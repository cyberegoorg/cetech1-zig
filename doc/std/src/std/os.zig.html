<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">    <title>os.zig - source view</title>
    <link rel="icon" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAgklEQVR4AWMYWuD7EllJIM4G4g4g5oIJ/odhOJ8wToOxSTXgNxDHoeiBMfA4+wGShjyYOCkG/IGqWQziEzYAoUAeiF9D5U+DxEg14DRU7jWIT5IBIOdCxf+A+CQZAAoopEB7QJwBCBwHiip8UYmRdrAlDpIMgApwQZNnNii5Dq0MBgCxxycBnwEd+wAAAABJRU5ErkJggg==">
    <link rel="icon" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxNTMgMTQwIj48ZyBmaWxsPSIjRjdBNDFEIj48Zz48cG9seWdvbiBwb2ludHM9IjQ2LDIyIDI4LDQ0IDE5LDMwIi8+PHBvbHlnb24gcG9pbnRzPSI0NiwyMiAzMywzMyAyOCw0NCAyMiw0NCAyMiw5NSAzMSw5NSAyMCwxMDAgMTIsMTE3IDAsMTE3IDAsMjIiIHNoYXBlLXJlbmRlcmluZz0iY3Jpc3BFZGdlcyIvPjxwb2x5Z29uIHBvaW50cz0iMzEsOTUgMTIsMTE3IDQsMTA2Ii8+PC9nPjxnPjxwb2x5Z29uIHBvaW50cz0iNTYsMjIgNjIsMzYgMzcsNDQiLz48cG9seWdvbiBwb2ludHM9IjU2LDIyIDExMSwyMiAxMTEsNDQgMzcsNDQgNTYsMzIiIHNoYXBlLXJlbmRlcmluZz0iY3Jpc3BFZGdlcyIvPjxwb2x5Z29uIHBvaW50cz0iMTE2LDk1IDk3LDExNyA5MCwxMDQiLz48cG9seWdvbiBwb2ludHM9IjExNiw5NSAxMDAsMTA0IDk3LDExNyA0MiwxMTcgNDIsOTUiIHNoYXBlLXJlbmRlcmluZz0iY3Jpc3BFZGdlcyIvPjxwb2x5Z29uIHBvaW50cz0iMTUwLDAgNTIsMTE3IDMsMTQwIDEwMSwyMiIvPjwvZz48Zz48cG9seWdvbiBwb2ludHM9IjE0MSwyMiAxNDAsNDAgMTIyLDQ1Ii8+PHBvbHlnb24gcG9pbnRzPSIxNTMsMjIgMTUzLDExNyAxMDYsMTE3IDEyMCwxMDUgMTI1LDk1IDEzMSw5NSAxMzEsNDUgMTIyLDQ1IDEzMiwzNiAxNDEsMjIiIHNoYXBlLXJlbmRlcmluZz0iY3Jpc3BFZGdlcyIvPjxwb2x5Z29uIHBvaW50cz0iMTI1LDk1IDEzMCwxMTAgMTA2LDExNyIvPjwvZz48L2c+PC9zdmc+">
    <style>
      body{
        font-family: system-ui, -apple-system, Roboto, "Segoe UI", sans-serif;
        margin: 0;
        line-height: 1.5;
      }

      pre > code {
        display: block;
        overflow: auto;
        line-height: normal;
        margin: 0em;
      }
      .tok-kw {
          color: #333;
          font-weight: bold;
      }
      .tok-str {
          color: #d14;
      }
      .tok-builtin {
          color: #005C7A;
      }
      .tok-comment {
          color: #545454;
          font-style: italic;
      }
      .tok-fn {
          color: #900;
          font-weight: bold;
      }
      .tok-null {
          color: #005C5C;
      }
      .tok-number {
          color: #005C5C;
      }
      .tok-type {
          color: #458;
          font-weight: bold;
      }
      pre {
        counter-reset: line;
      }
      pre .line:before {
        counter-increment: line;
        content: counter(line);
        display: inline-block;
        padding-right: 1em;
        width: 2em;
        text-align: right;
        color: #999;
      }
      
      .line {
        width: 100%;
        display: inline-block;
      }
      .line:target {
        border-top: 1px solid #ccc;
        border-bottom: 1px solid #ccc;
        background: #fafafa;
      }

      @media (prefers-color-scheme: dark) {
        body{
            background:#222;
            color: #ccc;
        }
        pre > code {
            color: #ccc;
            background: #222;
            border: unset;
        }
        .line:target {
            border-top: 1px solid #444;
            border-bottom: 1px solid #444;
            background: #333;
        }
        .tok-kw {
            color: #eee;
        }
        .tok-str {
            color: #2e5;
        }
        .tok-builtin {
            color: #ff894c;
        }
        .tok-comment {
            color: #aa7;
        }
        .tok-fn {
            color: #B1A0F8;
        }
        .tok-null {
            color: #ff8080;
        }
        .tok-number {
            color: #ff8080;
        }
        .tok-type {
            color: #68f;
        }
      }
    </style>
</head>
<body>
<pre><code><span class="line" id="L1"><span class="tok-comment">//! This file contains thin wrappers around OS-specific APIs, with these</span></span>
<span class="line" id="L2"><span class="tok-comment">//! specific goals in mind:</span></span>
<span class="line" id="L3"><span class="tok-comment">//! * Convert &quot;errno&quot;-style error codes into Zig errors.</span></span>
<span class="line" id="L4"><span class="tok-comment">//! * When null-terminated byte buffers are required, provide APIs which accept</span></span>
<span class="line" id="L5"><span class="tok-comment">//!   slices as well as APIs which accept null-terminated byte buffers. Same goes</span></span>
<span class="line" id="L6"><span class="tok-comment">//!   for WTF-16LE encoding.</span></span>
<span class="line" id="L7"><span class="tok-comment">//! * Where operating systems share APIs, e.g. POSIX, these thin wrappers provide</span></span>
<span class="line" id="L8"><span class="tok-comment">//!   cross platform abstracting.</span></span>
<span class="line" id="L9"><span class="tok-comment">//! * When there exists a corresponding libc function and linking libc, the libc</span></span>
<span class="line" id="L10"><span class="tok-comment">//!   implementation is used. Exceptions are made for known buggy areas of libc.</span></span>
<span class="line" id="L11"><span class="tok-comment">//!   On Linux libc can be side-stepped by using `std.os.linux` directly.</span></span>
<span class="line" id="L12"><span class="tok-comment">//! * For Windows, this file represents the API that libc would provide for</span></span>
<span class="line" id="L13"><span class="tok-comment">//!   Windows. For thin wrappers around Windows-specific APIs, see `std.os.windows`.</span></span>
<span class="line" id="L14"><span class="tok-comment">//! Note: The Zig standard library does not support POSIX thread cancellation, and</span></span>
<span class="line" id="L15"><span class="tok-comment">//! in general EINTR is handled by trying again.</span></span>
<span class="line" id="L16"></span>
<span class="line" id="L17"><span class="tok-kw">const</span> root = <span class="tok-builtin">@import</span>(<span class="tok-str">&quot;root&quot;</span>);</span>
<span class="line" id="L18"><span class="tok-kw">const</span> std = <span class="tok-builtin">@import</span>(<span class="tok-str">&quot;std.zig&quot;</span>);</span>
<span class="line" id="L19"><span class="tok-kw">const</span> builtin = <span class="tok-builtin">@import</span>(<span class="tok-str">&quot;builtin&quot;</span>);</span>
<span class="line" id="L20"><span class="tok-kw">const</span> assert = std.debug.assert;</span>
<span class="line" id="L21"><span class="tok-kw">const</span> math = std.math;</span>
<span class="line" id="L22"><span class="tok-kw">const</span> mem = std.mem;</span>
<span class="line" id="L23"><span class="tok-kw">const</span> elf = std.elf;</span>
<span class="line" id="L24"><span class="tok-kw">const</span> fs = std.fs;</span>
<span class="line" id="L25"><span class="tok-kw">const</span> dl = <span class="tok-builtin">@import</span>(<span class="tok-str">&quot;dynamic_library.zig&quot;</span>);</span>
<span class="line" id="L26"><span class="tok-kw">const</span> MAX_PATH_BYTES = std.fs.MAX_PATH_BYTES;</span>
<span class="line" id="L27"></span>
<span class="line" id="L28"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> darwin = std.c;</span>
<span class="line" id="L29"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> dragonfly = std.c;</span>
<span class="line" id="L30"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> freebsd = std.c;</span>
<span class="line" id="L31"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> haiku = std.c;</span>
<span class="line" id="L32"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> netbsd = std.c;</span>
<span class="line" id="L33"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> openbsd = std.c;</span>
<span class="line" id="L34"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> solaris = std.c;</span>
<span class="line" id="L35"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> illumos = std.c;</span>
<span class="line" id="L36"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> linux = <span class="tok-builtin">@import</span>(<span class="tok-str">&quot;os/linux.zig&quot;</span>);</span>
<span class="line" id="L37"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> plan9 = <span class="tok-builtin">@import</span>(<span class="tok-str">&quot;os/plan9.zig&quot;</span>);</span>
<span class="line" id="L38"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> uefi = <span class="tok-builtin">@import</span>(<span class="tok-str">&quot;os/uefi.zig&quot;</span>);</span>
<span class="line" id="L39"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> wasi = <span class="tok-builtin">@import</span>(<span class="tok-str">&quot;os/wasi.zig&quot;</span>);</span>
<span class="line" id="L40"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> emscripten = <span class="tok-builtin">@import</span>(<span class="tok-str">&quot;os/emscripten.zig&quot;</span>);</span>
<span class="line" id="L41"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> windows = <span class="tok-builtin">@import</span>(<span class="tok-str">&quot;os/windows.zig&quot;</span>);</span>
<span class="line" id="L42"></span>
<span class="line" id="L43"><span class="tok-kw">comptime</span> {</span>
<span class="line" id="L44">    assert(<span class="tok-builtin">@import</span>(<span class="tok-str">&quot;std&quot;</span>) == std); <span class="tok-comment">// std lib tests require --zig-lib-dir</span>
</span>
<span class="line" id="L45">}</span>
<span class="line" id="L46"></span>
<span class="line" id="L47"><span class="tok-kw">test</span> {</span>
<span class="line" id="L48">    _ = darwin;</span>
<span class="line" id="L49">    _ = linux;</span>
<span class="line" id="L50">    <span class="tok-kw">if</span> (builtin.os.tag == .uefi) {</span>
<span class="line" id="L51">        _ = uefi;</span>
<span class="line" id="L52">    }</span>
<span class="line" id="L53">    _ = wasi;</span>
<span class="line" id="L54">    _ = windows;</span>
<span class="line" id="L55"></span>
<span class="line" id="L56">    _ = <span class="tok-builtin">@import</span>(<span class="tok-str">&quot;os/test.zig&quot;</span>);</span>
<span class="line" id="L57">}</span>
<span class="line" id="L58"></span>
<span class="line" id="L59"><span class="tok-comment">/// Applications can override the `system` API layer in their root source file.</span></span>
<span class="line" id="L60"><span class="tok-comment">/// Otherwise, when linking libc, this is the C API.</span></span>
<span class="line" id="L61"><span class="tok-comment">/// When not linking libc, it is the OS-specific system interface.</span></span>
<span class="line" id="L62"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> system = <span class="tok-kw">if</span> (<span class="tok-builtin">@hasDecl</span>(root, <span class="tok-str">&quot;os&quot;</span>) <span class="tok-kw">and</span> <span class="tok-builtin">@hasDecl</span>(root.os, <span class="tok-str">&quot;system&quot;</span>) <span class="tok-kw">and</span> root.os != <span class="tok-builtin">@This</span>())</span>
<span class="line" id="L63">    root.os.system</span>
<span class="line" id="L64"><span class="tok-kw">else</span> <span class="tok-kw">if</span> (use_libc)</span>
<span class="line" id="L65">    std.c</span>
<span class="line" id="L66"><span class="tok-kw">else</span> <span class="tok-kw">switch</span> (builtin.os.tag) {</span>
<span class="line" id="L67">    .linux =&gt; linux,</span>
<span class="line" id="L68">    .plan9 =&gt; plan9,</span>
<span class="line" id="L69">    .uefi =&gt; uefi,</span>
<span class="line" id="L70">    <span class="tok-kw">else</span> =&gt; <span class="tok-kw">struct</span> {},</span>
<span class="line" id="L71">};</span>
<span class="line" id="L72"></span>
<span class="line" id="L73"><span class="tok-comment">/// Whether to use libc for the POSIX API layer.</span></span>
<span class="line" id="L74"><span class="tok-kw">const</span> use_libc = builtin.link_libc <span class="tok-kw">or</span> <span class="tok-kw">switch</span> (builtin.os.tag) {</span>
<span class="line" id="L75">    .windows, .wasi =&gt; <span class="tok-null">true</span>,</span>
<span class="line" id="L76">    <span class="tok-kw">else</span> =&gt; <span class="tok-null">false</span>,</span>
<span class="line" id="L77">};</span>
<span class="line" id="L78"></span>
<span class="line" id="L79"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> AF = system.AF;</span>
<span class="line" id="L80"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> AF_SUN = system.AF_SUN;</span>
<span class="line" id="L81"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> ARCH = system.ARCH;</span>
<span class="line" id="L82"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> AT = system.AT;</span>
<span class="line" id="L83"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> AT_SUN = system.AT_SUN;</span>
<span class="line" id="L84"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> CLOCK = system.CLOCK;</span>
<span class="line" id="L85"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> CPU_COUNT = system.CPU_COUNT;</span>
<span class="line" id="L86"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> CTL = system.CTL;</span>
<span class="line" id="L87"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> DT = system.DT;</span>
<span class="line" id="L88"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> E = system.E;</span>
<span class="line" id="L89"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> Elf_Symndx = system.Elf_Symndx;</span>
<span class="line" id="L90"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> F = system.F;</span>
<span class="line" id="L91"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FD_CLOEXEC = system.FD_CLOEXEC;</span>
<span class="line" id="L92"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> Flock = system.Flock;</span>
<span class="line" id="L93"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> HOST_NAME_MAX = system.HOST_NAME_MAX;</span>
<span class="line" id="L94"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> HW = system.HW;</span>
<span class="line" id="L95"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> IFNAMESIZE = system.IFNAMESIZE;</span>
<span class="line" id="L96"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> IOV_MAX = system.IOV_MAX;</span>
<span class="line" id="L97"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> IPPROTO = system.IPPROTO;</span>
<span class="line" id="L98"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> KERN = system.KERN;</span>
<span class="line" id="L99"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> Kevent = system.Kevent;</span>
<span class="line" id="L100"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> LOCK = system.LOCK;</span>
<span class="line" id="L101"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> MADV = system.MADV;</span>
<span class="line" id="L102"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> MAP = system.MAP;</span>
<span class="line" id="L103"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> MSF = system.MSF;</span>
<span class="line" id="L104"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> MAX_ADDR_LEN = system.MAX_ADDR_LEN;</span>
<span class="line" id="L105"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> MFD = system.MFD;</span>
<span class="line" id="L106"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> MMAP2_UNIT = system.MMAP2_UNIT;</span>
<span class="line" id="L107"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> MSG = system.MSG;</span>
<span class="line" id="L108"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> NAME_MAX = system.NAME_MAX;</span>
<span class="line" id="L109"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> O = system.O;</span>
<span class="line" id="L110"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> PATH_MAX = system.PATH_MAX;</span>
<span class="line" id="L111"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> POLL = system.POLL;</span>
<span class="line" id="L112"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> POSIX_FADV = system.POSIX_FADV;</span>
<span class="line" id="L113"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> PR = system.PR;</span>
<span class="line" id="L114"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> PROT = system.PROT;</span>
<span class="line" id="L115"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> REG = system.REG;</span>
<span class="line" id="L116"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> RLIM = system.RLIM;</span>
<span class="line" id="L117"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> RR = system.RR;</span>
<span class="line" id="L118"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> S = system.S;</span>
<span class="line" id="L119"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> SA = system.SA;</span>
<span class="line" id="L120"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> SC = system.SC;</span>
<span class="line" id="L121"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> _SC = system._SC;</span>
<span class="line" id="L122"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> SEEK = system.SEEK;</span>
<span class="line" id="L123"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> SHUT = system.SHUT;</span>
<span class="line" id="L124"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> SIG = system.SIG;</span>
<span class="line" id="L125"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> SIOCGIFINDEX = system.SIOCGIFINDEX;</span>
<span class="line" id="L126"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> SO = system.SO;</span>
<span class="line" id="L127"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> SOCK = system.SOCK;</span>
<span class="line" id="L128"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> SOL = system.SOL;</span>
<span class="line" id="L129"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> STDERR_FILENO = system.STDERR_FILENO;</span>
<span class="line" id="L130"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> STDIN_FILENO = system.STDIN_FILENO;</span>
<span class="line" id="L131"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> STDOUT_FILENO = system.STDOUT_FILENO;</span>
<span class="line" id="L132"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> SYS = system.SYS;</span>
<span class="line" id="L133"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> Sigaction = system.Sigaction;</span>
<span class="line" id="L134"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> Stat = system.Stat;</span>
<span class="line" id="L135"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> T = system.T;</span>
<span class="line" id="L136"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> TCSA = system.TCSA;</span>
<span class="line" id="L137"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> TCP = system.TCP;</span>
<span class="line" id="L138"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> VDSO = system.VDSO;</span>
<span class="line" id="L139"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> W = system.W;</span>
<span class="line" id="L140"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> addrinfo = system.addrinfo;</span>
<span class="line" id="L141"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> blkcnt_t = system.blkcnt_t;</span>
<span class="line" id="L142"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> blksize_t = system.blksize_t;</span>
<span class="line" id="L143"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> clock_t = system.clock_t;</span>
<span class="line" id="L144"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> cpu_set_t = system.cpu_set_t;</span>
<span class="line" id="L145"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> dev_t = system.dev_t;</span>
<span class="line" id="L146"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> dl_phdr_info = system.dl_phdr_info;</span>
<span class="line" id="L147"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> empty_sigset = system.empty_sigset;</span>
<span class="line" id="L148"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> filled_sigset = system.filled_sigset;</span>
<span class="line" id="L149"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> fd_t = system.fd_t;</span>
<span class="line" id="L150"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> gid_t = system.gid_t;</span>
<span class="line" id="L151"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> ifreq = system.ifreq;</span>
<span class="line" id="L152"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> ino_t = system.ino_t;</span>
<span class="line" id="L153"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> mcontext_t = system.mcontext_t;</span>
<span class="line" id="L154"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> mode_t = system.mode_t;</span>
<span class="line" id="L155"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> msghdr = system.msghdr;</span>
<span class="line" id="L156"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> msghdr_const = system.msghdr_const;</span>
<span class="line" id="L157"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> nfds_t = system.nfds_t;</span>
<span class="line" id="L158"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> nlink_t = system.nlink_t;</span>
<span class="line" id="L159"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> off_t = system.off_t;</span>
<span class="line" id="L160"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> pid_t = system.pid_t;</span>
<span class="line" id="L161"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> pollfd = system.pollfd;</span>
<span class="line" id="L162"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> port_t = system.port_t;</span>
<span class="line" id="L163"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> port_event = system.port_event;</span>
<span class="line" id="L164"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> port_notify = system.port_notify;</span>
<span class="line" id="L165"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> file_obj = system.file_obj;</span>
<span class="line" id="L166"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> rlim_t = system.rlim_t;</span>
<span class="line" id="L167"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> rlimit = system.rlimit;</span>
<span class="line" id="L168"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> rlimit_resource = system.rlimit_resource;</span>
<span class="line" id="L169"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> rusage = system.rusage;</span>
<span class="line" id="L170"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> sa_family_t = system.sa_family_t;</span>
<span class="line" id="L171"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> siginfo_t = system.siginfo_t;</span>
<span class="line" id="L172"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> sigset_t = system.sigset_t;</span>
<span class="line" id="L173"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> sockaddr = system.sockaddr;</span>
<span class="line" id="L174"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> socklen_t = system.socklen_t;</span>
<span class="line" id="L175"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> stack_t = system.stack_t;</span>
<span class="line" id="L176"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> time_t = system.time_t;</span>
<span class="line" id="L177"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> timespec = system.timespec;</span>
<span class="line" id="L178"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> timestamp_t = system.timestamp_t;</span>
<span class="line" id="L179"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> timeval = system.timeval;</span>
<span class="line" id="L180"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> timezone = system.timezone;</span>
<span class="line" id="L181"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> ucontext_t = system.ucontext_t;</span>
<span class="line" id="L182"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> uid_t = system.uid_t;</span>
<span class="line" id="L183"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> user_desc = system.user_desc;</span>
<span class="line" id="L184"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> utsname = system.utsname;</span>
<span class="line" id="L185"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> winsize = system.winsize;</span>
<span class="line" id="L186"></span>
<span class="line" id="L187"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> termios = system.termios;</span>
<span class="line" id="L188"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> CSIZE = system.CSIZE;</span>
<span class="line" id="L189"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> NCCS = system.NCCS;</span>
<span class="line" id="L190"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> cc_t = system.cc_t;</span>
<span class="line" id="L191"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> V = system.V;</span>
<span class="line" id="L192"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> speed_t = system.speed_t;</span>
<span class="line" id="L193"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> tc_iflag_t = system.tc_iflag_t;</span>
<span class="line" id="L194"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> tc_oflag_t = system.tc_oflag_t;</span>
<span class="line" id="L195"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> tc_cflag_t = system.tc_cflag_t;</span>
<span class="line" id="L196"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> tc_lflag_t = system.tc_lflag_t;</span>
<span class="line" id="L197"></span>
<span class="line" id="L198"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> F_OK = system.F_OK;</span>
<span class="line" id="L199"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> R_OK = system.R_OK;</span>
<span class="line" id="L200"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> W_OK = system.W_OK;</span>
<span class="line" id="L201"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> X_OK = system.X_OK;</span>
<span class="line" id="L202"></span>
<span class="line" id="L203"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> iovec = <span class="tok-kw">extern</span> <span class="tok-kw">struct</span> {</span>
<span class="line" id="L204">    iov_base: [*]<span class="tok-type">u8</span>,</span>
<span class="line" id="L205">    iov_len: <span class="tok-type">usize</span>,</span>
<span class="line" id="L206">};</span>
<span class="line" id="L207"></span>
<span class="line" id="L208"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> iovec_const = <span class="tok-kw">extern</span> <span class="tok-kw">struct</span> {</span>
<span class="line" id="L209">    iov_base: [*]<span class="tok-kw">const</span> <span class="tok-type">u8</span>,</span>
<span class="line" id="L210">    iov_len: <span class="tok-type">usize</span>,</span>
<span class="line" id="L211">};</span>
<span class="line" id="L212"></span>
<span class="line" id="L213"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> ACCMODE = <span class="tok-kw">enum</span>(<span class="tok-type">u2</span>) {</span>
<span class="line" id="L214">    RDONLY = <span class="tok-number">0</span>,</span>
<span class="line" id="L215">    WRONLY = <span class="tok-number">1</span>,</span>
<span class="line" id="L216">    RDWR = <span class="tok-number">2</span>,</span>
<span class="line" id="L217">};</span>
<span class="line" id="L218"></span>
<span class="line" id="L219"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> LOG = <span class="tok-kw">struct</span> {</span>
<span class="line" id="L220">    <span class="tok-comment">/// system is unusable</span></span>
<span class="line" id="L221">    <span class="tok-kw">pub</span> <span class="tok-kw">const</span> EMERG = <span class="tok-number">0</span>;</span>
<span class="line" id="L222">    <span class="tok-comment">/// action must be taken immediately</span></span>
<span class="line" id="L223">    <span class="tok-kw">pub</span> <span class="tok-kw">const</span> ALERT = <span class="tok-number">1</span>;</span>
<span class="line" id="L224">    <span class="tok-comment">/// critical conditions</span></span>
<span class="line" id="L225">    <span class="tok-kw">pub</span> <span class="tok-kw">const</span> CRIT = <span class="tok-number">2</span>;</span>
<span class="line" id="L226">    <span class="tok-comment">/// error conditions</span></span>
<span class="line" id="L227">    <span class="tok-kw">pub</span> <span class="tok-kw">const</span> ERR = <span class="tok-number">3</span>;</span>
<span class="line" id="L228">    <span class="tok-comment">/// warning conditions</span></span>
<span class="line" id="L229">    <span class="tok-kw">pub</span> <span class="tok-kw">const</span> WARNING = <span class="tok-number">4</span>;</span>
<span class="line" id="L230">    <span class="tok-comment">/// normal but significant condition</span></span>
<span class="line" id="L231">    <span class="tok-kw">pub</span> <span class="tok-kw">const</span> NOTICE = <span class="tok-number">5</span>;</span>
<span class="line" id="L232">    <span class="tok-comment">/// informational</span></span>
<span class="line" id="L233">    <span class="tok-kw">pub</span> <span class="tok-kw">const</span> INFO = <span class="tok-number">6</span>;</span>
<span class="line" id="L234">    <span class="tok-comment">/// debug-level messages</span></span>
<span class="line" id="L235">    <span class="tok-kw">pub</span> <span class="tok-kw">const</span> DEBUG = <span class="tok-number">7</span>;</span>
<span class="line" id="L236">};</span>
<span class="line" id="L237"></span>
<span class="line" id="L238"><span class="tok-comment">/// An fd-relative file path</span></span>
<span class="line" id="L239"><span class="tok-comment">///</span></span>
<span class="line" id="L240"><span class="tok-comment">/// This is currently only used for WASI-specific functionality, but the concept</span></span>
<span class="line" id="L241"><span class="tok-comment">/// is the same as the dirfd/pathname pairs in the `*at(...)` POSIX functions.</span></span>
<span class="line" id="L242"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> RelativePathWasi = <span class="tok-kw">struct</span> {</span>
<span class="line" id="L243">    <span class="tok-comment">/// Handle to directory</span></span>
<span class="line" id="L244">    dir_fd: fd_t,</span>
<span class="line" id="L245">    <span class="tok-comment">/// Path to resource within `dir_fd`.</span></span>
<span class="line" id="L246">    relative_path: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>,</span>
<span class="line" id="L247">};</span>
<span class="line" id="L248"></span>
<span class="line" id="L249"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> socket_t = <span class="tok-kw">if</span> (builtin.os.tag == .windows) windows.ws2_32.SOCKET <span class="tok-kw">else</span> fd_t;</span>
<span class="line" id="L250"></span>
<span class="line" id="L251"><span class="tok-comment">/// See also `getenv`. Populated by startup code before main().</span></span>
<span class="line" id="L252"><span class="tok-comment">/// TODO this is a footgun because the value will be undefined when using `zig build-lib`.</span></span>
<span class="line" id="L253"><span class="tok-comment">/// https://github.com/ziglang/zig/issues/4524</span></span>
<span class="line" id="L254"><span class="tok-kw">pub</span> <span class="tok-kw">var</span> environ: [][*:<span class="tok-number">0</span>]<span class="tok-type">u8</span> = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L255"></span>
<span class="line" id="L256"><span class="tok-comment">/// Populated by startup code before main().</span></span>
<span class="line" id="L257"><span class="tok-comment">/// Not available on WASI or Windows without libc. See `std.process.argsAlloc`</span></span>
<span class="line" id="L258"><span class="tok-comment">/// or `std.process.argsWithAllocator` for a cross-platform alternative.</span></span>
<span class="line" id="L259"><span class="tok-kw">pub</span> <span class="tok-kw">var</span> argv: [][*:<span class="tok-number">0</span>]<span class="tok-type">u8</span> = <span class="tok-kw">if</span> (builtin.link_libc) <span class="tok-null">undefined</span> <span class="tok-kw">else</span> <span class="tok-kw">switch</span> (builtin.os.tag) {</span>
<span class="line" id="L260">    .windows =&gt; <span class="tok-builtin">@compileError</span>(<span class="tok-str">&quot;argv isn't supported on Windows: use std.process.argsAlloc instead&quot;</span>),</span>
<span class="line" id="L261">    .wasi =&gt; <span class="tok-builtin">@compileError</span>(<span class="tok-str">&quot;argv isn't supported on WASI: use std.process.argsAlloc instead&quot;</span>),</span>
<span class="line" id="L262">    <span class="tok-kw">else</span> =&gt; <span class="tok-null">undefined</span>,</span>
<span class="line" id="L263">};</span>
<span class="line" id="L264"></span>
<span class="line" id="L265"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> have_sigpipe_support = <span class="tok-builtin">@hasDecl</span>(<span class="tok-builtin">@This</span>(), <span class="tok-str">&quot;SIG&quot;</span>) <span class="tok-kw">and</span> <span class="tok-builtin">@hasDecl</span>(SIG, <span class="tok-str">&quot;PIPE&quot;</span>);</span>
<span class="line" id="L266"></span>
<span class="line" id="L267"><span class="tok-kw">fn</span> <span class="tok-fn">noopSigHandler</span>(_: <span class="tok-type">c_int</span>) <span class="tok-kw">callconv</span>(.C) <span class="tok-type">void</span> {}</span>
<span class="line" id="L268"></span>
<span class="line" id="L269"><span class="tok-comment">/// On default executed by posix startup code before main(), if SIGPIPE is supported.</span></span>
<span class="line" id="L270"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">maybeIgnoreSigpipe</span>() <span class="tok-type">void</span> {</span>
<span class="line" id="L271">    <span class="tok-kw">if</span> (have_sigpipe_support <span class="tok-kw">and</span> !std.options.keep_sigpipe) {</span>
<span class="line" id="L272">        <span class="tok-kw">const</span> act = Sigaction{</span>
<span class="line" id="L273">            <span class="tok-comment">// We set handler to a noop function instead of SIG.IGN so we don't leak our</span>
</span>
<span class="line" id="L274">            <span class="tok-comment">// signal disposition to a child process</span>
</span>
<span class="line" id="L275">            .handler = .{ .handler = noopSigHandler },</span>
<span class="line" id="L276">            .mask = empty_sigset,</span>
<span class="line" id="L277">            .flags = <span class="tok-number">0</span>,</span>
<span class="line" id="L278">        };</span>
<span class="line" id="L279">        sigaction(SIG.PIPE, &amp;act, <span class="tok-null">null</span>) <span class="tok-kw">catch</span> |err|</span>
<span class="line" id="L280">            std.debug.panic(<span class="tok-str">&quot;failed to install noop SIGPIPE handler with '{s}'&quot;</span>, .{<span class="tok-builtin">@errorName</span>(err)});</span>
<span class="line" id="L281">    }</span>
<span class="line" id="L282">}</span>
<span class="line" id="L283"></span>
<span class="line" id="L284"><span class="tok-comment">/// To obtain errno, call this function with the return value of the</span></span>
<span class="line" id="L285"><span class="tok-comment">/// system function call. For some systems this will obtain the value directly</span></span>
<span class="line" id="L286"><span class="tok-comment">/// from the return code; for others it will use a thread-local errno variable.</span></span>
<span class="line" id="L287"><span class="tok-comment">/// Therefore, this function only returns a well-defined value when it is called</span></span>
<span class="line" id="L288"><span class="tok-comment">/// directly after the system function call which one wants to learn the errno</span></span>
<span class="line" id="L289"><span class="tok-comment">/// value of.</span></span>
<span class="line" id="L290"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> errno = system.getErrno;</span>
<span class="line" id="L291"></span>
<span class="line" id="L292"><span class="tok-comment">/// Closes the file descriptor.</span></span>
<span class="line" id="L293"><span class="tok-comment">/// This function is not capable of returning any indication of failure. An</span></span>
<span class="line" id="L294"><span class="tok-comment">/// application which wants to ensure writes have succeeded before closing</span></span>
<span class="line" id="L295"><span class="tok-comment">/// must call `fsync` before `close`.</span></span>
<span class="line" id="L296"><span class="tok-comment">/// Note: The Zig standard library does not support POSIX thread cancellation.</span></span>
<span class="line" id="L297"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">close</span>(fd: fd_t) <span class="tok-type">void</span> {</span>
<span class="line" id="L298">    <span class="tok-kw">if</span> (builtin.os.tag == .windows) {</span>
<span class="line" id="L299">        <span class="tok-kw">return</span> windows.CloseHandle(fd);</span>
<span class="line" id="L300">    }</span>
<span class="line" id="L301">    <span class="tok-kw">if</span> (builtin.os.tag == .wasi <span class="tok-kw">and</span> !builtin.link_libc) {</span>
<span class="line" id="L302">        _ = wasi.fd_close(fd);</span>
<span class="line" id="L303">        <span class="tok-kw">return</span>;</span>
<span class="line" id="L304">    }</span>
<span class="line" id="L305">    <span class="tok-kw">if</span> (builtin.target.isDarwin()) {</span>
<span class="line" id="L306">        <span class="tok-comment">// This avoids the EINTR problem.</span>
</span>
<span class="line" id="L307">        <span class="tok-kw">switch</span> (darwin.getErrno(darwin.@&quot;close$NOCANCEL&quot;(fd))) {</span>
<span class="line" id="L308">            .BADF =&gt; <span class="tok-kw">unreachable</span>, <span class="tok-comment">// Always a race condition.</span>
</span>
<span class="line" id="L309">            <span class="tok-kw">else</span> =&gt; <span class="tok-kw">return</span>,</span>
<span class="line" id="L310">        }</span>
<span class="line" id="L311">    }</span>
<span class="line" id="L312">    <span class="tok-kw">switch</span> (errno(system.close(fd))) {</span>
<span class="line" id="L313">        .BADF =&gt; <span class="tok-kw">unreachable</span>, <span class="tok-comment">// Always a race condition.</span>
</span>
<span class="line" id="L314">        .INTR =&gt; <span class="tok-kw">return</span>, <span class="tok-comment">// This is still a success. See https://github.com/ziglang/zig/issues/2425</span>
</span>
<span class="line" id="L315">        <span class="tok-kw">else</span> =&gt; <span class="tok-kw">return</span>,</span>
<span class="line" id="L316">    }</span>
<span class="line" id="L317">}</span>
<span class="line" id="L318"></span>
<span class="line" id="L319"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FChmodError = <span class="tok-kw">error</span>{</span>
<span class="line" id="L320">    AccessDenied,</span>
<span class="line" id="L321">    InputOutput,</span>
<span class="line" id="L322">    SymLinkLoop,</span>
<span class="line" id="L323">    FileNotFound,</span>
<span class="line" id="L324">    SystemResources,</span>
<span class="line" id="L325">    ReadOnlyFileSystem,</span>
<span class="line" id="L326">} || UnexpectedError;</span>
<span class="line" id="L327"></span>
<span class="line" id="L328"><span class="tok-comment">/// Changes the mode of the file referred to by the file descriptor.</span></span>
<span class="line" id="L329"><span class="tok-comment">/// The process must have the correct privileges in order to do this</span></span>
<span class="line" id="L330"><span class="tok-comment">/// successfully, or must have the effective user ID matching the owner</span></span>
<span class="line" id="L331"><span class="tok-comment">/// of the file.</span></span>
<span class="line" id="L332"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">fchmod</span>(fd: fd_t, mode: mode_t) FChmodError!<span class="tok-type">void</span> {</span>
<span class="line" id="L333">    <span class="tok-kw">if</span> (!std.fs.has_executable_bit) <span class="tok-builtin">@compileError</span>(<span class="tok-str">&quot;fchmod unsupported by target OS&quot;</span>);</span>
<span class="line" id="L334"></span>
<span class="line" id="L335">    <span class="tok-kw">while</span> (<span class="tok-null">true</span>) {</span>
<span class="line" id="L336">        <span class="tok-kw">const</span> res = system.fchmod(fd, mode);</span>
<span class="line" id="L337"></span>
<span class="line" id="L338">        <span class="tok-kw">switch</span> (system.getErrno(res)) {</span>
<span class="line" id="L339">            .SUCCESS =&gt; <span class="tok-kw">return</span>,</span>
<span class="line" id="L340">            .INTR =&gt; <span class="tok-kw">continue</span>,</span>
<span class="line" id="L341">            .BADF =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L342">            .FAULT =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L343">            .INVAL =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L344">            .ACCES =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.AccessDenied,</span>
<span class="line" id="L345">            .IO =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.InputOutput,</span>
<span class="line" id="L346">            .LOOP =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.SymLinkLoop,</span>
<span class="line" id="L347">            .NOENT =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.FileNotFound,</span>
<span class="line" id="L348">            .NOMEM =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.SystemResources,</span>
<span class="line" id="L349">            .NOTDIR =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.FileNotFound,</span>
<span class="line" id="L350">            .PERM =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.AccessDenied,</span>
<span class="line" id="L351">            .ROFS =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.ReadOnlyFileSystem,</span>
<span class="line" id="L352">            <span class="tok-kw">else</span> =&gt; |err| <span class="tok-kw">return</span> unexpectedErrno(err),</span>
<span class="line" id="L353">        }</span>
<span class="line" id="L354">    }</span>
<span class="line" id="L355">}</span>
<span class="line" id="L356"></span>
<span class="line" id="L357"><span class="tok-kw">const</span> FChmodAtError = FChmodError || <span class="tok-kw">error</span>{</span>
<span class="line" id="L358">    <span class="tok-comment">/// A component of `path` exceeded `NAME_MAX`, or the entire path exceeded</span></span>
<span class="line" id="L359">    <span class="tok-comment">/// `PATH_MAX`.</span></span>
<span class="line" id="L360">    NameTooLong,</span>
<span class="line" id="L361">    <span class="tok-comment">/// `path` resolves to a symbolic link, and `AT.SYMLINK_NOFOLLOW` was set</span></span>
<span class="line" id="L362">    <span class="tok-comment">/// in `flags`. This error only occurs on Linux, where changing the mode of</span></span>
<span class="line" id="L363">    <span class="tok-comment">/// a symbolic link has no meaning and can cause undefined behaviour on</span></span>
<span class="line" id="L364">    <span class="tok-comment">/// certain filesystems.</span></span>
<span class="line" id="L365">    <span class="tok-comment">///</span></span>
<span class="line" id="L366">    <span class="tok-comment">/// The procfs fallback was used but procfs was not mounted.</span></span>
<span class="line" id="L367">    OperationNotSupported,</span>
<span class="line" id="L368">    <span class="tok-comment">/// The procfs fallback was used but the process exceeded its open file</span></span>
<span class="line" id="L369">    <span class="tok-comment">/// limit.</span></span>
<span class="line" id="L370">    ProcessFdQuotaExceeded,</span>
<span class="line" id="L371">    <span class="tok-comment">/// The procfs fallback was used but the system exceeded it open file limit.</span></span>
<span class="line" id="L372">    SystemFdQuotaExceeded,</span>
<span class="line" id="L373">};</span>
<span class="line" id="L374"></span>
<span class="line" id="L375"><span class="tok-kw">var</span> has_fchmodat2_syscall = std.atomic.Value(<span class="tok-type">bool</span>).init(<span class="tok-null">true</span>);</span>
<span class="line" id="L376"></span>
<span class="line" id="L377"><span class="tok-comment">/// Changes the `mode` of `path` relative to the directory referred to by</span></span>
<span class="line" id="L378"><span class="tok-comment">/// `dirfd`. The process must have the correct privileges in order to do this</span></span>
<span class="line" id="L379"><span class="tok-comment">/// successfully, or must have the effective user ID matching the owner of the</span></span>
<span class="line" id="L380"><span class="tok-comment">/// file.</span></span>
<span class="line" id="L381"><span class="tok-comment">///</span></span>
<span class="line" id="L382"><span class="tok-comment">/// On Linux the `fchmodat2` syscall will be used if available, otherwise a</span></span>
<span class="line" id="L383"><span class="tok-comment">/// workaround using procfs will be employed. Changing the mode of a symbolic</span></span>
<span class="line" id="L384"><span class="tok-comment">/// link with `AT.SYMLINK_NOFOLLOW` set will also return</span></span>
<span class="line" id="L385"><span class="tok-comment">/// `OperationNotSupported`, as:</span></span>
<span class="line" id="L386"><span class="tok-comment">///</span></span>
<span class="line" id="L387"><span class="tok-comment">///  1. Permissions on the link are ignored when resolving its target.</span></span>
<span class="line" id="L388"><span class="tok-comment">///  2. This operation has been known to invoke undefined behaviour across</span></span>
<span class="line" id="L389"><span class="tok-comment">///     different filesystems[1].</span></span>
<span class="line" id="L390"><span class="tok-comment">///</span></span>
<span class="line" id="L391"><span class="tok-comment">/// [1]: https://sourceware.org/legacy-ml/libc-alpha/2020-02/msg00467.html.</span></span>
<span class="line" id="L392"><span class="tok-kw">pub</span> <span class="tok-kw">inline</span> <span class="tok-kw">fn</span> <span class="tok-fn">fchmodat</span>(dirfd: fd_t, path: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>, mode: mode_t, flags: <span class="tok-type">u32</span>) FChmodAtError!<span class="tok-type">void</span> {</span>
<span class="line" id="L393">    <span class="tok-kw">if</span> (!std.fs.has_executable_bit) <span class="tok-builtin">@compileError</span>(<span class="tok-str">&quot;fchmodat unsupported by target OS&quot;</span>);</span>
<span class="line" id="L394"></span>
<span class="line" id="L395">    <span class="tok-comment">// No special handling for linux is needed if we can use the libc fallback</span>
</span>
<span class="line" id="L396">    <span class="tok-comment">// or `flags` is empty. Glibc only added the fallback in 2.32.</span>
</span>
<span class="line" id="L397">    <span class="tok-kw">const</span> skip_fchmodat_fallback = builtin.os.tag != .linux <span class="tok-kw">or</span></span>
<span class="line" id="L398">        std.c.versionCheck(.{ .major = <span class="tok-number">2</span>, .minor = <span class="tok-number">32</span>, .patch = <span class="tok-number">0</span> }) <span class="tok-kw">or</span></span>
<span class="line" id="L399">        flags == <span class="tok-number">0</span>;</span>
<span class="line" id="L400"></span>
<span class="line" id="L401">    <span class="tok-comment">// This function is marked inline so that when flags is comptime-known,</span>
</span>
<span class="line" id="L402">    <span class="tok-comment">// skip_fchmodat_fallback will be comptime-known true.</span>
</span>
<span class="line" id="L403">    <span class="tok-kw">if</span> (skip_fchmodat_fallback)</span>
<span class="line" id="L404">        <span class="tok-kw">return</span> fchmodat1(dirfd, path, mode, flags);</span>
<span class="line" id="L405"></span>
<span class="line" id="L406">    <span class="tok-kw">return</span> fchmodat2(dirfd, path, mode, flags);</span>
<span class="line" id="L407">}</span>
<span class="line" id="L408"></span>
<span class="line" id="L409"><span class="tok-kw">fn</span> <span class="tok-fn">fchmodat1</span>(dirfd: fd_t, path: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>, mode: mode_t, flags: <span class="tok-type">u32</span>) FChmodAtError!<span class="tok-type">void</span> {</span>
<span class="line" id="L410">    <span class="tok-kw">const</span> path_c = <span class="tok-kw">try</span> toPosixPath(path);</span>
<span class="line" id="L411">    <span class="tok-kw">while</span> (<span class="tok-null">true</span>) {</span>
<span class="line" id="L412">        <span class="tok-kw">const</span> res = system.fchmodat(dirfd, &amp;path_c, mode, flags);</span>
<span class="line" id="L413">        <span class="tok-kw">switch</span> (system.getErrno(res)) {</span>
<span class="line" id="L414">            .SUCCESS =&gt; <span class="tok-kw">return</span>,</span>
<span class="line" id="L415">            .INTR =&gt; <span class="tok-kw">continue</span>,</span>
<span class="line" id="L416">            .BADF =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L417">            .FAULT =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L418">            .INVAL =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L419">            .ACCES =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.AccessDenied,</span>
<span class="line" id="L420">            .IO =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.InputOutput,</span>
<span class="line" id="L421">            .LOOP =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.SymLinkLoop,</span>
<span class="line" id="L422">            .MFILE =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.ProcessFdQuotaExceeded,</span>
<span class="line" id="L423">            .NAMETOOLONG =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.NameTooLong,</span>
<span class="line" id="L424">            .NFILE =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.SystemFdQuotaExceeded,</span>
<span class="line" id="L425">            .NOENT =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.FileNotFound,</span>
<span class="line" id="L426">            .NOTDIR =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.FileNotFound,</span>
<span class="line" id="L427">            .NOMEM =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.SystemResources,</span>
<span class="line" id="L428">            .OPNOTSUPP =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.OperationNotSupported,</span>
<span class="line" id="L429">            .PERM =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.AccessDenied,</span>
<span class="line" id="L430">            .ROFS =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.ReadOnlyFileSystem,</span>
<span class="line" id="L431">            <span class="tok-kw">else</span> =&gt; |err| <span class="tok-kw">return</span> unexpectedErrno(err),</span>
<span class="line" id="L432">        }</span>
<span class="line" id="L433">    }</span>
<span class="line" id="L434">}</span>
<span class="line" id="L435"></span>
<span class="line" id="L436"><span class="tok-kw">fn</span> <span class="tok-fn">fchmodat2</span>(dirfd: fd_t, path: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>, mode: mode_t, flags: <span class="tok-type">u32</span>) FChmodAtError!<span class="tok-type">void</span> {</span>
<span class="line" id="L437">    <span class="tok-kw">const</span> path_c = <span class="tok-kw">try</span> toPosixPath(path);</span>
<span class="line" id="L438">    <span class="tok-kw">const</span> use_fchmodat2 = (builtin.os.isAtLeast(.linux, .{ .major = <span class="tok-number">6</span>, .minor = <span class="tok-number">6</span>, .patch = <span class="tok-number">0</span> }) <span class="tok-kw">orelse</span> <span class="tok-null">false</span>) <span class="tok-kw">and</span></span>
<span class="line" id="L439">        has_fchmodat2_syscall.load(.Monotonic);</span>
<span class="line" id="L440">    <span class="tok-kw">while</span> (use_fchmodat2) {</span>
<span class="line" id="L441">        <span class="tok-comment">// Later on this should be changed to `system.fchmodat2`</span>
</span>
<span class="line" id="L442">        <span class="tok-comment">// when the musl/glibc add a wrapper.</span>
</span>
<span class="line" id="L443">        <span class="tok-kw">const</span> res = linux.fchmodat2(dirfd, &amp;path_c, mode, flags);</span>
<span class="line" id="L444">        <span class="tok-kw">switch</span> (linux.getErrno(res)) {</span>
<span class="line" id="L445">            .SUCCESS =&gt; <span class="tok-kw">return</span>,</span>
<span class="line" id="L446">            .INTR =&gt; <span class="tok-kw">continue</span>,</span>
<span class="line" id="L447">            .BADF =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L448">            .FAULT =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L449">            .INVAL =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L450">            .ACCES =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.AccessDenied,</span>
<span class="line" id="L451">            .IO =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.InputOutput,</span>
<span class="line" id="L452">            .LOOP =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.SymLinkLoop,</span>
<span class="line" id="L453">            .NOENT =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.FileNotFound,</span>
<span class="line" id="L454">            .NOMEM =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.SystemResources,</span>
<span class="line" id="L455">            .NOTDIR =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.FileNotFound,</span>
<span class="line" id="L456">            .OPNOTSUPP =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.OperationNotSupported,</span>
<span class="line" id="L457">            .PERM =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.AccessDenied,</span>
<span class="line" id="L458">            .ROFS =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.ReadOnlyFileSystem,</span>
<span class="line" id="L459"></span>
<span class="line" id="L460">            .NOSYS =&gt; { <span class="tok-comment">// Use fallback.</span>
</span>
<span class="line" id="L461">                has_fchmodat2_syscall.store(<span class="tok-null">false</span>, .Monotonic);</span>
<span class="line" id="L462">                <span class="tok-kw">break</span>;</span>
<span class="line" id="L463">            },</span>
<span class="line" id="L464">            <span class="tok-kw">else</span> =&gt; |err| <span class="tok-kw">return</span> unexpectedErrno(err),</span>
<span class="line" id="L465">        }</span>
<span class="line" id="L466">    }</span>
<span class="line" id="L467"></span>
<span class="line" id="L468">    <span class="tok-comment">// Fallback to changing permissions using procfs:</span>
</span>
<span class="line" id="L469">    <span class="tok-comment">//</span>
</span>
<span class="line" id="L470">    <span class="tok-comment">// 1. Open `path` as a `PATH` descriptor.</span>
</span>
<span class="line" id="L471">    <span class="tok-comment">// 2. Stat the fd and check if it isn't a symbolic link.</span>
</span>
<span class="line" id="L472">    <span class="tok-comment">// 3. Generate the procfs reference to the fd via `/proc/self/fd/{fd}`.</span>
</span>
<span class="line" id="L473">    <span class="tok-comment">// 4. Pass the procfs path to `chmod` with the `mode`.</span>
</span>
<span class="line" id="L474">    <span class="tok-kw">var</span> pathfd: fd_t = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L475">    <span class="tok-kw">while</span> (<span class="tok-null">true</span>) {</span>
<span class="line" id="L476">        <span class="tok-kw">const</span> rc = system.openat(dirfd, &amp;path_c, .{ .PATH = <span class="tok-null">true</span>, .NOFOLLOW = <span class="tok-null">true</span>, .CLOEXEC = <span class="tok-null">true</span> }, <span class="tok-builtin">@as</span>(mode_t, <span class="tok-number">0</span>));</span>
<span class="line" id="L477">        <span class="tok-kw">switch</span> (system.getErrno(rc)) {</span>
<span class="line" id="L478">            .SUCCESS =&gt; {</span>
<span class="line" id="L479">                pathfd = <span class="tok-builtin">@intCast</span>(rc);</span>
<span class="line" id="L480">                <span class="tok-kw">break</span>;</span>
<span class="line" id="L481">            },</span>
<span class="line" id="L482">            .INTR =&gt; <span class="tok-kw">continue</span>,</span>
<span class="line" id="L483">            .FAULT =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L484">            .INVAL =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L485">            .ACCES =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.AccessDenied,</span>
<span class="line" id="L486">            .PERM =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.AccessDenied,</span>
<span class="line" id="L487">            .LOOP =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.SymLinkLoop,</span>
<span class="line" id="L488">            .MFILE =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.ProcessFdQuotaExceeded,</span>
<span class="line" id="L489">            .NAMETOOLONG =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.NameTooLong,</span>
<span class="line" id="L490">            .NFILE =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.SystemFdQuotaExceeded,</span>
<span class="line" id="L491">            .NOENT =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.FileNotFound,</span>
<span class="line" id="L492">            .NOMEM =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.SystemResources,</span>
<span class="line" id="L493">            <span class="tok-kw">else</span> =&gt; |err| <span class="tok-kw">return</span> unexpectedErrno(err),</span>
<span class="line" id="L494">        }</span>
<span class="line" id="L495">    }</span>
<span class="line" id="L496">    <span class="tok-kw">defer</span> close(pathfd);</span>
<span class="line" id="L497"></span>
<span class="line" id="L498">    <span class="tok-kw">const</span> stat = fstatatZ(pathfd, <span class="tok-str">&quot;&quot;</span>, AT.EMPTY_PATH) <span class="tok-kw">catch</span> |err| <span class="tok-kw">switch</span> (err) {</span>
<span class="line" id="L499">        <span class="tok-kw">error</span>.NameTooLong =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L500">        <span class="tok-kw">error</span>.FileNotFound =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L501">        <span class="tok-kw">error</span>.InvalidUtf8 =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L502">        <span class="tok-kw">else</span> =&gt; |e| <span class="tok-kw">return</span> e,</span>
<span class="line" id="L503">    };</span>
<span class="line" id="L504">    <span class="tok-kw">if</span> ((stat.mode &amp; S.IFMT) == S.IFLNK)</span>
<span class="line" id="L505">        <span class="tok-kw">return</span> <span class="tok-kw">error</span>.OperationNotSupported;</span>
<span class="line" id="L506"></span>
<span class="line" id="L507">    <span class="tok-kw">var</span> procfs_buf: [<span class="tok-str">&quot;/proc/self/fd/-2147483648\x00&quot;</span>.len]<span class="tok-type">u8</span> = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L508">    <span class="tok-kw">const</span> proc_path = std.fmt.bufPrintZ(procfs_buf[<span class="tok-number">0</span>..], <span class="tok-str">&quot;/proc/self/fd/{d}&quot;</span>, .{pathfd}) <span class="tok-kw">catch</span> <span class="tok-kw">unreachable</span>;</span>
<span class="line" id="L509">    <span class="tok-kw">while</span> (<span class="tok-null">true</span>) {</span>
<span class="line" id="L510">        <span class="tok-kw">const</span> res = system.chmod(proc_path, mode);</span>
<span class="line" id="L511">        <span class="tok-kw">switch</span> (system.getErrno(res)) {</span>
<span class="line" id="L512">            <span class="tok-comment">// Getting NOENT here means that procfs isn't mounted.</span>
</span>
<span class="line" id="L513">            .NOENT =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.OperationNotSupported,</span>
<span class="line" id="L514"></span>
<span class="line" id="L515">            .SUCCESS =&gt; <span class="tok-kw">return</span>,</span>
<span class="line" id="L516">            .INTR =&gt; <span class="tok-kw">continue</span>,</span>
<span class="line" id="L517">            .BADF =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L518">            .FAULT =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L519">            .INVAL =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L520">            .ACCES =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.AccessDenied,</span>
<span class="line" id="L521">            .IO =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.InputOutput,</span>
<span class="line" id="L522">            .LOOP =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.SymLinkLoop,</span>
<span class="line" id="L523">            .NOMEM =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.SystemResources,</span>
<span class="line" id="L524">            .NOTDIR =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.FileNotFound,</span>
<span class="line" id="L525">            .PERM =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.AccessDenied,</span>
<span class="line" id="L526">            .ROFS =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.ReadOnlyFileSystem,</span>
<span class="line" id="L527">            <span class="tok-kw">else</span> =&gt; |err| <span class="tok-kw">return</span> unexpectedErrno(err),</span>
<span class="line" id="L528">        }</span>
<span class="line" id="L529">    }</span>
<span class="line" id="L530">}</span>
<span class="line" id="L531"></span>
<span class="line" id="L532"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FChownError = <span class="tok-kw">error</span>{</span>
<span class="line" id="L533">    AccessDenied,</span>
<span class="line" id="L534">    InputOutput,</span>
<span class="line" id="L535">    SymLinkLoop,</span>
<span class="line" id="L536">    FileNotFound,</span>
<span class="line" id="L537">    SystemResources,</span>
<span class="line" id="L538">    ReadOnlyFileSystem,</span>
<span class="line" id="L539">} || UnexpectedError;</span>
<span class="line" id="L540"></span>
<span class="line" id="L541"><span class="tok-comment">/// Changes the owner and group of the file referred to by the file descriptor.</span></span>
<span class="line" id="L542"><span class="tok-comment">/// The process must have the correct privileges in order to do this</span></span>
<span class="line" id="L543"><span class="tok-comment">/// successfully. The group may be changed by the owner of the directory to</span></span>
<span class="line" id="L544"><span class="tok-comment">/// any group of which the owner is a member. If the owner or group is</span></span>
<span class="line" id="L545"><span class="tok-comment">/// specified as `null`, the ID is not changed.</span></span>
<span class="line" id="L546"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">fchown</span>(fd: fd_t, owner: ?uid_t, group: ?gid_t) FChownError!<span class="tok-type">void</span> {</span>
<span class="line" id="L547">    <span class="tok-kw">switch</span> (builtin.os.tag) {</span>
<span class="line" id="L548">        .windows, .wasi =&gt; <span class="tok-builtin">@compileError</span>(<span class="tok-str">&quot;Unsupported OS&quot;</span>),</span>
<span class="line" id="L549">        <span class="tok-kw">else</span> =&gt; {},</span>
<span class="line" id="L550">    }</span>
<span class="line" id="L551"></span>
<span class="line" id="L552">    <span class="tok-kw">while</span> (<span class="tok-null">true</span>) {</span>
<span class="line" id="L553">        <span class="tok-kw">const</span> res = system.fchown(fd, owner <span class="tok-kw">orelse</span> ~<span class="tok-builtin">@as</span>(uid_t, <span class="tok-number">0</span>), group <span class="tok-kw">orelse</span> ~<span class="tok-builtin">@as</span>(gid_t, <span class="tok-number">0</span>));</span>
<span class="line" id="L554"></span>
<span class="line" id="L555">        <span class="tok-kw">switch</span> (system.getErrno(res)) {</span>
<span class="line" id="L556">            .SUCCESS =&gt; <span class="tok-kw">return</span>,</span>
<span class="line" id="L557">            .INTR =&gt; <span class="tok-kw">continue</span>,</span>
<span class="line" id="L558">            .BADF =&gt; <span class="tok-kw">unreachable</span>, <span class="tok-comment">// Can be reached if the fd refers to a directory opened without `OpenDirOptions{ .iterate = true }`</span>
</span>
<span class="line" id="L559"></span>
<span class="line" id="L560">            .FAULT =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L561">            .INVAL =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L562">            .ACCES =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.AccessDenied,</span>
<span class="line" id="L563">            .IO =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.InputOutput,</span>
<span class="line" id="L564">            .LOOP =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.SymLinkLoop,</span>
<span class="line" id="L565">            .NOENT =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.FileNotFound,</span>
<span class="line" id="L566">            .NOMEM =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.SystemResources,</span>
<span class="line" id="L567">            .NOTDIR =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.FileNotFound,</span>
<span class="line" id="L568">            .PERM =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.AccessDenied,</span>
<span class="line" id="L569">            .ROFS =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.ReadOnlyFileSystem,</span>
<span class="line" id="L570">            <span class="tok-kw">else</span> =&gt; |err| <span class="tok-kw">return</span> unexpectedErrno(err),</span>
<span class="line" id="L571">        }</span>
<span class="line" id="L572">    }</span>
<span class="line" id="L573">}</span>
<span class="line" id="L574"></span>
<span class="line" id="L575"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> RebootError = <span class="tok-kw">error</span>{</span>
<span class="line" id="L576">    PermissionDenied,</span>
<span class="line" id="L577">} || UnexpectedError;</span>
<span class="line" id="L578"></span>
<span class="line" id="L579"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> RebootCommand = <span class="tok-kw">switch</span> (builtin.os.tag) {</span>
<span class="line" id="L580">    .linux =&gt; <span class="tok-kw">union</span>(linux.LINUX_REBOOT.CMD) {</span>
<span class="line" id="L581">        RESTART: <span class="tok-type">void</span>,</span>
<span class="line" id="L582">        HALT: <span class="tok-type">void</span>,</span>
<span class="line" id="L583">        CAD_ON: <span class="tok-type">void</span>,</span>
<span class="line" id="L584">        CAD_OFF: <span class="tok-type">void</span>,</span>
<span class="line" id="L585">        POWER_OFF: <span class="tok-type">void</span>,</span>
<span class="line" id="L586">        RESTART2: [*:<span class="tok-number">0</span>]<span class="tok-kw">const</span> <span class="tok-type">u8</span>,</span>
<span class="line" id="L587">        SW_SUSPEND: <span class="tok-type">void</span>,</span>
<span class="line" id="L588">        KEXEC: <span class="tok-type">void</span>,</span>
<span class="line" id="L589">    },</span>
<span class="line" id="L590">    <span class="tok-kw">else</span> =&gt; <span class="tok-builtin">@compileError</span>(<span class="tok-str">&quot;Unsupported OS&quot;</span>),</span>
<span class="line" id="L591">};</span>
<span class="line" id="L592"></span>
<span class="line" id="L593"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">reboot</span>(cmd: RebootCommand) RebootError!<span class="tok-type">void</span> {</span>
<span class="line" id="L594">    <span class="tok-kw">switch</span> (builtin.os.tag) {</span>
<span class="line" id="L595">        .linux =&gt; {</span>
<span class="line" id="L596">            <span class="tok-kw">switch</span> (system.getErrno(linux.reboot(</span>
<span class="line" id="L597">                .MAGIC1,</span>
<span class="line" id="L598">                .MAGIC2,</span>
<span class="line" id="L599">                cmd,</span>
<span class="line" id="L600">                <span class="tok-kw">switch</span> (cmd) {</span>
<span class="line" id="L601">                    .RESTART2 =&gt; |s| s,</span>
<span class="line" id="L602">                    <span class="tok-kw">else</span> =&gt; <span class="tok-null">null</span>,</span>
<span class="line" id="L603">                },</span>
<span class="line" id="L604">            ))) {</span>
<span class="line" id="L605">                .SUCCESS =&gt; {},</span>
<span class="line" id="L606">                .PERM =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.PermissionDenied,</span>
<span class="line" id="L607">                <span class="tok-kw">else</span> =&gt; |err| <span class="tok-kw">return</span> std.os.unexpectedErrno(err),</span>
<span class="line" id="L608">            }</span>
<span class="line" id="L609">            <span class="tok-kw">switch</span> (cmd) {</span>
<span class="line" id="L610">                .CAD_OFF =&gt; {},</span>
<span class="line" id="L611">                .CAD_ON =&gt; {},</span>
<span class="line" id="L612">                .SW_SUSPEND =&gt; {},</span>
<span class="line" id="L613"></span>
<span class="line" id="L614">                .HALT =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L615">                .KEXEC =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L616">                .POWER_OFF =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L617">                .RESTART =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L618">                .RESTART2 =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L619">            }</span>
<span class="line" id="L620">        },</span>
<span class="line" id="L621">        <span class="tok-kw">else</span> =&gt; <span class="tok-builtin">@compileError</span>(<span class="tok-str">&quot;Unsupported OS&quot;</span>),</span>
<span class="line" id="L622">    }</span>
<span class="line" id="L623">}</span>
<span class="line" id="L624"></span>
<span class="line" id="L625"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> GetRandomError = OpenError;</span>
<span class="line" id="L626"></span>
<span class="line" id="L627"><span class="tok-comment">/// Obtain a series of random bytes. These bytes can be used to seed user-space</span></span>
<span class="line" id="L628"><span class="tok-comment">/// random number generators or for cryptographic purposes.</span></span>
<span class="line" id="L629"><span class="tok-comment">/// When linking against libc, this calls the</span></span>
<span class="line" id="L630"><span class="tok-comment">/// appropriate OS-specific library call. Otherwise it uses the zig standard</span></span>
<span class="line" id="L631"><span class="tok-comment">/// library implementation.</span></span>
<span class="line" id="L632"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">getrandom</span>(buffer: []<span class="tok-type">u8</span>) GetRandomError!<span class="tok-type">void</span> {</span>
<span class="line" id="L633">    <span class="tok-kw">if</span> (builtin.os.tag == .windows) {</span>
<span class="line" id="L634">        <span class="tok-kw">return</span> windows.RtlGenRandom(buffer);</span>
<span class="line" id="L635">    }</span>
<span class="line" id="L636">    <span class="tok-kw">if</span> (builtin.os.tag == .linux <span class="tok-kw">or</span> builtin.os.tag == .freebsd) {</span>
<span class="line" id="L637">        <span class="tok-kw">var</span> buf = buffer;</span>
<span class="line" id="L638">        <span class="tok-kw">const</span> use_c = builtin.os.tag != .linux <span class="tok-kw">or</span></span>
<span class="line" id="L639">            std.c.versionCheck(std.SemanticVersion{ .major = <span class="tok-number">2</span>, .minor = <span class="tok-number">25</span>, .patch = <span class="tok-number">0</span> });</span>
<span class="line" id="L640"></span>
<span class="line" id="L641">        <span class="tok-kw">while</span> (buf.len != <span class="tok-number">0</span>) {</span>
<span class="line" id="L642">            <span class="tok-kw">const</span> num_read: <span class="tok-type">usize</span>, <span class="tok-kw">const</span> err = <span class="tok-kw">if</span> (use_c) res: {</span>
<span class="line" id="L643">                <span class="tok-kw">const</span> rc = std.c.getrandom(buf.ptr, buf.len, <span class="tok-number">0</span>);</span>
<span class="line" id="L644">                <span class="tok-kw">break</span> :res .{</span>
<span class="line" id="L645">                    <span class="tok-builtin">@bitCast</span>(rc),</span>
<span class="line" id="L646">                    std.c.getErrno(rc),</span>
<span class="line" id="L647">                };</span>
<span class="line" id="L648">            } <span class="tok-kw">else</span> res: {</span>
<span class="line" id="L649">                <span class="tok-kw">const</span> rc = linux.getrandom(buf.ptr, buf.len, <span class="tok-number">0</span>);</span>
<span class="line" id="L650">                <span class="tok-kw">break</span> :res .{</span>
<span class="line" id="L651">                    rc,</span>
<span class="line" id="L652">                    linux.getErrno(rc),</span>
<span class="line" id="L653">                };</span>
<span class="line" id="L654">            };</span>
<span class="line" id="L655"></span>
<span class="line" id="L656">            <span class="tok-kw">switch</span> (err) {</span>
<span class="line" id="L657">                .SUCCESS =&gt; buf = buf[num_read..],</span>
<span class="line" id="L658">                .INVAL =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L659">                .FAULT =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L660">                .INTR =&gt; <span class="tok-kw">continue</span>,</span>
<span class="line" id="L661">                .NOSYS =&gt; <span class="tok-kw">return</span> getRandomBytesDevURandom(buf),</span>
<span class="line" id="L662">                <span class="tok-kw">else</span> =&gt; <span class="tok-kw">return</span> unexpectedErrno(err),</span>
<span class="line" id="L663">            }</span>
<span class="line" id="L664">        }</span>
<span class="line" id="L665">        <span class="tok-kw">return</span>;</span>
<span class="line" id="L666">    }</span>
<span class="line" id="L667">    <span class="tok-kw">if</span> (builtin.os.tag == .emscripten) {</span>
<span class="line" id="L668">        <span class="tok-kw">const</span> err = std.c.getErrno(std.c.getentropy(buffer.ptr, buffer.len));</span>
<span class="line" id="L669">        <span class="tok-kw">switch</span> (err) {</span>
<span class="line" id="L670">            .SUCCESS =&gt; <span class="tok-kw">return</span>,</span>
<span class="line" id="L671">            <span class="tok-kw">else</span> =&gt; <span class="tok-kw">return</span> unexpectedErrno(err),</span>
<span class="line" id="L672">        }</span>
<span class="line" id="L673">    }</span>
<span class="line" id="L674">    <span class="tok-kw">switch</span> (builtin.os.tag) {</span>
<span class="line" id="L675">        .netbsd, .openbsd, .macos, .ios, .tvos, .watchos =&gt; {</span>
<span class="line" id="L676">            system.arc4random_buf(buffer.ptr, buffer.len);</span>
<span class="line" id="L677">            <span class="tok-kw">return</span>;</span>
<span class="line" id="L678">        },</span>
<span class="line" id="L679">        .wasi =&gt; <span class="tok-kw">switch</span> (wasi.random_get(buffer.ptr, buffer.len)) {</span>
<span class="line" id="L680">            .SUCCESS =&gt; <span class="tok-kw">return</span>,</span>
<span class="line" id="L681">            <span class="tok-kw">else</span> =&gt; |err| <span class="tok-kw">return</span> unexpectedErrno(err),</span>
<span class="line" id="L682">        },</span>
<span class="line" id="L683">        <span class="tok-kw">else</span> =&gt; <span class="tok-kw">return</span> getRandomBytesDevURandom(buffer),</span>
<span class="line" id="L684">    }</span>
<span class="line" id="L685">}</span>
<span class="line" id="L686"></span>
<span class="line" id="L687"><span class="tok-kw">fn</span> <span class="tok-fn">getRandomBytesDevURandom</span>(buf: []<span class="tok-type">u8</span>) !<span class="tok-type">void</span> {</span>
<span class="line" id="L688">    <span class="tok-kw">const</span> fd = <span class="tok-kw">try</span> openZ(<span class="tok-str">&quot;/dev/urandom&quot;</span>, .{ .ACCMODE = .RDONLY, .CLOEXEC = <span class="tok-null">true</span> }, <span class="tok-number">0</span>);</span>
<span class="line" id="L689">    <span class="tok-kw">defer</span> close(fd);</span>
<span class="line" id="L690"></span>
<span class="line" id="L691">    <span class="tok-kw">const</span> st = <span class="tok-kw">try</span> fstat(fd);</span>
<span class="line" id="L692">    <span class="tok-kw">if</span> (!S.ISCHR(st.mode)) {</span>
<span class="line" id="L693">        <span class="tok-kw">return</span> <span class="tok-kw">error</span>.NoDevice;</span>
<span class="line" id="L694">    }</span>
<span class="line" id="L695"></span>
<span class="line" id="L696">    <span class="tok-kw">const</span> file = std.fs.File{ .handle = fd };</span>
<span class="line" id="L697">    <span class="tok-kw">const</span> stream = file.reader();</span>
<span class="line" id="L698">    stream.readNoEof(buf) <span class="tok-kw">catch</span> <span class="tok-kw">return</span> <span class="tok-kw">error</span>.Unexpected;</span>
<span class="line" id="L699">}</span>
<span class="line" id="L700"></span>
<span class="line" id="L701"><span class="tok-comment">/// Causes abnormal process termination.</span></span>
<span class="line" id="L702"><span class="tok-comment">/// If linking against libc, this calls the abort() libc function. Otherwise</span></span>
<span class="line" id="L703"><span class="tok-comment">/// it raises SIGABRT followed by SIGKILL and finally lo</span></span>
<span class="line" id="L704"><span class="tok-comment">/// Invokes the current signal handler for SIGABRT, if any.</span></span>
<span class="line" id="L705"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">abort</span>() <span class="tok-type">noreturn</span> {</span>
<span class="line" id="L706">    <span class="tok-builtin">@setCold</span>(<span class="tok-null">true</span>);</span>
<span class="line" id="L707">    <span class="tok-comment">// MSVCRT abort() sometimes opens a popup window which is undesirable, so</span>
</span>
<span class="line" id="L708">    <span class="tok-comment">// even when linking libc on Windows we use our own abort implementation.</span>
</span>
<span class="line" id="L709">    <span class="tok-comment">// See https://github.com/ziglang/zig/issues/2071 for more details.</span>
</span>
<span class="line" id="L710">    <span class="tok-kw">if</span> (builtin.os.tag == .windows) {</span>
<span class="line" id="L711">        <span class="tok-kw">if</span> (builtin.mode == .Debug) {</span>
<span class="line" id="L712">            <span class="tok-builtin">@breakpoint</span>();</span>
<span class="line" id="L713">        }</span>
<span class="line" id="L714">        windows.kernel32.ExitProcess(<span class="tok-number">3</span>);</span>
<span class="line" id="L715">    }</span>
<span class="line" id="L716">    <span class="tok-kw">if</span> (!builtin.link_libc <span class="tok-kw">and</span> builtin.os.tag == .linux) {</span>
<span class="line" id="L717">        <span class="tok-comment">// The Linux man page says that the libc abort() function</span>
</span>
<span class="line" id="L718">        <span class="tok-comment">// &quot;first unblocks the SIGABRT signal&quot;, but this is a footgun</span>
</span>
<span class="line" id="L719">        <span class="tok-comment">// for user-defined signal handlers that want to restore some state in</span>
</span>
<span class="line" id="L720">        <span class="tok-comment">// some program sections and crash in others.</span>
</span>
<span class="line" id="L721">        <span class="tok-comment">// So, the user-installed SIGABRT handler is run, if present.</span>
</span>
<span class="line" id="L722">        raise(SIG.ABRT) <span class="tok-kw">catch</span> {};</span>
<span class="line" id="L723"></span>
<span class="line" id="L724">        <span class="tok-comment">// Disable all signal handlers.</span>
</span>
<span class="line" id="L725">        sigprocmask(SIG.BLOCK, &amp;linux.all_mask, <span class="tok-null">null</span>);</span>
<span class="line" id="L726"></span>
<span class="line" id="L727">        <span class="tok-comment">// Only one thread may proceed to the rest of abort().</span>
</span>
<span class="line" id="L728">        <span class="tok-kw">if</span> (!builtin.single_threaded) {</span>
<span class="line" id="L729">            <span class="tok-kw">const</span> global = <span class="tok-kw">struct</span> {</span>
<span class="line" id="L730">                <span class="tok-kw">var</span> abort_entered: <span class="tok-type">bool</span> = <span class="tok-null">false</span>;</span>
<span class="line" id="L731">            };</span>
<span class="line" id="L732">            <span class="tok-kw">while</span> (<span class="tok-builtin">@cmpxchgWeak</span>(<span class="tok-type">bool</span>, &amp;global.abort_entered, <span class="tok-null">false</span>, <span class="tok-null">true</span>, .SeqCst, .SeqCst)) |_| {}</span>
<span class="line" id="L733">        }</span>
<span class="line" id="L734"></span>
<span class="line" id="L735">        <span class="tok-comment">// Install default handler so that the tkill below will terminate.</span>
</span>
<span class="line" id="L736">        <span class="tok-kw">const</span> sigact = Sigaction{</span>
<span class="line" id="L737">            .handler = .{ .handler = SIG.DFL },</span>
<span class="line" id="L738">            .mask = empty_sigset,</span>
<span class="line" id="L739">            .flags = <span class="tok-number">0</span>,</span>
<span class="line" id="L740">        };</span>
<span class="line" id="L741">        sigaction(SIG.ABRT, &amp;sigact, <span class="tok-null">null</span>) <span class="tok-kw">catch</span> |err| <span class="tok-kw">switch</span> (err) {</span>
<span class="line" id="L742">            <span class="tok-kw">error</span>.OperationNotSupported =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L743">        };</span>
<span class="line" id="L744"></span>
<span class="line" id="L745">        _ = linux.tkill(linux.gettid(), SIG.ABRT);</span>
<span class="line" id="L746"></span>
<span class="line" id="L747">        <span class="tok-kw">const</span> sigabrtmask: linux.sigset_t = [_]<span class="tok-type">u32</span>{<span class="tok-number">0</span>} ** <span class="tok-number">31</span> ++ [_]<span class="tok-type">u32</span>{<span class="tok-number">1</span> &lt;&lt; (SIG.ABRT - <span class="tok-number">1</span>)};</span>
<span class="line" id="L748">        sigprocmask(SIG.UNBLOCK, &amp;sigabrtmask, <span class="tok-null">null</span>);</span>
<span class="line" id="L749"></span>
<span class="line" id="L750">        <span class="tok-comment">// Beyond this point should be unreachable.</span>
</span>
<span class="line" id="L751">        <span class="tok-builtin">@as</span>(*<span class="tok-kw">allowzero</span> <span class="tok-kw">volatile</span> <span class="tok-type">u8</span>, <span class="tok-builtin">@ptrFromInt</span>(<span class="tok-number">0</span>)).* = <span class="tok-number">0</span>;</span>
<span class="line" id="L752">        raise(SIG.KILL) <span class="tok-kw">catch</span> {};</span>
<span class="line" id="L753">        exit(<span class="tok-number">127</span>); <span class="tok-comment">// Pid 1 might not be signalled in some containers.</span>
</span>
<span class="line" id="L754">    }</span>
<span class="line" id="L755">    <span class="tok-kw">switch</span> (builtin.os.tag) {</span>
<span class="line" id="L756">        .uefi, .wasi, .emscripten, .cuda, .amdhsa =&gt; <span class="tok-builtin">@trap</span>(),</span>
<span class="line" id="L757">        <span class="tok-kw">else</span> =&gt; system.abort(),</span>
<span class="line" id="L758">    }</span>
<span class="line" id="L759">}</span>
<span class="line" id="L760"></span>
<span class="line" id="L761"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> RaiseError = UnexpectedError;</span>
<span class="line" id="L762"></span>
<span class="line" id="L763"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">raise</span>(sig: <span class="tok-type">u8</span>) RaiseError!<span class="tok-type">void</span> {</span>
<span class="line" id="L764">    <span class="tok-kw">if</span> (builtin.link_libc) {</span>
<span class="line" id="L765">        <span class="tok-kw">switch</span> (errno(system.raise(sig))) {</span>
<span class="line" id="L766">            .SUCCESS =&gt; <span class="tok-kw">return</span>,</span>
<span class="line" id="L767">            <span class="tok-kw">else</span> =&gt; |err| <span class="tok-kw">return</span> unexpectedErrno(err),</span>
<span class="line" id="L768">        }</span>
<span class="line" id="L769">    }</span>
<span class="line" id="L770"></span>
<span class="line" id="L771">    <span class="tok-kw">if</span> (builtin.os.tag == .linux) {</span>
<span class="line" id="L772">        <span class="tok-kw">var</span> set: sigset_t = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L773">        <span class="tok-comment">// block application signals</span>
</span>
<span class="line" id="L774">        sigprocmask(SIG.BLOCK, &amp;linux.app_mask, &amp;set);</span>
<span class="line" id="L775"></span>
<span class="line" id="L776">        <span class="tok-kw">const</span> tid = linux.gettid();</span>
<span class="line" id="L777">        <span class="tok-kw">const</span> rc = linux.tkill(tid, sig);</span>
<span class="line" id="L778"></span>
<span class="line" id="L779">        <span class="tok-comment">// restore signal mask</span>
</span>
<span class="line" id="L780">        sigprocmask(SIG.SETMASK, &amp;set, <span class="tok-null">null</span>);</span>
<span class="line" id="L781"></span>
<span class="line" id="L782">        <span class="tok-kw">switch</span> (errno(rc)) {</span>
<span class="line" id="L783">            .SUCCESS =&gt; <span class="tok-kw">return</span>,</span>
<span class="line" id="L784">            <span class="tok-kw">else</span> =&gt; |err| <span class="tok-kw">return</span> unexpectedErrno(err),</span>
<span class="line" id="L785">        }</span>
<span class="line" id="L786">    }</span>
<span class="line" id="L787"></span>
<span class="line" id="L788">    <span class="tok-builtin">@compileError</span>(<span class="tok-str">&quot;std.os.raise unimplemented for this target&quot;</span>);</span>
<span class="line" id="L789">}</span>
<span class="line" id="L790"></span>
<span class="line" id="L791"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> KillError = <span class="tok-kw">error</span>{ ProcessNotFound, PermissionDenied } || UnexpectedError;</span>
<span class="line" id="L792"></span>
<span class="line" id="L793"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">kill</span>(pid: pid_t, sig: <span class="tok-type">u8</span>) KillError!<span class="tok-type">void</span> {</span>
<span class="line" id="L794">    <span class="tok-kw">switch</span> (errno(system.kill(pid, sig))) {</span>
<span class="line" id="L795">        .SUCCESS =&gt; <span class="tok-kw">return</span>,</span>
<span class="line" id="L796">        .INVAL =&gt; <span class="tok-kw">unreachable</span>, <span class="tok-comment">// invalid signal</span>
</span>
<span class="line" id="L797">        .PERM =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.PermissionDenied,</span>
<span class="line" id="L798">        .SRCH =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.ProcessNotFound,</span>
<span class="line" id="L799">        <span class="tok-kw">else</span> =&gt; |err| <span class="tok-kw">return</span> unexpectedErrno(err),</span>
<span class="line" id="L800">    }</span>
<span class="line" id="L801">}</span>
<span class="line" id="L802"></span>
<span class="line" id="L803"><span class="tok-comment">/// Exits the program cleanly with the specified status code.</span></span>
<span class="line" id="L804"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">exit</span>(status: <span class="tok-type">u8</span>) <span class="tok-type">noreturn</span> {</span>
<span class="line" id="L805">    <span class="tok-kw">if</span> (builtin.link_libc) {</span>
<span class="line" id="L806">        system.exit(status);</span>
<span class="line" id="L807">    }</span>
<span class="line" id="L808">    <span class="tok-kw">if</span> (builtin.os.tag == .windows) {</span>
<span class="line" id="L809">        windows.kernel32.ExitProcess(status);</span>
<span class="line" id="L810">    }</span>
<span class="line" id="L811">    <span class="tok-kw">if</span> (builtin.os.tag == .wasi) {</span>
<span class="line" id="L812">        wasi.proc_exit(status);</span>
<span class="line" id="L813">    }</span>
<span class="line" id="L814">    <span class="tok-kw">if</span> (builtin.os.tag == .linux <span class="tok-kw">and</span> !builtin.single_threaded) {</span>
<span class="line" id="L815">        linux.exit_group(status);</span>
<span class="line" id="L816">    }</span>
<span class="line" id="L817">    <span class="tok-kw">if</span> (builtin.os.tag == .uefi) {</span>
<span class="line" id="L818">        <span class="tok-comment">// exit() is only available if exitBootServices() has not been called yet.</span>
</span>
<span class="line" id="L819">        <span class="tok-comment">// This call to exit should not fail, so we don't care about its return value.</span>
</span>
<span class="line" id="L820">        <span class="tok-kw">if</span> (uefi.system_table.boot_services) |bs| {</span>
<span class="line" id="L821">            _ = bs.exit(uefi.handle, <span class="tok-builtin">@enumFromInt</span>(status), <span class="tok-number">0</span>, <span class="tok-null">null</span>);</span>
<span class="line" id="L822">        }</span>
<span class="line" id="L823">        <span class="tok-comment">// If we can't exit, reboot the system instead.</span>
</span>
<span class="line" id="L824">        uefi.system_table.runtime_services.resetSystem(.ResetCold, <span class="tok-builtin">@enumFromInt</span>(status), <span class="tok-number">0</span>, <span class="tok-null">null</span>);</span>
<span class="line" id="L825">    }</span>
<span class="line" id="L826">    system.exit(status);</span>
<span class="line" id="L827">}</span>
<span class="line" id="L828"></span>
<span class="line" id="L829"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> ReadError = <span class="tok-kw">error</span>{</span>
<span class="line" id="L830">    InputOutput,</span>
<span class="line" id="L831">    SystemResources,</span>
<span class="line" id="L832">    IsDir,</span>
<span class="line" id="L833">    OperationAborted,</span>
<span class="line" id="L834">    BrokenPipe,</span>
<span class="line" id="L835">    ConnectionResetByPeer,</span>
<span class="line" id="L836">    ConnectionTimedOut,</span>
<span class="line" id="L837">    NotOpenForReading,</span>
<span class="line" id="L838">    SocketNotConnected,</span>
<span class="line" id="L839"></span>
<span class="line" id="L840">    <span class="tok-comment">/// This error occurs when no global event loop is configured,</span></span>
<span class="line" id="L841">    <span class="tok-comment">/// and reading from the file descriptor would block.</span></span>
<span class="line" id="L842">    WouldBlock,</span>
<span class="line" id="L843"></span>
<span class="line" id="L844">    <span class="tok-comment">/// In WASI, this error occurs when the file descriptor does</span></span>
<span class="line" id="L845">    <span class="tok-comment">/// not hold the required rights to read from it.</span></span>
<span class="line" id="L846">    AccessDenied,</span>
<span class="line" id="L847">} || UnexpectedError;</span>
<span class="line" id="L848"></span>
<span class="line" id="L849"><span class="tok-comment">/// Returns the number of bytes that were read, which can be less than</span></span>
<span class="line" id="L850"><span class="tok-comment">/// buf.len. If 0 bytes were read, that means EOF.</span></span>
<span class="line" id="L851"><span class="tok-comment">/// If `fd` is opened in non blocking mode, the function will return error.WouldBlock</span></span>
<span class="line" id="L852"><span class="tok-comment">/// when EAGAIN is received.</span></span>
<span class="line" id="L853"><span class="tok-comment">///</span></span>
<span class="line" id="L854"><span class="tok-comment">/// Linux has a limit on how many bytes may be transferred in one `read` call, which is `0x7ffff000`</span></span>
<span class="line" id="L855"><span class="tok-comment">/// on both 64-bit and 32-bit systems. This is due to using a signed C int as the return value, as</span></span>
<span class="line" id="L856"><span class="tok-comment">/// well as stuffing the errno codes into the last `4096` values. This is noted on the `read` man page.</span></span>
<span class="line" id="L857"><span class="tok-comment">/// The limit on Darwin is `0x7fffffff`, trying to read more than that returns EINVAL.</span></span>
<span class="line" id="L858"><span class="tok-comment">/// The corresponding POSIX limit is `math.maxInt(isize)`.</span></span>
<span class="line" id="L859"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">read</span>(fd: fd_t, buf: []<span class="tok-type">u8</span>) ReadError!<span class="tok-type">usize</span> {</span>
<span class="line" id="L860">    <span class="tok-kw">if</span> (buf.len == <span class="tok-number">0</span>) <span class="tok-kw">return</span> <span class="tok-number">0</span>;</span>
<span class="line" id="L861">    <span class="tok-kw">if</span> (builtin.os.tag == .windows) {</span>
<span class="line" id="L862">        <span class="tok-kw">return</span> windows.ReadFile(fd, buf, <span class="tok-null">null</span>);</span>
<span class="line" id="L863">    }</span>
<span class="line" id="L864">    <span class="tok-kw">if</span> (builtin.os.tag == .wasi <span class="tok-kw">and</span> !builtin.link_libc) {</span>
<span class="line" id="L865">        <span class="tok-kw">const</span> iovs = [<span class="tok-number">1</span>]iovec{iovec{</span>
<span class="line" id="L866">            .iov_base = buf.ptr,</span>
<span class="line" id="L867">            .iov_len = buf.len,</span>
<span class="line" id="L868">        }};</span>
<span class="line" id="L869"></span>
<span class="line" id="L870">        <span class="tok-kw">var</span> nread: <span class="tok-type">usize</span> = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L871">        <span class="tok-kw">switch</span> (wasi.fd_read(fd, &amp;iovs, iovs.len, &amp;nread)) {</span>
<span class="line" id="L872">            .SUCCESS =&gt; <span class="tok-kw">return</span> nread,</span>
<span class="line" id="L873">            .INTR =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L874">            .INVAL =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L875">            .FAULT =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L876">            .AGAIN =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L877">            .BADF =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.NotOpenForReading, <span class="tok-comment">// Can be a race condition.</span>
</span>
<span class="line" id="L878">            .IO =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.InputOutput,</span>
<span class="line" id="L879">            .ISDIR =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.IsDir,</span>
<span class="line" id="L880">            .NOBUFS =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.SystemResources,</span>
<span class="line" id="L881">            .NOMEM =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.SystemResources,</span>
<span class="line" id="L882">            .NOTCONN =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.SocketNotConnected,</span>
<span class="line" id="L883">            .CONNRESET =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.ConnectionResetByPeer,</span>
<span class="line" id="L884">            .TIMEDOUT =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.ConnectionTimedOut,</span>
<span class="line" id="L885">            .NOTCAPABLE =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.AccessDenied,</span>
<span class="line" id="L886">            <span class="tok-kw">else</span> =&gt; |err| <span class="tok-kw">return</span> unexpectedErrno(err),</span>
<span class="line" id="L887">        }</span>
<span class="line" id="L888">    }</span>
<span class="line" id="L889"></span>
<span class="line" id="L890">    <span class="tok-comment">// Prevents EINVAL.</span>
</span>
<span class="line" id="L891">    <span class="tok-kw">const</span> max_count = <span class="tok-kw">switch</span> (builtin.os.tag) {</span>
<span class="line" id="L892">        .linux =&gt; <span class="tok-number">0x7ffff000</span>,</span>
<span class="line" id="L893">        .macos, .ios, .watchos, .tvos =&gt; math.maxInt(<span class="tok-type">i32</span>),</span>
<span class="line" id="L894">        <span class="tok-kw">else</span> =&gt; math.maxInt(<span class="tok-type">isize</span>),</span>
<span class="line" id="L895">    };</span>
<span class="line" id="L896">    <span class="tok-kw">while</span> (<span class="tok-null">true</span>) {</span>
<span class="line" id="L897">        <span class="tok-kw">const</span> rc = system.read(fd, buf.ptr, <span class="tok-builtin">@min</span>(buf.len, max_count));</span>
<span class="line" id="L898">        <span class="tok-kw">switch</span> (errno(rc)) {</span>
<span class="line" id="L899">            .SUCCESS =&gt; <span class="tok-kw">return</span> <span class="tok-builtin">@intCast</span>(rc),</span>
<span class="line" id="L900">            .INTR =&gt; <span class="tok-kw">continue</span>,</span>
<span class="line" id="L901">            .INVAL =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L902">            .FAULT =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L903">            .AGAIN =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.WouldBlock,</span>
<span class="line" id="L904">            .BADF =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.NotOpenForReading, <span class="tok-comment">// Can be a race condition.</span>
</span>
<span class="line" id="L905">            .IO =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.InputOutput,</span>
<span class="line" id="L906">            .ISDIR =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.IsDir,</span>
<span class="line" id="L907">            .NOBUFS =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.SystemResources,</span>
<span class="line" id="L908">            .NOMEM =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.SystemResources,</span>
<span class="line" id="L909">            .NOTCONN =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.SocketNotConnected,</span>
<span class="line" id="L910">            .CONNRESET =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.ConnectionResetByPeer,</span>
<span class="line" id="L911">            .TIMEDOUT =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.ConnectionTimedOut,</span>
<span class="line" id="L912">            <span class="tok-kw">else</span> =&gt; |err| <span class="tok-kw">return</span> unexpectedErrno(err),</span>
<span class="line" id="L913">        }</span>
<span class="line" id="L914">    }</span>
<span class="line" id="L915">}</span>
<span class="line" id="L916"></span>
<span class="line" id="L917"><span class="tok-comment">/// Number of bytes read is returned. Upon reading end-of-file, zero is returned.</span></span>
<span class="line" id="L918"><span class="tok-comment">///</span></span>
<span class="line" id="L919"><span class="tok-comment">/// For POSIX systems, if `fd` is opened in non blocking mode, the function will</span></span>
<span class="line" id="L920"><span class="tok-comment">/// return error.WouldBlock when EAGAIN is received.</span></span>
<span class="line" id="L921"><span class="tok-comment">/// On Windows, if the application has a global event loop enabled, I/O Completion Ports are</span></span>
<span class="line" id="L922"><span class="tok-comment">/// used to perform the I/O. `error.WouldBlock` is not possible on Windows.</span></span>
<span class="line" id="L923"><span class="tok-comment">///</span></span>
<span class="line" id="L924"><span class="tok-comment">/// This operation is non-atomic on the following systems:</span></span>
<span class="line" id="L925"><span class="tok-comment">/// * Windows</span></span>
<span class="line" id="L926"><span class="tok-comment">/// On these systems, the read races with concurrent writes to the same file descriptor.</span></span>
<span class="line" id="L927"><span class="tok-comment">///</span></span>
<span class="line" id="L928"><span class="tok-comment">/// This function assumes that all vectors, including zero-length vectors, have</span></span>
<span class="line" id="L929"><span class="tok-comment">/// a pointer within the address space of the application.</span></span>
<span class="line" id="L930"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">readv</span>(fd: fd_t, iov: []<span class="tok-kw">const</span> iovec) ReadError!<span class="tok-type">usize</span> {</span>
<span class="line" id="L931">    <span class="tok-kw">if</span> (builtin.os.tag == .windows) {</span>
<span class="line" id="L932">        <span class="tok-comment">// TODO improve this to use ReadFileScatter</span>
</span>
<span class="line" id="L933">        <span class="tok-kw">if</span> (iov.len == <span class="tok-number">0</span>) <span class="tok-kw">return</span> <span class="tok-number">0</span>;</span>
<span class="line" id="L934">        <span class="tok-kw">const</span> first = iov[<span class="tok-number">0</span>];</span>
<span class="line" id="L935">        <span class="tok-kw">return</span> read(fd, first.iov_base[<span class="tok-number">0</span>..first.iov_len]);</span>
<span class="line" id="L936">    }</span>
<span class="line" id="L937">    <span class="tok-kw">if</span> (builtin.os.tag == .wasi <span class="tok-kw">and</span> !builtin.link_libc) {</span>
<span class="line" id="L938">        <span class="tok-kw">var</span> nread: <span class="tok-type">usize</span> = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L939">        <span class="tok-kw">switch</span> (wasi.fd_read(fd, iov.ptr, iov.len, &amp;nread)) {</span>
<span class="line" id="L940">            .SUCCESS =&gt; <span class="tok-kw">return</span> nread,</span>
<span class="line" id="L941">            .INTR =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L942">            .INVAL =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L943">            .FAULT =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L944">            .AGAIN =&gt; <span class="tok-kw">unreachable</span>, <span class="tok-comment">// currently not support in WASI</span>
</span>
<span class="line" id="L945">            .BADF =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.NotOpenForReading, <span class="tok-comment">// can be a race condition</span>
</span>
<span class="line" id="L946">            .IO =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.InputOutput,</span>
<span class="line" id="L947">            .ISDIR =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.IsDir,</span>
<span class="line" id="L948">            .NOBUFS =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.SystemResources,</span>
<span class="line" id="L949">            .NOMEM =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.SystemResources,</span>
<span class="line" id="L950">            .NOTCONN =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.SocketNotConnected,</span>
<span class="line" id="L951">            .CONNRESET =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.ConnectionResetByPeer,</span>
<span class="line" id="L952">            .TIMEDOUT =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.ConnectionTimedOut,</span>
<span class="line" id="L953">            .NOTCAPABLE =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.AccessDenied,</span>
<span class="line" id="L954">            <span class="tok-kw">else</span> =&gt; |err| <span class="tok-kw">return</span> unexpectedErrno(err),</span>
<span class="line" id="L955">        }</span>
<span class="line" id="L956">    }</span>
<span class="line" id="L957"></span>
<span class="line" id="L958">    <span class="tok-kw">while</span> (<span class="tok-null">true</span>) {</span>
<span class="line" id="L959">        <span class="tok-kw">const</span> rc = system.readv(fd, iov.ptr, <span class="tok-builtin">@min</span>(iov.len, IOV_MAX));</span>
<span class="line" id="L960">        <span class="tok-kw">switch</span> (errno(rc)) {</span>
<span class="line" id="L961">            .SUCCESS =&gt; <span class="tok-kw">return</span> <span class="tok-builtin">@intCast</span>(rc),</span>
<span class="line" id="L962">            .INTR =&gt; <span class="tok-kw">continue</span>,</span>
<span class="line" id="L963">            .INVAL =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L964">            .FAULT =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L965">            .AGAIN =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.WouldBlock,</span>
<span class="line" id="L966">            .BADF =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.NotOpenForReading, <span class="tok-comment">// can be a race condition</span>
</span>
<span class="line" id="L967">            .IO =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.InputOutput,</span>
<span class="line" id="L968">            .ISDIR =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.IsDir,</span>
<span class="line" id="L969">            .NOBUFS =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.SystemResources,</span>
<span class="line" id="L970">            .NOMEM =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.SystemResources,</span>
<span class="line" id="L971">            .NOTCONN =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.SocketNotConnected,</span>
<span class="line" id="L972">            .CONNRESET =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.ConnectionResetByPeer,</span>
<span class="line" id="L973">            .TIMEDOUT =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.ConnectionTimedOut,</span>
<span class="line" id="L974">            <span class="tok-kw">else</span> =&gt; |err| <span class="tok-kw">return</span> unexpectedErrno(err),</span>
<span class="line" id="L975">        }</span>
<span class="line" id="L976">    }</span>
<span class="line" id="L977">}</span>
<span class="line" id="L978"></span>
<span class="line" id="L979"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> PReadError = ReadError || <span class="tok-kw">error</span>{Unseekable};</span>
<span class="line" id="L980"></span>
<span class="line" id="L981"><span class="tok-comment">/// Number of bytes read is returned. Upon reading end-of-file, zero is returned.</span></span>
<span class="line" id="L982"><span class="tok-comment">///</span></span>
<span class="line" id="L983"><span class="tok-comment">/// Retries when interrupted by a signal.</span></span>
<span class="line" id="L984"><span class="tok-comment">///</span></span>
<span class="line" id="L985"><span class="tok-comment">/// For POSIX systems, if `fd` is opened in non blocking mode, the function will</span></span>
<span class="line" id="L986"><span class="tok-comment">/// return error.WouldBlock when EAGAIN is received.</span></span>
<span class="line" id="L987"><span class="tok-comment">/// On Windows, if the application has a global event loop enabled, I/O Completion Ports are</span></span>
<span class="line" id="L988"><span class="tok-comment">/// used to perform the I/O. `error.WouldBlock` is not possible on Windows.</span></span>
<span class="line" id="L989"><span class="tok-comment">///</span></span>
<span class="line" id="L990"><span class="tok-comment">/// Linux has a limit on how many bytes may be transferred in one `pread` call, which is `0x7ffff000`</span></span>
<span class="line" id="L991"><span class="tok-comment">/// on both 64-bit and 32-bit systems. This is due to using a signed C int as the return value, as</span></span>
<span class="line" id="L992"><span class="tok-comment">/// well as stuffing the errno codes into the last `4096` values. This is noted on the `read` man page.</span></span>
<span class="line" id="L993"><span class="tok-comment">/// The limit on Darwin is `0x7fffffff`, trying to read more than that returns EINVAL.</span></span>
<span class="line" id="L994"><span class="tok-comment">/// The corresponding POSIX limit is `math.maxInt(isize)`.</span></span>
<span class="line" id="L995"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">pread</span>(fd: fd_t, buf: []<span class="tok-type">u8</span>, offset: <span class="tok-type">u64</span>) PReadError!<span class="tok-type">usize</span> {</span>
<span class="line" id="L996">    <span class="tok-kw">if</span> (buf.len == <span class="tok-number">0</span>) <span class="tok-kw">return</span> <span class="tok-number">0</span>;</span>
<span class="line" id="L997">    <span class="tok-kw">if</span> (builtin.os.tag == .windows) {</span>
<span class="line" id="L998">        <span class="tok-kw">return</span> windows.ReadFile(fd, buf, offset);</span>
<span class="line" id="L999">    }</span>
<span class="line" id="L1000">    <span class="tok-kw">if</span> (builtin.os.tag == .wasi <span class="tok-kw">and</span> !builtin.link_libc) {</span>
<span class="line" id="L1001">        <span class="tok-kw">const</span> iovs = [<span class="tok-number">1</span>]iovec{iovec{</span>
<span class="line" id="L1002">            .iov_base = buf.ptr,</span>
<span class="line" id="L1003">            .iov_len = buf.len,</span>
<span class="line" id="L1004">        }};</span>
<span class="line" id="L1005"></span>
<span class="line" id="L1006">        <span class="tok-kw">var</span> nread: <span class="tok-type">usize</span> = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L1007">        <span class="tok-kw">switch</span> (wasi.fd_pread(fd, &amp;iovs, iovs.len, offset, &amp;nread)) {</span>
<span class="line" id="L1008">            .SUCCESS =&gt; <span class="tok-kw">return</span> nread,</span>
<span class="line" id="L1009">            .INTR =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L1010">            .INVAL =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L1011">            .FAULT =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L1012">            .AGAIN =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L1013">            .BADF =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.NotOpenForReading, <span class="tok-comment">// Can be a race condition.</span>
</span>
<span class="line" id="L1014">            .IO =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.InputOutput,</span>
<span class="line" id="L1015">            .ISDIR =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.IsDir,</span>
<span class="line" id="L1016">            .NOBUFS =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.SystemResources,</span>
<span class="line" id="L1017">            .NOMEM =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.SystemResources,</span>
<span class="line" id="L1018">            .NOTCONN =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.SocketNotConnected,</span>
<span class="line" id="L1019">            .CONNRESET =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.ConnectionResetByPeer,</span>
<span class="line" id="L1020">            .TIMEDOUT =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.ConnectionTimedOut,</span>
<span class="line" id="L1021">            .NXIO =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.Unseekable,</span>
<span class="line" id="L1022">            .SPIPE =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.Unseekable,</span>
<span class="line" id="L1023">            .OVERFLOW =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.Unseekable,</span>
<span class="line" id="L1024">            .NOTCAPABLE =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.AccessDenied,</span>
<span class="line" id="L1025">            <span class="tok-kw">else</span> =&gt; |err| <span class="tok-kw">return</span> unexpectedErrno(err),</span>
<span class="line" id="L1026">        }</span>
<span class="line" id="L1027">    }</span>
<span class="line" id="L1028"></span>
<span class="line" id="L1029">    <span class="tok-comment">// Prevent EINVAL.</span>
</span>
<span class="line" id="L1030">    <span class="tok-kw">const</span> max_count = <span class="tok-kw">switch</span> (builtin.os.tag) {</span>
<span class="line" id="L1031">        .linux =&gt; <span class="tok-number">0x7ffff000</span>,</span>
<span class="line" id="L1032">        .macos, .ios, .watchos, .tvos =&gt; math.maxInt(<span class="tok-type">i32</span>),</span>
<span class="line" id="L1033">        <span class="tok-kw">else</span> =&gt; math.maxInt(<span class="tok-type">isize</span>),</span>
<span class="line" id="L1034">    };</span>
<span class="line" id="L1035"></span>
<span class="line" id="L1036">    <span class="tok-kw">const</span> pread_sym = <span class="tok-kw">if</span> (lfs64_abi) system.pread64 <span class="tok-kw">else</span> system.pread;</span>
<span class="line" id="L1037">    <span class="tok-kw">while</span> (<span class="tok-null">true</span>) {</span>
<span class="line" id="L1038">        <span class="tok-kw">const</span> rc = pread_sym(fd, buf.ptr, <span class="tok-builtin">@min</span>(buf.len, max_count), <span class="tok-builtin">@bitCast</span>(offset));</span>
<span class="line" id="L1039">        <span class="tok-kw">switch</span> (errno(rc)) {</span>
<span class="line" id="L1040">            .SUCCESS =&gt; <span class="tok-kw">return</span> <span class="tok-builtin">@intCast</span>(rc),</span>
<span class="line" id="L1041">            .INTR =&gt; <span class="tok-kw">continue</span>,</span>
<span class="line" id="L1042">            .INVAL =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L1043">            .FAULT =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L1044">            .AGAIN =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.WouldBlock,</span>
<span class="line" id="L1045">            .BADF =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.NotOpenForReading, <span class="tok-comment">// Can be a race condition.</span>
</span>
<span class="line" id="L1046">            .IO =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.InputOutput,</span>
<span class="line" id="L1047">            .ISDIR =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.IsDir,</span>
<span class="line" id="L1048">            .NOBUFS =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.SystemResources,</span>
<span class="line" id="L1049">            .NOMEM =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.SystemResources,</span>
<span class="line" id="L1050">            .NOTCONN =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.SocketNotConnected,</span>
<span class="line" id="L1051">            .CONNRESET =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.ConnectionResetByPeer,</span>
<span class="line" id="L1052">            .TIMEDOUT =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.ConnectionTimedOut,</span>
<span class="line" id="L1053">            .NXIO =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.Unseekable,</span>
<span class="line" id="L1054">            .SPIPE =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.Unseekable,</span>
<span class="line" id="L1055">            .OVERFLOW =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.Unseekable,</span>
<span class="line" id="L1056">            <span class="tok-kw">else</span> =&gt; |err| <span class="tok-kw">return</span> unexpectedErrno(err),</span>
<span class="line" id="L1057">        }</span>
<span class="line" id="L1058">    }</span>
<span class="line" id="L1059">}</span>
<span class="line" id="L1060"></span>
<span class="line" id="L1061"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> TruncateError = <span class="tok-kw">error</span>{</span>
<span class="line" id="L1062">    FileTooBig,</span>
<span class="line" id="L1063">    InputOutput,</span>
<span class="line" id="L1064">    FileBusy,</span>
<span class="line" id="L1065"></span>
<span class="line" id="L1066">    <span class="tok-comment">/// In WASI, this error occurs when the file descriptor does</span></span>
<span class="line" id="L1067">    <span class="tok-comment">/// not hold the required rights to call `ftruncate` on it.</span></span>
<span class="line" id="L1068">    AccessDenied,</span>
<span class="line" id="L1069">} || UnexpectedError;</span>
<span class="line" id="L1070"></span>
<span class="line" id="L1071"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">ftruncate</span>(fd: fd_t, length: <span class="tok-type">u64</span>) TruncateError!<span class="tok-type">void</span> {</span>
<span class="line" id="L1072">    <span class="tok-kw">if</span> (builtin.os.tag == .windows) {</span>
<span class="line" id="L1073">        <span class="tok-kw">var</span> io_status_block: windows.IO_STATUS_BLOCK = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L1074">        <span class="tok-kw">var</span> eof_info = windows.FILE_END_OF_FILE_INFORMATION{</span>
<span class="line" id="L1075">            .EndOfFile = <span class="tok-builtin">@bitCast</span>(length),</span>
<span class="line" id="L1076">        };</span>
<span class="line" id="L1077"></span>
<span class="line" id="L1078">        <span class="tok-kw">const</span> rc = windows.ntdll.NtSetInformationFile(</span>
<span class="line" id="L1079">            fd,</span>
<span class="line" id="L1080">            &amp;io_status_block,</span>
<span class="line" id="L1081">            &amp;eof_info,</span>
<span class="line" id="L1082">            <span class="tok-builtin">@sizeOf</span>(windows.FILE_END_OF_FILE_INFORMATION),</span>
<span class="line" id="L1083">            .FileEndOfFileInformation,</span>
<span class="line" id="L1084">        );</span>
<span class="line" id="L1085"></span>
<span class="line" id="L1086">        <span class="tok-kw">switch</span> (rc) {</span>
<span class="line" id="L1087">            .SUCCESS =&gt; <span class="tok-kw">return</span>,</span>
<span class="line" id="L1088">            .INVALID_HANDLE =&gt; <span class="tok-kw">unreachable</span>, <span class="tok-comment">// Handle not open for writing</span>
</span>
<span class="line" id="L1089">            .ACCESS_DENIED =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.AccessDenied,</span>
<span class="line" id="L1090">            <span class="tok-kw">else</span> =&gt; <span class="tok-kw">return</span> windows.unexpectedStatus(rc),</span>
<span class="line" id="L1091">        }</span>
<span class="line" id="L1092">    }</span>
<span class="line" id="L1093">    <span class="tok-kw">if</span> (builtin.os.tag == .wasi <span class="tok-kw">and</span> !builtin.link_libc) {</span>
<span class="line" id="L1094">        <span class="tok-kw">switch</span> (wasi.fd_filestat_set_size(fd, length)) {</span>
<span class="line" id="L1095">            .SUCCESS =&gt; <span class="tok-kw">return</span>,</span>
<span class="line" id="L1096">            .INTR =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L1097">            .FBIG =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.FileTooBig,</span>
<span class="line" id="L1098">            .IO =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.InputOutput,</span>
<span class="line" id="L1099">            .PERM =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.AccessDenied,</span>
<span class="line" id="L1100">            .TXTBSY =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.FileBusy,</span>
<span class="line" id="L1101">            .BADF =&gt; <span class="tok-kw">unreachable</span>, <span class="tok-comment">// Handle not open for writing</span>
</span>
<span class="line" id="L1102">            .INVAL =&gt; <span class="tok-kw">unreachable</span>, <span class="tok-comment">// Handle not open for writing</span>
</span>
<span class="line" id="L1103">            .NOTCAPABLE =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.AccessDenied,</span>
<span class="line" id="L1104">            <span class="tok-kw">else</span> =&gt; |err| <span class="tok-kw">return</span> unexpectedErrno(err),</span>
<span class="line" id="L1105">        }</span>
<span class="line" id="L1106">    }</span>
<span class="line" id="L1107"></span>
<span class="line" id="L1108">    <span class="tok-kw">const</span> ftruncate_sym = <span class="tok-kw">if</span> (lfs64_abi) system.ftruncate64 <span class="tok-kw">else</span> system.ftruncate;</span>
<span class="line" id="L1109">    <span class="tok-kw">while</span> (<span class="tok-null">true</span>) {</span>
<span class="line" id="L1110">        <span class="tok-kw">switch</span> (errno(ftruncate_sym(fd, <span class="tok-builtin">@bitCast</span>(length)))) {</span>
<span class="line" id="L1111">            .SUCCESS =&gt; <span class="tok-kw">return</span>,</span>
<span class="line" id="L1112">            .INTR =&gt; <span class="tok-kw">continue</span>,</span>
<span class="line" id="L1113">            .FBIG =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.FileTooBig,</span>
<span class="line" id="L1114">            .IO =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.InputOutput,</span>
<span class="line" id="L1115">            .PERM =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.AccessDenied,</span>
<span class="line" id="L1116">            .TXTBSY =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.FileBusy,</span>
<span class="line" id="L1117">            .BADF =&gt; <span class="tok-kw">unreachable</span>, <span class="tok-comment">// Handle not open for writing</span>
</span>
<span class="line" id="L1118">            .INVAL =&gt; <span class="tok-kw">unreachable</span>, <span class="tok-comment">// Handle not open for writing</span>
</span>
<span class="line" id="L1119">            <span class="tok-kw">else</span> =&gt; |err| <span class="tok-kw">return</span> unexpectedErrno(err),</span>
<span class="line" id="L1120">        }</span>
<span class="line" id="L1121">    }</span>
<span class="line" id="L1122">}</span>
<span class="line" id="L1123"></span>
<span class="line" id="L1124"><span class="tok-comment">/// Number of bytes read is returned. Upon reading end-of-file, zero is returned.</span></span>
<span class="line" id="L1125"><span class="tok-comment">///</span></span>
<span class="line" id="L1126"><span class="tok-comment">/// Retries when interrupted by a signal.</span></span>
<span class="line" id="L1127"><span class="tok-comment">///</span></span>
<span class="line" id="L1128"><span class="tok-comment">/// For POSIX systems, if `fd` is opened in non blocking mode, the function will</span></span>
<span class="line" id="L1129"><span class="tok-comment">/// return error.WouldBlock when EAGAIN is received.</span></span>
<span class="line" id="L1130"><span class="tok-comment">/// On Windows, if the application has a global event loop enabled, I/O Completion Ports are</span></span>
<span class="line" id="L1131"><span class="tok-comment">/// used to perform the I/O. `error.WouldBlock` is not possible on Windows.</span></span>
<span class="line" id="L1132"><span class="tok-comment">///</span></span>
<span class="line" id="L1133"><span class="tok-comment">/// This operation is non-atomic on the following systems:</span></span>
<span class="line" id="L1134"><span class="tok-comment">/// * Darwin</span></span>
<span class="line" id="L1135"><span class="tok-comment">/// * Windows</span></span>
<span class="line" id="L1136"><span class="tok-comment">/// On these systems, the read races with concurrent writes to the same file descriptor.</span></span>
<span class="line" id="L1137"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">preadv</span>(fd: fd_t, iov: []<span class="tok-kw">const</span> iovec, offset: <span class="tok-type">u64</span>) PReadError!<span class="tok-type">usize</span> {</span>
<span class="line" id="L1138">    <span class="tok-kw">const</span> have_pread_but_not_preadv = <span class="tok-kw">switch</span> (builtin.os.tag) {</span>
<span class="line" id="L1139">        .windows, .macos, .ios, .watchos, .tvos, .haiku =&gt; <span class="tok-null">true</span>,</span>
<span class="line" id="L1140">        <span class="tok-kw">else</span> =&gt; <span class="tok-null">false</span>,</span>
<span class="line" id="L1141">    };</span>
<span class="line" id="L1142">    <span class="tok-kw">if</span> (have_pread_but_not_preadv) {</span>
<span class="line" id="L1143">        <span class="tok-comment">// We could loop here; but proper usage of `preadv` must handle partial reads anyway.</span>
</span>
<span class="line" id="L1144">        <span class="tok-comment">// So we simply read into the first vector only.</span>
</span>
<span class="line" id="L1145">        <span class="tok-kw">if</span> (iov.len == <span class="tok-number">0</span>) <span class="tok-kw">return</span> <span class="tok-number">0</span>;</span>
<span class="line" id="L1146">        <span class="tok-kw">const</span> first = iov[<span class="tok-number">0</span>];</span>
<span class="line" id="L1147">        <span class="tok-kw">return</span> pread(fd, first.iov_base[<span class="tok-number">0</span>..first.iov_len], offset);</span>
<span class="line" id="L1148">    }</span>
<span class="line" id="L1149">    <span class="tok-kw">if</span> (builtin.os.tag == .wasi <span class="tok-kw">and</span> !builtin.link_libc) {</span>
<span class="line" id="L1150">        <span class="tok-kw">var</span> nread: <span class="tok-type">usize</span> = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L1151">        <span class="tok-kw">switch</span> (wasi.fd_pread(fd, iov.ptr, iov.len, offset, &amp;nread)) {</span>
<span class="line" id="L1152">            .SUCCESS =&gt; <span class="tok-kw">return</span> nread,</span>
<span class="line" id="L1153">            .INTR =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L1154">            .INVAL =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L1155">            .FAULT =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L1156">            .AGAIN =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L1157">            .BADF =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.NotOpenForReading, <span class="tok-comment">// can be a race condition</span>
</span>
<span class="line" id="L1158">            .IO =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.InputOutput,</span>
<span class="line" id="L1159">            .ISDIR =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.IsDir,</span>
<span class="line" id="L1160">            .NOBUFS =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.SystemResources,</span>
<span class="line" id="L1161">            .NOMEM =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.SystemResources,</span>
<span class="line" id="L1162">            .NOTCONN =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.SocketNotConnected,</span>
<span class="line" id="L1163">            .CONNRESET =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.ConnectionResetByPeer,</span>
<span class="line" id="L1164">            .TIMEDOUT =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.ConnectionTimedOut,</span>
<span class="line" id="L1165">            .NXIO =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.Unseekable,</span>
<span class="line" id="L1166">            .SPIPE =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.Unseekable,</span>
<span class="line" id="L1167">            .OVERFLOW =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.Unseekable,</span>
<span class="line" id="L1168">            .NOTCAPABLE =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.AccessDenied,</span>
<span class="line" id="L1169">            <span class="tok-kw">else</span> =&gt; |err| <span class="tok-kw">return</span> unexpectedErrno(err),</span>
<span class="line" id="L1170">        }</span>
<span class="line" id="L1171">    }</span>
<span class="line" id="L1172"></span>
<span class="line" id="L1173">    <span class="tok-kw">const</span> preadv_sym = <span class="tok-kw">if</span> (lfs64_abi) system.preadv64 <span class="tok-kw">else</span> system.preadv;</span>
<span class="line" id="L1174">    <span class="tok-kw">while</span> (<span class="tok-null">true</span>) {</span>
<span class="line" id="L1175">        <span class="tok-kw">const</span> rc = preadv_sym(fd, iov.ptr, <span class="tok-builtin">@min</span>(iov.len, IOV_MAX), <span class="tok-builtin">@bitCast</span>(offset));</span>
<span class="line" id="L1176">        <span class="tok-kw">switch</span> (errno(rc)) {</span>
<span class="line" id="L1177">            .SUCCESS =&gt; <span class="tok-kw">return</span> <span class="tok-builtin">@bitCast</span>(rc),</span>
<span class="line" id="L1178">            .INTR =&gt; <span class="tok-kw">continue</span>,</span>
<span class="line" id="L1179">            .INVAL =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L1180">            .FAULT =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L1181">            .AGAIN =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.WouldBlock,</span>
<span class="line" id="L1182">            .BADF =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.NotOpenForReading, <span class="tok-comment">// can be a race condition</span>
</span>
<span class="line" id="L1183">            .IO =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.InputOutput,</span>
<span class="line" id="L1184">            .ISDIR =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.IsDir,</span>
<span class="line" id="L1185">            .NOBUFS =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.SystemResources,</span>
<span class="line" id="L1186">            .NOMEM =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.SystemResources,</span>
<span class="line" id="L1187">            .NOTCONN =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.SocketNotConnected,</span>
<span class="line" id="L1188">            .CONNRESET =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.ConnectionResetByPeer,</span>
<span class="line" id="L1189">            .TIMEDOUT =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.ConnectionTimedOut,</span>
<span class="line" id="L1190">            .NXIO =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.Unseekable,</span>
<span class="line" id="L1191">            .SPIPE =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.Unseekable,</span>
<span class="line" id="L1192">            .OVERFLOW =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.Unseekable,</span>
<span class="line" id="L1193">            <span class="tok-kw">else</span> =&gt; |err| <span class="tok-kw">return</span> unexpectedErrno(err),</span>
<span class="line" id="L1194">        }</span>
<span class="line" id="L1195">    }</span>
<span class="line" id="L1196">}</span>
<span class="line" id="L1197"></span>
<span class="line" id="L1198"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> WriteError = <span class="tok-kw">error</span>{</span>
<span class="line" id="L1199">    DiskQuota,</span>
<span class="line" id="L1200">    FileTooBig,</span>
<span class="line" id="L1201">    InputOutput,</span>
<span class="line" id="L1202">    NoSpaceLeft,</span>
<span class="line" id="L1203">    DeviceBusy,</span>
<span class="line" id="L1204">    InvalidArgument,</span>
<span class="line" id="L1205"></span>
<span class="line" id="L1206">    <span class="tok-comment">/// In WASI, this error may occur when the file descriptor does</span></span>
<span class="line" id="L1207">    <span class="tok-comment">/// not hold the required rights to write to it.</span></span>
<span class="line" id="L1208">    AccessDenied,</span>
<span class="line" id="L1209">    BrokenPipe,</span>
<span class="line" id="L1210">    SystemResources,</span>
<span class="line" id="L1211">    OperationAborted,</span>
<span class="line" id="L1212">    NotOpenForWriting,</span>
<span class="line" id="L1213"></span>
<span class="line" id="L1214">    <span class="tok-comment">/// The process cannot access the file because another process has locked</span></span>
<span class="line" id="L1215">    <span class="tok-comment">/// a portion of the file. Windows-only.</span></span>
<span class="line" id="L1216">    LockViolation,</span>
<span class="line" id="L1217"></span>
<span class="line" id="L1218">    <span class="tok-comment">/// This error occurs when no global event loop is configured,</span></span>
<span class="line" id="L1219">    <span class="tok-comment">/// and reading from the file descriptor would block.</span></span>
<span class="line" id="L1220">    WouldBlock,</span>
<span class="line" id="L1221"></span>
<span class="line" id="L1222">    <span class="tok-comment">/// Connection reset by peer.</span></span>
<span class="line" id="L1223">    ConnectionResetByPeer,</span>
<span class="line" id="L1224">} || UnexpectedError;</span>
<span class="line" id="L1225"></span>
<span class="line" id="L1226"><span class="tok-comment">/// Write to a file descriptor.</span></span>
<span class="line" id="L1227"><span class="tok-comment">/// Retries when interrupted by a signal.</span></span>
<span class="line" id="L1228"><span class="tok-comment">/// Returns the number of bytes written. If nonzero bytes were supplied, this will be nonzero.</span></span>
<span class="line" id="L1229"><span class="tok-comment">///</span></span>
<span class="line" id="L1230"><span class="tok-comment">/// Note that a successful write() may transfer fewer than count bytes.  Such partial  writes  can</span></span>
<span class="line" id="L1231"><span class="tok-comment">/// occur  for  various reasons; for example, because there was insufficient space on the disk</span></span>
<span class="line" id="L1232"><span class="tok-comment">/// device to write all of the requested bytes, or because a blocked write() to a socket,  pipe,  or</span></span>
<span class="line" id="L1233"><span class="tok-comment">/// similar  was  interrupted by a signal handler after it had transferred some, but before it had</span></span>
<span class="line" id="L1234"><span class="tok-comment">/// transferred all of the requested bytes.  In the event of a partial write, the caller can  make</span></span>
<span class="line" id="L1235"><span class="tok-comment">/// another  write() call to transfer the remaining bytes.  The subsequent call will either</span></span>
<span class="line" id="L1236"><span class="tok-comment">/// transfer further bytes or may result in an error (e.g., if the disk is now full).</span></span>
<span class="line" id="L1237"><span class="tok-comment">///</span></span>
<span class="line" id="L1238"><span class="tok-comment">/// For POSIX systems, if `fd` is opened in non blocking mode, the function will</span></span>
<span class="line" id="L1239"><span class="tok-comment">/// return error.WouldBlock when EAGAIN is received.</span></span>
<span class="line" id="L1240"><span class="tok-comment">/// On Windows, if the application has a global event loop enabled, I/O Completion Ports are</span></span>
<span class="line" id="L1241"><span class="tok-comment">/// used to perform the I/O. `error.WouldBlock` is not possible on Windows.</span></span>
<span class="line" id="L1242"><span class="tok-comment">///</span></span>
<span class="line" id="L1243"><span class="tok-comment">/// Linux has a limit on how many bytes may be transferred in one `write` call, which is `0x7ffff000`</span></span>
<span class="line" id="L1244"><span class="tok-comment">/// on both 64-bit and 32-bit systems. This is due to using a signed C int as the return value, as</span></span>
<span class="line" id="L1245"><span class="tok-comment">/// well as stuffing the errno codes into the last `4096` values. This is noted on the `write` man page.</span></span>
<span class="line" id="L1246"><span class="tok-comment">/// The limit on Darwin is `0x7fffffff`, trying to read more than that returns EINVAL.</span></span>
<span class="line" id="L1247"><span class="tok-comment">/// The corresponding POSIX limit is `math.maxInt(isize)`.</span></span>
<span class="line" id="L1248"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">write</span>(fd: fd_t, bytes: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>) WriteError!<span class="tok-type">usize</span> {</span>
<span class="line" id="L1249">    <span class="tok-kw">if</span> (bytes.len == <span class="tok-number">0</span>) <span class="tok-kw">return</span> <span class="tok-number">0</span>;</span>
<span class="line" id="L1250">    <span class="tok-kw">if</span> (builtin.os.tag == .windows) {</span>
<span class="line" id="L1251">        <span class="tok-kw">return</span> windows.WriteFile(fd, bytes, <span class="tok-null">null</span>);</span>
<span class="line" id="L1252">    }</span>
<span class="line" id="L1253"></span>
<span class="line" id="L1254">    <span class="tok-kw">if</span> (builtin.os.tag == .wasi <span class="tok-kw">and</span> !builtin.link_libc) {</span>
<span class="line" id="L1255">        <span class="tok-kw">const</span> ciovs = [_]iovec_const{iovec_const{</span>
<span class="line" id="L1256">            .iov_base = bytes.ptr,</span>
<span class="line" id="L1257">            .iov_len = bytes.len,</span>
<span class="line" id="L1258">        }};</span>
<span class="line" id="L1259">        <span class="tok-kw">var</span> nwritten: <span class="tok-type">usize</span> = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L1260">        <span class="tok-kw">switch</span> (wasi.fd_write(fd, &amp;ciovs, ciovs.len, &amp;nwritten)) {</span>
<span class="line" id="L1261">            .SUCCESS =&gt; <span class="tok-kw">return</span> nwritten,</span>
<span class="line" id="L1262">            .INTR =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L1263">            .INVAL =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L1264">            .FAULT =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L1265">            .AGAIN =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L1266">            .BADF =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.NotOpenForWriting, <span class="tok-comment">// can be a race condition.</span>
</span>
<span class="line" id="L1267">            .DESTADDRREQ =&gt; <span class="tok-kw">unreachable</span>, <span class="tok-comment">// `connect` was never called.</span>
</span>
<span class="line" id="L1268">            .DQUOT =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.DiskQuota,</span>
<span class="line" id="L1269">            .FBIG =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.FileTooBig,</span>
<span class="line" id="L1270">            .IO =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.InputOutput,</span>
<span class="line" id="L1271">            .NOSPC =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.NoSpaceLeft,</span>
<span class="line" id="L1272">            .PERM =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.AccessDenied,</span>
<span class="line" id="L1273">            .PIPE =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.BrokenPipe,</span>
<span class="line" id="L1274">            .NOTCAPABLE =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.AccessDenied,</span>
<span class="line" id="L1275">            <span class="tok-kw">else</span> =&gt; |err| <span class="tok-kw">return</span> unexpectedErrno(err),</span>
<span class="line" id="L1276">        }</span>
<span class="line" id="L1277">    }</span>
<span class="line" id="L1278"></span>
<span class="line" id="L1279">    <span class="tok-kw">const</span> max_count = <span class="tok-kw">switch</span> (builtin.os.tag) {</span>
<span class="line" id="L1280">        .linux =&gt; <span class="tok-number">0x7ffff000</span>,</span>
<span class="line" id="L1281">        .macos, .ios, .watchos, .tvos =&gt; math.maxInt(<span class="tok-type">i32</span>),</span>
<span class="line" id="L1282">        <span class="tok-kw">else</span> =&gt; math.maxInt(<span class="tok-type">isize</span>),</span>
<span class="line" id="L1283">    };</span>
<span class="line" id="L1284">    <span class="tok-kw">while</span> (<span class="tok-null">true</span>) {</span>
<span class="line" id="L1285">        <span class="tok-kw">const</span> rc = system.write(fd, bytes.ptr, <span class="tok-builtin">@min</span>(bytes.len, max_count));</span>
<span class="line" id="L1286">        <span class="tok-kw">switch</span> (errno(rc)) {</span>
<span class="line" id="L1287">            .SUCCESS =&gt; <span class="tok-kw">return</span> <span class="tok-builtin">@intCast</span>(rc),</span>
<span class="line" id="L1288">            .INTR =&gt; <span class="tok-kw">continue</span>,</span>
<span class="line" id="L1289">            .INVAL =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.InvalidArgument,</span>
<span class="line" id="L1290">            .FAULT =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L1291">            .AGAIN =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.WouldBlock,</span>
<span class="line" id="L1292">            .BADF =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.NotOpenForWriting, <span class="tok-comment">// can be a race condition.</span>
</span>
<span class="line" id="L1293">            .DESTADDRREQ =&gt; <span class="tok-kw">unreachable</span>, <span class="tok-comment">// `connect` was never called.</span>
</span>
<span class="line" id="L1294">            .DQUOT =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.DiskQuota,</span>
<span class="line" id="L1295">            .FBIG =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.FileTooBig,</span>
<span class="line" id="L1296">            .IO =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.InputOutput,</span>
<span class="line" id="L1297">            .NOSPC =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.NoSpaceLeft,</span>
<span class="line" id="L1298">            .PERM =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.AccessDenied,</span>
<span class="line" id="L1299">            .PIPE =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.BrokenPipe,</span>
<span class="line" id="L1300">            .CONNRESET =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.ConnectionResetByPeer,</span>
<span class="line" id="L1301">            .BUSY =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.DeviceBusy,</span>
<span class="line" id="L1302">            <span class="tok-kw">else</span> =&gt; |err| <span class="tok-kw">return</span> unexpectedErrno(err),</span>
<span class="line" id="L1303">        }</span>
<span class="line" id="L1304">    }</span>
<span class="line" id="L1305">}</span>
<span class="line" id="L1306"></span>
<span class="line" id="L1307"><span class="tok-comment">/// Write multiple buffers to a file descriptor.</span></span>
<span class="line" id="L1308"><span class="tok-comment">/// Retries when interrupted by a signal.</span></span>
<span class="line" id="L1309"><span class="tok-comment">/// Returns the number of bytes written. If nonzero bytes were supplied, this will be nonzero.</span></span>
<span class="line" id="L1310"><span class="tok-comment">///</span></span>
<span class="line" id="L1311"><span class="tok-comment">/// Note that a successful write() may transfer fewer bytes than supplied.  Such partial  writes  can</span></span>
<span class="line" id="L1312"><span class="tok-comment">/// occur  for  various reasons; for example, because there was insufficient space on the disk</span></span>
<span class="line" id="L1313"><span class="tok-comment">/// device to write all of the requested bytes, or because a blocked write() to a socket,  pipe,  or</span></span>
<span class="line" id="L1314"><span class="tok-comment">/// similar  was  interrupted by a signal handler after it had transferred some, but before it had</span></span>
<span class="line" id="L1315"><span class="tok-comment">/// transferred all of the requested bytes.  In the event of a partial write, the caller can  make</span></span>
<span class="line" id="L1316"><span class="tok-comment">/// another  write() call to transfer the remaining bytes.  The subsequent call will either</span></span>
<span class="line" id="L1317"><span class="tok-comment">/// transfer further bytes or may result in an error (e.g., if the disk is now full).</span></span>
<span class="line" id="L1318"><span class="tok-comment">///</span></span>
<span class="line" id="L1319"><span class="tok-comment">/// For POSIX systems, if `fd` is opened in non blocking mode, the function will</span></span>
<span class="line" id="L1320"><span class="tok-comment">/// return error.WouldBlock when EAGAIN is received.</span></span>
<span class="line" id="L1321"><span class="tok-comment">/// On Windows, if the application has a global event loop enabled, I/O Completion Ports are</span></span>
<span class="line" id="L1322"><span class="tok-comment">/// used to perform the I/O. `error.WouldBlock` is not possible on Windows.</span></span>
<span class="line" id="L1323"><span class="tok-comment">///</span></span>
<span class="line" id="L1324"><span class="tok-comment">/// If `iov.len` is larger than `IOV_MAX`, a partial write will occur.</span></span>
<span class="line" id="L1325"><span class="tok-comment">///</span></span>
<span class="line" id="L1326"><span class="tok-comment">/// This function assumes that all vectors, including zero-length vectors, have</span></span>
<span class="line" id="L1327"><span class="tok-comment">/// a pointer within the address space of the application.</span></span>
<span class="line" id="L1328"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">writev</span>(fd: fd_t, iov: []<span class="tok-kw">const</span> iovec_const) WriteError!<span class="tok-type">usize</span> {</span>
<span class="line" id="L1329">    <span class="tok-kw">if</span> (builtin.os.tag == .windows) {</span>
<span class="line" id="L1330">        <span class="tok-comment">// TODO improve this to use WriteFileScatter</span>
</span>
<span class="line" id="L1331">        <span class="tok-kw">if</span> (iov.len == <span class="tok-number">0</span>) <span class="tok-kw">return</span> <span class="tok-number">0</span>;</span>
<span class="line" id="L1332">        <span class="tok-kw">const</span> first = iov[<span class="tok-number">0</span>];</span>
<span class="line" id="L1333">        <span class="tok-kw">return</span> write(fd, first.iov_base[<span class="tok-number">0</span>..first.iov_len]);</span>
<span class="line" id="L1334">    }</span>
<span class="line" id="L1335">    <span class="tok-kw">if</span> (builtin.os.tag == .wasi <span class="tok-kw">and</span> !builtin.link_libc) {</span>
<span class="line" id="L1336">        <span class="tok-kw">var</span> nwritten: <span class="tok-type">usize</span> = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L1337">        <span class="tok-kw">switch</span> (wasi.fd_write(fd, iov.ptr, iov.len, &amp;nwritten)) {</span>
<span class="line" id="L1338">            .SUCCESS =&gt; <span class="tok-kw">return</span> nwritten,</span>
<span class="line" id="L1339">            .INTR =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L1340">            .INVAL =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L1341">            .FAULT =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L1342">            .AGAIN =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L1343">            .BADF =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.NotOpenForWriting, <span class="tok-comment">// can be a race condition.</span>
</span>
<span class="line" id="L1344">            .DESTADDRREQ =&gt; <span class="tok-kw">unreachable</span>, <span class="tok-comment">// `connect` was never called.</span>
</span>
<span class="line" id="L1345">            .DQUOT =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.DiskQuota,</span>
<span class="line" id="L1346">            .FBIG =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.FileTooBig,</span>
<span class="line" id="L1347">            .IO =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.InputOutput,</span>
<span class="line" id="L1348">            .NOSPC =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.NoSpaceLeft,</span>
<span class="line" id="L1349">            .PERM =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.AccessDenied,</span>
<span class="line" id="L1350">            .PIPE =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.BrokenPipe,</span>
<span class="line" id="L1351">            .NOTCAPABLE =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.AccessDenied,</span>
<span class="line" id="L1352">            <span class="tok-kw">else</span> =&gt; |err| <span class="tok-kw">return</span> unexpectedErrno(err),</span>
<span class="line" id="L1353">        }</span>
<span class="line" id="L1354">    }</span>
<span class="line" id="L1355"></span>
<span class="line" id="L1356">    <span class="tok-kw">while</span> (<span class="tok-null">true</span>) {</span>
<span class="line" id="L1357">        <span class="tok-kw">const</span> rc = system.writev(fd, iov.ptr, <span class="tok-builtin">@min</span>(iov.len, IOV_MAX));</span>
<span class="line" id="L1358">        <span class="tok-kw">switch</span> (errno(rc)) {</span>
<span class="line" id="L1359">            .SUCCESS =&gt; <span class="tok-kw">return</span> <span class="tok-builtin">@intCast</span>(rc),</span>
<span class="line" id="L1360">            .INTR =&gt; <span class="tok-kw">continue</span>,</span>
<span class="line" id="L1361">            .INVAL =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.InvalidArgument,</span>
<span class="line" id="L1362">            .FAULT =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L1363">            .AGAIN =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.WouldBlock,</span>
<span class="line" id="L1364">            .BADF =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.NotOpenForWriting, <span class="tok-comment">// Can be a race condition.</span>
</span>
<span class="line" id="L1365">            .DESTADDRREQ =&gt; <span class="tok-kw">unreachable</span>, <span class="tok-comment">// `connect` was never called.</span>
</span>
<span class="line" id="L1366">            .DQUOT =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.DiskQuota,</span>
<span class="line" id="L1367">            .FBIG =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.FileTooBig,</span>
<span class="line" id="L1368">            .IO =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.InputOutput,</span>
<span class="line" id="L1369">            .NOSPC =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.NoSpaceLeft,</span>
<span class="line" id="L1370">            .PERM =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.AccessDenied,</span>
<span class="line" id="L1371">            .PIPE =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.BrokenPipe,</span>
<span class="line" id="L1372">            .CONNRESET =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.ConnectionResetByPeer,</span>
<span class="line" id="L1373">            .BUSY =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.DeviceBusy,</span>
<span class="line" id="L1374">            <span class="tok-kw">else</span> =&gt; |err| <span class="tok-kw">return</span> unexpectedErrno(err),</span>
<span class="line" id="L1375">        }</span>
<span class="line" id="L1376">    }</span>
<span class="line" id="L1377">}</span>
<span class="line" id="L1378"></span>
<span class="line" id="L1379"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> PWriteError = WriteError || <span class="tok-kw">error</span>{Unseekable};</span>
<span class="line" id="L1380"></span>
<span class="line" id="L1381"><span class="tok-comment">/// Write to a file descriptor, with a position offset.</span></span>
<span class="line" id="L1382"><span class="tok-comment">/// Retries when interrupted by a signal.</span></span>
<span class="line" id="L1383"><span class="tok-comment">/// Returns the number of bytes written. If nonzero bytes were supplied, this will be nonzero.</span></span>
<span class="line" id="L1384"><span class="tok-comment">///</span></span>
<span class="line" id="L1385"><span class="tok-comment">/// Note that a successful write() may transfer fewer bytes than supplied.  Such partial  writes  can</span></span>
<span class="line" id="L1386"><span class="tok-comment">/// occur  for  various reasons; for example, because there was insufficient space on the disk</span></span>
<span class="line" id="L1387"><span class="tok-comment">/// device to write all of the requested bytes, or because a blocked write() to a socket,  pipe,  or</span></span>
<span class="line" id="L1388"><span class="tok-comment">/// similar  was  interrupted by a signal handler after it had transferred some, but before it had</span></span>
<span class="line" id="L1389"><span class="tok-comment">/// transferred all of the requested bytes.  In the event of a partial write, the caller can  make</span></span>
<span class="line" id="L1390"><span class="tok-comment">/// another  write() call to transfer the remaining bytes.  The subsequent call will either</span></span>
<span class="line" id="L1391"><span class="tok-comment">/// transfer further bytes or may result in an error (e.g., if the disk is now full).</span></span>
<span class="line" id="L1392"><span class="tok-comment">///</span></span>
<span class="line" id="L1393"><span class="tok-comment">/// For POSIX systems, if `fd` is opened in non blocking mode, the function will</span></span>
<span class="line" id="L1394"><span class="tok-comment">/// return error.WouldBlock when EAGAIN is received.</span></span>
<span class="line" id="L1395"><span class="tok-comment">/// On Windows, if the application has a global event loop enabled, I/O Completion Ports are</span></span>
<span class="line" id="L1396"><span class="tok-comment">/// used to perform the I/O. `error.WouldBlock` is not possible on Windows.</span></span>
<span class="line" id="L1397"><span class="tok-comment">///</span></span>
<span class="line" id="L1398"><span class="tok-comment">/// Linux has a limit on how many bytes may be transferred in one `pwrite` call, which is `0x7ffff000`</span></span>
<span class="line" id="L1399"><span class="tok-comment">/// on both 64-bit and 32-bit systems. This is due to using a signed C int as the return value, as</span></span>
<span class="line" id="L1400"><span class="tok-comment">/// well as stuffing the errno codes into the last `4096` values. This is noted on the `write` man page.</span></span>
<span class="line" id="L1401"><span class="tok-comment">/// The limit on Darwin is `0x7fffffff`, trying to write more than that returns EINVAL.</span></span>
<span class="line" id="L1402"><span class="tok-comment">/// The corresponding POSIX limit is `math.maxInt(isize)`.</span></span>
<span class="line" id="L1403"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">pwrite</span>(fd: fd_t, bytes: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>, offset: <span class="tok-type">u64</span>) PWriteError!<span class="tok-type">usize</span> {</span>
<span class="line" id="L1404">    <span class="tok-kw">if</span> (bytes.len == <span class="tok-number">0</span>) <span class="tok-kw">return</span> <span class="tok-number">0</span>;</span>
<span class="line" id="L1405">    <span class="tok-kw">if</span> (builtin.os.tag == .windows) {</span>
<span class="line" id="L1406">        <span class="tok-kw">return</span> windows.WriteFile(fd, bytes, offset);</span>
<span class="line" id="L1407">    }</span>
<span class="line" id="L1408">    <span class="tok-kw">if</span> (builtin.os.tag == .wasi <span class="tok-kw">and</span> !builtin.link_libc) {</span>
<span class="line" id="L1409">        <span class="tok-kw">const</span> ciovs = [<span class="tok-number">1</span>]iovec_const{iovec_const{</span>
<span class="line" id="L1410">            .iov_base = bytes.ptr,</span>
<span class="line" id="L1411">            .iov_len = bytes.len,</span>
<span class="line" id="L1412">        }};</span>
<span class="line" id="L1413"></span>
<span class="line" id="L1414">        <span class="tok-kw">var</span> nwritten: <span class="tok-type">usize</span> = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L1415">        <span class="tok-kw">switch</span> (wasi.fd_pwrite(fd, &amp;ciovs, ciovs.len, offset, &amp;nwritten)) {</span>
<span class="line" id="L1416">            .SUCCESS =&gt; <span class="tok-kw">return</span> nwritten,</span>
<span class="line" id="L1417">            .INTR =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L1418">            .INVAL =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L1419">            .FAULT =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L1420">            .AGAIN =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L1421">            .BADF =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.NotOpenForWriting, <span class="tok-comment">// can be a race condition.</span>
</span>
<span class="line" id="L1422">            .DESTADDRREQ =&gt; <span class="tok-kw">unreachable</span>, <span class="tok-comment">// `connect` was never called.</span>
</span>
<span class="line" id="L1423">            .DQUOT =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.DiskQuota,</span>
<span class="line" id="L1424">            .FBIG =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.FileTooBig,</span>
<span class="line" id="L1425">            .IO =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.InputOutput,</span>
<span class="line" id="L1426">            .NOSPC =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.NoSpaceLeft,</span>
<span class="line" id="L1427">            .PERM =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.AccessDenied,</span>
<span class="line" id="L1428">            .PIPE =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.BrokenPipe,</span>
<span class="line" id="L1429">            .NXIO =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.Unseekable,</span>
<span class="line" id="L1430">            .SPIPE =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.Unseekable,</span>
<span class="line" id="L1431">            .OVERFLOW =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.Unseekable,</span>
<span class="line" id="L1432">            .NOTCAPABLE =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.AccessDenied,</span>
<span class="line" id="L1433">            <span class="tok-kw">else</span> =&gt; |err| <span class="tok-kw">return</span> unexpectedErrno(err),</span>
<span class="line" id="L1434">        }</span>
<span class="line" id="L1435">    }</span>
<span class="line" id="L1436"></span>
<span class="line" id="L1437">    <span class="tok-comment">// Prevent EINVAL.</span>
</span>
<span class="line" id="L1438">    <span class="tok-kw">const</span> max_count = <span class="tok-kw">switch</span> (builtin.os.tag) {</span>
<span class="line" id="L1439">        .linux =&gt; <span class="tok-number">0x7ffff000</span>,</span>
<span class="line" id="L1440">        .macos, .ios, .watchos, .tvos =&gt; math.maxInt(<span class="tok-type">i32</span>),</span>
<span class="line" id="L1441">        <span class="tok-kw">else</span> =&gt; math.maxInt(<span class="tok-type">isize</span>),</span>
<span class="line" id="L1442">    };</span>
<span class="line" id="L1443"></span>
<span class="line" id="L1444">    <span class="tok-kw">const</span> pwrite_sym = <span class="tok-kw">if</span> (lfs64_abi) system.pwrite64 <span class="tok-kw">else</span> system.pwrite;</span>
<span class="line" id="L1445">    <span class="tok-kw">while</span> (<span class="tok-null">true</span>) {</span>
<span class="line" id="L1446">        <span class="tok-kw">const</span> rc = pwrite_sym(fd, bytes.ptr, <span class="tok-builtin">@min</span>(bytes.len, max_count), <span class="tok-builtin">@bitCast</span>(offset));</span>
<span class="line" id="L1447">        <span class="tok-kw">switch</span> (errno(rc)) {</span>
<span class="line" id="L1448">            .SUCCESS =&gt; <span class="tok-kw">return</span> <span class="tok-builtin">@intCast</span>(rc),</span>
<span class="line" id="L1449">            .INTR =&gt; <span class="tok-kw">continue</span>,</span>
<span class="line" id="L1450">            .INVAL =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.InvalidArgument,</span>
<span class="line" id="L1451">            .FAULT =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L1452">            .AGAIN =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.WouldBlock,</span>
<span class="line" id="L1453">            .BADF =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.NotOpenForWriting, <span class="tok-comment">// Can be a race condition.</span>
</span>
<span class="line" id="L1454">            .DESTADDRREQ =&gt; <span class="tok-kw">unreachable</span>, <span class="tok-comment">// `connect` was never called.</span>
</span>
<span class="line" id="L1455">            .DQUOT =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.DiskQuota,</span>
<span class="line" id="L1456">            .FBIG =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.FileTooBig,</span>
<span class="line" id="L1457">            .IO =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.InputOutput,</span>
<span class="line" id="L1458">            .NOSPC =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.NoSpaceLeft,</span>
<span class="line" id="L1459">            .PERM =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.AccessDenied,</span>
<span class="line" id="L1460">            .PIPE =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.BrokenPipe,</span>
<span class="line" id="L1461">            .NXIO =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.Unseekable,</span>
<span class="line" id="L1462">            .SPIPE =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.Unseekable,</span>
<span class="line" id="L1463">            .OVERFLOW =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.Unseekable,</span>
<span class="line" id="L1464">            .BUSY =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.DeviceBusy,</span>
<span class="line" id="L1465">            <span class="tok-kw">else</span> =&gt; |err| <span class="tok-kw">return</span> unexpectedErrno(err),</span>
<span class="line" id="L1466">        }</span>
<span class="line" id="L1467">    }</span>
<span class="line" id="L1468">}</span>
<span class="line" id="L1469"></span>
<span class="line" id="L1470"><span class="tok-comment">/// Write multiple buffers to a file descriptor, with a position offset.</span></span>
<span class="line" id="L1471"><span class="tok-comment">/// Retries when interrupted by a signal.</span></span>
<span class="line" id="L1472"><span class="tok-comment">/// Returns the number of bytes written. If nonzero bytes were supplied, this will be nonzero.</span></span>
<span class="line" id="L1473"><span class="tok-comment">///</span></span>
<span class="line" id="L1474"><span class="tok-comment">/// Note that a successful write() may transfer fewer than count bytes.  Such partial  writes  can</span></span>
<span class="line" id="L1475"><span class="tok-comment">/// occur  for  various reasons; for example, because there was insufficient space on the disk</span></span>
<span class="line" id="L1476"><span class="tok-comment">/// device to write all of the requested bytes, or because a blocked write() to a socket,  pipe,  or</span></span>
<span class="line" id="L1477"><span class="tok-comment">/// similar  was  interrupted by a signal handler after it had transferred some, but before it had</span></span>
<span class="line" id="L1478"><span class="tok-comment">/// transferred all of the requested bytes.  In the event of a partial write, the caller can  make</span></span>
<span class="line" id="L1479"><span class="tok-comment">/// another  write() call to transfer the remaining bytes.  The subsequent call will either</span></span>
<span class="line" id="L1480"><span class="tok-comment">/// transfer further bytes or may result in an error (e.g., if the disk is now full).</span></span>
<span class="line" id="L1481"><span class="tok-comment">///</span></span>
<span class="line" id="L1482"><span class="tok-comment">/// If `fd` is opened in non blocking mode, the function will</span></span>
<span class="line" id="L1483"><span class="tok-comment">/// return error.WouldBlock when EAGAIN is received.</span></span>
<span class="line" id="L1484"><span class="tok-comment">///</span></span>
<span class="line" id="L1485"><span class="tok-comment">/// The following systems do not have this syscall, and will return partial writes if more than one</span></span>
<span class="line" id="L1486"><span class="tok-comment">/// vector is provided:</span></span>
<span class="line" id="L1487"><span class="tok-comment">/// * Darwin</span></span>
<span class="line" id="L1488"><span class="tok-comment">/// * Windows</span></span>
<span class="line" id="L1489"><span class="tok-comment">///</span></span>
<span class="line" id="L1490"><span class="tok-comment">/// If `iov.len` is larger than `IOV_MAX`, a partial write will occur.</span></span>
<span class="line" id="L1491"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">pwritev</span>(fd: fd_t, iov: []<span class="tok-kw">const</span> iovec_const, offset: <span class="tok-type">u64</span>) PWriteError!<span class="tok-type">usize</span> {</span>
<span class="line" id="L1492">    <span class="tok-kw">const</span> have_pwrite_but_not_pwritev = <span class="tok-kw">switch</span> (builtin.os.tag) {</span>
<span class="line" id="L1493">        .windows, .macos, .ios, .watchos, .tvos, .haiku =&gt; <span class="tok-null">true</span>,</span>
<span class="line" id="L1494">        <span class="tok-kw">else</span> =&gt; <span class="tok-null">false</span>,</span>
<span class="line" id="L1495">    };</span>
<span class="line" id="L1496"></span>
<span class="line" id="L1497">    <span class="tok-kw">if</span> (have_pwrite_but_not_pwritev) {</span>
<span class="line" id="L1498">        <span class="tok-comment">// We could loop here; but proper usage of `pwritev` must handle partial writes anyway.</span>
</span>
<span class="line" id="L1499">        <span class="tok-comment">// So we simply write the first vector only.</span>
</span>
<span class="line" id="L1500">        <span class="tok-kw">if</span> (iov.len == <span class="tok-number">0</span>) <span class="tok-kw">return</span> <span class="tok-number">0</span>;</span>
<span class="line" id="L1501">        <span class="tok-kw">const</span> first = iov[<span class="tok-number">0</span>];</span>
<span class="line" id="L1502">        <span class="tok-kw">return</span> pwrite(fd, first.iov_base[<span class="tok-number">0</span>..first.iov_len], offset);</span>
<span class="line" id="L1503">    }</span>
<span class="line" id="L1504">    <span class="tok-kw">if</span> (builtin.os.tag == .wasi <span class="tok-kw">and</span> !builtin.link_libc) {</span>
<span class="line" id="L1505">        <span class="tok-kw">var</span> nwritten: <span class="tok-type">usize</span> = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L1506">        <span class="tok-kw">switch</span> (wasi.fd_pwrite(fd, iov.ptr, iov.len, offset, &amp;nwritten)) {</span>
<span class="line" id="L1507">            .SUCCESS =&gt; <span class="tok-kw">return</span> nwritten,</span>
<span class="line" id="L1508">            .INTR =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L1509">            .INVAL =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L1510">            .FAULT =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L1511">            .AGAIN =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L1512">            .BADF =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.NotOpenForWriting, <span class="tok-comment">// Can be a race condition.</span>
</span>
<span class="line" id="L1513">            .DESTADDRREQ =&gt; <span class="tok-kw">unreachable</span>, <span class="tok-comment">// `connect` was never called.</span>
</span>
<span class="line" id="L1514">            .DQUOT =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.DiskQuota,</span>
<span class="line" id="L1515">            .FBIG =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.FileTooBig,</span>
<span class="line" id="L1516">            .IO =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.InputOutput,</span>
<span class="line" id="L1517">            .NOSPC =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.NoSpaceLeft,</span>
<span class="line" id="L1518">            .PERM =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.AccessDenied,</span>
<span class="line" id="L1519">            .PIPE =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.BrokenPipe,</span>
<span class="line" id="L1520">            .NXIO =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.Unseekable,</span>
<span class="line" id="L1521">            .SPIPE =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.Unseekable,</span>
<span class="line" id="L1522">            .OVERFLOW =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.Unseekable,</span>
<span class="line" id="L1523">            .NOTCAPABLE =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.AccessDenied,</span>
<span class="line" id="L1524">            <span class="tok-kw">else</span> =&gt; |err| <span class="tok-kw">return</span> unexpectedErrno(err),</span>
<span class="line" id="L1525">        }</span>
<span class="line" id="L1526">    }</span>
<span class="line" id="L1527"></span>
<span class="line" id="L1528">    <span class="tok-kw">const</span> pwritev_sym = <span class="tok-kw">if</span> (lfs64_abi) system.pwritev64 <span class="tok-kw">else</span> system.pwritev;</span>
<span class="line" id="L1529">    <span class="tok-kw">while</span> (<span class="tok-null">true</span>) {</span>
<span class="line" id="L1530">        <span class="tok-kw">const</span> rc = pwritev_sym(fd, iov.ptr, <span class="tok-builtin">@min</span>(iov.len, IOV_MAX), <span class="tok-builtin">@bitCast</span>(offset));</span>
<span class="line" id="L1531">        <span class="tok-kw">switch</span> (errno(rc)) {</span>
<span class="line" id="L1532">            .SUCCESS =&gt; <span class="tok-kw">return</span> <span class="tok-builtin">@intCast</span>(rc),</span>
<span class="line" id="L1533">            .INTR =&gt; <span class="tok-kw">continue</span>,</span>
<span class="line" id="L1534">            .INVAL =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.InvalidArgument,</span>
<span class="line" id="L1535">            .FAULT =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L1536">            .AGAIN =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.WouldBlock,</span>
<span class="line" id="L1537">            .BADF =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.NotOpenForWriting, <span class="tok-comment">// Can be a race condition.</span>
</span>
<span class="line" id="L1538">            .DESTADDRREQ =&gt; <span class="tok-kw">unreachable</span>, <span class="tok-comment">// `connect` was never called.</span>
</span>
<span class="line" id="L1539">            .DQUOT =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.DiskQuota,</span>
<span class="line" id="L1540">            .FBIG =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.FileTooBig,</span>
<span class="line" id="L1541">            .IO =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.InputOutput,</span>
<span class="line" id="L1542">            .NOSPC =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.NoSpaceLeft,</span>
<span class="line" id="L1543">            .PERM =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.AccessDenied,</span>
<span class="line" id="L1544">            .PIPE =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.BrokenPipe,</span>
<span class="line" id="L1545">            .NXIO =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.Unseekable,</span>
<span class="line" id="L1546">            .SPIPE =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.Unseekable,</span>
<span class="line" id="L1547">            .OVERFLOW =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.Unseekable,</span>
<span class="line" id="L1548">            .BUSY =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.DeviceBusy,</span>
<span class="line" id="L1549">            <span class="tok-kw">else</span> =&gt; |err| <span class="tok-kw">return</span> unexpectedErrno(err),</span>
<span class="line" id="L1550">        }</span>
<span class="line" id="L1551">    }</span>
<span class="line" id="L1552">}</span>
<span class="line" id="L1553"></span>
<span class="line" id="L1554"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> OpenError = <span class="tok-kw">error</span>{</span>
<span class="line" id="L1555">    <span class="tok-comment">/// In WASI, this error may occur when the file descriptor does</span></span>
<span class="line" id="L1556">    <span class="tok-comment">/// not hold the required rights to open a new resource relative to it.</span></span>
<span class="line" id="L1557">    AccessDenied,</span>
<span class="line" id="L1558">    SymLinkLoop,</span>
<span class="line" id="L1559">    ProcessFdQuotaExceeded,</span>
<span class="line" id="L1560">    SystemFdQuotaExceeded,</span>
<span class="line" id="L1561">    NoDevice,</span>
<span class="line" id="L1562">    FileNotFound,</span>
<span class="line" id="L1563"></span>
<span class="line" id="L1564">    <span class="tok-comment">/// The path exceeded `MAX_PATH_BYTES` bytes.</span></span>
<span class="line" id="L1565">    NameTooLong,</span>
<span class="line" id="L1566"></span>
<span class="line" id="L1567">    <span class="tok-comment">/// Insufficient kernel memory was available, or</span></span>
<span class="line" id="L1568">    <span class="tok-comment">/// the named file is a FIFO and per-user hard limit on</span></span>
<span class="line" id="L1569">    <span class="tok-comment">/// memory allocation for pipes has been reached.</span></span>
<span class="line" id="L1570">    SystemResources,</span>
<span class="line" id="L1571"></span>
<span class="line" id="L1572">    <span class="tok-comment">/// The file is too large to be opened. This error is unreachable</span></span>
<span class="line" id="L1573">    <span class="tok-comment">/// for 64-bit targets, as well as when opening directories.</span></span>
<span class="line" id="L1574">    FileTooBig,</span>
<span class="line" id="L1575"></span>
<span class="line" id="L1576">    <span class="tok-comment">/// The path refers to directory but the `DIRECTORY` flag was not provided.</span></span>
<span class="line" id="L1577">    IsDir,</span>
<span class="line" id="L1578"></span>
<span class="line" id="L1579">    <span class="tok-comment">/// A new path cannot be created because the device has no room for the new file.</span></span>
<span class="line" id="L1580">    <span class="tok-comment">/// This error is only reachable when the `CREAT` flag is provided.</span></span>
<span class="line" id="L1581">    NoSpaceLeft,</span>
<span class="line" id="L1582"></span>
<span class="line" id="L1583">    <span class="tok-comment">/// A component used as a directory in the path was not, in fact, a directory, or</span></span>
<span class="line" id="L1584">    <span class="tok-comment">/// `DIRECTORY` was specified and the path was not a directory.</span></span>
<span class="line" id="L1585">    NotDir,</span>
<span class="line" id="L1586"></span>
<span class="line" id="L1587">    <span class="tok-comment">/// The path already exists and the `CREAT` and `EXCL` flags were provided.</span></span>
<span class="line" id="L1588">    PathAlreadyExists,</span>
<span class="line" id="L1589">    DeviceBusy,</span>
<span class="line" id="L1590"></span>
<span class="line" id="L1591">    <span class="tok-comment">/// The underlying filesystem does not support file locks</span></span>
<span class="line" id="L1592">    FileLocksNotSupported,</span>
<span class="line" id="L1593"></span>
<span class="line" id="L1594">    <span class="tok-comment">/// Path contains characters that are disallowed by the underlying filesystem.</span></span>
<span class="line" id="L1595">    BadPathName,</span>
<span class="line" id="L1596"></span>
<span class="line" id="L1597">    <span class="tok-comment">/// WASI-only; file paths must be valid UTF-8.</span></span>
<span class="line" id="L1598">    InvalidUtf8,</span>
<span class="line" id="L1599"></span>
<span class="line" id="L1600">    <span class="tok-comment">/// Windows-only; file paths provided by the user must be valid WTF-8.</span></span>
<span class="line" id="L1601">    <span class="tok-comment">/// https://simonsapin.github.io/wtf-8/</span></span>
<span class="line" id="L1602">    InvalidWtf8,</span>
<span class="line" id="L1603"></span>
<span class="line" id="L1604">    <span class="tok-comment">/// On Windows, `\\server` or `\\server\share` was not found.</span></span>
<span class="line" id="L1605">    NetworkNotFound,</span>
<span class="line" id="L1606"></span>
<span class="line" id="L1607">    <span class="tok-comment">/// One of these three things:</span></span>
<span class="line" id="L1608">    <span class="tok-comment">/// * pathname  refers to an executable image which is currently being</span></span>
<span class="line" id="L1609">    <span class="tok-comment">///   executed and write access was requested.</span></span>
<span class="line" id="L1610">    <span class="tok-comment">/// * pathname refers to a file that is currently in  use  as  a  swap</span></span>
<span class="line" id="L1611">    <span class="tok-comment">///   file, and the O_TRUNC flag was specified.</span></span>
<span class="line" id="L1612">    <span class="tok-comment">/// * pathname  refers  to  a file that is currently being read by the</span></span>
<span class="line" id="L1613">    <span class="tok-comment">///   kernel (e.g., for module/firmware loading), and write access was</span></span>
<span class="line" id="L1614">    <span class="tok-comment">///   requested.</span></span>
<span class="line" id="L1615">    FileBusy,</span>
<span class="line" id="L1616"></span>
<span class="line" id="L1617">    WouldBlock,</span>
<span class="line" id="L1618">} || UnexpectedError;</span>
<span class="line" id="L1619"></span>
<span class="line" id="L1620"><span class="tok-comment">/// Open and possibly create a file. Keeps trying if it gets interrupted.</span></span>
<span class="line" id="L1621"><span class="tok-comment">/// On Windows, `file_path` should be encoded as [WTF-8](https://simonsapin.github.io/wtf-8/).</span></span>
<span class="line" id="L1622"><span class="tok-comment">/// On WASI, `file_path` should be encoded as valid UTF-8.</span></span>
<span class="line" id="L1623"><span class="tok-comment">/// On other platforms, `file_path` is an opaque sequence of bytes with no particular encoding.</span></span>
<span class="line" id="L1624"><span class="tok-comment">/// See also `openZ`.</span></span>
<span class="line" id="L1625"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">open</span>(file_path: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>, flags: O, perm: mode_t) OpenError!fd_t {</span>
<span class="line" id="L1626">    <span class="tok-kw">if</span> (builtin.os.tag == .windows) {</span>
<span class="line" id="L1627">        <span class="tok-builtin">@compileError</span>(<span class="tok-str">&quot;Windows does not support POSIX; use Windows-specific API or cross-platform std.fs API&quot;</span>);</span>
<span class="line" id="L1628">    } <span class="tok-kw">else</span> <span class="tok-kw">if</span> (builtin.os.tag == .wasi <span class="tok-kw">and</span> !builtin.link_libc) {</span>
<span class="line" id="L1629">        <span class="tok-kw">return</span> openat(AT.FDCWD, file_path, flags, perm);</span>
<span class="line" id="L1630">    }</span>
<span class="line" id="L1631">    <span class="tok-kw">const</span> file_path_c = <span class="tok-kw">try</span> toPosixPath(file_path);</span>
<span class="line" id="L1632">    <span class="tok-kw">return</span> openZ(&amp;file_path_c, flags, perm);</span>
<span class="line" id="L1633">}</span>
<span class="line" id="L1634"></span>
<span class="line" id="L1635"><span class="tok-comment">/// Open and possibly create a file. Keeps trying if it gets interrupted.</span></span>
<span class="line" id="L1636"><span class="tok-comment">/// On Windows, `file_path` should be encoded as [WTF-8](https://simonsapin.github.io/wtf-8/).</span></span>
<span class="line" id="L1637"><span class="tok-comment">/// On WASI, `file_path` should be encoded as valid UTF-8.</span></span>
<span class="line" id="L1638"><span class="tok-comment">/// On other platforms, `file_path` is an opaque sequence of bytes with no particular encoding.</span></span>
<span class="line" id="L1639"><span class="tok-comment">/// See also `open`.</span></span>
<span class="line" id="L1640"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">openZ</span>(file_path: [*:<span class="tok-number">0</span>]<span class="tok-kw">const</span> <span class="tok-type">u8</span>, flags: O, perm: mode_t) OpenError!fd_t {</span>
<span class="line" id="L1641">    <span class="tok-kw">if</span> (builtin.os.tag == .windows) {</span>
<span class="line" id="L1642">        <span class="tok-builtin">@compileError</span>(<span class="tok-str">&quot;Windows does not support POSIX; use Windows-specific API or cross-platform std.fs API&quot;</span>);</span>
<span class="line" id="L1643">    } <span class="tok-kw">else</span> <span class="tok-kw">if</span> (builtin.os.tag == .wasi <span class="tok-kw">and</span> !builtin.link_libc) {</span>
<span class="line" id="L1644">        <span class="tok-kw">return</span> open(mem.sliceTo(file_path, <span class="tok-number">0</span>), flags, perm);</span>
<span class="line" id="L1645">    }</span>
<span class="line" id="L1646"></span>
<span class="line" id="L1647">    <span class="tok-kw">const</span> open_sym = <span class="tok-kw">if</span> (lfs64_abi) system.open64 <span class="tok-kw">else</span> system.open;</span>
<span class="line" id="L1648">    <span class="tok-kw">while</span> (<span class="tok-null">true</span>) {</span>
<span class="line" id="L1649">        <span class="tok-kw">const</span> rc = open_sym(file_path, flags, perm);</span>
<span class="line" id="L1650">        <span class="tok-kw">switch</span> (errno(rc)) {</span>
<span class="line" id="L1651">            .SUCCESS =&gt; <span class="tok-kw">return</span> <span class="tok-builtin">@intCast</span>(rc),</span>
<span class="line" id="L1652">            .INTR =&gt; <span class="tok-kw">continue</span>,</span>
<span class="line" id="L1653"></span>
<span class="line" id="L1654">            .FAULT =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L1655">            .INVAL =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L1656">            .ACCES =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.AccessDenied,</span>
<span class="line" id="L1657">            .FBIG =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.FileTooBig,</span>
<span class="line" id="L1658">            .OVERFLOW =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.FileTooBig,</span>
<span class="line" id="L1659">            .ISDIR =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.IsDir,</span>
<span class="line" id="L1660">            .LOOP =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.SymLinkLoop,</span>
<span class="line" id="L1661">            .MFILE =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.ProcessFdQuotaExceeded,</span>
<span class="line" id="L1662">            .NAMETOOLONG =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.NameTooLong,</span>
<span class="line" id="L1663">            .NFILE =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.SystemFdQuotaExceeded,</span>
<span class="line" id="L1664">            .NODEV =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.NoDevice,</span>
<span class="line" id="L1665">            .NOENT =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.FileNotFound,</span>
<span class="line" id="L1666">            .NOMEM =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.SystemResources,</span>
<span class="line" id="L1667">            .NOSPC =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.NoSpaceLeft,</span>
<span class="line" id="L1668">            .NOTDIR =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.NotDir,</span>
<span class="line" id="L1669">            .PERM =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.AccessDenied,</span>
<span class="line" id="L1670">            .EXIST =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.PathAlreadyExists,</span>
<span class="line" id="L1671">            .BUSY =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.DeviceBusy,</span>
<span class="line" id="L1672">            <span class="tok-kw">else</span> =&gt; |err| <span class="tok-kw">return</span> unexpectedErrno(err),</span>
<span class="line" id="L1673">        }</span>
<span class="line" id="L1674">    }</span>
<span class="line" id="L1675">}</span>
<span class="line" id="L1676"></span>
<span class="line" id="L1677"><span class="tok-comment">/// Open and possibly create a file. Keeps trying if it gets interrupted.</span></span>
<span class="line" id="L1678"><span class="tok-comment">/// `file_path` is relative to the open directory handle `dir_fd`.</span></span>
<span class="line" id="L1679"><span class="tok-comment">/// On Windows, `file_path` should be encoded as [WTF-8](https://simonsapin.github.io/wtf-8/).</span></span>
<span class="line" id="L1680"><span class="tok-comment">/// On WASI, `file_path` should be encoded as valid UTF-8.</span></span>
<span class="line" id="L1681"><span class="tok-comment">/// On other platforms, `file_path` is an opaque sequence of bytes with no particular encoding.</span></span>
<span class="line" id="L1682"><span class="tok-comment">/// See also `openatZ`.</span></span>
<span class="line" id="L1683"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">openat</span>(dir_fd: fd_t, file_path: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>, flags: O, mode: mode_t) OpenError!fd_t {</span>
<span class="line" id="L1684">    <span class="tok-kw">if</span> (builtin.os.tag == .windows) {</span>
<span class="line" id="L1685">        <span class="tok-builtin">@compileError</span>(<span class="tok-str">&quot;Windows does not support POSIX; use Windows-specific API or cross-platform std.fs API&quot;</span>);</span>
<span class="line" id="L1686">    } <span class="tok-kw">else</span> <span class="tok-kw">if</span> (builtin.os.tag == .wasi <span class="tok-kw">and</span> !builtin.link_libc) {</span>
<span class="line" id="L1687">        <span class="tok-comment">// `mode` is ignored on WASI, which does not support unix-style file permissions</span>
</span>
<span class="line" id="L1688">        <span class="tok-kw">const</span> opts = <span class="tok-kw">try</span> openOptionsFromFlagsWasi(flags);</span>
<span class="line" id="L1689">        <span class="tok-kw">const</span> fd = <span class="tok-kw">try</span> openatWasi(</span>
<span class="line" id="L1690">            dir_fd,</span>
<span class="line" id="L1691">            file_path,</span>
<span class="line" id="L1692">            opts.lookup_flags,</span>
<span class="line" id="L1693">            opts.oflags,</span>
<span class="line" id="L1694">            opts.fs_flags,</span>
<span class="line" id="L1695">            opts.fs_rights_base,</span>
<span class="line" id="L1696">            opts.fs_rights_inheriting,</span>
<span class="line" id="L1697">        );</span>
<span class="line" id="L1698">        <span class="tok-kw">errdefer</span> close(fd);</span>
<span class="line" id="L1699"></span>
<span class="line" id="L1700">        <span class="tok-kw">if</span> (flags.write) {</span>
<span class="line" id="L1701">            <span class="tok-kw">const</span> info = <span class="tok-kw">try</span> fstat_wasi(fd);</span>
<span class="line" id="L1702">            <span class="tok-kw">if</span> (info.filetype == .DIRECTORY)</span>
<span class="line" id="L1703">                <span class="tok-kw">return</span> <span class="tok-kw">error</span>.IsDir;</span>
<span class="line" id="L1704">        }</span>
<span class="line" id="L1705"></span>
<span class="line" id="L1706">        <span class="tok-kw">return</span> fd;</span>
<span class="line" id="L1707">    }</span>
<span class="line" id="L1708">    <span class="tok-kw">const</span> file_path_c = <span class="tok-kw">try</span> toPosixPath(file_path);</span>
<span class="line" id="L1709">    <span class="tok-kw">return</span> openatZ(dir_fd, &amp;file_path_c, flags, mode);</span>
<span class="line" id="L1710">}</span>
<span class="line" id="L1711"></span>
<span class="line" id="L1712"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> CommonOpenFlags = <span class="tok-kw">packed</span> <span class="tok-kw">struct</span> {</span>
<span class="line" id="L1713">    ACCMODE: ACCMODE = .RDONLY,</span>
<span class="line" id="L1714">    CREAT: <span class="tok-type">bool</span> = <span class="tok-null">false</span>,</span>
<span class="line" id="L1715">    EXCL: <span class="tok-type">bool</span> = <span class="tok-null">false</span>,</span>
<span class="line" id="L1716">    LARGEFILE: <span class="tok-type">bool</span> = <span class="tok-null">false</span>,</span>
<span class="line" id="L1717">    DIRECTORY: <span class="tok-type">bool</span> = <span class="tok-null">false</span>,</span>
<span class="line" id="L1718">    CLOEXEC: <span class="tok-type">bool</span> = <span class="tok-null">false</span>,</span>
<span class="line" id="L1719">    NONBLOCK: <span class="tok-type">bool</span> = <span class="tok-null">false</span>,</span>
<span class="line" id="L1720"></span>
<span class="line" id="L1721">    <span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">lower</span>(cof: CommonOpenFlags) O {</span>
<span class="line" id="L1722">        <span class="tok-kw">if</span> (builtin.os.tag == .wasi) <span class="tok-kw">return</span> .{</span>
<span class="line" id="L1723">            .read = cof.ACCMODE != .WRONLY,</span>
<span class="line" id="L1724">            .write = cof.ACCMODE != .RDONLY,</span>
<span class="line" id="L1725">            .CREAT = cof.CREAT,</span>
<span class="line" id="L1726">            .EXCL = cof.EXCL,</span>
<span class="line" id="L1727">            .DIRECTORY = cof.DIRECTORY,</span>
<span class="line" id="L1728">            .NONBLOCK = cof.NONBLOCK,</span>
<span class="line" id="L1729">        };</span>
<span class="line" id="L1730">        <span class="tok-kw">var</span> result: O = .{</span>
<span class="line" id="L1731">            .ACCMODE = cof.ACCMODE,</span>
<span class="line" id="L1732">            .CREAT = cof.CREAT,</span>
<span class="line" id="L1733">            .EXCL = cof.EXCL,</span>
<span class="line" id="L1734">            .DIRECTORY = cof.DIRECTORY,</span>
<span class="line" id="L1735">            .NONBLOCK = cof.NONBLOCK,</span>
<span class="line" id="L1736">            .CLOEXEC = cof.CLOEXEC,</span>
<span class="line" id="L1737">        };</span>
<span class="line" id="L1738">        <span class="tok-kw">if</span> (<span class="tok-builtin">@hasField</span>(O, <span class="tok-str">&quot;LARGEFILE&quot;</span>)) result.LARGEFILE = cof.LARGEFILE;</span>
<span class="line" id="L1739">        <span class="tok-kw">return</span> result;</span>
<span class="line" id="L1740">    }</span>
<span class="line" id="L1741">};</span>
<span class="line" id="L1742"></span>
<span class="line" id="L1743"><span class="tok-comment">/// A struct to contain all lookup/rights flags accepted by `wasi.path_open`</span></span>
<span class="line" id="L1744"><span class="tok-kw">const</span> WasiOpenOptions = <span class="tok-kw">struct</span> {</span>
<span class="line" id="L1745">    oflags: wasi.oflags_t,</span>
<span class="line" id="L1746">    lookup_flags: wasi.lookupflags_t,</span>
<span class="line" id="L1747">    fs_rights_base: wasi.rights_t,</span>
<span class="line" id="L1748">    fs_rights_inheriting: wasi.rights_t,</span>
<span class="line" id="L1749">    fs_flags: wasi.fdflags_t,</span>
<span class="line" id="L1750">};</span>
<span class="line" id="L1751"></span>
<span class="line" id="L1752"><span class="tok-comment">/// Compute rights + flags corresponding to the provided POSIX access mode.</span></span>
<span class="line" id="L1753"><span class="tok-kw">fn</span> <span class="tok-fn">openOptionsFromFlagsWasi</span>(oflag: O) OpenError!WasiOpenOptions {</span>
<span class="line" id="L1754">    <span class="tok-kw">const</span> w = std.os.wasi;</span>
<span class="line" id="L1755"></span>
<span class="line" id="L1756">    <span class="tok-comment">// Next, calculate the read/write rights to request, depending on the</span>
</span>
<span class="line" id="L1757">    <span class="tok-comment">// provided POSIX access mode</span>
</span>
<span class="line" id="L1758">    <span class="tok-kw">var</span> rights: w.rights_t = .{};</span>
<span class="line" id="L1759">    <span class="tok-kw">if</span> (oflag.read) {</span>
<span class="line" id="L1760">        rights.FD_READ = <span class="tok-null">true</span>;</span>
<span class="line" id="L1761">        rights.FD_READDIR = <span class="tok-null">true</span>;</span>
<span class="line" id="L1762">    }</span>
<span class="line" id="L1763">    <span class="tok-kw">if</span> (oflag.write) {</span>
<span class="line" id="L1764">        rights.FD_DATASYNC = <span class="tok-null">true</span>;</span>
<span class="line" id="L1765">        rights.FD_WRITE = <span class="tok-null">true</span>;</span>
<span class="line" id="L1766">        rights.FD_ALLOCATE = <span class="tok-null">true</span>;</span>
<span class="line" id="L1767">        rights.FD_FILESTAT_SET_SIZE = <span class="tok-null">true</span>;</span>
<span class="line" id="L1768">    }</span>
<span class="line" id="L1769"></span>
<span class="line" id="L1770">    <span class="tok-comment">// https://github.com/ziglang/zig/issues/18882</span>
</span>
<span class="line" id="L1771">    <span class="tok-kw">const</span> flag_bits: <span class="tok-type">u32</span> = <span class="tok-builtin">@bitCast</span>(oflag);</span>
<span class="line" id="L1772">    <span class="tok-kw">const</span> oflags_int: <span class="tok-type">u16</span> = <span class="tok-builtin">@as</span>(<span class="tok-type">u12</span>, <span class="tok-builtin">@truncate</span>(flag_bits &gt;&gt; <span class="tok-number">12</span>));</span>
<span class="line" id="L1773">    <span class="tok-kw">const</span> fs_flags_int: <span class="tok-type">u16</span> = <span class="tok-builtin">@as</span>(<span class="tok-type">u12</span>, <span class="tok-builtin">@truncate</span>(flag_bits));</span>
<span class="line" id="L1774"></span>
<span class="line" id="L1775">    <span class="tok-kw">return</span> .{</span>
<span class="line" id="L1776">        <span class="tok-comment">// https://github.com/ziglang/zig/issues/18882</span>
</span>
<span class="line" id="L1777">        .oflags = <span class="tok-builtin">@bitCast</span>(oflags_int),</span>
<span class="line" id="L1778">        .lookup_flags = .{</span>
<span class="line" id="L1779">            .SYMLINK_FOLLOW = !oflag.NOFOLLOW,</span>
<span class="line" id="L1780">        },</span>
<span class="line" id="L1781">        .fs_rights_base = rights,</span>
<span class="line" id="L1782">        .fs_rights_inheriting = rights,</span>
<span class="line" id="L1783">        <span class="tok-comment">// https://github.com/ziglang/zig/issues/18882</span>
</span>
<span class="line" id="L1784">        .fs_flags = <span class="tok-builtin">@bitCast</span>(fs_flags_int),</span>
<span class="line" id="L1785">    };</span>
<span class="line" id="L1786">}</span>
<span class="line" id="L1787"></span>
<span class="line" id="L1788"><span class="tok-comment">/// Open and possibly create a file in WASI.</span></span>
<span class="line" id="L1789"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">openatWasi</span>(</span>
<span class="line" id="L1790">    dir_fd: fd_t,</span>
<span class="line" id="L1791">    file_path: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>,</span>
<span class="line" id="L1792">    lookup_flags: wasi.lookupflags_t,</span>
<span class="line" id="L1793">    oflags: wasi.oflags_t,</span>
<span class="line" id="L1794">    fdflags: wasi.fdflags_t,</span>
<span class="line" id="L1795">    base: wasi.rights_t,</span>
<span class="line" id="L1796">    inheriting: wasi.rights_t,</span>
<span class="line" id="L1797">) OpenError!fd_t {</span>
<span class="line" id="L1798">    <span class="tok-kw">while</span> (<span class="tok-null">true</span>) {</span>
<span class="line" id="L1799">        <span class="tok-kw">var</span> fd: fd_t = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L1800">        <span class="tok-kw">switch</span> (wasi.path_open(dir_fd, lookup_flags, file_path.ptr, file_path.len, oflags, base, inheriting, fdflags, &amp;fd)) {</span>
<span class="line" id="L1801">            .SUCCESS =&gt; <span class="tok-kw">return</span> fd,</span>
<span class="line" id="L1802">            .INTR =&gt; <span class="tok-kw">continue</span>,</span>
<span class="line" id="L1803"></span>
<span class="line" id="L1804">            .FAULT =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L1805">            .INVAL =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L1806">            .BADF =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L1807">            .ACCES =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.AccessDenied,</span>
<span class="line" id="L1808">            .FBIG =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.FileTooBig,</span>
<span class="line" id="L1809">            .OVERFLOW =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.FileTooBig,</span>
<span class="line" id="L1810">            .ISDIR =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.IsDir,</span>
<span class="line" id="L1811">            .LOOP =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.SymLinkLoop,</span>
<span class="line" id="L1812">            .MFILE =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.ProcessFdQuotaExceeded,</span>
<span class="line" id="L1813">            .NAMETOOLONG =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.NameTooLong,</span>
<span class="line" id="L1814">            .NFILE =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.SystemFdQuotaExceeded,</span>
<span class="line" id="L1815">            .NODEV =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.NoDevice,</span>
<span class="line" id="L1816">            .NOENT =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.FileNotFound,</span>
<span class="line" id="L1817">            .NOMEM =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.SystemResources,</span>
<span class="line" id="L1818">            .NOSPC =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.NoSpaceLeft,</span>
<span class="line" id="L1819">            .NOTDIR =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.NotDir,</span>
<span class="line" id="L1820">            .PERM =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.AccessDenied,</span>
<span class="line" id="L1821">            .EXIST =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.PathAlreadyExists,</span>
<span class="line" id="L1822">            .BUSY =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.DeviceBusy,</span>
<span class="line" id="L1823">            .NOTCAPABLE =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.AccessDenied,</span>
<span class="line" id="L1824">            .ILSEQ =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.InvalidUtf8,</span>
<span class="line" id="L1825">            <span class="tok-kw">else</span> =&gt; |err| <span class="tok-kw">return</span> unexpectedErrno(err),</span>
<span class="line" id="L1826">        }</span>
<span class="line" id="L1827">    }</span>
<span class="line" id="L1828">}</span>
<span class="line" id="L1829"></span>
<span class="line" id="L1830"><span class="tok-comment">/// Open and possibly create a file. Keeps trying if it gets interrupted.</span></span>
<span class="line" id="L1831"><span class="tok-comment">/// `file_path` is relative to the open directory handle `dir_fd`.</span></span>
<span class="line" id="L1832"><span class="tok-comment">/// On Windows, `file_path` should be encoded as [WTF-8](https://simonsapin.github.io/wtf-8/).</span></span>
<span class="line" id="L1833"><span class="tok-comment">/// On WASI, `file_path` should be encoded as valid UTF-8.</span></span>
<span class="line" id="L1834"><span class="tok-comment">/// On other platforms, `file_path` is an opaque sequence of bytes with no particular encoding.</span></span>
<span class="line" id="L1835"><span class="tok-comment">/// See also `openat`.</span></span>
<span class="line" id="L1836"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">openatZ</span>(dir_fd: fd_t, file_path: [*:<span class="tok-number">0</span>]<span class="tok-kw">const</span> <span class="tok-type">u8</span>, flags: O, mode: mode_t) OpenError!fd_t {</span>
<span class="line" id="L1837">    <span class="tok-kw">if</span> (builtin.os.tag == .windows) {</span>
<span class="line" id="L1838">        <span class="tok-builtin">@compileError</span>(<span class="tok-str">&quot;Windows does not support POSIX; use Windows-specific API or cross-platform std.fs API&quot;</span>);</span>
<span class="line" id="L1839">    } <span class="tok-kw">else</span> <span class="tok-kw">if</span> (builtin.os.tag == .wasi <span class="tok-kw">and</span> !builtin.link_libc) {</span>
<span class="line" id="L1840">        <span class="tok-kw">return</span> openat(dir_fd, mem.sliceTo(file_path, <span class="tok-number">0</span>), flags, mode);</span>
<span class="line" id="L1841">    }</span>
<span class="line" id="L1842"></span>
<span class="line" id="L1843">    <span class="tok-kw">const</span> openat_sym = <span class="tok-kw">if</span> (lfs64_abi) system.openat64 <span class="tok-kw">else</span> system.openat;</span>
<span class="line" id="L1844">    <span class="tok-kw">while</span> (<span class="tok-null">true</span>) {</span>
<span class="line" id="L1845">        <span class="tok-kw">const</span> rc = openat_sym(dir_fd, file_path, flags, mode);</span>
<span class="line" id="L1846">        <span class="tok-kw">switch</span> (errno(rc)) {</span>
<span class="line" id="L1847">            .SUCCESS =&gt; <span class="tok-kw">return</span> <span class="tok-builtin">@intCast</span>(rc),</span>
<span class="line" id="L1848">            .INTR =&gt; <span class="tok-kw">continue</span>,</span>
<span class="line" id="L1849"></span>
<span class="line" id="L1850">            .FAULT =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L1851">            .INVAL =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L1852">            .BADF =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L1853">            .ACCES =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.AccessDenied,</span>
<span class="line" id="L1854">            .FBIG =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.FileTooBig,</span>
<span class="line" id="L1855">            .OVERFLOW =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.FileTooBig,</span>
<span class="line" id="L1856">            .ISDIR =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.IsDir,</span>
<span class="line" id="L1857">            .LOOP =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.SymLinkLoop,</span>
<span class="line" id="L1858">            .MFILE =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.ProcessFdQuotaExceeded,</span>
<span class="line" id="L1859">            .NAMETOOLONG =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.NameTooLong,</span>
<span class="line" id="L1860">            .NFILE =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.SystemFdQuotaExceeded,</span>
<span class="line" id="L1861">            .NODEV =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.NoDevice,</span>
<span class="line" id="L1862">            .NOENT =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.FileNotFound,</span>
<span class="line" id="L1863">            .NOMEM =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.SystemResources,</span>
<span class="line" id="L1864">            .NOSPC =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.NoSpaceLeft,</span>
<span class="line" id="L1865">            .NOTDIR =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.NotDir,</span>
<span class="line" id="L1866">            .PERM =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.AccessDenied,</span>
<span class="line" id="L1867">            .EXIST =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.PathAlreadyExists,</span>
<span class="line" id="L1868">            .BUSY =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.DeviceBusy,</span>
<span class="line" id="L1869">            .OPNOTSUPP =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.FileLocksNotSupported,</span>
<span class="line" id="L1870">            .AGAIN =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.WouldBlock,</span>
<span class="line" id="L1871">            .TXTBSY =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.FileBusy,</span>
<span class="line" id="L1872">            <span class="tok-kw">else</span> =&gt; |err| <span class="tok-kw">return</span> unexpectedErrno(err),</span>
<span class="line" id="L1873">        }</span>
<span class="line" id="L1874">    }</span>
<span class="line" id="L1875">}</span>
<span class="line" id="L1876"></span>
<span class="line" id="L1877"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">dup</span>(old_fd: fd_t) !fd_t {</span>
<span class="line" id="L1878">    <span class="tok-kw">const</span> rc = system.dup(old_fd);</span>
<span class="line" id="L1879">    <span class="tok-kw">return</span> <span class="tok-kw">switch</span> (errno(rc)) {</span>
<span class="line" id="L1880">        .SUCCESS =&gt; <span class="tok-kw">return</span> <span class="tok-builtin">@intCast</span>(rc),</span>
<span class="line" id="L1881">        .MFILE =&gt; <span class="tok-kw">error</span>.ProcessFdQuotaExceeded,</span>
<span class="line" id="L1882">        .BADF =&gt; <span class="tok-kw">unreachable</span>, <span class="tok-comment">// invalid file descriptor</span>
</span>
<span class="line" id="L1883">        <span class="tok-kw">else</span> =&gt; |err| <span class="tok-kw">return</span> unexpectedErrno(err),</span>
<span class="line" id="L1884">    };</span>
<span class="line" id="L1885">}</span>
<span class="line" id="L1886"></span>
<span class="line" id="L1887"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">dup2</span>(old_fd: fd_t, new_fd: fd_t) !<span class="tok-type">void</span> {</span>
<span class="line" id="L1888">    <span class="tok-kw">while</span> (<span class="tok-null">true</span>) {</span>
<span class="line" id="L1889">        <span class="tok-kw">switch</span> (errno(system.dup2(old_fd, new_fd))) {</span>
<span class="line" id="L1890">            .SUCCESS =&gt; <span class="tok-kw">return</span>,</span>
<span class="line" id="L1891">            .BUSY, .INTR =&gt; <span class="tok-kw">continue</span>,</span>
<span class="line" id="L1892">            .MFILE =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.ProcessFdQuotaExceeded,</span>
<span class="line" id="L1893">            .INVAL =&gt; <span class="tok-kw">unreachable</span>, <span class="tok-comment">// invalid parameters passed to dup2</span>
</span>
<span class="line" id="L1894">            .BADF =&gt; <span class="tok-kw">unreachable</span>, <span class="tok-comment">// invalid file descriptor</span>
</span>
<span class="line" id="L1895">            <span class="tok-kw">else</span> =&gt; |err| <span class="tok-kw">return</span> unexpectedErrno(err),</span>
<span class="line" id="L1896">        }</span>
<span class="line" id="L1897">    }</span>
<span class="line" id="L1898">}</span>
<span class="line" id="L1899"></span>
<span class="line" id="L1900"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> ExecveError = <span class="tok-kw">error</span>{</span>
<span class="line" id="L1901">    SystemResources,</span>
<span class="line" id="L1902">    AccessDenied,</span>
<span class="line" id="L1903">    InvalidExe,</span>
<span class="line" id="L1904">    FileSystem,</span>
<span class="line" id="L1905">    IsDir,</span>
<span class="line" id="L1906">    FileNotFound,</span>
<span class="line" id="L1907">    NotDir,</span>
<span class="line" id="L1908">    FileBusy,</span>
<span class="line" id="L1909">    ProcessFdQuotaExceeded,</span>
<span class="line" id="L1910">    SystemFdQuotaExceeded,</span>
<span class="line" id="L1911">    NameTooLong,</span>
<span class="line" id="L1912">} || UnexpectedError;</span>
<span class="line" id="L1913"></span>
<span class="line" id="L1914"><span class="tok-comment">/// This function ignores PATH environment variable. See `execvpeZ` for that.</span></span>
<span class="line" id="L1915"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">execveZ</span>(</span>
<span class="line" id="L1916">    path: [*:<span class="tok-number">0</span>]<span class="tok-kw">const</span> <span class="tok-type">u8</span>,</span>
<span class="line" id="L1917">    child_argv: [*:<span class="tok-null">null</span>]<span class="tok-kw">const</span> ?[*:<span class="tok-number">0</span>]<span class="tok-kw">const</span> <span class="tok-type">u8</span>,</span>
<span class="line" id="L1918">    envp: [*:<span class="tok-null">null</span>]<span class="tok-kw">const</span> ?[*:<span class="tok-number">0</span>]<span class="tok-kw">const</span> <span class="tok-type">u8</span>,</span>
<span class="line" id="L1919">) ExecveError {</span>
<span class="line" id="L1920">    <span class="tok-kw">switch</span> (errno(system.execve(path, child_argv, envp))) {</span>
<span class="line" id="L1921">        .SUCCESS =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L1922">        .FAULT =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L1923">        .@&quot;2BIG&quot; =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.SystemResources,</span>
<span class="line" id="L1924">        .MFILE =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.ProcessFdQuotaExceeded,</span>
<span class="line" id="L1925">        .NAMETOOLONG =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.NameTooLong,</span>
<span class="line" id="L1926">        .NFILE =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.SystemFdQuotaExceeded,</span>
<span class="line" id="L1927">        .NOMEM =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.SystemResources,</span>
<span class="line" id="L1928">        .ACCES =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.AccessDenied,</span>
<span class="line" id="L1929">        .PERM =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.AccessDenied,</span>
<span class="line" id="L1930">        .INVAL =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.InvalidExe,</span>
<span class="line" id="L1931">        .NOEXEC =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.InvalidExe,</span>
<span class="line" id="L1932">        .IO =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.FileSystem,</span>
<span class="line" id="L1933">        .LOOP =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.FileSystem,</span>
<span class="line" id="L1934">        .ISDIR =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.IsDir,</span>
<span class="line" id="L1935">        .NOENT =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.FileNotFound,</span>
<span class="line" id="L1936">        .NOTDIR =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.NotDir,</span>
<span class="line" id="L1937">        .TXTBSY =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.FileBusy,</span>
<span class="line" id="L1938">        <span class="tok-kw">else</span> =&gt; |err| <span class="tok-kw">switch</span> (builtin.os.tag) {</span>
<span class="line" id="L1939">            .macos, .ios, .tvos, .watchos =&gt; <span class="tok-kw">switch</span> (err) {</span>
<span class="line" id="L1940">                .BADEXEC =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.InvalidExe,</span>
<span class="line" id="L1941">                .BADARCH =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.InvalidExe,</span>
<span class="line" id="L1942">                <span class="tok-kw">else</span> =&gt; <span class="tok-kw">return</span> unexpectedErrno(err),</span>
<span class="line" id="L1943">            },</span>
<span class="line" id="L1944">            .linux =&gt; <span class="tok-kw">switch</span> (err) {</span>
<span class="line" id="L1945">                .LIBBAD =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.InvalidExe,</span>
<span class="line" id="L1946">                <span class="tok-kw">else</span> =&gt; <span class="tok-kw">return</span> unexpectedErrno(err),</span>
<span class="line" id="L1947">            },</span>
<span class="line" id="L1948">            <span class="tok-kw">else</span> =&gt; <span class="tok-kw">return</span> unexpectedErrno(err),</span>
<span class="line" id="L1949">        },</span>
<span class="line" id="L1950">    }</span>
<span class="line" id="L1951">}</span>
<span class="line" id="L1952"></span>
<span class="line" id="L1953"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> Arg0Expand = <span class="tok-kw">enum</span> {</span>
<span class="line" id="L1954">    expand,</span>
<span class="line" id="L1955">    no_expand,</span>
<span class="line" id="L1956">};</span>
<span class="line" id="L1957"></span>
<span class="line" id="L1958"><span class="tok-comment">/// Like `execvpeZ` except if `arg0_expand` is `.expand`, then `argv` is mutable,</span></span>
<span class="line" id="L1959"><span class="tok-comment">/// and `argv[0]` is expanded to be the same absolute path that is passed to the execve syscall.</span></span>
<span class="line" id="L1960"><span class="tok-comment">/// If this function returns with an error, `argv[0]` will be restored to the value it was when it was passed in.</span></span>
<span class="line" id="L1961"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">execvpeZ_expandArg0</span>(</span>
<span class="line" id="L1962">    <span class="tok-kw">comptime</span> arg0_expand: Arg0Expand,</span>
<span class="line" id="L1963">    file: [*:<span class="tok-number">0</span>]<span class="tok-kw">const</span> <span class="tok-type">u8</span>,</span>
<span class="line" id="L1964">    child_argv: <span class="tok-kw">switch</span> (arg0_expand) {</span>
<span class="line" id="L1965">        .expand =&gt; [*:<span class="tok-null">null</span>]?[*:<span class="tok-number">0</span>]<span class="tok-kw">const</span> <span class="tok-type">u8</span>,</span>
<span class="line" id="L1966">        .no_expand =&gt; [*:<span class="tok-null">null</span>]<span class="tok-kw">const</span> ?[*:<span class="tok-number">0</span>]<span class="tok-kw">const</span> <span class="tok-type">u8</span>,</span>
<span class="line" id="L1967">    },</span>
<span class="line" id="L1968">    envp: [*:<span class="tok-null">null</span>]<span class="tok-kw">const</span> ?[*:<span class="tok-number">0</span>]<span class="tok-kw">const</span> <span class="tok-type">u8</span>,</span>
<span class="line" id="L1969">) ExecveError {</span>
<span class="line" id="L1970">    <span class="tok-kw">const</span> file_slice = mem.sliceTo(file, <span class="tok-number">0</span>);</span>
<span class="line" id="L1971">    <span class="tok-kw">if</span> (mem.indexOfScalar(<span class="tok-type">u8</span>, file_slice, <span class="tok-str">'/'</span>) != <span class="tok-null">null</span>) <span class="tok-kw">return</span> execveZ(file, child_argv, envp);</span>
<span class="line" id="L1972"></span>
<span class="line" id="L1973">    <span class="tok-kw">const</span> PATH = getenvZ(<span class="tok-str">&quot;PATH&quot;</span>) <span class="tok-kw">orelse</span> <span class="tok-str">&quot;/usr/local/bin:/bin/:/usr/bin&quot;</span>;</span>
<span class="line" id="L1974">    <span class="tok-comment">// Use of MAX_PATH_BYTES here is valid as the path_buf will be passed</span>
</span>
<span class="line" id="L1975">    <span class="tok-comment">// directly to the operating system in execveZ.</span>
</span>
<span class="line" id="L1976">    <span class="tok-kw">var</span> path_buf: [MAX_PATH_BYTES]<span class="tok-type">u8</span> = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L1977">    <span class="tok-kw">var</span> it = mem.tokenizeScalar(<span class="tok-type">u8</span>, PATH, <span class="tok-str">':'</span>);</span>
<span class="line" id="L1978">    <span class="tok-kw">var</span> seen_eacces = <span class="tok-null">false</span>;</span>
<span class="line" id="L1979">    <span class="tok-kw">var</span> err: ExecveError = <span class="tok-kw">error</span>.FileNotFound;</span>
<span class="line" id="L1980"></span>
<span class="line" id="L1981">    <span class="tok-comment">// In case of expanding arg0 we must put it back if we return with an error.</span>
</span>
<span class="line" id="L1982">    <span class="tok-kw">const</span> prev_arg0 = child_argv[<span class="tok-number">0</span>];</span>
<span class="line" id="L1983">    <span class="tok-kw">defer</span> <span class="tok-kw">switch</span> (arg0_expand) {</span>
<span class="line" id="L1984">        .expand =&gt; child_argv[<span class="tok-number">0</span>] = prev_arg0,</span>
<span class="line" id="L1985">        .no_expand =&gt; {},</span>
<span class="line" id="L1986">    };</span>
<span class="line" id="L1987"></span>
<span class="line" id="L1988">    <span class="tok-kw">while</span> (it.next()) |search_path| {</span>
<span class="line" id="L1989">        <span class="tok-kw">const</span> path_len = search_path.len + file_slice.len + <span class="tok-number">1</span>;</span>
<span class="line" id="L1990">        <span class="tok-kw">if</span> (path_buf.len &lt; path_len + <span class="tok-number">1</span>) <span class="tok-kw">return</span> <span class="tok-kw">error</span>.NameTooLong;</span>
<span class="line" id="L1991">        <span class="tok-builtin">@memcpy</span>(path_buf[<span class="tok-number">0</span>..search_path.len], search_path);</span>
<span class="line" id="L1992">        path_buf[search_path.len] = <span class="tok-str">'/'</span>;</span>
<span class="line" id="L1993">        <span class="tok-builtin">@memcpy</span>(path_buf[search_path.len + <span class="tok-number">1</span> ..][<span class="tok-number">0</span>..file_slice.len], file_slice);</span>
<span class="line" id="L1994">        path_buf[path_len] = <span class="tok-number">0</span>;</span>
<span class="line" id="L1995">        <span class="tok-kw">const</span> full_path = path_buf[<span class="tok-number">0</span>..path_len :<span class="tok-number">0</span>].ptr;</span>
<span class="line" id="L1996">        <span class="tok-kw">switch</span> (arg0_expand) {</span>
<span class="line" id="L1997">            .expand =&gt; child_argv[<span class="tok-number">0</span>] = full_path,</span>
<span class="line" id="L1998">            .no_expand =&gt; {},</span>
<span class="line" id="L1999">        }</span>
<span class="line" id="L2000">        err = execveZ(full_path, child_argv, envp);</span>
<span class="line" id="L2001">        <span class="tok-kw">switch</span> (err) {</span>
<span class="line" id="L2002">            <span class="tok-kw">error</span>.AccessDenied =&gt; seen_eacces = <span class="tok-null">true</span>,</span>
<span class="line" id="L2003">            <span class="tok-kw">error</span>.FileNotFound, <span class="tok-kw">error</span>.NotDir =&gt; {},</span>
<span class="line" id="L2004">            <span class="tok-kw">else</span> =&gt; |e| <span class="tok-kw">return</span> e,</span>
<span class="line" id="L2005">        }</span>
<span class="line" id="L2006">    }</span>
<span class="line" id="L2007">    <span class="tok-kw">if</span> (seen_eacces) <span class="tok-kw">return</span> <span class="tok-kw">error</span>.AccessDenied;</span>
<span class="line" id="L2008">    <span class="tok-kw">return</span> err;</span>
<span class="line" id="L2009">}</span>
<span class="line" id="L2010"></span>
<span class="line" id="L2011"><span class="tok-comment">/// This function also uses the PATH environment variable to get the full path to the executable.</span></span>
<span class="line" id="L2012"><span class="tok-comment">/// If `file` is an absolute path, this is the same as `execveZ`.</span></span>
<span class="line" id="L2013"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">execvpeZ</span>(</span>
<span class="line" id="L2014">    file: [*:<span class="tok-number">0</span>]<span class="tok-kw">const</span> <span class="tok-type">u8</span>,</span>
<span class="line" id="L2015">    argv_ptr: [*:<span class="tok-null">null</span>]<span class="tok-kw">const</span> ?[*:<span class="tok-number">0</span>]<span class="tok-kw">const</span> <span class="tok-type">u8</span>,</span>
<span class="line" id="L2016">    envp: [*:<span class="tok-null">null</span>]<span class="tok-kw">const</span> ?[*:<span class="tok-number">0</span>]<span class="tok-kw">const</span> <span class="tok-type">u8</span>,</span>
<span class="line" id="L2017">) ExecveError {</span>
<span class="line" id="L2018">    <span class="tok-kw">return</span> execvpeZ_expandArg0(.no_expand, file, argv_ptr, envp);</span>
<span class="line" id="L2019">}</span>
<span class="line" id="L2020"></span>
<span class="line" id="L2021"><span class="tok-comment">/// Get an environment variable.</span></span>
<span class="line" id="L2022"><span class="tok-comment">/// See also `getenvZ`.</span></span>
<span class="line" id="L2023"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">getenv</span>(key: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>) ?[:<span class="tok-number">0</span>]<span class="tok-kw">const</span> <span class="tok-type">u8</span> {</span>
<span class="line" id="L2024">    <span class="tok-kw">if</span> (builtin.os.tag == .windows) {</span>
<span class="line" id="L2025">        <span class="tok-builtin">@compileError</span>(<span class="tok-str">&quot;std.os.getenv is unavailable for Windows because environment strings are in WTF-16 format. See std.process.getEnvVarOwned for a cross-platform API or std.os.getenvW for a Windows-specific API.&quot;</span>);</span>
<span class="line" id="L2026">    }</span>
<span class="line" id="L2027">    <span class="tok-kw">if</span> (builtin.link_libc) {</span>
<span class="line" id="L2028">        <span class="tok-kw">var</span> ptr = std.c.environ;</span>
<span class="line" id="L2029">        <span class="tok-kw">while</span> (ptr[<span class="tok-number">0</span>]) |line| : (ptr += <span class="tok-number">1</span>) {</span>
<span class="line" id="L2030">            <span class="tok-kw">var</span> line_i: <span class="tok-type">usize</span> = <span class="tok-number">0</span>;</span>
<span class="line" id="L2031">            <span class="tok-kw">while</span> (line[line_i] != <span class="tok-number">0</span> <span class="tok-kw">and</span> line[line_i] != <span class="tok-str">'='</span>) : (line_i += <span class="tok-number">1</span>) {}</span>
<span class="line" id="L2032">            <span class="tok-kw">const</span> this_key = line[<span class="tok-number">0</span>..line_i];</span>
<span class="line" id="L2033"></span>
<span class="line" id="L2034">            <span class="tok-kw">if</span> (!mem.eql(<span class="tok-type">u8</span>, this_key, key)) <span class="tok-kw">continue</span>;</span>
<span class="line" id="L2035"></span>
<span class="line" id="L2036">            <span class="tok-kw">return</span> mem.sliceTo(line + line_i + <span class="tok-number">1</span>, <span class="tok-number">0</span>);</span>
<span class="line" id="L2037">        }</span>
<span class="line" id="L2038">        <span class="tok-kw">return</span> <span class="tok-null">null</span>;</span>
<span class="line" id="L2039">    }</span>
<span class="line" id="L2040">    <span class="tok-kw">if</span> (builtin.os.tag == .wasi) {</span>
<span class="line" id="L2041">        <span class="tok-builtin">@compileError</span>(<span class="tok-str">&quot;std.os.getenv is unavailable for WASI. See std.process.getEnvMap or std.process.getEnvVarOwned for a cross-platform API.&quot;</span>);</span>
<span class="line" id="L2042">    }</span>
<span class="line" id="L2043">    <span class="tok-comment">// The simplified start logic doesn't populate environ.</span>
</span>
<span class="line" id="L2044">    <span class="tok-kw">if</span> (std.start.simplified_logic) <span class="tok-kw">return</span> <span class="tok-null">null</span>;</span>
<span class="line" id="L2045">    <span class="tok-comment">// TODO see https://github.com/ziglang/zig/issues/4524</span>
</span>
<span class="line" id="L2046">    <span class="tok-kw">for</span> (environ) |ptr| {</span>
<span class="line" id="L2047">        <span class="tok-kw">var</span> line_i: <span class="tok-type">usize</span> = <span class="tok-number">0</span>;</span>
<span class="line" id="L2048">        <span class="tok-kw">while</span> (ptr[line_i] != <span class="tok-number">0</span> <span class="tok-kw">and</span> ptr[line_i] != <span class="tok-str">'='</span>) : (line_i += <span class="tok-number">1</span>) {}</span>
<span class="line" id="L2049">        <span class="tok-kw">const</span> this_key = ptr[<span class="tok-number">0</span>..line_i];</span>
<span class="line" id="L2050">        <span class="tok-kw">if</span> (!mem.eql(<span class="tok-type">u8</span>, key, this_key)) <span class="tok-kw">continue</span>;</span>
<span class="line" id="L2051"></span>
<span class="line" id="L2052">        <span class="tok-kw">return</span> mem.sliceTo(ptr + line_i + <span class="tok-number">1</span>, <span class="tok-number">0</span>);</span>
<span class="line" id="L2053">    }</span>
<span class="line" id="L2054">    <span class="tok-kw">return</span> <span class="tok-null">null</span>;</span>
<span class="line" id="L2055">}</span>
<span class="line" id="L2056"></span>
<span class="line" id="L2057"><span class="tok-comment">/// Get an environment variable with a null-terminated name.</span></span>
<span class="line" id="L2058"><span class="tok-comment">/// See also `getenv`.</span></span>
<span class="line" id="L2059"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">getenvZ</span>(key: [*:<span class="tok-number">0</span>]<span class="tok-kw">const</span> <span class="tok-type">u8</span>) ?[:<span class="tok-number">0</span>]<span class="tok-kw">const</span> <span class="tok-type">u8</span> {</span>
<span class="line" id="L2060">    <span class="tok-kw">if</span> (builtin.link_libc) {</span>
<span class="line" id="L2061">        <span class="tok-kw">const</span> value = system.getenv(key) <span class="tok-kw">orelse</span> <span class="tok-kw">return</span> <span class="tok-null">null</span>;</span>
<span class="line" id="L2062">        <span class="tok-kw">return</span> mem.sliceTo(value, <span class="tok-number">0</span>);</span>
<span class="line" id="L2063">    }</span>
<span class="line" id="L2064">    <span class="tok-kw">if</span> (builtin.os.tag == .windows) {</span>
<span class="line" id="L2065">        <span class="tok-builtin">@compileError</span>(<span class="tok-str">&quot;std.os.getenvZ is unavailable for Windows because environment string is in WTF-16 format. See std.process.getEnvVarOwned for cross-platform API or std.os.getenvW for Windows-specific API.&quot;</span>);</span>
<span class="line" id="L2066">    }</span>
<span class="line" id="L2067">    <span class="tok-kw">return</span> getenv(mem.sliceTo(key, <span class="tok-number">0</span>));</span>
<span class="line" id="L2068">}</span>
<span class="line" id="L2069"></span>
<span class="line" id="L2070"><span class="tok-comment">/// Windows-only. Get an environment variable with a null-terminated, WTF-16 encoded name.</span></span>
<span class="line" id="L2071"><span class="tok-comment">/// See also `getenv`.</span></span>
<span class="line" id="L2072"><span class="tok-comment">/// This function performs a Unicode-aware case-insensitive lookup using RtlEqualUnicodeString.</span></span>
<span class="line" id="L2073"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">getenvW</span>(key: [*:<span class="tok-number">0</span>]<span class="tok-kw">const</span> <span class="tok-type">u16</span>) ?[:<span class="tok-number">0</span>]<span class="tok-kw">const</span> <span class="tok-type">u16</span> {</span>
<span class="line" id="L2074">    <span class="tok-kw">if</span> (builtin.os.tag != .windows) {</span>
<span class="line" id="L2075">        <span class="tok-builtin">@compileError</span>(<span class="tok-str">&quot;std.os.getenvW is a Windows-only API&quot;</span>);</span>
<span class="line" id="L2076">    }</span>
<span class="line" id="L2077">    <span class="tok-kw">const</span> key_slice = mem.sliceTo(key, <span class="tok-number">0</span>);</span>
<span class="line" id="L2078">    <span class="tok-kw">const</span> ptr = windows.peb().ProcessParameters.Environment;</span>
<span class="line" id="L2079">    <span class="tok-kw">var</span> i: <span class="tok-type">usize</span> = <span class="tok-number">0</span>;</span>
<span class="line" id="L2080">    <span class="tok-kw">while</span> (ptr[i] != <span class="tok-number">0</span>) {</span>
<span class="line" id="L2081">        <span class="tok-kw">const</span> key_start = i;</span>
<span class="line" id="L2082"></span>
<span class="line" id="L2083">        <span class="tok-comment">// There are some special environment variables that start with =,</span>
</span>
<span class="line" id="L2084">        <span class="tok-comment">// so we need a special case to not treat = as a key/value separator</span>
</span>
<span class="line" id="L2085">        <span class="tok-comment">// if it's the first character.</span>
</span>
<span class="line" id="L2086">        <span class="tok-comment">// https://devblogs.microsoft.com/oldnewthing/20100506-00/?p=14133</span>
</span>
<span class="line" id="L2087">        <span class="tok-kw">if</span> (ptr[key_start] == <span class="tok-str">'='</span>) i += <span class="tok-number">1</span>;</span>
<span class="line" id="L2088"></span>
<span class="line" id="L2089">        <span class="tok-kw">while</span> (ptr[i] != <span class="tok-number">0</span> <span class="tok-kw">and</span> ptr[i] != <span class="tok-str">'='</span>) : (i += <span class="tok-number">1</span>) {}</span>
<span class="line" id="L2090">        <span class="tok-kw">const</span> this_key = ptr[key_start..i];</span>
<span class="line" id="L2091"></span>
<span class="line" id="L2092">        <span class="tok-kw">if</span> (ptr[i] == <span class="tok-str">'='</span>) i += <span class="tok-number">1</span>;</span>
<span class="line" id="L2093"></span>
<span class="line" id="L2094">        <span class="tok-kw">const</span> value_start = i;</span>
<span class="line" id="L2095">        <span class="tok-kw">while</span> (ptr[i] != <span class="tok-number">0</span>) : (i += <span class="tok-number">1</span>) {}</span>
<span class="line" id="L2096">        <span class="tok-kw">const</span> this_value = ptr[value_start..i :<span class="tok-number">0</span>];</span>
<span class="line" id="L2097"></span>
<span class="line" id="L2098">        <span class="tok-kw">if</span> (windows.eqlIgnoreCaseWTF16(key_slice, this_key)) {</span>
<span class="line" id="L2099">            <span class="tok-kw">return</span> this_value;</span>
<span class="line" id="L2100">        }</span>
<span class="line" id="L2101"></span>
<span class="line" id="L2102">        i += <span class="tok-number">1</span>; <span class="tok-comment">// skip over null byte</span>
</span>
<span class="line" id="L2103">    }</span>
<span class="line" id="L2104">    <span class="tok-kw">return</span> <span class="tok-null">null</span>;</span>
<span class="line" id="L2105">}</span>
<span class="line" id="L2106"></span>
<span class="line" id="L2107"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> GetCwdError = <span class="tok-kw">error</span>{</span>
<span class="line" id="L2108">    NameTooLong,</span>
<span class="line" id="L2109">    CurrentWorkingDirectoryUnlinked,</span>
<span class="line" id="L2110">} || UnexpectedError;</span>
<span class="line" id="L2111"></span>
<span class="line" id="L2112"><span class="tok-comment">/// The result is a slice of out_buffer, indexed from 0.</span></span>
<span class="line" id="L2113"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">getcwd</span>(out_buffer: []<span class="tok-type">u8</span>) GetCwdError![]<span class="tok-type">u8</span> {</span>
<span class="line" id="L2114">    <span class="tok-kw">if</span> (builtin.os.tag == .windows) {</span>
<span class="line" id="L2115">        <span class="tok-kw">return</span> windows.GetCurrentDirectory(out_buffer);</span>
<span class="line" id="L2116">    } <span class="tok-kw">else</span> <span class="tok-kw">if</span> (builtin.os.tag == .wasi <span class="tok-kw">and</span> !builtin.link_libc) {</span>
<span class="line" id="L2117">        <span class="tok-kw">const</span> path = <span class="tok-str">&quot;.&quot;</span>;</span>
<span class="line" id="L2118">        <span class="tok-kw">if</span> (out_buffer.len &lt; path.len) <span class="tok-kw">return</span> <span class="tok-kw">error</span>.NameTooLong;</span>
<span class="line" id="L2119">        <span class="tok-kw">const</span> result = out_buffer[<span class="tok-number">0</span>..path.len];</span>
<span class="line" id="L2120">        <span class="tok-builtin">@memcpy</span>(result, path);</span>
<span class="line" id="L2121">        <span class="tok-kw">return</span> result;</span>
<span class="line" id="L2122">    }</span>
<span class="line" id="L2123"></span>
<span class="line" id="L2124">    <span class="tok-kw">const</span> err: E = <span class="tok-kw">if</span> (builtin.link_libc) err: {</span>
<span class="line" id="L2125">        <span class="tok-kw">const</span> c_err = <span class="tok-kw">if</span> (std.c.getcwd(out_buffer.ptr, out_buffer.len)) |_| <span class="tok-number">0</span> <span class="tok-kw">else</span> std.c._errno().*;</span>
<span class="line" id="L2126">        <span class="tok-kw">break</span> :err <span class="tok-builtin">@enumFromInt</span>(c_err);</span>
<span class="line" id="L2127">    } <span class="tok-kw">else</span> err: {</span>
<span class="line" id="L2128">        <span class="tok-kw">break</span> :err errno(system.getcwd(out_buffer.ptr, out_buffer.len));</span>
<span class="line" id="L2129">    };</span>
<span class="line" id="L2130">    <span class="tok-kw">switch</span> (err) {</span>
<span class="line" id="L2131">        .SUCCESS =&gt; <span class="tok-kw">return</span> mem.sliceTo(out_buffer, <span class="tok-number">0</span>),</span>
<span class="line" id="L2132">        .FAULT =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L2133">        .INVAL =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L2134">        .NOENT =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.CurrentWorkingDirectoryUnlinked,</span>
<span class="line" id="L2135">        .RANGE =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.NameTooLong,</span>
<span class="line" id="L2136">        <span class="tok-kw">else</span> =&gt; <span class="tok-kw">return</span> unexpectedErrno(err),</span>
<span class="line" id="L2137">    }</span>
<span class="line" id="L2138">}</span>
<span class="line" id="L2139"></span>
<span class="line" id="L2140"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> SymLinkError = <span class="tok-kw">error</span>{</span>
<span class="line" id="L2141">    <span class="tok-comment">/// In WASI, this error may occur when the file descriptor does</span></span>
<span class="line" id="L2142">    <span class="tok-comment">/// not hold the required rights to create a new symbolic link relative to it.</span></span>
<span class="line" id="L2143">    AccessDenied,</span>
<span class="line" id="L2144">    DiskQuota,</span>
<span class="line" id="L2145">    PathAlreadyExists,</span>
<span class="line" id="L2146">    FileSystem,</span>
<span class="line" id="L2147">    SymLinkLoop,</span>
<span class="line" id="L2148">    FileNotFound,</span>
<span class="line" id="L2149">    SystemResources,</span>
<span class="line" id="L2150">    NoSpaceLeft,</span>
<span class="line" id="L2151">    ReadOnlyFileSystem,</span>
<span class="line" id="L2152">    NotDir,</span>
<span class="line" id="L2153">    NameTooLong,</span>
<span class="line" id="L2154"></span>
<span class="line" id="L2155">    <span class="tok-comment">/// WASI-only; file paths must be valid UTF-8.</span></span>
<span class="line" id="L2156">    InvalidUtf8,</span>
<span class="line" id="L2157"></span>
<span class="line" id="L2158">    <span class="tok-comment">/// Windows-only; file paths provided by the user must be valid WTF-8.</span></span>
<span class="line" id="L2159">    <span class="tok-comment">/// https://simonsapin.github.io/wtf-8/</span></span>
<span class="line" id="L2160">    InvalidWtf8,</span>
<span class="line" id="L2161"></span>
<span class="line" id="L2162">    BadPathName,</span>
<span class="line" id="L2163">} || UnexpectedError;</span>
<span class="line" id="L2164"></span>
<span class="line" id="L2165"><span class="tok-comment">/// Creates a symbolic link named `sym_link_path` which contains the string `target_path`.</span></span>
<span class="line" id="L2166"><span class="tok-comment">/// A symbolic link (also known as a soft link) may point to an existing file or to a nonexistent</span></span>
<span class="line" id="L2167"><span class="tok-comment">/// one; the latter case is known as a dangling link.</span></span>
<span class="line" id="L2168"><span class="tok-comment">/// On Windows, both paths should be encoded as [WTF-8](https://simonsapin.github.io/wtf-8/).</span></span>
<span class="line" id="L2169"><span class="tok-comment">/// On WASI, both paths should be encoded as valid UTF-8.</span></span>
<span class="line" id="L2170"><span class="tok-comment">/// On other platforms, both paths are an opaque sequence of bytes with no particular encoding.</span></span>
<span class="line" id="L2171"><span class="tok-comment">/// If `sym_link_path` exists, it will not be overwritten.</span></span>
<span class="line" id="L2172"><span class="tok-comment">/// See also `symlinkZ.</span></span>
<span class="line" id="L2173"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">symlink</span>(target_path: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>, sym_link_path: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>) SymLinkError!<span class="tok-type">void</span> {</span>
<span class="line" id="L2174">    <span class="tok-kw">if</span> (builtin.os.tag == .windows) {</span>
<span class="line" id="L2175">        <span class="tok-builtin">@compileError</span>(<span class="tok-str">&quot;symlink is not supported on Windows; use std.os.windows.CreateSymbolicLink instead&quot;</span>);</span>
<span class="line" id="L2176">    } <span class="tok-kw">else</span> <span class="tok-kw">if</span> (builtin.os.tag == .wasi <span class="tok-kw">and</span> !builtin.link_libc) {</span>
<span class="line" id="L2177">        <span class="tok-kw">return</span> symlinkat(target_path, wasi.AT.FDCWD, sym_link_path);</span>
<span class="line" id="L2178">    }</span>
<span class="line" id="L2179">    <span class="tok-kw">const</span> target_path_c = <span class="tok-kw">try</span> toPosixPath(target_path);</span>
<span class="line" id="L2180">    <span class="tok-kw">const</span> sym_link_path_c = <span class="tok-kw">try</span> toPosixPath(sym_link_path);</span>
<span class="line" id="L2181">    <span class="tok-kw">return</span> symlinkZ(&amp;target_path_c, &amp;sym_link_path_c);</span>
<span class="line" id="L2182">}</span>
<span class="line" id="L2183"></span>
<span class="line" id="L2184"><span class="tok-comment">/// This is the same as `symlink` except the parameters are null-terminated pointers.</span></span>
<span class="line" id="L2185"><span class="tok-comment">/// See also `symlink`.</span></span>
<span class="line" id="L2186"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">symlinkZ</span>(target_path: [*:<span class="tok-number">0</span>]<span class="tok-kw">const</span> <span class="tok-type">u8</span>, sym_link_path: [*:<span class="tok-number">0</span>]<span class="tok-kw">const</span> <span class="tok-type">u8</span>) SymLinkError!<span class="tok-type">void</span> {</span>
<span class="line" id="L2187">    <span class="tok-kw">if</span> (builtin.os.tag == .windows) {</span>
<span class="line" id="L2188">        <span class="tok-builtin">@compileError</span>(<span class="tok-str">&quot;symlink is not supported on Windows; use std.os.windows.CreateSymbolicLink instead&quot;</span>);</span>
<span class="line" id="L2189">    } <span class="tok-kw">else</span> <span class="tok-kw">if</span> (builtin.os.tag == .wasi <span class="tok-kw">and</span> !builtin.link_libc) {</span>
<span class="line" id="L2190">        <span class="tok-kw">return</span> symlinkatZ(target_path, fs.cwd().fd, sym_link_path);</span>
<span class="line" id="L2191">    }</span>
<span class="line" id="L2192">    <span class="tok-kw">switch</span> (errno(system.symlink(target_path, sym_link_path))) {</span>
<span class="line" id="L2193">        .SUCCESS =&gt; <span class="tok-kw">return</span>,</span>
<span class="line" id="L2194">        .FAULT =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L2195">        .INVAL =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L2196">        .ACCES =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.AccessDenied,</span>
<span class="line" id="L2197">        .PERM =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.AccessDenied,</span>
<span class="line" id="L2198">        .DQUOT =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.DiskQuota,</span>
<span class="line" id="L2199">        .EXIST =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.PathAlreadyExists,</span>
<span class="line" id="L2200">        .IO =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.FileSystem,</span>
<span class="line" id="L2201">        .LOOP =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.SymLinkLoop,</span>
<span class="line" id="L2202">        .NAMETOOLONG =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.NameTooLong,</span>
<span class="line" id="L2203">        .NOENT =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.FileNotFound,</span>
<span class="line" id="L2204">        .NOTDIR =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.NotDir,</span>
<span class="line" id="L2205">        .NOMEM =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.SystemResources,</span>
<span class="line" id="L2206">        .NOSPC =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.NoSpaceLeft,</span>
<span class="line" id="L2207">        .ROFS =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.ReadOnlyFileSystem,</span>
<span class="line" id="L2208">        .ILSEQ =&gt; |err| <span class="tok-kw">if</span> (builtin.os.tag == .wasi)</span>
<span class="line" id="L2209">            <span class="tok-kw">return</span> <span class="tok-kw">error</span>.InvalidUtf8</span>
<span class="line" id="L2210">        <span class="tok-kw">else</span></span>
<span class="line" id="L2211">            <span class="tok-kw">return</span> unexpectedErrno(err),</span>
<span class="line" id="L2212">        <span class="tok-kw">else</span> =&gt; |err| <span class="tok-kw">return</span> unexpectedErrno(err),</span>
<span class="line" id="L2213">    }</span>
<span class="line" id="L2214">}</span>
<span class="line" id="L2215"></span>
<span class="line" id="L2216"><span class="tok-comment">/// Similar to `symlink`, however, creates a symbolic link named `sym_link_path` which contains the string</span></span>
<span class="line" id="L2217"><span class="tok-comment">/// `target_path` **relative** to `newdirfd` directory handle.</span></span>
<span class="line" id="L2218"><span class="tok-comment">/// A symbolic link (also known as a soft link) may point to an existing file or to a nonexistent</span></span>
<span class="line" id="L2219"><span class="tok-comment">/// one; the latter case is known as a dangling link.</span></span>
<span class="line" id="L2220"><span class="tok-comment">/// On Windows, both paths should be encoded as [WTF-8](https://simonsapin.github.io/wtf-8/).</span></span>
<span class="line" id="L2221"><span class="tok-comment">/// On WASI, both paths should be encoded as valid UTF-8.</span></span>
<span class="line" id="L2222"><span class="tok-comment">/// On other platforms, both paths are an opaque sequence of bytes with no particular encoding.</span></span>
<span class="line" id="L2223"><span class="tok-comment">/// If `sym_link_path` exists, it will not be overwritten.</span></span>
<span class="line" id="L2224"><span class="tok-comment">/// See also `symlinkatWasi`, `symlinkatZ` and `symlinkatW`.</span></span>
<span class="line" id="L2225"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">symlinkat</span>(target_path: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>, newdirfd: fd_t, sym_link_path: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>) SymLinkError!<span class="tok-type">void</span> {</span>
<span class="line" id="L2226">    <span class="tok-kw">if</span> (builtin.os.tag == .windows) {</span>
<span class="line" id="L2227">        <span class="tok-builtin">@compileError</span>(<span class="tok-str">&quot;symlinkat is not supported on Windows; use std.os.windows.CreateSymbolicLink instead&quot;</span>);</span>
<span class="line" id="L2228">    } <span class="tok-kw">else</span> <span class="tok-kw">if</span> (builtin.os.tag == .wasi <span class="tok-kw">and</span> !builtin.link_libc) {</span>
<span class="line" id="L2229">        <span class="tok-kw">return</span> symlinkatWasi(target_path, newdirfd, sym_link_path);</span>
<span class="line" id="L2230">    }</span>
<span class="line" id="L2231">    <span class="tok-kw">const</span> target_path_c = <span class="tok-kw">try</span> toPosixPath(target_path);</span>
<span class="line" id="L2232">    <span class="tok-kw">const</span> sym_link_path_c = <span class="tok-kw">try</span> toPosixPath(sym_link_path);</span>
<span class="line" id="L2233">    <span class="tok-kw">return</span> symlinkatZ(&amp;target_path_c, newdirfd, &amp;sym_link_path_c);</span>
<span class="line" id="L2234">}</span>
<span class="line" id="L2235"></span>
<span class="line" id="L2236"><span class="tok-comment">/// WASI-only. The same as `symlinkat` but targeting WASI.</span></span>
<span class="line" id="L2237"><span class="tok-comment">/// See also `symlinkat`.</span></span>
<span class="line" id="L2238"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">symlinkatWasi</span>(target_path: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>, newdirfd: fd_t, sym_link_path: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>) SymLinkError!<span class="tok-type">void</span> {</span>
<span class="line" id="L2239">    <span class="tok-kw">switch</span> (wasi.path_symlink(target_path.ptr, target_path.len, newdirfd, sym_link_path.ptr, sym_link_path.len)) {</span>
<span class="line" id="L2240">        .SUCCESS =&gt; {},</span>
<span class="line" id="L2241">        .FAULT =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L2242">        .INVAL =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L2243">        .BADF =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L2244">        .ACCES =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.AccessDenied,</span>
<span class="line" id="L2245">        .PERM =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.AccessDenied,</span>
<span class="line" id="L2246">        .DQUOT =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.DiskQuota,</span>
<span class="line" id="L2247">        .EXIST =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.PathAlreadyExists,</span>
<span class="line" id="L2248">        .IO =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.FileSystem,</span>
<span class="line" id="L2249">        .LOOP =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.SymLinkLoop,</span>
<span class="line" id="L2250">        .NAMETOOLONG =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.NameTooLong,</span>
<span class="line" id="L2251">        .NOENT =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.FileNotFound,</span>
<span class="line" id="L2252">        .NOTDIR =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.NotDir,</span>
<span class="line" id="L2253">        .NOMEM =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.SystemResources,</span>
<span class="line" id="L2254">        .NOSPC =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.NoSpaceLeft,</span>
<span class="line" id="L2255">        .ROFS =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.ReadOnlyFileSystem,</span>
<span class="line" id="L2256">        .NOTCAPABLE =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.AccessDenied,</span>
<span class="line" id="L2257">        .ILSEQ =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.InvalidUtf8,</span>
<span class="line" id="L2258">        <span class="tok-kw">else</span> =&gt; |err| <span class="tok-kw">return</span> unexpectedErrno(err),</span>
<span class="line" id="L2259">    }</span>
<span class="line" id="L2260">}</span>
<span class="line" id="L2261"></span>
<span class="line" id="L2262"><span class="tok-comment">/// The same as `symlinkat` except the parameters are null-terminated pointers.</span></span>
<span class="line" id="L2263"><span class="tok-comment">/// See also `symlinkat`.</span></span>
<span class="line" id="L2264"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">symlinkatZ</span>(target_path: [*:<span class="tok-number">0</span>]<span class="tok-kw">const</span> <span class="tok-type">u8</span>, newdirfd: fd_t, sym_link_path: [*:<span class="tok-number">0</span>]<span class="tok-kw">const</span> <span class="tok-type">u8</span>) SymLinkError!<span class="tok-type">void</span> {</span>
<span class="line" id="L2265">    <span class="tok-kw">if</span> (builtin.os.tag == .windows) {</span>
<span class="line" id="L2266">        <span class="tok-builtin">@compileError</span>(<span class="tok-str">&quot;symlinkat is not supported on Windows; use std.os.windows.CreateSymbolicLink instead&quot;</span>);</span>
<span class="line" id="L2267">    } <span class="tok-kw">else</span> <span class="tok-kw">if</span> (builtin.os.tag == .wasi <span class="tok-kw">and</span> !builtin.link_libc) {</span>
<span class="line" id="L2268">        <span class="tok-kw">return</span> symlinkat(mem.sliceTo(target_path, <span class="tok-number">0</span>), newdirfd, mem.sliceTo(sym_link_path, <span class="tok-number">0</span>));</span>
<span class="line" id="L2269">    }</span>
<span class="line" id="L2270">    <span class="tok-kw">switch</span> (errno(system.symlinkat(target_path, newdirfd, sym_link_path))) {</span>
<span class="line" id="L2271">        .SUCCESS =&gt; <span class="tok-kw">return</span>,</span>
<span class="line" id="L2272">        .FAULT =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L2273">        .INVAL =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L2274">        .ACCES =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.AccessDenied,</span>
<span class="line" id="L2275">        .PERM =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.AccessDenied,</span>
<span class="line" id="L2276">        .DQUOT =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.DiskQuota,</span>
<span class="line" id="L2277">        .EXIST =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.PathAlreadyExists,</span>
<span class="line" id="L2278">        .IO =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.FileSystem,</span>
<span class="line" id="L2279">        .LOOP =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.SymLinkLoop,</span>
<span class="line" id="L2280">        .NAMETOOLONG =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.NameTooLong,</span>
<span class="line" id="L2281">        .NOENT =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.FileNotFound,</span>
<span class="line" id="L2282">        .NOTDIR =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.NotDir,</span>
<span class="line" id="L2283">        .NOMEM =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.SystemResources,</span>
<span class="line" id="L2284">        .NOSPC =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.NoSpaceLeft,</span>
<span class="line" id="L2285">        .ROFS =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.ReadOnlyFileSystem,</span>
<span class="line" id="L2286">        .ILSEQ =&gt; |err| <span class="tok-kw">if</span> (builtin.os.tag == .wasi)</span>
<span class="line" id="L2287">            <span class="tok-kw">return</span> <span class="tok-kw">error</span>.InvalidUtf8</span>
<span class="line" id="L2288">        <span class="tok-kw">else</span></span>
<span class="line" id="L2289">            <span class="tok-kw">return</span> unexpectedErrno(err),</span>
<span class="line" id="L2290">        <span class="tok-kw">else</span> =&gt; |err| <span class="tok-kw">return</span> unexpectedErrno(err),</span>
<span class="line" id="L2291">    }</span>
<span class="line" id="L2292">}</span>
<span class="line" id="L2293"></span>
<span class="line" id="L2294"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> LinkError = UnexpectedError || <span class="tok-kw">error</span>{</span>
<span class="line" id="L2295">    AccessDenied,</span>
<span class="line" id="L2296">    DiskQuota,</span>
<span class="line" id="L2297">    PathAlreadyExists,</span>
<span class="line" id="L2298">    FileSystem,</span>
<span class="line" id="L2299">    SymLinkLoop,</span>
<span class="line" id="L2300">    LinkQuotaExceeded,</span>
<span class="line" id="L2301">    NameTooLong,</span>
<span class="line" id="L2302">    FileNotFound,</span>
<span class="line" id="L2303">    SystemResources,</span>
<span class="line" id="L2304">    NoSpaceLeft,</span>
<span class="line" id="L2305">    ReadOnlyFileSystem,</span>
<span class="line" id="L2306">    NotSameFileSystem,</span>
<span class="line" id="L2307"></span>
<span class="line" id="L2308">    <span class="tok-comment">/// WASI-only; file paths must be valid UTF-8.</span></span>
<span class="line" id="L2309">    InvalidUtf8,</span>
<span class="line" id="L2310">};</span>
<span class="line" id="L2311"></span>
<span class="line" id="L2312"><span class="tok-comment">/// On WASI, both paths should be encoded as valid UTF-8.</span></span>
<span class="line" id="L2313"><span class="tok-comment">/// On other platforms, both paths are an opaque sequence of bytes with no particular encoding.</span></span>
<span class="line" id="L2314"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">linkZ</span>(oldpath: [*:<span class="tok-number">0</span>]<span class="tok-kw">const</span> <span class="tok-type">u8</span>, newpath: [*:<span class="tok-number">0</span>]<span class="tok-kw">const</span> <span class="tok-type">u8</span>, flags: <span class="tok-type">i32</span>) LinkError!<span class="tok-type">void</span> {</span>
<span class="line" id="L2315">    <span class="tok-kw">if</span> (builtin.os.tag == .wasi <span class="tok-kw">and</span> !builtin.link_libc) {</span>
<span class="line" id="L2316">        <span class="tok-kw">return</span> link(mem.sliceTo(oldpath, <span class="tok-number">0</span>), mem.sliceTo(newpath, <span class="tok-number">0</span>), flags);</span>
<span class="line" id="L2317">    }</span>
<span class="line" id="L2318">    <span class="tok-kw">switch</span> (errno(system.link(oldpath, newpath, flags))) {</span>
<span class="line" id="L2319">        .SUCCESS =&gt; <span class="tok-kw">return</span>,</span>
<span class="line" id="L2320">        .ACCES =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.AccessDenied,</span>
<span class="line" id="L2321">        .DQUOT =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.DiskQuota,</span>
<span class="line" id="L2322">        .EXIST =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.PathAlreadyExists,</span>
<span class="line" id="L2323">        .FAULT =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L2324">        .IO =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.FileSystem,</span>
<span class="line" id="L2325">        .LOOP =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.SymLinkLoop,</span>
<span class="line" id="L2326">        .MLINK =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.LinkQuotaExceeded,</span>
<span class="line" id="L2327">        .NAMETOOLONG =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.NameTooLong,</span>
<span class="line" id="L2328">        .NOENT =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.FileNotFound,</span>
<span class="line" id="L2329">        .NOMEM =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.SystemResources,</span>
<span class="line" id="L2330">        .NOSPC =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.NoSpaceLeft,</span>
<span class="line" id="L2331">        .PERM =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.AccessDenied,</span>
<span class="line" id="L2332">        .ROFS =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.ReadOnlyFileSystem,</span>
<span class="line" id="L2333">        .XDEV =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.NotSameFileSystem,</span>
<span class="line" id="L2334">        .INVAL =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L2335">        .ILSEQ =&gt; |err| <span class="tok-kw">if</span> (builtin.os.tag == .wasi)</span>
<span class="line" id="L2336">            <span class="tok-kw">return</span> <span class="tok-kw">error</span>.InvalidUtf8</span>
<span class="line" id="L2337">        <span class="tok-kw">else</span></span>
<span class="line" id="L2338">            <span class="tok-kw">return</span> unexpectedErrno(err),</span>
<span class="line" id="L2339">        <span class="tok-kw">else</span> =&gt; |err| <span class="tok-kw">return</span> unexpectedErrno(err),</span>
<span class="line" id="L2340">    }</span>
<span class="line" id="L2341">}</span>
<span class="line" id="L2342"></span>
<span class="line" id="L2343"><span class="tok-comment">/// On WASI, both paths should be encoded as valid UTF-8.</span></span>
<span class="line" id="L2344"><span class="tok-comment">/// On other platforms, both paths are an opaque sequence of bytes with no particular encoding.</span></span>
<span class="line" id="L2345"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">link</span>(oldpath: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>, newpath: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>, flags: <span class="tok-type">i32</span>) LinkError!<span class="tok-type">void</span> {</span>
<span class="line" id="L2346">    <span class="tok-kw">if</span> (builtin.os.tag == .wasi <span class="tok-kw">and</span> !builtin.link_libc) {</span>
<span class="line" id="L2347">        <span class="tok-kw">return</span> linkat(wasi.AT.FDCWD, oldpath, wasi.AT.FDCWD, newpath, flags) <span class="tok-kw">catch</span> |err| <span class="tok-kw">switch</span> (err) {</span>
<span class="line" id="L2348">            <span class="tok-kw">error</span>.NotDir =&gt; <span class="tok-kw">unreachable</span>, <span class="tok-comment">// link() does not support directories</span>
</span>
<span class="line" id="L2349">            <span class="tok-kw">else</span> =&gt; |e| <span class="tok-kw">return</span> e,</span>
<span class="line" id="L2350">        };</span>
<span class="line" id="L2351">    }</span>
<span class="line" id="L2352">    <span class="tok-kw">const</span> old = <span class="tok-kw">try</span> toPosixPath(oldpath);</span>
<span class="line" id="L2353">    <span class="tok-kw">const</span> new = <span class="tok-kw">try</span> toPosixPath(newpath);</span>
<span class="line" id="L2354">    <span class="tok-kw">return</span> <span class="tok-kw">try</span> linkZ(&amp;old, &amp;new, flags);</span>
<span class="line" id="L2355">}</span>
<span class="line" id="L2356"></span>
<span class="line" id="L2357"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> LinkatError = LinkError || <span class="tok-kw">error</span>{NotDir};</span>
<span class="line" id="L2358"></span>
<span class="line" id="L2359"><span class="tok-comment">/// On WASI, both paths should be encoded as valid UTF-8.</span></span>
<span class="line" id="L2360"><span class="tok-comment">/// On other platforms, both paths are an opaque sequence of bytes with no particular encoding.</span></span>
<span class="line" id="L2361"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">linkatZ</span>(</span>
<span class="line" id="L2362">    olddir: fd_t,</span>
<span class="line" id="L2363">    oldpath: [*:<span class="tok-number">0</span>]<span class="tok-kw">const</span> <span class="tok-type">u8</span>,</span>
<span class="line" id="L2364">    newdir: fd_t,</span>
<span class="line" id="L2365">    newpath: [*:<span class="tok-number">0</span>]<span class="tok-kw">const</span> <span class="tok-type">u8</span>,</span>
<span class="line" id="L2366">    flags: <span class="tok-type">i32</span>,</span>
<span class="line" id="L2367">) LinkatError!<span class="tok-type">void</span> {</span>
<span class="line" id="L2368">    <span class="tok-kw">if</span> (builtin.os.tag == .wasi <span class="tok-kw">and</span> !builtin.link_libc) {</span>
<span class="line" id="L2369">        <span class="tok-kw">return</span> linkat(olddir, mem.sliceTo(oldpath, <span class="tok-number">0</span>), newdir, mem.sliceTo(newpath, <span class="tok-number">0</span>), flags);</span>
<span class="line" id="L2370">    }</span>
<span class="line" id="L2371">    <span class="tok-kw">switch</span> (errno(system.linkat(olddir, oldpath, newdir, newpath, flags))) {</span>
<span class="line" id="L2372">        .SUCCESS =&gt; <span class="tok-kw">return</span>,</span>
<span class="line" id="L2373">        .ACCES =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.AccessDenied,</span>
<span class="line" id="L2374">        .DQUOT =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.DiskQuota,</span>
<span class="line" id="L2375">        .EXIST =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.PathAlreadyExists,</span>
<span class="line" id="L2376">        .FAULT =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L2377">        .IO =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.FileSystem,</span>
<span class="line" id="L2378">        .LOOP =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.SymLinkLoop,</span>
<span class="line" id="L2379">        .MLINK =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.LinkQuotaExceeded,</span>
<span class="line" id="L2380">        .NAMETOOLONG =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.NameTooLong,</span>
<span class="line" id="L2381">        .NOENT =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.FileNotFound,</span>
<span class="line" id="L2382">        .NOMEM =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.SystemResources,</span>
<span class="line" id="L2383">        .NOSPC =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.NoSpaceLeft,</span>
<span class="line" id="L2384">        .NOTDIR =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.NotDir,</span>
<span class="line" id="L2385">        .PERM =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.AccessDenied,</span>
<span class="line" id="L2386">        .ROFS =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.ReadOnlyFileSystem,</span>
<span class="line" id="L2387">        .XDEV =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.NotSameFileSystem,</span>
<span class="line" id="L2388">        .INVAL =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L2389">        .ILSEQ =&gt; |err| <span class="tok-kw">if</span> (builtin.os.tag == .wasi)</span>
<span class="line" id="L2390">            <span class="tok-kw">return</span> <span class="tok-kw">error</span>.InvalidUtf8</span>
<span class="line" id="L2391">        <span class="tok-kw">else</span></span>
<span class="line" id="L2392">            <span class="tok-kw">return</span> unexpectedErrno(err),</span>
<span class="line" id="L2393">        <span class="tok-kw">else</span> =&gt; |err| <span class="tok-kw">return</span> unexpectedErrno(err),</span>
<span class="line" id="L2394">    }</span>
<span class="line" id="L2395">}</span>
<span class="line" id="L2396"></span>
<span class="line" id="L2397"><span class="tok-comment">/// On WASI, both paths should be encoded as valid UTF-8.</span></span>
<span class="line" id="L2398"><span class="tok-comment">/// On other platforms, both paths are an opaque sequence of bytes with no particular encoding.</span></span>
<span class="line" id="L2399"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">linkat</span>(</span>
<span class="line" id="L2400">    olddir: fd_t,</span>
<span class="line" id="L2401">    oldpath: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>,</span>
<span class="line" id="L2402">    newdir: fd_t,</span>
<span class="line" id="L2403">    newpath: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>,</span>
<span class="line" id="L2404">    flags: <span class="tok-type">i32</span>,</span>
<span class="line" id="L2405">) LinkatError!<span class="tok-type">void</span> {</span>
<span class="line" id="L2406">    <span class="tok-kw">if</span> (builtin.os.tag == .wasi <span class="tok-kw">and</span> !builtin.link_libc) {</span>
<span class="line" id="L2407">        <span class="tok-kw">const</span> old: RelativePathWasi = .{ .dir_fd = olddir, .relative_path = oldpath };</span>
<span class="line" id="L2408">        <span class="tok-kw">const</span> new: RelativePathWasi = .{ .dir_fd = newdir, .relative_path = newpath };</span>
<span class="line" id="L2409">        <span class="tok-kw">const</span> old_flags: wasi.lookupflags_t = .{</span>
<span class="line" id="L2410">            .SYMLINK_FOLLOW = (flags &amp; AT.SYMLINK_FOLLOW) != <span class="tok-number">0</span>,</span>
<span class="line" id="L2411">        };</span>
<span class="line" id="L2412">        <span class="tok-kw">switch</span> (wasi.path_link(</span>
<span class="line" id="L2413">            old.dir_fd,</span>
<span class="line" id="L2414">            old_flags,</span>
<span class="line" id="L2415">            old.relative_path.ptr,</span>
<span class="line" id="L2416">            old.relative_path.len,</span>
<span class="line" id="L2417">            new.dir_fd,</span>
<span class="line" id="L2418">            new.relative_path.ptr,</span>
<span class="line" id="L2419">            new.relative_path.len,</span>
<span class="line" id="L2420">        )) {</span>
<span class="line" id="L2421">            .SUCCESS =&gt; <span class="tok-kw">return</span>,</span>
<span class="line" id="L2422">            .ACCES =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.AccessDenied,</span>
<span class="line" id="L2423">            .DQUOT =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.DiskQuota,</span>
<span class="line" id="L2424">            .EXIST =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.PathAlreadyExists,</span>
<span class="line" id="L2425">            .FAULT =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L2426">            .IO =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.FileSystem,</span>
<span class="line" id="L2427">            .LOOP =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.SymLinkLoop,</span>
<span class="line" id="L2428">            .MLINK =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.LinkQuotaExceeded,</span>
<span class="line" id="L2429">            .NAMETOOLONG =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.NameTooLong,</span>
<span class="line" id="L2430">            .NOENT =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.FileNotFound,</span>
<span class="line" id="L2431">            .NOMEM =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.SystemResources,</span>
<span class="line" id="L2432">            .NOSPC =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.NoSpaceLeft,</span>
<span class="line" id="L2433">            .NOTDIR =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.NotDir,</span>
<span class="line" id="L2434">            .PERM =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.AccessDenied,</span>
<span class="line" id="L2435">            .ROFS =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.ReadOnlyFileSystem,</span>
<span class="line" id="L2436">            .XDEV =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.NotSameFileSystem,</span>
<span class="line" id="L2437">            .INVAL =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L2438">            .ILSEQ =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.InvalidUtf8,</span>
<span class="line" id="L2439">            <span class="tok-kw">else</span> =&gt; |err| <span class="tok-kw">return</span> unexpectedErrno(err),</span>
<span class="line" id="L2440">        }</span>
<span class="line" id="L2441">    }</span>
<span class="line" id="L2442">    <span class="tok-kw">const</span> old = <span class="tok-kw">try</span> toPosixPath(oldpath);</span>
<span class="line" id="L2443">    <span class="tok-kw">const</span> new = <span class="tok-kw">try</span> toPosixPath(newpath);</span>
<span class="line" id="L2444">    <span class="tok-kw">return</span> <span class="tok-kw">try</span> linkatZ(olddir, &amp;old, newdir, &amp;new, flags);</span>
<span class="line" id="L2445">}</span>
<span class="line" id="L2446"></span>
<span class="line" id="L2447"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> UnlinkError = <span class="tok-kw">error</span>{</span>
<span class="line" id="L2448">    FileNotFound,</span>
<span class="line" id="L2449"></span>
<span class="line" id="L2450">    <span class="tok-comment">/// In WASI, this error may occur when the file descriptor does</span></span>
<span class="line" id="L2451">    <span class="tok-comment">/// not hold the required rights to unlink a resource by path relative to it.</span></span>
<span class="line" id="L2452">    AccessDenied,</span>
<span class="line" id="L2453">    FileBusy,</span>
<span class="line" id="L2454">    FileSystem,</span>
<span class="line" id="L2455">    IsDir,</span>
<span class="line" id="L2456">    SymLinkLoop,</span>
<span class="line" id="L2457">    NameTooLong,</span>
<span class="line" id="L2458">    NotDir,</span>
<span class="line" id="L2459">    SystemResources,</span>
<span class="line" id="L2460">    ReadOnlyFileSystem,</span>
<span class="line" id="L2461"></span>
<span class="line" id="L2462">    <span class="tok-comment">/// WASI-only; file paths must be valid UTF-8.</span></span>
<span class="line" id="L2463">    InvalidUtf8,</span>
<span class="line" id="L2464"></span>
<span class="line" id="L2465">    <span class="tok-comment">/// Windows-only; file paths provided by the user must be valid WTF-8.</span></span>
<span class="line" id="L2466">    <span class="tok-comment">/// https://simonsapin.github.io/wtf-8/</span></span>
<span class="line" id="L2467">    InvalidWtf8,</span>
<span class="line" id="L2468"></span>
<span class="line" id="L2469">    <span class="tok-comment">/// On Windows, file paths cannot contain these characters:</span></span>
<span class="line" id="L2470">    <span class="tok-comment">/// '/', '*', '?', '&quot;', '&lt;', '&gt;', '|'</span></span>
<span class="line" id="L2471">    BadPathName,</span>
<span class="line" id="L2472"></span>
<span class="line" id="L2473">    <span class="tok-comment">/// On Windows, `\\server` or `\\server\share` was not found.</span></span>
<span class="line" id="L2474">    NetworkNotFound,</span>
<span class="line" id="L2475">} || UnexpectedError;</span>
<span class="line" id="L2476"></span>
<span class="line" id="L2477"><span class="tok-comment">/// Delete a name and possibly the file it refers to.</span></span>
<span class="line" id="L2478"><span class="tok-comment">/// On Windows, `file_path` should be encoded as [WTF-8](https://simonsapin.github.io/wtf-8/).</span></span>
<span class="line" id="L2479"><span class="tok-comment">/// On WASI, `file_path` should be encoded as valid UTF-8.</span></span>
<span class="line" id="L2480"><span class="tok-comment">/// On other platforms, `file_path` is an opaque sequence of bytes with no particular encoding.</span></span>
<span class="line" id="L2481"><span class="tok-comment">/// See also `unlinkZ`.</span></span>
<span class="line" id="L2482"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">unlink</span>(file_path: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>) UnlinkError!<span class="tok-type">void</span> {</span>
<span class="line" id="L2483">    <span class="tok-kw">if</span> (builtin.os.tag == .wasi <span class="tok-kw">and</span> !builtin.link_libc) {</span>
<span class="line" id="L2484">        <span class="tok-kw">return</span> unlinkat(wasi.AT.FDCWD, file_path, <span class="tok-number">0</span>) <span class="tok-kw">catch</span> |err| <span class="tok-kw">switch</span> (err) {</span>
<span class="line" id="L2485">            <span class="tok-kw">error</span>.DirNotEmpty =&gt; <span class="tok-kw">unreachable</span>, <span class="tok-comment">// only occurs when targeting directories</span>
</span>
<span class="line" id="L2486">            <span class="tok-kw">else</span> =&gt; |e| <span class="tok-kw">return</span> e,</span>
<span class="line" id="L2487">        };</span>
<span class="line" id="L2488">    } <span class="tok-kw">else</span> <span class="tok-kw">if</span> (builtin.os.tag == .windows) {</span>
<span class="line" id="L2489">        <span class="tok-kw">const</span> file_path_w = <span class="tok-kw">try</span> windows.sliceToPrefixedFileW(<span class="tok-null">null</span>, file_path);</span>
<span class="line" id="L2490">        <span class="tok-kw">return</span> unlinkW(file_path_w.span());</span>
<span class="line" id="L2491">    } <span class="tok-kw">else</span> {</span>
<span class="line" id="L2492">        <span class="tok-kw">const</span> file_path_c = <span class="tok-kw">try</span> toPosixPath(file_path);</span>
<span class="line" id="L2493">        <span class="tok-kw">return</span> unlinkZ(&amp;file_path_c);</span>
<span class="line" id="L2494">    }</span>
<span class="line" id="L2495">}</span>
<span class="line" id="L2496"></span>
<span class="line" id="L2497"><span class="tok-comment">/// Same as `unlink` except the parameter is null terminated.</span></span>
<span class="line" id="L2498"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">unlinkZ</span>(file_path: [*:<span class="tok-number">0</span>]<span class="tok-kw">const</span> <span class="tok-type">u8</span>) UnlinkError!<span class="tok-type">void</span> {</span>
<span class="line" id="L2499">    <span class="tok-kw">if</span> (builtin.os.tag == .windows) {</span>
<span class="line" id="L2500">        <span class="tok-kw">const</span> file_path_w = <span class="tok-kw">try</span> windows.cStrToPrefixedFileW(<span class="tok-null">null</span>, file_path);</span>
<span class="line" id="L2501">        <span class="tok-kw">return</span> unlinkW(file_path_w.span());</span>
<span class="line" id="L2502">    } <span class="tok-kw">else</span> <span class="tok-kw">if</span> (builtin.os.tag == .wasi <span class="tok-kw">and</span> !builtin.link_libc) {</span>
<span class="line" id="L2503">        <span class="tok-kw">return</span> unlink(mem.sliceTo(file_path, <span class="tok-number">0</span>));</span>
<span class="line" id="L2504">    }</span>
<span class="line" id="L2505">    <span class="tok-kw">switch</span> (errno(system.unlink(file_path))) {</span>
<span class="line" id="L2506">        .SUCCESS =&gt; <span class="tok-kw">return</span>,</span>
<span class="line" id="L2507">        .ACCES =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.AccessDenied,</span>
<span class="line" id="L2508">        .PERM =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.AccessDenied,</span>
<span class="line" id="L2509">        .BUSY =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.FileBusy,</span>
<span class="line" id="L2510">        .FAULT =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L2511">        .INVAL =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L2512">        .IO =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.FileSystem,</span>
<span class="line" id="L2513">        .ISDIR =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.IsDir,</span>
<span class="line" id="L2514">        .LOOP =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.SymLinkLoop,</span>
<span class="line" id="L2515">        .NAMETOOLONG =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.NameTooLong,</span>
<span class="line" id="L2516">        .NOENT =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.FileNotFound,</span>
<span class="line" id="L2517">        .NOTDIR =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.NotDir,</span>
<span class="line" id="L2518">        .NOMEM =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.SystemResources,</span>
<span class="line" id="L2519">        .ROFS =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.ReadOnlyFileSystem,</span>
<span class="line" id="L2520">        .ILSEQ =&gt; |err| <span class="tok-kw">if</span> (builtin.os.tag == .wasi)</span>
<span class="line" id="L2521">            <span class="tok-kw">return</span> <span class="tok-kw">error</span>.InvalidUtf8</span>
<span class="line" id="L2522">        <span class="tok-kw">else</span></span>
<span class="line" id="L2523">            <span class="tok-kw">return</span> unexpectedErrno(err),</span>
<span class="line" id="L2524">        <span class="tok-kw">else</span> =&gt; |err| <span class="tok-kw">return</span> unexpectedErrno(err),</span>
<span class="line" id="L2525">    }</span>
<span class="line" id="L2526">}</span>
<span class="line" id="L2527"></span>
<span class="line" id="L2528"><span class="tok-comment">/// Windows-only. Same as `unlink` except the parameter is null-terminated, WTF16 LE encoded.</span></span>
<span class="line" id="L2529"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">unlinkW</span>(file_path_w: []<span class="tok-kw">const</span> <span class="tok-type">u16</span>) UnlinkError!<span class="tok-type">void</span> {</span>
<span class="line" id="L2530">    windows.DeleteFile(file_path_w, .{ .dir = std.fs.cwd().fd }) <span class="tok-kw">catch</span> |err| <span class="tok-kw">switch</span> (err) {</span>
<span class="line" id="L2531">        <span class="tok-kw">error</span>.DirNotEmpty =&gt; <span class="tok-kw">unreachable</span>, <span class="tok-comment">// we're not passing .remove_dir = true</span>
</span>
<span class="line" id="L2532">        <span class="tok-kw">else</span> =&gt; |e| <span class="tok-kw">return</span> e,</span>
<span class="line" id="L2533">    };</span>
<span class="line" id="L2534">}</span>
<span class="line" id="L2535"></span>
<span class="line" id="L2536"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> UnlinkatError = UnlinkError || <span class="tok-kw">error</span>{</span>
<span class="line" id="L2537">    <span class="tok-comment">/// When passing `AT.REMOVEDIR`, this error occurs when the named directory is not empty.</span></span>
<span class="line" id="L2538">    DirNotEmpty,</span>
<span class="line" id="L2539">};</span>
<span class="line" id="L2540"></span>
<span class="line" id="L2541"><span class="tok-comment">/// Delete a file name and possibly the file it refers to, based on an open directory handle.</span></span>
<span class="line" id="L2542"><span class="tok-comment">/// On Windows, `file_path` should be encoded as [WTF-8](https://simonsapin.github.io/wtf-8/).</span></span>
<span class="line" id="L2543"><span class="tok-comment">/// On WASI, `file_path` should be encoded as valid UTF-8.</span></span>
<span class="line" id="L2544"><span class="tok-comment">/// On other platforms, `file_path` is an opaque sequence of bytes with no particular encoding.</span></span>
<span class="line" id="L2545"><span class="tok-comment">/// Asserts that the path parameter has no null bytes.</span></span>
<span class="line" id="L2546"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">unlinkat</span>(dirfd: fd_t, file_path: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>, flags: <span class="tok-type">u32</span>) UnlinkatError!<span class="tok-type">void</span> {</span>
<span class="line" id="L2547">    <span class="tok-kw">if</span> (builtin.os.tag == .windows) {</span>
<span class="line" id="L2548">        <span class="tok-kw">const</span> file_path_w = <span class="tok-kw">try</span> windows.sliceToPrefixedFileW(dirfd, file_path);</span>
<span class="line" id="L2549">        <span class="tok-kw">return</span> unlinkatW(dirfd, file_path_w.span(), flags);</span>
<span class="line" id="L2550">    } <span class="tok-kw">else</span> <span class="tok-kw">if</span> (builtin.os.tag == .wasi <span class="tok-kw">and</span> !builtin.link_libc) {</span>
<span class="line" id="L2551">        <span class="tok-kw">return</span> unlinkatWasi(dirfd, file_path, flags);</span>
<span class="line" id="L2552">    } <span class="tok-kw">else</span> {</span>
<span class="line" id="L2553">        <span class="tok-kw">const</span> file_path_c = <span class="tok-kw">try</span> toPosixPath(file_path);</span>
<span class="line" id="L2554">        <span class="tok-kw">return</span> unlinkatZ(dirfd, &amp;file_path_c, flags);</span>
<span class="line" id="L2555">    }</span>
<span class="line" id="L2556">}</span>
<span class="line" id="L2557"></span>
<span class="line" id="L2558"><span class="tok-comment">/// WASI-only. Same as `unlinkat` but targeting WASI.</span></span>
<span class="line" id="L2559"><span class="tok-comment">/// See also `unlinkat`.</span></span>
<span class="line" id="L2560"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">unlinkatWasi</span>(dirfd: fd_t, file_path: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>, flags: <span class="tok-type">u32</span>) UnlinkatError!<span class="tok-type">void</span> {</span>
<span class="line" id="L2561">    <span class="tok-kw">const</span> remove_dir = (flags &amp; AT.REMOVEDIR) != <span class="tok-number">0</span>;</span>
<span class="line" id="L2562">    <span class="tok-kw">const</span> res = <span class="tok-kw">if</span> (remove_dir)</span>
<span class="line" id="L2563">        wasi.path_remove_directory(dirfd, file_path.ptr, file_path.len)</span>
<span class="line" id="L2564">    <span class="tok-kw">else</span></span>
<span class="line" id="L2565">        wasi.path_unlink_file(dirfd, file_path.ptr, file_path.len);</span>
<span class="line" id="L2566">    <span class="tok-kw">switch</span> (res) {</span>
<span class="line" id="L2567">        .SUCCESS =&gt; <span class="tok-kw">return</span>,</span>
<span class="line" id="L2568">        .ACCES =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.AccessDenied,</span>
<span class="line" id="L2569">        .PERM =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.AccessDenied,</span>
<span class="line" id="L2570">        .BUSY =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.FileBusy,</span>
<span class="line" id="L2571">        .FAULT =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L2572">        .IO =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.FileSystem,</span>
<span class="line" id="L2573">        .ISDIR =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.IsDir,</span>
<span class="line" id="L2574">        .LOOP =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.SymLinkLoop,</span>
<span class="line" id="L2575">        .NAMETOOLONG =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.NameTooLong,</span>
<span class="line" id="L2576">        .NOENT =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.FileNotFound,</span>
<span class="line" id="L2577">        .NOTDIR =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.NotDir,</span>
<span class="line" id="L2578">        .NOMEM =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.SystemResources,</span>
<span class="line" id="L2579">        .ROFS =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.ReadOnlyFileSystem,</span>
<span class="line" id="L2580">        .NOTEMPTY =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.DirNotEmpty,</span>
<span class="line" id="L2581">        .NOTCAPABLE =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.AccessDenied,</span>
<span class="line" id="L2582">        .ILSEQ =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.InvalidUtf8,</span>
<span class="line" id="L2583"></span>
<span class="line" id="L2584">        .INVAL =&gt; <span class="tok-kw">unreachable</span>, <span class="tok-comment">// invalid flags, or pathname has . as last component</span>
</span>
<span class="line" id="L2585">        .BADF =&gt; <span class="tok-kw">unreachable</span>, <span class="tok-comment">// always a race condition</span>
</span>
<span class="line" id="L2586"></span>
<span class="line" id="L2587">        <span class="tok-kw">else</span> =&gt; |err| <span class="tok-kw">return</span> unexpectedErrno(err),</span>
<span class="line" id="L2588">    }</span>
<span class="line" id="L2589">}</span>
<span class="line" id="L2590"></span>
<span class="line" id="L2591"><span class="tok-comment">/// Same as `unlinkat` but `file_path` is a null-terminated string.</span></span>
<span class="line" id="L2592"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">unlinkatZ</span>(dirfd: fd_t, file_path_c: [*:<span class="tok-number">0</span>]<span class="tok-kw">const</span> <span class="tok-type">u8</span>, flags: <span class="tok-type">u32</span>) UnlinkatError!<span class="tok-type">void</span> {</span>
<span class="line" id="L2593">    <span class="tok-kw">if</span> (builtin.os.tag == .windows) {</span>
<span class="line" id="L2594">        <span class="tok-kw">const</span> file_path_w = <span class="tok-kw">try</span> windows.cStrToPrefixedFileW(dirfd, file_path_c);</span>
<span class="line" id="L2595">        <span class="tok-kw">return</span> unlinkatW(dirfd, file_path_w.span(), flags);</span>
<span class="line" id="L2596">    } <span class="tok-kw">else</span> <span class="tok-kw">if</span> (builtin.os.tag == .wasi <span class="tok-kw">and</span> !builtin.link_libc) {</span>
<span class="line" id="L2597">        <span class="tok-kw">return</span> unlinkat(dirfd, mem.sliceTo(file_path_c, <span class="tok-number">0</span>), flags);</span>
<span class="line" id="L2598">    }</span>
<span class="line" id="L2599">    <span class="tok-kw">switch</span> (errno(system.unlinkat(dirfd, file_path_c, flags))) {</span>
<span class="line" id="L2600">        .SUCCESS =&gt; <span class="tok-kw">return</span>,</span>
<span class="line" id="L2601">        .ACCES =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.AccessDenied,</span>
<span class="line" id="L2602">        .PERM =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.AccessDenied,</span>
<span class="line" id="L2603">        .BUSY =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.FileBusy,</span>
<span class="line" id="L2604">        .FAULT =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L2605">        .IO =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.FileSystem,</span>
<span class="line" id="L2606">        .ISDIR =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.IsDir,</span>
<span class="line" id="L2607">        .LOOP =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.SymLinkLoop,</span>
<span class="line" id="L2608">        .NAMETOOLONG =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.NameTooLong,</span>
<span class="line" id="L2609">        .NOENT =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.FileNotFound,</span>
<span class="line" id="L2610">        .NOTDIR =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.NotDir,</span>
<span class="line" id="L2611">        .NOMEM =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.SystemResources,</span>
<span class="line" id="L2612">        .ROFS =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.ReadOnlyFileSystem,</span>
<span class="line" id="L2613">        .EXIST =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.DirNotEmpty,</span>
<span class="line" id="L2614">        .NOTEMPTY =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.DirNotEmpty,</span>
<span class="line" id="L2615">        .ILSEQ =&gt; |err| <span class="tok-kw">if</span> (builtin.os.tag == .wasi)</span>
<span class="line" id="L2616">            <span class="tok-kw">return</span> <span class="tok-kw">error</span>.InvalidUtf8</span>
<span class="line" id="L2617">        <span class="tok-kw">else</span></span>
<span class="line" id="L2618">            <span class="tok-kw">return</span> unexpectedErrno(err),</span>
<span class="line" id="L2619"></span>
<span class="line" id="L2620">        .INVAL =&gt; <span class="tok-kw">unreachable</span>, <span class="tok-comment">// invalid flags, or pathname has . as last component</span>
</span>
<span class="line" id="L2621">        .BADF =&gt; <span class="tok-kw">unreachable</span>, <span class="tok-comment">// always a race condition</span>
</span>
<span class="line" id="L2622"></span>
<span class="line" id="L2623">        <span class="tok-kw">else</span> =&gt; |err| <span class="tok-kw">return</span> unexpectedErrno(err),</span>
<span class="line" id="L2624">    }</span>
<span class="line" id="L2625">}</span>
<span class="line" id="L2626"></span>
<span class="line" id="L2627"><span class="tok-comment">/// Same as `unlinkat` but `sub_path_w` is WTF16LE, NT prefixed. Windows only.</span></span>
<span class="line" id="L2628"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">unlinkatW</span>(dirfd: fd_t, sub_path_w: []<span class="tok-kw">const</span> <span class="tok-type">u16</span>, flags: <span class="tok-type">u32</span>) UnlinkatError!<span class="tok-type">void</span> {</span>
<span class="line" id="L2629">    <span class="tok-kw">const</span> remove_dir = (flags &amp; AT.REMOVEDIR) != <span class="tok-number">0</span>;</span>
<span class="line" id="L2630">    <span class="tok-kw">return</span> windows.DeleteFile(sub_path_w, .{ .dir = dirfd, .remove_dir = remove_dir });</span>
<span class="line" id="L2631">}</span>
<span class="line" id="L2632"></span>
<span class="line" id="L2633"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> RenameError = <span class="tok-kw">error</span>{</span>
<span class="line" id="L2634">    <span class="tok-comment">/// In WASI, this error may occur when the file descriptor does</span></span>
<span class="line" id="L2635">    <span class="tok-comment">/// not hold the required rights to rename a resource by path relative to it.</span></span>
<span class="line" id="L2636">    <span class="tok-comment">///</span></span>
<span class="line" id="L2637">    <span class="tok-comment">/// On Windows, this error may be returned instead of PathAlreadyExists when</span></span>
<span class="line" id="L2638">    <span class="tok-comment">/// renaming a directory over an existing directory.</span></span>
<span class="line" id="L2639">    AccessDenied,</span>
<span class="line" id="L2640">    FileBusy,</span>
<span class="line" id="L2641">    DiskQuota,</span>
<span class="line" id="L2642">    IsDir,</span>
<span class="line" id="L2643">    SymLinkLoop,</span>
<span class="line" id="L2644">    LinkQuotaExceeded,</span>
<span class="line" id="L2645">    NameTooLong,</span>
<span class="line" id="L2646">    FileNotFound,</span>
<span class="line" id="L2647">    NotDir,</span>
<span class="line" id="L2648">    SystemResources,</span>
<span class="line" id="L2649">    NoSpaceLeft,</span>
<span class="line" id="L2650">    PathAlreadyExists,</span>
<span class="line" id="L2651">    ReadOnlyFileSystem,</span>
<span class="line" id="L2652">    RenameAcrossMountPoints,</span>
<span class="line" id="L2653">    <span class="tok-comment">/// WASI-only; file paths must be valid UTF-8.</span></span>
<span class="line" id="L2654">    InvalidUtf8,</span>
<span class="line" id="L2655">    <span class="tok-comment">/// Windows-only; file paths provided by the user must be valid WTF-8.</span></span>
<span class="line" id="L2656">    <span class="tok-comment">/// https://simonsapin.github.io/wtf-8/</span></span>
<span class="line" id="L2657">    InvalidWtf8,</span>
<span class="line" id="L2658">    BadPathName,</span>
<span class="line" id="L2659">    NoDevice,</span>
<span class="line" id="L2660">    SharingViolation,</span>
<span class="line" id="L2661">    PipeBusy,</span>
<span class="line" id="L2662">    <span class="tok-comment">/// On Windows, `\\server` or `\\server\share` was not found.</span></span>
<span class="line" id="L2663">    NetworkNotFound,</span>
<span class="line" id="L2664">    <span class="tok-comment">/// On Windows, antivirus software is enabled by default. It can be</span></span>
<span class="line" id="L2665">    <span class="tok-comment">/// disabled, but Windows Update sometimes ignores the user's preference</span></span>
<span class="line" id="L2666">    <span class="tok-comment">/// and re-enables it. When enabled, antivirus software on Windows</span></span>
<span class="line" id="L2667">    <span class="tok-comment">/// intercepts file system operations and makes them significantly slower</span></span>
<span class="line" id="L2668">    <span class="tok-comment">/// in addition to possibly failing with this error code.</span></span>
<span class="line" id="L2669">    AntivirusInterference,</span>
<span class="line" id="L2670">} || UnexpectedError;</span>
<span class="line" id="L2671"></span>
<span class="line" id="L2672"><span class="tok-comment">/// Change the name or location of a file.</span></span>
<span class="line" id="L2673"><span class="tok-comment">/// On Windows, both paths should be encoded as [WTF-8](https://simonsapin.github.io/wtf-8/).</span></span>
<span class="line" id="L2674"><span class="tok-comment">/// On WASI, both paths should be encoded as valid UTF-8.</span></span>
<span class="line" id="L2675"><span class="tok-comment">/// On other platforms, both paths are an opaque sequence of bytes with no particular encoding.</span></span>
<span class="line" id="L2676"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">rename</span>(old_path: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>, new_path: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>) RenameError!<span class="tok-type">void</span> {</span>
<span class="line" id="L2677">    <span class="tok-kw">if</span> (builtin.os.tag == .wasi <span class="tok-kw">and</span> !builtin.link_libc) {</span>
<span class="line" id="L2678">        <span class="tok-kw">return</span> renameat(wasi.AT.FDCWD, old_path, wasi.AT.FDCWD, new_path);</span>
<span class="line" id="L2679">    } <span class="tok-kw">else</span> <span class="tok-kw">if</span> (builtin.os.tag == .windows) {</span>
<span class="line" id="L2680">        <span class="tok-kw">const</span> old_path_w = <span class="tok-kw">try</span> windows.sliceToPrefixedFileW(<span class="tok-null">null</span>, old_path);</span>
<span class="line" id="L2681">        <span class="tok-kw">const</span> new_path_w = <span class="tok-kw">try</span> windows.sliceToPrefixedFileW(<span class="tok-null">null</span>, new_path);</span>
<span class="line" id="L2682">        <span class="tok-kw">return</span> renameW(old_path_w.span().ptr, new_path_w.span().ptr);</span>
<span class="line" id="L2683">    } <span class="tok-kw">else</span> {</span>
<span class="line" id="L2684">        <span class="tok-kw">const</span> old_path_c = <span class="tok-kw">try</span> toPosixPath(old_path);</span>
<span class="line" id="L2685">        <span class="tok-kw">const</span> new_path_c = <span class="tok-kw">try</span> toPosixPath(new_path);</span>
<span class="line" id="L2686">        <span class="tok-kw">return</span> renameZ(&amp;old_path_c, &amp;new_path_c);</span>
<span class="line" id="L2687">    }</span>
<span class="line" id="L2688">}</span>
<span class="line" id="L2689"></span>
<span class="line" id="L2690"><span class="tok-comment">/// Same as `rename` except the parameters are null-terminated.</span></span>
<span class="line" id="L2691"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">renameZ</span>(old_path: [*:<span class="tok-number">0</span>]<span class="tok-kw">const</span> <span class="tok-type">u8</span>, new_path: [*:<span class="tok-number">0</span>]<span class="tok-kw">const</span> <span class="tok-type">u8</span>) RenameError!<span class="tok-type">void</span> {</span>
<span class="line" id="L2692">    <span class="tok-kw">if</span> (builtin.os.tag == .windows) {</span>
<span class="line" id="L2693">        <span class="tok-kw">const</span> old_path_w = <span class="tok-kw">try</span> windows.cStrToPrefixedFileW(<span class="tok-null">null</span>, old_path);</span>
<span class="line" id="L2694">        <span class="tok-kw">const</span> new_path_w = <span class="tok-kw">try</span> windows.cStrToPrefixedFileW(<span class="tok-null">null</span>, new_path);</span>
<span class="line" id="L2695">        <span class="tok-kw">return</span> renameW(old_path_w.span().ptr, new_path_w.span().ptr);</span>
<span class="line" id="L2696">    } <span class="tok-kw">else</span> <span class="tok-kw">if</span> (builtin.os.tag == .wasi <span class="tok-kw">and</span> !builtin.link_libc) {</span>
<span class="line" id="L2697">        <span class="tok-kw">return</span> rename(mem.sliceTo(old_path, <span class="tok-number">0</span>), mem.sliceTo(new_path, <span class="tok-number">0</span>));</span>
<span class="line" id="L2698">    }</span>
<span class="line" id="L2699">    <span class="tok-kw">switch</span> (errno(system.rename(old_path, new_path))) {</span>
<span class="line" id="L2700">        .SUCCESS =&gt; <span class="tok-kw">return</span>,</span>
<span class="line" id="L2701">        .ACCES =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.AccessDenied,</span>
<span class="line" id="L2702">        .PERM =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.AccessDenied,</span>
<span class="line" id="L2703">        .BUSY =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.FileBusy,</span>
<span class="line" id="L2704">        .DQUOT =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.DiskQuota,</span>
<span class="line" id="L2705">        .FAULT =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L2706">        .INVAL =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L2707">        .ISDIR =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.IsDir,</span>
<span class="line" id="L2708">        .LOOP =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.SymLinkLoop,</span>
<span class="line" id="L2709">        .MLINK =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.LinkQuotaExceeded,</span>
<span class="line" id="L2710">        .NAMETOOLONG =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.NameTooLong,</span>
<span class="line" id="L2711">        .NOENT =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.FileNotFound,</span>
<span class="line" id="L2712">        .NOTDIR =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.NotDir,</span>
<span class="line" id="L2713">        .NOMEM =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.SystemResources,</span>
<span class="line" id="L2714">        .NOSPC =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.NoSpaceLeft,</span>
<span class="line" id="L2715">        .EXIST =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.PathAlreadyExists,</span>
<span class="line" id="L2716">        .NOTEMPTY =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.PathAlreadyExists,</span>
<span class="line" id="L2717">        .ROFS =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.ReadOnlyFileSystem,</span>
<span class="line" id="L2718">        .XDEV =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.RenameAcrossMountPoints,</span>
<span class="line" id="L2719">        .ILSEQ =&gt; |err| <span class="tok-kw">if</span> (builtin.os.tag == .wasi)</span>
<span class="line" id="L2720">            <span class="tok-kw">return</span> <span class="tok-kw">error</span>.InvalidUtf8</span>
<span class="line" id="L2721">        <span class="tok-kw">else</span></span>
<span class="line" id="L2722">            <span class="tok-kw">return</span> unexpectedErrno(err),</span>
<span class="line" id="L2723">        <span class="tok-kw">else</span> =&gt; |err| <span class="tok-kw">return</span> unexpectedErrno(err),</span>
<span class="line" id="L2724">    }</span>
<span class="line" id="L2725">}</span>
<span class="line" id="L2726"></span>
<span class="line" id="L2727"><span class="tok-comment">/// Same as `rename` except the parameters are null-terminated and WTF16LE encoded.</span></span>
<span class="line" id="L2728"><span class="tok-comment">/// Assumes target is Windows.</span></span>
<span class="line" id="L2729"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">renameW</span>(old_path: [*:<span class="tok-number">0</span>]<span class="tok-kw">const</span> <span class="tok-type">u16</span>, new_path: [*:<span class="tok-number">0</span>]<span class="tok-kw">const</span> <span class="tok-type">u16</span>) RenameError!<span class="tok-type">void</span> {</span>
<span class="line" id="L2730">    <span class="tok-kw">const</span> flags = windows.MOVEFILE_REPLACE_EXISTING | windows.MOVEFILE_WRITE_THROUGH;</span>
<span class="line" id="L2731">    <span class="tok-kw">return</span> windows.MoveFileExW(old_path, new_path, flags);</span>
<span class="line" id="L2732">}</span>
<span class="line" id="L2733"></span>
<span class="line" id="L2734"><span class="tok-comment">/// Change the name or location of a file based on an open directory handle.</span></span>
<span class="line" id="L2735"><span class="tok-comment">/// On Windows, both paths should be encoded as [WTF-8](https://simonsapin.github.io/wtf-8/).</span></span>
<span class="line" id="L2736"><span class="tok-comment">/// On WASI, both paths should be encoded as valid UTF-8.</span></span>
<span class="line" id="L2737"><span class="tok-comment">/// On other platforms, both paths are an opaque sequence of bytes with no particular encoding.</span></span>
<span class="line" id="L2738"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">renameat</span>(</span>
<span class="line" id="L2739">    old_dir_fd: fd_t,</span>
<span class="line" id="L2740">    old_path: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>,</span>
<span class="line" id="L2741">    new_dir_fd: fd_t,</span>
<span class="line" id="L2742">    new_path: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>,</span>
<span class="line" id="L2743">) RenameError!<span class="tok-type">void</span> {</span>
<span class="line" id="L2744">    <span class="tok-kw">if</span> (builtin.os.tag == .windows) {</span>
<span class="line" id="L2745">        <span class="tok-kw">const</span> old_path_w = <span class="tok-kw">try</span> windows.sliceToPrefixedFileW(old_dir_fd, old_path);</span>
<span class="line" id="L2746">        <span class="tok-kw">const</span> new_path_w = <span class="tok-kw">try</span> windows.sliceToPrefixedFileW(new_dir_fd, new_path);</span>
<span class="line" id="L2747">        <span class="tok-kw">return</span> renameatW(old_dir_fd, old_path_w.span(), new_dir_fd, new_path_w.span(), windows.TRUE);</span>
<span class="line" id="L2748">    } <span class="tok-kw">else</span> <span class="tok-kw">if</span> (builtin.os.tag == .wasi <span class="tok-kw">and</span> !builtin.link_libc) {</span>
<span class="line" id="L2749">        <span class="tok-kw">const</span> old: RelativePathWasi = .{ .dir_fd = old_dir_fd, .relative_path = old_path };</span>
<span class="line" id="L2750">        <span class="tok-kw">const</span> new: RelativePathWasi = .{ .dir_fd = new_dir_fd, .relative_path = new_path };</span>
<span class="line" id="L2751">        <span class="tok-kw">return</span> renameatWasi(old, new);</span>
<span class="line" id="L2752">    } <span class="tok-kw">else</span> {</span>
<span class="line" id="L2753">        <span class="tok-kw">const</span> old_path_c = <span class="tok-kw">try</span> toPosixPath(old_path);</span>
<span class="line" id="L2754">        <span class="tok-kw">const</span> new_path_c = <span class="tok-kw">try</span> toPosixPath(new_path);</span>
<span class="line" id="L2755">        <span class="tok-kw">return</span> renameatZ(old_dir_fd, &amp;old_path_c, new_dir_fd, &amp;new_path_c);</span>
<span class="line" id="L2756">    }</span>
<span class="line" id="L2757">}</span>
<span class="line" id="L2758"></span>
<span class="line" id="L2759"><span class="tok-comment">/// WASI-only. Same as `renameat` expect targeting WASI.</span></span>
<span class="line" id="L2760"><span class="tok-comment">/// See also `renameat`.</span></span>
<span class="line" id="L2761"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">renameatWasi</span>(old: RelativePathWasi, new: RelativePathWasi) RenameError!<span class="tok-type">void</span> {</span>
<span class="line" id="L2762">    <span class="tok-kw">switch</span> (wasi.path_rename(old.dir_fd, old.relative_path.ptr, old.relative_path.len, new.dir_fd, new.relative_path.ptr, new.relative_path.len)) {</span>
<span class="line" id="L2763">        .SUCCESS =&gt; <span class="tok-kw">return</span>,</span>
<span class="line" id="L2764">        .ACCES =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.AccessDenied,</span>
<span class="line" id="L2765">        .PERM =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.AccessDenied,</span>
<span class="line" id="L2766">        .BUSY =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.FileBusy,</span>
<span class="line" id="L2767">        .DQUOT =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.DiskQuota,</span>
<span class="line" id="L2768">        .FAULT =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L2769">        .INVAL =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L2770">        .ISDIR =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.IsDir,</span>
<span class="line" id="L2771">        .LOOP =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.SymLinkLoop,</span>
<span class="line" id="L2772">        .MLINK =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.LinkQuotaExceeded,</span>
<span class="line" id="L2773">        .NAMETOOLONG =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.NameTooLong,</span>
<span class="line" id="L2774">        .NOENT =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.FileNotFound,</span>
<span class="line" id="L2775">        .NOTDIR =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.NotDir,</span>
<span class="line" id="L2776">        .NOMEM =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.SystemResources,</span>
<span class="line" id="L2777">        .NOSPC =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.NoSpaceLeft,</span>
<span class="line" id="L2778">        .EXIST =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.PathAlreadyExists,</span>
<span class="line" id="L2779">        .NOTEMPTY =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.PathAlreadyExists,</span>
<span class="line" id="L2780">        .ROFS =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.ReadOnlyFileSystem,</span>
<span class="line" id="L2781">        .XDEV =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.RenameAcrossMountPoints,</span>
<span class="line" id="L2782">        .NOTCAPABLE =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.AccessDenied,</span>
<span class="line" id="L2783">        .ILSEQ =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.InvalidUtf8,</span>
<span class="line" id="L2784">        <span class="tok-kw">else</span> =&gt; |err| <span class="tok-kw">return</span> unexpectedErrno(err),</span>
<span class="line" id="L2785">    }</span>
<span class="line" id="L2786">}</span>
<span class="line" id="L2787"></span>
<span class="line" id="L2788"><span class="tok-comment">/// Same as `renameat` except the parameters are null-terminated.</span></span>
<span class="line" id="L2789"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">renameatZ</span>(</span>
<span class="line" id="L2790">    old_dir_fd: fd_t,</span>
<span class="line" id="L2791">    old_path: [*:<span class="tok-number">0</span>]<span class="tok-kw">const</span> <span class="tok-type">u8</span>,</span>
<span class="line" id="L2792">    new_dir_fd: fd_t,</span>
<span class="line" id="L2793">    new_path: [*:<span class="tok-number">0</span>]<span class="tok-kw">const</span> <span class="tok-type">u8</span>,</span>
<span class="line" id="L2794">) RenameError!<span class="tok-type">void</span> {</span>
<span class="line" id="L2795">    <span class="tok-kw">if</span> (builtin.os.tag == .windows) {</span>
<span class="line" id="L2796">        <span class="tok-kw">const</span> old_path_w = <span class="tok-kw">try</span> windows.cStrToPrefixedFileW(old_dir_fd, old_path);</span>
<span class="line" id="L2797">        <span class="tok-kw">const</span> new_path_w = <span class="tok-kw">try</span> windows.cStrToPrefixedFileW(new_dir_fd, new_path);</span>
<span class="line" id="L2798">        <span class="tok-kw">return</span> renameatW(old_dir_fd, old_path_w.span(), new_dir_fd, new_path_w.span(), windows.TRUE);</span>
<span class="line" id="L2799">    } <span class="tok-kw">else</span> <span class="tok-kw">if</span> (builtin.os.tag == .wasi <span class="tok-kw">and</span> !builtin.link_libc) {</span>
<span class="line" id="L2800">        <span class="tok-kw">return</span> renameat(old_dir_fd, mem.sliceTo(old_path, <span class="tok-number">0</span>), new_dir_fd, mem.sliceTo(new_path, <span class="tok-number">0</span>));</span>
<span class="line" id="L2801">    }</span>
<span class="line" id="L2802"></span>
<span class="line" id="L2803">    <span class="tok-kw">switch</span> (errno(system.renameat(old_dir_fd, old_path, new_dir_fd, new_path))) {</span>
<span class="line" id="L2804">        .SUCCESS =&gt; <span class="tok-kw">return</span>,</span>
<span class="line" id="L2805">        .ACCES =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.AccessDenied,</span>
<span class="line" id="L2806">        .PERM =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.AccessDenied,</span>
<span class="line" id="L2807">        .BUSY =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.FileBusy,</span>
<span class="line" id="L2808">        .DQUOT =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.DiskQuota,</span>
<span class="line" id="L2809">        .FAULT =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L2810">        .INVAL =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L2811">        .ISDIR =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.IsDir,</span>
<span class="line" id="L2812">        .LOOP =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.SymLinkLoop,</span>
<span class="line" id="L2813">        .MLINK =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.LinkQuotaExceeded,</span>
<span class="line" id="L2814">        .NAMETOOLONG =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.NameTooLong,</span>
<span class="line" id="L2815">        .NOENT =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.FileNotFound,</span>
<span class="line" id="L2816">        .NOTDIR =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.NotDir,</span>
<span class="line" id="L2817">        .NOMEM =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.SystemResources,</span>
<span class="line" id="L2818">        .NOSPC =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.NoSpaceLeft,</span>
<span class="line" id="L2819">        .EXIST =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.PathAlreadyExists,</span>
<span class="line" id="L2820">        .NOTEMPTY =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.PathAlreadyExists,</span>
<span class="line" id="L2821">        .ROFS =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.ReadOnlyFileSystem,</span>
<span class="line" id="L2822">        .XDEV =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.RenameAcrossMountPoints,</span>
<span class="line" id="L2823">        .ILSEQ =&gt; |err| <span class="tok-kw">if</span> (builtin.os.tag == .wasi)</span>
<span class="line" id="L2824">            <span class="tok-kw">return</span> <span class="tok-kw">error</span>.InvalidUtf8</span>
<span class="line" id="L2825">        <span class="tok-kw">else</span></span>
<span class="line" id="L2826">            <span class="tok-kw">return</span> unexpectedErrno(err),</span>
<span class="line" id="L2827">        <span class="tok-kw">else</span> =&gt; |err| <span class="tok-kw">return</span> unexpectedErrno(err),</span>
<span class="line" id="L2828">    }</span>
<span class="line" id="L2829">}</span>
<span class="line" id="L2830"></span>
<span class="line" id="L2831"><span class="tok-comment">/// Same as `renameat` but Windows-only and the path parameters are</span></span>
<span class="line" id="L2832"><span class="tok-comment">/// [WTF-16](https://simonsapin.github.io/wtf-8/#potentially-ill-formed-utf-16) encoded.</span></span>
<span class="line" id="L2833"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">renameatW</span>(</span>
<span class="line" id="L2834">    old_dir_fd: fd_t,</span>
<span class="line" id="L2835">    old_path_w: []<span class="tok-kw">const</span> <span class="tok-type">u16</span>,</span>
<span class="line" id="L2836">    new_dir_fd: fd_t,</span>
<span class="line" id="L2837">    new_path_w: []<span class="tok-kw">const</span> <span class="tok-type">u16</span>,</span>
<span class="line" id="L2838">    ReplaceIfExists: windows.BOOLEAN,</span>
<span class="line" id="L2839">) RenameError!<span class="tok-type">void</span> {</span>
<span class="line" id="L2840">    <span class="tok-kw">const</span> src_fd = windows.OpenFile(old_path_w, .{</span>
<span class="line" id="L2841">        .dir = old_dir_fd,</span>
<span class="line" id="L2842">        .access_mask = windows.SYNCHRONIZE | windows.GENERIC_WRITE | windows.DELETE,</span>
<span class="line" id="L2843">        .creation = windows.FILE_OPEN,</span>
<span class="line" id="L2844">        .filter = .any, <span class="tok-comment">// This function is supposed to rename both files and directories.</span>
</span>
<span class="line" id="L2845">        .follow_symlinks = <span class="tok-null">false</span>,</span>
<span class="line" id="L2846">    }) <span class="tok-kw">catch</span> |err| <span class="tok-kw">switch</span> (err) {</span>
<span class="line" id="L2847">        <span class="tok-kw">error</span>.WouldBlock =&gt; <span class="tok-kw">unreachable</span>, <span class="tok-comment">// Not possible without `.share_access_nonblocking = true`.</span>
</span>
<span class="line" id="L2848">        <span class="tok-kw">else</span> =&gt; |e| <span class="tok-kw">return</span> e,</span>
<span class="line" id="L2849">    };</span>
<span class="line" id="L2850">    <span class="tok-kw">defer</span> windows.CloseHandle(src_fd);</span>
<span class="line" id="L2851"></span>
<span class="line" id="L2852">    <span class="tok-kw">var</span> need_fallback = <span class="tok-null">true</span>;</span>
<span class="line" id="L2853">    <span class="tok-kw">var</span> rc: windows.NTSTATUS = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L2854">    <span class="tok-comment">// FILE_RENAME_INFORMATION_EX and FILE_RENAME_POSIX_SEMANTICS require &gt;= win10_rs1,</span>
</span>
<span class="line" id="L2855">    <span class="tok-comment">// but FILE_RENAME_IGNORE_READONLY_ATTRIBUTE requires &gt;= win10_rs5. We check &gt;= rs5 here</span>
</span>
<span class="line" id="L2856">    <span class="tok-comment">// so that we only use POSIX_SEMANTICS when we know IGNORE_READONLY_ATTRIBUTE will also be</span>
</span>
<span class="line" id="L2857">    <span class="tok-comment">// supported in order to avoid either (1) using a redundant call that we can know in advance will return</span>
</span>
<span class="line" id="L2858">    <span class="tok-comment">// STATUS_NOT_SUPPORTED or (2) only setting IGNORE_READONLY_ATTRIBUTE when &gt;= rs5</span>
</span>
<span class="line" id="L2859">    <span class="tok-comment">// and therefore having different behavior when the Windows version is &gt;= rs1 but &lt; rs5.</span>
</span>
<span class="line" id="L2860">    <span class="tok-kw">if</span> (builtin.target.os.isAtLeast(.windows, .win10_rs5) <span class="tok-kw">orelse</span> <span class="tok-null">false</span>) {</span>
<span class="line" id="L2861">        <span class="tok-kw">const</span> struct_buf_len = <span class="tok-builtin">@sizeOf</span>(windows.FILE_RENAME_INFORMATION_EX) + (MAX_PATH_BYTES - <span class="tok-number">1</span>);</span>
<span class="line" id="L2862">        <span class="tok-kw">var</span> rename_info_buf: [struct_buf_len]<span class="tok-type">u8</span> <span class="tok-kw">align</span>(<span class="tok-builtin">@alignOf</span>(windows.FILE_RENAME_INFORMATION_EX)) = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L2863">        <span class="tok-kw">const</span> struct_len = <span class="tok-builtin">@sizeOf</span>(windows.FILE_RENAME_INFORMATION_EX) - <span class="tok-number">1</span> + new_path_w.len * <span class="tok-number">2</span>;</span>
<span class="line" id="L2864">        <span class="tok-kw">if</span> (struct_len &gt; struct_buf_len) <span class="tok-kw">return</span> <span class="tok-kw">error</span>.NameTooLong;</span>
<span class="line" id="L2865"></span>
<span class="line" id="L2866">        <span class="tok-kw">const</span> rename_info: *windows.FILE_RENAME_INFORMATION_EX = <span class="tok-builtin">@ptrCast</span>(&amp;rename_info_buf);</span>
<span class="line" id="L2867">        <span class="tok-kw">var</span> io_status_block: windows.IO_STATUS_BLOCK = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L2868"></span>
<span class="line" id="L2869">        <span class="tok-kw">var</span> flags: windows.ULONG = windows.FILE_RENAME_POSIX_SEMANTICS | windows.FILE_RENAME_IGNORE_READONLY_ATTRIBUTE;</span>
<span class="line" id="L2870">        <span class="tok-kw">if</span> (ReplaceIfExists == windows.TRUE) flags |= windows.FILE_RENAME_REPLACE_IF_EXISTS;</span>
<span class="line" id="L2871">        rename_info.* = .{</span>
<span class="line" id="L2872">            .Flags = flags,</span>
<span class="line" id="L2873">            .RootDirectory = <span class="tok-kw">if</span> (std.fs.path.isAbsoluteWindowsWTF16(new_path_w)) <span class="tok-null">null</span> <span class="tok-kw">else</span> new_dir_fd,</span>
<span class="line" id="L2874">            .FileNameLength = <span class="tok-builtin">@intCast</span>(new_path_w.len * <span class="tok-number">2</span>), <span class="tok-comment">// already checked error.NameTooLong</span>
</span>
<span class="line" id="L2875">            .FileName = <span class="tok-null">undefined</span>,</span>
<span class="line" id="L2876">        };</span>
<span class="line" id="L2877">        <span class="tok-builtin">@memcpy</span>((&amp;rename_info.FileName).ptr, new_path_w);</span>
<span class="line" id="L2878">        rc = windows.ntdll.NtSetInformationFile(</span>
<span class="line" id="L2879">            src_fd,</span>
<span class="line" id="L2880">            &amp;io_status_block,</span>
<span class="line" id="L2881">            rename_info,</span>
<span class="line" id="L2882">            <span class="tok-builtin">@intCast</span>(struct_len), <span class="tok-comment">// already checked for error.NameTooLong</span>
</span>
<span class="line" id="L2883">            .FileRenameInformationEx,</span>
<span class="line" id="L2884">        );</span>
<span class="line" id="L2885">        <span class="tok-kw">switch</span> (rc) {</span>
<span class="line" id="L2886">            .SUCCESS =&gt; <span class="tok-kw">return</span>,</span>
<span class="line" id="L2887">            <span class="tok-comment">// INVALID_PARAMETER here means that the filesystem does not support FileRenameInformationEx</span>
</span>
<span class="line" id="L2888">            .INVALID_PARAMETER =&gt; {},</span>
<span class="line" id="L2889">            .DIRECTORY_NOT_EMPTY =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.PathAlreadyExists,</span>
<span class="line" id="L2890">            .FILE_IS_A_DIRECTORY =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.IsDir,</span>
<span class="line" id="L2891">            .NOT_A_DIRECTORY =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.NotDir,</span>
<span class="line" id="L2892">            <span class="tok-comment">// For all other statuses, fall down to the switch below to handle them.</span>
</span>
<span class="line" id="L2893">            <span class="tok-kw">else</span> =&gt; need_fallback = <span class="tok-null">false</span>,</span>
<span class="line" id="L2894">        }</span>
<span class="line" id="L2895">    }</span>
<span class="line" id="L2896"></span>
<span class="line" id="L2897">    <span class="tok-kw">if</span> (need_fallback) {</span>
<span class="line" id="L2898">        <span class="tok-kw">const</span> struct_buf_len = <span class="tok-builtin">@sizeOf</span>(windows.FILE_RENAME_INFORMATION) + (MAX_PATH_BYTES - <span class="tok-number">1</span>);</span>
<span class="line" id="L2899">        <span class="tok-kw">var</span> rename_info_buf: [struct_buf_len]<span class="tok-type">u8</span> <span class="tok-kw">align</span>(<span class="tok-builtin">@alignOf</span>(windows.FILE_RENAME_INFORMATION)) = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L2900">        <span class="tok-kw">const</span> struct_len = <span class="tok-builtin">@sizeOf</span>(windows.FILE_RENAME_INFORMATION) - <span class="tok-number">1</span> + new_path_w.len * <span class="tok-number">2</span>;</span>
<span class="line" id="L2901">        <span class="tok-kw">if</span> (struct_len &gt; struct_buf_len) <span class="tok-kw">return</span> <span class="tok-kw">error</span>.NameTooLong;</span>
<span class="line" id="L2902"></span>
<span class="line" id="L2903">        <span class="tok-kw">const</span> rename_info: *windows.FILE_RENAME_INFORMATION = <span class="tok-builtin">@ptrCast</span>(&amp;rename_info_buf);</span>
<span class="line" id="L2904">        <span class="tok-kw">var</span> io_status_block: windows.IO_STATUS_BLOCK = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L2905"></span>
<span class="line" id="L2906">        rename_info.* = .{</span>
<span class="line" id="L2907">            .Flags = ReplaceIfExists,</span>
<span class="line" id="L2908">            .RootDirectory = <span class="tok-kw">if</span> (std.fs.path.isAbsoluteWindowsWTF16(new_path_w)) <span class="tok-null">null</span> <span class="tok-kw">else</span> new_dir_fd,</span>
<span class="line" id="L2909">            .FileNameLength = <span class="tok-builtin">@intCast</span>(new_path_w.len * <span class="tok-number">2</span>), <span class="tok-comment">// already checked error.NameTooLong</span>
</span>
<span class="line" id="L2910">            .FileName = <span class="tok-null">undefined</span>,</span>
<span class="line" id="L2911">        };</span>
<span class="line" id="L2912">        <span class="tok-builtin">@memcpy</span>((&amp;rename_info.FileName).ptr, new_path_w);</span>
<span class="line" id="L2913"></span>
<span class="line" id="L2914">        rc =</span>
<span class="line" id="L2915">            windows.ntdll.NtSetInformationFile(</span>
<span class="line" id="L2916">            src_fd,</span>
<span class="line" id="L2917">            &amp;io_status_block,</span>
<span class="line" id="L2918">            rename_info,</span>
<span class="line" id="L2919">            <span class="tok-builtin">@intCast</span>(struct_len), <span class="tok-comment">// already checked for error.NameTooLong</span>
</span>
<span class="line" id="L2920">            .FileRenameInformation,</span>
<span class="line" id="L2921">        );</span>
<span class="line" id="L2922">    }</span>
<span class="line" id="L2923"></span>
<span class="line" id="L2924">    <span class="tok-kw">switch</span> (rc) {</span>
<span class="line" id="L2925">        .SUCCESS =&gt; {},</span>
<span class="line" id="L2926">        .INVALID_HANDLE =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L2927">        .INVALID_PARAMETER =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L2928">        .OBJECT_PATH_SYNTAX_BAD =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L2929">        .ACCESS_DENIED =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.AccessDenied,</span>
<span class="line" id="L2930">        .OBJECT_NAME_NOT_FOUND =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.FileNotFound,</span>
<span class="line" id="L2931">        .OBJECT_PATH_NOT_FOUND =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.FileNotFound,</span>
<span class="line" id="L2932">        .NOT_SAME_DEVICE =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.RenameAcrossMountPoints,</span>
<span class="line" id="L2933">        .OBJECT_NAME_COLLISION =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.PathAlreadyExists,</span>
<span class="line" id="L2934">        <span class="tok-kw">else</span> =&gt; <span class="tok-kw">return</span> windows.unexpectedStatus(rc),</span>
<span class="line" id="L2935">    }</span>
<span class="line" id="L2936">}</span>
<span class="line" id="L2937"></span>
<span class="line" id="L2938"><span class="tok-comment">/// On Windows, `sub_dir_path` should be encoded as [WTF-8](https://simonsapin.github.io/wtf-8/).</span></span>
<span class="line" id="L2939"><span class="tok-comment">/// On WASI, `sub_dir_path` should be encoded as valid UTF-8.</span></span>
<span class="line" id="L2940"><span class="tok-comment">/// On other platforms, `sub_dir_path` is an opaque sequence of bytes with no particular encoding.</span></span>
<span class="line" id="L2941"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">mkdirat</span>(dir_fd: fd_t, sub_dir_path: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>, mode: <span class="tok-type">u32</span>) MakeDirError!<span class="tok-type">void</span> {</span>
<span class="line" id="L2942">    <span class="tok-kw">if</span> (builtin.os.tag == .windows) {</span>
<span class="line" id="L2943">        <span class="tok-kw">const</span> sub_dir_path_w = <span class="tok-kw">try</span> windows.sliceToPrefixedFileW(dir_fd, sub_dir_path);</span>
<span class="line" id="L2944">        <span class="tok-kw">return</span> mkdiratW(dir_fd, sub_dir_path_w.span(), mode);</span>
<span class="line" id="L2945">    } <span class="tok-kw">else</span> <span class="tok-kw">if</span> (builtin.os.tag == .wasi <span class="tok-kw">and</span> !builtin.link_libc) {</span>
<span class="line" id="L2946">        <span class="tok-kw">return</span> mkdiratWasi(dir_fd, sub_dir_path, mode);</span>
<span class="line" id="L2947">    } <span class="tok-kw">else</span> {</span>
<span class="line" id="L2948">        <span class="tok-kw">const</span> sub_dir_path_c = <span class="tok-kw">try</span> toPosixPath(sub_dir_path);</span>
<span class="line" id="L2949">        <span class="tok-kw">return</span> mkdiratZ(dir_fd, &amp;sub_dir_path_c, mode);</span>
<span class="line" id="L2950">    }</span>
<span class="line" id="L2951">}</span>
<span class="line" id="L2952"></span>
<span class="line" id="L2953"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">mkdiratWasi</span>(dir_fd: fd_t, sub_dir_path: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>, mode: <span class="tok-type">u32</span>) MakeDirError!<span class="tok-type">void</span> {</span>
<span class="line" id="L2954">    _ = mode;</span>
<span class="line" id="L2955">    <span class="tok-kw">switch</span> (wasi.path_create_directory(dir_fd, sub_dir_path.ptr, sub_dir_path.len)) {</span>
<span class="line" id="L2956">        .SUCCESS =&gt; <span class="tok-kw">return</span>,</span>
<span class="line" id="L2957">        .ACCES =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.AccessDenied,</span>
<span class="line" id="L2958">        .BADF =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L2959">        .PERM =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.AccessDenied,</span>
<span class="line" id="L2960">        .DQUOT =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.DiskQuota,</span>
<span class="line" id="L2961">        .EXIST =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.PathAlreadyExists,</span>
<span class="line" id="L2962">        .FAULT =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L2963">        .LOOP =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.SymLinkLoop,</span>
<span class="line" id="L2964">        .MLINK =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.LinkQuotaExceeded,</span>
<span class="line" id="L2965">        .NAMETOOLONG =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.NameTooLong,</span>
<span class="line" id="L2966">        .NOENT =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.FileNotFound,</span>
<span class="line" id="L2967">        .NOMEM =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.SystemResources,</span>
<span class="line" id="L2968">        .NOSPC =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.NoSpaceLeft,</span>
<span class="line" id="L2969">        .NOTDIR =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.NotDir,</span>
<span class="line" id="L2970">        .ROFS =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.ReadOnlyFileSystem,</span>
<span class="line" id="L2971">        .NOTCAPABLE =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.AccessDenied,</span>
<span class="line" id="L2972">        .ILSEQ =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.InvalidUtf8,</span>
<span class="line" id="L2973">        <span class="tok-kw">else</span> =&gt; |err| <span class="tok-kw">return</span> unexpectedErrno(err),</span>
<span class="line" id="L2974">    }</span>
<span class="line" id="L2975">}</span>
<span class="line" id="L2976"></span>
<span class="line" id="L2977"><span class="tok-comment">/// Same as `mkdirat` except the parameters are null-terminated.</span></span>
<span class="line" id="L2978"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">mkdiratZ</span>(dir_fd: fd_t, sub_dir_path: [*:<span class="tok-number">0</span>]<span class="tok-kw">const</span> <span class="tok-type">u8</span>, mode: <span class="tok-type">u32</span>) MakeDirError!<span class="tok-type">void</span> {</span>
<span class="line" id="L2979">    <span class="tok-kw">if</span> (builtin.os.tag == .windows) {</span>
<span class="line" id="L2980">        <span class="tok-kw">const</span> sub_dir_path_w = <span class="tok-kw">try</span> windows.cStrToPrefixedFileW(dir_fd, sub_dir_path);</span>
<span class="line" id="L2981">        <span class="tok-kw">return</span> mkdiratW(dir_fd, sub_dir_path_w.span(), mode);</span>
<span class="line" id="L2982">    } <span class="tok-kw">else</span> <span class="tok-kw">if</span> (builtin.os.tag == .wasi <span class="tok-kw">and</span> !builtin.link_libc) {</span>
<span class="line" id="L2983">        <span class="tok-kw">return</span> mkdirat(dir_fd, mem.sliceTo(sub_dir_path, <span class="tok-number">0</span>), mode);</span>
<span class="line" id="L2984">    }</span>
<span class="line" id="L2985">    <span class="tok-kw">switch</span> (errno(system.mkdirat(dir_fd, sub_dir_path, mode))) {</span>
<span class="line" id="L2986">        .SUCCESS =&gt; <span class="tok-kw">return</span>,</span>
<span class="line" id="L2987">        .ACCES =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.AccessDenied,</span>
<span class="line" id="L2988">        .BADF =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L2989">        .PERM =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.AccessDenied,</span>
<span class="line" id="L2990">        .DQUOT =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.DiskQuota,</span>
<span class="line" id="L2991">        .EXIST =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.PathAlreadyExists,</span>
<span class="line" id="L2992">        .FAULT =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L2993">        .LOOP =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.SymLinkLoop,</span>
<span class="line" id="L2994">        .MLINK =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.LinkQuotaExceeded,</span>
<span class="line" id="L2995">        .NAMETOOLONG =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.NameTooLong,</span>
<span class="line" id="L2996">        .NOENT =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.FileNotFound,</span>
<span class="line" id="L2997">        .NOMEM =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.SystemResources,</span>
<span class="line" id="L2998">        .NOSPC =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.NoSpaceLeft,</span>
<span class="line" id="L2999">        .NOTDIR =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.NotDir,</span>
<span class="line" id="L3000">        .ROFS =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.ReadOnlyFileSystem,</span>
<span class="line" id="L3001">        <span class="tok-comment">// dragonfly: when dir_fd is unlinked from filesystem</span>
</span>
<span class="line" id="L3002">        .NOTCONN =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.FileNotFound,</span>
<span class="line" id="L3003">        .ILSEQ =&gt; |err| <span class="tok-kw">if</span> (builtin.os.tag == .wasi)</span>
<span class="line" id="L3004">            <span class="tok-kw">return</span> <span class="tok-kw">error</span>.InvalidUtf8</span>
<span class="line" id="L3005">        <span class="tok-kw">else</span></span>
<span class="line" id="L3006">            <span class="tok-kw">return</span> unexpectedErrno(err),</span>
<span class="line" id="L3007">        <span class="tok-kw">else</span> =&gt; |err| <span class="tok-kw">return</span> unexpectedErrno(err),</span>
<span class="line" id="L3008">    }</span>
<span class="line" id="L3009">}</span>
<span class="line" id="L3010"></span>
<span class="line" id="L3011"><span class="tok-comment">/// Windows-only. Same as `mkdirat` except the parameter WTF16 LE encoded.</span></span>
<span class="line" id="L3012"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">mkdiratW</span>(dir_fd: fd_t, sub_path_w: []<span class="tok-kw">const</span> <span class="tok-type">u16</span>, mode: <span class="tok-type">u32</span>) MakeDirError!<span class="tok-type">void</span> {</span>
<span class="line" id="L3013">    _ = mode;</span>
<span class="line" id="L3014">    <span class="tok-kw">const</span> sub_dir_handle = windows.OpenFile(sub_path_w, .{</span>
<span class="line" id="L3015">        .dir = dir_fd,</span>
<span class="line" id="L3016">        .access_mask = windows.GENERIC_READ | windows.SYNCHRONIZE,</span>
<span class="line" id="L3017">        .creation = windows.FILE_CREATE,</span>
<span class="line" id="L3018">        .filter = .dir_only,</span>
<span class="line" id="L3019">    }) <span class="tok-kw">catch</span> |err| <span class="tok-kw">switch</span> (err) {</span>
<span class="line" id="L3020">        <span class="tok-kw">error</span>.IsDir =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.Unexpected,</span>
<span class="line" id="L3021">        <span class="tok-kw">error</span>.PipeBusy =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.Unexpected,</span>
<span class="line" id="L3022">        <span class="tok-kw">error</span>.WouldBlock =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.Unexpected,</span>
<span class="line" id="L3023">        <span class="tok-kw">error</span>.AntivirusInterference =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.Unexpected,</span>
<span class="line" id="L3024">        <span class="tok-kw">else</span> =&gt; |e| <span class="tok-kw">return</span> e,</span>
<span class="line" id="L3025">    };</span>
<span class="line" id="L3026">    windows.CloseHandle(sub_dir_handle);</span>
<span class="line" id="L3027">}</span>
<span class="line" id="L3028"></span>
<span class="line" id="L3029"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> MakeDirError = <span class="tok-kw">error</span>{</span>
<span class="line" id="L3030">    <span class="tok-comment">/// In WASI, this error may occur when the file descriptor does</span></span>
<span class="line" id="L3031">    <span class="tok-comment">/// not hold the required rights to create a new directory relative to it.</span></span>
<span class="line" id="L3032">    AccessDenied,</span>
<span class="line" id="L3033">    DiskQuota,</span>
<span class="line" id="L3034">    PathAlreadyExists,</span>
<span class="line" id="L3035">    SymLinkLoop,</span>
<span class="line" id="L3036">    LinkQuotaExceeded,</span>
<span class="line" id="L3037">    NameTooLong,</span>
<span class="line" id="L3038">    FileNotFound,</span>
<span class="line" id="L3039">    SystemResources,</span>
<span class="line" id="L3040">    NoSpaceLeft,</span>
<span class="line" id="L3041">    NotDir,</span>
<span class="line" id="L3042">    ReadOnlyFileSystem,</span>
<span class="line" id="L3043">    <span class="tok-comment">/// WASI-only; file paths must be valid UTF-8.</span></span>
<span class="line" id="L3044">    InvalidUtf8,</span>
<span class="line" id="L3045">    <span class="tok-comment">/// Windows-only; file paths provided by the user must be valid WTF-8.</span></span>
<span class="line" id="L3046">    <span class="tok-comment">/// https://simonsapin.github.io/wtf-8/</span></span>
<span class="line" id="L3047">    InvalidWtf8,</span>
<span class="line" id="L3048">    BadPathName,</span>
<span class="line" id="L3049">    NoDevice,</span>
<span class="line" id="L3050">    <span class="tok-comment">/// On Windows, `\\server` or `\\server\share` was not found.</span></span>
<span class="line" id="L3051">    NetworkNotFound,</span>
<span class="line" id="L3052">} || UnexpectedError;</span>
<span class="line" id="L3053"></span>
<span class="line" id="L3054"><span class="tok-comment">/// Create a directory.</span></span>
<span class="line" id="L3055"><span class="tok-comment">/// `mode` is ignored on Windows and WASI.</span></span>
<span class="line" id="L3056"><span class="tok-comment">/// On Windows, `dir_path` should be encoded as [WTF-8](https://simonsapin.github.io/wtf-8/).</span></span>
<span class="line" id="L3057"><span class="tok-comment">/// On WASI, `dir_path` should be encoded as valid UTF-8.</span></span>
<span class="line" id="L3058"><span class="tok-comment">/// On other platforms, `dir_path` is an opaque sequence of bytes with no particular encoding.</span></span>
<span class="line" id="L3059"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">mkdir</span>(dir_path: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>, mode: <span class="tok-type">u32</span>) MakeDirError!<span class="tok-type">void</span> {</span>
<span class="line" id="L3060">    <span class="tok-kw">if</span> (builtin.os.tag == .wasi <span class="tok-kw">and</span> !builtin.link_libc) {</span>
<span class="line" id="L3061">        <span class="tok-kw">return</span> mkdirat(wasi.AT.FDCWD, dir_path, mode);</span>
<span class="line" id="L3062">    } <span class="tok-kw">else</span> <span class="tok-kw">if</span> (builtin.os.tag == .windows) {</span>
<span class="line" id="L3063">        <span class="tok-kw">const</span> dir_path_w = <span class="tok-kw">try</span> windows.sliceToPrefixedFileW(<span class="tok-null">null</span>, dir_path);</span>
<span class="line" id="L3064">        <span class="tok-kw">return</span> mkdirW(dir_path_w.span(), mode);</span>
<span class="line" id="L3065">    } <span class="tok-kw">else</span> {</span>
<span class="line" id="L3066">        <span class="tok-kw">const</span> dir_path_c = <span class="tok-kw">try</span> toPosixPath(dir_path);</span>
<span class="line" id="L3067">        <span class="tok-kw">return</span> mkdirZ(&amp;dir_path_c, mode);</span>
<span class="line" id="L3068">    }</span>
<span class="line" id="L3069">}</span>
<span class="line" id="L3070"></span>
<span class="line" id="L3071"><span class="tok-comment">/// Same as `mkdir` but the parameter is null-terminated.</span></span>
<span class="line" id="L3072"><span class="tok-comment">/// On Windows, `dir_path` should be encoded as [WTF-8](https://simonsapin.github.io/wtf-8/).</span></span>
<span class="line" id="L3073"><span class="tok-comment">/// On WASI, `dir_path` should be encoded as valid UTF-8.</span></span>
<span class="line" id="L3074"><span class="tok-comment">/// On other platforms, `dir_path` is an opaque sequence of bytes with no particular encoding.</span></span>
<span class="line" id="L3075"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">mkdirZ</span>(dir_path: [*:<span class="tok-number">0</span>]<span class="tok-kw">const</span> <span class="tok-type">u8</span>, mode: <span class="tok-type">u32</span>) MakeDirError!<span class="tok-type">void</span> {</span>
<span class="line" id="L3076">    <span class="tok-kw">if</span> (builtin.os.tag == .windows) {</span>
<span class="line" id="L3077">        <span class="tok-kw">const</span> dir_path_w = <span class="tok-kw">try</span> windows.cStrToPrefixedFileW(<span class="tok-null">null</span>, dir_path);</span>
<span class="line" id="L3078">        <span class="tok-kw">return</span> mkdirW(dir_path_w.span(), mode);</span>
<span class="line" id="L3079">    } <span class="tok-kw">else</span> <span class="tok-kw">if</span> (builtin.os.tag == .wasi <span class="tok-kw">and</span> !builtin.link_libc) {</span>
<span class="line" id="L3080">        <span class="tok-kw">return</span> mkdir(mem.sliceTo(dir_path, <span class="tok-number">0</span>), mode);</span>
<span class="line" id="L3081">    }</span>
<span class="line" id="L3082">    <span class="tok-kw">switch</span> (errno(system.mkdir(dir_path, mode))) {</span>
<span class="line" id="L3083">        .SUCCESS =&gt; <span class="tok-kw">return</span>,</span>
<span class="line" id="L3084">        .ACCES =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.AccessDenied,</span>
<span class="line" id="L3085">        .PERM =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.AccessDenied,</span>
<span class="line" id="L3086">        .DQUOT =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.DiskQuota,</span>
<span class="line" id="L3087">        .EXIST =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.PathAlreadyExists,</span>
<span class="line" id="L3088">        .FAULT =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L3089">        .LOOP =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.SymLinkLoop,</span>
<span class="line" id="L3090">        .MLINK =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.LinkQuotaExceeded,</span>
<span class="line" id="L3091">        .NAMETOOLONG =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.NameTooLong,</span>
<span class="line" id="L3092">        .NOENT =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.FileNotFound,</span>
<span class="line" id="L3093">        .NOMEM =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.SystemResources,</span>
<span class="line" id="L3094">        .NOSPC =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.NoSpaceLeft,</span>
<span class="line" id="L3095">        .NOTDIR =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.NotDir,</span>
<span class="line" id="L3096">        .ROFS =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.ReadOnlyFileSystem,</span>
<span class="line" id="L3097">        .ILSEQ =&gt; |err| <span class="tok-kw">if</span> (builtin.os.tag == .wasi)</span>
<span class="line" id="L3098">            <span class="tok-kw">return</span> <span class="tok-kw">error</span>.InvalidUtf8</span>
<span class="line" id="L3099">        <span class="tok-kw">else</span></span>
<span class="line" id="L3100">            <span class="tok-kw">return</span> unexpectedErrno(err),</span>
<span class="line" id="L3101">        <span class="tok-kw">else</span> =&gt; |err| <span class="tok-kw">return</span> unexpectedErrno(err),</span>
<span class="line" id="L3102">    }</span>
<span class="line" id="L3103">}</span>
<span class="line" id="L3104"></span>
<span class="line" id="L3105"><span class="tok-comment">/// Windows-only. Same as `mkdir` but the parameters is WTF16LE encoded.</span></span>
<span class="line" id="L3106"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">mkdirW</span>(dir_path_w: []<span class="tok-kw">const</span> <span class="tok-type">u16</span>, mode: <span class="tok-type">u32</span>) MakeDirError!<span class="tok-type">void</span> {</span>
<span class="line" id="L3107">    _ = mode;</span>
<span class="line" id="L3108">    <span class="tok-kw">const</span> sub_dir_handle = windows.OpenFile(dir_path_w, .{</span>
<span class="line" id="L3109">        .dir = std.fs.cwd().fd,</span>
<span class="line" id="L3110">        .access_mask = windows.GENERIC_READ | windows.SYNCHRONIZE,</span>
<span class="line" id="L3111">        .creation = windows.FILE_CREATE,</span>
<span class="line" id="L3112">        .filter = .dir_only,</span>
<span class="line" id="L3113">    }) <span class="tok-kw">catch</span> |err| <span class="tok-kw">switch</span> (err) {</span>
<span class="line" id="L3114">        <span class="tok-kw">error</span>.IsDir =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.Unexpected,</span>
<span class="line" id="L3115">        <span class="tok-kw">error</span>.PipeBusy =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.Unexpected,</span>
<span class="line" id="L3116">        <span class="tok-kw">error</span>.WouldBlock =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.Unexpected,</span>
<span class="line" id="L3117">        <span class="tok-kw">error</span>.AntivirusInterference =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.Unexpected,</span>
<span class="line" id="L3118">        <span class="tok-kw">else</span> =&gt; |e| <span class="tok-kw">return</span> e,</span>
<span class="line" id="L3119">    };</span>
<span class="line" id="L3120">    windows.CloseHandle(sub_dir_handle);</span>
<span class="line" id="L3121">}</span>
<span class="line" id="L3122"></span>
<span class="line" id="L3123"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> DeleteDirError = <span class="tok-kw">error</span>{</span>
<span class="line" id="L3124">    AccessDenied,</span>
<span class="line" id="L3125">    FileBusy,</span>
<span class="line" id="L3126">    SymLinkLoop,</span>
<span class="line" id="L3127">    NameTooLong,</span>
<span class="line" id="L3128">    FileNotFound,</span>
<span class="line" id="L3129">    SystemResources,</span>
<span class="line" id="L3130">    NotDir,</span>
<span class="line" id="L3131">    DirNotEmpty,</span>
<span class="line" id="L3132">    ReadOnlyFileSystem,</span>
<span class="line" id="L3133">    <span class="tok-comment">/// WASI-only; file paths must be valid UTF-8.</span></span>
<span class="line" id="L3134">    InvalidUtf8,</span>
<span class="line" id="L3135">    <span class="tok-comment">/// Windows-only; file paths provided by the user must be valid WTF-8.</span></span>
<span class="line" id="L3136">    <span class="tok-comment">/// https://simonsapin.github.io/wtf-8/</span></span>
<span class="line" id="L3137">    InvalidWtf8,</span>
<span class="line" id="L3138">    BadPathName,</span>
<span class="line" id="L3139">    <span class="tok-comment">/// On Windows, `\\server` or `\\server\share` was not found.</span></span>
<span class="line" id="L3140">    NetworkNotFound,</span>
<span class="line" id="L3141">} || UnexpectedError;</span>
<span class="line" id="L3142"></span>
<span class="line" id="L3143"><span class="tok-comment">/// Deletes an empty directory.</span></span>
<span class="line" id="L3144"><span class="tok-comment">/// On Windows, `dir_path` should be encoded as [WTF-8](https://simonsapin.github.io/wtf-8/).</span></span>
<span class="line" id="L3145"><span class="tok-comment">/// On WASI, `dir_path` should be encoded as valid UTF-8.</span></span>
<span class="line" id="L3146"><span class="tok-comment">/// On other platforms, `dir_path` is an opaque sequence of bytes with no particular encoding.</span></span>
<span class="line" id="L3147"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">rmdir</span>(dir_path: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>) DeleteDirError!<span class="tok-type">void</span> {</span>
<span class="line" id="L3148">    <span class="tok-kw">if</span> (builtin.os.tag == .wasi <span class="tok-kw">and</span> !builtin.link_libc) {</span>
<span class="line" id="L3149">        <span class="tok-kw">return</span> unlinkat(wasi.AT.FDCWD, dir_path, AT.REMOVEDIR) <span class="tok-kw">catch</span> |err| <span class="tok-kw">switch</span> (err) {</span>
<span class="line" id="L3150">            <span class="tok-kw">error</span>.FileSystem =&gt; <span class="tok-kw">unreachable</span>, <span class="tok-comment">// only occurs when targeting files</span>
</span>
<span class="line" id="L3151">            <span class="tok-kw">error</span>.IsDir =&gt; <span class="tok-kw">unreachable</span>, <span class="tok-comment">// only occurs when targeting files</span>
</span>
<span class="line" id="L3152">            <span class="tok-kw">else</span> =&gt; |e| <span class="tok-kw">return</span> e,</span>
<span class="line" id="L3153">        };</span>
<span class="line" id="L3154">    } <span class="tok-kw">else</span> <span class="tok-kw">if</span> (builtin.os.tag == .windows) {</span>
<span class="line" id="L3155">        <span class="tok-kw">const</span> dir_path_w = <span class="tok-kw">try</span> windows.sliceToPrefixedFileW(<span class="tok-null">null</span>, dir_path);</span>
<span class="line" id="L3156">        <span class="tok-kw">return</span> rmdirW(dir_path_w.span());</span>
<span class="line" id="L3157">    } <span class="tok-kw">else</span> {</span>
<span class="line" id="L3158">        <span class="tok-kw">const</span> dir_path_c = <span class="tok-kw">try</span> toPosixPath(dir_path);</span>
<span class="line" id="L3159">        <span class="tok-kw">return</span> rmdirZ(&amp;dir_path_c);</span>
<span class="line" id="L3160">    }</span>
<span class="line" id="L3161">}</span>
<span class="line" id="L3162"></span>
<span class="line" id="L3163"><span class="tok-comment">/// Same as `rmdir` except the parameter is null-terminated.</span></span>
<span class="line" id="L3164"><span class="tok-comment">/// On Windows, `dir_path` should be encoded as [WTF-8](https://simonsapin.github.io/wtf-8/).</span></span>
<span class="line" id="L3165"><span class="tok-comment">/// On WASI, `dir_path` should be encoded as valid UTF-8.</span></span>
<span class="line" id="L3166"><span class="tok-comment">/// On other platforms, `dir_path` is an opaque sequence of bytes with no particular encoding.</span></span>
<span class="line" id="L3167"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">rmdirZ</span>(dir_path: [*:<span class="tok-number">0</span>]<span class="tok-kw">const</span> <span class="tok-type">u8</span>) DeleteDirError!<span class="tok-type">void</span> {</span>
<span class="line" id="L3168">    <span class="tok-kw">if</span> (builtin.os.tag == .windows) {</span>
<span class="line" id="L3169">        <span class="tok-kw">const</span> dir_path_w = <span class="tok-kw">try</span> windows.cStrToPrefixedFileW(<span class="tok-null">null</span>, dir_path);</span>
<span class="line" id="L3170">        <span class="tok-kw">return</span> rmdirW(dir_path_w.span());</span>
<span class="line" id="L3171">    } <span class="tok-kw">else</span> <span class="tok-kw">if</span> (builtin.os.tag == .wasi <span class="tok-kw">and</span> !builtin.link_libc) {</span>
<span class="line" id="L3172">        <span class="tok-kw">return</span> rmdir(mem.sliceTo(dir_path, <span class="tok-number">0</span>));</span>
<span class="line" id="L3173">    }</span>
<span class="line" id="L3174">    <span class="tok-kw">switch</span> (errno(system.rmdir(dir_path))) {</span>
<span class="line" id="L3175">        .SUCCESS =&gt; <span class="tok-kw">return</span>,</span>
<span class="line" id="L3176">        .ACCES =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.AccessDenied,</span>
<span class="line" id="L3177">        .PERM =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.AccessDenied,</span>
<span class="line" id="L3178">        .BUSY =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.FileBusy,</span>
<span class="line" id="L3179">        .FAULT =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L3180">        .INVAL =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.BadPathName,</span>
<span class="line" id="L3181">        .LOOP =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.SymLinkLoop,</span>
<span class="line" id="L3182">        .NAMETOOLONG =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.NameTooLong,</span>
<span class="line" id="L3183">        .NOENT =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.FileNotFound,</span>
<span class="line" id="L3184">        .NOMEM =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.SystemResources,</span>
<span class="line" id="L3185">        .NOTDIR =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.NotDir,</span>
<span class="line" id="L3186">        .EXIST =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.DirNotEmpty,</span>
<span class="line" id="L3187">        .NOTEMPTY =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.DirNotEmpty,</span>
<span class="line" id="L3188">        .ROFS =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.ReadOnlyFileSystem,</span>
<span class="line" id="L3189">        .ILSEQ =&gt; |err| <span class="tok-kw">if</span> (builtin.os.tag == .wasi)</span>
<span class="line" id="L3190">            <span class="tok-kw">return</span> <span class="tok-kw">error</span>.InvalidUtf8</span>
<span class="line" id="L3191">        <span class="tok-kw">else</span></span>
<span class="line" id="L3192">            <span class="tok-kw">return</span> unexpectedErrno(err),</span>
<span class="line" id="L3193">        <span class="tok-kw">else</span> =&gt; |err| <span class="tok-kw">return</span> unexpectedErrno(err),</span>
<span class="line" id="L3194">    }</span>
<span class="line" id="L3195">}</span>
<span class="line" id="L3196"></span>
<span class="line" id="L3197"><span class="tok-comment">/// Windows-only. Same as `rmdir` except the parameter is WTF-16 LE encoded.</span></span>
<span class="line" id="L3198"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">rmdirW</span>(dir_path_w: []<span class="tok-kw">const</span> <span class="tok-type">u16</span>) DeleteDirError!<span class="tok-type">void</span> {</span>
<span class="line" id="L3199">    <span class="tok-kw">return</span> windows.DeleteFile(dir_path_w, .{ .dir = std.fs.cwd().fd, .remove_dir = <span class="tok-null">true</span> }) <span class="tok-kw">catch</span> |err| <span class="tok-kw">switch</span> (err) {</span>
<span class="line" id="L3200">        <span class="tok-kw">error</span>.IsDir =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L3201">        <span class="tok-kw">else</span> =&gt; |e| <span class="tok-kw">return</span> e,</span>
<span class="line" id="L3202">    };</span>
<span class="line" id="L3203">}</span>
<span class="line" id="L3204"></span>
<span class="line" id="L3205"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> ChangeCurDirError = <span class="tok-kw">error</span>{</span>
<span class="line" id="L3206">    AccessDenied,</span>
<span class="line" id="L3207">    FileSystem,</span>
<span class="line" id="L3208">    SymLinkLoop,</span>
<span class="line" id="L3209">    NameTooLong,</span>
<span class="line" id="L3210">    FileNotFound,</span>
<span class="line" id="L3211">    SystemResources,</span>
<span class="line" id="L3212">    NotDir,</span>
<span class="line" id="L3213">    BadPathName,</span>
<span class="line" id="L3214">    <span class="tok-comment">/// WASI-only; file paths must be valid UTF-8.</span></span>
<span class="line" id="L3215">    InvalidUtf8,</span>
<span class="line" id="L3216">    <span class="tok-comment">/// Windows-only; file paths provided by the user must be valid WTF-8.</span></span>
<span class="line" id="L3217">    <span class="tok-comment">/// https://simonsapin.github.io/wtf-8/</span></span>
<span class="line" id="L3218">    InvalidWtf8,</span>
<span class="line" id="L3219">} || UnexpectedError;</span>
<span class="line" id="L3220"></span>
<span class="line" id="L3221"><span class="tok-comment">/// Changes the current working directory of the calling process.</span></span>
<span class="line" id="L3222"><span class="tok-comment">/// On Windows, `dir_path` should be encoded as [WTF-8](https://simonsapin.github.io/wtf-8/).</span></span>
<span class="line" id="L3223"><span class="tok-comment">/// On WASI, `dir_path` should be encoded as valid UTF-8.</span></span>
<span class="line" id="L3224"><span class="tok-comment">/// On other platforms, `dir_path` is an opaque sequence of bytes with no particular encoding.</span></span>
<span class="line" id="L3225"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">chdir</span>(dir_path: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>) ChangeCurDirError!<span class="tok-type">void</span> {</span>
<span class="line" id="L3226">    <span class="tok-kw">if</span> (builtin.os.tag == .wasi <span class="tok-kw">and</span> !builtin.link_libc) {</span>
<span class="line" id="L3227">        <span class="tok-builtin">@compileError</span>(<span class="tok-str">&quot;WASI does not support os.chdir&quot;</span>);</span>
<span class="line" id="L3228">    } <span class="tok-kw">else</span> <span class="tok-kw">if</span> (builtin.os.tag == .windows) {</span>
<span class="line" id="L3229">        <span class="tok-kw">var</span> wtf16_dir_path: [windows.PATH_MAX_WIDE]<span class="tok-type">u16</span> = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L3230">        <span class="tok-kw">const</span> len = <span class="tok-kw">try</span> std.unicode.wtf8ToWtf16Le(wtf16_dir_path[<span class="tok-number">0</span>..], dir_path);</span>
<span class="line" id="L3231">        <span class="tok-kw">if</span> (len &gt; wtf16_dir_path.len) <span class="tok-kw">return</span> <span class="tok-kw">error</span>.NameTooLong;</span>
<span class="line" id="L3232">        <span class="tok-kw">return</span> chdirW(wtf16_dir_path[<span class="tok-number">0</span>..len]);</span>
<span class="line" id="L3233">    } <span class="tok-kw">else</span> {</span>
<span class="line" id="L3234">        <span class="tok-kw">const</span> dir_path_c = <span class="tok-kw">try</span> toPosixPath(dir_path);</span>
<span class="line" id="L3235">        <span class="tok-kw">return</span> chdirZ(&amp;dir_path_c);</span>
<span class="line" id="L3236">    }</span>
<span class="line" id="L3237">}</span>
<span class="line" id="L3238"></span>
<span class="line" id="L3239"><span class="tok-comment">/// Same as `chdir` except the parameter is null-terminated.</span></span>
<span class="line" id="L3240"><span class="tok-comment">/// On Windows, `dir_path` should be encoded as [WTF-8](https://simonsapin.github.io/wtf-8/).</span></span>
<span class="line" id="L3241"><span class="tok-comment">/// On WASI, `dir_path` should be encoded as valid UTF-8.</span></span>
<span class="line" id="L3242"><span class="tok-comment">/// On other platforms, `dir_path` is an opaque sequence of bytes with no particular encoding.</span></span>
<span class="line" id="L3243"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">chdirZ</span>(dir_path: [*:<span class="tok-number">0</span>]<span class="tok-kw">const</span> <span class="tok-type">u8</span>) ChangeCurDirError!<span class="tok-type">void</span> {</span>
<span class="line" id="L3244">    <span class="tok-kw">if</span> (builtin.os.tag == .windows) {</span>
<span class="line" id="L3245">        <span class="tok-kw">var</span> wtf16_dir_path: [windows.PATH_MAX_WIDE]<span class="tok-type">u16</span> = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L3246">        <span class="tok-kw">const</span> len = <span class="tok-kw">try</span> std.unicode.wtf8ToWtf16Le(wtf16_dir_path[<span class="tok-number">0</span>..], mem.span(dir_path));</span>
<span class="line" id="L3247">        <span class="tok-kw">if</span> (len &gt; wtf16_dir_path.len) <span class="tok-kw">return</span> <span class="tok-kw">error</span>.NameTooLong;</span>
<span class="line" id="L3248">        <span class="tok-kw">return</span> chdirW(wtf16_dir_path[<span class="tok-number">0</span>..len]);</span>
<span class="line" id="L3249">    } <span class="tok-kw">else</span> <span class="tok-kw">if</span> (builtin.os.tag == .wasi <span class="tok-kw">and</span> !builtin.link_libc) {</span>
<span class="line" id="L3250">        <span class="tok-kw">return</span> chdir(mem.span(dir_path));</span>
<span class="line" id="L3251">    }</span>
<span class="line" id="L3252">    <span class="tok-kw">switch</span> (errno(system.chdir(dir_path))) {</span>
<span class="line" id="L3253">        .SUCCESS =&gt; <span class="tok-kw">return</span>,</span>
<span class="line" id="L3254">        .ACCES =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.AccessDenied,</span>
<span class="line" id="L3255">        .FAULT =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L3256">        .IO =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.FileSystem,</span>
<span class="line" id="L3257">        .LOOP =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.SymLinkLoop,</span>
<span class="line" id="L3258">        .NAMETOOLONG =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.NameTooLong,</span>
<span class="line" id="L3259">        .NOENT =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.FileNotFound,</span>
<span class="line" id="L3260">        .NOMEM =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.SystemResources,</span>
<span class="line" id="L3261">        .NOTDIR =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.NotDir,</span>
<span class="line" id="L3262">        .ILSEQ =&gt; |err| <span class="tok-kw">if</span> (builtin.os.tag == .wasi)</span>
<span class="line" id="L3263">            <span class="tok-kw">return</span> <span class="tok-kw">error</span>.InvalidUtf8</span>
<span class="line" id="L3264">        <span class="tok-kw">else</span></span>
<span class="line" id="L3265">            <span class="tok-kw">return</span> unexpectedErrno(err),</span>
<span class="line" id="L3266">        <span class="tok-kw">else</span> =&gt; |err| <span class="tok-kw">return</span> unexpectedErrno(err),</span>
<span class="line" id="L3267">    }</span>
<span class="line" id="L3268">}</span>
<span class="line" id="L3269"></span>
<span class="line" id="L3270"><span class="tok-comment">/// Windows-only. Same as `chdir` except the parameter is WTF16 LE encoded.</span></span>
<span class="line" id="L3271"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">chdirW</span>(dir_path: []<span class="tok-kw">const</span> <span class="tok-type">u16</span>) ChangeCurDirError!<span class="tok-type">void</span> {</span>
<span class="line" id="L3272">    windows.SetCurrentDirectory(dir_path) <span class="tok-kw">catch</span> |err| <span class="tok-kw">switch</span> (err) {</span>
<span class="line" id="L3273">        <span class="tok-kw">error</span>.NoDevice =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.FileSystem,</span>
<span class="line" id="L3274">        <span class="tok-kw">else</span> =&gt; |e| <span class="tok-kw">return</span> e,</span>
<span class="line" id="L3275">    };</span>
<span class="line" id="L3276">}</span>
<span class="line" id="L3277"></span>
<span class="line" id="L3278"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FchdirError = <span class="tok-kw">error</span>{</span>
<span class="line" id="L3279">    AccessDenied,</span>
<span class="line" id="L3280">    NotDir,</span>
<span class="line" id="L3281">    FileSystem,</span>
<span class="line" id="L3282">} || UnexpectedError;</span>
<span class="line" id="L3283"></span>
<span class="line" id="L3284"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">fchdir</span>(dirfd: fd_t) FchdirError!<span class="tok-type">void</span> {</span>
<span class="line" id="L3285">    <span class="tok-kw">if</span> (dirfd == AT.FDCWD) <span class="tok-kw">return</span>;</span>
<span class="line" id="L3286">    <span class="tok-kw">while</span> (<span class="tok-null">true</span>) {</span>
<span class="line" id="L3287">        <span class="tok-kw">switch</span> (errno(system.fchdir(dirfd))) {</span>
<span class="line" id="L3288">            .SUCCESS =&gt; <span class="tok-kw">return</span>,</span>
<span class="line" id="L3289">            .ACCES =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.AccessDenied,</span>
<span class="line" id="L3290">            .BADF =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L3291">            .NOTDIR =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.NotDir,</span>
<span class="line" id="L3292">            .INTR =&gt; <span class="tok-kw">continue</span>,</span>
<span class="line" id="L3293">            .IO =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.FileSystem,</span>
<span class="line" id="L3294">            <span class="tok-kw">else</span> =&gt; |err| <span class="tok-kw">return</span> unexpectedErrno(err),</span>
<span class="line" id="L3295">        }</span>
<span class="line" id="L3296">    }</span>
<span class="line" id="L3297">}</span>
<span class="line" id="L3298"></span>
<span class="line" id="L3299"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> ReadLinkError = <span class="tok-kw">error</span>{</span>
<span class="line" id="L3300">    <span class="tok-comment">/// In WASI, this error may occur when the file descriptor does</span></span>
<span class="line" id="L3301">    <span class="tok-comment">/// not hold the required rights to read value of a symbolic link relative to it.</span></span>
<span class="line" id="L3302">    AccessDenied,</span>
<span class="line" id="L3303">    FileSystem,</span>
<span class="line" id="L3304">    SymLinkLoop,</span>
<span class="line" id="L3305">    NameTooLong,</span>
<span class="line" id="L3306">    FileNotFound,</span>
<span class="line" id="L3307">    SystemResources,</span>
<span class="line" id="L3308">    NotLink,</span>
<span class="line" id="L3309">    NotDir,</span>
<span class="line" id="L3310">    <span class="tok-comment">/// WASI-only; file paths must be valid UTF-8.</span></span>
<span class="line" id="L3311">    InvalidUtf8,</span>
<span class="line" id="L3312">    <span class="tok-comment">/// Windows-only; file paths provided by the user must be valid WTF-8.</span></span>
<span class="line" id="L3313">    <span class="tok-comment">/// https://simonsapin.github.io/wtf-8/</span></span>
<span class="line" id="L3314">    InvalidWtf8,</span>
<span class="line" id="L3315">    BadPathName,</span>
<span class="line" id="L3316">    <span class="tok-comment">/// Windows-only. This error may occur if the opened reparse point is</span></span>
<span class="line" id="L3317">    <span class="tok-comment">/// of unsupported type.</span></span>
<span class="line" id="L3318">    UnsupportedReparsePointType,</span>
<span class="line" id="L3319">    <span class="tok-comment">/// On Windows, `\\server` or `\\server\share` was not found.</span></span>
<span class="line" id="L3320">    NetworkNotFound,</span>
<span class="line" id="L3321">} || UnexpectedError;</span>
<span class="line" id="L3322"></span>
<span class="line" id="L3323"><span class="tok-comment">/// Read value of a symbolic link.</span></span>
<span class="line" id="L3324"><span class="tok-comment">/// On Windows, `file_path` should be encoded as [WTF-8](https://simonsapin.github.io/wtf-8/).</span></span>
<span class="line" id="L3325"><span class="tok-comment">/// On WASI, `file_path` should be encoded as valid UTF-8.</span></span>
<span class="line" id="L3326"><span class="tok-comment">/// On other platforms, `file_path` is an opaque sequence of bytes with no particular encoding.</span></span>
<span class="line" id="L3327"><span class="tok-comment">/// The return value is a slice of `out_buffer` from index 0.</span></span>
<span class="line" id="L3328"><span class="tok-comment">/// On Windows, the result is encoded as [WTF-8](https://simonsapin.github.io/wtf-8/).</span></span>
<span class="line" id="L3329"><span class="tok-comment">/// On WASI, the result is encoded as UTF-8.</span></span>
<span class="line" id="L3330"><span class="tok-comment">/// On other platforms, the result is an opaque sequence of bytes with no particular encoding.</span></span>
<span class="line" id="L3331"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">readlink</span>(file_path: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>, out_buffer: []<span class="tok-type">u8</span>) ReadLinkError![]<span class="tok-type">u8</span> {</span>
<span class="line" id="L3332">    <span class="tok-kw">if</span> (builtin.os.tag == .wasi <span class="tok-kw">and</span> !builtin.link_libc) {</span>
<span class="line" id="L3333">        <span class="tok-kw">return</span> readlinkat(wasi.AT.FDCWD, file_path, out_buffer);</span>
<span class="line" id="L3334">    } <span class="tok-kw">else</span> <span class="tok-kw">if</span> (builtin.os.tag == .windows) {</span>
<span class="line" id="L3335">        <span class="tok-kw">const</span> file_path_w = <span class="tok-kw">try</span> windows.sliceToPrefixedFileW(<span class="tok-null">null</span>, file_path);</span>
<span class="line" id="L3336">        <span class="tok-kw">return</span> readlinkW(file_path_w.span(), out_buffer);</span>
<span class="line" id="L3337">    } <span class="tok-kw">else</span> {</span>
<span class="line" id="L3338">        <span class="tok-kw">const</span> file_path_c = <span class="tok-kw">try</span> toPosixPath(file_path);</span>
<span class="line" id="L3339">        <span class="tok-kw">return</span> readlinkZ(&amp;file_path_c, out_buffer);</span>
<span class="line" id="L3340">    }</span>
<span class="line" id="L3341">}</span>
<span class="line" id="L3342"></span>
<span class="line" id="L3343"><span class="tok-comment">/// Windows-only. Same as `readlink` except `file_path` is WTF16 LE encoded.</span></span>
<span class="line" id="L3344"><span class="tok-comment">/// The result is encoded as [WTF-8](https://simonsapin.github.io/wtf-8/).</span></span>
<span class="line" id="L3345"><span class="tok-comment">/// See also `readlinkZ`.</span></span>
<span class="line" id="L3346"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">readlinkW</span>(file_path: []<span class="tok-kw">const</span> <span class="tok-type">u16</span>, out_buffer: []<span class="tok-type">u8</span>) ReadLinkError![]<span class="tok-type">u8</span> {</span>
<span class="line" id="L3347">    <span class="tok-kw">return</span> windows.ReadLink(std.fs.cwd().fd, file_path, out_buffer);</span>
<span class="line" id="L3348">}</span>
<span class="line" id="L3349"></span>
<span class="line" id="L3350"><span class="tok-comment">/// Same as `readlink` except `file_path` is null-terminated.</span></span>
<span class="line" id="L3351"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">readlinkZ</span>(file_path: [*:<span class="tok-number">0</span>]<span class="tok-kw">const</span> <span class="tok-type">u8</span>, out_buffer: []<span class="tok-type">u8</span>) ReadLinkError![]<span class="tok-type">u8</span> {</span>
<span class="line" id="L3352">    <span class="tok-kw">if</span> (builtin.os.tag == .windows) {</span>
<span class="line" id="L3353">        <span class="tok-kw">const</span> file_path_w = <span class="tok-kw">try</span> windows.cStrToPrefixedFileW(<span class="tok-null">null</span>, file_path);</span>
<span class="line" id="L3354">        <span class="tok-kw">return</span> readlinkW(file_path_w.span(), out_buffer);</span>
<span class="line" id="L3355">    } <span class="tok-kw">else</span> <span class="tok-kw">if</span> (builtin.os.tag == .wasi <span class="tok-kw">and</span> !builtin.link_libc) {</span>
<span class="line" id="L3356">        <span class="tok-kw">return</span> readlink(mem.sliceTo(file_path, <span class="tok-number">0</span>), out_buffer);</span>
<span class="line" id="L3357">    }</span>
<span class="line" id="L3358">    <span class="tok-kw">const</span> rc = system.readlink(file_path, out_buffer.ptr, out_buffer.len);</span>
<span class="line" id="L3359">    <span class="tok-kw">switch</span> (errno(rc)) {</span>
<span class="line" id="L3360">        .SUCCESS =&gt; <span class="tok-kw">return</span> out_buffer[<span class="tok-number">0</span>..<span class="tok-builtin">@bitCast</span>(rc)],</span>
<span class="line" id="L3361">        .ACCES =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.AccessDenied,</span>
<span class="line" id="L3362">        .FAULT =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L3363">        .INVAL =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.NotLink,</span>
<span class="line" id="L3364">        .IO =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.FileSystem,</span>
<span class="line" id="L3365">        .LOOP =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.SymLinkLoop,</span>
<span class="line" id="L3366">        .NAMETOOLONG =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.NameTooLong,</span>
<span class="line" id="L3367">        .NOENT =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.FileNotFound,</span>
<span class="line" id="L3368">        .NOMEM =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.SystemResources,</span>
<span class="line" id="L3369">        .NOTDIR =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.NotDir,</span>
<span class="line" id="L3370">        .ILSEQ =&gt; |err| <span class="tok-kw">if</span> (builtin.os.tag == .wasi)</span>
<span class="line" id="L3371">            <span class="tok-kw">return</span> <span class="tok-kw">error</span>.InvalidUtf8</span>
<span class="line" id="L3372">        <span class="tok-kw">else</span></span>
<span class="line" id="L3373">            <span class="tok-kw">return</span> unexpectedErrno(err),</span>
<span class="line" id="L3374">        <span class="tok-kw">else</span> =&gt; |err| <span class="tok-kw">return</span> unexpectedErrno(err),</span>
<span class="line" id="L3375">    }</span>
<span class="line" id="L3376">}</span>
<span class="line" id="L3377"></span>
<span class="line" id="L3378"><span class="tok-comment">/// Similar to `readlink` except reads value of a symbolink link **relative** to `dirfd` directory handle.</span></span>
<span class="line" id="L3379"><span class="tok-comment">/// On Windows, `file_path` should be encoded as [WTF-8](https://simonsapin.github.io/wtf-8/).</span></span>
<span class="line" id="L3380"><span class="tok-comment">/// On WASI, `file_path` should be encoded as valid UTF-8.</span></span>
<span class="line" id="L3381"><span class="tok-comment">/// On other platforms, `file_path` is an opaque sequence of bytes with no particular encoding.</span></span>
<span class="line" id="L3382"><span class="tok-comment">/// The return value is a slice of `out_buffer` from index 0.</span></span>
<span class="line" id="L3383"><span class="tok-comment">/// On Windows, the result is encoded as [WTF-8](https://simonsapin.github.io/wtf-8/).</span></span>
<span class="line" id="L3384"><span class="tok-comment">/// On WASI, the result is encoded as UTF-8.</span></span>
<span class="line" id="L3385"><span class="tok-comment">/// On other platforms, the result is an opaque sequence of bytes with no particular encoding.</span></span>
<span class="line" id="L3386"><span class="tok-comment">/// See also `readlinkatWasi`, `realinkatZ` and `realinkatW`.</span></span>
<span class="line" id="L3387"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">readlinkat</span>(dirfd: fd_t, file_path: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>, out_buffer: []<span class="tok-type">u8</span>) ReadLinkError![]<span class="tok-type">u8</span> {</span>
<span class="line" id="L3388">    <span class="tok-kw">if</span> (builtin.os.tag == .wasi <span class="tok-kw">and</span> !builtin.link_libc) {</span>
<span class="line" id="L3389">        <span class="tok-kw">return</span> readlinkatWasi(dirfd, file_path, out_buffer);</span>
<span class="line" id="L3390">    }</span>
<span class="line" id="L3391">    <span class="tok-kw">if</span> (builtin.os.tag == .windows) {</span>
<span class="line" id="L3392">        <span class="tok-kw">const</span> file_path_w = <span class="tok-kw">try</span> windows.sliceToPrefixedFileW(dirfd, file_path);</span>
<span class="line" id="L3393">        <span class="tok-kw">return</span> readlinkatW(dirfd, file_path_w.span(), out_buffer);</span>
<span class="line" id="L3394">    }</span>
<span class="line" id="L3395">    <span class="tok-kw">const</span> file_path_c = <span class="tok-kw">try</span> toPosixPath(file_path);</span>
<span class="line" id="L3396">    <span class="tok-kw">return</span> readlinkatZ(dirfd, &amp;file_path_c, out_buffer);</span>
<span class="line" id="L3397">}</span>
<span class="line" id="L3398"></span>
<span class="line" id="L3399"><span class="tok-comment">/// WASI-only. Same as `readlinkat` but targets WASI.</span></span>
<span class="line" id="L3400"><span class="tok-comment">/// See also `readlinkat`.</span></span>
<span class="line" id="L3401"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">readlinkatWasi</span>(dirfd: fd_t, file_path: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>, out_buffer: []<span class="tok-type">u8</span>) ReadLinkError![]<span class="tok-type">u8</span> {</span>
<span class="line" id="L3402">    <span class="tok-kw">var</span> bufused: <span class="tok-type">usize</span> = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L3403">    <span class="tok-kw">switch</span> (wasi.path_readlink(dirfd, file_path.ptr, file_path.len, out_buffer.ptr, out_buffer.len, &amp;bufused)) {</span>
<span class="line" id="L3404">        .SUCCESS =&gt; <span class="tok-kw">return</span> out_buffer[<span class="tok-number">0</span>..bufused],</span>
<span class="line" id="L3405">        .ACCES =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.AccessDenied,</span>
<span class="line" id="L3406">        .FAULT =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L3407">        .INVAL =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.NotLink,</span>
<span class="line" id="L3408">        .IO =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.FileSystem,</span>
<span class="line" id="L3409">        .LOOP =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.SymLinkLoop,</span>
<span class="line" id="L3410">        .NAMETOOLONG =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.NameTooLong,</span>
<span class="line" id="L3411">        .NOENT =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.FileNotFound,</span>
<span class="line" id="L3412">        .NOMEM =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.SystemResources,</span>
<span class="line" id="L3413">        .NOTDIR =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.NotDir,</span>
<span class="line" id="L3414">        .NOTCAPABLE =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.AccessDenied,</span>
<span class="line" id="L3415">        .ILSEQ =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.InvalidUtf8,</span>
<span class="line" id="L3416">        <span class="tok-kw">else</span> =&gt; |err| <span class="tok-kw">return</span> unexpectedErrno(err),</span>
<span class="line" id="L3417">    }</span>
<span class="line" id="L3418">}</span>
<span class="line" id="L3419"></span>
<span class="line" id="L3420"><span class="tok-comment">/// Windows-only. Same as `readlinkat` except `file_path` is null-terminated, WTF16 LE encoded.</span></span>
<span class="line" id="L3421"><span class="tok-comment">/// The result is encoded as [WTF-8](https://simonsapin.github.io/wtf-8/).</span></span>
<span class="line" id="L3422"><span class="tok-comment">/// See also `readlinkat`.</span></span>
<span class="line" id="L3423"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">readlinkatW</span>(dirfd: fd_t, file_path: []<span class="tok-kw">const</span> <span class="tok-type">u16</span>, out_buffer: []<span class="tok-type">u8</span>) ReadLinkError![]<span class="tok-type">u8</span> {</span>
<span class="line" id="L3424">    <span class="tok-kw">return</span> windows.ReadLink(dirfd, file_path, out_buffer);</span>
<span class="line" id="L3425">}</span>
<span class="line" id="L3426"></span>
<span class="line" id="L3427"><span class="tok-comment">/// Same as `readlinkat` except `file_path` is null-terminated.</span></span>
<span class="line" id="L3428"><span class="tok-comment">/// See also `readlinkat`.</span></span>
<span class="line" id="L3429"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">readlinkatZ</span>(dirfd: fd_t, file_path: [*:<span class="tok-number">0</span>]<span class="tok-kw">const</span> <span class="tok-type">u8</span>, out_buffer: []<span class="tok-type">u8</span>) ReadLinkError![]<span class="tok-type">u8</span> {</span>
<span class="line" id="L3430">    <span class="tok-kw">if</span> (builtin.os.tag == .windows) {</span>
<span class="line" id="L3431">        <span class="tok-kw">const</span> file_path_w = <span class="tok-kw">try</span> windows.cStrToPrefixedFileW(dirfd, file_path);</span>
<span class="line" id="L3432">        <span class="tok-kw">return</span> readlinkatW(dirfd, file_path_w.span(), out_buffer);</span>
<span class="line" id="L3433">    } <span class="tok-kw">else</span> <span class="tok-kw">if</span> (builtin.os.tag == .wasi <span class="tok-kw">and</span> !builtin.link_libc) {</span>
<span class="line" id="L3434">        <span class="tok-kw">return</span> readlinkat(dirfd, mem.sliceTo(file_path, <span class="tok-number">0</span>), out_buffer);</span>
<span class="line" id="L3435">    }</span>
<span class="line" id="L3436">    <span class="tok-kw">const</span> rc = system.readlinkat(dirfd, file_path, out_buffer.ptr, out_buffer.len);</span>
<span class="line" id="L3437">    <span class="tok-kw">switch</span> (errno(rc)) {</span>
<span class="line" id="L3438">        .SUCCESS =&gt; <span class="tok-kw">return</span> out_buffer[<span class="tok-number">0</span>..<span class="tok-builtin">@bitCast</span>(rc)],</span>
<span class="line" id="L3439">        .ACCES =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.AccessDenied,</span>
<span class="line" id="L3440">        .FAULT =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L3441">        .INVAL =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.NotLink,</span>
<span class="line" id="L3442">        .IO =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.FileSystem,</span>
<span class="line" id="L3443">        .LOOP =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.SymLinkLoop,</span>
<span class="line" id="L3444">        .NAMETOOLONG =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.NameTooLong,</span>
<span class="line" id="L3445">        .NOENT =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.FileNotFound,</span>
<span class="line" id="L3446">        .NOMEM =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.SystemResources,</span>
<span class="line" id="L3447">        .NOTDIR =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.NotDir,</span>
<span class="line" id="L3448">        .ILSEQ =&gt; |err| <span class="tok-kw">if</span> (builtin.os.tag == .wasi)</span>
<span class="line" id="L3449">            <span class="tok-kw">return</span> <span class="tok-kw">error</span>.InvalidUtf8</span>
<span class="line" id="L3450">        <span class="tok-kw">else</span></span>
<span class="line" id="L3451">            <span class="tok-kw">return</span> unexpectedErrno(err),</span>
<span class="line" id="L3452">        <span class="tok-kw">else</span> =&gt; |err| <span class="tok-kw">return</span> unexpectedErrno(err),</span>
<span class="line" id="L3453">    }</span>
<span class="line" id="L3454">}</span>
<span class="line" id="L3455"></span>
<span class="line" id="L3456"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> SetEidError = <span class="tok-kw">error</span>{</span>
<span class="line" id="L3457">    InvalidUserId,</span>
<span class="line" id="L3458">    PermissionDenied,</span>
<span class="line" id="L3459">} || UnexpectedError;</span>
<span class="line" id="L3460"></span>
<span class="line" id="L3461"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> SetIdError = <span class="tok-kw">error</span>{ResourceLimitReached} || SetEidError;</span>
<span class="line" id="L3462"></span>
<span class="line" id="L3463"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">setuid</span>(uid: uid_t) SetIdError!<span class="tok-type">void</span> {</span>
<span class="line" id="L3464">    <span class="tok-kw">switch</span> (errno(system.setuid(uid))) {</span>
<span class="line" id="L3465">        .SUCCESS =&gt; <span class="tok-kw">return</span>,</span>
<span class="line" id="L3466">        .AGAIN =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.ResourceLimitReached,</span>
<span class="line" id="L3467">        .INVAL =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.InvalidUserId,</span>
<span class="line" id="L3468">        .PERM =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.PermissionDenied,</span>
<span class="line" id="L3469">        <span class="tok-kw">else</span> =&gt; |err| <span class="tok-kw">return</span> unexpectedErrno(err),</span>
<span class="line" id="L3470">    }</span>
<span class="line" id="L3471">}</span>
<span class="line" id="L3472"></span>
<span class="line" id="L3473"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">seteuid</span>(uid: uid_t) SetEidError!<span class="tok-type">void</span> {</span>
<span class="line" id="L3474">    <span class="tok-kw">switch</span> (errno(system.seteuid(uid))) {</span>
<span class="line" id="L3475">        .SUCCESS =&gt; <span class="tok-kw">return</span>,</span>
<span class="line" id="L3476">        .INVAL =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.InvalidUserId,</span>
<span class="line" id="L3477">        .PERM =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.PermissionDenied,</span>
<span class="line" id="L3478">        <span class="tok-kw">else</span> =&gt; |err| <span class="tok-kw">return</span> unexpectedErrno(err),</span>
<span class="line" id="L3479">    }</span>
<span class="line" id="L3480">}</span>
<span class="line" id="L3481"></span>
<span class="line" id="L3482"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">setreuid</span>(ruid: uid_t, euid: uid_t) SetIdError!<span class="tok-type">void</span> {</span>
<span class="line" id="L3483">    <span class="tok-kw">switch</span> (errno(system.setreuid(ruid, euid))) {</span>
<span class="line" id="L3484">        .SUCCESS =&gt; <span class="tok-kw">return</span>,</span>
<span class="line" id="L3485">        .AGAIN =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.ResourceLimitReached,</span>
<span class="line" id="L3486">        .INVAL =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.InvalidUserId,</span>
<span class="line" id="L3487">        .PERM =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.PermissionDenied,</span>
<span class="line" id="L3488">        <span class="tok-kw">else</span> =&gt; |err| <span class="tok-kw">return</span> unexpectedErrno(err),</span>
<span class="line" id="L3489">    }</span>
<span class="line" id="L3490">}</span>
<span class="line" id="L3491"></span>
<span class="line" id="L3492"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">setgid</span>(gid: gid_t) SetIdError!<span class="tok-type">void</span> {</span>
<span class="line" id="L3493">    <span class="tok-kw">switch</span> (errno(system.setgid(gid))) {</span>
<span class="line" id="L3494">        .SUCCESS =&gt; <span class="tok-kw">return</span>,</span>
<span class="line" id="L3495">        .AGAIN =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.ResourceLimitReached,</span>
<span class="line" id="L3496">        .INVAL =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.InvalidUserId,</span>
<span class="line" id="L3497">        .PERM =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.PermissionDenied,</span>
<span class="line" id="L3498">        <span class="tok-kw">else</span> =&gt; |err| <span class="tok-kw">return</span> unexpectedErrno(err),</span>
<span class="line" id="L3499">    }</span>
<span class="line" id="L3500">}</span>
<span class="line" id="L3501"></span>
<span class="line" id="L3502"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">setegid</span>(uid: uid_t) SetEidError!<span class="tok-type">void</span> {</span>
<span class="line" id="L3503">    <span class="tok-kw">switch</span> (errno(system.setegid(uid))) {</span>
<span class="line" id="L3504">        .SUCCESS =&gt; <span class="tok-kw">return</span>,</span>
<span class="line" id="L3505">        .INVAL =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.InvalidUserId,</span>
<span class="line" id="L3506">        .PERM =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.PermissionDenied,</span>
<span class="line" id="L3507">        <span class="tok-kw">else</span> =&gt; |err| <span class="tok-kw">return</span> unexpectedErrno(err),</span>
<span class="line" id="L3508">    }</span>
<span class="line" id="L3509">}</span>
<span class="line" id="L3510"></span>
<span class="line" id="L3511"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">setregid</span>(rgid: gid_t, egid: gid_t) SetIdError!<span class="tok-type">void</span> {</span>
<span class="line" id="L3512">    <span class="tok-kw">switch</span> (errno(system.setregid(rgid, egid))) {</span>
<span class="line" id="L3513">        .SUCCESS =&gt; <span class="tok-kw">return</span>,</span>
<span class="line" id="L3514">        .AGAIN =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.ResourceLimitReached,</span>
<span class="line" id="L3515">        .INVAL =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.InvalidUserId,</span>
<span class="line" id="L3516">        .PERM =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.PermissionDenied,</span>
<span class="line" id="L3517">        <span class="tok-kw">else</span> =&gt; |err| <span class="tok-kw">return</span> unexpectedErrno(err),</span>
<span class="line" id="L3518">    }</span>
<span class="line" id="L3519">}</span>
<span class="line" id="L3520"></span>
<span class="line" id="L3521"><span class="tok-comment">/// Test whether a file descriptor refers to a terminal.</span></span>
<span class="line" id="L3522"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">isatty</span>(handle: fd_t) <span class="tok-type">bool</span> {</span>
<span class="line" id="L3523">    <span class="tok-kw">if</span> (builtin.os.tag == .windows) {</span>
<span class="line" id="L3524">        <span class="tok-kw">if</span> (isCygwinPty(handle))</span>
<span class="line" id="L3525">            <span class="tok-kw">return</span> <span class="tok-null">true</span>;</span>
<span class="line" id="L3526"></span>
<span class="line" id="L3527">        <span class="tok-kw">var</span> out: windows.DWORD = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L3528">        <span class="tok-kw">return</span> windows.kernel32.GetConsoleMode(handle, &amp;out) != <span class="tok-number">0</span>;</span>
<span class="line" id="L3529">    }</span>
<span class="line" id="L3530">    <span class="tok-kw">if</span> (builtin.link_libc) {</span>
<span class="line" id="L3531">        <span class="tok-kw">return</span> system.isatty(handle) != <span class="tok-number">0</span>;</span>
<span class="line" id="L3532">    }</span>
<span class="line" id="L3533">    <span class="tok-kw">if</span> (builtin.os.tag == .wasi) {</span>
<span class="line" id="L3534">        <span class="tok-kw">var</span> statbuf: wasi.fdstat_t = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L3535">        <span class="tok-kw">const</span> err = wasi.fd_fdstat_get(handle, &amp;statbuf);</span>
<span class="line" id="L3536">        <span class="tok-kw">if</span> (err != .SUCCESS)</span>
<span class="line" id="L3537">            <span class="tok-kw">return</span> <span class="tok-null">false</span>;</span>
<span class="line" id="L3538"></span>
<span class="line" id="L3539">        <span class="tok-comment">// A tty is a character device that we can't seek or tell on.</span>
</span>
<span class="line" id="L3540">        <span class="tok-kw">if</span> (statbuf.fs_filetype != .CHARACTER_DEVICE)</span>
<span class="line" id="L3541">            <span class="tok-kw">return</span> <span class="tok-null">false</span>;</span>
<span class="line" id="L3542">        <span class="tok-kw">if</span> (statbuf.fs_rights_base.FD_SEEK <span class="tok-kw">or</span> statbuf.fs_rights_base.FD_TELL)</span>
<span class="line" id="L3543">            <span class="tok-kw">return</span> <span class="tok-null">false</span>;</span>
<span class="line" id="L3544"></span>
<span class="line" id="L3545">        <span class="tok-kw">return</span> <span class="tok-null">true</span>;</span>
<span class="line" id="L3546">    }</span>
<span class="line" id="L3547">    <span class="tok-kw">if</span> (builtin.os.tag == .linux) {</span>
<span class="line" id="L3548">        <span class="tok-kw">while</span> (<span class="tok-null">true</span>) {</span>
<span class="line" id="L3549">            <span class="tok-kw">var</span> wsz: linux.winsize = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L3550">            <span class="tok-kw">const</span> fd: <span class="tok-type">usize</span> = <span class="tok-builtin">@bitCast</span>(<span class="tok-builtin">@as</span>(<span class="tok-type">isize</span>, handle));</span>
<span class="line" id="L3551">            <span class="tok-kw">const</span> rc = linux.syscall3(.ioctl, fd, linux.T.IOCGWINSZ, <span class="tok-builtin">@intFromPtr</span>(&amp;wsz));</span>
<span class="line" id="L3552">            <span class="tok-kw">switch</span> (linux.getErrno(rc)) {</span>
<span class="line" id="L3553">                .SUCCESS =&gt; <span class="tok-kw">return</span> <span class="tok-null">true</span>,</span>
<span class="line" id="L3554">                .INTR =&gt; <span class="tok-kw">continue</span>,</span>
<span class="line" id="L3555">                <span class="tok-kw">else</span> =&gt; <span class="tok-kw">return</span> <span class="tok-null">false</span>,</span>
<span class="line" id="L3556">            }</span>
<span class="line" id="L3557">        }</span>
<span class="line" id="L3558">    }</span>
<span class="line" id="L3559">    <span class="tok-kw">return</span> system.isatty(handle) != <span class="tok-number">0</span>;</span>
<span class="line" id="L3560">}</span>
<span class="line" id="L3561"></span>
<span class="line" id="L3562"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">isCygwinPty</span>(handle: fd_t) <span class="tok-type">bool</span> {</span>
<span class="line" id="L3563">    <span class="tok-kw">if</span> (builtin.os.tag != .windows) <span class="tok-kw">return</span> <span class="tok-null">false</span>;</span>
<span class="line" id="L3564"></span>
<span class="line" id="L3565">    <span class="tok-comment">// If this is a MSYS2/cygwin pty, then it will be a named pipe with a name in one of these formats:</span>
</span>
<span class="line" id="L3566">    <span class="tok-comment">//   msys-[...]-ptyN-[...]</span>
</span>
<span class="line" id="L3567">    <span class="tok-comment">//   cygwin-[...]-ptyN-[...]</span>
</span>
<span class="line" id="L3568">    <span class="tok-comment">//</span>
</span>
<span class="line" id="L3569">    <span class="tok-comment">// Example: msys-1888ae32e00d56aa-pty0-to-master</span>
</span>
<span class="line" id="L3570"></span>
<span class="line" id="L3571">    <span class="tok-comment">// First, just check that the handle is a named pipe.</span>
</span>
<span class="line" id="L3572">    <span class="tok-comment">// This allows us to avoid the more costly NtQueryInformationFile call</span>
</span>
<span class="line" id="L3573">    <span class="tok-comment">// for handles that aren't named pipes.</span>
</span>
<span class="line" id="L3574">    {</span>
<span class="line" id="L3575">        <span class="tok-kw">var</span> io_status: windows.IO_STATUS_BLOCK = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L3576">        <span class="tok-kw">var</span> device_info: windows.FILE_FS_DEVICE_INFORMATION = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L3577">        <span class="tok-kw">const</span> rc = windows.ntdll.NtQueryVolumeInformationFile(handle, &amp;io_status, &amp;device_info, <span class="tok-builtin">@sizeOf</span>(windows.FILE_FS_DEVICE_INFORMATION), .FileFsDeviceInformation);</span>
<span class="line" id="L3578">        <span class="tok-kw">switch</span> (rc) {</span>
<span class="line" id="L3579">            .SUCCESS =&gt; {},</span>
<span class="line" id="L3580">            <span class="tok-kw">else</span> =&gt; <span class="tok-kw">return</span> <span class="tok-null">false</span>,</span>
<span class="line" id="L3581">        }</span>
<span class="line" id="L3582">        <span class="tok-kw">if</span> (device_info.DeviceType != windows.FILE_DEVICE_NAMED_PIPE) <span class="tok-kw">return</span> <span class="tok-null">false</span>;</span>
<span class="line" id="L3583">    }</span>
<span class="line" id="L3584"></span>
<span class="line" id="L3585">    <span class="tok-kw">const</span> name_bytes_offset = <span class="tok-builtin">@offsetOf</span>(windows.FILE_NAME_INFO, <span class="tok-str">&quot;FileName&quot;</span>);</span>
<span class="line" id="L3586">    <span class="tok-comment">// `NAME_MAX` UTF-16 code units (2 bytes each)</span>
</span>
<span class="line" id="L3587">    <span class="tok-comment">// Note: This buffer may not be long enough to handle *all* possible paths (PATH_MAX_WIDE would be necessary for that),</span>
</span>
<span class="line" id="L3588">    <span class="tok-comment">//       but because we only care about certain paths and we know they must be within a reasonable length,</span>
</span>
<span class="line" id="L3589">    <span class="tok-comment">//       we can use this smaller buffer and just return false on any error from NtQueryInformationFile.</span>
</span>
<span class="line" id="L3590">    <span class="tok-kw">const</span> num_name_bytes = windows.MAX_PATH * <span class="tok-number">2</span>;</span>
<span class="line" id="L3591">    <span class="tok-kw">var</span> name_info_bytes <span class="tok-kw">align</span>(<span class="tok-builtin">@alignOf</span>(windows.FILE_NAME_INFO)) = [_]<span class="tok-type">u8</span>{<span class="tok-number">0</span>} ** (name_bytes_offset + num_name_bytes);</span>
<span class="line" id="L3592"></span>
<span class="line" id="L3593">    <span class="tok-kw">var</span> io_status_block: windows.IO_STATUS_BLOCK = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L3594">    <span class="tok-kw">const</span> rc = windows.ntdll.NtQueryInformationFile(handle, &amp;io_status_block, &amp;name_info_bytes, <span class="tok-builtin">@intCast</span>(name_info_bytes.len), .FileNameInformation);</span>
<span class="line" id="L3595">    <span class="tok-kw">switch</span> (rc) {</span>
<span class="line" id="L3596">        .SUCCESS =&gt; {},</span>
<span class="line" id="L3597">        .INVALID_PARAMETER =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L3598">        <span class="tok-kw">else</span> =&gt; <span class="tok-kw">return</span> <span class="tok-null">false</span>,</span>
<span class="line" id="L3599">    }</span>
<span class="line" id="L3600"></span>
<span class="line" id="L3601">    <span class="tok-kw">const</span> name_info: *<span class="tok-kw">const</span> windows.FILE_NAME_INFO = <span class="tok-builtin">@ptrCast</span>(&amp;name_info_bytes);</span>
<span class="line" id="L3602">    <span class="tok-kw">const</span> name_bytes = name_info_bytes[name_bytes_offset .. name_bytes_offset + name_info.FileNameLength];</span>
<span class="line" id="L3603">    <span class="tok-kw">const</span> name_wide = mem.bytesAsSlice(<span class="tok-type">u16</span>, name_bytes);</span>
<span class="line" id="L3604">    <span class="tok-comment">// Note: The name we get from NtQueryInformationFile will be prefixed with a '\', e.g. \msys-1888ae32e00d56aa-pty0-to-master</span>
</span>
<span class="line" id="L3605">    <span class="tok-kw">return</span> (mem.startsWith(<span class="tok-type">u16</span>, name_wide, &amp;[_]<span class="tok-type">u16</span>{ <span class="tok-str">'\\'</span>, <span class="tok-str">'m'</span>, <span class="tok-str">'s'</span>, <span class="tok-str">'y'</span>, <span class="tok-str">'s'</span>, <span class="tok-str">'-'</span> }) <span class="tok-kw">or</span></span>
<span class="line" id="L3606">        mem.startsWith(<span class="tok-type">u16</span>, name_wide, &amp;[_]<span class="tok-type">u16</span>{ <span class="tok-str">'\\'</span>, <span class="tok-str">'c'</span>, <span class="tok-str">'y'</span>, <span class="tok-str">'g'</span>, <span class="tok-str">'w'</span>, <span class="tok-str">'i'</span>, <span class="tok-str">'n'</span>, <span class="tok-str">'-'</span> })) <span class="tok-kw">and</span></span>
<span class="line" id="L3607">        mem.indexOf(<span class="tok-type">u16</span>, name_wide, &amp;[_]<span class="tok-type">u16</span>{ <span class="tok-str">'-'</span>, <span class="tok-str">'p'</span>, <span class="tok-str">'t'</span>, <span class="tok-str">'y'</span> }) != <span class="tok-null">null</span>;</span>
<span class="line" id="L3608">}</span>
<span class="line" id="L3609"></span>
<span class="line" id="L3610"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> SocketError = <span class="tok-kw">error</span>{</span>
<span class="line" id="L3611">    <span class="tok-comment">/// Permission to create a socket of the specified type and/or</span></span>
<span class="line" id="L3612">    <span class="tok-comment">/// pro‐tocol is denied.</span></span>
<span class="line" id="L3613">    PermissionDenied,</span>
<span class="line" id="L3614"></span>
<span class="line" id="L3615">    <span class="tok-comment">/// The implementation does not support the specified address family.</span></span>
<span class="line" id="L3616">    AddressFamilyNotSupported,</span>
<span class="line" id="L3617"></span>
<span class="line" id="L3618">    <span class="tok-comment">/// Unknown protocol, or protocol family not available.</span></span>
<span class="line" id="L3619">    ProtocolFamilyNotAvailable,</span>
<span class="line" id="L3620"></span>
<span class="line" id="L3621">    <span class="tok-comment">/// The per-process limit on the number of open file descriptors has been reached.</span></span>
<span class="line" id="L3622">    ProcessFdQuotaExceeded,</span>
<span class="line" id="L3623"></span>
<span class="line" id="L3624">    <span class="tok-comment">/// The system-wide limit on the total number of open files has been reached.</span></span>
<span class="line" id="L3625">    SystemFdQuotaExceeded,</span>
<span class="line" id="L3626"></span>
<span class="line" id="L3627">    <span class="tok-comment">/// Insufficient memory is available. The socket cannot be created until sufficient</span></span>
<span class="line" id="L3628">    <span class="tok-comment">/// resources are freed.</span></span>
<span class="line" id="L3629">    SystemResources,</span>
<span class="line" id="L3630"></span>
<span class="line" id="L3631">    <span class="tok-comment">/// The protocol type or the specified protocol is not supported within this domain.</span></span>
<span class="line" id="L3632">    ProtocolNotSupported,</span>
<span class="line" id="L3633"></span>
<span class="line" id="L3634">    <span class="tok-comment">/// The socket type is not supported by the protocol.</span></span>
<span class="line" id="L3635">    SocketTypeNotSupported,</span>
<span class="line" id="L3636">} || UnexpectedError;</span>
<span class="line" id="L3637"></span>
<span class="line" id="L3638"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">socket</span>(domain: <span class="tok-type">u32</span>, socket_type: <span class="tok-type">u32</span>, protocol: <span class="tok-type">u32</span>) SocketError!socket_t {</span>
<span class="line" id="L3639">    <span class="tok-kw">if</span> (builtin.os.tag == .windows) {</span>
<span class="line" id="L3640">        <span class="tok-comment">// NOTE: windows translates the SOCK.NONBLOCK/SOCK.CLOEXEC flags into</span>
</span>
<span class="line" id="L3641">        <span class="tok-comment">// windows-analagous operations</span>
</span>
<span class="line" id="L3642">        <span class="tok-kw">const</span> filtered_sock_type = socket_type &amp; ~<span class="tok-builtin">@as</span>(<span class="tok-type">u32</span>, SOCK.NONBLOCK | SOCK.CLOEXEC);</span>
<span class="line" id="L3643">        <span class="tok-kw">const</span> flags: <span class="tok-type">u32</span> = <span class="tok-kw">if</span> ((socket_type &amp; SOCK.CLOEXEC) != <span class="tok-number">0</span>)</span>
<span class="line" id="L3644">            windows.ws2_32.WSA_FLAG_NO_HANDLE_INHERIT</span>
<span class="line" id="L3645">        <span class="tok-kw">else</span></span>
<span class="line" id="L3646">            <span class="tok-number">0</span>;</span>
<span class="line" id="L3647">        <span class="tok-kw">const</span> rc = <span class="tok-kw">try</span> windows.WSASocketW(</span>
<span class="line" id="L3648">            <span class="tok-builtin">@bitCast</span>(domain),</span>
<span class="line" id="L3649">            <span class="tok-builtin">@bitCast</span>(filtered_sock_type),</span>
<span class="line" id="L3650">            <span class="tok-builtin">@bitCast</span>(protocol),</span>
<span class="line" id="L3651">            <span class="tok-null">null</span>,</span>
<span class="line" id="L3652">            <span class="tok-number">0</span>,</span>
<span class="line" id="L3653">            flags,</span>
<span class="line" id="L3654">        );</span>
<span class="line" id="L3655">        <span class="tok-kw">errdefer</span> windows.closesocket(rc) <span class="tok-kw">catch</span> <span class="tok-kw">unreachable</span>;</span>
<span class="line" id="L3656">        <span class="tok-kw">if</span> ((socket_type &amp; SOCK.NONBLOCK) != <span class="tok-number">0</span>) {</span>
<span class="line" id="L3657">            <span class="tok-kw">var</span> mode: <span class="tok-type">c_ulong</span> = <span class="tok-number">1</span>; <span class="tok-comment">// nonblocking</span>
</span>
<span class="line" id="L3658">            <span class="tok-kw">if</span> (windows.ws2_32.SOCKET_ERROR == windows.ws2_32.ioctlsocket(rc, windows.ws2_32.FIONBIO, &amp;mode)) {</span>
<span class="line" id="L3659">                <span class="tok-kw">switch</span> (windows.ws2_32.WSAGetLastError()) {</span>
<span class="line" id="L3660">                    <span class="tok-comment">// have not identified any error codes that should be handled yet</span>
</span>
<span class="line" id="L3661">                    <span class="tok-kw">else</span> =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L3662">                }</span>
<span class="line" id="L3663">            }</span>
<span class="line" id="L3664">        }</span>
<span class="line" id="L3665">        <span class="tok-kw">return</span> rc;</span>
<span class="line" id="L3666">    }</span>
<span class="line" id="L3667"></span>
<span class="line" id="L3668">    <span class="tok-kw">const</span> have_sock_flags = !builtin.target.isDarwin();</span>
<span class="line" id="L3669">    <span class="tok-kw">const</span> filtered_sock_type = <span class="tok-kw">if</span> (!have_sock_flags)</span>
<span class="line" id="L3670">        socket_type &amp; ~<span class="tok-builtin">@as</span>(<span class="tok-type">u32</span>, SOCK.NONBLOCK | SOCK.CLOEXEC)</span>
<span class="line" id="L3671">    <span class="tok-kw">else</span></span>
<span class="line" id="L3672">        socket_type;</span>
<span class="line" id="L3673">    <span class="tok-kw">const</span> rc = system.socket(domain, filtered_sock_type, protocol);</span>
<span class="line" id="L3674">    <span class="tok-kw">switch</span> (errno(rc)) {</span>
<span class="line" id="L3675">        .SUCCESS =&gt; {</span>
<span class="line" id="L3676">            <span class="tok-kw">const</span> fd: fd_t = <span class="tok-builtin">@intCast</span>(rc);</span>
<span class="line" id="L3677">            <span class="tok-kw">errdefer</span> close(fd);</span>
<span class="line" id="L3678">            <span class="tok-kw">if</span> (!have_sock_flags) {</span>
<span class="line" id="L3679">                <span class="tok-kw">try</span> setSockFlags(fd, socket_type);</span>
<span class="line" id="L3680">            }</span>
<span class="line" id="L3681">            <span class="tok-kw">return</span> fd;</span>
<span class="line" id="L3682">        },</span>
<span class="line" id="L3683">        .ACCES =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.PermissionDenied,</span>
<span class="line" id="L3684">        .AFNOSUPPORT =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.AddressFamilyNotSupported,</span>
<span class="line" id="L3685">        .INVAL =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.ProtocolFamilyNotAvailable,</span>
<span class="line" id="L3686">        .MFILE =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.ProcessFdQuotaExceeded,</span>
<span class="line" id="L3687">        .NFILE =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.SystemFdQuotaExceeded,</span>
<span class="line" id="L3688">        .NOBUFS =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.SystemResources,</span>
<span class="line" id="L3689">        .NOMEM =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.SystemResources,</span>
<span class="line" id="L3690">        .PROTONOSUPPORT =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.ProtocolNotSupported,</span>
<span class="line" id="L3691">        .PROTOTYPE =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.SocketTypeNotSupported,</span>
<span class="line" id="L3692">        <span class="tok-kw">else</span> =&gt; |err| <span class="tok-kw">return</span> unexpectedErrno(err),</span>
<span class="line" id="L3693">    }</span>
<span class="line" id="L3694">}</span>
<span class="line" id="L3695"></span>
<span class="line" id="L3696"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> ShutdownError = <span class="tok-kw">error</span>{</span>
<span class="line" id="L3697">    ConnectionAborted,</span>
<span class="line" id="L3698"></span>
<span class="line" id="L3699">    <span class="tok-comment">/// Connection was reset by peer, application should close socket as it is no longer usable.</span></span>
<span class="line" id="L3700">    ConnectionResetByPeer,</span>
<span class="line" id="L3701">    BlockingOperationInProgress,</span>
<span class="line" id="L3702"></span>
<span class="line" id="L3703">    <span class="tok-comment">/// The network subsystem has failed.</span></span>
<span class="line" id="L3704">    NetworkSubsystemFailed,</span>
<span class="line" id="L3705"></span>
<span class="line" id="L3706">    <span class="tok-comment">/// The socket is not connected (connection-oriented sockets only).</span></span>
<span class="line" id="L3707">    SocketNotConnected,</span>
<span class="line" id="L3708">    SystemResources,</span>
<span class="line" id="L3709">} || UnexpectedError;</span>
<span class="line" id="L3710"></span>
<span class="line" id="L3711"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> ShutdownHow = <span class="tok-kw">enum</span> { recv, send, both };</span>
<span class="line" id="L3712"></span>
<span class="line" id="L3713"><span class="tok-comment">/// Shutdown socket send/receive operations</span></span>
<span class="line" id="L3714"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">shutdown</span>(sock: socket_t, how: ShutdownHow) ShutdownError!<span class="tok-type">void</span> {</span>
<span class="line" id="L3715">    <span class="tok-kw">if</span> (builtin.os.tag == .windows) {</span>
<span class="line" id="L3716">        <span class="tok-kw">const</span> result = windows.ws2_32.shutdown(sock, <span class="tok-kw">switch</span> (how) {</span>
<span class="line" id="L3717">            .recv =&gt; windows.ws2_32.SD_RECEIVE,</span>
<span class="line" id="L3718">            .send =&gt; windows.ws2_32.SD_SEND,</span>
<span class="line" id="L3719">            .both =&gt; windows.ws2_32.SD_BOTH,</span>
<span class="line" id="L3720">        });</span>
<span class="line" id="L3721">        <span class="tok-kw">if</span> (<span class="tok-number">0</span> != result) <span class="tok-kw">switch</span> (windows.ws2_32.WSAGetLastError()) {</span>
<span class="line" id="L3722">            .WSAECONNABORTED =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.ConnectionAborted,</span>
<span class="line" id="L3723">            .WSAECONNRESET =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.ConnectionResetByPeer,</span>
<span class="line" id="L3724">            .WSAEINPROGRESS =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.BlockingOperationInProgress,</span>
<span class="line" id="L3725">            .WSAEINVAL =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L3726">            .WSAENETDOWN =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.NetworkSubsystemFailed,</span>
<span class="line" id="L3727">            .WSAENOTCONN =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.SocketNotConnected,</span>
<span class="line" id="L3728">            .WSAENOTSOCK =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L3729">            .WSANOTINITIALISED =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L3730">            <span class="tok-kw">else</span> =&gt; |err| <span class="tok-kw">return</span> windows.unexpectedWSAError(err),</span>
<span class="line" id="L3731">        };</span>
<span class="line" id="L3732">    } <span class="tok-kw">else</span> {</span>
<span class="line" id="L3733">        <span class="tok-kw">const</span> rc = system.shutdown(sock, <span class="tok-kw">switch</span> (how) {</span>
<span class="line" id="L3734">            .recv =&gt; SHUT.RD,</span>
<span class="line" id="L3735">            .send =&gt; SHUT.WR,</span>
<span class="line" id="L3736">            .both =&gt; SHUT.RDWR,</span>
<span class="line" id="L3737">        });</span>
<span class="line" id="L3738">        <span class="tok-kw">switch</span> (errno(rc)) {</span>
<span class="line" id="L3739">            .SUCCESS =&gt; <span class="tok-kw">return</span>,</span>
<span class="line" id="L3740">            .BADF =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L3741">            .INVAL =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L3742">            .NOTCONN =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.SocketNotConnected,</span>
<span class="line" id="L3743">            .NOTSOCK =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L3744">            .NOBUFS =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.SystemResources,</span>
<span class="line" id="L3745">            <span class="tok-kw">else</span> =&gt; |err| <span class="tok-kw">return</span> unexpectedErrno(err),</span>
<span class="line" id="L3746">        }</span>
<span class="line" id="L3747">    }</span>
<span class="line" id="L3748">}</span>
<span class="line" id="L3749"></span>
<span class="line" id="L3750"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> BindError = <span class="tok-kw">error</span>{</span>
<span class="line" id="L3751">    <span class="tok-comment">/// The address is protected, and the user is not the superuser.</span></span>
<span class="line" id="L3752">    <span class="tok-comment">/// For UNIX domain sockets: Search permission is denied on  a  component</span></span>
<span class="line" id="L3753">    <span class="tok-comment">/// of  the  path  prefix.</span></span>
<span class="line" id="L3754">    AccessDenied,</span>
<span class="line" id="L3755"></span>
<span class="line" id="L3756">    <span class="tok-comment">/// The given address is already in use, or in the case of Internet domain sockets,</span></span>
<span class="line" id="L3757">    <span class="tok-comment">/// The  port number was specified as zero in the socket</span></span>
<span class="line" id="L3758">    <span class="tok-comment">/// address structure, but, upon attempting to bind to  an  ephemeral  port,  it  was</span></span>
<span class="line" id="L3759">    <span class="tok-comment">/// determined  that  all  port  numbers in the ephemeral port range are currently in</span></span>
<span class="line" id="L3760">    <span class="tok-comment">/// use.  See the discussion of /proc/sys/net/ipv4/ip_local_port_range ip(7).</span></span>
<span class="line" id="L3761">    AddressInUse,</span>
<span class="line" id="L3762"></span>
<span class="line" id="L3763">    <span class="tok-comment">/// A nonexistent interface was requested or the requested address was not local.</span></span>
<span class="line" id="L3764">    AddressNotAvailable,</span>
<span class="line" id="L3765"></span>
<span class="line" id="L3766">    <span class="tok-comment">/// The address is not valid for the address family of socket.</span></span>
<span class="line" id="L3767">    AddressFamilyNotSupported,</span>
<span class="line" id="L3768"></span>
<span class="line" id="L3769">    <span class="tok-comment">/// Too many symbolic links were encountered in resolving addr.</span></span>
<span class="line" id="L3770">    SymLinkLoop,</span>
<span class="line" id="L3771"></span>
<span class="line" id="L3772">    <span class="tok-comment">/// addr is too long.</span></span>
<span class="line" id="L3773">    NameTooLong,</span>
<span class="line" id="L3774"></span>
<span class="line" id="L3775">    <span class="tok-comment">/// A component in the directory prefix of the socket pathname does not exist.</span></span>
<span class="line" id="L3776">    FileNotFound,</span>
<span class="line" id="L3777"></span>
<span class="line" id="L3778">    <span class="tok-comment">/// Insufficient kernel memory was available.</span></span>
<span class="line" id="L3779">    SystemResources,</span>
<span class="line" id="L3780"></span>
<span class="line" id="L3781">    <span class="tok-comment">/// A component of the path prefix is not a directory.</span></span>
<span class="line" id="L3782">    NotDir,</span>
<span class="line" id="L3783"></span>
<span class="line" id="L3784">    <span class="tok-comment">/// The socket inode would reside on a read-only filesystem.</span></span>
<span class="line" id="L3785">    ReadOnlyFileSystem,</span>
<span class="line" id="L3786"></span>
<span class="line" id="L3787">    <span class="tok-comment">/// The network subsystem has failed.</span></span>
<span class="line" id="L3788">    NetworkSubsystemFailed,</span>
<span class="line" id="L3789"></span>
<span class="line" id="L3790">    FileDescriptorNotASocket,</span>
<span class="line" id="L3791"></span>
<span class="line" id="L3792">    AlreadyBound,</span>
<span class="line" id="L3793">} || UnexpectedError;</span>
<span class="line" id="L3794"></span>
<span class="line" id="L3795"><span class="tok-comment">/// addr is `*const T` where T is one of the sockaddr</span></span>
<span class="line" id="L3796"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">bind</span>(sock: socket_t, addr: *<span class="tok-kw">const</span> sockaddr, len: socklen_t) BindError!<span class="tok-type">void</span> {</span>
<span class="line" id="L3797">    <span class="tok-kw">if</span> (builtin.os.tag == .windows) {</span>
<span class="line" id="L3798">        <span class="tok-kw">const</span> rc = windows.bind(sock, addr, len);</span>
<span class="line" id="L3799">        <span class="tok-kw">if</span> (rc == windows.ws2_32.SOCKET_ERROR) {</span>
<span class="line" id="L3800">            <span class="tok-kw">switch</span> (windows.ws2_32.WSAGetLastError()) {</span>
<span class="line" id="L3801">                .WSANOTINITIALISED =&gt; <span class="tok-kw">unreachable</span>, <span class="tok-comment">// not initialized WSA</span>
</span>
<span class="line" id="L3802">                .WSAEACCES =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.AccessDenied,</span>
<span class="line" id="L3803">                .WSAEADDRINUSE =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.AddressInUse,</span>
<span class="line" id="L3804">                .WSAEADDRNOTAVAIL =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.AddressNotAvailable,</span>
<span class="line" id="L3805">                .WSAENOTSOCK =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.FileDescriptorNotASocket,</span>
<span class="line" id="L3806">                .WSAEFAULT =&gt; <span class="tok-kw">unreachable</span>, <span class="tok-comment">// invalid pointers</span>
</span>
<span class="line" id="L3807">                .WSAEINVAL =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.AlreadyBound,</span>
<span class="line" id="L3808">                .WSAENOBUFS =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.SystemResources,</span>
<span class="line" id="L3809">                .WSAENETDOWN =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.NetworkSubsystemFailed,</span>
<span class="line" id="L3810">                <span class="tok-kw">else</span> =&gt; |err| <span class="tok-kw">return</span> windows.unexpectedWSAError(err),</span>
<span class="line" id="L3811">            }</span>
<span class="line" id="L3812">            <span class="tok-kw">unreachable</span>;</span>
<span class="line" id="L3813">        }</span>
<span class="line" id="L3814">        <span class="tok-kw">return</span>;</span>
<span class="line" id="L3815">    } <span class="tok-kw">else</span> {</span>
<span class="line" id="L3816">        <span class="tok-kw">const</span> rc = system.bind(sock, addr, len);</span>
<span class="line" id="L3817">        <span class="tok-kw">switch</span> (errno(rc)) {</span>
<span class="line" id="L3818">            .SUCCESS =&gt; <span class="tok-kw">return</span>,</span>
<span class="line" id="L3819">            .ACCES, .PERM =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.AccessDenied,</span>
<span class="line" id="L3820">            .ADDRINUSE =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.AddressInUse,</span>
<span class="line" id="L3821">            .BADF =&gt; <span class="tok-kw">unreachable</span>, <span class="tok-comment">// always a race condition if this error is returned</span>
</span>
<span class="line" id="L3822">            .INVAL =&gt; <span class="tok-kw">unreachable</span>, <span class="tok-comment">// invalid parameters</span>
</span>
<span class="line" id="L3823">            .NOTSOCK =&gt; <span class="tok-kw">unreachable</span>, <span class="tok-comment">// invalid `sockfd`</span>
</span>
<span class="line" id="L3824">            .AFNOSUPPORT =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.AddressFamilyNotSupported,</span>
<span class="line" id="L3825">            .ADDRNOTAVAIL =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.AddressNotAvailable,</span>
<span class="line" id="L3826">            .FAULT =&gt; <span class="tok-kw">unreachable</span>, <span class="tok-comment">// invalid `addr` pointer</span>
</span>
<span class="line" id="L3827">            .LOOP =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.SymLinkLoop,</span>
<span class="line" id="L3828">            .NAMETOOLONG =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.NameTooLong,</span>
<span class="line" id="L3829">            .NOENT =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.FileNotFound,</span>
<span class="line" id="L3830">            .NOMEM =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.SystemResources,</span>
<span class="line" id="L3831">            .NOTDIR =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.NotDir,</span>
<span class="line" id="L3832">            .ROFS =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.ReadOnlyFileSystem,</span>
<span class="line" id="L3833">            <span class="tok-kw">else</span> =&gt; |err| <span class="tok-kw">return</span> unexpectedErrno(err),</span>
<span class="line" id="L3834">        }</span>
<span class="line" id="L3835">    }</span>
<span class="line" id="L3836">    <span class="tok-kw">unreachable</span>;</span>
<span class="line" id="L3837">}</span>
<span class="line" id="L3838"></span>
<span class="line" id="L3839"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> ListenError = <span class="tok-kw">error</span>{</span>
<span class="line" id="L3840">    <span class="tok-comment">/// Another socket is already listening on the same port.</span></span>
<span class="line" id="L3841">    <span class="tok-comment">/// For Internet domain sockets, the  socket referred to by sockfd had not previously</span></span>
<span class="line" id="L3842">    <span class="tok-comment">/// been bound to an address and, upon attempting to bind it to an ephemeral port, it</span></span>
<span class="line" id="L3843">    <span class="tok-comment">/// was determined that all port numbers in the ephemeral port range are currently in</span></span>
<span class="line" id="L3844">    <span class="tok-comment">/// use.  See the discussion of /proc/sys/net/ipv4/ip_local_port_range in ip(7).</span></span>
<span class="line" id="L3845">    AddressInUse,</span>
<span class="line" id="L3846"></span>
<span class="line" id="L3847">    <span class="tok-comment">/// The file descriptor sockfd does not refer to a socket.</span></span>
<span class="line" id="L3848">    FileDescriptorNotASocket,</span>
<span class="line" id="L3849"></span>
<span class="line" id="L3850">    <span class="tok-comment">/// The socket is not of a type that supports the listen() operation.</span></span>
<span class="line" id="L3851">    OperationNotSupported,</span>
<span class="line" id="L3852"></span>
<span class="line" id="L3853">    <span class="tok-comment">/// The network subsystem has failed.</span></span>
<span class="line" id="L3854">    NetworkSubsystemFailed,</span>
<span class="line" id="L3855"></span>
<span class="line" id="L3856">    <span class="tok-comment">/// Ran out of system resources</span></span>
<span class="line" id="L3857">    <span class="tok-comment">/// On Windows it can either run out of socket descriptors or buffer space</span></span>
<span class="line" id="L3858">    SystemResources,</span>
<span class="line" id="L3859"></span>
<span class="line" id="L3860">    <span class="tok-comment">/// Already connected</span></span>
<span class="line" id="L3861">    AlreadyConnected,</span>
<span class="line" id="L3862"></span>
<span class="line" id="L3863">    <span class="tok-comment">/// Socket has not been bound yet</span></span>
<span class="line" id="L3864">    SocketNotBound,</span>
<span class="line" id="L3865">} || UnexpectedError;</span>
<span class="line" id="L3866"></span>
<span class="line" id="L3867"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">listen</span>(sock: socket_t, backlog: <span class="tok-type">u31</span>) ListenError!<span class="tok-type">void</span> {</span>
<span class="line" id="L3868">    <span class="tok-kw">if</span> (builtin.os.tag == .windows) {</span>
<span class="line" id="L3869">        <span class="tok-kw">const</span> rc = windows.listen(sock, backlog);</span>
<span class="line" id="L3870">        <span class="tok-kw">if</span> (rc == windows.ws2_32.SOCKET_ERROR) {</span>
<span class="line" id="L3871">            <span class="tok-kw">switch</span> (windows.ws2_32.WSAGetLastError()) {</span>
<span class="line" id="L3872">                .WSANOTINITIALISED =&gt; <span class="tok-kw">unreachable</span>, <span class="tok-comment">// not initialized WSA</span>
</span>
<span class="line" id="L3873">                .WSAENETDOWN =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.NetworkSubsystemFailed,</span>
<span class="line" id="L3874">                .WSAEADDRINUSE =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.AddressInUse,</span>
<span class="line" id="L3875">                .WSAEISCONN =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.AlreadyConnected,</span>
<span class="line" id="L3876">                .WSAEINVAL =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.SocketNotBound,</span>
<span class="line" id="L3877">                .WSAEMFILE, .WSAENOBUFS =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.SystemResources,</span>
<span class="line" id="L3878">                .WSAENOTSOCK =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.FileDescriptorNotASocket,</span>
<span class="line" id="L3879">                .WSAEOPNOTSUPP =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.OperationNotSupported,</span>
<span class="line" id="L3880">                .WSAEINPROGRESS =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L3881">                <span class="tok-kw">else</span> =&gt; |err| <span class="tok-kw">return</span> windows.unexpectedWSAError(err),</span>
<span class="line" id="L3882">            }</span>
<span class="line" id="L3883">        }</span>
<span class="line" id="L3884">        <span class="tok-kw">return</span>;</span>
<span class="line" id="L3885">    } <span class="tok-kw">else</span> {</span>
<span class="line" id="L3886">        <span class="tok-kw">const</span> rc = system.listen(sock, backlog);</span>
<span class="line" id="L3887">        <span class="tok-kw">switch</span> (errno(rc)) {</span>
<span class="line" id="L3888">            .SUCCESS =&gt; <span class="tok-kw">return</span>,</span>
<span class="line" id="L3889">            .ADDRINUSE =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.AddressInUse,</span>
<span class="line" id="L3890">            .BADF =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L3891">            .NOTSOCK =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.FileDescriptorNotASocket,</span>
<span class="line" id="L3892">            .OPNOTSUPP =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.OperationNotSupported,</span>
<span class="line" id="L3893">            <span class="tok-kw">else</span> =&gt; |err| <span class="tok-kw">return</span> unexpectedErrno(err),</span>
<span class="line" id="L3894">        }</span>
<span class="line" id="L3895">    }</span>
<span class="line" id="L3896">}</span>
<span class="line" id="L3897"></span>
<span class="line" id="L3898"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> AcceptError = <span class="tok-kw">error</span>{</span>
<span class="line" id="L3899">    ConnectionAborted,</span>
<span class="line" id="L3900"></span>
<span class="line" id="L3901">    <span class="tok-comment">/// The file descriptor sockfd does not refer to a socket.</span></span>
<span class="line" id="L3902">    FileDescriptorNotASocket,</span>
<span class="line" id="L3903"></span>
<span class="line" id="L3904">    <span class="tok-comment">/// The per-process limit on the number of open file descriptors has been reached.</span></span>
<span class="line" id="L3905">    ProcessFdQuotaExceeded,</span>
<span class="line" id="L3906"></span>
<span class="line" id="L3907">    <span class="tok-comment">/// The system-wide limit on the total number of open files has been reached.</span></span>
<span class="line" id="L3908">    SystemFdQuotaExceeded,</span>
<span class="line" id="L3909"></span>
<span class="line" id="L3910">    <span class="tok-comment">/// Not enough free memory.  This often means that the memory allocation  is  limited</span></span>
<span class="line" id="L3911">    <span class="tok-comment">/// by the socket buffer limits, not by the system memory.</span></span>
<span class="line" id="L3912">    SystemResources,</span>
<span class="line" id="L3913"></span>
<span class="line" id="L3914">    <span class="tok-comment">/// Socket is not listening for new connections.</span></span>
<span class="line" id="L3915">    SocketNotListening,</span>
<span class="line" id="L3916"></span>
<span class="line" id="L3917">    ProtocolFailure,</span>
<span class="line" id="L3918"></span>
<span class="line" id="L3919">    <span class="tok-comment">/// Firewall rules forbid connection.</span></span>
<span class="line" id="L3920">    BlockedByFirewall,</span>
<span class="line" id="L3921"></span>
<span class="line" id="L3922">    <span class="tok-comment">/// This error occurs when no global event loop is configured,</span></span>
<span class="line" id="L3923">    <span class="tok-comment">/// and accepting from the socket would block.</span></span>
<span class="line" id="L3924">    WouldBlock,</span>
<span class="line" id="L3925"></span>
<span class="line" id="L3926">    <span class="tok-comment">/// An incoming connection was indicated, but was subsequently terminated by the</span></span>
<span class="line" id="L3927">    <span class="tok-comment">/// remote peer prior to accepting the call.</span></span>
<span class="line" id="L3928">    ConnectionResetByPeer,</span>
<span class="line" id="L3929"></span>
<span class="line" id="L3930">    <span class="tok-comment">/// The network subsystem has failed.</span></span>
<span class="line" id="L3931">    NetworkSubsystemFailed,</span>
<span class="line" id="L3932"></span>
<span class="line" id="L3933">    <span class="tok-comment">/// The referenced socket is not a type that supports connection-oriented service.</span></span>
<span class="line" id="L3934">    OperationNotSupported,</span>
<span class="line" id="L3935">} || UnexpectedError;</span>
<span class="line" id="L3936"></span>
<span class="line" id="L3937"><span class="tok-comment">/// Accept a connection on a socket.</span></span>
<span class="line" id="L3938"><span class="tok-comment">/// If `sockfd` is opened in non blocking mode, the function will</span></span>
<span class="line" id="L3939"><span class="tok-comment">/// return error.WouldBlock when EAGAIN is received.</span></span>
<span class="line" id="L3940"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">accept</span>(</span>
<span class="line" id="L3941">    <span class="tok-comment">/// This argument is a socket that has been created with `socket`, bound to a local address</span></span>
<span class="line" id="L3942">    <span class="tok-comment">/// with `bind`, and is listening for connections after a `listen`.</span></span>
<span class="line" id="L3943">    sock: socket_t,</span>
<span class="line" id="L3944">    <span class="tok-comment">/// This argument is a pointer to a sockaddr structure.  This structure is filled in with  the</span></span>
<span class="line" id="L3945">    <span class="tok-comment">/// address  of  the  peer  socket, as known to the communications layer.  The exact format of the</span></span>
<span class="line" id="L3946">    <span class="tok-comment">/// address returned addr is determined by the socket's address  family  (see  `socket`  and  the</span></span>
<span class="line" id="L3947">    <span class="tok-comment">/// respective  protocol  man  pages).</span></span>
<span class="line" id="L3948">    addr: ?*sockaddr,</span>
<span class="line" id="L3949">    <span class="tok-comment">/// This argument is a value-result argument: the caller must initialize it to contain  the</span></span>
<span class="line" id="L3950">    <span class="tok-comment">/// size (in bytes) of the structure pointed to by addr; on return it will contain the actual size</span></span>
<span class="line" id="L3951">    <span class="tok-comment">/// of the peer address.</span></span>
<span class="line" id="L3952">    <span class="tok-comment">///</span></span>
<span class="line" id="L3953">    <span class="tok-comment">/// The returned address is truncated if the buffer provided is too small; in this  case,  `addr_size`</span></span>
<span class="line" id="L3954">    <span class="tok-comment">/// will return a value greater than was supplied to the call.</span></span>
<span class="line" id="L3955">    addr_size: ?*socklen_t,</span>
<span class="line" id="L3956">    <span class="tok-comment">/// The following values can be bitwise ORed in flags to obtain different behavior:</span></span>
<span class="line" id="L3957">    <span class="tok-comment">/// * `SOCK.NONBLOCK` - Set the `NONBLOCK` file status flag on the open file description (see `open`)</span></span>
<span class="line" id="L3958">    <span class="tok-comment">///   referred  to by the new file descriptor.  Using this flag saves extra calls to `fcntl` to achieve</span></span>
<span class="line" id="L3959">    <span class="tok-comment">///   the same result.</span></span>
<span class="line" id="L3960">    <span class="tok-comment">/// * `SOCK.CLOEXEC`  - Set the close-on-exec (`FD_CLOEXEC`) flag on the new file descriptor.   See  the</span></span>
<span class="line" id="L3961">    <span class="tok-comment">///   description  of the `CLOEXEC` flag in `open` for reasons why this may be useful.</span></span>
<span class="line" id="L3962">    flags: <span class="tok-type">u32</span>,</span>
<span class="line" id="L3963">) AcceptError!socket_t {</span>
<span class="line" id="L3964">    <span class="tok-kw">const</span> have_accept4 = !(builtin.target.isDarwin() <span class="tok-kw">or</span> builtin.os.tag == .windows);</span>
<span class="line" id="L3965">    assert(<span class="tok-number">0</span> == (flags &amp; ~<span class="tok-builtin">@as</span>(<span class="tok-type">u32</span>, SOCK.NONBLOCK | SOCK.CLOEXEC))); <span class="tok-comment">// Unsupported flag(s)</span>
</span>
<span class="line" id="L3966"></span>
<span class="line" id="L3967">    <span class="tok-kw">const</span> accepted_sock: socket_t = <span class="tok-kw">while</span> (<span class="tok-null">true</span>) {</span>
<span class="line" id="L3968">        <span class="tok-kw">const</span> rc = <span class="tok-kw">if</span> (have_accept4)</span>
<span class="line" id="L3969">            system.accept4(sock, addr, addr_size, flags)</span>
<span class="line" id="L3970">        <span class="tok-kw">else</span> <span class="tok-kw">if</span> (builtin.os.tag == .windows)</span>
<span class="line" id="L3971">            windows.accept(sock, addr, addr_size)</span>
<span class="line" id="L3972">        <span class="tok-kw">else</span></span>
<span class="line" id="L3973">            system.accept(sock, addr, addr_size);</span>
<span class="line" id="L3974"></span>
<span class="line" id="L3975">        <span class="tok-kw">if</span> (builtin.os.tag == .windows) {</span>
<span class="line" id="L3976">            <span class="tok-kw">if</span> (rc == windows.ws2_32.INVALID_SOCKET) {</span>
<span class="line" id="L3977">                <span class="tok-kw">switch</span> (windows.ws2_32.WSAGetLastError()) {</span>
<span class="line" id="L3978">                    .WSANOTINITIALISED =&gt; <span class="tok-kw">unreachable</span>, <span class="tok-comment">// not initialized WSA</span>
</span>
<span class="line" id="L3979">                    .WSAECONNRESET =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.ConnectionResetByPeer,</span>
<span class="line" id="L3980">                    .WSAEFAULT =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L3981">                    .WSAEINVAL =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.SocketNotListening,</span>
<span class="line" id="L3982">                    .WSAEMFILE =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.ProcessFdQuotaExceeded,</span>
<span class="line" id="L3983">                    .WSAENETDOWN =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.NetworkSubsystemFailed,</span>
<span class="line" id="L3984">                    .WSAENOBUFS =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.FileDescriptorNotASocket,</span>
<span class="line" id="L3985">                    .WSAEOPNOTSUPP =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.OperationNotSupported,</span>
<span class="line" id="L3986">                    .WSAEWOULDBLOCK =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.WouldBlock,</span>
<span class="line" id="L3987">                    <span class="tok-kw">else</span> =&gt; |err| <span class="tok-kw">return</span> windows.unexpectedWSAError(err),</span>
<span class="line" id="L3988">                }</span>
<span class="line" id="L3989">            } <span class="tok-kw">else</span> {</span>
<span class="line" id="L3990">                <span class="tok-kw">break</span> rc;</span>
<span class="line" id="L3991">            }</span>
<span class="line" id="L3992">        } <span class="tok-kw">else</span> {</span>
<span class="line" id="L3993">            <span class="tok-kw">switch</span> (errno(rc)) {</span>
<span class="line" id="L3994">                .SUCCESS =&gt; <span class="tok-kw">break</span> <span class="tok-builtin">@intCast</span>(rc),</span>
<span class="line" id="L3995">                .INTR =&gt; <span class="tok-kw">continue</span>,</span>
<span class="line" id="L3996">                .AGAIN =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.WouldBlock,</span>
<span class="line" id="L3997">                .BADF =&gt; <span class="tok-kw">unreachable</span>, <span class="tok-comment">// always a race condition</span>
</span>
<span class="line" id="L3998">                .CONNABORTED =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.ConnectionAborted,</span>
<span class="line" id="L3999">                .FAULT =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L4000">                .INVAL =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.SocketNotListening,</span>
<span class="line" id="L4001">                .NOTSOCK =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L4002">                .MFILE =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.ProcessFdQuotaExceeded,</span>
<span class="line" id="L4003">                .NFILE =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.SystemFdQuotaExceeded,</span>
<span class="line" id="L4004">                .NOBUFS =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.SystemResources,</span>
<span class="line" id="L4005">                .NOMEM =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.SystemResources,</span>
<span class="line" id="L4006">                .OPNOTSUPP =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L4007">                .PROTO =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.ProtocolFailure,</span>
<span class="line" id="L4008">                .PERM =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.BlockedByFirewall,</span>
<span class="line" id="L4009">                <span class="tok-kw">else</span> =&gt; |err| <span class="tok-kw">return</span> unexpectedErrno(err),</span>
<span class="line" id="L4010">            }</span>
<span class="line" id="L4011">        }</span>
<span class="line" id="L4012">    };</span>
<span class="line" id="L4013"></span>
<span class="line" id="L4014">    <span class="tok-kw">errdefer</span> <span class="tok-kw">switch</span> (builtin.os.tag) {</span>
<span class="line" id="L4015">        .windows =&gt; windows.closesocket(accepted_sock) <span class="tok-kw">catch</span> <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L4016">        <span class="tok-kw">else</span> =&gt; close(accepted_sock),</span>
<span class="line" id="L4017">    };</span>
<span class="line" id="L4018">    <span class="tok-kw">if</span> (!have_accept4) {</span>
<span class="line" id="L4019">        <span class="tok-kw">try</span> setSockFlags(accepted_sock, flags);</span>
<span class="line" id="L4020">    }</span>
<span class="line" id="L4021">    <span class="tok-kw">return</span> accepted_sock;</span>
<span class="line" id="L4022">}</span>
<span class="line" id="L4023"></span>
<span class="line" id="L4024"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> EpollCreateError = <span class="tok-kw">error</span>{</span>
<span class="line" id="L4025">    <span class="tok-comment">/// The  per-user   limit   on   the   number   of   epoll   instances   imposed   by</span></span>
<span class="line" id="L4026">    <span class="tok-comment">/// /proc/sys/fs/epoll/max_user_instances  was encountered.  See epoll(7) for further</span></span>
<span class="line" id="L4027">    <span class="tok-comment">/// details.</span></span>
<span class="line" id="L4028">    <span class="tok-comment">/// Or, The per-process limit on the number of open file descriptors has been reached.</span></span>
<span class="line" id="L4029">    ProcessFdQuotaExceeded,</span>
<span class="line" id="L4030"></span>
<span class="line" id="L4031">    <span class="tok-comment">/// The system-wide limit on the total number of open files has been reached.</span></span>
<span class="line" id="L4032">    SystemFdQuotaExceeded,</span>
<span class="line" id="L4033"></span>
<span class="line" id="L4034">    <span class="tok-comment">/// There was insufficient memory to create the kernel object.</span></span>
<span class="line" id="L4035">    SystemResources,</span>
<span class="line" id="L4036">} || UnexpectedError;</span>
<span class="line" id="L4037"></span>
<span class="line" id="L4038"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">epoll_create1</span>(flags: <span class="tok-type">u32</span>) EpollCreateError!<span class="tok-type">i32</span> {</span>
<span class="line" id="L4039">    <span class="tok-kw">const</span> rc = system.epoll_create1(flags);</span>
<span class="line" id="L4040">    <span class="tok-kw">switch</span> (errno(rc)) {</span>
<span class="line" id="L4041">        .SUCCESS =&gt; <span class="tok-kw">return</span> <span class="tok-builtin">@intCast</span>(rc),</span>
<span class="line" id="L4042">        <span class="tok-kw">else</span> =&gt; |err| <span class="tok-kw">return</span> unexpectedErrno(err),</span>
<span class="line" id="L4043"></span>
<span class="line" id="L4044">        .INVAL =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L4045">        .MFILE =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.ProcessFdQuotaExceeded,</span>
<span class="line" id="L4046">        .NFILE =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.SystemFdQuotaExceeded,</span>
<span class="line" id="L4047">        .NOMEM =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.SystemResources,</span>
<span class="line" id="L4048">    }</span>
<span class="line" id="L4049">}</span>
<span class="line" id="L4050"></span>
<span class="line" id="L4051"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> EpollCtlError = <span class="tok-kw">error</span>{</span>
<span class="line" id="L4052">    <span class="tok-comment">/// op was EPOLL_CTL_ADD, and the supplied file descriptor fd is  already  registered</span></span>
<span class="line" id="L4053">    <span class="tok-comment">/// with this epoll instance.</span></span>
<span class="line" id="L4054">    FileDescriptorAlreadyPresentInSet,</span>
<span class="line" id="L4055"></span>
<span class="line" id="L4056">    <span class="tok-comment">/// fd refers to an epoll instance and this EPOLL_CTL_ADD operation would result in a</span></span>
<span class="line" id="L4057">    <span class="tok-comment">/// circular loop of epoll instances monitoring one another.</span></span>
<span class="line" id="L4058">    OperationCausesCircularLoop,</span>
<span class="line" id="L4059"></span>
<span class="line" id="L4060">    <span class="tok-comment">/// op was EPOLL_CTL_MOD or EPOLL_CTL_DEL, and fd is not registered with  this  epoll</span></span>
<span class="line" id="L4061">    <span class="tok-comment">/// instance.</span></span>
<span class="line" id="L4062">    FileDescriptorNotRegistered,</span>
<span class="line" id="L4063"></span>
<span class="line" id="L4064">    <span class="tok-comment">/// There was insufficient memory to handle the requested op control operation.</span></span>
<span class="line" id="L4065">    SystemResources,</span>
<span class="line" id="L4066"></span>
<span class="line" id="L4067">    <span class="tok-comment">/// The  limit  imposed  by /proc/sys/fs/epoll/max_user_watches was encountered while</span></span>
<span class="line" id="L4068">    <span class="tok-comment">/// trying to register (EPOLL_CTL_ADD) a new file descriptor on  an  epoll  instance.</span></span>
<span class="line" id="L4069">    <span class="tok-comment">/// See epoll(7) for further details.</span></span>
<span class="line" id="L4070">    UserResourceLimitReached,</span>
<span class="line" id="L4071"></span>
<span class="line" id="L4072">    <span class="tok-comment">/// The target file fd does not support epoll.  This error can occur if fd refers to,</span></span>
<span class="line" id="L4073">    <span class="tok-comment">/// for example, a regular file or a directory.</span></span>
<span class="line" id="L4074">    FileDescriptorIncompatibleWithEpoll,</span>
<span class="line" id="L4075">} || UnexpectedError;</span>
<span class="line" id="L4076"></span>
<span class="line" id="L4077"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">epoll_ctl</span>(epfd: <span class="tok-type">i32</span>, op: <span class="tok-type">u32</span>, fd: <span class="tok-type">i32</span>, event: ?*linux.epoll_event) EpollCtlError!<span class="tok-type">void</span> {</span>
<span class="line" id="L4078">    <span class="tok-kw">const</span> rc = system.epoll_ctl(epfd, op, fd, event);</span>
<span class="line" id="L4079">    <span class="tok-kw">switch</span> (errno(rc)) {</span>
<span class="line" id="L4080">        .SUCCESS =&gt; <span class="tok-kw">return</span>,</span>
<span class="line" id="L4081">        <span class="tok-kw">else</span> =&gt; |err| <span class="tok-kw">return</span> unexpectedErrno(err),</span>
<span class="line" id="L4082"></span>
<span class="line" id="L4083">        .BADF =&gt; <span class="tok-kw">unreachable</span>, <span class="tok-comment">// always a race condition if this happens</span>
</span>
<span class="line" id="L4084">        .EXIST =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.FileDescriptorAlreadyPresentInSet,</span>
<span class="line" id="L4085">        .INVAL =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L4086">        .LOOP =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.OperationCausesCircularLoop,</span>
<span class="line" id="L4087">        .NOENT =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.FileDescriptorNotRegistered,</span>
<span class="line" id="L4088">        .NOMEM =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.SystemResources,</span>
<span class="line" id="L4089">        .NOSPC =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.UserResourceLimitReached,</span>
<span class="line" id="L4090">        .PERM =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.FileDescriptorIncompatibleWithEpoll,</span>
<span class="line" id="L4091">    }</span>
<span class="line" id="L4092">}</span>
<span class="line" id="L4093"></span>
<span class="line" id="L4094"><span class="tok-comment">/// Waits for an I/O event on an epoll file descriptor.</span></span>
<span class="line" id="L4095"><span class="tok-comment">/// Returns the number of file descriptors ready for the requested I/O,</span></span>
<span class="line" id="L4096"><span class="tok-comment">/// or zero if no file descriptor became ready during the requested timeout milliseconds.</span></span>
<span class="line" id="L4097"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">epoll_wait</span>(epfd: <span class="tok-type">i32</span>, events: []linux.epoll_event, timeout: <span class="tok-type">i32</span>) <span class="tok-type">usize</span> {</span>
<span class="line" id="L4098">    <span class="tok-kw">while</span> (<span class="tok-null">true</span>) {</span>
<span class="line" id="L4099">        <span class="tok-comment">// TODO get rid of the @intCast</span>
</span>
<span class="line" id="L4100">        <span class="tok-kw">const</span> rc = system.epoll_wait(epfd, events.ptr, <span class="tok-builtin">@intCast</span>(events.len), timeout);</span>
<span class="line" id="L4101">        <span class="tok-kw">switch</span> (errno(rc)) {</span>
<span class="line" id="L4102">            .SUCCESS =&gt; <span class="tok-kw">return</span> <span class="tok-builtin">@intCast</span>(rc),</span>
<span class="line" id="L4103">            .INTR =&gt; <span class="tok-kw">continue</span>,</span>
<span class="line" id="L4104">            .BADF =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L4105">            .FAULT =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L4106">            .INVAL =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L4107">            <span class="tok-kw">else</span> =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L4108">        }</span>
<span class="line" id="L4109">    }</span>
<span class="line" id="L4110">}</span>
<span class="line" id="L4111"></span>
<span class="line" id="L4112"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> EventFdError = <span class="tok-kw">error</span>{</span>
<span class="line" id="L4113">    SystemResources,</span>
<span class="line" id="L4114">    ProcessFdQuotaExceeded,</span>
<span class="line" id="L4115">    SystemFdQuotaExceeded,</span>
<span class="line" id="L4116">} || UnexpectedError;</span>
<span class="line" id="L4117"></span>
<span class="line" id="L4118"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">eventfd</span>(initval: <span class="tok-type">u32</span>, flags: <span class="tok-type">u32</span>) EventFdError!<span class="tok-type">i32</span> {</span>
<span class="line" id="L4119">    <span class="tok-kw">const</span> rc = system.eventfd(initval, flags);</span>
<span class="line" id="L4120">    <span class="tok-kw">switch</span> (errno(rc)) {</span>
<span class="line" id="L4121">        .SUCCESS =&gt; <span class="tok-kw">return</span> <span class="tok-builtin">@intCast</span>(rc),</span>
<span class="line" id="L4122">        <span class="tok-kw">else</span> =&gt; |err| <span class="tok-kw">return</span> unexpectedErrno(err),</span>
<span class="line" id="L4123"></span>
<span class="line" id="L4124">        .INVAL =&gt; <span class="tok-kw">unreachable</span>, <span class="tok-comment">// invalid parameters</span>
</span>
<span class="line" id="L4125">        .MFILE =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.ProcessFdQuotaExceeded,</span>
<span class="line" id="L4126">        .NFILE =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.SystemFdQuotaExceeded,</span>
<span class="line" id="L4127">        .NODEV =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.SystemResources,</span>
<span class="line" id="L4128">        .NOMEM =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.SystemResources,</span>
<span class="line" id="L4129">    }</span>
<span class="line" id="L4130">}</span>
<span class="line" id="L4131"></span>
<span class="line" id="L4132"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> GetSockNameError = <span class="tok-kw">error</span>{</span>
<span class="line" id="L4133">    <span class="tok-comment">/// Insufficient resources were available in the system to perform the operation.</span></span>
<span class="line" id="L4134">    SystemResources,</span>
<span class="line" id="L4135"></span>
<span class="line" id="L4136">    <span class="tok-comment">/// The network subsystem has failed.</span></span>
<span class="line" id="L4137">    NetworkSubsystemFailed,</span>
<span class="line" id="L4138"></span>
<span class="line" id="L4139">    <span class="tok-comment">/// Socket hasn't been bound yet</span></span>
<span class="line" id="L4140">    SocketNotBound,</span>
<span class="line" id="L4141"></span>
<span class="line" id="L4142">    FileDescriptorNotASocket,</span>
<span class="line" id="L4143">} || UnexpectedError;</span>
<span class="line" id="L4144"></span>
<span class="line" id="L4145"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">getsockname</span>(sock: socket_t, addr: *sockaddr, addrlen: *socklen_t) GetSockNameError!<span class="tok-type">void</span> {</span>
<span class="line" id="L4146">    <span class="tok-kw">if</span> (builtin.os.tag == .windows) {</span>
<span class="line" id="L4147">        <span class="tok-kw">const</span> rc = windows.getsockname(sock, addr, addrlen);</span>
<span class="line" id="L4148">        <span class="tok-kw">if</span> (rc == windows.ws2_32.SOCKET_ERROR) {</span>
<span class="line" id="L4149">            <span class="tok-kw">switch</span> (windows.ws2_32.WSAGetLastError()) {</span>
<span class="line" id="L4150">                .WSANOTINITIALISED =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L4151">                .WSAENETDOWN =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.NetworkSubsystemFailed,</span>
<span class="line" id="L4152">                .WSAEFAULT =&gt; <span class="tok-kw">unreachable</span>, <span class="tok-comment">// addr or addrlen have invalid pointers or addrlen points to an incorrect value</span>
</span>
<span class="line" id="L4153">                .WSAENOTSOCK =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.FileDescriptorNotASocket,</span>
<span class="line" id="L4154">                .WSAEINVAL =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.SocketNotBound,</span>
<span class="line" id="L4155">                <span class="tok-kw">else</span> =&gt; |err| <span class="tok-kw">return</span> windows.unexpectedWSAError(err),</span>
<span class="line" id="L4156">            }</span>
<span class="line" id="L4157">        }</span>
<span class="line" id="L4158">        <span class="tok-kw">return</span>;</span>
<span class="line" id="L4159">    } <span class="tok-kw">else</span> {</span>
<span class="line" id="L4160">        <span class="tok-kw">const</span> rc = system.getsockname(sock, addr, addrlen);</span>
<span class="line" id="L4161">        <span class="tok-kw">switch</span> (errno(rc)) {</span>
<span class="line" id="L4162">            .SUCCESS =&gt; <span class="tok-kw">return</span>,</span>
<span class="line" id="L4163">            <span class="tok-kw">else</span> =&gt; |err| <span class="tok-kw">return</span> unexpectedErrno(err),</span>
<span class="line" id="L4164"></span>
<span class="line" id="L4165">            .BADF =&gt; <span class="tok-kw">unreachable</span>, <span class="tok-comment">// always a race condition</span>
</span>
<span class="line" id="L4166">            .FAULT =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L4167">            .INVAL =&gt; <span class="tok-kw">unreachable</span>, <span class="tok-comment">// invalid parameters</span>
</span>
<span class="line" id="L4168">            .NOTSOCK =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.FileDescriptorNotASocket,</span>
<span class="line" id="L4169">            .NOBUFS =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.SystemResources,</span>
<span class="line" id="L4170">        }</span>
<span class="line" id="L4171">    }</span>
<span class="line" id="L4172">}</span>
<span class="line" id="L4173"></span>
<span class="line" id="L4174"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">getpeername</span>(sock: socket_t, addr: *sockaddr, addrlen: *socklen_t) GetSockNameError!<span class="tok-type">void</span> {</span>
<span class="line" id="L4175">    <span class="tok-kw">if</span> (builtin.os.tag == .windows) {</span>
<span class="line" id="L4176">        <span class="tok-kw">const</span> rc = windows.getpeername(sock, addr, addrlen);</span>
<span class="line" id="L4177">        <span class="tok-kw">if</span> (rc == windows.ws2_32.SOCKET_ERROR) {</span>
<span class="line" id="L4178">            <span class="tok-kw">switch</span> (windows.ws2_32.WSAGetLastError()) {</span>
<span class="line" id="L4179">                .WSANOTINITIALISED =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L4180">                .WSAENETDOWN =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.NetworkSubsystemFailed,</span>
<span class="line" id="L4181">                .WSAEFAULT =&gt; <span class="tok-kw">unreachable</span>, <span class="tok-comment">// addr or addrlen have invalid pointers or addrlen points to an incorrect value</span>
</span>
<span class="line" id="L4182">                .WSAENOTSOCK =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.FileDescriptorNotASocket,</span>
<span class="line" id="L4183">                .WSAEINVAL =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.SocketNotBound,</span>
<span class="line" id="L4184">                <span class="tok-kw">else</span> =&gt; |err| <span class="tok-kw">return</span> windows.unexpectedWSAError(err),</span>
<span class="line" id="L4185">            }</span>
<span class="line" id="L4186">        }</span>
<span class="line" id="L4187">        <span class="tok-kw">return</span>;</span>
<span class="line" id="L4188">    } <span class="tok-kw">else</span> {</span>
<span class="line" id="L4189">        <span class="tok-kw">const</span> rc = system.getpeername(sock, addr, addrlen);</span>
<span class="line" id="L4190">        <span class="tok-kw">switch</span> (errno(rc)) {</span>
<span class="line" id="L4191">            .SUCCESS =&gt; <span class="tok-kw">return</span>,</span>
<span class="line" id="L4192">            <span class="tok-kw">else</span> =&gt; |err| <span class="tok-kw">return</span> unexpectedErrno(err),</span>
<span class="line" id="L4193"></span>
<span class="line" id="L4194">            .BADF =&gt; <span class="tok-kw">unreachable</span>, <span class="tok-comment">// always a race condition</span>
</span>
<span class="line" id="L4195">            .FAULT =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L4196">            .INVAL =&gt; <span class="tok-kw">unreachable</span>, <span class="tok-comment">// invalid parameters</span>
</span>
<span class="line" id="L4197">            .NOTSOCK =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.FileDescriptorNotASocket,</span>
<span class="line" id="L4198">            .NOBUFS =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.SystemResources,</span>
<span class="line" id="L4199">        }</span>
<span class="line" id="L4200">    }</span>
<span class="line" id="L4201">}</span>
<span class="line" id="L4202"></span>
<span class="line" id="L4203"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> ConnectError = <span class="tok-kw">error</span>{</span>
<span class="line" id="L4204">    <span class="tok-comment">/// For UNIX domain sockets, which are identified by pathname: Write permission is denied on  the  socket</span></span>
<span class="line" id="L4205">    <span class="tok-comment">/// file,  or  search  permission  is  denied  for  one of the directories in the path prefix.</span></span>
<span class="line" id="L4206">    <span class="tok-comment">/// or</span></span>
<span class="line" id="L4207">    <span class="tok-comment">/// The user tried to connect to a broadcast address without having the socket broadcast flag enabled  or</span></span>
<span class="line" id="L4208">    <span class="tok-comment">/// the connection request failed because of a local firewall rule.</span></span>
<span class="line" id="L4209">    PermissionDenied,</span>
<span class="line" id="L4210"></span>
<span class="line" id="L4211">    <span class="tok-comment">/// Local address is already in use.</span></span>
<span class="line" id="L4212">    AddressInUse,</span>
<span class="line" id="L4213"></span>
<span class="line" id="L4214">    <span class="tok-comment">/// (Internet  domain  sockets)  The  socket  referred  to  by sockfd had not previously been bound to an</span></span>
<span class="line" id="L4215">    <span class="tok-comment">/// address and, upon attempting to bind it to an ephemeral port, it was determined that all port numbers</span></span>
<span class="line" id="L4216">    <span class="tok-comment">/// in    the    ephemeral    port    range    are   currently   in   use.    See   the   discussion   of</span></span>
<span class="line" id="L4217">    <span class="tok-comment">/// /proc/sys/net/ipv4/ip_local_port_range in ip(7).</span></span>
<span class="line" id="L4218">    AddressNotAvailable,</span>
<span class="line" id="L4219"></span>
<span class="line" id="L4220">    <span class="tok-comment">/// The passed address didn't have the correct address family in its sa_family field.</span></span>
<span class="line" id="L4221">    AddressFamilyNotSupported,</span>
<span class="line" id="L4222"></span>
<span class="line" id="L4223">    <span class="tok-comment">/// Insufficient entries in the routing cache.</span></span>
<span class="line" id="L4224">    SystemResources,</span>
<span class="line" id="L4225"></span>
<span class="line" id="L4226">    <span class="tok-comment">/// A connect() on a stream socket found no one listening on the remote address.</span></span>
<span class="line" id="L4227">    ConnectionRefused,</span>
<span class="line" id="L4228"></span>
<span class="line" id="L4229">    <span class="tok-comment">/// Network is unreachable.</span></span>
<span class="line" id="L4230">    NetworkUnreachable,</span>
<span class="line" id="L4231"></span>
<span class="line" id="L4232">    <span class="tok-comment">/// Timeout  while  attempting  connection.   The server may be too busy to accept new connections.  Note</span></span>
<span class="line" id="L4233">    <span class="tok-comment">/// that for IP sockets the timeout may be very long when syncookies are enabled on the server.</span></span>
<span class="line" id="L4234">    ConnectionTimedOut,</span>
<span class="line" id="L4235"></span>
<span class="line" id="L4236">    <span class="tok-comment">/// This error occurs when no global event loop is configured,</span></span>
<span class="line" id="L4237">    <span class="tok-comment">/// and connecting to the socket would block.</span></span>
<span class="line" id="L4238">    WouldBlock,</span>
<span class="line" id="L4239"></span>
<span class="line" id="L4240">    <span class="tok-comment">/// The given path for the unix socket does not exist.</span></span>
<span class="line" id="L4241">    FileNotFound,</span>
<span class="line" id="L4242"></span>
<span class="line" id="L4243">    <span class="tok-comment">/// Connection was reset by peer before connect could complete.</span></span>
<span class="line" id="L4244">    ConnectionResetByPeer,</span>
<span class="line" id="L4245"></span>
<span class="line" id="L4246">    <span class="tok-comment">/// Socket is non-blocking and already has a pending connection in progress.</span></span>
<span class="line" id="L4247">    ConnectionPending,</span>
<span class="line" id="L4248">} || UnexpectedError;</span>
<span class="line" id="L4249"></span>
<span class="line" id="L4250"><span class="tok-comment">/// Initiate a connection on a socket.</span></span>
<span class="line" id="L4251"><span class="tok-comment">/// If `sockfd` is opened in non blocking mode, the function will</span></span>
<span class="line" id="L4252"><span class="tok-comment">/// return error.WouldBlock when EAGAIN or EINPROGRESS is received.</span></span>
<span class="line" id="L4253"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">connect</span>(sock: socket_t, sock_addr: *<span class="tok-kw">const</span> sockaddr, len: socklen_t) ConnectError!<span class="tok-type">void</span> {</span>
<span class="line" id="L4254">    <span class="tok-kw">if</span> (builtin.os.tag == .windows) {</span>
<span class="line" id="L4255">        <span class="tok-kw">const</span> rc = windows.ws2_32.connect(sock, sock_addr, <span class="tok-builtin">@intCast</span>(len));</span>
<span class="line" id="L4256">        <span class="tok-kw">if</span> (rc == <span class="tok-number">0</span>) <span class="tok-kw">return</span>;</span>
<span class="line" id="L4257">        <span class="tok-kw">switch</span> (windows.ws2_32.WSAGetLastError()) {</span>
<span class="line" id="L4258">            .WSAEADDRINUSE =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.AddressInUse,</span>
<span class="line" id="L4259">            .WSAEADDRNOTAVAIL =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.AddressNotAvailable,</span>
<span class="line" id="L4260">            .WSAECONNREFUSED =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.ConnectionRefused,</span>
<span class="line" id="L4261">            .WSAECONNRESET =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.ConnectionResetByPeer,</span>
<span class="line" id="L4262">            .WSAETIMEDOUT =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.ConnectionTimedOut,</span>
<span class="line" id="L4263">            .WSAEHOSTUNREACH, <span class="tok-comment">// TODO: should we return NetworkUnreachable in this case as well?</span>
</span>
<span class="line" id="L4264">            .WSAENETUNREACH,</span>
<span class="line" id="L4265">            =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.NetworkUnreachable,</span>
<span class="line" id="L4266">            .WSAEFAULT =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L4267">            .WSAEINVAL =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L4268">            .WSAEISCONN =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L4269">            .WSAENOTSOCK =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L4270">            .WSAEWOULDBLOCK =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.WouldBlock,</span>
<span class="line" id="L4271">            .WSAEACCES =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L4272">            .WSAENOBUFS =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.SystemResources,</span>
<span class="line" id="L4273">            .WSAEAFNOSUPPORT =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.AddressFamilyNotSupported,</span>
<span class="line" id="L4274">            <span class="tok-kw">else</span> =&gt; |err| <span class="tok-kw">return</span> windows.unexpectedWSAError(err),</span>
<span class="line" id="L4275">        }</span>
<span class="line" id="L4276">        <span class="tok-kw">return</span>;</span>
<span class="line" id="L4277">    }</span>
<span class="line" id="L4278"></span>
<span class="line" id="L4279">    <span class="tok-kw">while</span> (<span class="tok-null">true</span>) {</span>
<span class="line" id="L4280">        <span class="tok-kw">switch</span> (errno(system.connect(sock, sock_addr, len))) {</span>
<span class="line" id="L4281">            .SUCCESS =&gt; <span class="tok-kw">return</span>,</span>
<span class="line" id="L4282">            .ACCES =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.PermissionDenied,</span>
<span class="line" id="L4283">            .PERM =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.PermissionDenied,</span>
<span class="line" id="L4284">            .ADDRINUSE =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.AddressInUse,</span>
<span class="line" id="L4285">            .ADDRNOTAVAIL =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.AddressNotAvailable,</span>
<span class="line" id="L4286">            .AFNOSUPPORT =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.AddressFamilyNotSupported,</span>
<span class="line" id="L4287">            .AGAIN, .INPROGRESS =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.WouldBlock,</span>
<span class="line" id="L4288">            .ALREADY =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.ConnectionPending,</span>
<span class="line" id="L4289">            .BADF =&gt; <span class="tok-kw">unreachable</span>, <span class="tok-comment">// sockfd is not a valid open file descriptor.</span>
</span>
<span class="line" id="L4290">            .CONNREFUSED =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.ConnectionRefused,</span>
<span class="line" id="L4291">            .CONNRESET =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.ConnectionResetByPeer,</span>
<span class="line" id="L4292">            .FAULT =&gt; <span class="tok-kw">unreachable</span>, <span class="tok-comment">// The socket structure address is outside the user's address space.</span>
</span>
<span class="line" id="L4293">            .INTR =&gt; <span class="tok-kw">continue</span>,</span>
<span class="line" id="L4294">            .ISCONN =&gt; <span class="tok-kw">unreachable</span>, <span class="tok-comment">// The socket is already connected.</span>
</span>
<span class="line" id="L4295">            .HOSTUNREACH =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.NetworkUnreachable,</span>
<span class="line" id="L4296">            .NETUNREACH =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.NetworkUnreachable,</span>
<span class="line" id="L4297">            .NOTSOCK =&gt; <span class="tok-kw">unreachable</span>, <span class="tok-comment">// The file descriptor sockfd does not refer to a socket.</span>
</span>
<span class="line" id="L4298">            .PROTOTYPE =&gt; <span class="tok-kw">unreachable</span>, <span class="tok-comment">// The socket type does not support the requested communications protocol.</span>
</span>
<span class="line" id="L4299">            .TIMEDOUT =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.ConnectionTimedOut,</span>
<span class="line" id="L4300">            .NOENT =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.FileNotFound, <span class="tok-comment">// Returned when socket is AF.UNIX and the given path does not exist.</span>
</span>
<span class="line" id="L4301">            .CONNABORTED =&gt; <span class="tok-kw">unreachable</span>, <span class="tok-comment">// Tried to reuse socket that previously received error.ConnectionRefused.</span>
</span>
<span class="line" id="L4302">            <span class="tok-kw">else</span> =&gt; |err| <span class="tok-kw">return</span> unexpectedErrno(err),</span>
<span class="line" id="L4303">        }</span>
<span class="line" id="L4304">    }</span>
<span class="line" id="L4305">}</span>
<span class="line" id="L4306"></span>
<span class="line" id="L4307"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">getsockoptError</span>(sockfd: fd_t) ConnectError!<span class="tok-type">void</span> {</span>
<span class="line" id="L4308">    <span class="tok-kw">var</span> err_code: <span class="tok-type">i32</span> = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L4309">    <span class="tok-kw">var</span> size: <span class="tok-type">u32</span> = <span class="tok-builtin">@sizeOf</span>(<span class="tok-type">u32</span>);</span>
<span class="line" id="L4310">    <span class="tok-kw">const</span> rc = system.getsockopt(sockfd, SOL.SOCKET, SO.ERROR, <span class="tok-builtin">@ptrCast</span>(&amp;err_code), &amp;size);</span>
<span class="line" id="L4311">    assert(size == <span class="tok-number">4</span>);</span>
<span class="line" id="L4312">    <span class="tok-kw">switch</span> (errno(rc)) {</span>
<span class="line" id="L4313">        .SUCCESS =&gt; <span class="tok-kw">switch</span> (<span class="tok-builtin">@as</span>(E, <span class="tok-builtin">@enumFromInt</span>(err_code))) {</span>
<span class="line" id="L4314">            .SUCCESS =&gt; <span class="tok-kw">return</span>,</span>
<span class="line" id="L4315">            .ACCES =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.PermissionDenied,</span>
<span class="line" id="L4316">            .PERM =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.PermissionDenied,</span>
<span class="line" id="L4317">            .ADDRINUSE =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.AddressInUse,</span>
<span class="line" id="L4318">            .ADDRNOTAVAIL =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.AddressNotAvailable,</span>
<span class="line" id="L4319">            .AFNOSUPPORT =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.AddressFamilyNotSupported,</span>
<span class="line" id="L4320">            .AGAIN =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.SystemResources,</span>
<span class="line" id="L4321">            .ALREADY =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.ConnectionPending,</span>
<span class="line" id="L4322">            .BADF =&gt; <span class="tok-kw">unreachable</span>, <span class="tok-comment">// sockfd is not a valid open file descriptor.</span>
</span>
<span class="line" id="L4323">            .CONNREFUSED =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.ConnectionRefused,</span>
<span class="line" id="L4324">            .FAULT =&gt; <span class="tok-kw">unreachable</span>, <span class="tok-comment">// The socket structure address is outside the user's address space.</span>
</span>
<span class="line" id="L4325">            .ISCONN =&gt; <span class="tok-kw">unreachable</span>, <span class="tok-comment">// The socket is already connected.</span>
</span>
<span class="line" id="L4326">            .HOSTUNREACH =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.NetworkUnreachable,</span>
<span class="line" id="L4327">            .NETUNREACH =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.NetworkUnreachable,</span>
<span class="line" id="L4328">            .NOTSOCK =&gt; <span class="tok-kw">unreachable</span>, <span class="tok-comment">// The file descriptor sockfd does not refer to a socket.</span>
</span>
<span class="line" id="L4329">            .PROTOTYPE =&gt; <span class="tok-kw">unreachable</span>, <span class="tok-comment">// The socket type does not support the requested communications protocol.</span>
</span>
<span class="line" id="L4330">            .TIMEDOUT =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.ConnectionTimedOut,</span>
<span class="line" id="L4331">            .CONNRESET =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.ConnectionResetByPeer,</span>
<span class="line" id="L4332">            <span class="tok-kw">else</span> =&gt; |err| <span class="tok-kw">return</span> unexpectedErrno(err),</span>
<span class="line" id="L4333">        },</span>
<span class="line" id="L4334">        .BADF =&gt; <span class="tok-kw">unreachable</span>, <span class="tok-comment">// The argument sockfd is not a valid file descriptor.</span>
</span>
<span class="line" id="L4335">        .FAULT =&gt; <span class="tok-kw">unreachable</span>, <span class="tok-comment">// The address pointed to by optval or optlen is not in a valid part of the process address space.</span>
</span>
<span class="line" id="L4336">        .INVAL =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L4337">        .NOPROTOOPT =&gt; <span class="tok-kw">unreachable</span>, <span class="tok-comment">// The option is unknown at the level indicated.</span>
</span>
<span class="line" id="L4338">        .NOTSOCK =&gt; <span class="tok-kw">unreachable</span>, <span class="tok-comment">// The file descriptor sockfd does not refer to a socket.</span>
</span>
<span class="line" id="L4339">        <span class="tok-kw">else</span> =&gt; |err| <span class="tok-kw">return</span> unexpectedErrno(err),</span>
<span class="line" id="L4340">    }</span>
<span class="line" id="L4341">}</span>
<span class="line" id="L4342"></span>
<span class="line" id="L4343"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> WaitPidResult = <span class="tok-kw">struct</span> {</span>
<span class="line" id="L4344">    pid: pid_t,</span>
<span class="line" id="L4345">    status: <span class="tok-type">u32</span>,</span>
<span class="line" id="L4346">};</span>
<span class="line" id="L4347"></span>
<span class="line" id="L4348"><span class="tok-comment">/// Use this version of the `waitpid` wrapper if you spawned your child process using explicit</span></span>
<span class="line" id="L4349"><span class="tok-comment">/// `fork` and `execve` method.</span></span>
<span class="line" id="L4350"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">waitpid</span>(pid: pid_t, flags: <span class="tok-type">u32</span>) WaitPidResult {</span>
<span class="line" id="L4351">    <span class="tok-kw">var</span> status: <span class="tok-kw">if</span> (builtin.link_libc) <span class="tok-type">c_int</span> <span class="tok-kw">else</span> <span class="tok-type">u32</span> = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L4352">    <span class="tok-kw">while</span> (<span class="tok-null">true</span>) {</span>
<span class="line" id="L4353">        <span class="tok-kw">const</span> rc = system.waitpid(pid, &amp;status, <span class="tok-builtin">@intCast</span>(flags));</span>
<span class="line" id="L4354">        <span class="tok-kw">switch</span> (errno(rc)) {</span>
<span class="line" id="L4355">            .SUCCESS =&gt; <span class="tok-kw">return</span> .{</span>
<span class="line" id="L4356">                .pid = <span class="tok-builtin">@intCast</span>(rc),</span>
<span class="line" id="L4357">                .status = <span class="tok-builtin">@bitCast</span>(status),</span>
<span class="line" id="L4358">            },</span>
<span class="line" id="L4359">            .INTR =&gt; <span class="tok-kw">continue</span>,</span>
<span class="line" id="L4360">            .CHILD =&gt; <span class="tok-kw">unreachable</span>, <span class="tok-comment">// The process specified does not exist. It would be a race condition to handle this error.</span>
</span>
<span class="line" id="L4361">            .INVAL =&gt; <span class="tok-kw">unreachable</span>, <span class="tok-comment">// Invalid flags.</span>
</span>
<span class="line" id="L4362">            <span class="tok-kw">else</span> =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L4363">        }</span>
<span class="line" id="L4364">    }</span>
<span class="line" id="L4365">}</span>
<span class="line" id="L4366"></span>
<span class="line" id="L4367"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">wait4</span>(pid: pid_t, flags: <span class="tok-type">u32</span>, ru: ?*rusage) WaitPidResult {</span>
<span class="line" id="L4368">    <span class="tok-kw">var</span> status: <span class="tok-kw">if</span> (builtin.link_libc) <span class="tok-type">c_int</span> <span class="tok-kw">else</span> <span class="tok-type">u32</span> = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L4369">    <span class="tok-kw">while</span> (<span class="tok-null">true</span>) {</span>
<span class="line" id="L4370">        <span class="tok-kw">const</span> rc = system.wait4(pid, &amp;status, <span class="tok-builtin">@intCast</span>(flags), ru);</span>
<span class="line" id="L4371">        <span class="tok-kw">switch</span> (errno(rc)) {</span>
<span class="line" id="L4372">            .SUCCESS =&gt; <span class="tok-kw">return</span> .{</span>
<span class="line" id="L4373">                .pid = <span class="tok-builtin">@intCast</span>(rc),</span>
<span class="line" id="L4374">                .status = <span class="tok-builtin">@bitCast</span>(status),</span>
<span class="line" id="L4375">            },</span>
<span class="line" id="L4376">            .INTR =&gt; <span class="tok-kw">continue</span>,</span>
<span class="line" id="L4377">            .CHILD =&gt; <span class="tok-kw">unreachable</span>, <span class="tok-comment">// The process specified does not exist. It would be a race condition to handle this error.</span>
</span>
<span class="line" id="L4378">            .INVAL =&gt; <span class="tok-kw">unreachable</span>, <span class="tok-comment">// Invalid flags.</span>
</span>
<span class="line" id="L4379">            <span class="tok-kw">else</span> =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L4380">        }</span>
<span class="line" id="L4381">    }</span>
<span class="line" id="L4382">}</span>
<span class="line" id="L4383"></span>
<span class="line" id="L4384"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FStatError = <span class="tok-kw">error</span>{</span>
<span class="line" id="L4385">    SystemResources,</span>
<span class="line" id="L4386"></span>
<span class="line" id="L4387">    <span class="tok-comment">/// In WASI, this error may occur when the file descriptor does</span></span>
<span class="line" id="L4388">    <span class="tok-comment">/// not hold the required rights to get its filestat information.</span></span>
<span class="line" id="L4389">    AccessDenied,</span>
<span class="line" id="L4390">} || UnexpectedError;</span>
<span class="line" id="L4391"></span>
<span class="line" id="L4392"><span class="tok-comment">/// Return information about a file descriptor.</span></span>
<span class="line" id="L4393"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">fstat</span>(fd: fd_t) FStatError!Stat {</span>
<span class="line" id="L4394">    <span class="tok-kw">if</span> (builtin.os.tag == .wasi <span class="tok-kw">and</span> !builtin.link_libc) {</span>
<span class="line" id="L4395">        <span class="tok-kw">return</span> Stat.fromFilestat(<span class="tok-kw">try</span> fstat_wasi(fd));</span>
<span class="line" id="L4396">    }</span>
<span class="line" id="L4397">    <span class="tok-kw">if</span> (builtin.os.tag == .windows) {</span>
<span class="line" id="L4398">        <span class="tok-builtin">@compileError</span>(<span class="tok-str">&quot;fstat is not yet implemented on Windows&quot;</span>);</span>
<span class="line" id="L4399">    }</span>
<span class="line" id="L4400"></span>
<span class="line" id="L4401">    <span class="tok-kw">const</span> fstat_sym = <span class="tok-kw">if</span> (lfs64_abi) system.fstat64 <span class="tok-kw">else</span> system.fstat;</span>
<span class="line" id="L4402">    <span class="tok-kw">var</span> stat = mem.zeroes(Stat);</span>
<span class="line" id="L4403">    <span class="tok-kw">switch</span> (errno(fstat_sym(fd, &amp;stat))) {</span>
<span class="line" id="L4404">        .SUCCESS =&gt; <span class="tok-kw">return</span> stat,</span>
<span class="line" id="L4405">        .INVAL =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L4406">        .BADF =&gt; <span class="tok-kw">unreachable</span>, <span class="tok-comment">// Always a race condition.</span>
</span>
<span class="line" id="L4407">        .NOMEM =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.SystemResources,</span>
<span class="line" id="L4408">        .ACCES =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.AccessDenied,</span>
<span class="line" id="L4409">        <span class="tok-kw">else</span> =&gt; |err| <span class="tok-kw">return</span> unexpectedErrno(err),</span>
<span class="line" id="L4410">    }</span>
<span class="line" id="L4411">}</span>
<span class="line" id="L4412"></span>
<span class="line" id="L4413"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">fstat_wasi</span>(fd: fd_t) FStatError!wasi.filestat_t {</span>
<span class="line" id="L4414">    <span class="tok-kw">var</span> stat: wasi.filestat_t = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L4415">    <span class="tok-kw">switch</span> (wasi.fd_filestat_get(fd, &amp;stat)) {</span>
<span class="line" id="L4416">        .SUCCESS =&gt; <span class="tok-kw">return</span> stat,</span>
<span class="line" id="L4417">        .INVAL =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L4418">        .BADF =&gt; <span class="tok-kw">unreachable</span>, <span class="tok-comment">// Always a race condition.</span>
</span>
<span class="line" id="L4419">        .NOMEM =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.SystemResources,</span>
<span class="line" id="L4420">        .ACCES =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.AccessDenied,</span>
<span class="line" id="L4421">        .NOTCAPABLE =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.AccessDenied,</span>
<span class="line" id="L4422">        <span class="tok-kw">else</span> =&gt; |err| <span class="tok-kw">return</span> unexpectedErrno(err),</span>
<span class="line" id="L4423">    }</span>
<span class="line" id="L4424">}</span>
<span class="line" id="L4425"></span>
<span class="line" id="L4426"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FStatAtError = FStatError || <span class="tok-kw">error</span>{</span>
<span class="line" id="L4427">    NameTooLong,</span>
<span class="line" id="L4428">    FileNotFound,</span>
<span class="line" id="L4429">    SymLinkLoop,</span>
<span class="line" id="L4430">    <span class="tok-comment">/// WASI-only; file paths must be valid UTF-8.</span></span>
<span class="line" id="L4431">    InvalidUtf8,</span>
<span class="line" id="L4432">};</span>
<span class="line" id="L4433"></span>
<span class="line" id="L4434"><span class="tok-comment">/// Similar to `fstat`, but returns stat of a resource pointed to by `pathname`</span></span>
<span class="line" id="L4435"><span class="tok-comment">/// which is relative to `dirfd` handle.</span></span>
<span class="line" id="L4436"><span class="tok-comment">/// On WASI, `pathname` should be encoded as valid UTF-8.</span></span>
<span class="line" id="L4437"><span class="tok-comment">/// On other platforms, `pathname` is an opaque sequence of bytes with no particular encoding.</span></span>
<span class="line" id="L4438"><span class="tok-comment">/// See also `fstatatZ` and `fstatat_wasi`.</span></span>
<span class="line" id="L4439"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">fstatat</span>(dirfd: fd_t, pathname: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>, flags: <span class="tok-type">u32</span>) FStatAtError!Stat {</span>
<span class="line" id="L4440">    <span class="tok-kw">if</span> (builtin.os.tag == .wasi <span class="tok-kw">and</span> !builtin.link_libc) {</span>
<span class="line" id="L4441">        <span class="tok-kw">const</span> filestat = <span class="tok-kw">try</span> fstatat_wasi(dirfd, pathname, .{</span>
<span class="line" id="L4442">            .SYMLINK_FOLLOW = (flags &amp; AT.SYMLINK_NOFOLLOW) == <span class="tok-number">0</span>,</span>
<span class="line" id="L4443">        });</span>
<span class="line" id="L4444">        <span class="tok-kw">return</span> Stat.fromFilestat(filestat);</span>
<span class="line" id="L4445">    } <span class="tok-kw">else</span> <span class="tok-kw">if</span> (builtin.os.tag == .windows) {</span>
<span class="line" id="L4446">        <span class="tok-builtin">@compileError</span>(<span class="tok-str">&quot;fstatat is not yet implemented on Windows&quot;</span>);</span>
<span class="line" id="L4447">    } <span class="tok-kw">else</span> {</span>
<span class="line" id="L4448">        <span class="tok-kw">const</span> pathname_c = <span class="tok-kw">try</span> toPosixPath(pathname);</span>
<span class="line" id="L4449">        <span class="tok-kw">return</span> fstatatZ(dirfd, &amp;pathname_c, flags);</span>
<span class="line" id="L4450">    }</span>
<span class="line" id="L4451">}</span>
<span class="line" id="L4452"></span>
<span class="line" id="L4453"><span class="tok-comment">/// WASI-only. Same as `fstatat` but targeting WASI.</span></span>
<span class="line" id="L4454"><span class="tok-comment">/// `pathname` should be encoded as valid UTF-8.</span></span>
<span class="line" id="L4455"><span class="tok-comment">/// See also `fstatat`.</span></span>
<span class="line" id="L4456"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">fstatat_wasi</span>(dirfd: fd_t, pathname: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>, flags: wasi.lookupflags_t) FStatAtError!wasi.filestat_t {</span>
<span class="line" id="L4457">    <span class="tok-kw">var</span> stat: wasi.filestat_t = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L4458">    <span class="tok-kw">switch</span> (wasi.path_filestat_get(dirfd, flags, pathname.ptr, pathname.len, &amp;stat)) {</span>
<span class="line" id="L4459">        .SUCCESS =&gt; <span class="tok-kw">return</span> stat,</span>
<span class="line" id="L4460">        .INVAL =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L4461">        .BADF =&gt; <span class="tok-kw">unreachable</span>, <span class="tok-comment">// Always a race condition.</span>
</span>
<span class="line" id="L4462">        .NOMEM =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.SystemResources,</span>
<span class="line" id="L4463">        .ACCES =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.AccessDenied,</span>
<span class="line" id="L4464">        .FAULT =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L4465">        .NAMETOOLONG =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.NameTooLong,</span>
<span class="line" id="L4466">        .NOENT =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.FileNotFound,</span>
<span class="line" id="L4467">        .NOTDIR =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.FileNotFound,</span>
<span class="line" id="L4468">        .NOTCAPABLE =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.AccessDenied,</span>
<span class="line" id="L4469">        .ILSEQ =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.InvalidUtf8,</span>
<span class="line" id="L4470">        <span class="tok-kw">else</span> =&gt; |err| <span class="tok-kw">return</span> unexpectedErrno(err),</span>
<span class="line" id="L4471">    }</span>
<span class="line" id="L4472">}</span>
<span class="line" id="L4473"></span>
<span class="line" id="L4474"><span class="tok-comment">/// Same as `fstatat` but `pathname` is null-terminated.</span></span>
<span class="line" id="L4475"><span class="tok-comment">/// See also `fstatat`.</span></span>
<span class="line" id="L4476"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">fstatatZ</span>(dirfd: fd_t, pathname: [*:<span class="tok-number">0</span>]<span class="tok-kw">const</span> <span class="tok-type">u8</span>, flags: <span class="tok-type">u32</span>) FStatAtError!Stat {</span>
<span class="line" id="L4477">    <span class="tok-kw">if</span> (builtin.os.tag == .wasi <span class="tok-kw">and</span> !builtin.link_libc) {</span>
<span class="line" id="L4478">        <span class="tok-kw">const</span> filestat = <span class="tok-kw">try</span> fstatat_wasi(dirfd, mem.sliceTo(pathname, <span class="tok-number">0</span>), .{</span>
<span class="line" id="L4479">            .SYMLINK_FOLLOW = (flags &amp; AT.SYMLINK_NOFOLLOW) == <span class="tok-number">0</span>,</span>
<span class="line" id="L4480">        });</span>
<span class="line" id="L4481">        <span class="tok-kw">return</span> Stat.fromFilestat(filestat);</span>
<span class="line" id="L4482">    }</span>
<span class="line" id="L4483"></span>
<span class="line" id="L4484">    <span class="tok-kw">const</span> fstatat_sym = <span class="tok-kw">if</span> (lfs64_abi) system.fstatat64 <span class="tok-kw">else</span> system.fstatat;</span>
<span class="line" id="L4485">    <span class="tok-kw">var</span> stat = mem.zeroes(Stat);</span>
<span class="line" id="L4486">    <span class="tok-kw">switch</span> (errno(fstatat_sym(dirfd, pathname, &amp;stat, flags))) {</span>
<span class="line" id="L4487">        .SUCCESS =&gt; <span class="tok-kw">return</span> stat,</span>
<span class="line" id="L4488">        .INVAL =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L4489">        .BADF =&gt; <span class="tok-kw">unreachable</span>, <span class="tok-comment">// Always a race condition.</span>
</span>
<span class="line" id="L4490">        .NOMEM =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.SystemResources,</span>
<span class="line" id="L4491">        .ACCES =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.AccessDenied,</span>
<span class="line" id="L4492">        .PERM =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.AccessDenied,</span>
<span class="line" id="L4493">        .FAULT =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L4494">        .NAMETOOLONG =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.NameTooLong,</span>
<span class="line" id="L4495">        .LOOP =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.SymLinkLoop,</span>
<span class="line" id="L4496">        .NOENT =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.FileNotFound,</span>
<span class="line" id="L4497">        .NOTDIR =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.FileNotFound,</span>
<span class="line" id="L4498">        .ILSEQ =&gt; |err| <span class="tok-kw">if</span> (builtin.os.tag == .wasi)</span>
<span class="line" id="L4499">            <span class="tok-kw">return</span> <span class="tok-kw">error</span>.InvalidUtf8</span>
<span class="line" id="L4500">        <span class="tok-kw">else</span></span>
<span class="line" id="L4501">            <span class="tok-kw">return</span> unexpectedErrno(err),</span>
<span class="line" id="L4502">        <span class="tok-kw">else</span> =&gt; |err| <span class="tok-kw">return</span> unexpectedErrno(err),</span>
<span class="line" id="L4503">    }</span>
<span class="line" id="L4504">}</span>
<span class="line" id="L4505"></span>
<span class="line" id="L4506"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> KQueueError = <span class="tok-kw">error</span>{</span>
<span class="line" id="L4507">    <span class="tok-comment">/// The per-process limit on the number of open file descriptors has been reached.</span></span>
<span class="line" id="L4508">    ProcessFdQuotaExceeded,</span>
<span class="line" id="L4509"></span>
<span class="line" id="L4510">    <span class="tok-comment">/// The system-wide limit on the total number of open files has been reached.</span></span>
<span class="line" id="L4511">    SystemFdQuotaExceeded,</span>
<span class="line" id="L4512">} || UnexpectedError;</span>
<span class="line" id="L4513"></span>
<span class="line" id="L4514"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">kqueue</span>() KQueueError!<span class="tok-type">i32</span> {</span>
<span class="line" id="L4515">    <span class="tok-kw">const</span> rc = system.kqueue();</span>
<span class="line" id="L4516">    <span class="tok-kw">switch</span> (errno(rc)) {</span>
<span class="line" id="L4517">        .SUCCESS =&gt; <span class="tok-kw">return</span> <span class="tok-builtin">@intCast</span>(rc),</span>
<span class="line" id="L4518">        .MFILE =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.ProcessFdQuotaExceeded,</span>
<span class="line" id="L4519">        .NFILE =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.SystemFdQuotaExceeded,</span>
<span class="line" id="L4520">        <span class="tok-kw">else</span> =&gt; |err| <span class="tok-kw">return</span> unexpectedErrno(err),</span>
<span class="line" id="L4521">    }</span>
<span class="line" id="L4522">}</span>
<span class="line" id="L4523"></span>
<span class="line" id="L4524"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> KEventError = <span class="tok-kw">error</span>{</span>
<span class="line" id="L4525">    <span class="tok-comment">/// The process does not have permission to register a filter.</span></span>
<span class="line" id="L4526">    AccessDenied,</span>
<span class="line" id="L4527"></span>
<span class="line" id="L4528">    <span class="tok-comment">/// The event could not be found to be modified or deleted.</span></span>
<span class="line" id="L4529">    EventNotFound,</span>
<span class="line" id="L4530"></span>
<span class="line" id="L4531">    <span class="tok-comment">/// No memory was available to register the event.</span></span>
<span class="line" id="L4532">    SystemResources,</span>
<span class="line" id="L4533"></span>
<span class="line" id="L4534">    <span class="tok-comment">/// The specified process to attach to does not exist.</span></span>
<span class="line" id="L4535">    ProcessNotFound,</span>
<span class="line" id="L4536"></span>
<span class="line" id="L4537">    <span class="tok-comment">/// changelist or eventlist had too many items on it.</span></span>
<span class="line" id="L4538">    <span class="tok-comment">/// TODO remove this possibility</span></span>
<span class="line" id="L4539">    Overflow,</span>
<span class="line" id="L4540">};</span>
<span class="line" id="L4541"></span>
<span class="line" id="L4542"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">kevent</span>(</span>
<span class="line" id="L4543">    kq: <span class="tok-type">i32</span>,</span>
<span class="line" id="L4544">    changelist: []<span class="tok-kw">const</span> Kevent,</span>
<span class="line" id="L4545">    eventlist: []Kevent,</span>
<span class="line" id="L4546">    timeout: ?*<span class="tok-kw">const</span> timespec,</span>
<span class="line" id="L4547">) KEventError!<span class="tok-type">usize</span> {</span>
<span class="line" id="L4548">    <span class="tok-kw">while</span> (<span class="tok-null">true</span>) {</span>
<span class="line" id="L4549">        <span class="tok-kw">const</span> rc = system.kevent(</span>
<span class="line" id="L4550">            kq,</span>
<span class="line" id="L4551">            changelist.ptr,</span>
<span class="line" id="L4552">            math.cast(<span class="tok-type">c_int</span>, changelist.len) <span class="tok-kw">orelse</span> <span class="tok-kw">return</span> <span class="tok-kw">error</span>.Overflow,</span>
<span class="line" id="L4553">            eventlist.ptr,</span>
<span class="line" id="L4554">            math.cast(<span class="tok-type">c_int</span>, eventlist.len) <span class="tok-kw">orelse</span> <span class="tok-kw">return</span> <span class="tok-kw">error</span>.Overflow,</span>
<span class="line" id="L4555">            timeout,</span>
<span class="line" id="L4556">        );</span>
<span class="line" id="L4557">        <span class="tok-kw">switch</span> (errno(rc)) {</span>
<span class="line" id="L4558">            .SUCCESS =&gt; <span class="tok-kw">return</span> <span class="tok-builtin">@intCast</span>(rc),</span>
<span class="line" id="L4559">            .ACCES =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.AccessDenied,</span>
<span class="line" id="L4560">            .FAULT =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L4561">            .BADF =&gt; <span class="tok-kw">unreachable</span>, <span class="tok-comment">// Always a race condition.</span>
</span>
<span class="line" id="L4562">            .INTR =&gt; <span class="tok-kw">continue</span>,</span>
<span class="line" id="L4563">            .INVAL =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L4564">            .NOENT =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.EventNotFound,</span>
<span class="line" id="L4565">            .NOMEM =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.SystemResources,</span>
<span class="line" id="L4566">            .SRCH =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.ProcessNotFound,</span>
<span class="line" id="L4567">            <span class="tok-kw">else</span> =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L4568">        }</span>
<span class="line" id="L4569">    }</span>
<span class="line" id="L4570">}</span>
<span class="line" id="L4571"></span>
<span class="line" id="L4572"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> INotifyInitError = <span class="tok-kw">error</span>{</span>
<span class="line" id="L4573">    ProcessFdQuotaExceeded,</span>
<span class="line" id="L4574">    SystemFdQuotaExceeded,</span>
<span class="line" id="L4575">    SystemResources,</span>
<span class="line" id="L4576">} || UnexpectedError;</span>
<span class="line" id="L4577"></span>
<span class="line" id="L4578"><span class="tok-comment">/// initialize an inotify instance</span></span>
<span class="line" id="L4579"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">inotify_init1</span>(flags: <span class="tok-type">u32</span>) INotifyInitError!<span class="tok-type">i32</span> {</span>
<span class="line" id="L4580">    <span class="tok-kw">const</span> rc = system.inotify_init1(flags);</span>
<span class="line" id="L4581">    <span class="tok-kw">switch</span> (errno(rc)) {</span>
<span class="line" id="L4582">        .SUCCESS =&gt; <span class="tok-kw">return</span> <span class="tok-builtin">@intCast</span>(rc),</span>
<span class="line" id="L4583">        .INVAL =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L4584">        .MFILE =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.ProcessFdQuotaExceeded,</span>
<span class="line" id="L4585">        .NFILE =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.SystemFdQuotaExceeded,</span>
<span class="line" id="L4586">        .NOMEM =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.SystemResources,</span>
<span class="line" id="L4587">        <span class="tok-kw">else</span> =&gt; |err| <span class="tok-kw">return</span> unexpectedErrno(err),</span>
<span class="line" id="L4588">    }</span>
<span class="line" id="L4589">}</span>
<span class="line" id="L4590"></span>
<span class="line" id="L4591"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> INotifyAddWatchError = <span class="tok-kw">error</span>{</span>
<span class="line" id="L4592">    AccessDenied,</span>
<span class="line" id="L4593">    NameTooLong,</span>
<span class="line" id="L4594">    FileNotFound,</span>
<span class="line" id="L4595">    SystemResources,</span>
<span class="line" id="L4596">    UserResourceLimitReached,</span>
<span class="line" id="L4597">    NotDir,</span>
<span class="line" id="L4598">    WatchAlreadyExists,</span>
<span class="line" id="L4599">} || UnexpectedError;</span>
<span class="line" id="L4600"></span>
<span class="line" id="L4601"><span class="tok-comment">/// add a watch to an initialized inotify instance</span></span>
<span class="line" id="L4602"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">inotify_add_watch</span>(inotify_fd: <span class="tok-type">i32</span>, pathname: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>, mask: <span class="tok-type">u32</span>) INotifyAddWatchError!<span class="tok-type">i32</span> {</span>
<span class="line" id="L4603">    <span class="tok-kw">const</span> pathname_c = <span class="tok-kw">try</span> toPosixPath(pathname);</span>
<span class="line" id="L4604">    <span class="tok-kw">return</span> inotify_add_watchZ(inotify_fd, &amp;pathname_c, mask);</span>
<span class="line" id="L4605">}</span>
<span class="line" id="L4606"></span>
<span class="line" id="L4607"><span class="tok-comment">/// Same as `inotify_add_watch` except pathname is null-terminated.</span></span>
<span class="line" id="L4608"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">inotify_add_watchZ</span>(inotify_fd: <span class="tok-type">i32</span>, pathname: [*:<span class="tok-number">0</span>]<span class="tok-kw">const</span> <span class="tok-type">u8</span>, mask: <span class="tok-type">u32</span>) INotifyAddWatchError!<span class="tok-type">i32</span> {</span>
<span class="line" id="L4609">    <span class="tok-kw">const</span> rc = system.inotify_add_watch(inotify_fd, pathname, mask);</span>
<span class="line" id="L4610">    <span class="tok-kw">switch</span> (errno(rc)) {</span>
<span class="line" id="L4611">        .SUCCESS =&gt; <span class="tok-kw">return</span> <span class="tok-builtin">@intCast</span>(rc),</span>
<span class="line" id="L4612">        .ACCES =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.AccessDenied,</span>
<span class="line" id="L4613">        .BADF =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L4614">        .FAULT =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L4615">        .INVAL =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L4616">        .NAMETOOLONG =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.NameTooLong,</span>
<span class="line" id="L4617">        .NOENT =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.FileNotFound,</span>
<span class="line" id="L4618">        .NOMEM =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.SystemResources,</span>
<span class="line" id="L4619">        .NOSPC =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.UserResourceLimitReached,</span>
<span class="line" id="L4620">        .NOTDIR =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.NotDir,</span>
<span class="line" id="L4621">        .EXIST =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.WatchAlreadyExists,</span>
<span class="line" id="L4622">        <span class="tok-kw">else</span> =&gt; |err| <span class="tok-kw">return</span> unexpectedErrno(err),</span>
<span class="line" id="L4623">    }</span>
<span class="line" id="L4624">}</span>
<span class="line" id="L4625"></span>
<span class="line" id="L4626"><span class="tok-comment">/// remove an existing watch from an inotify instance</span></span>
<span class="line" id="L4627"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">inotify_rm_watch</span>(inotify_fd: <span class="tok-type">i32</span>, wd: <span class="tok-type">i32</span>) <span class="tok-type">void</span> {</span>
<span class="line" id="L4628">    <span class="tok-kw">switch</span> (errno(system.inotify_rm_watch(inotify_fd, wd))) {</span>
<span class="line" id="L4629">        .SUCCESS =&gt; <span class="tok-kw">return</span>,</span>
<span class="line" id="L4630">        .BADF =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L4631">        .INVAL =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L4632">        <span class="tok-kw">else</span> =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L4633">    }</span>
<span class="line" id="L4634">}</span>
<span class="line" id="L4635"></span>
<span class="line" id="L4636"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FanotifyInitError = <span class="tok-kw">error</span>{</span>
<span class="line" id="L4637">    ProcessFdQuotaExceeded,</span>
<span class="line" id="L4638">    SystemFdQuotaExceeded,</span>
<span class="line" id="L4639">    SystemResources,</span>
<span class="line" id="L4640">    OperationNotSupported,</span>
<span class="line" id="L4641">    PermissionDenied,</span>
<span class="line" id="L4642">} || UnexpectedError;</span>
<span class="line" id="L4643"></span>
<span class="line" id="L4644"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">fanotify_init</span>(flags: <span class="tok-type">u32</span>, event_f_flags: <span class="tok-type">u32</span>) FanotifyInitError!<span class="tok-type">i32</span> {</span>
<span class="line" id="L4645">    <span class="tok-kw">const</span> rc = system.fanotify_init(flags, event_f_flags);</span>
<span class="line" id="L4646">    <span class="tok-kw">switch</span> (errno(rc)) {</span>
<span class="line" id="L4647">        .SUCCESS =&gt; <span class="tok-kw">return</span> <span class="tok-builtin">@intCast</span>(rc),</span>
<span class="line" id="L4648">        .INVAL =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L4649">        .MFILE =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.ProcessFdQuotaExceeded,</span>
<span class="line" id="L4650">        .NFILE =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.SystemFdQuotaExceeded,</span>
<span class="line" id="L4651">        .NOMEM =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.SystemResources,</span>
<span class="line" id="L4652">        .NOSYS =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.OperationNotSupported,</span>
<span class="line" id="L4653">        .PERM =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.PermissionDenied,</span>
<span class="line" id="L4654">        <span class="tok-kw">else</span> =&gt; |err| <span class="tok-kw">return</span> unexpectedErrno(err),</span>
<span class="line" id="L4655">    }</span>
<span class="line" id="L4656">}</span>
<span class="line" id="L4657"></span>
<span class="line" id="L4658"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FanotifyMarkError = <span class="tok-kw">error</span>{</span>
<span class="line" id="L4659">    MarkAlreadyExists,</span>
<span class="line" id="L4660">    IsDir,</span>
<span class="line" id="L4661">    NotAssociatedWithFileSystem,</span>
<span class="line" id="L4662">    FileNotFound,</span>
<span class="line" id="L4663">    SystemResources,</span>
<span class="line" id="L4664">    UserMarkQuotaExceeded,</span>
<span class="line" id="L4665">    NotImplemented,</span>
<span class="line" id="L4666">    NotDir,</span>
<span class="line" id="L4667">    OperationNotSupported,</span>
<span class="line" id="L4668">    PermissionDenied,</span>
<span class="line" id="L4669">    NotSameFileSystem,</span>
<span class="line" id="L4670">    NameTooLong,</span>
<span class="line" id="L4671">} || UnexpectedError;</span>
<span class="line" id="L4672"></span>
<span class="line" id="L4673"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">fanotify_mark</span>(fanotify_fd: <span class="tok-type">i32</span>, flags: <span class="tok-type">u32</span>, mask: <span class="tok-type">u64</span>, dirfd: <span class="tok-type">i32</span>, pathname: ?[]<span class="tok-kw">const</span> <span class="tok-type">u8</span>) FanotifyMarkError!<span class="tok-type">void</span> {</span>
<span class="line" id="L4674">    <span class="tok-kw">if</span> (pathname) |path| {</span>
<span class="line" id="L4675">        <span class="tok-kw">const</span> path_c = <span class="tok-kw">try</span> toPosixPath(path);</span>
<span class="line" id="L4676">        <span class="tok-kw">return</span> fanotify_markZ(fanotify_fd, flags, mask, dirfd, &amp;path_c);</span>
<span class="line" id="L4677">    }</span>
<span class="line" id="L4678"></span>
<span class="line" id="L4679">    <span class="tok-kw">return</span> fanotify_markZ(fanotify_fd, flags, mask, dirfd, <span class="tok-null">null</span>);</span>
<span class="line" id="L4680">}</span>
<span class="line" id="L4681"></span>
<span class="line" id="L4682"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">fanotify_markZ</span>(fanotify_fd: <span class="tok-type">i32</span>, flags: <span class="tok-type">u32</span>, mask: <span class="tok-type">u64</span>, dirfd: <span class="tok-type">i32</span>, pathname: ?[*:<span class="tok-number">0</span>]<span class="tok-kw">const</span> <span class="tok-type">u8</span>) FanotifyMarkError!<span class="tok-type">void</span> {</span>
<span class="line" id="L4683">    <span class="tok-kw">const</span> rc = system.fanotify_mark(fanotify_fd, flags, mask, dirfd, pathname);</span>
<span class="line" id="L4684">    <span class="tok-kw">switch</span> (errno(rc)) {</span>
<span class="line" id="L4685">        .SUCCESS =&gt; <span class="tok-kw">return</span>,</span>
<span class="line" id="L4686">        .BADF =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L4687">        .EXIST =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.MarkAlreadyExists,</span>
<span class="line" id="L4688">        .INVAL =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L4689">        .ISDIR =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.IsDir,</span>
<span class="line" id="L4690">        .NODEV =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.NotAssociatedWithFileSystem,</span>
<span class="line" id="L4691">        .NOENT =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.FileNotFound,</span>
<span class="line" id="L4692">        .NOMEM =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.SystemResources,</span>
<span class="line" id="L4693">        .NOSPC =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.UserMarkQuotaExceeded,</span>
<span class="line" id="L4694">        .NOSYS =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.NotImplemented,</span>
<span class="line" id="L4695">        .NOTDIR =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.NotDir,</span>
<span class="line" id="L4696">        .OPNOTSUPP =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.OperationNotSupported,</span>
<span class="line" id="L4697">        .PERM =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.PermissionDenied,</span>
<span class="line" id="L4698">        .XDEV =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.NotSameFileSystem,</span>
<span class="line" id="L4699">        <span class="tok-kw">else</span> =&gt; |err| <span class="tok-kw">return</span> unexpectedErrno(err),</span>
<span class="line" id="L4700">    }</span>
<span class="line" id="L4701">}</span>
<span class="line" id="L4702"></span>
<span class="line" id="L4703"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> MProtectError = <span class="tok-kw">error</span>{</span>
<span class="line" id="L4704">    <span class="tok-comment">/// The memory cannot be given the specified access.  This can happen, for example, if you</span></span>
<span class="line" id="L4705">    <span class="tok-comment">/// mmap(2)  a  file  to  which  you have read-only access, then ask mprotect() to mark it</span></span>
<span class="line" id="L4706">    <span class="tok-comment">/// PROT_WRITE.</span></span>
<span class="line" id="L4707">    AccessDenied,</span>
<span class="line" id="L4708"></span>
<span class="line" id="L4709">    <span class="tok-comment">/// Changing  the  protection  of a memory region would result in the total number of map‐</span></span>
<span class="line" id="L4710">    <span class="tok-comment">/// pings with distinct attributes (e.g., read versus read/write protection) exceeding the</span></span>
<span class="line" id="L4711">    <span class="tok-comment">/// allowed maximum.  (For example, making the protection of a range PROT_READ in the mid‐</span></span>
<span class="line" id="L4712">    <span class="tok-comment">/// dle of a region currently protected as PROT_READ|PROT_WRITE would result in three map‐</span></span>
<span class="line" id="L4713">    <span class="tok-comment">/// pings: two read/write mappings at each end and a read-only mapping in the middle.)</span></span>
<span class="line" id="L4714">    OutOfMemory,</span>
<span class="line" id="L4715">} || UnexpectedError;</span>
<span class="line" id="L4716"></span>
<span class="line" id="L4717"><span class="tok-comment">/// `memory.len` must be page-aligned.</span></span>
<span class="line" id="L4718"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">mprotect</span>(memory: []<span class="tok-kw">align</span>(mem.page_size) <span class="tok-type">u8</span>, protection: <span class="tok-type">u32</span>) MProtectError!<span class="tok-type">void</span> {</span>
<span class="line" id="L4719">    assert(mem.isAligned(memory.len, mem.page_size));</span>
<span class="line" id="L4720">    <span class="tok-kw">if</span> (builtin.os.tag == .windows) {</span>
<span class="line" id="L4721">        <span class="tok-kw">const</span> win_prot: windows.DWORD = <span class="tok-kw">switch</span> (<span class="tok-builtin">@as</span>(<span class="tok-type">u3</span>, <span class="tok-builtin">@truncate</span>(protection))) {</span>
<span class="line" id="L4722">            <span class="tok-number">0b000</span> =&gt; windows.PAGE_NOACCESS,</span>
<span class="line" id="L4723">            <span class="tok-number">0b001</span> =&gt; windows.PAGE_READONLY,</span>
<span class="line" id="L4724">            <span class="tok-number">0b010</span> =&gt; <span class="tok-kw">unreachable</span>, <span class="tok-comment">// +w -r not allowed</span>
</span>
<span class="line" id="L4725">            <span class="tok-number">0b011</span> =&gt; windows.PAGE_READWRITE,</span>
<span class="line" id="L4726">            <span class="tok-number">0b100</span> =&gt; windows.PAGE_EXECUTE,</span>
<span class="line" id="L4727">            <span class="tok-number">0b101</span> =&gt; windows.PAGE_EXECUTE_READ,</span>
<span class="line" id="L4728">            <span class="tok-number">0b110</span> =&gt; <span class="tok-kw">unreachable</span>, <span class="tok-comment">// +w -r not allowed</span>
</span>
<span class="line" id="L4729">            <span class="tok-number">0b111</span> =&gt; windows.PAGE_EXECUTE_READWRITE,</span>
<span class="line" id="L4730">        };</span>
<span class="line" id="L4731">        <span class="tok-kw">var</span> old: windows.DWORD = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L4732">        windows.VirtualProtect(memory.ptr, memory.len, win_prot, &amp;old) <span class="tok-kw">catch</span> |err| <span class="tok-kw">switch</span> (err) {</span>
<span class="line" id="L4733">            <span class="tok-kw">error</span>.InvalidAddress =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.AccessDenied,</span>
<span class="line" id="L4734">            <span class="tok-kw">error</span>.Unexpected =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.Unexpected,</span>
<span class="line" id="L4735">        };</span>
<span class="line" id="L4736">    } <span class="tok-kw">else</span> {</span>
<span class="line" id="L4737">        <span class="tok-kw">switch</span> (errno(system.mprotect(memory.ptr, memory.len, protection))) {</span>
<span class="line" id="L4738">            .SUCCESS =&gt; <span class="tok-kw">return</span>,</span>
<span class="line" id="L4739">            .INVAL =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L4740">            .ACCES =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.AccessDenied,</span>
<span class="line" id="L4741">            .NOMEM =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.OutOfMemory,</span>
<span class="line" id="L4742">            <span class="tok-kw">else</span> =&gt; |err| <span class="tok-kw">return</span> unexpectedErrno(err),</span>
<span class="line" id="L4743">        }</span>
<span class="line" id="L4744">    }</span>
<span class="line" id="L4745">}</span>
<span class="line" id="L4746"></span>
<span class="line" id="L4747"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> ForkError = <span class="tok-kw">error</span>{SystemResources} || UnexpectedError;</span>
<span class="line" id="L4748"></span>
<span class="line" id="L4749"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">fork</span>() ForkError!pid_t {</span>
<span class="line" id="L4750">    <span class="tok-kw">const</span> rc = system.fork();</span>
<span class="line" id="L4751">    <span class="tok-kw">switch</span> (errno(rc)) {</span>
<span class="line" id="L4752">        .SUCCESS =&gt; <span class="tok-kw">return</span> <span class="tok-builtin">@intCast</span>(rc),</span>
<span class="line" id="L4753">        .AGAIN =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.SystemResources,</span>
<span class="line" id="L4754">        .NOMEM =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.SystemResources,</span>
<span class="line" id="L4755">        <span class="tok-kw">else</span> =&gt; |err| <span class="tok-kw">return</span> unexpectedErrno(err),</span>
<span class="line" id="L4756">    }</span>
<span class="line" id="L4757">}</span>
<span class="line" id="L4758"></span>
<span class="line" id="L4759"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> MMapError = <span class="tok-kw">error</span>{</span>
<span class="line" id="L4760">    <span class="tok-comment">/// The underlying filesystem of the specified file does not support memory mapping.</span></span>
<span class="line" id="L4761">    MemoryMappingNotSupported,</span>
<span class="line" id="L4762"></span>
<span class="line" id="L4763">    <span class="tok-comment">/// A file descriptor refers to a non-regular file. Or a file mapping was requested,</span></span>
<span class="line" id="L4764">    <span class="tok-comment">/// but the file descriptor is not open for reading. Or `MAP.SHARED` was requested</span></span>
<span class="line" id="L4765">    <span class="tok-comment">/// and `PROT_WRITE` is set, but the file descriptor is not open in `RDWR` mode.</span></span>
<span class="line" id="L4766">    <span class="tok-comment">/// Or `PROT_WRITE` is set, but the file is append-only.</span></span>
<span class="line" id="L4767">    AccessDenied,</span>
<span class="line" id="L4768"></span>
<span class="line" id="L4769">    <span class="tok-comment">/// The `prot` argument asks for `PROT_EXEC` but the mapped area belongs to a file on</span></span>
<span class="line" id="L4770">    <span class="tok-comment">/// a filesystem that was mounted no-exec.</span></span>
<span class="line" id="L4771">    PermissionDenied,</span>
<span class="line" id="L4772">    LockedMemoryLimitExceeded,</span>
<span class="line" id="L4773">    ProcessFdQuotaExceeded,</span>
<span class="line" id="L4774">    SystemFdQuotaExceeded,</span>
<span class="line" id="L4775">    OutOfMemory,</span>
<span class="line" id="L4776">} || UnexpectedError;</span>
<span class="line" id="L4777"></span>
<span class="line" id="L4778"><span class="tok-comment">/// Map files or devices into memory.</span></span>
<span class="line" id="L4779"><span class="tok-comment">/// `length` does not need to be aligned.</span></span>
<span class="line" id="L4780"><span class="tok-comment">/// Use of a mapped region can result in these signals:</span></span>
<span class="line" id="L4781"><span class="tok-comment">/// * SIGSEGV - Attempted write into a region mapped as read-only.</span></span>
<span class="line" id="L4782"><span class="tok-comment">/// * SIGBUS - Attempted  access to a portion of the buffer that does not correspond to the file</span></span>
<span class="line" id="L4783"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">mmap</span>(</span>
<span class="line" id="L4784">    ptr: ?[*]<span class="tok-kw">align</span>(mem.page_size) <span class="tok-type">u8</span>,</span>
<span class="line" id="L4785">    length: <span class="tok-type">usize</span>,</span>
<span class="line" id="L4786">    prot: <span class="tok-type">u32</span>,</span>
<span class="line" id="L4787">    flags: system.MAP,</span>
<span class="line" id="L4788">    fd: fd_t,</span>
<span class="line" id="L4789">    offset: <span class="tok-type">u64</span>,</span>
<span class="line" id="L4790">) MMapError![]<span class="tok-kw">align</span>(mem.page_size) <span class="tok-type">u8</span> {</span>
<span class="line" id="L4791">    <span class="tok-kw">const</span> mmap_sym = <span class="tok-kw">if</span> (lfs64_abi) system.mmap64 <span class="tok-kw">else</span> system.mmap;</span>
<span class="line" id="L4792">    <span class="tok-kw">const</span> rc = mmap_sym(ptr, length, prot, <span class="tok-builtin">@bitCast</span>(flags), fd, <span class="tok-builtin">@bitCast</span>(offset));</span>
<span class="line" id="L4793">    <span class="tok-kw">const</span> err: E = <span class="tok-kw">if</span> (builtin.link_libc) blk: {</span>
<span class="line" id="L4794">        <span class="tok-kw">if</span> (rc != std.c.MAP_FAILED) <span class="tok-kw">return</span> <span class="tok-builtin">@as</span>([*]<span class="tok-kw">align</span>(mem.page_size) <span class="tok-type">u8</span>, <span class="tok-builtin">@ptrCast</span>(<span class="tok-builtin">@alignCast</span>(rc)))[<span class="tok-number">0</span>..length];</span>
<span class="line" id="L4795">        <span class="tok-kw">break</span> :blk <span class="tok-builtin">@enumFromInt</span>(system._errno().*);</span>
<span class="line" id="L4796">    } <span class="tok-kw">else</span> blk: {</span>
<span class="line" id="L4797">        <span class="tok-kw">const</span> err = errno(rc);</span>
<span class="line" id="L4798">        <span class="tok-kw">if</span> (err == .SUCCESS) <span class="tok-kw">return</span> <span class="tok-builtin">@as</span>([*]<span class="tok-kw">align</span>(mem.page_size) <span class="tok-type">u8</span>, <span class="tok-builtin">@ptrFromInt</span>(rc))[<span class="tok-number">0</span>..length];</span>
<span class="line" id="L4799">        <span class="tok-kw">break</span> :blk err;</span>
<span class="line" id="L4800">    };</span>
<span class="line" id="L4801">    <span class="tok-kw">switch</span> (err) {</span>
<span class="line" id="L4802">        .SUCCESS =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L4803">        .TXTBSY =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.AccessDenied,</span>
<span class="line" id="L4804">        .ACCES =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.AccessDenied,</span>
<span class="line" id="L4805">        .PERM =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.PermissionDenied,</span>
<span class="line" id="L4806">        .AGAIN =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.LockedMemoryLimitExceeded,</span>
<span class="line" id="L4807">        .BADF =&gt; <span class="tok-kw">unreachable</span>, <span class="tok-comment">// Always a race condition.</span>
</span>
<span class="line" id="L4808">        .OVERFLOW =&gt; <span class="tok-kw">unreachable</span>, <span class="tok-comment">// The number of pages used for length + offset would overflow.</span>
</span>
<span class="line" id="L4809">        .NODEV =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.MemoryMappingNotSupported,</span>
<span class="line" id="L4810">        .INVAL =&gt; <span class="tok-kw">unreachable</span>, <span class="tok-comment">// Invalid parameters to mmap()</span>
</span>
<span class="line" id="L4811">        .MFILE =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.ProcessFdQuotaExceeded,</span>
<span class="line" id="L4812">        .NFILE =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.SystemFdQuotaExceeded,</span>
<span class="line" id="L4813">        .NOMEM =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.OutOfMemory,</span>
<span class="line" id="L4814">        <span class="tok-kw">else</span> =&gt; <span class="tok-kw">return</span> unexpectedErrno(err),</span>
<span class="line" id="L4815">    }</span>
<span class="line" id="L4816">}</span>
<span class="line" id="L4817"></span>
<span class="line" id="L4818"><span class="tok-comment">/// Deletes the mappings for the specified address range, causing</span></span>
<span class="line" id="L4819"><span class="tok-comment">/// further references to addresses within the range to generate invalid memory references.</span></span>
<span class="line" id="L4820"><span class="tok-comment">/// Note that while POSIX allows unmapping a region in the middle of an existing mapping,</span></span>
<span class="line" id="L4821"><span class="tok-comment">/// Zig's munmap function does not, for two reasons:</span></span>
<span class="line" id="L4822"><span class="tok-comment">/// * It violates the Zig principle that resource deallocation must succeed.</span></span>
<span class="line" id="L4823"><span class="tok-comment">/// * The Windows function, VirtualFree, has this restriction.</span></span>
<span class="line" id="L4824"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">munmap</span>(memory: []<span class="tok-kw">align</span>(mem.page_size) <span class="tok-kw">const</span> <span class="tok-type">u8</span>) <span class="tok-type">void</span> {</span>
<span class="line" id="L4825">    <span class="tok-kw">switch</span> (errno(system.munmap(memory.ptr, memory.len))) {</span>
<span class="line" id="L4826">        .SUCCESS =&gt; <span class="tok-kw">return</span>,</span>
<span class="line" id="L4827">        .INVAL =&gt; <span class="tok-kw">unreachable</span>, <span class="tok-comment">// Invalid parameters.</span>
</span>
<span class="line" id="L4828">        .NOMEM =&gt; <span class="tok-kw">unreachable</span>, <span class="tok-comment">// Attempted to unmap a region in the middle of an existing mapping.</span>
</span>
<span class="line" id="L4829">        <span class="tok-kw">else</span> =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L4830">    }</span>
<span class="line" id="L4831">}</span>
<span class="line" id="L4832"></span>
<span class="line" id="L4833"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> MSyncError = <span class="tok-kw">error</span>{</span>
<span class="line" id="L4834">    UnmappedMemory,</span>
<span class="line" id="L4835">} || UnexpectedError;</span>
<span class="line" id="L4836"></span>
<span class="line" id="L4837"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">msync</span>(memory: []<span class="tok-kw">align</span>(mem.page_size) <span class="tok-type">u8</span>, flags: <span class="tok-type">i32</span>) MSyncError!<span class="tok-type">void</span> {</span>
<span class="line" id="L4838">    <span class="tok-kw">switch</span> (errno(system.msync(memory.ptr, memory.len, flags))) {</span>
<span class="line" id="L4839">        .SUCCESS =&gt; <span class="tok-kw">return</span>,</span>
<span class="line" id="L4840">        .NOMEM =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.UnmappedMemory, <span class="tok-comment">// Unsuccessful, provided pointer does not point mapped memory</span>
</span>
<span class="line" id="L4841">        .INVAL =&gt; <span class="tok-kw">unreachable</span>, <span class="tok-comment">// Invalid parameters.</span>
</span>
<span class="line" id="L4842">        <span class="tok-kw">else</span> =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L4843">    }</span>
<span class="line" id="L4844">}</span>
<span class="line" id="L4845"></span>
<span class="line" id="L4846"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> AccessError = <span class="tok-kw">error</span>{</span>
<span class="line" id="L4847">    PermissionDenied,</span>
<span class="line" id="L4848">    FileNotFound,</span>
<span class="line" id="L4849">    NameTooLong,</span>
<span class="line" id="L4850">    InputOutput,</span>
<span class="line" id="L4851">    SystemResources,</span>
<span class="line" id="L4852">    BadPathName,</span>
<span class="line" id="L4853">    FileBusy,</span>
<span class="line" id="L4854">    SymLinkLoop,</span>
<span class="line" id="L4855">    ReadOnlyFileSystem,</span>
<span class="line" id="L4856">    <span class="tok-comment">/// WASI-only; file paths must be valid UTF-8.</span></span>
<span class="line" id="L4857">    InvalidUtf8,</span>
<span class="line" id="L4858">    <span class="tok-comment">/// Windows-only; file paths provided by the user must be valid WTF-8.</span></span>
<span class="line" id="L4859">    <span class="tok-comment">/// https://simonsapin.github.io/wtf-8/</span></span>
<span class="line" id="L4860">    InvalidWtf8,</span>
<span class="line" id="L4861">} || UnexpectedError;</span>
<span class="line" id="L4862"></span>
<span class="line" id="L4863"><span class="tok-comment">/// check user's permissions for a file</span></span>
<span class="line" id="L4864"><span class="tok-comment">/// On Windows, `path` should be encoded as [WTF-8](https://simonsapin.github.io/wtf-8/).</span></span>
<span class="line" id="L4865"><span class="tok-comment">/// On WASI, `path` should be encoded as valid UTF-8.</span></span>
<span class="line" id="L4866"><span class="tok-comment">/// On other platforms, `path` is an opaque sequence of bytes with no particular encoding.</span></span>
<span class="line" id="L4867"><span class="tok-comment">/// TODO currently this assumes `mode` is `F.OK` on Windows.</span></span>
<span class="line" id="L4868"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">access</span>(path: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>, mode: <span class="tok-type">u32</span>) AccessError!<span class="tok-type">void</span> {</span>
<span class="line" id="L4869">    <span class="tok-kw">if</span> (builtin.os.tag == .windows) {</span>
<span class="line" id="L4870">        <span class="tok-kw">const</span> path_w = windows.sliceToPrefixedFileW(<span class="tok-null">null</span>, path) <span class="tok-kw">catch</span> |err| <span class="tok-kw">switch</span> (err) {</span>
<span class="line" id="L4871">            <span class="tok-kw">error</span>.AccessDenied =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.PermissionDenied,</span>
<span class="line" id="L4872">            <span class="tok-kw">else</span> =&gt; |e| <span class="tok-kw">return</span> e,</span>
<span class="line" id="L4873">        };</span>
<span class="line" id="L4874">        _ = <span class="tok-kw">try</span> windows.GetFileAttributesW(path_w.span().ptr);</span>
<span class="line" id="L4875">        <span class="tok-kw">return</span>;</span>
<span class="line" id="L4876">    } <span class="tok-kw">else</span> <span class="tok-kw">if</span> (builtin.os.tag == .wasi <span class="tok-kw">and</span> !builtin.link_libc) {</span>
<span class="line" id="L4877">        <span class="tok-kw">return</span> faccessat(wasi.AT.FDCWD, path, mode, <span class="tok-number">0</span>);</span>
<span class="line" id="L4878">    }</span>
<span class="line" id="L4879">    <span class="tok-kw">const</span> path_c = <span class="tok-kw">try</span> toPosixPath(path);</span>
<span class="line" id="L4880">    <span class="tok-kw">return</span> accessZ(&amp;path_c, mode);</span>
<span class="line" id="L4881">}</span>
<span class="line" id="L4882"></span>
<span class="line" id="L4883"><span class="tok-comment">/// Same as `access` except `path` is null-terminated.</span></span>
<span class="line" id="L4884"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">accessZ</span>(path: [*:<span class="tok-number">0</span>]<span class="tok-kw">const</span> <span class="tok-type">u8</span>, mode: <span class="tok-type">u32</span>) AccessError!<span class="tok-type">void</span> {</span>
<span class="line" id="L4885">    <span class="tok-kw">if</span> (builtin.os.tag == .windows) {</span>
<span class="line" id="L4886">        <span class="tok-kw">const</span> path_w = windows.cStrToPrefixedFileW(<span class="tok-null">null</span>, path) <span class="tok-kw">catch</span> |err| <span class="tok-kw">switch</span> (err) {</span>
<span class="line" id="L4887">            <span class="tok-kw">error</span>.AccessDenied =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.PermissionDenied,</span>
<span class="line" id="L4888">            <span class="tok-kw">else</span> =&gt; |e| <span class="tok-kw">return</span> e,</span>
<span class="line" id="L4889">        };</span>
<span class="line" id="L4890">        _ = <span class="tok-kw">try</span> windows.GetFileAttributesW(path_w.span().ptr);</span>
<span class="line" id="L4891">        <span class="tok-kw">return</span>;</span>
<span class="line" id="L4892">    } <span class="tok-kw">else</span> <span class="tok-kw">if</span> (builtin.os.tag == .wasi <span class="tok-kw">and</span> !builtin.link_libc) {</span>
<span class="line" id="L4893">        <span class="tok-kw">return</span> access(mem.sliceTo(path, <span class="tok-number">0</span>), mode);</span>
<span class="line" id="L4894">    }</span>
<span class="line" id="L4895">    <span class="tok-kw">switch</span> (errno(system.access(path, mode))) {</span>
<span class="line" id="L4896">        .SUCCESS =&gt; <span class="tok-kw">return</span>,</span>
<span class="line" id="L4897">        .ACCES =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.PermissionDenied,</span>
<span class="line" id="L4898">        .ROFS =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.ReadOnlyFileSystem,</span>
<span class="line" id="L4899">        .LOOP =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.SymLinkLoop,</span>
<span class="line" id="L4900">        .TXTBSY =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.FileBusy,</span>
<span class="line" id="L4901">        .NOTDIR =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.FileNotFound,</span>
<span class="line" id="L4902">        .NOENT =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.FileNotFound,</span>
<span class="line" id="L4903">        .NAMETOOLONG =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.NameTooLong,</span>
<span class="line" id="L4904">        .INVAL =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L4905">        .FAULT =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L4906">        .IO =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.InputOutput,</span>
<span class="line" id="L4907">        .NOMEM =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.SystemResources,</span>
<span class="line" id="L4908">        .ILSEQ =&gt; |err| <span class="tok-kw">if</span> (builtin.os.tag == .wasi)</span>
<span class="line" id="L4909">            <span class="tok-kw">return</span> <span class="tok-kw">error</span>.InvalidUtf8</span>
<span class="line" id="L4910">        <span class="tok-kw">else</span></span>
<span class="line" id="L4911">            <span class="tok-kw">return</span> unexpectedErrno(err),</span>
<span class="line" id="L4912">        <span class="tok-kw">else</span> =&gt; |err| <span class="tok-kw">return</span> unexpectedErrno(err),</span>
<span class="line" id="L4913">    }</span>
<span class="line" id="L4914">}</span>
<span class="line" id="L4915"></span>
<span class="line" id="L4916"><span class="tok-comment">/// Call from Windows-specific code if you already have a WTF-16LE encoded, null terminated string.</span></span>
<span class="line" id="L4917"><span class="tok-comment">/// Otherwise use `access` or `accessZ`.</span></span>
<span class="line" id="L4918"><span class="tok-comment">/// TODO currently this ignores `mode`.</span></span>
<span class="line" id="L4919"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">accessW</span>(path: [*:<span class="tok-number">0</span>]<span class="tok-kw">const</span> <span class="tok-type">u16</span>, mode: <span class="tok-type">u32</span>) windows.GetFileAttributesError!<span class="tok-type">void</span> {</span>
<span class="line" id="L4920">    _ = mode;</span>
<span class="line" id="L4921">    <span class="tok-kw">const</span> ret = <span class="tok-kw">try</span> windows.GetFileAttributesW(path);</span>
<span class="line" id="L4922">    <span class="tok-kw">if</span> (ret != windows.INVALID_FILE_ATTRIBUTES) {</span>
<span class="line" id="L4923">        <span class="tok-kw">return</span>;</span>
<span class="line" id="L4924">    }</span>
<span class="line" id="L4925">    <span class="tok-kw">switch</span> (windows.kernel32.GetLastError()) {</span>
<span class="line" id="L4926">        .FILE_NOT_FOUND =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.FileNotFound,</span>
<span class="line" id="L4927">        .PATH_NOT_FOUND =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.FileNotFound,</span>
<span class="line" id="L4928">        .ACCESS_DENIED =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.PermissionDenied,</span>
<span class="line" id="L4929">        <span class="tok-kw">else</span> =&gt; |err| <span class="tok-kw">return</span> windows.unexpectedError(err),</span>
<span class="line" id="L4930">    }</span>
<span class="line" id="L4931">}</span>
<span class="line" id="L4932"></span>
<span class="line" id="L4933"><span class="tok-comment">/// Check user's permissions for a file, based on an open directory handle.</span></span>
<span class="line" id="L4934"><span class="tok-comment">/// On Windows, `path` should be encoded as [WTF-8](https://simonsapin.github.io/wtf-8/).</span></span>
<span class="line" id="L4935"><span class="tok-comment">/// On WASI, `path` should be encoded as valid UTF-8.</span></span>
<span class="line" id="L4936"><span class="tok-comment">/// On other platforms, `path` is an opaque sequence of bytes with no particular encoding.</span></span>
<span class="line" id="L4937"><span class="tok-comment">/// TODO currently this ignores `mode` and `flags` on Windows.</span></span>
<span class="line" id="L4938"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">faccessat</span>(dirfd: fd_t, path: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>, mode: <span class="tok-type">u32</span>, flags: <span class="tok-type">u32</span>) AccessError!<span class="tok-type">void</span> {</span>
<span class="line" id="L4939">    <span class="tok-kw">if</span> (builtin.os.tag == .windows) {</span>
<span class="line" id="L4940">        <span class="tok-kw">const</span> path_w = <span class="tok-kw">try</span> windows.sliceToPrefixedFileW(dirfd, path);</span>
<span class="line" id="L4941">        <span class="tok-kw">return</span> faccessatW(dirfd, path_w.span().ptr, mode, flags);</span>
<span class="line" id="L4942">    } <span class="tok-kw">else</span> <span class="tok-kw">if</span> (builtin.os.tag == .wasi <span class="tok-kw">and</span> !builtin.link_libc) {</span>
<span class="line" id="L4943">        <span class="tok-kw">const</span> resolved: RelativePathWasi = .{ .dir_fd = dirfd, .relative_path = path };</span>
<span class="line" id="L4944"></span>
<span class="line" id="L4945">        <span class="tok-kw">const</span> st = blk: {</span>
<span class="line" id="L4946">            <span class="tok-kw">break</span> :blk fstatat_wasi(dirfd, path, .{</span>
<span class="line" id="L4947">                .SYMLINK_FOLLOW = (flags &amp; AT.SYMLINK_NOFOLLOW) == <span class="tok-number">0</span>,</span>
<span class="line" id="L4948">            });</span>
<span class="line" id="L4949">        } <span class="tok-kw">catch</span> |err| <span class="tok-kw">switch</span> (err) {</span>
<span class="line" id="L4950">            <span class="tok-kw">error</span>.AccessDenied =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.PermissionDenied,</span>
<span class="line" id="L4951">            <span class="tok-kw">else</span> =&gt; |e| <span class="tok-kw">return</span> e,</span>
<span class="line" id="L4952">        };</span>
<span class="line" id="L4953"></span>
<span class="line" id="L4954">        <span class="tok-kw">if</span> (mode != F_OK) {</span>
<span class="line" id="L4955">            <span class="tok-kw">var</span> directory: wasi.fdstat_t = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L4956">            <span class="tok-kw">if</span> (wasi.fd_fdstat_get(resolved.dir_fd, &amp;directory) != .SUCCESS) {</span>
<span class="line" id="L4957">                <span class="tok-kw">return</span> <span class="tok-kw">error</span>.PermissionDenied;</span>
<span class="line" id="L4958">            }</span>
<span class="line" id="L4959"></span>
<span class="line" id="L4960">            <span class="tok-kw">var</span> rights: wasi.rights_t = .{};</span>
<span class="line" id="L4961">            <span class="tok-kw">if</span> (mode &amp; R_OK != <span class="tok-number">0</span>) {</span>
<span class="line" id="L4962">                <span class="tok-kw">if</span> (st.filetype == .DIRECTORY) {</span>
<span class="line" id="L4963">                    rights.FD_READDIR = <span class="tok-null">true</span>;</span>
<span class="line" id="L4964">                } <span class="tok-kw">else</span> {</span>
<span class="line" id="L4965">                    rights.FD_READ = <span class="tok-null">true</span>;</span>
<span class="line" id="L4966">                }</span>
<span class="line" id="L4967">            }</span>
<span class="line" id="L4968">            <span class="tok-kw">if</span> (mode &amp; W_OK != <span class="tok-number">0</span>) {</span>
<span class="line" id="L4969">                rights.FD_WRITE = <span class="tok-null">true</span>;</span>
<span class="line" id="L4970">            }</span>
<span class="line" id="L4971">            <span class="tok-comment">// No validation for X_OK</span>
</span>
<span class="line" id="L4972"></span>
<span class="line" id="L4973">            <span class="tok-comment">// https://github.com/ziglang/zig/issues/18882</span>
</span>
<span class="line" id="L4974">            <span class="tok-kw">const</span> rights_int: <span class="tok-type">u64</span> = <span class="tok-builtin">@bitCast</span>(rights);</span>
<span class="line" id="L4975">            <span class="tok-kw">const</span> inheriting_int: <span class="tok-type">u64</span> = <span class="tok-builtin">@bitCast</span>(directory.fs_rights_inheriting);</span>
<span class="line" id="L4976">            <span class="tok-kw">if</span> ((rights_int &amp; inheriting_int) != rights_int) {</span>
<span class="line" id="L4977">                <span class="tok-kw">return</span> <span class="tok-kw">error</span>.PermissionDenied;</span>
<span class="line" id="L4978">            }</span>
<span class="line" id="L4979">        }</span>
<span class="line" id="L4980">        <span class="tok-kw">return</span>;</span>
<span class="line" id="L4981">    }</span>
<span class="line" id="L4982">    <span class="tok-kw">const</span> path_c = <span class="tok-kw">try</span> toPosixPath(path);</span>
<span class="line" id="L4983">    <span class="tok-kw">return</span> faccessatZ(dirfd, &amp;path_c, mode, flags);</span>
<span class="line" id="L4984">}</span>
<span class="line" id="L4985"></span>
<span class="line" id="L4986"><span class="tok-comment">/// Same as `faccessat` except the path parameter is null-terminated.</span></span>
<span class="line" id="L4987"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">faccessatZ</span>(dirfd: fd_t, path: [*:<span class="tok-number">0</span>]<span class="tok-kw">const</span> <span class="tok-type">u8</span>, mode: <span class="tok-type">u32</span>, flags: <span class="tok-type">u32</span>) AccessError!<span class="tok-type">void</span> {</span>
<span class="line" id="L4988">    <span class="tok-kw">if</span> (builtin.os.tag == .windows) {</span>
<span class="line" id="L4989">        <span class="tok-kw">const</span> path_w = <span class="tok-kw">try</span> windows.cStrToPrefixedFileW(dirfd, path);</span>
<span class="line" id="L4990">        <span class="tok-kw">return</span> faccessatW(dirfd, path_w.span().ptr, mode, flags);</span>
<span class="line" id="L4991">    } <span class="tok-kw">else</span> <span class="tok-kw">if</span> (builtin.os.tag == .wasi <span class="tok-kw">and</span> !builtin.link_libc) {</span>
<span class="line" id="L4992">        <span class="tok-kw">return</span> faccessat(dirfd, mem.sliceTo(path, <span class="tok-number">0</span>), mode, flags);</span>
<span class="line" id="L4993">    }</span>
<span class="line" id="L4994">    <span class="tok-kw">switch</span> (errno(system.faccessat(dirfd, path, mode, flags))) {</span>
<span class="line" id="L4995">        .SUCCESS =&gt; <span class="tok-kw">return</span>,</span>
<span class="line" id="L4996">        .ACCES =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.PermissionDenied,</span>
<span class="line" id="L4997">        .ROFS =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.ReadOnlyFileSystem,</span>
<span class="line" id="L4998">        .LOOP =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.SymLinkLoop,</span>
<span class="line" id="L4999">        .TXTBSY =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.FileBusy,</span>
<span class="line" id="L5000">        .NOTDIR =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.FileNotFound,</span>
<span class="line" id="L5001">        .NOENT =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.FileNotFound,</span>
<span class="line" id="L5002">        .NAMETOOLONG =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.NameTooLong,</span>
<span class="line" id="L5003">        .INVAL =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L5004">        .FAULT =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L5005">        .IO =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.InputOutput,</span>
<span class="line" id="L5006">        .NOMEM =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.SystemResources,</span>
<span class="line" id="L5007">        .ILSEQ =&gt; |err| <span class="tok-kw">if</span> (builtin.os.tag == .wasi)</span>
<span class="line" id="L5008">            <span class="tok-kw">return</span> <span class="tok-kw">error</span>.InvalidUtf8</span>
<span class="line" id="L5009">        <span class="tok-kw">else</span></span>
<span class="line" id="L5010">            <span class="tok-kw">return</span> unexpectedErrno(err),</span>
<span class="line" id="L5011">        <span class="tok-kw">else</span> =&gt; |err| <span class="tok-kw">return</span> unexpectedErrno(err),</span>
<span class="line" id="L5012">    }</span>
<span class="line" id="L5013">}</span>
<span class="line" id="L5014"></span>
<span class="line" id="L5015"><span class="tok-comment">/// Same as `faccessat` except asserts the target is Windows and the path parameter</span></span>
<span class="line" id="L5016"><span class="tok-comment">/// is NtDll-prefixed, null-terminated, WTF-16 encoded.</span></span>
<span class="line" id="L5017"><span class="tok-comment">/// TODO currently this ignores `mode` and `flags`</span></span>
<span class="line" id="L5018"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">faccessatW</span>(dirfd: fd_t, sub_path_w: [*:<span class="tok-number">0</span>]<span class="tok-kw">const</span> <span class="tok-type">u16</span>, mode: <span class="tok-type">u32</span>, flags: <span class="tok-type">u32</span>) AccessError!<span class="tok-type">void</span> {</span>
<span class="line" id="L5019">    _ = mode;</span>
<span class="line" id="L5020">    _ = flags;</span>
<span class="line" id="L5021">    <span class="tok-kw">if</span> (sub_path_w[<span class="tok-number">0</span>] == <span class="tok-str">'.'</span> <span class="tok-kw">and</span> sub_path_w[<span class="tok-number">1</span>] == <span class="tok-number">0</span>) {</span>
<span class="line" id="L5022">        <span class="tok-kw">return</span>;</span>
<span class="line" id="L5023">    }</span>
<span class="line" id="L5024">    <span class="tok-kw">if</span> (sub_path_w[<span class="tok-number">0</span>] == <span class="tok-str">'.'</span> <span class="tok-kw">and</span> sub_path_w[<span class="tok-number">1</span>] == <span class="tok-str">'.'</span> <span class="tok-kw">and</span> sub_path_w[<span class="tok-number">2</span>] == <span class="tok-number">0</span>) {</span>
<span class="line" id="L5025">        <span class="tok-kw">return</span>;</span>
<span class="line" id="L5026">    }</span>
<span class="line" id="L5027"></span>
<span class="line" id="L5028">    <span class="tok-kw">const</span> path_len_bytes = math.cast(<span class="tok-type">u16</span>, mem.sliceTo(sub_path_w, <span class="tok-number">0</span>).len * <span class="tok-number">2</span>) <span class="tok-kw">orelse</span> <span class="tok-kw">return</span> <span class="tok-kw">error</span>.NameTooLong;</span>
<span class="line" id="L5029">    <span class="tok-kw">var</span> nt_name = windows.UNICODE_STRING{</span>
<span class="line" id="L5030">        .Length = path_len_bytes,</span>
<span class="line" id="L5031">        .MaximumLength = path_len_bytes,</span>
<span class="line" id="L5032">        .Buffer = <span class="tok-builtin">@constCast</span>(sub_path_w),</span>
<span class="line" id="L5033">    };</span>
<span class="line" id="L5034">    <span class="tok-kw">var</span> attr = windows.OBJECT_ATTRIBUTES{</span>
<span class="line" id="L5035">        .Length = <span class="tok-builtin">@sizeOf</span>(windows.OBJECT_ATTRIBUTES),</span>
<span class="line" id="L5036">        .RootDirectory = <span class="tok-kw">if</span> (std.fs.path.isAbsoluteWindowsW(sub_path_w)) <span class="tok-null">null</span> <span class="tok-kw">else</span> dirfd,</span>
<span class="line" id="L5037">        .Attributes = <span class="tok-number">0</span>, <span class="tok-comment">// Note we do not use OBJ_CASE_INSENSITIVE here.</span>
</span>
<span class="line" id="L5038">        .ObjectName = &amp;nt_name,</span>
<span class="line" id="L5039">        .SecurityDescriptor = <span class="tok-null">null</span>,</span>
<span class="line" id="L5040">        .SecurityQualityOfService = <span class="tok-null">null</span>,</span>
<span class="line" id="L5041">    };</span>
<span class="line" id="L5042">    <span class="tok-kw">var</span> basic_info: windows.FILE_BASIC_INFORMATION = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L5043">    <span class="tok-kw">switch</span> (windows.ntdll.NtQueryAttributesFile(&amp;attr, &amp;basic_info)) {</span>
<span class="line" id="L5044">        .SUCCESS =&gt; <span class="tok-kw">return</span>,</span>
<span class="line" id="L5045">        .OBJECT_NAME_NOT_FOUND =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.FileNotFound,</span>
<span class="line" id="L5046">        .OBJECT_PATH_NOT_FOUND =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.FileNotFound,</span>
<span class="line" id="L5047">        .OBJECT_NAME_INVALID =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L5048">        .INVALID_PARAMETER =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L5049">        .ACCESS_DENIED =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.PermissionDenied,</span>
<span class="line" id="L5050">        .OBJECT_PATH_SYNTAX_BAD =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L5051">        <span class="tok-kw">else</span> =&gt; |rc| <span class="tok-kw">return</span> windows.unexpectedStatus(rc),</span>
<span class="line" id="L5052">    }</span>
<span class="line" id="L5053">}</span>
<span class="line" id="L5054"></span>
<span class="line" id="L5055"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> PipeError = <span class="tok-kw">error</span>{</span>
<span class="line" id="L5056">    SystemFdQuotaExceeded,</span>
<span class="line" id="L5057">    ProcessFdQuotaExceeded,</span>
<span class="line" id="L5058">} || UnexpectedError;</span>
<span class="line" id="L5059"></span>
<span class="line" id="L5060"><span class="tok-comment">/// Creates a unidirectional data channel that can be used for interprocess communication.</span></span>
<span class="line" id="L5061"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">pipe</span>() PipeError![<span class="tok-number">2</span>]fd_t {</span>
<span class="line" id="L5062">    <span class="tok-kw">var</span> fds: [<span class="tok-number">2</span>]fd_t = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L5063">    <span class="tok-kw">switch</span> (errno(system.pipe(&amp;fds))) {</span>
<span class="line" id="L5064">        .SUCCESS =&gt; <span class="tok-kw">return</span> fds,</span>
<span class="line" id="L5065">        .INVAL =&gt; <span class="tok-kw">unreachable</span>, <span class="tok-comment">// Invalid parameters to pipe()</span>
</span>
<span class="line" id="L5066">        .FAULT =&gt; <span class="tok-kw">unreachable</span>, <span class="tok-comment">// Invalid fds pointer</span>
</span>
<span class="line" id="L5067">        .NFILE =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.SystemFdQuotaExceeded,</span>
<span class="line" id="L5068">        .MFILE =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.ProcessFdQuotaExceeded,</span>
<span class="line" id="L5069">        <span class="tok-kw">else</span> =&gt; |err| <span class="tok-kw">return</span> unexpectedErrno(err),</span>
<span class="line" id="L5070">    }</span>
<span class="line" id="L5071">}</span>
<span class="line" id="L5072"></span>
<span class="line" id="L5073"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">pipe2</span>(flags: O) PipeError![<span class="tok-number">2</span>]fd_t {</span>
<span class="line" id="L5074">    <span class="tok-kw">if</span> (<span class="tok-builtin">@hasDecl</span>(system, <span class="tok-str">&quot;pipe2&quot;</span>)) {</span>
<span class="line" id="L5075">        <span class="tok-kw">var</span> fds: [<span class="tok-number">2</span>]fd_t = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L5076">        <span class="tok-kw">switch</span> (errno(system.pipe2(&amp;fds, flags))) {</span>
<span class="line" id="L5077">            .SUCCESS =&gt; <span class="tok-kw">return</span> fds,</span>
<span class="line" id="L5078">            .INVAL =&gt; <span class="tok-kw">unreachable</span>, <span class="tok-comment">// Invalid flags</span>
</span>
<span class="line" id="L5079">            .FAULT =&gt; <span class="tok-kw">unreachable</span>, <span class="tok-comment">// Invalid fds pointer</span>
</span>
<span class="line" id="L5080">            .NFILE =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.SystemFdQuotaExceeded,</span>
<span class="line" id="L5081">            .MFILE =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.ProcessFdQuotaExceeded,</span>
<span class="line" id="L5082">            <span class="tok-kw">else</span> =&gt; |err| <span class="tok-kw">return</span> unexpectedErrno(err),</span>
<span class="line" id="L5083">        }</span>
<span class="line" id="L5084">    }</span>
<span class="line" id="L5085"></span>
<span class="line" id="L5086">    <span class="tok-kw">const</span> fds: [<span class="tok-number">2</span>]fd_t = <span class="tok-kw">try</span> pipe();</span>
<span class="line" id="L5087">    <span class="tok-kw">errdefer</span> {</span>
<span class="line" id="L5088">        close(fds[<span class="tok-number">0</span>]);</span>
<span class="line" id="L5089">        close(fds[<span class="tok-number">1</span>]);</span>
<span class="line" id="L5090">    }</span>
<span class="line" id="L5091"></span>
<span class="line" id="L5092">    <span class="tok-comment">// https://github.com/ziglang/zig/issues/18882</span>
</span>
<span class="line" id="L5093">    <span class="tok-kw">if</span> (<span class="tok-builtin">@as</span>(<span class="tok-type">u32</span>, <span class="tok-builtin">@bitCast</span>(flags)) == <span class="tok-number">0</span>)</span>
<span class="line" id="L5094">        <span class="tok-kw">return</span> fds;</span>
<span class="line" id="L5095"></span>
<span class="line" id="L5096">    <span class="tok-comment">// CLOEXEC is special, it's a file descriptor flag and must be set using</span>
</span>
<span class="line" id="L5097">    <span class="tok-comment">// F.SETFD.</span>
</span>
<span class="line" id="L5098">    <span class="tok-kw">if</span> (flags.CLOEXEC) {</span>
<span class="line" id="L5099">        <span class="tok-kw">for</span> (fds) |fd| {</span>
<span class="line" id="L5100">            <span class="tok-kw">switch</span> (errno(system.fcntl(fd, F.SETFD, <span class="tok-builtin">@as</span>(<span class="tok-type">u32</span>, FD_CLOEXEC)))) {</span>
<span class="line" id="L5101">                .SUCCESS =&gt; {},</span>
<span class="line" id="L5102">                .INVAL =&gt; <span class="tok-kw">unreachable</span>, <span class="tok-comment">// Invalid flags</span>
</span>
<span class="line" id="L5103">                .BADF =&gt; <span class="tok-kw">unreachable</span>, <span class="tok-comment">// Always a race condition</span>
</span>
<span class="line" id="L5104">                <span class="tok-kw">else</span> =&gt; |err| <span class="tok-kw">return</span> unexpectedErrno(err),</span>
<span class="line" id="L5105">            }</span>
<span class="line" id="L5106">        }</span>
<span class="line" id="L5107">    }</span>
<span class="line" id="L5108"></span>
<span class="line" id="L5109">    <span class="tok-kw">const</span> new_flags: <span class="tok-type">u32</span> = f: {</span>
<span class="line" id="L5110">        <span class="tok-kw">var</span> new_flags = flags;</span>
<span class="line" id="L5111">        new_flags.CLOEXEC = <span class="tok-null">false</span>;</span>
<span class="line" id="L5112">        <span class="tok-kw">break</span> :f <span class="tok-builtin">@bitCast</span>(new_flags);</span>
<span class="line" id="L5113">    };</span>
<span class="line" id="L5114">    <span class="tok-comment">// Set every other flag affecting the file status using F.SETFL.</span>
</span>
<span class="line" id="L5115">    <span class="tok-kw">if</span> (new_flags != <span class="tok-number">0</span>) {</span>
<span class="line" id="L5116">        <span class="tok-kw">for</span> (fds) |fd| {</span>
<span class="line" id="L5117">            <span class="tok-kw">switch</span> (errno(system.fcntl(fd, F.SETFL, new_flags))) {</span>
<span class="line" id="L5118">                .SUCCESS =&gt; {},</span>
<span class="line" id="L5119">                .INVAL =&gt; <span class="tok-kw">unreachable</span>, <span class="tok-comment">// Invalid flags</span>
</span>
<span class="line" id="L5120">                .BADF =&gt; <span class="tok-kw">unreachable</span>, <span class="tok-comment">// Always a race condition</span>
</span>
<span class="line" id="L5121">                <span class="tok-kw">else</span> =&gt; |err| <span class="tok-kw">return</span> unexpectedErrno(err),</span>
<span class="line" id="L5122">            }</span>
<span class="line" id="L5123">        }</span>
<span class="line" id="L5124">    }</span>
<span class="line" id="L5125"></span>
<span class="line" id="L5126">    <span class="tok-kw">return</span> fds;</span>
<span class="line" id="L5127">}</span>
<span class="line" id="L5128"></span>
<span class="line" id="L5129"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> SysCtlError = <span class="tok-kw">error</span>{</span>
<span class="line" id="L5130">    PermissionDenied,</span>
<span class="line" id="L5131">    SystemResources,</span>
<span class="line" id="L5132">    NameTooLong,</span>
<span class="line" id="L5133">    UnknownName,</span>
<span class="line" id="L5134">} || UnexpectedError;</span>
<span class="line" id="L5135"></span>
<span class="line" id="L5136"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">sysctl</span>(</span>
<span class="line" id="L5137">    name: []<span class="tok-kw">const</span> <span class="tok-type">c_int</span>,</span>
<span class="line" id="L5138">    oldp: ?*<span class="tok-type">anyopaque</span>,</span>
<span class="line" id="L5139">    oldlenp: ?*<span class="tok-type">usize</span>,</span>
<span class="line" id="L5140">    newp: ?*<span class="tok-type">anyopaque</span>,</span>
<span class="line" id="L5141">    newlen: <span class="tok-type">usize</span>,</span>
<span class="line" id="L5142">) SysCtlError!<span class="tok-type">void</span> {</span>
<span class="line" id="L5143">    <span class="tok-kw">if</span> (builtin.os.tag == .wasi) {</span>
<span class="line" id="L5144">        <span class="tok-builtin">@panic</span>(<span class="tok-str">&quot;unsupported&quot;</span>); <span class="tok-comment">// TODO should be compile error, not panic</span>
</span>
<span class="line" id="L5145">    }</span>
<span class="line" id="L5146">    <span class="tok-kw">if</span> (builtin.os.tag == .haiku) {</span>
<span class="line" id="L5147">        <span class="tok-builtin">@panic</span>(<span class="tok-str">&quot;unsupported&quot;</span>); <span class="tok-comment">// TODO should be compile error, not panic</span>
</span>
<span class="line" id="L5148">    }</span>
<span class="line" id="L5149"></span>
<span class="line" id="L5150">    <span class="tok-kw">const</span> name_len = math.cast(<span class="tok-type">c_uint</span>, name.len) <span class="tok-kw">orelse</span> <span class="tok-kw">return</span> <span class="tok-kw">error</span>.NameTooLong;</span>
<span class="line" id="L5151">    <span class="tok-kw">switch</span> (errno(system.sysctl(name.ptr, name_len, oldp, oldlenp, newp, newlen))) {</span>
<span class="line" id="L5152">        .SUCCESS =&gt; <span class="tok-kw">return</span>,</span>
<span class="line" id="L5153">        .FAULT =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L5154">        .PERM =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.PermissionDenied,</span>
<span class="line" id="L5155">        .NOMEM =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.SystemResources,</span>
<span class="line" id="L5156">        .NOENT =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.UnknownName,</span>
<span class="line" id="L5157">        <span class="tok-kw">else</span> =&gt; |err| <span class="tok-kw">return</span> unexpectedErrno(err),</span>
<span class="line" id="L5158">    }</span>
<span class="line" id="L5159">}</span>
<span class="line" id="L5160"></span>
<span class="line" id="L5161"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">sysctlbynameZ</span>(</span>
<span class="line" id="L5162">    name: [*:<span class="tok-number">0</span>]<span class="tok-kw">const</span> <span class="tok-type">u8</span>,</span>
<span class="line" id="L5163">    oldp: ?*<span class="tok-type">anyopaque</span>,</span>
<span class="line" id="L5164">    oldlenp: ?*<span class="tok-type">usize</span>,</span>
<span class="line" id="L5165">    newp: ?*<span class="tok-type">anyopaque</span>,</span>
<span class="line" id="L5166">    newlen: <span class="tok-type">usize</span>,</span>
<span class="line" id="L5167">) SysCtlError!<span class="tok-type">void</span> {</span>
<span class="line" id="L5168">    <span class="tok-kw">if</span> (builtin.os.tag == .wasi) {</span>
<span class="line" id="L5169">        <span class="tok-builtin">@panic</span>(<span class="tok-str">&quot;unsupported&quot;</span>); <span class="tok-comment">// TODO should be compile error, not panic</span>
</span>
<span class="line" id="L5170">    }</span>
<span class="line" id="L5171">    <span class="tok-kw">if</span> (builtin.os.tag == .haiku) {</span>
<span class="line" id="L5172">        <span class="tok-builtin">@panic</span>(<span class="tok-str">&quot;unsupported&quot;</span>); <span class="tok-comment">// TODO should be compile error, not panic</span>
</span>
<span class="line" id="L5173">    }</span>
<span class="line" id="L5174"></span>
<span class="line" id="L5175">    <span class="tok-kw">switch</span> (errno(system.sysctlbyname(name, oldp, oldlenp, newp, newlen))) {</span>
<span class="line" id="L5176">        .SUCCESS =&gt; <span class="tok-kw">return</span>,</span>
<span class="line" id="L5177">        .FAULT =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L5178">        .PERM =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.PermissionDenied,</span>
<span class="line" id="L5179">        .NOMEM =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.SystemResources,</span>
<span class="line" id="L5180">        .NOENT =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.UnknownName,</span>
<span class="line" id="L5181">        <span class="tok-kw">else</span> =&gt; |err| <span class="tok-kw">return</span> unexpectedErrno(err),</span>
<span class="line" id="L5182">    }</span>
<span class="line" id="L5183">}</span>
<span class="line" id="L5184"></span>
<span class="line" id="L5185"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">gettimeofday</span>(tv: ?*timeval, tz: ?*timezone) <span class="tok-type">void</span> {</span>
<span class="line" id="L5186">    <span class="tok-kw">switch</span> (errno(system.gettimeofday(tv, tz))) {</span>
<span class="line" id="L5187">        .SUCCESS =&gt; <span class="tok-kw">return</span>,</span>
<span class="line" id="L5188">        .INVAL =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L5189">        <span class="tok-kw">else</span> =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L5190">    }</span>
<span class="line" id="L5191">}</span>
<span class="line" id="L5192"></span>
<span class="line" id="L5193"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> SeekError = <span class="tok-kw">error</span>{</span>
<span class="line" id="L5194">    Unseekable,</span>
<span class="line" id="L5195"></span>
<span class="line" id="L5196">    <span class="tok-comment">/// In WASI, this error may occur when the file descriptor does</span></span>
<span class="line" id="L5197">    <span class="tok-comment">/// not hold the required rights to seek on it.</span></span>
<span class="line" id="L5198">    AccessDenied,</span>
<span class="line" id="L5199">} || UnexpectedError;</span>
<span class="line" id="L5200"></span>
<span class="line" id="L5201"><span class="tok-comment">/// Repositions read/write file offset relative to the beginning.</span></span>
<span class="line" id="L5202"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">lseek_SET</span>(fd: fd_t, offset: <span class="tok-type">u64</span>) SeekError!<span class="tok-type">void</span> {</span>
<span class="line" id="L5203">    <span class="tok-kw">if</span> (builtin.os.tag == .linux <span class="tok-kw">and</span> !builtin.link_libc <span class="tok-kw">and</span> <span class="tok-builtin">@sizeOf</span>(<span class="tok-type">usize</span>) == <span class="tok-number">4</span>) {</span>
<span class="line" id="L5204">        <span class="tok-kw">var</span> result: <span class="tok-type">u64</span> = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L5205">        <span class="tok-kw">switch</span> (errno(system.llseek(fd, offset, &amp;result, SEEK.SET))) {</span>
<span class="line" id="L5206">            .SUCCESS =&gt; <span class="tok-kw">return</span>,</span>
<span class="line" id="L5207">            .BADF =&gt; <span class="tok-kw">unreachable</span>, <span class="tok-comment">// always a race condition</span>
</span>
<span class="line" id="L5208">            .INVAL =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.Unseekable,</span>
<span class="line" id="L5209">            .OVERFLOW =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.Unseekable,</span>
<span class="line" id="L5210">            .SPIPE =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.Unseekable,</span>
<span class="line" id="L5211">            .NXIO =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.Unseekable,</span>
<span class="line" id="L5212">            <span class="tok-kw">else</span> =&gt; |err| <span class="tok-kw">return</span> unexpectedErrno(err),</span>
<span class="line" id="L5213">        }</span>
<span class="line" id="L5214">    }</span>
<span class="line" id="L5215">    <span class="tok-kw">if</span> (builtin.os.tag == .windows) {</span>
<span class="line" id="L5216">        <span class="tok-kw">return</span> windows.SetFilePointerEx_BEGIN(fd, offset);</span>
<span class="line" id="L5217">    }</span>
<span class="line" id="L5218">    <span class="tok-kw">if</span> (builtin.os.tag == .wasi <span class="tok-kw">and</span> !builtin.link_libc) {</span>
<span class="line" id="L5219">        <span class="tok-kw">var</span> new_offset: wasi.filesize_t = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L5220">        <span class="tok-kw">switch</span> (wasi.fd_seek(fd, <span class="tok-builtin">@bitCast</span>(offset), .SET, &amp;new_offset)) {</span>
<span class="line" id="L5221">            .SUCCESS =&gt; <span class="tok-kw">return</span>,</span>
<span class="line" id="L5222">            .BADF =&gt; <span class="tok-kw">unreachable</span>, <span class="tok-comment">// always a race condition</span>
</span>
<span class="line" id="L5223">            .INVAL =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.Unseekable,</span>
<span class="line" id="L5224">            .OVERFLOW =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.Unseekable,</span>
<span class="line" id="L5225">            .SPIPE =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.Unseekable,</span>
<span class="line" id="L5226">            .NXIO =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.Unseekable,</span>
<span class="line" id="L5227">            .NOTCAPABLE =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.AccessDenied,</span>
<span class="line" id="L5228">            <span class="tok-kw">else</span> =&gt; |err| <span class="tok-kw">return</span> unexpectedErrno(err),</span>
<span class="line" id="L5229">        }</span>
<span class="line" id="L5230">    }</span>
<span class="line" id="L5231"></span>
<span class="line" id="L5232">    <span class="tok-kw">const</span> lseek_sym = <span class="tok-kw">if</span> (lfs64_abi) system.lseek64 <span class="tok-kw">else</span> system.lseek;</span>
<span class="line" id="L5233">    <span class="tok-kw">switch</span> (errno(lseek_sym(fd, <span class="tok-builtin">@bitCast</span>(offset), SEEK.SET))) {</span>
<span class="line" id="L5234">        .SUCCESS =&gt; <span class="tok-kw">return</span>,</span>
<span class="line" id="L5235">        .BADF =&gt; <span class="tok-kw">unreachable</span>, <span class="tok-comment">// always a race condition</span>
</span>
<span class="line" id="L5236">        .INVAL =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.Unseekable,</span>
<span class="line" id="L5237">        .OVERFLOW =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.Unseekable,</span>
<span class="line" id="L5238">        .SPIPE =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.Unseekable,</span>
<span class="line" id="L5239">        .NXIO =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.Unseekable,</span>
<span class="line" id="L5240">        <span class="tok-kw">else</span> =&gt; |err| <span class="tok-kw">return</span> unexpectedErrno(err),</span>
<span class="line" id="L5241">    }</span>
<span class="line" id="L5242">}</span>
<span class="line" id="L5243"></span>
<span class="line" id="L5244"><span class="tok-comment">/// Repositions read/write file offset relative to the current offset.</span></span>
<span class="line" id="L5245"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">lseek_CUR</span>(fd: fd_t, offset: <span class="tok-type">i64</span>) SeekError!<span class="tok-type">void</span> {</span>
<span class="line" id="L5246">    <span class="tok-kw">if</span> (builtin.os.tag == .linux <span class="tok-kw">and</span> !builtin.link_libc <span class="tok-kw">and</span> <span class="tok-builtin">@sizeOf</span>(<span class="tok-type">usize</span>) == <span class="tok-number">4</span>) {</span>
<span class="line" id="L5247">        <span class="tok-kw">var</span> result: <span class="tok-type">u64</span> = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L5248">        <span class="tok-kw">switch</span> (errno(system.llseek(fd, <span class="tok-builtin">@bitCast</span>(offset), &amp;result, SEEK.CUR))) {</span>
<span class="line" id="L5249">            .SUCCESS =&gt; <span class="tok-kw">return</span>,</span>
<span class="line" id="L5250">            .BADF =&gt; <span class="tok-kw">unreachable</span>, <span class="tok-comment">// always a race condition</span>
</span>
<span class="line" id="L5251">            .INVAL =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.Unseekable,</span>
<span class="line" id="L5252">            .OVERFLOW =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.Unseekable,</span>
<span class="line" id="L5253">            .SPIPE =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.Unseekable,</span>
<span class="line" id="L5254">            .NXIO =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.Unseekable,</span>
<span class="line" id="L5255">            <span class="tok-kw">else</span> =&gt; |err| <span class="tok-kw">return</span> unexpectedErrno(err),</span>
<span class="line" id="L5256">        }</span>
<span class="line" id="L5257">    }</span>
<span class="line" id="L5258">    <span class="tok-kw">if</span> (builtin.os.tag == .windows) {</span>
<span class="line" id="L5259">        <span class="tok-kw">return</span> windows.SetFilePointerEx_CURRENT(fd, offset);</span>
<span class="line" id="L5260">    }</span>
<span class="line" id="L5261">    <span class="tok-kw">if</span> (builtin.os.tag == .wasi <span class="tok-kw">and</span> !builtin.link_libc) {</span>
<span class="line" id="L5262">        <span class="tok-kw">var</span> new_offset: wasi.filesize_t = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L5263">        <span class="tok-kw">switch</span> (wasi.fd_seek(fd, offset, .CUR, &amp;new_offset)) {</span>
<span class="line" id="L5264">            .SUCCESS =&gt; <span class="tok-kw">return</span>,</span>
<span class="line" id="L5265">            .BADF =&gt; <span class="tok-kw">unreachable</span>, <span class="tok-comment">// always a race condition</span>
</span>
<span class="line" id="L5266">            .INVAL =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.Unseekable,</span>
<span class="line" id="L5267">            .OVERFLOW =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.Unseekable,</span>
<span class="line" id="L5268">            .SPIPE =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.Unseekable,</span>
<span class="line" id="L5269">            .NXIO =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.Unseekable,</span>
<span class="line" id="L5270">            .NOTCAPABLE =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.AccessDenied,</span>
<span class="line" id="L5271">            <span class="tok-kw">else</span> =&gt; |err| <span class="tok-kw">return</span> unexpectedErrno(err),</span>
<span class="line" id="L5272">        }</span>
<span class="line" id="L5273">    }</span>
<span class="line" id="L5274">    <span class="tok-kw">const</span> lseek_sym = <span class="tok-kw">if</span> (lfs64_abi) system.lseek64 <span class="tok-kw">else</span> system.lseek;</span>
<span class="line" id="L5275">    <span class="tok-kw">switch</span> (errno(lseek_sym(fd, <span class="tok-builtin">@bitCast</span>(offset), SEEK.CUR))) {</span>
<span class="line" id="L5276">        .SUCCESS =&gt; <span class="tok-kw">return</span>,</span>
<span class="line" id="L5277">        .BADF =&gt; <span class="tok-kw">unreachable</span>, <span class="tok-comment">// always a race condition</span>
</span>
<span class="line" id="L5278">        .INVAL =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.Unseekable,</span>
<span class="line" id="L5279">        .OVERFLOW =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.Unseekable,</span>
<span class="line" id="L5280">        .SPIPE =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.Unseekable,</span>
<span class="line" id="L5281">        .NXIO =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.Unseekable,</span>
<span class="line" id="L5282">        <span class="tok-kw">else</span> =&gt; |err| <span class="tok-kw">return</span> unexpectedErrno(err),</span>
<span class="line" id="L5283">    }</span>
<span class="line" id="L5284">}</span>
<span class="line" id="L5285"></span>
<span class="line" id="L5286"><span class="tok-comment">/// Repositions read/write file offset relative to the end.</span></span>
<span class="line" id="L5287"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">lseek_END</span>(fd: fd_t, offset: <span class="tok-type">i64</span>) SeekError!<span class="tok-type">void</span> {</span>
<span class="line" id="L5288">    <span class="tok-kw">if</span> (builtin.os.tag == .linux <span class="tok-kw">and</span> !builtin.link_libc <span class="tok-kw">and</span> <span class="tok-builtin">@sizeOf</span>(<span class="tok-type">usize</span>) == <span class="tok-number">4</span>) {</span>
<span class="line" id="L5289">        <span class="tok-kw">var</span> result: <span class="tok-type">u64</span> = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L5290">        <span class="tok-kw">switch</span> (errno(system.llseek(fd, <span class="tok-builtin">@bitCast</span>(offset), &amp;result, SEEK.END))) {</span>
<span class="line" id="L5291">            .SUCCESS =&gt; <span class="tok-kw">return</span>,</span>
<span class="line" id="L5292">            .BADF =&gt; <span class="tok-kw">unreachable</span>, <span class="tok-comment">// always a race condition</span>
</span>
<span class="line" id="L5293">            .INVAL =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.Unseekable,</span>
<span class="line" id="L5294">            .OVERFLOW =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.Unseekable,</span>
<span class="line" id="L5295">            .SPIPE =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.Unseekable,</span>
<span class="line" id="L5296">            .NXIO =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.Unseekable,</span>
<span class="line" id="L5297">            <span class="tok-kw">else</span> =&gt; |err| <span class="tok-kw">return</span> unexpectedErrno(err),</span>
<span class="line" id="L5298">        }</span>
<span class="line" id="L5299">    }</span>
<span class="line" id="L5300">    <span class="tok-kw">if</span> (builtin.os.tag == .windows) {</span>
<span class="line" id="L5301">        <span class="tok-kw">return</span> windows.SetFilePointerEx_END(fd, offset);</span>
<span class="line" id="L5302">    }</span>
<span class="line" id="L5303">    <span class="tok-kw">if</span> (builtin.os.tag == .wasi <span class="tok-kw">and</span> !builtin.link_libc) {</span>
<span class="line" id="L5304">        <span class="tok-kw">var</span> new_offset: wasi.filesize_t = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L5305">        <span class="tok-kw">switch</span> (wasi.fd_seek(fd, offset, .END, &amp;new_offset)) {</span>
<span class="line" id="L5306">            .SUCCESS =&gt; <span class="tok-kw">return</span>,</span>
<span class="line" id="L5307">            .BADF =&gt; <span class="tok-kw">unreachable</span>, <span class="tok-comment">// always a race condition</span>
</span>
<span class="line" id="L5308">            .INVAL =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.Unseekable,</span>
<span class="line" id="L5309">            .OVERFLOW =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.Unseekable,</span>
<span class="line" id="L5310">            .SPIPE =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.Unseekable,</span>
<span class="line" id="L5311">            .NXIO =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.Unseekable,</span>
<span class="line" id="L5312">            .NOTCAPABLE =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.AccessDenied,</span>
<span class="line" id="L5313">            <span class="tok-kw">else</span> =&gt; |err| <span class="tok-kw">return</span> unexpectedErrno(err),</span>
<span class="line" id="L5314">        }</span>
<span class="line" id="L5315">    }</span>
<span class="line" id="L5316">    <span class="tok-kw">const</span> lseek_sym = <span class="tok-kw">if</span> (lfs64_abi) system.lseek64 <span class="tok-kw">else</span> system.lseek;</span>
<span class="line" id="L5317">    <span class="tok-kw">switch</span> (errno(lseek_sym(fd, <span class="tok-builtin">@bitCast</span>(offset), SEEK.END))) {</span>
<span class="line" id="L5318">        .SUCCESS =&gt; <span class="tok-kw">return</span>,</span>
<span class="line" id="L5319">        .BADF =&gt; <span class="tok-kw">unreachable</span>, <span class="tok-comment">// always a race condition</span>
</span>
<span class="line" id="L5320">        .INVAL =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.Unseekable,</span>
<span class="line" id="L5321">        .OVERFLOW =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.Unseekable,</span>
<span class="line" id="L5322">        .SPIPE =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.Unseekable,</span>
<span class="line" id="L5323">        .NXIO =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.Unseekable,</span>
<span class="line" id="L5324">        <span class="tok-kw">else</span> =&gt; |err| <span class="tok-kw">return</span> unexpectedErrno(err),</span>
<span class="line" id="L5325">    }</span>
<span class="line" id="L5326">}</span>
<span class="line" id="L5327"></span>
<span class="line" id="L5328"><span class="tok-comment">/// Returns the read/write file offset relative to the beginning.</span></span>
<span class="line" id="L5329"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">lseek_CUR_get</span>(fd: fd_t) SeekError!<span class="tok-type">u64</span> {</span>
<span class="line" id="L5330">    <span class="tok-kw">if</span> (builtin.os.tag == .linux <span class="tok-kw">and</span> !builtin.link_libc <span class="tok-kw">and</span> <span class="tok-builtin">@sizeOf</span>(<span class="tok-type">usize</span>) == <span class="tok-number">4</span>) {</span>
<span class="line" id="L5331">        <span class="tok-kw">var</span> result: <span class="tok-type">u64</span> = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L5332">        <span class="tok-kw">switch</span> (errno(system.llseek(fd, <span class="tok-number">0</span>, &amp;result, SEEK.CUR))) {</span>
<span class="line" id="L5333">            .SUCCESS =&gt; <span class="tok-kw">return</span> result,</span>
<span class="line" id="L5334">            .BADF =&gt; <span class="tok-kw">unreachable</span>, <span class="tok-comment">// always a race condition</span>
</span>
<span class="line" id="L5335">            .INVAL =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.Unseekable,</span>
<span class="line" id="L5336">            .OVERFLOW =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.Unseekable,</span>
<span class="line" id="L5337">            .SPIPE =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.Unseekable,</span>
<span class="line" id="L5338">            .NXIO =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.Unseekable,</span>
<span class="line" id="L5339">            <span class="tok-kw">else</span> =&gt; |err| <span class="tok-kw">return</span> unexpectedErrno(err),</span>
<span class="line" id="L5340">        }</span>
<span class="line" id="L5341">    }</span>
<span class="line" id="L5342">    <span class="tok-kw">if</span> (builtin.os.tag == .windows) {</span>
<span class="line" id="L5343">        <span class="tok-kw">return</span> windows.SetFilePointerEx_CURRENT_get(fd);</span>
<span class="line" id="L5344">    }</span>
<span class="line" id="L5345">    <span class="tok-kw">if</span> (builtin.os.tag == .wasi <span class="tok-kw">and</span> !builtin.link_libc) {</span>
<span class="line" id="L5346">        <span class="tok-kw">var</span> new_offset: wasi.filesize_t = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L5347">        <span class="tok-kw">switch</span> (wasi.fd_seek(fd, <span class="tok-number">0</span>, .CUR, &amp;new_offset)) {</span>
<span class="line" id="L5348">            .SUCCESS =&gt; <span class="tok-kw">return</span> new_offset,</span>
<span class="line" id="L5349">            .BADF =&gt; <span class="tok-kw">unreachable</span>, <span class="tok-comment">// always a race condition</span>
</span>
<span class="line" id="L5350">            .INVAL =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.Unseekable,</span>
<span class="line" id="L5351">            .OVERFLOW =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.Unseekable,</span>
<span class="line" id="L5352">            .SPIPE =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.Unseekable,</span>
<span class="line" id="L5353">            .NXIO =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.Unseekable,</span>
<span class="line" id="L5354">            .NOTCAPABLE =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.AccessDenied,</span>
<span class="line" id="L5355">            <span class="tok-kw">else</span> =&gt; |err| <span class="tok-kw">return</span> unexpectedErrno(err),</span>
<span class="line" id="L5356">        }</span>
<span class="line" id="L5357">    }</span>
<span class="line" id="L5358">    <span class="tok-kw">const</span> lseek_sym = <span class="tok-kw">if</span> (lfs64_abi) system.lseek64 <span class="tok-kw">else</span> system.lseek;</span>
<span class="line" id="L5359">    <span class="tok-kw">const</span> rc = lseek_sym(fd, <span class="tok-number">0</span>, SEEK.CUR);</span>
<span class="line" id="L5360">    <span class="tok-kw">switch</span> (errno(rc)) {</span>
<span class="line" id="L5361">        .SUCCESS =&gt; <span class="tok-kw">return</span> <span class="tok-builtin">@bitCast</span>(rc),</span>
<span class="line" id="L5362">        .BADF =&gt; <span class="tok-kw">unreachable</span>, <span class="tok-comment">// always a race condition</span>
</span>
<span class="line" id="L5363">        .INVAL =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.Unseekable,</span>
<span class="line" id="L5364">        .OVERFLOW =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.Unseekable,</span>
<span class="line" id="L5365">        .SPIPE =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.Unseekable,</span>
<span class="line" id="L5366">        .NXIO =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.Unseekable,</span>
<span class="line" id="L5367">        <span class="tok-kw">else</span> =&gt; |err| <span class="tok-kw">return</span> unexpectedErrno(err),</span>
<span class="line" id="L5368">    }</span>
<span class="line" id="L5369">}</span>
<span class="line" id="L5370"></span>
<span class="line" id="L5371"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FcntlError = <span class="tok-kw">error</span>{</span>
<span class="line" id="L5372">    PermissionDenied,</span>
<span class="line" id="L5373">    FileBusy,</span>
<span class="line" id="L5374">    ProcessFdQuotaExceeded,</span>
<span class="line" id="L5375">    Locked,</span>
<span class="line" id="L5376">    DeadLock,</span>
<span class="line" id="L5377">    LockedRegionLimitExceeded,</span>
<span class="line" id="L5378">} || UnexpectedError;</span>
<span class="line" id="L5379"></span>
<span class="line" id="L5380"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">fcntl</span>(fd: fd_t, cmd: <span class="tok-type">i32</span>, arg: <span class="tok-type">usize</span>) FcntlError!<span class="tok-type">usize</span> {</span>
<span class="line" id="L5381">    <span class="tok-kw">while</span> (<span class="tok-null">true</span>) {</span>
<span class="line" id="L5382">        <span class="tok-kw">const</span> rc = system.fcntl(fd, cmd, arg);</span>
<span class="line" id="L5383">        <span class="tok-kw">switch</span> (errno(rc)) {</span>
<span class="line" id="L5384">            .SUCCESS =&gt; <span class="tok-kw">return</span> <span class="tok-builtin">@intCast</span>(rc),</span>
<span class="line" id="L5385">            .INTR =&gt; <span class="tok-kw">continue</span>,</span>
<span class="line" id="L5386">            .AGAIN, .ACCES =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.Locked,</span>
<span class="line" id="L5387">            .BADF =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L5388">            .BUSY =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.FileBusy,</span>
<span class="line" id="L5389">            .INVAL =&gt; <span class="tok-kw">unreachable</span>, <span class="tok-comment">// invalid parameters</span>
</span>
<span class="line" id="L5390">            .PERM =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.PermissionDenied,</span>
<span class="line" id="L5391">            .MFILE =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.ProcessFdQuotaExceeded,</span>
<span class="line" id="L5392">            .NOTDIR =&gt; <span class="tok-kw">unreachable</span>, <span class="tok-comment">// invalid parameter</span>
</span>
<span class="line" id="L5393">            .DEADLK =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.DeadLock,</span>
<span class="line" id="L5394">            .NOLCK =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.LockedRegionLimitExceeded,</span>
<span class="line" id="L5395">            <span class="tok-kw">else</span> =&gt; |err| <span class="tok-kw">return</span> unexpectedErrno(err),</span>
<span class="line" id="L5396">        }</span>
<span class="line" id="L5397">    }</span>
<span class="line" id="L5398">}</span>
<span class="line" id="L5399"></span>
<span class="line" id="L5400"><span class="tok-kw">fn</span> <span class="tok-fn">setSockFlags</span>(sock: socket_t, flags: <span class="tok-type">u32</span>) !<span class="tok-type">void</span> {</span>
<span class="line" id="L5401">    <span class="tok-kw">if</span> ((flags &amp; SOCK.CLOEXEC) != <span class="tok-number">0</span>) {</span>
<span class="line" id="L5402">        <span class="tok-kw">if</span> (builtin.os.tag == .windows) {</span>
<span class="line" id="L5403">            <span class="tok-comment">// TODO: Find out if this is supported for sockets</span>
</span>
<span class="line" id="L5404">        } <span class="tok-kw">else</span> {</span>
<span class="line" id="L5405">            <span class="tok-kw">var</span> fd_flags = fcntl(sock, F.GETFD, <span class="tok-number">0</span>) <span class="tok-kw">catch</span> |err| <span class="tok-kw">switch</span> (err) {</span>
<span class="line" id="L5406">                <span class="tok-kw">error</span>.FileBusy =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L5407">                <span class="tok-kw">error</span>.Locked =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L5408">                <span class="tok-kw">error</span>.PermissionDenied =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L5409">                <span class="tok-kw">error</span>.DeadLock =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L5410">                <span class="tok-kw">error</span>.LockedRegionLimitExceeded =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L5411">                <span class="tok-kw">else</span> =&gt; |e| <span class="tok-kw">return</span> e,</span>
<span class="line" id="L5412">            };</span>
<span class="line" id="L5413">            fd_flags |= FD_CLOEXEC;</span>
<span class="line" id="L5414">            _ = fcntl(sock, F.SETFD, fd_flags) <span class="tok-kw">catch</span> |err| <span class="tok-kw">switch</span> (err) {</span>
<span class="line" id="L5415">                <span class="tok-kw">error</span>.FileBusy =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L5416">                <span class="tok-kw">error</span>.Locked =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L5417">                <span class="tok-kw">error</span>.PermissionDenied =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L5418">                <span class="tok-kw">error</span>.DeadLock =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L5419">                <span class="tok-kw">error</span>.LockedRegionLimitExceeded =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L5420">                <span class="tok-kw">else</span> =&gt; |e| <span class="tok-kw">return</span> e,</span>
<span class="line" id="L5421">            };</span>
<span class="line" id="L5422">        }</span>
<span class="line" id="L5423">    }</span>
<span class="line" id="L5424">    <span class="tok-kw">if</span> ((flags &amp; SOCK.NONBLOCK) != <span class="tok-number">0</span>) {</span>
<span class="line" id="L5425">        <span class="tok-kw">if</span> (builtin.os.tag == .windows) {</span>
<span class="line" id="L5426">            <span class="tok-kw">var</span> mode: <span class="tok-type">c_ulong</span> = <span class="tok-number">1</span>;</span>
<span class="line" id="L5427">            <span class="tok-kw">if</span> (windows.ws2_32.ioctlsocket(sock, windows.ws2_32.FIONBIO, &amp;mode) == windows.ws2_32.SOCKET_ERROR) {</span>
<span class="line" id="L5428">                <span class="tok-kw">switch</span> (windows.ws2_32.WSAGetLastError()) {</span>
<span class="line" id="L5429">                    .WSANOTINITIALISED =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L5430">                    .WSAENETDOWN =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.NetworkSubsystemFailed,</span>
<span class="line" id="L5431">                    .WSAENOTSOCK =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.FileDescriptorNotASocket,</span>
<span class="line" id="L5432">                    <span class="tok-comment">// TODO: handle more errors</span>
</span>
<span class="line" id="L5433">                    <span class="tok-kw">else</span> =&gt; |err| <span class="tok-kw">return</span> windows.unexpectedWSAError(err),</span>
<span class="line" id="L5434">                }</span>
<span class="line" id="L5435">            }</span>
<span class="line" id="L5436">        } <span class="tok-kw">else</span> {</span>
<span class="line" id="L5437">            <span class="tok-kw">var</span> fl_flags = fcntl(sock, F.GETFL, <span class="tok-number">0</span>) <span class="tok-kw">catch</span> |err| <span class="tok-kw">switch</span> (err) {</span>
<span class="line" id="L5438">                <span class="tok-kw">error</span>.FileBusy =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L5439">                <span class="tok-kw">error</span>.Locked =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L5440">                <span class="tok-kw">error</span>.PermissionDenied =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L5441">                <span class="tok-kw">error</span>.DeadLock =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L5442">                <span class="tok-kw">error</span>.LockedRegionLimitExceeded =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L5443">                <span class="tok-kw">else</span> =&gt; |e| <span class="tok-kw">return</span> e,</span>
<span class="line" id="L5444">            };</span>
<span class="line" id="L5445">            fl_flags |= <span class="tok-number">1</span> &lt;&lt; <span class="tok-builtin">@bitOffsetOf</span>(O, <span class="tok-str">&quot;NONBLOCK&quot;</span>);</span>
<span class="line" id="L5446">            _ = fcntl(sock, F.SETFL, fl_flags) <span class="tok-kw">catch</span> |err| <span class="tok-kw">switch</span> (err) {</span>
<span class="line" id="L5447">                <span class="tok-kw">error</span>.FileBusy =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L5448">                <span class="tok-kw">error</span>.Locked =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L5449">                <span class="tok-kw">error</span>.PermissionDenied =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L5450">                <span class="tok-kw">error</span>.DeadLock =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L5451">                <span class="tok-kw">error</span>.LockedRegionLimitExceeded =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L5452">                <span class="tok-kw">else</span> =&gt; |e| <span class="tok-kw">return</span> e,</span>
<span class="line" id="L5453">            };</span>
<span class="line" id="L5454">        }</span>
<span class="line" id="L5455">    }</span>
<span class="line" id="L5456">}</span>
<span class="line" id="L5457"></span>
<span class="line" id="L5458"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FlockError = <span class="tok-kw">error</span>{</span>
<span class="line" id="L5459">    WouldBlock,</span>
<span class="line" id="L5460"></span>
<span class="line" id="L5461">    <span class="tok-comment">/// The kernel ran out of memory for allocating file locks</span></span>
<span class="line" id="L5462">    SystemResources,</span>
<span class="line" id="L5463"></span>
<span class="line" id="L5464">    <span class="tok-comment">/// The underlying filesystem does not support file locks</span></span>
<span class="line" id="L5465">    FileLocksNotSupported,</span>
<span class="line" id="L5466">} || UnexpectedError;</span>
<span class="line" id="L5467"></span>
<span class="line" id="L5468"><span class="tok-comment">/// Depending on the operating system `flock` may or may not interact with</span></span>
<span class="line" id="L5469"><span class="tok-comment">/// `fcntl` locks made by other processes.</span></span>
<span class="line" id="L5470"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">flock</span>(fd: fd_t, operation: <span class="tok-type">i32</span>) FlockError!<span class="tok-type">void</span> {</span>
<span class="line" id="L5471">    <span class="tok-kw">while</span> (<span class="tok-null">true</span>) {</span>
<span class="line" id="L5472">        <span class="tok-kw">const</span> rc = system.flock(fd, operation);</span>
<span class="line" id="L5473">        <span class="tok-kw">switch</span> (errno(rc)) {</span>
<span class="line" id="L5474">            .SUCCESS =&gt; <span class="tok-kw">return</span>,</span>
<span class="line" id="L5475">            .BADF =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L5476">            .INTR =&gt; <span class="tok-kw">continue</span>,</span>
<span class="line" id="L5477">            .INVAL =&gt; <span class="tok-kw">unreachable</span>, <span class="tok-comment">// invalid parameters</span>
</span>
<span class="line" id="L5478">            .NOLCK =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.SystemResources,</span>
<span class="line" id="L5479">            .AGAIN =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.WouldBlock, <span class="tok-comment">// TODO: integrate with async instead of just returning an error</span>
</span>
<span class="line" id="L5480">            .OPNOTSUPP =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.FileLocksNotSupported,</span>
<span class="line" id="L5481">            <span class="tok-kw">else</span> =&gt; |err| <span class="tok-kw">return</span> unexpectedErrno(err),</span>
<span class="line" id="L5482">        }</span>
<span class="line" id="L5483">    }</span>
<span class="line" id="L5484">}</span>
<span class="line" id="L5485"></span>
<span class="line" id="L5486"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> RealPathError = <span class="tok-kw">error</span>{</span>
<span class="line" id="L5487">    FileNotFound,</span>
<span class="line" id="L5488">    AccessDenied,</span>
<span class="line" id="L5489">    NameTooLong,</span>
<span class="line" id="L5490">    NotSupported,</span>
<span class="line" id="L5491">    NotDir,</span>
<span class="line" id="L5492">    SymLinkLoop,</span>
<span class="line" id="L5493">    InputOutput,</span>
<span class="line" id="L5494">    FileTooBig,</span>
<span class="line" id="L5495">    IsDir,</span>
<span class="line" id="L5496">    ProcessFdQuotaExceeded,</span>
<span class="line" id="L5497">    SystemFdQuotaExceeded,</span>
<span class="line" id="L5498">    NoDevice,</span>
<span class="line" id="L5499">    SystemResources,</span>
<span class="line" id="L5500">    NoSpaceLeft,</span>
<span class="line" id="L5501">    FileSystem,</span>
<span class="line" id="L5502">    BadPathName,</span>
<span class="line" id="L5503">    DeviceBusy,</span>
<span class="line" id="L5504"></span>
<span class="line" id="L5505">    SharingViolation,</span>
<span class="line" id="L5506">    PipeBusy,</span>
<span class="line" id="L5507"></span>
<span class="line" id="L5508">    <span class="tok-comment">/// Windows-only; file paths provided by the user must be valid WTF-8.</span></span>
<span class="line" id="L5509">    <span class="tok-comment">/// https://simonsapin.github.io/wtf-8/</span></span>
<span class="line" id="L5510">    InvalidWtf8,</span>
<span class="line" id="L5511"></span>
<span class="line" id="L5512">    <span class="tok-comment">/// On Windows, `\\server` or `\\server\share` was not found.</span></span>
<span class="line" id="L5513">    NetworkNotFound,</span>
<span class="line" id="L5514"></span>
<span class="line" id="L5515">    PathAlreadyExists,</span>
<span class="line" id="L5516"></span>
<span class="line" id="L5517">    <span class="tok-comment">/// On Windows, antivirus software is enabled by default. It can be</span></span>
<span class="line" id="L5518">    <span class="tok-comment">/// disabled, but Windows Update sometimes ignores the user's preference</span></span>
<span class="line" id="L5519">    <span class="tok-comment">/// and re-enables it. When enabled, antivirus software on Windows</span></span>
<span class="line" id="L5520">    <span class="tok-comment">/// intercepts file system operations and makes them significantly slower</span></span>
<span class="line" id="L5521">    <span class="tok-comment">/// in addition to possibly failing with this error code.</span></span>
<span class="line" id="L5522">    AntivirusInterference,</span>
<span class="line" id="L5523"></span>
<span class="line" id="L5524">    <span class="tok-comment">/// On Windows, the volume does not contain a recognized file system. File</span></span>
<span class="line" id="L5525">    <span class="tok-comment">/// system drivers might not be loaded, or the volume may be corrupt.</span></span>
<span class="line" id="L5526">    UnrecognizedVolume,</span>
<span class="line" id="L5527">} || UnexpectedError;</span>
<span class="line" id="L5528"></span>
<span class="line" id="L5529"><span class="tok-comment">/// Return the canonicalized absolute pathname.</span></span>
<span class="line" id="L5530"><span class="tok-comment">/// Expands all symbolic links and resolves references to `.`, `..`, and</span></span>
<span class="line" id="L5531"><span class="tok-comment">/// extra `/` characters in `pathname`.</span></span>
<span class="line" id="L5532"><span class="tok-comment">/// On Windows, `pathname` should be encoded as [WTF-8](https://simonsapin.github.io/wtf-8/).</span></span>
<span class="line" id="L5533"><span class="tok-comment">/// On other platforms, `pathname` is an opaque sequence of bytes with no particular encoding.</span></span>
<span class="line" id="L5534"><span class="tok-comment">/// The return value is a slice of `out_buffer`, but not necessarily from the beginning.</span></span>
<span class="line" id="L5535"><span class="tok-comment">/// See also `realpathZ` and `realpathW`.</span></span>
<span class="line" id="L5536"><span class="tok-comment">/// On Windows, the result is encoded as [WTF-8](https://simonsapin.github.io/wtf-8/).</span></span>
<span class="line" id="L5537"><span class="tok-comment">/// On other platforms, the result is an opaque sequence of bytes with no particular encoding.</span></span>
<span class="line" id="L5538"><span class="tok-comment">/// Calling this function is usually a bug.</span></span>
<span class="line" id="L5539"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">realpath</span>(pathname: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>, out_buffer: *[MAX_PATH_BYTES]<span class="tok-type">u8</span>) RealPathError![]<span class="tok-type">u8</span> {</span>
<span class="line" id="L5540">    <span class="tok-kw">if</span> (builtin.os.tag == .windows) {</span>
<span class="line" id="L5541">        <span class="tok-kw">const</span> pathname_w = <span class="tok-kw">try</span> windows.sliceToPrefixedFileW(<span class="tok-null">null</span>, pathname);</span>
<span class="line" id="L5542">        <span class="tok-kw">return</span> realpathW(pathname_w.span(), out_buffer);</span>
<span class="line" id="L5543">    } <span class="tok-kw">else</span> <span class="tok-kw">if</span> (builtin.os.tag == .wasi <span class="tok-kw">and</span> !builtin.link_libc) {</span>
<span class="line" id="L5544">        <span class="tok-builtin">@compileError</span>(<span class="tok-str">&quot;WASI does not support os.realpath&quot;</span>);</span>
<span class="line" id="L5545">    }</span>
<span class="line" id="L5546">    <span class="tok-kw">const</span> pathname_c = <span class="tok-kw">try</span> toPosixPath(pathname);</span>
<span class="line" id="L5547">    <span class="tok-kw">return</span> realpathZ(&amp;pathname_c, out_buffer);</span>
<span class="line" id="L5548">}</span>
<span class="line" id="L5549"></span>
<span class="line" id="L5550"><span class="tok-comment">/// Same as `realpath` except `pathname` is null-terminated.</span></span>
<span class="line" id="L5551"><span class="tok-comment">/// Calling this function is usually a bug.</span></span>
<span class="line" id="L5552"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">realpathZ</span>(pathname: [*:<span class="tok-number">0</span>]<span class="tok-kw">const</span> <span class="tok-type">u8</span>, out_buffer: *[MAX_PATH_BYTES]<span class="tok-type">u8</span>) RealPathError![]<span class="tok-type">u8</span> {</span>
<span class="line" id="L5553">    <span class="tok-kw">if</span> (builtin.os.tag == .windows) {</span>
<span class="line" id="L5554">        <span class="tok-kw">const</span> pathname_w = <span class="tok-kw">try</span> windows.cStrToPrefixedFileW(<span class="tok-null">null</span>, pathname);</span>
<span class="line" id="L5555">        <span class="tok-kw">return</span> realpathW(pathname_w.span(), out_buffer);</span>
<span class="line" id="L5556">    } <span class="tok-kw">else</span> <span class="tok-kw">if</span> (builtin.os.tag == .wasi <span class="tok-kw">and</span> !builtin.link_libc) {</span>
<span class="line" id="L5557">        <span class="tok-kw">return</span> realpath(mem.sliceTo(pathname, <span class="tok-number">0</span>), out_buffer);</span>
<span class="line" id="L5558">    }</span>
<span class="line" id="L5559">    <span class="tok-kw">if</span> (!builtin.link_libc) {</span>
<span class="line" id="L5560">        <span class="tok-kw">const</span> flags: O = <span class="tok-kw">switch</span> (builtin.os.tag) {</span>
<span class="line" id="L5561">            .linux =&gt; .{</span>
<span class="line" id="L5562">                .NONBLOCK = <span class="tok-null">true</span>,</span>
<span class="line" id="L5563">                .CLOEXEC = <span class="tok-null">true</span>,</span>
<span class="line" id="L5564">                .PATH = <span class="tok-null">true</span>,</span>
<span class="line" id="L5565">            },</span>
<span class="line" id="L5566">            <span class="tok-kw">else</span> =&gt; .{</span>
<span class="line" id="L5567">                .NONBLOCK = <span class="tok-null">true</span>,</span>
<span class="line" id="L5568">                .CLOEXEC = <span class="tok-null">true</span>,</span>
<span class="line" id="L5569">            },</span>
<span class="line" id="L5570">        };</span>
<span class="line" id="L5571">        <span class="tok-kw">const</span> fd = openZ(pathname, flags, <span class="tok-number">0</span>) <span class="tok-kw">catch</span> |err| <span class="tok-kw">switch</span> (err) {</span>
<span class="line" id="L5572">            <span class="tok-kw">error</span>.FileLocksNotSupported =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L5573">            <span class="tok-kw">error</span>.WouldBlock =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L5574">            <span class="tok-kw">error</span>.FileBusy =&gt; <span class="tok-kw">unreachable</span>, <span class="tok-comment">// not asking for write permissions</span>
</span>
<span class="line" id="L5575">            <span class="tok-kw">error</span>.InvalidUtf8 =&gt; <span class="tok-kw">unreachable</span>, <span class="tok-comment">// WASI-only</span>
</span>
<span class="line" id="L5576">            <span class="tok-kw">else</span> =&gt; |e| <span class="tok-kw">return</span> e,</span>
<span class="line" id="L5577">        };</span>
<span class="line" id="L5578">        <span class="tok-kw">defer</span> close(fd);</span>
<span class="line" id="L5579"></span>
<span class="line" id="L5580">        <span class="tok-kw">return</span> getFdPath(fd, out_buffer);</span>
<span class="line" id="L5581">    }</span>
<span class="line" id="L5582">    <span class="tok-kw">const</span> result_path = std.c.realpath(pathname, out_buffer) <span class="tok-kw">orelse</span> <span class="tok-kw">switch</span> (<span class="tok-builtin">@as</span>(E, <span class="tok-builtin">@enumFromInt</span>(std.c._errno().*))) {</span>
<span class="line" id="L5583">        .SUCCESS =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L5584">        .INVAL =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L5585">        .BADF =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L5586">        .FAULT =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L5587">        .ACCES =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.AccessDenied,</span>
<span class="line" id="L5588">        .NOENT =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.FileNotFound,</span>
<span class="line" id="L5589">        .OPNOTSUPP =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.NotSupported,</span>
<span class="line" id="L5590">        .NOTDIR =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.NotDir,</span>
<span class="line" id="L5591">        .NAMETOOLONG =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.NameTooLong,</span>
<span class="line" id="L5592">        .LOOP =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.SymLinkLoop,</span>
<span class="line" id="L5593">        .IO =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.InputOutput,</span>
<span class="line" id="L5594">        <span class="tok-kw">else</span> =&gt; |err| <span class="tok-kw">return</span> unexpectedErrno(err),</span>
<span class="line" id="L5595">    };</span>
<span class="line" id="L5596">    <span class="tok-kw">return</span> mem.sliceTo(result_path, <span class="tok-number">0</span>);</span>
<span class="line" id="L5597">}</span>
<span class="line" id="L5598"></span>
<span class="line" id="L5599"><span class="tok-comment">/// Same as `realpath` except `pathname` is WTF16LE-encoded.</span></span>
<span class="line" id="L5600"><span class="tok-comment">/// The result is encoded as [WTF-8](https://simonsapin.github.io/wtf-8/).</span></span>
<span class="line" id="L5601"><span class="tok-comment">/// Calling this function is usually a bug.</span></span>
<span class="line" id="L5602"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">realpathW</span>(pathname: []<span class="tok-kw">const</span> <span class="tok-type">u16</span>, out_buffer: *[MAX_PATH_BYTES]<span class="tok-type">u8</span>) RealPathError![]<span class="tok-type">u8</span> {</span>
<span class="line" id="L5603">    <span class="tok-kw">const</span> w = windows;</span>
<span class="line" id="L5604"></span>
<span class="line" id="L5605">    <span class="tok-kw">const</span> dir = std.fs.cwd().fd;</span>
<span class="line" id="L5606">    <span class="tok-kw">const</span> access_mask = w.GENERIC_READ | w.SYNCHRONIZE;</span>
<span class="line" id="L5607">    <span class="tok-kw">const</span> share_access = w.FILE_SHARE_READ;</span>
<span class="line" id="L5608">    <span class="tok-kw">const</span> creation = w.FILE_OPEN;</span>
<span class="line" id="L5609">    <span class="tok-kw">const</span> h_file = blk: {</span>
<span class="line" id="L5610">        <span class="tok-kw">const</span> res = w.OpenFile(pathname, .{</span>
<span class="line" id="L5611">            .dir = dir,</span>
<span class="line" id="L5612">            .access_mask = access_mask,</span>
<span class="line" id="L5613">            .share_access = share_access,</span>
<span class="line" id="L5614">            .creation = creation,</span>
<span class="line" id="L5615">            .filter = .any,</span>
<span class="line" id="L5616">        }) <span class="tok-kw">catch</span> |err| <span class="tok-kw">switch</span> (err) {</span>
<span class="line" id="L5617">            <span class="tok-kw">error</span>.WouldBlock =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L5618">            <span class="tok-kw">else</span> =&gt; |e| <span class="tok-kw">return</span> e,</span>
<span class="line" id="L5619">        };</span>
<span class="line" id="L5620">        <span class="tok-kw">break</span> :blk res;</span>
<span class="line" id="L5621">    };</span>
<span class="line" id="L5622">    <span class="tok-kw">defer</span> w.CloseHandle(h_file);</span>
<span class="line" id="L5623"></span>
<span class="line" id="L5624">    <span class="tok-kw">return</span> getFdPath(h_file, out_buffer);</span>
<span class="line" id="L5625">}</span>
<span class="line" id="L5626"></span>
<span class="line" id="L5627"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">isGetFdPathSupportedOnTarget</span>(os: std.Target.Os) <span class="tok-type">bool</span> {</span>
<span class="line" id="L5628">    <span class="tok-kw">return</span> <span class="tok-kw">switch</span> (os.tag) {</span>
<span class="line" id="L5629">        .windows,</span>
<span class="line" id="L5630">        .macos,</span>
<span class="line" id="L5631">        .ios,</span>
<span class="line" id="L5632">        .watchos,</span>
<span class="line" id="L5633">        .tvos,</span>
<span class="line" id="L5634">        .linux,</span>
<span class="line" id="L5635">        .solaris,</span>
<span class="line" id="L5636">        .illumos,</span>
<span class="line" id="L5637">        .freebsd,</span>
<span class="line" id="L5638">        =&gt; <span class="tok-null">true</span>,</span>
<span class="line" id="L5639"></span>
<span class="line" id="L5640">        .dragonfly =&gt; os.version_range.semver.max.order(.{ .major = <span class="tok-number">6</span>, .minor = <span class="tok-number">0</span>, .patch = <span class="tok-number">0</span> }) != .lt,</span>
<span class="line" id="L5641">        .netbsd =&gt; os.version_range.semver.max.order(.{ .major = <span class="tok-number">10</span>, .minor = <span class="tok-number">0</span>, .patch = <span class="tok-number">0</span> }) != .lt,</span>
<span class="line" id="L5642">        <span class="tok-kw">else</span> =&gt; <span class="tok-null">false</span>,</span>
<span class="line" id="L5643">    };</span>
<span class="line" id="L5644">}</span>
<span class="line" id="L5645"></span>
<span class="line" id="L5646"><span class="tok-comment">/// Return canonical path of handle `fd`.</span></span>
<span class="line" id="L5647"><span class="tok-comment">/// This function is very host-specific and is not universally supported by all hosts.</span></span>
<span class="line" id="L5648"><span class="tok-comment">/// For example, while it generally works on Linux, macOS, FreeBSD or Windows, it is</span></span>
<span class="line" id="L5649"><span class="tok-comment">/// unsupported on WASI.</span></span>
<span class="line" id="L5650"><span class="tok-comment">/// On Windows, the result is encoded as [WTF-8](https://simonsapin.github.io/wtf-8/).</span></span>
<span class="line" id="L5651"><span class="tok-comment">/// On other platforms, the result is an opaque sequence of bytes with no particular encoding.</span></span>
<span class="line" id="L5652"><span class="tok-comment">/// Calling this function is usually a bug.</span></span>
<span class="line" id="L5653"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">getFdPath</span>(fd: fd_t, out_buffer: *[MAX_PATH_BYTES]<span class="tok-type">u8</span>) RealPathError![]<span class="tok-type">u8</span> {</span>
<span class="line" id="L5654">    <span class="tok-kw">if</span> (!<span class="tok-kw">comptime</span> isGetFdPathSupportedOnTarget(builtin.os)) {</span>
<span class="line" id="L5655">        <span class="tok-builtin">@compileError</span>(<span class="tok-str">&quot;querying for canonical path of a handle is unsupported on this host&quot;</span>);</span>
<span class="line" id="L5656">    }</span>
<span class="line" id="L5657">    <span class="tok-kw">switch</span> (builtin.os.tag) {</span>
<span class="line" id="L5658">        .windows =&gt; {</span>
<span class="line" id="L5659">            <span class="tok-kw">var</span> wide_buf: [windows.PATH_MAX_WIDE]<span class="tok-type">u16</span> = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L5660">            <span class="tok-kw">const</span> wide_slice = <span class="tok-kw">try</span> windows.GetFinalPathNameByHandle(fd, .{}, wide_buf[<span class="tok-number">0</span>..]);</span>
<span class="line" id="L5661"></span>
<span class="line" id="L5662">            <span class="tok-kw">const</span> end_index = std.unicode.wtf16LeToWtf8(out_buffer, wide_slice);</span>
<span class="line" id="L5663">            <span class="tok-kw">return</span> out_buffer[<span class="tok-number">0</span>..end_index];</span>
<span class="line" id="L5664">        },</span>
<span class="line" id="L5665">        .macos, .ios, .watchos, .tvos =&gt; {</span>
<span class="line" id="L5666">            <span class="tok-comment">// On macOS, we can use F.GETPATH fcntl command to query the OS for</span>
</span>
<span class="line" id="L5667">            <span class="tok-comment">// the path to the file descriptor.</span>
</span>
<span class="line" id="L5668">            <span class="tok-builtin">@memset</span>(out_buffer[<span class="tok-number">0</span>..MAX_PATH_BYTES], <span class="tok-number">0</span>);</span>
<span class="line" id="L5669">            <span class="tok-kw">switch</span> (errno(system.fcntl(fd, F.GETPATH, out_buffer))) {</span>
<span class="line" id="L5670">                .SUCCESS =&gt; {},</span>
<span class="line" id="L5671">                .BADF =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.FileNotFound,</span>
<span class="line" id="L5672">                .NOSPC =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.NameTooLong,</span>
<span class="line" id="L5673">                <span class="tok-comment">// TODO man pages for fcntl on macOS don't really tell you what</span>
</span>
<span class="line" id="L5674">                <span class="tok-comment">// errno values to expect when command is F.GETPATH...</span>
</span>
<span class="line" id="L5675">                <span class="tok-kw">else</span> =&gt; |err| <span class="tok-kw">return</span> unexpectedErrno(err),</span>
<span class="line" id="L5676">            }</span>
<span class="line" id="L5677">            <span class="tok-kw">const</span> len = mem.indexOfScalar(<span class="tok-type">u8</span>, out_buffer[<span class="tok-number">0</span>..], <span class="tok-number">0</span>) <span class="tok-kw">orelse</span> MAX_PATH_BYTES;</span>
<span class="line" id="L5678">            <span class="tok-kw">return</span> out_buffer[<span class="tok-number">0</span>..len];</span>
<span class="line" id="L5679">        },</span>
<span class="line" id="L5680">        .linux =&gt; {</span>
<span class="line" id="L5681">            <span class="tok-kw">var</span> procfs_buf: [<span class="tok-str">&quot;/proc/self/fd/-2147483648\x00&quot;</span>.len]<span class="tok-type">u8</span> = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L5682">            <span class="tok-kw">const</span> proc_path = std.fmt.bufPrintZ(procfs_buf[<span class="tok-number">0</span>..], <span class="tok-str">&quot;/proc/self/fd/{d}&quot;</span>, .{fd}) <span class="tok-kw">catch</span> <span class="tok-kw">unreachable</span>;</span>
<span class="line" id="L5683"></span>
<span class="line" id="L5684">            <span class="tok-kw">const</span> target = readlinkZ(proc_path, out_buffer) <span class="tok-kw">catch</span> |err| {</span>
<span class="line" id="L5685">                <span class="tok-kw">switch</span> (err) {</span>
<span class="line" id="L5686">                    <span class="tok-kw">error</span>.NotLink =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L5687">                    <span class="tok-kw">error</span>.BadPathName =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L5688">                    <span class="tok-kw">error</span>.InvalidUtf8 =&gt; <span class="tok-kw">unreachable</span>, <span class="tok-comment">// WASI-only</span>
</span>
<span class="line" id="L5689">                    <span class="tok-kw">error</span>.InvalidWtf8 =&gt; <span class="tok-kw">unreachable</span>, <span class="tok-comment">// Windows-only</span>
</span>
<span class="line" id="L5690">                    <span class="tok-kw">error</span>.UnsupportedReparsePointType =&gt; <span class="tok-kw">unreachable</span>, <span class="tok-comment">// Windows-only</span>
</span>
<span class="line" id="L5691">                    <span class="tok-kw">error</span>.NetworkNotFound =&gt; <span class="tok-kw">unreachable</span>, <span class="tok-comment">// Windows-only</span>
</span>
<span class="line" id="L5692">                    <span class="tok-kw">else</span> =&gt; |e| <span class="tok-kw">return</span> e,</span>
<span class="line" id="L5693">                }</span>
<span class="line" id="L5694">            };</span>
<span class="line" id="L5695">            <span class="tok-kw">return</span> target;</span>
<span class="line" id="L5696">        },</span>
<span class="line" id="L5697">        .solaris, .illumos =&gt; {</span>
<span class="line" id="L5698">            <span class="tok-kw">var</span> procfs_buf: [<span class="tok-str">&quot;/proc/self/path/-2147483648\x00&quot;</span>.len]<span class="tok-type">u8</span> = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L5699">            <span class="tok-kw">const</span> proc_path = std.fmt.bufPrintZ(procfs_buf[<span class="tok-number">0</span>..], <span class="tok-str">&quot;/proc/self/path/{d}&quot;</span>, .{fd}) <span class="tok-kw">catch</span> <span class="tok-kw">unreachable</span>;</span>
<span class="line" id="L5700"></span>
<span class="line" id="L5701">            <span class="tok-kw">const</span> target = readlinkZ(proc_path, out_buffer) <span class="tok-kw">catch</span> |err| <span class="tok-kw">switch</span> (err) {</span>
<span class="line" id="L5702">                <span class="tok-kw">error</span>.UnsupportedReparsePointType =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L5703">                <span class="tok-kw">error</span>.NotLink =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L5704">                <span class="tok-kw">else</span> =&gt; |e| <span class="tok-kw">return</span> e,</span>
<span class="line" id="L5705">            };</span>
<span class="line" id="L5706">            <span class="tok-kw">return</span> target;</span>
<span class="line" id="L5707">        },</span>
<span class="line" id="L5708">        .freebsd =&gt; {</span>
<span class="line" id="L5709">            <span class="tok-kw">if</span> (<span class="tok-kw">comptime</span> builtin.os.isAtLeast(.freebsd, .{ .major = <span class="tok-number">13</span>, .minor = <span class="tok-number">0</span>, .patch = <span class="tok-number">0</span> }) <span class="tok-kw">orelse</span> <span class="tok-null">false</span>) {</span>
<span class="line" id="L5710">                <span class="tok-kw">var</span> kfile: system.kinfo_file = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L5711">                kfile.structsize = system.KINFO_FILE_SIZE;</span>
<span class="line" id="L5712">                <span class="tok-kw">switch</span> (errno(system.fcntl(fd, system.F.KINFO, <span class="tok-builtin">@intFromPtr</span>(&amp;kfile)))) {</span>
<span class="line" id="L5713">                    .SUCCESS =&gt; {},</span>
<span class="line" id="L5714">                    .BADF =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.FileNotFound,</span>
<span class="line" id="L5715">                    <span class="tok-kw">else</span> =&gt; |err| <span class="tok-kw">return</span> unexpectedErrno(err),</span>
<span class="line" id="L5716">                }</span>
<span class="line" id="L5717">                <span class="tok-kw">const</span> len = mem.indexOfScalar(<span class="tok-type">u8</span>, &amp;kfile.path, <span class="tok-number">0</span>) <span class="tok-kw">orelse</span> MAX_PATH_BYTES;</span>
<span class="line" id="L5718">                <span class="tok-kw">if</span> (len == <span class="tok-number">0</span>) <span class="tok-kw">return</span> <span class="tok-kw">error</span>.NameTooLong;</span>
<span class="line" id="L5719">                <span class="tok-kw">const</span> result = out_buffer[<span class="tok-number">0</span>..len];</span>
<span class="line" id="L5720">                <span class="tok-builtin">@memcpy</span>(result, kfile.path[<span class="tok-number">0</span>..len]);</span>
<span class="line" id="L5721">                <span class="tok-kw">return</span> result;</span>
<span class="line" id="L5722">            } <span class="tok-kw">else</span> {</span>
<span class="line" id="L5723">                <span class="tok-comment">// This fallback implementation reimplements libutil's `kinfo_getfile()`.</span>
</span>
<span class="line" id="L5724">                <span class="tok-comment">// The motivation is to avoid linking -lutil when building zig or general</span>
</span>
<span class="line" id="L5725">                <span class="tok-comment">// user executables.</span>
</span>
<span class="line" id="L5726">                <span class="tok-kw">var</span> mib = [<span class="tok-number">4</span>]<span class="tok-type">c_int</span>{ CTL.KERN, KERN.PROC, KERN.PROC_FILEDESC, system.getpid() };</span>
<span class="line" id="L5727">                <span class="tok-kw">var</span> len: <span class="tok-type">usize</span> = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L5728">                sysctl(&amp;mib, <span class="tok-null">null</span>, &amp;len, <span class="tok-null">null</span>, <span class="tok-number">0</span>) <span class="tok-kw">catch</span> |err| <span class="tok-kw">switch</span> (err) {</span>
<span class="line" id="L5729">                    <span class="tok-kw">error</span>.PermissionDenied =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L5730">                    <span class="tok-kw">error</span>.SystemResources =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.SystemResources,</span>
<span class="line" id="L5731">                    <span class="tok-kw">error</span>.NameTooLong =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L5732">                    <span class="tok-kw">error</span>.UnknownName =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L5733">                    <span class="tok-kw">else</span> =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.Unexpected,</span>
<span class="line" id="L5734">                };</span>
<span class="line" id="L5735">                len = len * <span class="tok-number">4</span> / <span class="tok-number">3</span>;</span>
<span class="line" id="L5736">                <span class="tok-kw">const</span> buf = std.heap.c_allocator.alloc(<span class="tok-type">u8</span>, len) <span class="tok-kw">catch</span> <span class="tok-kw">return</span> <span class="tok-kw">error</span>.SystemResources;</span>
<span class="line" id="L5737">                <span class="tok-kw">defer</span> std.heap.c_allocator.free(buf);</span>
<span class="line" id="L5738">                len = buf.len;</span>
<span class="line" id="L5739">                sysctl(&amp;mib, &amp;buf[<span class="tok-number">0</span>], &amp;len, <span class="tok-null">null</span>, <span class="tok-number">0</span>) <span class="tok-kw">catch</span> |err| <span class="tok-kw">switch</span> (err) {</span>
<span class="line" id="L5740">                    <span class="tok-kw">error</span>.PermissionDenied =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L5741">                    <span class="tok-kw">error</span>.SystemResources =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.SystemResources,</span>
<span class="line" id="L5742">                    <span class="tok-kw">error</span>.NameTooLong =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L5743">                    <span class="tok-kw">error</span>.UnknownName =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L5744">                    <span class="tok-kw">else</span> =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.Unexpected,</span>
<span class="line" id="L5745">                };</span>
<span class="line" id="L5746">                <span class="tok-kw">var</span> i: <span class="tok-type">usize</span> = <span class="tok-number">0</span>;</span>
<span class="line" id="L5747">                <span class="tok-kw">while</span> (i &lt; len) {</span>
<span class="line" id="L5748">                    <span class="tok-kw">const</span> kf: *<span class="tok-kw">align</span>(<span class="tok-number">1</span>) system.kinfo_file = <span class="tok-builtin">@ptrCast</span>(&amp;buf[i]);</span>
<span class="line" id="L5749">                    <span class="tok-kw">if</span> (kf.fd == fd) {</span>
<span class="line" id="L5750">                        len = mem.indexOfScalar(<span class="tok-type">u8</span>, &amp;kf.path, <span class="tok-number">0</span>) <span class="tok-kw">orelse</span> MAX_PATH_BYTES;</span>
<span class="line" id="L5751">                        <span class="tok-kw">if</span> (len == <span class="tok-number">0</span>) <span class="tok-kw">return</span> <span class="tok-kw">error</span>.NameTooLong;</span>
<span class="line" id="L5752">                        <span class="tok-kw">const</span> result = out_buffer[<span class="tok-number">0</span>..len];</span>
<span class="line" id="L5753">                        <span class="tok-builtin">@memcpy</span>(result, kf.path[<span class="tok-number">0</span>..len]);</span>
<span class="line" id="L5754">                        <span class="tok-kw">return</span> result;</span>
<span class="line" id="L5755">                    }</span>
<span class="line" id="L5756">                    i += <span class="tok-builtin">@intCast</span>(kf.structsize);</span>
<span class="line" id="L5757">                }</span>
<span class="line" id="L5758">                <span class="tok-kw">return</span> <span class="tok-kw">error</span>.FileNotFound;</span>
<span class="line" id="L5759">            }</span>
<span class="line" id="L5760">        },</span>
<span class="line" id="L5761">        .dragonfly =&gt; {</span>
<span class="line" id="L5762">            <span class="tok-builtin">@memset</span>(out_buffer[<span class="tok-number">0</span>..MAX_PATH_BYTES], <span class="tok-number">0</span>);</span>
<span class="line" id="L5763">            <span class="tok-kw">switch</span> (errno(system.fcntl(fd, F.GETPATH, out_buffer))) {</span>
<span class="line" id="L5764">                .SUCCESS =&gt; {},</span>
<span class="line" id="L5765">                .BADF =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.FileNotFound,</span>
<span class="line" id="L5766">                .RANGE =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.NameTooLong,</span>
<span class="line" id="L5767">                <span class="tok-kw">else</span> =&gt; |err| <span class="tok-kw">return</span> unexpectedErrno(err),</span>
<span class="line" id="L5768">            }</span>
<span class="line" id="L5769">            <span class="tok-kw">const</span> len = mem.indexOfScalar(<span class="tok-type">u8</span>, out_buffer[<span class="tok-number">0</span>..], <span class="tok-number">0</span>) <span class="tok-kw">orelse</span> MAX_PATH_BYTES;</span>
<span class="line" id="L5770">            <span class="tok-kw">return</span> out_buffer[<span class="tok-number">0</span>..len];</span>
<span class="line" id="L5771">        },</span>
<span class="line" id="L5772">        .netbsd =&gt; {</span>
<span class="line" id="L5773">            <span class="tok-builtin">@memset</span>(out_buffer[<span class="tok-number">0</span>..MAX_PATH_BYTES], <span class="tok-number">0</span>);</span>
<span class="line" id="L5774">            <span class="tok-kw">switch</span> (errno(system.fcntl(fd, F.GETPATH, out_buffer))) {</span>
<span class="line" id="L5775">                .SUCCESS =&gt; {},</span>
<span class="line" id="L5776">                .ACCES =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.AccessDenied,</span>
<span class="line" id="L5777">                .BADF =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.FileNotFound,</span>
<span class="line" id="L5778">                .NOENT =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.FileNotFound,</span>
<span class="line" id="L5779">                .NOMEM =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.SystemResources,</span>
<span class="line" id="L5780">                .RANGE =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.NameTooLong,</span>
<span class="line" id="L5781">                <span class="tok-kw">else</span> =&gt; |err| <span class="tok-kw">return</span> unexpectedErrno(err),</span>
<span class="line" id="L5782">            }</span>
<span class="line" id="L5783">            <span class="tok-kw">const</span> len = mem.indexOfScalar(<span class="tok-type">u8</span>, out_buffer[<span class="tok-number">0</span>..], <span class="tok-number">0</span>) <span class="tok-kw">orelse</span> MAX_PATH_BYTES;</span>
<span class="line" id="L5784">            <span class="tok-kw">return</span> out_buffer[<span class="tok-number">0</span>..len];</span>
<span class="line" id="L5785">        },</span>
<span class="line" id="L5786">        <span class="tok-kw">else</span> =&gt; <span class="tok-kw">unreachable</span>, <span class="tok-comment">// made unreachable by isGetFdPathSupportedOnTarget above</span>
</span>
<span class="line" id="L5787">    }</span>
<span class="line" id="L5788">}</span>
<span class="line" id="L5789"></span>
<span class="line" id="L5790"><span class="tok-comment">/// Spurious wakeups are possible and no precision of timing is guaranteed.</span></span>
<span class="line" id="L5791"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">nanosleep</span>(seconds: <span class="tok-type">u64</span>, nanoseconds: <span class="tok-type">u64</span>) <span class="tok-type">void</span> {</span>
<span class="line" id="L5792">    <span class="tok-kw">var</span> req = timespec{</span>
<span class="line" id="L5793">        .tv_sec = math.cast(<span class="tok-type">isize</span>, seconds) <span class="tok-kw">orelse</span> math.maxInt(<span class="tok-type">isize</span>),</span>
<span class="line" id="L5794">        .tv_nsec = math.cast(<span class="tok-type">isize</span>, nanoseconds) <span class="tok-kw">orelse</span> math.maxInt(<span class="tok-type">isize</span>),</span>
<span class="line" id="L5795">    };</span>
<span class="line" id="L5796">    <span class="tok-kw">var</span> rem: timespec = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L5797">    <span class="tok-kw">while</span> (<span class="tok-null">true</span>) {</span>
<span class="line" id="L5798">        <span class="tok-kw">switch</span> (errno(system.nanosleep(&amp;req, &amp;rem))) {</span>
<span class="line" id="L5799">            .FAULT =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L5800">            .INVAL =&gt; {</span>
<span class="line" id="L5801">                <span class="tok-comment">// Sometimes Darwin returns EINVAL for no reason.</span>
</span>
<span class="line" id="L5802">                <span class="tok-comment">// We treat it as a spurious wakeup.</span>
</span>
<span class="line" id="L5803">                <span class="tok-kw">return</span>;</span>
<span class="line" id="L5804">            },</span>
<span class="line" id="L5805">            .INTR =&gt; {</span>
<span class="line" id="L5806">                req = rem;</span>
<span class="line" id="L5807">                <span class="tok-kw">continue</span>;</span>
<span class="line" id="L5808">            },</span>
<span class="line" id="L5809">            <span class="tok-comment">// This prong handles success as well as unexpected errors.</span>
</span>
<span class="line" id="L5810">            <span class="tok-kw">else</span> =&gt; <span class="tok-kw">return</span>,</span>
<span class="line" id="L5811">        }</span>
<span class="line" id="L5812">    }</span>
<span class="line" id="L5813">}</span>
<span class="line" id="L5814"></span>
<span class="line" id="L5815"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">dl_iterate_phdr</span>(</span>
<span class="line" id="L5816">    context: <span class="tok-kw">anytype</span>,</span>
<span class="line" id="L5817">    <span class="tok-kw">comptime</span> Error: <span class="tok-type">type</span>,</span>
<span class="line" id="L5818">    <span class="tok-kw">comptime</span> callback: <span class="tok-kw">fn</span> (info: *dl_phdr_info, size: <span class="tok-type">usize</span>, context: <span class="tok-builtin">@TypeOf</span>(context)) Error!<span class="tok-type">void</span>,</span>
<span class="line" id="L5819">) Error!<span class="tok-type">void</span> {</span>
<span class="line" id="L5820">    <span class="tok-kw">const</span> Context = <span class="tok-builtin">@TypeOf</span>(context);</span>
<span class="line" id="L5821"></span>
<span class="line" id="L5822">    <span class="tok-kw">switch</span> (builtin.object_format) {</span>
<span class="line" id="L5823">        .elf, .c =&gt; {},</span>
<span class="line" id="L5824">        <span class="tok-kw">else</span> =&gt; <span class="tok-builtin">@compileError</span>(<span class="tok-str">&quot;dl_iterate_phdr is not available for this target&quot;</span>),</span>
<span class="line" id="L5825">    }</span>
<span class="line" id="L5826"></span>
<span class="line" id="L5827">    <span class="tok-kw">if</span> (builtin.link_libc) {</span>
<span class="line" id="L5828">        <span class="tok-kw">switch</span> (system.dl_iterate_phdr(<span class="tok-kw">struct</span> {</span>
<span class="line" id="L5829">            <span class="tok-kw">fn</span> <span class="tok-fn">callbackC</span>(info: *dl_phdr_info, size: <span class="tok-type">usize</span>, data: ?*<span class="tok-type">anyopaque</span>) <span class="tok-kw">callconv</span>(.C) <span class="tok-type">c_int</span> {</span>
<span class="line" id="L5830">                <span class="tok-kw">const</span> context_ptr: *<span class="tok-kw">const</span> Context = <span class="tok-builtin">@ptrCast</span>(<span class="tok-builtin">@alignCast</span>(data));</span>
<span class="line" id="L5831">                callback(info, size, context_ptr.*) <span class="tok-kw">catch</span> |err| <span class="tok-kw">return</span> <span class="tok-builtin">@intFromError</span>(err);</span>
<span class="line" id="L5832">                <span class="tok-kw">return</span> <span class="tok-number">0</span>;</span>
<span class="line" id="L5833">            }</span>
<span class="line" id="L5834">        }.callbackC, <span class="tok-builtin">@ptrCast</span>(<span class="tok-builtin">@constCast</span>(&amp;context)))) {</span>
<span class="line" id="L5835">            <span class="tok-number">0</span> =&gt; <span class="tok-kw">return</span>,</span>
<span class="line" id="L5836">            <span class="tok-kw">else</span> =&gt; |err| <span class="tok-kw">return</span> <span class="tok-builtin">@as</span>(Error, <span class="tok-builtin">@errorCast</span>(<span class="tok-builtin">@errorFromInt</span>(<span class="tok-builtin">@as</span>(std.meta.Int(.unsigned, <span class="tok-builtin">@bitSizeOf</span>(<span class="tok-type">anyerror</span>)), <span class="tok-builtin">@intCast</span>(err))))),</span>
<span class="line" id="L5837">        }</span>
<span class="line" id="L5838">    }</span>
<span class="line" id="L5839"></span>
<span class="line" id="L5840">    <span class="tok-kw">const</span> elf_base = std.process.getBaseAddress();</span>
<span class="line" id="L5841">    <span class="tok-kw">const</span> ehdr: *elf.Ehdr = <span class="tok-builtin">@ptrFromInt</span>(elf_base);</span>
<span class="line" id="L5842">    <span class="tok-comment">// Make sure the base address points to an ELF image.</span>
</span>
<span class="line" id="L5843">    assert(mem.eql(<span class="tok-type">u8</span>, ehdr.e_ident[<span class="tok-number">0</span>..<span class="tok-number">4</span>], elf.MAGIC));</span>
<span class="line" id="L5844">    <span class="tok-kw">const</span> n_phdr = ehdr.e_phnum;</span>
<span class="line" id="L5845">    <span class="tok-kw">const</span> phdrs = (<span class="tok-builtin">@as</span>([*]elf.Phdr, <span class="tok-builtin">@ptrFromInt</span>(elf_base + ehdr.e_phoff)))[<span class="tok-number">0</span>..n_phdr];</span>
<span class="line" id="L5846"></span>
<span class="line" id="L5847">    <span class="tok-kw">var</span> it = dl.linkmap_iterator(phdrs) <span class="tok-kw">catch</span> <span class="tok-kw">unreachable</span>;</span>
<span class="line" id="L5848"></span>
<span class="line" id="L5849">    <span class="tok-comment">// The executable has no dynamic link segment, create a single entry for</span>
</span>
<span class="line" id="L5850">    <span class="tok-comment">// the whole ELF image.</span>
</span>
<span class="line" id="L5851">    <span class="tok-kw">if</span> (it.end()) {</span>
<span class="line" id="L5852">        <span class="tok-comment">// Find the base address for the ELF image, if this is a PIE the value</span>
</span>
<span class="line" id="L5853">        <span class="tok-comment">// is non-zero.</span>
</span>
<span class="line" id="L5854">        <span class="tok-kw">const</span> base_address = <span class="tok-kw">for</span> (phdrs) |*phdr| {</span>
<span class="line" id="L5855">            <span class="tok-kw">if</span> (phdr.p_type == elf.PT_PHDR) {</span>
<span class="line" id="L5856">                <span class="tok-kw">break</span> <span class="tok-builtin">@intFromPtr</span>(phdrs.ptr) - phdr.p_vaddr;</span>
<span class="line" id="L5857">                <span class="tok-comment">// We could try computing the difference between _DYNAMIC and</span>
</span>
<span class="line" id="L5858">                <span class="tok-comment">// the p_vaddr of the PT_DYNAMIC section, but using the phdr is</span>
</span>
<span class="line" id="L5859">                <span class="tok-comment">// good enough (Is it?).</span>
</span>
<span class="line" id="L5860">            }</span>
<span class="line" id="L5861">        } <span class="tok-kw">else</span> <span class="tok-kw">unreachable</span>;</span>
<span class="line" id="L5862"></span>
<span class="line" id="L5863">        <span class="tok-kw">var</span> info = dl_phdr_info{</span>
<span class="line" id="L5864">            .dlpi_addr = base_address,</span>
<span class="line" id="L5865">            .dlpi_name = <span class="tok-str">&quot;/proc/self/exe&quot;</span>,</span>
<span class="line" id="L5866">            .dlpi_phdr = phdrs.ptr,</span>
<span class="line" id="L5867">            .dlpi_phnum = ehdr.e_phnum,</span>
<span class="line" id="L5868">        };</span>
<span class="line" id="L5869"></span>
<span class="line" id="L5870">        <span class="tok-kw">return</span> callback(&amp;info, <span class="tok-builtin">@sizeOf</span>(dl_phdr_info), context);</span>
<span class="line" id="L5871">    }</span>
<span class="line" id="L5872"></span>
<span class="line" id="L5873">    <span class="tok-comment">// Last return value from the callback function.</span>
</span>
<span class="line" id="L5874">    <span class="tok-kw">while</span> (it.next()) |entry| {</span>
<span class="line" id="L5875">        <span class="tok-kw">var</span> dlpi_phdr: [*]elf.Phdr = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L5876">        <span class="tok-kw">var</span> dlpi_phnum: <span class="tok-type">u16</span> = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L5877"></span>
<span class="line" id="L5878">        <span class="tok-kw">if</span> (entry.l_addr != <span class="tok-number">0</span>) {</span>
<span class="line" id="L5879">            <span class="tok-kw">const</span> elf_header: *elf.Ehdr = <span class="tok-builtin">@ptrFromInt</span>(entry.l_addr);</span>
<span class="line" id="L5880">            dlpi_phdr = <span class="tok-builtin">@ptrFromInt</span>(entry.l_addr + elf_header.e_phoff);</span>
<span class="line" id="L5881">            dlpi_phnum = elf_header.e_phnum;</span>
<span class="line" id="L5882">        } <span class="tok-kw">else</span> {</span>
<span class="line" id="L5883">            <span class="tok-comment">// This is the running ELF image</span>
</span>
<span class="line" id="L5884">            dlpi_phdr = <span class="tok-builtin">@ptrFromInt</span>(elf_base + ehdr.e_phoff);</span>
<span class="line" id="L5885">            dlpi_phnum = ehdr.e_phnum;</span>
<span class="line" id="L5886">        }</span>
<span class="line" id="L5887"></span>
<span class="line" id="L5888">        <span class="tok-kw">var</span> info = dl_phdr_info{</span>
<span class="line" id="L5889">            .dlpi_addr = entry.l_addr,</span>
<span class="line" id="L5890">            .dlpi_name = entry.l_name,</span>
<span class="line" id="L5891">            .dlpi_phdr = dlpi_phdr,</span>
<span class="line" id="L5892">            .dlpi_phnum = dlpi_phnum,</span>
<span class="line" id="L5893">        };</span>
<span class="line" id="L5894"></span>
<span class="line" id="L5895">        <span class="tok-kw">try</span> callback(&amp;info, <span class="tok-builtin">@sizeOf</span>(dl_phdr_info), context);</span>
<span class="line" id="L5896">    }</span>
<span class="line" id="L5897">}</span>
<span class="line" id="L5898"></span>
<span class="line" id="L5899"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> ClockGetTimeError = <span class="tok-kw">error</span>{UnsupportedClock} || UnexpectedError;</span>
<span class="line" id="L5900"></span>
<span class="line" id="L5901"><span class="tok-comment">/// TODO: change this to return the timespec as a return value</span></span>
<span class="line" id="L5902"><span class="tok-comment">/// TODO: look into making clk_id an enum</span></span>
<span class="line" id="L5903"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">clock_gettime</span>(clk_id: <span class="tok-type">i32</span>, tp: *timespec) ClockGetTimeError!<span class="tok-type">void</span> {</span>
<span class="line" id="L5904">    <span class="tok-kw">if</span> (builtin.os.tag == .wasi <span class="tok-kw">and</span> !builtin.link_libc) {</span>
<span class="line" id="L5905">        <span class="tok-kw">var</span> ts: timestamp_t = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L5906">        <span class="tok-kw">switch</span> (system.clock_time_get(<span class="tok-builtin">@bitCast</span>(clk_id), <span class="tok-number">1</span>, &amp;ts)) {</span>
<span class="line" id="L5907">            .SUCCESS =&gt; {</span>
<span class="line" id="L5908">                tp.* = .{</span>
<span class="line" id="L5909">                    .tv_sec = <span class="tok-builtin">@intCast</span>(ts / std.time.ns_per_s),</span>
<span class="line" id="L5910">                    .tv_nsec = <span class="tok-builtin">@intCast</span>(ts % std.time.ns_per_s),</span>
<span class="line" id="L5911">                };</span>
<span class="line" id="L5912">            },</span>
<span class="line" id="L5913">            .INVAL =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.UnsupportedClock,</span>
<span class="line" id="L5914">            <span class="tok-kw">else</span> =&gt; |err| <span class="tok-kw">return</span> unexpectedErrno(err),</span>
<span class="line" id="L5915">        }</span>
<span class="line" id="L5916">        <span class="tok-kw">return</span>;</span>
<span class="line" id="L5917">    }</span>
<span class="line" id="L5918">    <span class="tok-kw">if</span> (builtin.os.tag == .windows) {</span>
<span class="line" id="L5919">        <span class="tok-kw">if</span> (clk_id == CLOCK.REALTIME) {</span>
<span class="line" id="L5920">            <span class="tok-kw">var</span> ft: windows.FILETIME = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L5921">            windows.kernel32.GetSystemTimeAsFileTime(&amp;ft);</span>
<span class="line" id="L5922">            <span class="tok-comment">// FileTime has a granularity of 100 nanoseconds and uses the NTFS/Windows epoch.</span>
</span>
<span class="line" id="L5923">            <span class="tok-kw">const</span> ft64 = (<span class="tok-builtin">@as</span>(<span class="tok-type">u64</span>, ft.dwHighDateTime) &lt;&lt; <span class="tok-number">32</span>) | ft.dwLowDateTime;</span>
<span class="line" id="L5924">            <span class="tok-kw">const</span> ft_per_s = std.time.ns_per_s / <span class="tok-number">100</span>;</span>
<span class="line" id="L5925">            tp.* = .{</span>
<span class="line" id="L5926">                .tv_sec = <span class="tok-builtin">@as</span>(<span class="tok-type">i64</span>, <span class="tok-builtin">@intCast</span>(ft64 / ft_per_s)) + std.time.epoch.windows,</span>
<span class="line" id="L5927">                .tv_nsec = <span class="tok-builtin">@as</span>(<span class="tok-type">c_long</span>, <span class="tok-builtin">@intCast</span>(ft64 % ft_per_s)) * <span class="tok-number">100</span>,</span>
<span class="line" id="L5928">            };</span>
<span class="line" id="L5929">            <span class="tok-kw">return</span>;</span>
<span class="line" id="L5930">        } <span class="tok-kw">else</span> {</span>
<span class="line" id="L5931">            <span class="tok-comment">// TODO POSIX implementation of CLOCK.MONOTONIC on Windows.</span>
</span>
<span class="line" id="L5932">            <span class="tok-kw">return</span> <span class="tok-kw">error</span>.UnsupportedClock;</span>
<span class="line" id="L5933">        }</span>
<span class="line" id="L5934">    }</span>
<span class="line" id="L5935"></span>
<span class="line" id="L5936">    <span class="tok-kw">switch</span> (errno(system.clock_gettime(clk_id, tp))) {</span>
<span class="line" id="L5937">        .SUCCESS =&gt; <span class="tok-kw">return</span>,</span>
<span class="line" id="L5938">        .FAULT =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L5939">        .INVAL =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.UnsupportedClock,</span>
<span class="line" id="L5940">        <span class="tok-kw">else</span> =&gt; |err| <span class="tok-kw">return</span> unexpectedErrno(err),</span>
<span class="line" id="L5941">    }</span>
<span class="line" id="L5942">}</span>
<span class="line" id="L5943"></span>
<span class="line" id="L5944"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">clock_getres</span>(clk_id: <span class="tok-type">i32</span>, res: *timespec) ClockGetTimeError!<span class="tok-type">void</span> {</span>
<span class="line" id="L5945">    <span class="tok-kw">if</span> (builtin.os.tag == .wasi <span class="tok-kw">and</span> !builtin.link_libc) {</span>
<span class="line" id="L5946">        <span class="tok-kw">var</span> ts: timestamp_t = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L5947">        <span class="tok-kw">switch</span> (system.clock_res_get(<span class="tok-builtin">@bitCast</span>(clk_id), &amp;ts)) {</span>
<span class="line" id="L5948">            .SUCCESS =&gt; res.* = .{</span>
<span class="line" id="L5949">                .tv_sec = <span class="tok-builtin">@intCast</span>(ts / std.time.ns_per_s),</span>
<span class="line" id="L5950">                .tv_nsec = <span class="tok-builtin">@intCast</span>(ts % std.time.ns_per_s),</span>
<span class="line" id="L5951">            },</span>
<span class="line" id="L5952">            .INVAL =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.UnsupportedClock,</span>
<span class="line" id="L5953">            <span class="tok-kw">else</span> =&gt; |err| <span class="tok-kw">return</span> unexpectedErrno(err),</span>
<span class="line" id="L5954">        }</span>
<span class="line" id="L5955">        <span class="tok-kw">return</span>;</span>
<span class="line" id="L5956">    }</span>
<span class="line" id="L5957"></span>
<span class="line" id="L5958">    <span class="tok-kw">switch</span> (errno(system.clock_getres(clk_id, res))) {</span>
<span class="line" id="L5959">        .SUCCESS =&gt; <span class="tok-kw">return</span>,</span>
<span class="line" id="L5960">        .FAULT =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L5961">        .INVAL =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.UnsupportedClock,</span>
<span class="line" id="L5962">        <span class="tok-kw">else</span> =&gt; |err| <span class="tok-kw">return</span> unexpectedErrno(err),</span>
<span class="line" id="L5963">    }</span>
<span class="line" id="L5964">}</span>
<span class="line" id="L5965"></span>
<span class="line" id="L5966"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> SchedGetAffinityError = <span class="tok-kw">error</span>{PermissionDenied} || UnexpectedError;</span>
<span class="line" id="L5967"></span>
<span class="line" id="L5968"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">sched_getaffinity</span>(pid: pid_t) SchedGetAffinityError!cpu_set_t {</span>
<span class="line" id="L5969">    <span class="tok-kw">var</span> set: cpu_set_t = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L5970">    <span class="tok-kw">switch</span> (errno(system.sched_getaffinity(pid, <span class="tok-builtin">@sizeOf</span>(cpu_set_t), &amp;set))) {</span>
<span class="line" id="L5971">        .SUCCESS =&gt; <span class="tok-kw">return</span> set,</span>
<span class="line" id="L5972">        .FAULT =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L5973">        .INVAL =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L5974">        .SRCH =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L5975">        .PERM =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.PermissionDenied,</span>
<span class="line" id="L5976">        <span class="tok-kw">else</span> =&gt; |err| <span class="tok-kw">return</span> unexpectedErrno(err),</span>
<span class="line" id="L5977">    }</span>
<span class="line" id="L5978">}</span>
<span class="line" id="L5979"></span>
<span class="line" id="L5980"><span class="tok-comment">/// Used to convert a slice to a null terminated slice on the stack.</span></span>
<span class="line" id="L5981"><span class="tok-comment">/// TODO https://github.com/ziglang/zig/issues/287</span></span>
<span class="line" id="L5982"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">toPosixPath</span>(file_path: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>) ![MAX_PATH_BYTES - <span class="tok-number">1</span>:<span class="tok-number">0</span>]<span class="tok-type">u8</span> {</span>
<span class="line" id="L5983">    <span class="tok-kw">if</span> (std.debug.runtime_safety) assert(std.mem.indexOfScalar(<span class="tok-type">u8</span>, file_path, <span class="tok-number">0</span>) == <span class="tok-null">null</span>);</span>
<span class="line" id="L5984">    <span class="tok-kw">var</span> path_with_null: [MAX_PATH_BYTES - <span class="tok-number">1</span>:<span class="tok-number">0</span>]<span class="tok-type">u8</span> = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L5985">    <span class="tok-comment">// &gt;= rather than &gt; to make room for the null byte</span>
</span>
<span class="line" id="L5986">    <span class="tok-kw">if</span> (file_path.len &gt;= MAX_PATH_BYTES) <span class="tok-kw">return</span> <span class="tok-kw">error</span>.NameTooLong;</span>
<span class="line" id="L5987">    <span class="tok-builtin">@memcpy</span>(path_with_null[<span class="tok-number">0</span>..file_path.len], file_path);</span>
<span class="line" id="L5988">    path_with_null[file_path.len] = <span class="tok-number">0</span>;</span>
<span class="line" id="L5989">    <span class="tok-kw">return</span> path_with_null;</span>
<span class="line" id="L5990">}</span>
<span class="line" id="L5991"></span>
<span class="line" id="L5992"><span class="tok-comment">/// Whether or not error.Unexpected will print its value and a stack trace.</span></span>
<span class="line" id="L5993"><span class="tok-comment">/// if this happens the fix is to add the error code to the corresponding</span></span>
<span class="line" id="L5994"><span class="tok-comment">/// switch expression, possibly introduce a new error in the error set, and</span></span>
<span class="line" id="L5995"><span class="tok-comment">/// send a patch to Zig.</span></span>
<span class="line" id="L5996"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> unexpected_error_tracing = builtin.zig_backend == .stage2_llvm <span class="tok-kw">and</span> builtin.mode == .Debug;</span>
<span class="line" id="L5997"></span>
<span class="line" id="L5998"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> UnexpectedError = <span class="tok-kw">error</span>{</span>
<span class="line" id="L5999">    <span class="tok-comment">/// The Operating System returned an undocumented error code.</span></span>
<span class="line" id="L6000">    <span class="tok-comment">/// This error is in theory not possible, but it would be better</span></span>
<span class="line" id="L6001">    <span class="tok-comment">/// to handle this error than to invoke undefined behavior.</span></span>
<span class="line" id="L6002">    Unexpected,</span>
<span class="line" id="L6003">};</span>
<span class="line" id="L6004"></span>
<span class="line" id="L6005"><span class="tok-comment">/// Call this when you made a syscall or something that sets errno</span></span>
<span class="line" id="L6006"><span class="tok-comment">/// and you get an unexpected error.</span></span>
<span class="line" id="L6007"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">unexpectedErrno</span>(err: E) UnexpectedError {</span>
<span class="line" id="L6008">    <span class="tok-kw">if</span> (unexpected_error_tracing) {</span>
<span class="line" id="L6009">        std.debug.print(<span class="tok-str">&quot;unexpected errno: {d}\n&quot;</span>, .{<span class="tok-builtin">@intFromEnum</span>(err)});</span>
<span class="line" id="L6010">        std.debug.dumpCurrentStackTrace(<span class="tok-null">null</span>);</span>
<span class="line" id="L6011">    }</span>
<span class="line" id="L6012">    <span class="tok-kw">return</span> <span class="tok-kw">error</span>.Unexpected;</span>
<span class="line" id="L6013">}</span>
<span class="line" id="L6014"></span>
<span class="line" id="L6015"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> SigaltstackError = <span class="tok-kw">error</span>{</span>
<span class="line" id="L6016">    <span class="tok-comment">/// The supplied stack size was less than MINSIGSTKSZ.</span></span>
<span class="line" id="L6017">    SizeTooSmall,</span>
<span class="line" id="L6018"></span>
<span class="line" id="L6019">    <span class="tok-comment">/// Attempted to change the signal stack while it was active.</span></span>
<span class="line" id="L6020">    PermissionDenied,</span>
<span class="line" id="L6021">} || UnexpectedError;</span>
<span class="line" id="L6022"></span>
<span class="line" id="L6023"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">sigaltstack</span>(ss: ?*stack_t, old_ss: ?*stack_t) SigaltstackError!<span class="tok-type">void</span> {</span>
<span class="line" id="L6024">    <span class="tok-kw">switch</span> (errno(system.sigaltstack(ss, old_ss))) {</span>
<span class="line" id="L6025">        .SUCCESS =&gt; <span class="tok-kw">return</span>,</span>
<span class="line" id="L6026">        .FAULT =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L6027">        .INVAL =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L6028">        .NOMEM =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.SizeTooSmall,</span>
<span class="line" id="L6029">        .PERM =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.PermissionDenied,</span>
<span class="line" id="L6030">        <span class="tok-kw">else</span> =&gt; |err| <span class="tok-kw">return</span> unexpectedErrno(err),</span>
<span class="line" id="L6031">    }</span>
<span class="line" id="L6032">}</span>
<span class="line" id="L6033"></span>
<span class="line" id="L6034"><span class="tok-comment">/// Examine and change a signal action.</span></span>
<span class="line" id="L6035"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">sigaction</span>(sig: <span class="tok-type">u6</span>, <span class="tok-kw">noalias</span> act: ?*<span class="tok-kw">const</span> Sigaction, <span class="tok-kw">noalias</span> oact: ?*Sigaction) <span class="tok-kw">error</span>{OperationNotSupported}!<span class="tok-type">void</span> {</span>
<span class="line" id="L6036">    <span class="tok-kw">switch</span> (errno(system.sigaction(sig, act, oact))) {</span>
<span class="line" id="L6037">        .SUCCESS =&gt; <span class="tok-kw">return</span>,</span>
<span class="line" id="L6038">        .INVAL, .NOSYS =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.OperationNotSupported,</span>
<span class="line" id="L6039">        <span class="tok-kw">else</span> =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L6040">    }</span>
<span class="line" id="L6041">}</span>
<span class="line" id="L6042"></span>
<span class="line" id="L6043"><span class="tok-comment">/// Sets the thread signal mask.</span></span>
<span class="line" id="L6044"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">sigprocmask</span>(flags: <span class="tok-type">u32</span>, <span class="tok-kw">noalias</span> set: ?*<span class="tok-kw">const</span> sigset_t, <span class="tok-kw">noalias</span> oldset: ?*sigset_t) <span class="tok-type">void</span> {</span>
<span class="line" id="L6045">    <span class="tok-kw">switch</span> (errno(system.sigprocmask(<span class="tok-builtin">@bitCast</span>(flags), set, oldset))) {</span>
<span class="line" id="L6046">        .SUCCESS =&gt; <span class="tok-kw">return</span>,</span>
<span class="line" id="L6047">        .FAULT =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L6048">        .INVAL =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L6049">        <span class="tok-kw">else</span> =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L6050">    }</span>
<span class="line" id="L6051">}</span>
<span class="line" id="L6052"></span>
<span class="line" id="L6053"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FutimensError = <span class="tok-kw">error</span>{</span>
<span class="line" id="L6054">    <span class="tok-comment">/// times is NULL, or both tv_nsec values are UTIME_NOW, and either:</span></span>
<span class="line" id="L6055">    <span class="tok-comment">/// *  the effective user ID of the caller does not match the  owner</span></span>
<span class="line" id="L6056">    <span class="tok-comment">///    of  the  file,  the  caller does not have write access to the</span></span>
<span class="line" id="L6057">    <span class="tok-comment">///    file, and the caller is not privileged (Linux: does not  have</span></span>
<span class="line" id="L6058">    <span class="tok-comment">///    either  the  CAP_FOWNER  or the CAP_DAC_OVERRIDE capability);</span></span>
<span class="line" id="L6059">    <span class="tok-comment">///    or,</span></span>
<span class="line" id="L6060">    <span class="tok-comment">/// *  the file is marked immutable (see chattr(1)).</span></span>
<span class="line" id="L6061">    AccessDenied,</span>
<span class="line" id="L6062"></span>
<span class="line" id="L6063">    <span class="tok-comment">/// The caller attempted to change one or both timestamps to a value</span></span>
<span class="line" id="L6064">    <span class="tok-comment">/// other than the current time, or to change one of the  timestamps</span></span>
<span class="line" id="L6065">    <span class="tok-comment">/// to the current time while leaving the other timestamp unchanged,</span></span>
<span class="line" id="L6066">    <span class="tok-comment">/// (i.e., times is not NULL, neither tv_nsec  field  is  UTIME_NOW,</span></span>
<span class="line" id="L6067">    <span class="tok-comment">/// and neither tv_nsec field is UTIME_OMIT) and either:</span></span>
<span class="line" id="L6068">    <span class="tok-comment">/// *  the  caller's  effective  user ID does not match the owner of</span></span>
<span class="line" id="L6069">    <span class="tok-comment">///    file, and the caller is not privileged (Linux: does not  have</span></span>
<span class="line" id="L6070">    <span class="tok-comment">///    the CAP_FOWNER capability); or,</span></span>
<span class="line" id="L6071">    <span class="tok-comment">/// *  the file is marked append-only or immutable (see chattr(1)).</span></span>
<span class="line" id="L6072">    PermissionDenied,</span>
<span class="line" id="L6073"></span>
<span class="line" id="L6074">    ReadOnlyFileSystem,</span>
<span class="line" id="L6075">} || UnexpectedError;</span>
<span class="line" id="L6076"></span>
<span class="line" id="L6077"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">futimens</span>(fd: fd_t, times: *<span class="tok-kw">const</span> [<span class="tok-number">2</span>]timespec) FutimensError!<span class="tok-type">void</span> {</span>
<span class="line" id="L6078">    <span class="tok-kw">if</span> (builtin.os.tag == .wasi <span class="tok-kw">and</span> !builtin.link_libc) {</span>
<span class="line" id="L6079">        <span class="tok-comment">// TODO WASI encodes `wasi.fstflags` to signify magic values</span>
</span>
<span class="line" id="L6080">        <span class="tok-comment">// similar to UTIME_NOW and UTIME_OMIT. Currently, we ignore</span>
</span>
<span class="line" id="L6081">        <span class="tok-comment">// this here, but we should really handle it somehow.</span>
</span>
<span class="line" id="L6082">        <span class="tok-kw">const</span> atim = times[<span class="tok-number">0</span>].toTimestamp();</span>
<span class="line" id="L6083">        <span class="tok-kw">const</span> mtim = times[<span class="tok-number">1</span>].toTimestamp();</span>
<span class="line" id="L6084">        <span class="tok-kw">switch</span> (wasi.fd_filestat_set_times(fd, atim, mtim, .{</span>
<span class="line" id="L6085">            .ATIM = <span class="tok-null">true</span>,</span>
<span class="line" id="L6086">            .MTIM = <span class="tok-null">true</span>,</span>
<span class="line" id="L6087">        })) {</span>
<span class="line" id="L6088">            .SUCCESS =&gt; <span class="tok-kw">return</span>,</span>
<span class="line" id="L6089">            .ACCES =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.AccessDenied,</span>
<span class="line" id="L6090">            .PERM =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.PermissionDenied,</span>
<span class="line" id="L6091">            .BADF =&gt; <span class="tok-kw">unreachable</span>, <span class="tok-comment">// always a race condition</span>
</span>
<span class="line" id="L6092">            .FAULT =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L6093">            .INVAL =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L6094">            .ROFS =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.ReadOnlyFileSystem,</span>
<span class="line" id="L6095">            <span class="tok-kw">else</span> =&gt; |err| <span class="tok-kw">return</span> unexpectedErrno(err),</span>
<span class="line" id="L6096">        }</span>
<span class="line" id="L6097">    }</span>
<span class="line" id="L6098"></span>
<span class="line" id="L6099">    <span class="tok-kw">switch</span> (errno(system.futimens(fd, times))) {</span>
<span class="line" id="L6100">        .SUCCESS =&gt; <span class="tok-kw">return</span>,</span>
<span class="line" id="L6101">        .ACCES =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.AccessDenied,</span>
<span class="line" id="L6102">        .PERM =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.PermissionDenied,</span>
<span class="line" id="L6103">        .BADF =&gt; <span class="tok-kw">unreachable</span>, <span class="tok-comment">// always a race condition</span>
</span>
<span class="line" id="L6104">        .FAULT =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L6105">        .INVAL =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L6106">        .ROFS =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.ReadOnlyFileSystem,</span>
<span class="line" id="L6107">        <span class="tok-kw">else</span> =&gt; |err| <span class="tok-kw">return</span> unexpectedErrno(err),</span>
<span class="line" id="L6108">    }</span>
<span class="line" id="L6109">}</span>
<span class="line" id="L6110"></span>
<span class="line" id="L6111"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> GetHostNameError = <span class="tok-kw">error</span>{PermissionDenied} || UnexpectedError;</span>
<span class="line" id="L6112"></span>
<span class="line" id="L6113"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">gethostname</span>(name_buffer: *[HOST_NAME_MAX]<span class="tok-type">u8</span>) GetHostNameError![]<span class="tok-type">u8</span> {</span>
<span class="line" id="L6114">    <span class="tok-kw">if</span> (builtin.link_libc) {</span>
<span class="line" id="L6115">        <span class="tok-kw">switch</span> (errno(system.gethostname(name_buffer, name_buffer.len))) {</span>
<span class="line" id="L6116">            .SUCCESS =&gt; <span class="tok-kw">return</span> mem.sliceTo(name_buffer, <span class="tok-number">0</span>),</span>
<span class="line" id="L6117">            .FAULT =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L6118">            .NAMETOOLONG =&gt; <span class="tok-kw">unreachable</span>, <span class="tok-comment">// HOST_NAME_MAX prevents this</span>
</span>
<span class="line" id="L6119">            .PERM =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.PermissionDenied,</span>
<span class="line" id="L6120">            <span class="tok-kw">else</span> =&gt; |err| <span class="tok-kw">return</span> unexpectedErrno(err),</span>
<span class="line" id="L6121">        }</span>
<span class="line" id="L6122">    }</span>
<span class="line" id="L6123">    <span class="tok-kw">if</span> (builtin.os.tag == .linux) {</span>
<span class="line" id="L6124">        <span class="tok-kw">const</span> uts = uname();</span>
<span class="line" id="L6125">        <span class="tok-kw">const</span> hostname = mem.sliceTo(&amp;uts.nodename, <span class="tok-number">0</span>);</span>
<span class="line" id="L6126">        <span class="tok-kw">const</span> result = name_buffer[<span class="tok-number">0</span>..hostname.len];</span>
<span class="line" id="L6127">        <span class="tok-builtin">@memcpy</span>(result, hostname);</span>
<span class="line" id="L6128">        <span class="tok-kw">return</span> result;</span>
<span class="line" id="L6129">    }</span>
<span class="line" id="L6130"></span>
<span class="line" id="L6131">    <span class="tok-builtin">@compileError</span>(<span class="tok-str">&quot;TODO implement gethostname for this OS&quot;</span>);</span>
<span class="line" id="L6132">}</span>
<span class="line" id="L6133"></span>
<span class="line" id="L6134"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">uname</span>() utsname {</span>
<span class="line" id="L6135">    <span class="tok-kw">var</span> uts: utsname = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L6136">    <span class="tok-kw">switch</span> (errno(system.uname(&amp;uts))) {</span>
<span class="line" id="L6137">        .SUCCESS =&gt; <span class="tok-kw">return</span> uts,</span>
<span class="line" id="L6138">        .FAULT =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L6139">        <span class="tok-kw">else</span> =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L6140">    }</span>
<span class="line" id="L6141">}</span>
<span class="line" id="L6142"></span>
<span class="line" id="L6143"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">res_mkquery</span>(</span>
<span class="line" id="L6144">    op: <span class="tok-type">u4</span>,</span>
<span class="line" id="L6145">    dname: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>,</span>
<span class="line" id="L6146">    class: <span class="tok-type">u8</span>,</span>
<span class="line" id="L6147">    ty: <span class="tok-type">u8</span>,</span>
<span class="line" id="L6148">    data: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>,</span>
<span class="line" id="L6149">    newrr: ?[*]<span class="tok-kw">const</span> <span class="tok-type">u8</span>,</span>
<span class="line" id="L6150">    buf: []<span class="tok-type">u8</span>,</span>
<span class="line" id="L6151">) <span class="tok-type">usize</span> {</span>
<span class="line" id="L6152">    _ = data;</span>
<span class="line" id="L6153">    _ = newrr;</span>
<span class="line" id="L6154">    <span class="tok-comment">// This implementation is ported from musl libc.</span>
</span>
<span class="line" id="L6155">    <span class="tok-comment">// A more idiomatic &quot;ziggy&quot; implementation would be welcome.</span>
</span>
<span class="line" id="L6156">    <span class="tok-kw">var</span> name = dname;</span>
<span class="line" id="L6157">    <span class="tok-kw">if</span> (mem.endsWith(<span class="tok-type">u8</span>, name, <span class="tok-str">&quot;.&quot;</span>)) name.len -= <span class="tok-number">1</span>;</span>
<span class="line" id="L6158">    assert(name.len &lt;= <span class="tok-number">253</span>);</span>
<span class="line" id="L6159">    <span class="tok-kw">const</span> n = <span class="tok-number">17</span> + name.len + <span class="tok-builtin">@intFromBool</span>(name.len != <span class="tok-number">0</span>);</span>
<span class="line" id="L6160"></span>
<span class="line" id="L6161">    <span class="tok-comment">// Construct query template - ID will be filled later</span>
</span>
<span class="line" id="L6162">    <span class="tok-kw">var</span> q: [<span class="tok-number">280</span>]<span class="tok-type">u8</span> = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L6163">    <span class="tok-builtin">@memset</span>(q[<span class="tok-number">0</span>..n], <span class="tok-number">0</span>);</span>
<span class="line" id="L6164">    q[<span class="tok-number">2</span>] = <span class="tok-builtin">@as</span>(<span class="tok-type">u8</span>, op) * <span class="tok-number">8</span> + <span class="tok-number">1</span>;</span>
<span class="line" id="L6165">    q[<span class="tok-number">5</span>] = <span class="tok-number">1</span>;</span>
<span class="line" id="L6166">    <span class="tok-builtin">@memcpy</span>(q[<span class="tok-number">13</span>..][<span class="tok-number">0</span>..name.len], name);</span>
<span class="line" id="L6167">    <span class="tok-kw">var</span> i: <span class="tok-type">usize</span> = <span class="tok-number">13</span>;</span>
<span class="line" id="L6168">    <span class="tok-kw">var</span> j: <span class="tok-type">usize</span> = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L6169">    <span class="tok-kw">while</span> (q[i] != <span class="tok-number">0</span>) : (i = j + <span class="tok-number">1</span>) {</span>
<span class="line" id="L6170">        j = i;</span>
<span class="line" id="L6171">        <span class="tok-kw">while</span> (q[j] != <span class="tok-number">0</span> <span class="tok-kw">and</span> q[j] != <span class="tok-str">'.'</span>) : (j += <span class="tok-number">1</span>) {}</span>
<span class="line" id="L6172">        <span class="tok-comment">// TODO determine the circumstances for this and whether or</span>
</span>
<span class="line" id="L6173">        <span class="tok-comment">// not this should be an error.</span>
</span>
<span class="line" id="L6174">        <span class="tok-kw">if</span> (j - i - <span class="tok-number">1</span> &gt; <span class="tok-number">62</span>) <span class="tok-kw">unreachable</span>;</span>
<span class="line" id="L6175">        q[i - <span class="tok-number">1</span>] = <span class="tok-builtin">@intCast</span>(j - i);</span>
<span class="line" id="L6176">    }</span>
<span class="line" id="L6177">    q[i + <span class="tok-number">1</span>] = ty;</span>
<span class="line" id="L6178">    q[i + <span class="tok-number">3</span>] = class;</span>
<span class="line" id="L6179"></span>
<span class="line" id="L6180">    <span class="tok-comment">// Make a reasonably unpredictable id</span>
</span>
<span class="line" id="L6181">    <span class="tok-kw">var</span> ts: timespec = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L6182">    clock_gettime(CLOCK.REALTIME, &amp;ts) <span class="tok-kw">catch</span> {};</span>
<span class="line" id="L6183">    <span class="tok-kw">const</span> UInt = std.meta.Int(.unsigned, <span class="tok-builtin">@bitSizeOf</span>(<span class="tok-builtin">@TypeOf</span>(ts.tv_nsec)));</span>
<span class="line" id="L6184">    <span class="tok-kw">const</span> unsec: UInt = <span class="tok-builtin">@bitCast</span>(ts.tv_nsec);</span>
<span class="line" id="L6185">    <span class="tok-kw">const</span> id: <span class="tok-type">u32</span> = <span class="tok-builtin">@truncate</span>(unsec + unsec / <span class="tok-number">65536</span>);</span>
<span class="line" id="L6186">    q[<span class="tok-number">0</span>] = <span class="tok-builtin">@truncate</span>(id / <span class="tok-number">256</span>);</span>
<span class="line" id="L6187">    q[<span class="tok-number">1</span>] = <span class="tok-builtin">@truncate</span>(id);</span>
<span class="line" id="L6188"></span>
<span class="line" id="L6189">    <span class="tok-builtin">@memcpy</span>(buf[<span class="tok-number">0</span>..n], q[<span class="tok-number">0</span>..n]);</span>
<span class="line" id="L6190">    <span class="tok-kw">return</span> n;</span>
<span class="line" id="L6191">}</span>
<span class="line" id="L6192"></span>
<span class="line" id="L6193"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> SendError = <span class="tok-kw">error</span>{</span>
<span class="line" id="L6194">    <span class="tok-comment">/// (For UNIX domain sockets, which are identified by pathname) Write permission is  denied</span></span>
<span class="line" id="L6195">    <span class="tok-comment">/// on  the destination socket file, or search permission is denied for one of the</span></span>
<span class="line" id="L6196">    <span class="tok-comment">/// directories the path prefix.  (See path_resolution(7).)</span></span>
<span class="line" id="L6197">    <span class="tok-comment">/// (For UDP sockets) An attempt was made to send to a network/broadcast address as  though</span></span>
<span class="line" id="L6198">    <span class="tok-comment">/// it was a unicast address.</span></span>
<span class="line" id="L6199">    AccessDenied,</span>
<span class="line" id="L6200"></span>
<span class="line" id="L6201">    <span class="tok-comment">/// The socket is marked nonblocking and the requested operation would block, and</span></span>
<span class="line" id="L6202">    <span class="tok-comment">/// there is no global event loop configured.</span></span>
<span class="line" id="L6203">    <span class="tok-comment">/// It's also possible to get this error under the following condition:</span></span>
<span class="line" id="L6204">    <span class="tok-comment">/// (Internet  domain datagram sockets) The socket referred to by sockfd had not previously</span></span>
<span class="line" id="L6205">    <span class="tok-comment">/// been bound to an address and, upon attempting to bind it to an ephemeral port,  it  was</span></span>
<span class="line" id="L6206">    <span class="tok-comment">/// determined that all port numbers in the ephemeral port range are currently in use.  See</span></span>
<span class="line" id="L6207">    <span class="tok-comment">/// the discussion of /proc/sys/net/ipv4/ip_local_port_range in ip(7).</span></span>
<span class="line" id="L6208">    WouldBlock,</span>
<span class="line" id="L6209"></span>
<span class="line" id="L6210">    <span class="tok-comment">/// Another Fast Open is already in progress.</span></span>
<span class="line" id="L6211">    FastOpenAlreadyInProgress,</span>
<span class="line" id="L6212"></span>
<span class="line" id="L6213">    <span class="tok-comment">/// Connection reset by peer.</span></span>
<span class="line" id="L6214">    ConnectionResetByPeer,</span>
<span class="line" id="L6215"></span>
<span class="line" id="L6216">    <span class="tok-comment">/// The  socket  type requires that message be sent atomically, and the size of the message</span></span>
<span class="line" id="L6217">    <span class="tok-comment">/// to be sent made this impossible. The message is not transmitted.</span></span>
<span class="line" id="L6218">    MessageTooBig,</span>
<span class="line" id="L6219"></span>
<span class="line" id="L6220">    <span class="tok-comment">/// The output queue for a network interface was full.  This generally indicates  that  the</span></span>
<span class="line" id="L6221">    <span class="tok-comment">/// interface  has  stopped sending, but may be caused by transient congestion.  (Normally,</span></span>
<span class="line" id="L6222">    <span class="tok-comment">/// this does not occur in Linux.  Packets are just silently dropped when  a  device  queue</span></span>
<span class="line" id="L6223">    <span class="tok-comment">/// overflows.)</span></span>
<span class="line" id="L6224">    <span class="tok-comment">/// This is also caused when there is not enough kernel memory available.</span></span>
<span class="line" id="L6225">    SystemResources,</span>
<span class="line" id="L6226"></span>
<span class="line" id="L6227">    <span class="tok-comment">/// The  local  end  has been shut down on a connection oriented socket.  In this case, the</span></span>
<span class="line" id="L6228">    <span class="tok-comment">/// process will also receive a SIGPIPE unless MSG.NOSIGNAL is set.</span></span>
<span class="line" id="L6229">    BrokenPipe,</span>
<span class="line" id="L6230"></span>
<span class="line" id="L6231">    FileDescriptorNotASocket,</span>
<span class="line" id="L6232"></span>
<span class="line" id="L6233">    <span class="tok-comment">/// Network is unreachable.</span></span>
<span class="line" id="L6234">    NetworkUnreachable,</span>
<span class="line" id="L6235"></span>
<span class="line" id="L6236">    <span class="tok-comment">/// The local network interface used to reach the destination is down.</span></span>
<span class="line" id="L6237">    NetworkSubsystemFailed,</span>
<span class="line" id="L6238">} || UnexpectedError;</span>
<span class="line" id="L6239"></span>
<span class="line" id="L6240"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> SendMsgError = SendError || <span class="tok-kw">error</span>{</span>
<span class="line" id="L6241">    <span class="tok-comment">/// The passed address didn't have the correct address family in its sa_family field.</span></span>
<span class="line" id="L6242">    AddressFamilyNotSupported,</span>
<span class="line" id="L6243"></span>
<span class="line" id="L6244">    <span class="tok-comment">/// Returned when socket is AF.UNIX and the given path has a symlink loop.</span></span>
<span class="line" id="L6245">    SymLinkLoop,</span>
<span class="line" id="L6246"></span>
<span class="line" id="L6247">    <span class="tok-comment">/// Returned when socket is AF.UNIX and the given path length exceeds `MAX_PATH_BYTES` bytes.</span></span>
<span class="line" id="L6248">    NameTooLong,</span>
<span class="line" id="L6249"></span>
<span class="line" id="L6250">    <span class="tok-comment">/// Returned when socket is AF.UNIX and the given path does not point to an existing file.</span></span>
<span class="line" id="L6251">    FileNotFound,</span>
<span class="line" id="L6252">    NotDir,</span>
<span class="line" id="L6253"></span>
<span class="line" id="L6254">    <span class="tok-comment">/// The socket is not connected (connection-oriented sockets only).</span></span>
<span class="line" id="L6255">    SocketNotConnected,</span>
<span class="line" id="L6256">    AddressNotAvailable,</span>
<span class="line" id="L6257">};</span>
<span class="line" id="L6258"></span>
<span class="line" id="L6259"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">sendmsg</span>(</span>
<span class="line" id="L6260">    <span class="tok-comment">/// The file descriptor of the sending socket.</span></span>
<span class="line" id="L6261">    sockfd: socket_t,</span>
<span class="line" id="L6262">    <span class="tok-comment">/// Message header and iovecs</span></span>
<span class="line" id="L6263">    msg: *<span class="tok-kw">const</span> msghdr_const,</span>
<span class="line" id="L6264">    flags: <span class="tok-type">u32</span>,</span>
<span class="line" id="L6265">) SendMsgError!<span class="tok-type">usize</span> {</span>
<span class="line" id="L6266">    <span class="tok-kw">while</span> (<span class="tok-null">true</span>) {</span>
<span class="line" id="L6267">        <span class="tok-kw">const</span> rc = system.sendmsg(sockfd, msg, flags);</span>
<span class="line" id="L6268">        <span class="tok-kw">if</span> (builtin.os.tag == .windows) {</span>
<span class="line" id="L6269">            <span class="tok-kw">if</span> (rc == windows.ws2_32.SOCKET_ERROR) {</span>
<span class="line" id="L6270">                <span class="tok-kw">switch</span> (windows.ws2_32.WSAGetLastError()) {</span>
<span class="line" id="L6271">                    .WSAEACCES =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.AccessDenied,</span>
<span class="line" id="L6272">                    .WSAEADDRNOTAVAIL =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.AddressNotAvailable,</span>
<span class="line" id="L6273">                    .WSAECONNRESET =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.ConnectionResetByPeer,</span>
<span class="line" id="L6274">                    .WSAEMSGSIZE =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.MessageTooBig,</span>
<span class="line" id="L6275">                    .WSAENOBUFS =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.SystemResources,</span>
<span class="line" id="L6276">                    .WSAENOTSOCK =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.FileDescriptorNotASocket,</span>
<span class="line" id="L6277">                    .WSAEAFNOSUPPORT =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.AddressFamilyNotSupported,</span>
<span class="line" id="L6278">                    .WSAEDESTADDRREQ =&gt; <span class="tok-kw">unreachable</span>, <span class="tok-comment">// A destination address is required.</span>
</span>
<span class="line" id="L6279">                    .WSAEFAULT =&gt; <span class="tok-kw">unreachable</span>, <span class="tok-comment">// The lpBuffers, lpTo, lpOverlapped, lpNumberOfBytesSent, or lpCompletionRoutine parameters are not part of the user address space, or the lpTo parameter is too small.</span>
</span>
<span class="line" id="L6280">                    .WSAEHOSTUNREACH =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.NetworkUnreachable,</span>
<span class="line" id="L6281">                    <span class="tok-comment">// TODO: WSAEINPROGRESS, WSAEINTR</span>
</span>
<span class="line" id="L6282">                    .WSAEINVAL =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L6283">                    .WSAENETDOWN =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.NetworkSubsystemFailed,</span>
<span class="line" id="L6284">                    .WSAENETRESET =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.ConnectionResetByPeer,</span>
<span class="line" id="L6285">                    .WSAENETUNREACH =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.NetworkUnreachable,</span>
<span class="line" id="L6286">                    .WSAENOTCONN =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.SocketNotConnected,</span>
<span class="line" id="L6287">                    .WSAESHUTDOWN =&gt; <span class="tok-kw">unreachable</span>, <span class="tok-comment">// The socket has been shut down; it is not possible to WSASendTo on a socket after shutdown has been invoked with how set to SD_SEND or SD_BOTH.</span>
</span>
<span class="line" id="L6288">                    .WSAEWOULDBLOCK =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.WouldBlock,</span>
<span class="line" id="L6289">                    .WSANOTINITIALISED =&gt; <span class="tok-kw">unreachable</span>, <span class="tok-comment">// A successful WSAStartup call must occur before using this function.</span>
</span>
<span class="line" id="L6290">                    <span class="tok-kw">else</span> =&gt; |err| <span class="tok-kw">return</span> windows.unexpectedWSAError(err),</span>
<span class="line" id="L6291">                }</span>
<span class="line" id="L6292">            } <span class="tok-kw">else</span> {</span>
<span class="line" id="L6293">                <span class="tok-kw">return</span> <span class="tok-builtin">@intCast</span>(rc);</span>
<span class="line" id="L6294">            }</span>
<span class="line" id="L6295">        } <span class="tok-kw">else</span> {</span>
<span class="line" id="L6296">            <span class="tok-kw">switch</span> (errno(rc)) {</span>
<span class="line" id="L6297">                .SUCCESS =&gt; <span class="tok-kw">return</span> <span class="tok-builtin">@intCast</span>(rc),</span>
<span class="line" id="L6298"></span>
<span class="line" id="L6299">                .ACCES =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.AccessDenied,</span>
<span class="line" id="L6300">                .AGAIN =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.WouldBlock,</span>
<span class="line" id="L6301">                .ALREADY =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.FastOpenAlreadyInProgress,</span>
<span class="line" id="L6302">                .BADF =&gt; <span class="tok-kw">unreachable</span>, <span class="tok-comment">// always a race condition</span>
</span>
<span class="line" id="L6303">                .CONNRESET =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.ConnectionResetByPeer,</span>
<span class="line" id="L6304">                .DESTADDRREQ =&gt; <span class="tok-kw">unreachable</span>, <span class="tok-comment">// The socket is not connection-mode, and no peer address is set.</span>
</span>
<span class="line" id="L6305">                .FAULT =&gt; <span class="tok-kw">unreachable</span>, <span class="tok-comment">// An invalid user space address was specified for an argument.</span>
</span>
<span class="line" id="L6306">                .INTR =&gt; <span class="tok-kw">continue</span>,</span>
<span class="line" id="L6307">                .INVAL =&gt; <span class="tok-kw">unreachable</span>, <span class="tok-comment">// Invalid argument passed.</span>
</span>
<span class="line" id="L6308">                .ISCONN =&gt; <span class="tok-kw">unreachable</span>, <span class="tok-comment">// connection-mode socket was connected already but a recipient was specified</span>
</span>
<span class="line" id="L6309">                .MSGSIZE =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.MessageTooBig,</span>
<span class="line" id="L6310">                .NOBUFS =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.SystemResources,</span>
<span class="line" id="L6311">                .NOMEM =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.SystemResources,</span>
<span class="line" id="L6312">                .NOTSOCK =&gt; <span class="tok-kw">unreachable</span>, <span class="tok-comment">// The file descriptor sockfd does not refer to a socket.</span>
</span>
<span class="line" id="L6313">                .OPNOTSUPP =&gt; <span class="tok-kw">unreachable</span>, <span class="tok-comment">// Some bit in the flags argument is inappropriate for the socket type.</span>
</span>
<span class="line" id="L6314">                .PIPE =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.BrokenPipe,</span>
<span class="line" id="L6315">                .AFNOSUPPORT =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.AddressFamilyNotSupported,</span>
<span class="line" id="L6316">                .LOOP =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.SymLinkLoop,</span>
<span class="line" id="L6317">                .NAMETOOLONG =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.NameTooLong,</span>
<span class="line" id="L6318">                .NOENT =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.FileNotFound,</span>
<span class="line" id="L6319">                .NOTDIR =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.NotDir,</span>
<span class="line" id="L6320">                .HOSTUNREACH =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.NetworkUnreachable,</span>
<span class="line" id="L6321">                .NETUNREACH =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.NetworkUnreachable,</span>
<span class="line" id="L6322">                .NOTCONN =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.SocketNotConnected,</span>
<span class="line" id="L6323">                .NETDOWN =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.NetworkSubsystemFailed,</span>
<span class="line" id="L6324">                <span class="tok-kw">else</span> =&gt; |err| <span class="tok-kw">return</span> unexpectedErrno(err),</span>
<span class="line" id="L6325">            }</span>
<span class="line" id="L6326">        }</span>
<span class="line" id="L6327">    }</span>
<span class="line" id="L6328">}</span>
<span class="line" id="L6329"></span>
<span class="line" id="L6330"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> SendToError = SendMsgError || <span class="tok-kw">error</span>{</span>
<span class="line" id="L6331">    <span class="tok-comment">/// The destination address is not reachable by the bound address.</span></span>
<span class="line" id="L6332">    UnreachableAddress,</span>
<span class="line" id="L6333">};</span>
<span class="line" id="L6334"></span>
<span class="line" id="L6335"><span class="tok-comment">/// Transmit a message to another socket.</span></span>
<span class="line" id="L6336"><span class="tok-comment">///</span></span>
<span class="line" id="L6337"><span class="tok-comment">/// The `sendto` call may be used only when the socket is in a connected state (so that the intended</span></span>
<span class="line" id="L6338"><span class="tok-comment">/// recipient  is  known). The  following call</span></span>
<span class="line" id="L6339"><span class="tok-comment">///</span></span>
<span class="line" id="L6340"><span class="tok-comment">///     send(sockfd, buf, len, flags);</span></span>
<span class="line" id="L6341"><span class="tok-comment">///</span></span>
<span class="line" id="L6342"><span class="tok-comment">/// is equivalent to</span></span>
<span class="line" id="L6343"><span class="tok-comment">///</span></span>
<span class="line" id="L6344"><span class="tok-comment">///     sendto(sockfd, buf, len, flags, NULL, 0);</span></span>
<span class="line" id="L6345"><span class="tok-comment">///</span></span>
<span class="line" id="L6346"><span class="tok-comment">/// If  sendto()  is used on a connection-mode (`SOCK.STREAM`, `SOCK.SEQPACKET`) socket, the arguments</span></span>
<span class="line" id="L6347"><span class="tok-comment">/// `dest_addr` and `addrlen` are asserted to be `null` and `0` respectively, and asserted</span></span>
<span class="line" id="L6348"><span class="tok-comment">/// that the socket was actually connected.</span></span>
<span class="line" id="L6349"><span class="tok-comment">/// Otherwise, the address of the target is given by `dest_addr` with `addrlen` specifying  its  size.</span></span>
<span class="line" id="L6350"><span class="tok-comment">///</span></span>
<span class="line" id="L6351"><span class="tok-comment">/// If the message is too long to pass atomically through the underlying protocol,</span></span>
<span class="line" id="L6352"><span class="tok-comment">/// `SendError.MessageTooBig` is returned, and the message is not transmitted.</span></span>
<span class="line" id="L6353"><span class="tok-comment">///</span></span>
<span class="line" id="L6354"><span class="tok-comment">/// There is no  indication  of  failure  to  deliver.</span></span>
<span class="line" id="L6355"><span class="tok-comment">///</span></span>
<span class="line" id="L6356"><span class="tok-comment">/// When the message does not fit into the send buffer of  the  socket,  `sendto`  normally  blocks,</span></span>
<span class="line" id="L6357"><span class="tok-comment">/// unless  the socket has been placed in nonblocking I/O mode.  In nonblocking mode it would fail</span></span>
<span class="line" id="L6358"><span class="tok-comment">/// with `SendError.WouldBlock`.  The `select` call may be used  to  determine when it is</span></span>
<span class="line" id="L6359"><span class="tok-comment">/// possible to send more data.</span></span>
<span class="line" id="L6360"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">sendto</span>(</span>
<span class="line" id="L6361">    <span class="tok-comment">/// The file descriptor of the sending socket.</span></span>
<span class="line" id="L6362">    sockfd: socket_t,</span>
<span class="line" id="L6363">    <span class="tok-comment">/// Message to send.</span></span>
<span class="line" id="L6364">    buf: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>,</span>
<span class="line" id="L6365">    flags: <span class="tok-type">u32</span>,</span>
<span class="line" id="L6366">    dest_addr: ?*<span class="tok-kw">const</span> sockaddr,</span>
<span class="line" id="L6367">    addrlen: socklen_t,</span>
<span class="line" id="L6368">) SendToError!<span class="tok-type">usize</span> {</span>
<span class="line" id="L6369">    <span class="tok-kw">if</span> (builtin.os.tag == .windows) {</span>
<span class="line" id="L6370">        <span class="tok-kw">switch</span> (windows.sendto(sockfd, buf.ptr, buf.len, flags, dest_addr, addrlen)) {</span>
<span class="line" id="L6371">            windows.ws2_32.SOCKET_ERROR =&gt; <span class="tok-kw">switch</span> (windows.ws2_32.WSAGetLastError()) {</span>
<span class="line" id="L6372">                .WSAEACCES =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.AccessDenied,</span>
<span class="line" id="L6373">                .WSAEADDRNOTAVAIL =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.AddressNotAvailable,</span>
<span class="line" id="L6374">                .WSAECONNRESET =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.ConnectionResetByPeer,</span>
<span class="line" id="L6375">                .WSAEMSGSIZE =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.MessageTooBig,</span>
<span class="line" id="L6376">                .WSAENOBUFS =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.SystemResources,</span>
<span class="line" id="L6377">                .WSAENOTSOCK =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.FileDescriptorNotASocket,</span>
<span class="line" id="L6378">                .WSAEAFNOSUPPORT =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.AddressFamilyNotSupported,</span>
<span class="line" id="L6379">                .WSAEDESTADDRREQ =&gt; <span class="tok-kw">unreachable</span>, <span class="tok-comment">// A destination address is required.</span>
</span>
<span class="line" id="L6380">                .WSAEFAULT =&gt; <span class="tok-kw">unreachable</span>, <span class="tok-comment">// The lpBuffers, lpTo, lpOverlapped, lpNumberOfBytesSent, or lpCompletionRoutine parameters are not part of the user address space, or the lpTo parameter is too small.</span>
</span>
<span class="line" id="L6381">                .WSAEHOSTUNREACH =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.NetworkUnreachable,</span>
<span class="line" id="L6382">                <span class="tok-comment">// TODO: WSAEINPROGRESS, WSAEINTR</span>
</span>
<span class="line" id="L6383">                .WSAEINVAL =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L6384">                .WSAENETDOWN =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.NetworkSubsystemFailed,</span>
<span class="line" id="L6385">                .WSAENETRESET =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.ConnectionResetByPeer,</span>
<span class="line" id="L6386">                .WSAENETUNREACH =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.NetworkUnreachable,</span>
<span class="line" id="L6387">                .WSAENOTCONN =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.SocketNotConnected,</span>
<span class="line" id="L6388">                .WSAESHUTDOWN =&gt; <span class="tok-kw">unreachable</span>, <span class="tok-comment">// The socket has been shut down; it is not possible to WSASendTo on a socket after shutdown has been invoked with how set to SD_SEND or SD_BOTH.</span>
</span>
<span class="line" id="L6389">                .WSAEWOULDBLOCK =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.WouldBlock,</span>
<span class="line" id="L6390">                .WSANOTINITIALISED =&gt; <span class="tok-kw">unreachable</span>, <span class="tok-comment">// A successful WSAStartup call must occur before using this function.</span>
</span>
<span class="line" id="L6391">                <span class="tok-kw">else</span> =&gt; |err| <span class="tok-kw">return</span> windows.unexpectedWSAError(err),</span>
<span class="line" id="L6392">            },</span>
<span class="line" id="L6393">            <span class="tok-kw">else</span> =&gt; |rc| <span class="tok-kw">return</span> <span class="tok-builtin">@intCast</span>(rc),</span>
<span class="line" id="L6394">        }</span>
<span class="line" id="L6395">    }</span>
<span class="line" id="L6396">    <span class="tok-kw">while</span> (<span class="tok-null">true</span>) {</span>
<span class="line" id="L6397">        <span class="tok-kw">const</span> rc = system.sendto(sockfd, buf.ptr, buf.len, flags, dest_addr, addrlen);</span>
<span class="line" id="L6398">        <span class="tok-kw">switch</span> (errno(rc)) {</span>
<span class="line" id="L6399">            .SUCCESS =&gt; <span class="tok-kw">return</span> <span class="tok-builtin">@intCast</span>(rc),</span>
<span class="line" id="L6400"></span>
<span class="line" id="L6401">            .ACCES =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.AccessDenied,</span>
<span class="line" id="L6402">            .AGAIN =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.WouldBlock,</span>
<span class="line" id="L6403">            .ALREADY =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.FastOpenAlreadyInProgress,</span>
<span class="line" id="L6404">            .BADF =&gt; <span class="tok-kw">unreachable</span>, <span class="tok-comment">// always a race condition</span>
</span>
<span class="line" id="L6405">            .CONNRESET =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.ConnectionResetByPeer,</span>
<span class="line" id="L6406">            .DESTADDRREQ =&gt; <span class="tok-kw">unreachable</span>, <span class="tok-comment">// The socket is not connection-mode, and no peer address is set.</span>
</span>
<span class="line" id="L6407">            .FAULT =&gt; <span class="tok-kw">unreachable</span>, <span class="tok-comment">// An invalid user space address was specified for an argument.</span>
</span>
<span class="line" id="L6408">            .INTR =&gt; <span class="tok-kw">continue</span>,</span>
<span class="line" id="L6409">            .INVAL =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.UnreachableAddress,</span>
<span class="line" id="L6410">            .ISCONN =&gt; <span class="tok-kw">unreachable</span>, <span class="tok-comment">// connection-mode socket was connected already but a recipient was specified</span>
</span>
<span class="line" id="L6411">            .MSGSIZE =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.MessageTooBig,</span>
<span class="line" id="L6412">            .NOBUFS =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.SystemResources,</span>
<span class="line" id="L6413">            .NOMEM =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.SystemResources,</span>
<span class="line" id="L6414">            .NOTSOCK =&gt; <span class="tok-kw">unreachable</span>, <span class="tok-comment">// The file descriptor sockfd does not refer to a socket.</span>
</span>
<span class="line" id="L6415">            .OPNOTSUPP =&gt; <span class="tok-kw">unreachable</span>, <span class="tok-comment">// Some bit in the flags argument is inappropriate for the socket type.</span>
</span>
<span class="line" id="L6416">            .PIPE =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.BrokenPipe,</span>
<span class="line" id="L6417">            .AFNOSUPPORT =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.AddressFamilyNotSupported,</span>
<span class="line" id="L6418">            .LOOP =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.SymLinkLoop,</span>
<span class="line" id="L6419">            .NAMETOOLONG =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.NameTooLong,</span>
<span class="line" id="L6420">            .NOENT =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.FileNotFound,</span>
<span class="line" id="L6421">            .NOTDIR =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.NotDir,</span>
<span class="line" id="L6422">            .HOSTUNREACH =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.NetworkUnreachable,</span>
<span class="line" id="L6423">            .NETUNREACH =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.NetworkUnreachable,</span>
<span class="line" id="L6424">            .NOTCONN =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.SocketNotConnected,</span>
<span class="line" id="L6425">            .NETDOWN =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.NetworkSubsystemFailed,</span>
<span class="line" id="L6426">            <span class="tok-kw">else</span> =&gt; |err| <span class="tok-kw">return</span> unexpectedErrno(err),</span>
<span class="line" id="L6427">        }</span>
<span class="line" id="L6428">    }</span>
<span class="line" id="L6429">}</span>
<span class="line" id="L6430"></span>
<span class="line" id="L6431"><span class="tok-comment">/// Transmit a message to another socket.</span></span>
<span class="line" id="L6432"><span class="tok-comment">///</span></span>
<span class="line" id="L6433"><span class="tok-comment">/// The `send` call may be used only when the socket is in a connected state (so that the intended</span></span>
<span class="line" id="L6434"><span class="tok-comment">/// recipient  is  known).   The  only  difference  between `send` and `write` is the presence of</span></span>
<span class="line" id="L6435"><span class="tok-comment">/// flags.  With a zero flags argument, `send` is equivalent to  `write`.   Also,  the  following</span></span>
<span class="line" id="L6436"><span class="tok-comment">/// call</span></span>
<span class="line" id="L6437"><span class="tok-comment">///</span></span>
<span class="line" id="L6438"><span class="tok-comment">///     send(sockfd, buf, len, flags);</span></span>
<span class="line" id="L6439"><span class="tok-comment">///</span></span>
<span class="line" id="L6440"><span class="tok-comment">/// is equivalent to</span></span>
<span class="line" id="L6441"><span class="tok-comment">///</span></span>
<span class="line" id="L6442"><span class="tok-comment">///     sendto(sockfd, buf, len, flags, NULL, 0);</span></span>
<span class="line" id="L6443"><span class="tok-comment">///</span></span>
<span class="line" id="L6444"><span class="tok-comment">/// There is no  indication  of  failure  to  deliver.</span></span>
<span class="line" id="L6445"><span class="tok-comment">///</span></span>
<span class="line" id="L6446"><span class="tok-comment">/// When the message does not fit into the send buffer of  the  socket,  `send`  normally  blocks,</span></span>
<span class="line" id="L6447"><span class="tok-comment">/// unless  the socket has been placed in nonblocking I/O mode.  In nonblocking mode it would fail</span></span>
<span class="line" id="L6448"><span class="tok-comment">/// with `SendError.WouldBlock`.  The `select` call may be used  to  determine when it is</span></span>
<span class="line" id="L6449"><span class="tok-comment">/// possible to send more data.</span></span>
<span class="line" id="L6450"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">send</span>(</span>
<span class="line" id="L6451">    <span class="tok-comment">/// The file descriptor of the sending socket.</span></span>
<span class="line" id="L6452">    sockfd: socket_t,</span>
<span class="line" id="L6453">    buf: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>,</span>
<span class="line" id="L6454">    flags: <span class="tok-type">u32</span>,</span>
<span class="line" id="L6455">) SendError!<span class="tok-type">usize</span> {</span>
<span class="line" id="L6456">    <span class="tok-kw">return</span> sendto(sockfd, buf, flags, <span class="tok-null">null</span>, <span class="tok-number">0</span>) <span class="tok-kw">catch</span> |err| <span class="tok-kw">switch</span> (err) {</span>
<span class="line" id="L6457">        <span class="tok-kw">error</span>.AddressFamilyNotSupported =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L6458">        <span class="tok-kw">error</span>.SymLinkLoop =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L6459">        <span class="tok-kw">error</span>.NameTooLong =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L6460">        <span class="tok-kw">error</span>.FileNotFound =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L6461">        <span class="tok-kw">error</span>.NotDir =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L6462">        <span class="tok-kw">error</span>.NetworkUnreachable =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L6463">        <span class="tok-kw">error</span>.AddressNotAvailable =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L6464">        <span class="tok-kw">error</span>.SocketNotConnected =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L6465">        <span class="tok-kw">error</span>.UnreachableAddress =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L6466">        <span class="tok-kw">else</span> =&gt; |e| <span class="tok-kw">return</span> e,</span>
<span class="line" id="L6467">    };</span>
<span class="line" id="L6468">}</span>
<span class="line" id="L6469"></span>
<span class="line" id="L6470"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> SendFileError = PReadError || WriteError || SendError;</span>
<span class="line" id="L6471"></span>
<span class="line" id="L6472"><span class="tok-kw">fn</span> <span class="tok-fn">count_iovec_bytes</span>(iovs: []<span class="tok-kw">const</span> iovec_const) <span class="tok-type">usize</span> {</span>
<span class="line" id="L6473">    <span class="tok-kw">var</span> count: <span class="tok-type">usize</span> = <span class="tok-number">0</span>;</span>
<span class="line" id="L6474">    <span class="tok-kw">for</span> (iovs) |iov| {</span>
<span class="line" id="L6475">        count += iov.iov_len;</span>
<span class="line" id="L6476">    }</span>
<span class="line" id="L6477">    <span class="tok-kw">return</span> count;</span>
<span class="line" id="L6478">}</span>
<span class="line" id="L6479"></span>
<span class="line" id="L6480"><span class="tok-comment">/// Transfer data between file descriptors, with optional headers and trailers.</span></span>
<span class="line" id="L6481"><span class="tok-comment">/// Returns the number of bytes written, which can be zero.</span></span>
<span class="line" id="L6482"><span class="tok-comment">///</span></span>
<span class="line" id="L6483"><span class="tok-comment">/// The `sendfile` call copies `in_len` bytes from one file descriptor to another. When possible,</span></span>
<span class="line" id="L6484"><span class="tok-comment">/// this is done within the operating system kernel, which can provide better performance</span></span>
<span class="line" id="L6485"><span class="tok-comment">/// characteristics than transferring data from kernel to user space and back, such as with</span></span>
<span class="line" id="L6486"><span class="tok-comment">/// `read` and `write` calls. When `in_len` is `0`, it means to copy until the end of the input file has been</span></span>
<span class="line" id="L6487"><span class="tok-comment">/// reached. Note, however, that partial writes are still possible in this case.</span></span>
<span class="line" id="L6488"><span class="tok-comment">///</span></span>
<span class="line" id="L6489"><span class="tok-comment">/// `in_fd` must be a file descriptor opened for reading, and `out_fd` must be a file descriptor</span></span>
<span class="line" id="L6490"><span class="tok-comment">/// opened for writing. They may be any kind of file descriptor; however, if `in_fd` is not a regular</span></span>
<span class="line" id="L6491"><span class="tok-comment">/// file system file, it may cause this function to fall back to calling `read` and `write`, in which case</span></span>
<span class="line" id="L6492"><span class="tok-comment">/// atomicity guarantees no longer apply.</span></span>
<span class="line" id="L6493"><span class="tok-comment">///</span></span>
<span class="line" id="L6494"><span class="tok-comment">/// Copying begins reading at `in_offset`. The input file descriptor seek position is ignored and not updated.</span></span>
<span class="line" id="L6495"><span class="tok-comment">/// If the output file descriptor has a seek position, it is updated as bytes are written. When</span></span>
<span class="line" id="L6496"><span class="tok-comment">/// `in_offset` is past the end of the input file, it successfully reads 0 bytes.</span></span>
<span class="line" id="L6497"><span class="tok-comment">///</span></span>
<span class="line" id="L6498"><span class="tok-comment">/// `flags` has different meanings per operating system; refer to the respective man pages.</span></span>
<span class="line" id="L6499"><span class="tok-comment">///</span></span>
<span class="line" id="L6500"><span class="tok-comment">/// These systems support atomically sending everything, including headers and trailers:</span></span>
<span class="line" id="L6501"><span class="tok-comment">/// * macOS</span></span>
<span class="line" id="L6502"><span class="tok-comment">/// * FreeBSD</span></span>
<span class="line" id="L6503"><span class="tok-comment">///</span></span>
<span class="line" id="L6504"><span class="tok-comment">/// These systems support in-kernel data copying, but headers and trailers are not sent atomically:</span></span>
<span class="line" id="L6505"><span class="tok-comment">/// * Linux</span></span>
<span class="line" id="L6506"><span class="tok-comment">///</span></span>
<span class="line" id="L6507"><span class="tok-comment">/// Other systems fall back to calling `read` / `write`.</span></span>
<span class="line" id="L6508"><span class="tok-comment">///</span></span>
<span class="line" id="L6509"><span class="tok-comment">/// Linux has a limit on how many bytes may be transferred in one `sendfile` call, which is `0x7ffff000`</span></span>
<span class="line" id="L6510"><span class="tok-comment">/// on both 64-bit and 32-bit systems. This is due to using a signed C int as the return value, as</span></span>
<span class="line" id="L6511"><span class="tok-comment">/// well as stuffing the errno codes into the last `4096` values. This is noted on the `sendfile` man page.</span></span>
<span class="line" id="L6512"><span class="tok-comment">/// The limit on Darwin is `0x7fffffff`, trying to write more than that returns EINVAL.</span></span>
<span class="line" id="L6513"><span class="tok-comment">/// The corresponding POSIX limit on this is `math.maxInt(isize)`.</span></span>
<span class="line" id="L6514"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">sendfile</span>(</span>
<span class="line" id="L6515">    out_fd: fd_t,</span>
<span class="line" id="L6516">    in_fd: fd_t,</span>
<span class="line" id="L6517">    in_offset: <span class="tok-type">u64</span>,</span>
<span class="line" id="L6518">    in_len: <span class="tok-type">u64</span>,</span>
<span class="line" id="L6519">    headers: []<span class="tok-kw">const</span> iovec_const,</span>
<span class="line" id="L6520">    trailers: []<span class="tok-kw">const</span> iovec_const,</span>
<span class="line" id="L6521">    flags: <span class="tok-type">u32</span>,</span>
<span class="line" id="L6522">) SendFileError!<span class="tok-type">usize</span> {</span>
<span class="line" id="L6523">    <span class="tok-kw">var</span> header_done = <span class="tok-null">false</span>;</span>
<span class="line" id="L6524">    <span class="tok-kw">var</span> total_written: <span class="tok-type">usize</span> = <span class="tok-number">0</span>;</span>
<span class="line" id="L6525"></span>
<span class="line" id="L6526">    <span class="tok-comment">// Prevents EOVERFLOW.</span>
</span>
<span class="line" id="L6527">    <span class="tok-kw">const</span> size_t = std.meta.Int(.unsigned, <span class="tok-builtin">@typeInfo</span>(<span class="tok-type">usize</span>).Int.bits - <span class="tok-number">1</span>);</span>
<span class="line" id="L6528">    <span class="tok-kw">const</span> max_count = <span class="tok-kw">switch</span> (builtin.os.tag) {</span>
<span class="line" id="L6529">        .linux =&gt; <span class="tok-number">0x7ffff000</span>,</span>
<span class="line" id="L6530">        .macos, .ios, .watchos, .tvos =&gt; math.maxInt(<span class="tok-type">i32</span>),</span>
<span class="line" id="L6531">        <span class="tok-kw">else</span> =&gt; math.maxInt(size_t),</span>
<span class="line" id="L6532">    };</span>
<span class="line" id="L6533"></span>
<span class="line" id="L6534">    <span class="tok-kw">switch</span> (builtin.os.tag) {</span>
<span class="line" id="L6535">        .linux =&gt; sf: {</span>
<span class="line" id="L6536">            <span class="tok-comment">// sendfile() first appeared in Linux 2.2, glibc 2.1.</span>
</span>
<span class="line" id="L6537">            <span class="tok-kw">const</span> call_sf = <span class="tok-kw">comptime</span> <span class="tok-kw">if</span> (builtin.link_libc)</span>
<span class="line" id="L6538">                std.c.versionCheck(.{ .major = <span class="tok-number">2</span>, .minor = <span class="tok-number">1</span>, .patch = <span class="tok-number">0</span> })</span>
<span class="line" id="L6539">            <span class="tok-kw">else</span></span>
<span class="line" id="L6540">                builtin.os.version_range.linux.range.max.order(.{ .major = <span class="tok-number">2</span>, .minor = <span class="tok-number">2</span>, .patch = <span class="tok-number">0</span> }) != .lt;</span>
<span class="line" id="L6541">            <span class="tok-kw">if</span> (!call_sf) <span class="tok-kw">break</span> :sf;</span>
<span class="line" id="L6542"></span>
<span class="line" id="L6543">            <span class="tok-kw">if</span> (headers.len != <span class="tok-number">0</span>) {</span>
<span class="line" id="L6544">                <span class="tok-kw">const</span> amt = <span class="tok-kw">try</span> writev(out_fd, headers);</span>
<span class="line" id="L6545">                total_written += amt;</span>
<span class="line" id="L6546">                <span class="tok-kw">if</span> (amt &lt; count_iovec_bytes(headers)) <span class="tok-kw">return</span> total_written;</span>
<span class="line" id="L6547">                header_done = <span class="tok-null">true</span>;</span>
<span class="line" id="L6548">            }</span>
<span class="line" id="L6549"></span>
<span class="line" id="L6550">            <span class="tok-comment">// Here we match BSD behavior, making a zero count value send as many bytes as possible.</span>
</span>
<span class="line" id="L6551">            <span class="tok-kw">const</span> adjusted_count = <span class="tok-kw">if</span> (in_len == <span class="tok-number">0</span>) max_count <span class="tok-kw">else</span> <span class="tok-builtin">@min</span>(in_len, max_count);</span>
<span class="line" id="L6552"></span>
<span class="line" id="L6553">            <span class="tok-kw">const</span> sendfile_sym = <span class="tok-kw">if</span> (lfs64_abi) system.sendfile64 <span class="tok-kw">else</span> system.sendfile;</span>
<span class="line" id="L6554">            <span class="tok-kw">while</span> (<span class="tok-null">true</span>) {</span>
<span class="line" id="L6555">                <span class="tok-kw">var</span> offset: off_t = <span class="tok-builtin">@bitCast</span>(in_offset);</span>
<span class="line" id="L6556">                <span class="tok-kw">const</span> rc = sendfile_sym(out_fd, in_fd, &amp;offset, adjusted_count);</span>
<span class="line" id="L6557">                <span class="tok-kw">switch</span> (errno(rc)) {</span>
<span class="line" id="L6558">                    .SUCCESS =&gt; {</span>
<span class="line" id="L6559">                        <span class="tok-kw">const</span> amt: <span class="tok-type">usize</span> = <span class="tok-builtin">@bitCast</span>(rc);</span>
<span class="line" id="L6560">                        total_written += amt;</span>
<span class="line" id="L6561">                        <span class="tok-kw">if</span> (in_len == <span class="tok-number">0</span> <span class="tok-kw">and</span> amt == <span class="tok-number">0</span>) {</span>
<span class="line" id="L6562">                            <span class="tok-comment">// We have detected EOF from `in_fd`.</span>
</span>
<span class="line" id="L6563">                            <span class="tok-kw">break</span>;</span>
<span class="line" id="L6564">                        } <span class="tok-kw">else</span> <span class="tok-kw">if</span> (amt &lt; in_len) {</span>
<span class="line" id="L6565">                            <span class="tok-kw">return</span> total_written;</span>
<span class="line" id="L6566">                        } <span class="tok-kw">else</span> {</span>
<span class="line" id="L6567">                            <span class="tok-kw">break</span>;</span>
<span class="line" id="L6568">                        }</span>
<span class="line" id="L6569">                    },</span>
<span class="line" id="L6570"></span>
<span class="line" id="L6571">                    .BADF =&gt; <span class="tok-kw">unreachable</span>, <span class="tok-comment">// Always a race condition.</span>
</span>
<span class="line" id="L6572">                    .FAULT =&gt; <span class="tok-kw">unreachable</span>, <span class="tok-comment">// Segmentation fault.</span>
</span>
<span class="line" id="L6573">                    .OVERFLOW =&gt; <span class="tok-kw">unreachable</span>, <span class="tok-comment">// We avoid passing too large of a `count`.</span>
</span>
<span class="line" id="L6574">                    .NOTCONN =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.BrokenPipe, <span class="tok-comment">// `out_fd` is an unconnected socket</span>
</span>
<span class="line" id="L6575"></span>
<span class="line" id="L6576">                    .INVAL, .NOSYS =&gt; {</span>
<span class="line" id="L6577">                        <span class="tok-comment">// EINVAL could be any of the following situations:</span>
</span>
<span class="line" id="L6578">                        <span class="tok-comment">// * Descriptor is not valid or locked</span>
</span>
<span class="line" id="L6579">                        <span class="tok-comment">// * an mmap(2)-like operation is  not  available  for in_fd</span>
</span>
<span class="line" id="L6580">                        <span class="tok-comment">// * count is negative</span>
</span>
<span class="line" id="L6581">                        <span class="tok-comment">// * out_fd has the APPEND flag set</span>
</span>
<span class="line" id="L6582">                        <span class="tok-comment">// Because of the &quot;mmap(2)-like operation&quot; possibility, we fall back to doing read/write</span>
</span>
<span class="line" id="L6583">                        <span class="tok-comment">// manually, the same as ENOSYS.</span>
</span>
<span class="line" id="L6584">                        <span class="tok-kw">break</span> :sf;</span>
<span class="line" id="L6585">                    },</span>
<span class="line" id="L6586">                    .AGAIN =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.WouldBlock,</span>
<span class="line" id="L6587">                    .IO =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.InputOutput,</span>
<span class="line" id="L6588">                    .PIPE =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.BrokenPipe,</span>
<span class="line" id="L6589">                    .NOMEM =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.SystemResources,</span>
<span class="line" id="L6590">                    .NXIO =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.Unseekable,</span>
<span class="line" id="L6591">                    .SPIPE =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.Unseekable,</span>
<span class="line" id="L6592">                    <span class="tok-kw">else</span> =&gt; |err| {</span>
<span class="line" id="L6593">                        unexpectedErrno(err) <span class="tok-kw">catch</span> {};</span>
<span class="line" id="L6594">                        <span class="tok-kw">break</span> :sf;</span>
<span class="line" id="L6595">                    },</span>
<span class="line" id="L6596">                }</span>
<span class="line" id="L6597">            }</span>
<span class="line" id="L6598"></span>
<span class="line" id="L6599">            <span class="tok-kw">if</span> (trailers.len != <span class="tok-number">0</span>) {</span>
<span class="line" id="L6600">                total_written += <span class="tok-kw">try</span> writev(out_fd, trailers);</span>
<span class="line" id="L6601">            }</span>
<span class="line" id="L6602"></span>
<span class="line" id="L6603">            <span class="tok-kw">return</span> total_written;</span>
<span class="line" id="L6604">        },</span>
<span class="line" id="L6605">        .freebsd =&gt; sf: {</span>
<span class="line" id="L6606">            <span class="tok-kw">var</span> hdtr_data: std.c.sf_hdtr = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L6607">            <span class="tok-kw">var</span> hdtr: ?*std.c.sf_hdtr = <span class="tok-null">null</span>;</span>
<span class="line" id="L6608">            <span class="tok-kw">if</span> (headers.len != <span class="tok-number">0</span> <span class="tok-kw">or</span> trailers.len != <span class="tok-number">0</span>) {</span>
<span class="line" id="L6609">                <span class="tok-comment">// Here we carefully avoid `@intCast` by returning partial writes when</span>
</span>
<span class="line" id="L6610">                <span class="tok-comment">// too many io vectors are provided.</span>
</span>
<span class="line" id="L6611">                <span class="tok-kw">const</span> hdr_cnt = math.cast(<span class="tok-type">u31</span>, headers.len) <span class="tok-kw">orelse</span> math.maxInt(<span class="tok-type">u31</span>);</span>
<span class="line" id="L6612">                <span class="tok-kw">if</span> (headers.len &gt; hdr_cnt) <span class="tok-kw">return</span> writev(out_fd, headers);</span>
<span class="line" id="L6613"></span>
<span class="line" id="L6614">                <span class="tok-kw">const</span> trl_cnt = math.cast(<span class="tok-type">u31</span>, trailers.len) <span class="tok-kw">orelse</span> math.maxInt(<span class="tok-type">u31</span>);</span>
<span class="line" id="L6615"></span>
<span class="line" id="L6616">                hdtr_data = std.c.sf_hdtr{</span>
<span class="line" id="L6617">                    .headers = headers.ptr,</span>
<span class="line" id="L6618">                    .hdr_cnt = hdr_cnt,</span>
<span class="line" id="L6619">                    .trailers = trailers.ptr,</span>
<span class="line" id="L6620">                    .trl_cnt = trl_cnt,</span>
<span class="line" id="L6621">                };</span>
<span class="line" id="L6622">                hdtr = &amp;hdtr_data;</span>
<span class="line" id="L6623">            }</span>
<span class="line" id="L6624"></span>
<span class="line" id="L6625">            <span class="tok-kw">while</span> (<span class="tok-null">true</span>) {</span>
<span class="line" id="L6626">                <span class="tok-kw">var</span> sbytes: off_t = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L6627">                <span class="tok-kw">const</span> err = errno(system.sendfile(in_fd, out_fd, <span class="tok-builtin">@bitCast</span>(in_offset), <span class="tok-builtin">@min</span>(in_len, max_count), hdtr, &amp;sbytes, flags));</span>
<span class="line" id="L6628">                <span class="tok-kw">const</span> amt: <span class="tok-type">usize</span> = <span class="tok-builtin">@bitCast</span>(sbytes);</span>
<span class="line" id="L6629">                <span class="tok-kw">switch</span> (err) {</span>
<span class="line" id="L6630">                    .SUCCESS =&gt; <span class="tok-kw">return</span> amt,</span>
<span class="line" id="L6631"></span>
<span class="line" id="L6632">                    .BADF =&gt; <span class="tok-kw">unreachable</span>, <span class="tok-comment">// Always a race condition.</span>
</span>
<span class="line" id="L6633">                    .FAULT =&gt; <span class="tok-kw">unreachable</span>, <span class="tok-comment">// Segmentation fault.</span>
</span>
<span class="line" id="L6634">                    .NOTCONN =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.BrokenPipe, <span class="tok-comment">// `out_fd` is an unconnected socket</span>
</span>
<span class="line" id="L6635"></span>
<span class="line" id="L6636">                    .INVAL, .OPNOTSUPP, .NOTSOCK, .NOSYS =&gt; {</span>
<span class="line" id="L6637">                        <span class="tok-comment">// EINVAL could be any of the following situations:</span>
</span>
<span class="line" id="L6638">                        <span class="tok-comment">// * The fd argument is not a regular file.</span>
</span>
<span class="line" id="L6639">                        <span class="tok-comment">// * The s argument is not a SOCK.STREAM type socket.</span>
</span>
<span class="line" id="L6640">                        <span class="tok-comment">// * The offset argument is negative.</span>
</span>
<span class="line" id="L6641">                        <span class="tok-comment">// Because of some of these possibilities, we fall back to doing read/write</span>
</span>
<span class="line" id="L6642">                        <span class="tok-comment">// manually, the same as ENOSYS.</span>
</span>
<span class="line" id="L6643">                        <span class="tok-kw">break</span> :sf;</span>
<span class="line" id="L6644">                    },</span>
<span class="line" id="L6645"></span>
<span class="line" id="L6646">                    .INTR =&gt; <span class="tok-kw">if</span> (amt != <span class="tok-number">0</span>) <span class="tok-kw">return</span> amt <span class="tok-kw">else</span> <span class="tok-kw">continue</span>,</span>
<span class="line" id="L6647"></span>
<span class="line" id="L6648">                    .AGAIN =&gt; <span class="tok-kw">if</span> (amt != <span class="tok-number">0</span>) {</span>
<span class="line" id="L6649">                        <span class="tok-kw">return</span> amt;</span>
<span class="line" id="L6650">                    } <span class="tok-kw">else</span> {</span>
<span class="line" id="L6651">                        <span class="tok-kw">return</span> <span class="tok-kw">error</span>.WouldBlock;</span>
<span class="line" id="L6652">                    },</span>
<span class="line" id="L6653"></span>
<span class="line" id="L6654">                    .BUSY =&gt; <span class="tok-kw">if</span> (amt != <span class="tok-number">0</span>) {</span>
<span class="line" id="L6655">                        <span class="tok-kw">return</span> amt;</span>
<span class="line" id="L6656">                    } <span class="tok-kw">else</span> {</span>
<span class="line" id="L6657">                        <span class="tok-kw">return</span> <span class="tok-kw">error</span>.WouldBlock;</span>
<span class="line" id="L6658">                    },</span>
<span class="line" id="L6659"></span>
<span class="line" id="L6660">                    .IO =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.InputOutput,</span>
<span class="line" id="L6661">                    .NOBUFS =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.SystemResources,</span>
<span class="line" id="L6662">                    .PIPE =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.BrokenPipe,</span>
<span class="line" id="L6663"></span>
<span class="line" id="L6664">                    <span class="tok-kw">else</span> =&gt; {</span>
<span class="line" id="L6665">                        unexpectedErrno(err) <span class="tok-kw">catch</span> {};</span>
<span class="line" id="L6666">                        <span class="tok-kw">if</span> (amt != <span class="tok-number">0</span>) {</span>
<span class="line" id="L6667">                            <span class="tok-kw">return</span> amt;</span>
<span class="line" id="L6668">                        } <span class="tok-kw">else</span> {</span>
<span class="line" id="L6669">                            <span class="tok-kw">break</span> :sf;</span>
<span class="line" id="L6670">                        }</span>
<span class="line" id="L6671">                    },</span>
<span class="line" id="L6672">                }</span>
<span class="line" id="L6673">            }</span>
<span class="line" id="L6674">        },</span>
<span class="line" id="L6675">        .macos, .ios, .tvos, .watchos =&gt; sf: {</span>
<span class="line" id="L6676">            <span class="tok-kw">var</span> hdtr_data: std.c.sf_hdtr = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L6677">            <span class="tok-kw">var</span> hdtr: ?*std.c.sf_hdtr = <span class="tok-null">null</span>;</span>
<span class="line" id="L6678">            <span class="tok-kw">if</span> (headers.len != <span class="tok-number">0</span> <span class="tok-kw">or</span> trailers.len != <span class="tok-number">0</span>) {</span>
<span class="line" id="L6679">                <span class="tok-comment">// Here we carefully avoid `@intCast` by returning partial writes when</span>
</span>
<span class="line" id="L6680">                <span class="tok-comment">// too many io vectors are provided.</span>
</span>
<span class="line" id="L6681">                <span class="tok-kw">const</span> hdr_cnt = math.cast(<span class="tok-type">u31</span>, headers.len) <span class="tok-kw">orelse</span> math.maxInt(<span class="tok-type">u31</span>);</span>
<span class="line" id="L6682">                <span class="tok-kw">if</span> (headers.len &gt; hdr_cnt) <span class="tok-kw">return</span> writev(out_fd, headers);</span>
<span class="line" id="L6683"></span>
<span class="line" id="L6684">                <span class="tok-kw">const</span> trl_cnt = math.cast(<span class="tok-type">u31</span>, trailers.len) <span class="tok-kw">orelse</span> math.maxInt(<span class="tok-type">u31</span>);</span>
<span class="line" id="L6685"></span>
<span class="line" id="L6686">                hdtr_data = std.c.sf_hdtr{</span>
<span class="line" id="L6687">                    .headers = headers.ptr,</span>
<span class="line" id="L6688">                    .hdr_cnt = hdr_cnt,</span>
<span class="line" id="L6689">                    .trailers = trailers.ptr,</span>
<span class="line" id="L6690">                    .trl_cnt = trl_cnt,</span>
<span class="line" id="L6691">                };</span>
<span class="line" id="L6692">                hdtr = &amp;hdtr_data;</span>
<span class="line" id="L6693">            }</span>
<span class="line" id="L6694"></span>
<span class="line" id="L6695">            <span class="tok-kw">while</span> (<span class="tok-null">true</span>) {</span>
<span class="line" id="L6696">                <span class="tok-kw">var</span> sbytes: off_t = <span class="tok-builtin">@min</span>(in_len, max_count);</span>
<span class="line" id="L6697">                <span class="tok-kw">const</span> err = errno(system.sendfile(in_fd, out_fd, <span class="tok-builtin">@bitCast</span>(in_offset), &amp;sbytes, hdtr, flags));</span>
<span class="line" id="L6698">                <span class="tok-kw">const</span> amt: <span class="tok-type">usize</span> = <span class="tok-builtin">@bitCast</span>(sbytes);</span>
<span class="line" id="L6699">                <span class="tok-kw">switch</span> (err) {</span>
<span class="line" id="L6700">                    .SUCCESS =&gt; <span class="tok-kw">return</span> amt,</span>
<span class="line" id="L6701"></span>
<span class="line" id="L6702">                    .BADF =&gt; <span class="tok-kw">unreachable</span>, <span class="tok-comment">// Always a race condition.</span>
</span>
<span class="line" id="L6703">                    .FAULT =&gt; <span class="tok-kw">unreachable</span>, <span class="tok-comment">// Segmentation fault.</span>
</span>
<span class="line" id="L6704">                    .INVAL =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L6705">                    .NOTCONN =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.BrokenPipe, <span class="tok-comment">// `out_fd` is an unconnected socket</span>
</span>
<span class="line" id="L6706"></span>
<span class="line" id="L6707">                    .OPNOTSUPP, .NOTSOCK, .NOSYS =&gt; <span class="tok-kw">break</span> :sf,</span>
<span class="line" id="L6708"></span>
<span class="line" id="L6709">                    .INTR =&gt; <span class="tok-kw">if</span> (amt != <span class="tok-number">0</span>) <span class="tok-kw">return</span> amt <span class="tok-kw">else</span> <span class="tok-kw">continue</span>,</span>
<span class="line" id="L6710"></span>
<span class="line" id="L6711">                    .AGAIN =&gt; <span class="tok-kw">if</span> (amt != <span class="tok-number">0</span>) {</span>
<span class="line" id="L6712">                        <span class="tok-kw">return</span> amt;</span>
<span class="line" id="L6713">                    } <span class="tok-kw">else</span> {</span>
<span class="line" id="L6714">                        <span class="tok-kw">return</span> <span class="tok-kw">error</span>.WouldBlock;</span>
<span class="line" id="L6715">                    },</span>
<span class="line" id="L6716"></span>
<span class="line" id="L6717">                    .IO =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.InputOutput,</span>
<span class="line" id="L6718">                    .PIPE =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.BrokenPipe,</span>
<span class="line" id="L6719"></span>
<span class="line" id="L6720">                    <span class="tok-kw">else</span> =&gt; {</span>
<span class="line" id="L6721">                        unexpectedErrno(err) <span class="tok-kw">catch</span> {};</span>
<span class="line" id="L6722">                        <span class="tok-kw">if</span> (amt != <span class="tok-number">0</span>) {</span>
<span class="line" id="L6723">                            <span class="tok-kw">return</span> amt;</span>
<span class="line" id="L6724">                        } <span class="tok-kw">else</span> {</span>
<span class="line" id="L6725">                            <span class="tok-kw">break</span> :sf;</span>
<span class="line" id="L6726">                        }</span>
<span class="line" id="L6727">                    },</span>
<span class="line" id="L6728">                }</span>
<span class="line" id="L6729">            }</span>
<span class="line" id="L6730">        },</span>
<span class="line" id="L6731">        <span class="tok-kw">else</span> =&gt; {}, <span class="tok-comment">// fall back to read/write</span>
</span>
<span class="line" id="L6732">    }</span>
<span class="line" id="L6733"></span>
<span class="line" id="L6734">    <span class="tok-kw">if</span> (headers.len != <span class="tok-number">0</span> <span class="tok-kw">and</span> !header_done) {</span>
<span class="line" id="L6735">        <span class="tok-kw">const</span> amt = <span class="tok-kw">try</span> writev(out_fd, headers);</span>
<span class="line" id="L6736">        total_written += amt;</span>
<span class="line" id="L6737">        <span class="tok-kw">if</span> (amt &lt; count_iovec_bytes(headers)) <span class="tok-kw">return</span> total_written;</span>
<span class="line" id="L6738">    }</span>
<span class="line" id="L6739"></span>
<span class="line" id="L6740">    rw: {</span>
<span class="line" id="L6741">        <span class="tok-kw">var</span> buf: [<span class="tok-number">8</span> * <span class="tok-number">4096</span>]<span class="tok-type">u8</span> = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L6742">        <span class="tok-comment">// Here we match BSD behavior, making a zero count value send as many bytes as possible.</span>
</span>
<span class="line" id="L6743">        <span class="tok-kw">const</span> adjusted_count = <span class="tok-kw">if</span> (in_len == <span class="tok-number">0</span>) buf.len <span class="tok-kw">else</span> <span class="tok-builtin">@min</span>(buf.len, in_len);</span>
<span class="line" id="L6744">        <span class="tok-kw">const</span> amt_read = <span class="tok-kw">try</span> pread(in_fd, buf[<span class="tok-number">0</span>..adjusted_count], in_offset);</span>
<span class="line" id="L6745">        <span class="tok-kw">if</span> (amt_read == <span class="tok-number">0</span>) {</span>
<span class="line" id="L6746">            <span class="tok-kw">if</span> (in_len == <span class="tok-number">0</span>) {</span>
<span class="line" id="L6747">                <span class="tok-comment">// We have detected EOF from `in_fd`.</span>
</span>
<span class="line" id="L6748">                <span class="tok-kw">break</span> :rw;</span>
<span class="line" id="L6749">            } <span class="tok-kw">else</span> {</span>
<span class="line" id="L6750">                <span class="tok-kw">return</span> total_written;</span>
<span class="line" id="L6751">            }</span>
<span class="line" id="L6752">        }</span>
<span class="line" id="L6753">        <span class="tok-kw">const</span> amt_written = <span class="tok-kw">try</span> write(out_fd, buf[<span class="tok-number">0</span>..amt_read]);</span>
<span class="line" id="L6754">        total_written += amt_written;</span>
<span class="line" id="L6755">        <span class="tok-kw">if</span> (amt_written &lt; in_len <span class="tok-kw">or</span> in_len == <span class="tok-number">0</span>) <span class="tok-kw">return</span> total_written;</span>
<span class="line" id="L6756">    }</span>
<span class="line" id="L6757"></span>
<span class="line" id="L6758">    <span class="tok-kw">if</span> (trailers.len != <span class="tok-number">0</span>) {</span>
<span class="line" id="L6759">        total_written += <span class="tok-kw">try</span> writev(out_fd, trailers);</span>
<span class="line" id="L6760">    }</span>
<span class="line" id="L6761"></span>
<span class="line" id="L6762">    <span class="tok-kw">return</span> total_written;</span>
<span class="line" id="L6763">}</span>
<span class="line" id="L6764"></span>
<span class="line" id="L6765"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> CopyFileRangeError = <span class="tok-kw">error</span>{</span>
<span class="line" id="L6766">    FileTooBig,</span>
<span class="line" id="L6767">    InputOutput,</span>
<span class="line" id="L6768">    <span class="tok-comment">/// `fd_in` is not open for reading; or `fd_out` is not open  for  writing;</span></span>
<span class="line" id="L6769">    <span class="tok-comment">/// or the  `APPEND`  flag  is  set  for `fd_out`.</span></span>
<span class="line" id="L6770">    FilesOpenedWithWrongFlags,</span>
<span class="line" id="L6771">    IsDir,</span>
<span class="line" id="L6772">    OutOfMemory,</span>
<span class="line" id="L6773">    NoSpaceLeft,</span>
<span class="line" id="L6774">    Unseekable,</span>
<span class="line" id="L6775">    PermissionDenied,</span>
<span class="line" id="L6776">    SwapFile,</span>
<span class="line" id="L6777">    CorruptedData,</span>
<span class="line" id="L6778">} || PReadError || PWriteError || UnexpectedError;</span>
<span class="line" id="L6779"></span>
<span class="line" id="L6780"><span class="tok-kw">var</span> has_copy_file_range_syscall = std.atomic.Value(<span class="tok-type">bool</span>).init(<span class="tok-null">true</span>);</span>
<span class="line" id="L6781"></span>
<span class="line" id="L6782"><span class="tok-comment">/// Transfer data between file descriptors at specified offsets.</span></span>
<span class="line" id="L6783"><span class="tok-comment">/// Returns the number of bytes written, which can less than requested.</span></span>
<span class="line" id="L6784"><span class="tok-comment">///</span></span>
<span class="line" id="L6785"><span class="tok-comment">/// The `copy_file_range` call copies `len` bytes from one file descriptor to another. When possible,</span></span>
<span class="line" id="L6786"><span class="tok-comment">/// this is done within the operating system kernel, which can provide better performance</span></span>
<span class="line" id="L6787"><span class="tok-comment">/// characteristics than transferring data from kernel to user space and back, such as with</span></span>
<span class="line" id="L6788"><span class="tok-comment">/// `pread` and `pwrite` calls.</span></span>
<span class="line" id="L6789"><span class="tok-comment">///</span></span>
<span class="line" id="L6790"><span class="tok-comment">/// `fd_in` must be a file descriptor opened for reading, and `fd_out` must be a file descriptor</span></span>
<span class="line" id="L6791"><span class="tok-comment">/// opened for writing. They may be any kind of file descriptor; however, if `fd_in` is not a regular</span></span>
<span class="line" id="L6792"><span class="tok-comment">/// file system file, it may cause this function to fall back to calling `pread` and `pwrite`, in which case</span></span>
<span class="line" id="L6793"><span class="tok-comment">/// atomicity guarantees no longer apply.</span></span>
<span class="line" id="L6794"><span class="tok-comment">///</span></span>
<span class="line" id="L6795"><span class="tok-comment">/// If `fd_in` and `fd_out` are the same, source and target ranges must not overlap.</span></span>
<span class="line" id="L6796"><span class="tok-comment">/// The file descriptor seek positions are ignored and not updated.</span></span>
<span class="line" id="L6797"><span class="tok-comment">/// When `off_in` is past the end of the input file, it successfully reads 0 bytes.</span></span>
<span class="line" id="L6798"><span class="tok-comment">///</span></span>
<span class="line" id="L6799"><span class="tok-comment">/// `flags` has different meanings per operating system; refer to the respective man pages.</span></span>
<span class="line" id="L6800"><span class="tok-comment">///</span></span>
<span class="line" id="L6801"><span class="tok-comment">/// These systems support in-kernel data copying:</span></span>
<span class="line" id="L6802"><span class="tok-comment">/// * Linux 4.5 (cross-filesystem 5.3)</span></span>
<span class="line" id="L6803"><span class="tok-comment">/// * FreeBSD 13.0</span></span>
<span class="line" id="L6804"><span class="tok-comment">///</span></span>
<span class="line" id="L6805"><span class="tok-comment">/// Other systems fall back to calling `pread` / `pwrite`.</span></span>
<span class="line" id="L6806"><span class="tok-comment">///</span></span>
<span class="line" id="L6807"><span class="tok-comment">/// Maximum offsets on Linux and FreeBSD are `math.maxInt(i64)`.</span></span>
<span class="line" id="L6808"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">copy_file_range</span>(fd_in: fd_t, off_in: <span class="tok-type">u64</span>, fd_out: fd_t, off_out: <span class="tok-type">u64</span>, len: <span class="tok-type">usize</span>, flags: <span class="tok-type">u32</span>) CopyFileRangeError!<span class="tok-type">usize</span> {</span>
<span class="line" id="L6809">    <span class="tok-kw">if</span> ((<span class="tok-kw">comptime</span> builtin.os.isAtLeast(.freebsd, .{ .major = <span class="tok-number">13</span>, .minor = <span class="tok-number">0</span>, .patch = <span class="tok-number">0</span> }) <span class="tok-kw">orelse</span> <span class="tok-null">false</span>) <span class="tok-kw">or</span></span>
<span class="line" id="L6810">        ((<span class="tok-kw">comptime</span> builtin.os.isAtLeast(.linux, .{ .major = <span class="tok-number">4</span>, .minor = <span class="tok-number">5</span>, .patch = <span class="tok-number">0</span> }) <span class="tok-kw">orelse</span> <span class="tok-null">false</span> <span class="tok-kw">and</span></span>
<span class="line" id="L6811">        std.c.versionCheck(.{ .major = <span class="tok-number">2</span>, .minor = <span class="tok-number">27</span>, .patch = <span class="tok-number">0</span> })) <span class="tok-kw">and</span></span>
<span class="line" id="L6812">        has_copy_file_range_syscall.load(.Monotonic)))</span>
<span class="line" id="L6813">    {</span>
<span class="line" id="L6814">        <span class="tok-kw">var</span> off_in_copy: <span class="tok-type">i64</span> = <span class="tok-builtin">@bitCast</span>(off_in);</span>
<span class="line" id="L6815">        <span class="tok-kw">var</span> off_out_copy: <span class="tok-type">i64</span> = <span class="tok-builtin">@bitCast</span>(off_out);</span>
<span class="line" id="L6816"></span>
<span class="line" id="L6817">        <span class="tok-kw">while</span> (<span class="tok-null">true</span>) {</span>
<span class="line" id="L6818">            <span class="tok-kw">const</span> rc = system.copy_file_range(fd_in, &amp;off_in_copy, fd_out, &amp;off_out_copy, len, flags);</span>
<span class="line" id="L6819">            <span class="tok-kw">if</span> (builtin.os.tag == .freebsd) {</span>
<span class="line" id="L6820">                <span class="tok-kw">switch</span> (system.getErrno(rc)) {</span>
<span class="line" id="L6821">                    .SUCCESS =&gt; <span class="tok-kw">return</span> <span class="tok-builtin">@intCast</span>(rc),</span>
<span class="line" id="L6822">                    .BADF =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.FilesOpenedWithWrongFlags,</span>
<span class="line" id="L6823">                    .FBIG =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.FileTooBig,</span>
<span class="line" id="L6824">                    .IO =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.InputOutput,</span>
<span class="line" id="L6825">                    .ISDIR =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.IsDir,</span>
<span class="line" id="L6826">                    .NOSPC =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.NoSpaceLeft,</span>
<span class="line" id="L6827">                    .INVAL =&gt; <span class="tok-kw">break</span>, <span class="tok-comment">// these may not be regular files, try fallback</span>
</span>
<span class="line" id="L6828">                    .INTEGRITY =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.CorruptedData,</span>
<span class="line" id="L6829">                    .INTR =&gt; <span class="tok-kw">continue</span>,</span>
<span class="line" id="L6830">                    <span class="tok-kw">else</span> =&gt; |err| <span class="tok-kw">return</span> unexpectedErrno(err),</span>
<span class="line" id="L6831">                }</span>
<span class="line" id="L6832">            } <span class="tok-kw">else</span> { <span class="tok-comment">// assume linux</span>
</span>
<span class="line" id="L6833">                <span class="tok-kw">switch</span> (system.getErrno(rc)) {</span>
<span class="line" id="L6834">                    .SUCCESS =&gt; <span class="tok-kw">return</span> <span class="tok-builtin">@intCast</span>(rc),</span>
<span class="line" id="L6835">                    .BADF =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.FilesOpenedWithWrongFlags,</span>
<span class="line" id="L6836">                    .FBIG =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.FileTooBig,</span>
<span class="line" id="L6837">                    .IO =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.InputOutput,</span>
<span class="line" id="L6838">                    .ISDIR =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.IsDir,</span>
<span class="line" id="L6839">                    .NOSPC =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.NoSpaceLeft,</span>
<span class="line" id="L6840">                    .INVAL =&gt; <span class="tok-kw">break</span>, <span class="tok-comment">// these may not be regular files, try fallback</span>
</span>
<span class="line" id="L6841">                    .NOMEM =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.OutOfMemory,</span>
<span class="line" id="L6842">                    .OVERFLOW =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.Unseekable,</span>
<span class="line" id="L6843">                    .PERM =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.PermissionDenied,</span>
<span class="line" id="L6844">                    .TXTBSY =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.SwapFile,</span>
<span class="line" id="L6845">                    .XDEV =&gt; <span class="tok-kw">break</span>, <span class="tok-comment">// support for cross-filesystem copy added in Linux 5.3, use fallback</span>
</span>
<span class="line" id="L6846">                    .NOSYS =&gt; { <span class="tok-comment">// syscall added in Linux 4.5, use fallback</span>
</span>
<span class="line" id="L6847">                        has_copy_file_range_syscall.store(<span class="tok-null">false</span>, .Monotonic);</span>
<span class="line" id="L6848">                        <span class="tok-kw">break</span>;</span>
<span class="line" id="L6849">                    },</span>
<span class="line" id="L6850">                    <span class="tok-kw">else</span> =&gt; |err| <span class="tok-kw">return</span> unexpectedErrno(err),</span>
<span class="line" id="L6851">                }</span>
<span class="line" id="L6852">            }</span>
<span class="line" id="L6853">        }</span>
<span class="line" id="L6854">    }</span>
<span class="line" id="L6855"></span>
<span class="line" id="L6856">    <span class="tok-kw">var</span> buf: [<span class="tok-number">8</span> * <span class="tok-number">4096</span>]<span class="tok-type">u8</span> = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L6857">    <span class="tok-kw">const</span> amt_read = <span class="tok-kw">try</span> pread(fd_in, buf[<span class="tok-number">0</span>..<span class="tok-builtin">@min</span>(buf.len, len)], off_in);</span>
<span class="line" id="L6858">    <span class="tok-kw">if</span> (amt_read == <span class="tok-number">0</span>) <span class="tok-kw">return</span> <span class="tok-number">0</span>;</span>
<span class="line" id="L6859">    <span class="tok-kw">return</span> pwrite(fd_out, buf[<span class="tok-number">0</span>..amt_read], off_out);</span>
<span class="line" id="L6860">}</span>
<span class="line" id="L6861"></span>
<span class="line" id="L6862"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> PollError = <span class="tok-kw">error</span>{</span>
<span class="line" id="L6863">    <span class="tok-comment">/// The network subsystem has failed.</span></span>
<span class="line" id="L6864">    NetworkSubsystemFailed,</span>
<span class="line" id="L6865"></span>
<span class="line" id="L6866">    <span class="tok-comment">/// The kernel had no space to allocate file descriptor tables.</span></span>
<span class="line" id="L6867">    SystemResources,</span>
<span class="line" id="L6868">} || UnexpectedError;</span>
<span class="line" id="L6869"></span>
<span class="line" id="L6870"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">poll</span>(fds: []pollfd, timeout: <span class="tok-type">i32</span>) PollError!<span class="tok-type">usize</span> {</span>
<span class="line" id="L6871">    <span class="tok-kw">while</span> (<span class="tok-null">true</span>) {</span>
<span class="line" id="L6872">        <span class="tok-kw">const</span> fds_count = math.cast(nfds_t, fds.len) <span class="tok-kw">orelse</span> <span class="tok-kw">return</span> <span class="tok-kw">error</span>.SystemResources;</span>
<span class="line" id="L6873">        <span class="tok-kw">const</span> rc = system.poll(fds.ptr, fds_count, timeout);</span>
<span class="line" id="L6874">        <span class="tok-kw">if</span> (builtin.os.tag == .windows) {</span>
<span class="line" id="L6875">            <span class="tok-kw">if</span> (rc == windows.ws2_32.SOCKET_ERROR) {</span>
<span class="line" id="L6876">                <span class="tok-kw">switch</span> (windows.ws2_32.WSAGetLastError()) {</span>
<span class="line" id="L6877">                    .WSANOTINITIALISED =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L6878">                    .WSAENETDOWN =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.NetworkSubsystemFailed,</span>
<span class="line" id="L6879">                    .WSAENOBUFS =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.SystemResources,</span>
<span class="line" id="L6880">                    <span class="tok-comment">// TODO: handle more errors</span>
</span>
<span class="line" id="L6881">                    <span class="tok-kw">else</span> =&gt; |err| <span class="tok-kw">return</span> windows.unexpectedWSAError(err),</span>
<span class="line" id="L6882">                }</span>
<span class="line" id="L6883">            } <span class="tok-kw">else</span> {</span>
<span class="line" id="L6884">                <span class="tok-kw">return</span> <span class="tok-builtin">@intCast</span>(rc);</span>
<span class="line" id="L6885">            }</span>
<span class="line" id="L6886">        } <span class="tok-kw">else</span> {</span>
<span class="line" id="L6887">            <span class="tok-kw">switch</span> (errno(rc)) {</span>
<span class="line" id="L6888">                .SUCCESS =&gt; <span class="tok-kw">return</span> <span class="tok-builtin">@intCast</span>(rc),</span>
<span class="line" id="L6889">                .FAULT =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L6890">                .INTR =&gt; <span class="tok-kw">continue</span>,</span>
<span class="line" id="L6891">                .INVAL =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L6892">                .NOMEM =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.SystemResources,</span>
<span class="line" id="L6893">                <span class="tok-kw">else</span> =&gt; |err| <span class="tok-kw">return</span> unexpectedErrno(err),</span>
<span class="line" id="L6894">            }</span>
<span class="line" id="L6895">        }</span>
<span class="line" id="L6896">        <span class="tok-kw">unreachable</span>;</span>
<span class="line" id="L6897">    }</span>
<span class="line" id="L6898">}</span>
<span class="line" id="L6899"></span>
<span class="line" id="L6900"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> PPollError = <span class="tok-kw">error</span>{</span>
<span class="line" id="L6901">    <span class="tok-comment">/// The operation was interrupted by a delivery of a signal before it could complete.</span></span>
<span class="line" id="L6902">    SignalInterrupt,</span>
<span class="line" id="L6903"></span>
<span class="line" id="L6904">    <span class="tok-comment">/// The kernel had no space to allocate file descriptor tables.</span></span>
<span class="line" id="L6905">    SystemResources,</span>
<span class="line" id="L6906">} || UnexpectedError;</span>
<span class="line" id="L6907"></span>
<span class="line" id="L6908"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">ppoll</span>(fds: []pollfd, timeout: ?*<span class="tok-kw">const</span> timespec, mask: ?*<span class="tok-kw">const</span> sigset_t) PPollError!<span class="tok-type">usize</span> {</span>
<span class="line" id="L6909">    <span class="tok-kw">var</span> ts: timespec = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L6910">    <span class="tok-kw">var</span> ts_ptr: ?*timespec = <span class="tok-null">null</span>;</span>
<span class="line" id="L6911">    <span class="tok-kw">if</span> (timeout) |timeout_ns| {</span>
<span class="line" id="L6912">        ts_ptr = &amp;ts;</span>
<span class="line" id="L6913">        ts = timeout_ns.*;</span>
<span class="line" id="L6914">    }</span>
<span class="line" id="L6915">    <span class="tok-kw">const</span> fds_count = math.cast(nfds_t, fds.len) <span class="tok-kw">orelse</span> <span class="tok-kw">return</span> <span class="tok-kw">error</span>.SystemResources;</span>
<span class="line" id="L6916">    <span class="tok-kw">const</span> rc = system.ppoll(fds.ptr, fds_count, ts_ptr, mask);</span>
<span class="line" id="L6917">    <span class="tok-kw">switch</span> (errno(rc)) {</span>
<span class="line" id="L6918">        .SUCCESS =&gt; <span class="tok-kw">return</span> <span class="tok-builtin">@intCast</span>(rc),</span>
<span class="line" id="L6919">        .FAULT =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L6920">        .INTR =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.SignalInterrupt,</span>
<span class="line" id="L6921">        .INVAL =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L6922">        .NOMEM =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.SystemResources,</span>
<span class="line" id="L6923">        <span class="tok-kw">else</span> =&gt; |err| <span class="tok-kw">return</span> unexpectedErrno(err),</span>
<span class="line" id="L6924">    }</span>
<span class="line" id="L6925">}</span>
<span class="line" id="L6926"></span>
<span class="line" id="L6927"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> RecvFromError = <span class="tok-kw">error</span>{</span>
<span class="line" id="L6928">    <span class="tok-comment">/// The socket is marked nonblocking and the requested operation would block, and</span></span>
<span class="line" id="L6929">    <span class="tok-comment">/// there is no global event loop configured.</span></span>
<span class="line" id="L6930">    WouldBlock,</span>
<span class="line" id="L6931"></span>
<span class="line" id="L6932">    <span class="tok-comment">/// A remote host refused to allow the network connection, typically because it is not</span></span>
<span class="line" id="L6933">    <span class="tok-comment">/// running the requested service.</span></span>
<span class="line" id="L6934">    ConnectionRefused,</span>
<span class="line" id="L6935"></span>
<span class="line" id="L6936">    <span class="tok-comment">/// Could not allocate kernel memory.</span></span>
<span class="line" id="L6937">    SystemResources,</span>
<span class="line" id="L6938"></span>
<span class="line" id="L6939">    ConnectionResetByPeer,</span>
<span class="line" id="L6940">    ConnectionTimedOut,</span>
<span class="line" id="L6941"></span>
<span class="line" id="L6942">    <span class="tok-comment">/// The socket has not been bound.</span></span>
<span class="line" id="L6943">    SocketNotBound,</span>
<span class="line" id="L6944"></span>
<span class="line" id="L6945">    <span class="tok-comment">/// The UDP message was too big for the buffer and part of it has been discarded</span></span>
<span class="line" id="L6946">    MessageTooBig,</span>
<span class="line" id="L6947"></span>
<span class="line" id="L6948">    <span class="tok-comment">/// The network subsystem has failed.</span></span>
<span class="line" id="L6949">    NetworkSubsystemFailed,</span>
<span class="line" id="L6950"></span>
<span class="line" id="L6951">    <span class="tok-comment">/// The socket is not connected (connection-oriented sockets only).</span></span>
<span class="line" id="L6952">    SocketNotConnected,</span>
<span class="line" id="L6953">} || UnexpectedError;</span>
<span class="line" id="L6954"></span>
<span class="line" id="L6955"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">recv</span>(sock: socket_t, buf: []<span class="tok-type">u8</span>, flags: <span class="tok-type">u32</span>) RecvFromError!<span class="tok-type">usize</span> {</span>
<span class="line" id="L6956">    <span class="tok-kw">return</span> recvfrom(sock, buf, flags, <span class="tok-null">null</span>, <span class="tok-null">null</span>);</span>
<span class="line" id="L6957">}</span>
<span class="line" id="L6958"></span>
<span class="line" id="L6959"><span class="tok-comment">/// If `sockfd` is opened in non blocking mode, the function will</span></span>
<span class="line" id="L6960"><span class="tok-comment">/// return error.WouldBlock when EAGAIN is received.</span></span>
<span class="line" id="L6961"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">recvfrom</span>(</span>
<span class="line" id="L6962">    sockfd: socket_t,</span>
<span class="line" id="L6963">    buf: []<span class="tok-type">u8</span>,</span>
<span class="line" id="L6964">    flags: <span class="tok-type">u32</span>,</span>
<span class="line" id="L6965">    src_addr: ?*sockaddr,</span>
<span class="line" id="L6966">    addrlen: ?*socklen_t,</span>
<span class="line" id="L6967">) RecvFromError!<span class="tok-type">usize</span> {</span>
<span class="line" id="L6968">    <span class="tok-kw">while</span> (<span class="tok-null">true</span>) {</span>
<span class="line" id="L6969">        <span class="tok-kw">const</span> rc = system.recvfrom(sockfd, buf.ptr, buf.len, flags, src_addr, addrlen);</span>
<span class="line" id="L6970">        <span class="tok-kw">if</span> (builtin.os.tag == .windows) {</span>
<span class="line" id="L6971">            <span class="tok-kw">if</span> (rc == windows.ws2_32.SOCKET_ERROR) {</span>
<span class="line" id="L6972">                <span class="tok-kw">switch</span> (windows.ws2_32.WSAGetLastError()) {</span>
<span class="line" id="L6973">                    .WSANOTINITIALISED =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L6974">                    .WSAECONNRESET =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.ConnectionResetByPeer,</span>
<span class="line" id="L6975">                    .WSAEINVAL =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.SocketNotBound,</span>
<span class="line" id="L6976">                    .WSAEMSGSIZE =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.MessageTooBig,</span>
<span class="line" id="L6977">                    .WSAENETDOWN =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.NetworkSubsystemFailed,</span>
<span class="line" id="L6978">                    .WSAENOTCONN =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.SocketNotConnected,</span>
<span class="line" id="L6979">                    .WSAEWOULDBLOCK =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.WouldBlock,</span>
<span class="line" id="L6980">                    .WSAETIMEDOUT =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.ConnectionTimedOut,</span>
<span class="line" id="L6981">                    <span class="tok-comment">// TODO: handle more errors</span>
</span>
<span class="line" id="L6982">                    <span class="tok-kw">else</span> =&gt; |err| <span class="tok-kw">return</span> windows.unexpectedWSAError(err),</span>
<span class="line" id="L6983">                }</span>
<span class="line" id="L6984">            } <span class="tok-kw">else</span> {</span>
<span class="line" id="L6985">                <span class="tok-kw">return</span> <span class="tok-builtin">@intCast</span>(rc);</span>
<span class="line" id="L6986">            }</span>
<span class="line" id="L6987">        } <span class="tok-kw">else</span> {</span>
<span class="line" id="L6988">            <span class="tok-kw">switch</span> (errno(rc)) {</span>
<span class="line" id="L6989">                .SUCCESS =&gt; <span class="tok-kw">return</span> <span class="tok-builtin">@intCast</span>(rc),</span>
<span class="line" id="L6990">                .BADF =&gt; <span class="tok-kw">unreachable</span>, <span class="tok-comment">// always a race condition</span>
</span>
<span class="line" id="L6991">                .FAULT =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L6992">                .INVAL =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L6993">                .NOTCONN =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.SocketNotConnected,</span>
<span class="line" id="L6994">                .NOTSOCK =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L6995">                .INTR =&gt; <span class="tok-kw">continue</span>,</span>
<span class="line" id="L6996">                .AGAIN =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.WouldBlock,</span>
<span class="line" id="L6997">                .NOMEM =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.SystemResources,</span>
<span class="line" id="L6998">                .CONNREFUSED =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.ConnectionRefused,</span>
<span class="line" id="L6999">                .CONNRESET =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.ConnectionResetByPeer,</span>
<span class="line" id="L7000">                .TIMEDOUT =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.ConnectionTimedOut,</span>
<span class="line" id="L7001">                <span class="tok-kw">else</span> =&gt; |err| <span class="tok-kw">return</span> unexpectedErrno(err),</span>
<span class="line" id="L7002">            }</span>
<span class="line" id="L7003">        }</span>
<span class="line" id="L7004">    }</span>
<span class="line" id="L7005">}</span>
<span class="line" id="L7006"></span>
<span class="line" id="L7007"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> DnExpandError = <span class="tok-kw">error</span>{InvalidDnsPacket};</span>
<span class="line" id="L7008"></span>
<span class="line" id="L7009"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">dn_expand</span>(</span>
<span class="line" id="L7010">    msg: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>,</span>
<span class="line" id="L7011">    comp_dn: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>,</span>
<span class="line" id="L7012">    exp_dn: []<span class="tok-type">u8</span>,</span>
<span class="line" id="L7013">) DnExpandError!<span class="tok-type">usize</span> {</span>
<span class="line" id="L7014">    <span class="tok-comment">// This implementation is ported from musl libc.</span>
</span>
<span class="line" id="L7015">    <span class="tok-comment">// A more idiomatic &quot;ziggy&quot; implementation would be welcome.</span>
</span>
<span class="line" id="L7016">    <span class="tok-kw">var</span> p = comp_dn.ptr;</span>
<span class="line" id="L7017">    <span class="tok-kw">var</span> len: <span class="tok-type">usize</span> = std.math.maxInt(<span class="tok-type">usize</span>);</span>
<span class="line" id="L7018">    <span class="tok-kw">const</span> end = msg.ptr + msg.len;</span>
<span class="line" id="L7019">    <span class="tok-kw">if</span> (p == end <span class="tok-kw">or</span> exp_dn.len == <span class="tok-number">0</span>) <span class="tok-kw">return</span> <span class="tok-kw">error</span>.InvalidDnsPacket;</span>
<span class="line" id="L7020">    <span class="tok-kw">var</span> dest = exp_dn.ptr;</span>
<span class="line" id="L7021">    <span class="tok-kw">const</span> dend = dest + <span class="tok-builtin">@min</span>(exp_dn.len, <span class="tok-number">254</span>);</span>
<span class="line" id="L7022">    <span class="tok-comment">// detect reference loop using an iteration counter</span>
</span>
<span class="line" id="L7023">    <span class="tok-kw">var</span> i: <span class="tok-type">usize</span> = <span class="tok-number">0</span>;</span>
<span class="line" id="L7024">    <span class="tok-kw">while</span> (i &lt; msg.len) : (i += <span class="tok-number">2</span>) {</span>
<span class="line" id="L7025">        <span class="tok-comment">// loop invariants: p&lt;end, dest&lt;dend</span>
</span>
<span class="line" id="L7026">        <span class="tok-kw">if</span> ((p[<span class="tok-number">0</span>] &amp; <span class="tok-number">0xc0</span>) != <span class="tok-number">0</span>) {</span>
<span class="line" id="L7027">            <span class="tok-kw">if</span> (p + <span class="tok-number">1</span> == end) <span class="tok-kw">return</span> <span class="tok-kw">error</span>.InvalidDnsPacket;</span>
<span class="line" id="L7028">            <span class="tok-kw">const</span> j = <span class="tok-builtin">@as</span>(<span class="tok-type">usize</span>, p[<span class="tok-number">0</span>] &amp; <span class="tok-number">0x3f</span>) &lt;&lt; <span class="tok-number">8</span> | p[<span class="tok-number">1</span>];</span>
<span class="line" id="L7029">            <span class="tok-kw">if</span> (len == std.math.maxInt(<span class="tok-type">usize</span>)) len = <span class="tok-builtin">@intFromPtr</span>(p) + <span class="tok-number">2</span> - <span class="tok-builtin">@intFromPtr</span>(comp_dn.ptr);</span>
<span class="line" id="L7030">            <span class="tok-kw">if</span> (j &gt;= msg.len) <span class="tok-kw">return</span> <span class="tok-kw">error</span>.InvalidDnsPacket;</span>
<span class="line" id="L7031">            p = msg.ptr + j;</span>
<span class="line" id="L7032">        } <span class="tok-kw">else</span> <span class="tok-kw">if</span> (p[<span class="tok-number">0</span>] != <span class="tok-number">0</span>) {</span>
<span class="line" id="L7033">            <span class="tok-kw">if</span> (dest != exp_dn.ptr) {</span>
<span class="line" id="L7034">                dest[<span class="tok-number">0</span>] = <span class="tok-str">'.'</span>;</span>
<span class="line" id="L7035">                dest += <span class="tok-number">1</span>;</span>
<span class="line" id="L7036">            }</span>
<span class="line" id="L7037">            <span class="tok-kw">var</span> j = p[<span class="tok-number">0</span>];</span>
<span class="line" id="L7038">            p += <span class="tok-number">1</span>;</span>
<span class="line" id="L7039">            <span class="tok-kw">if</span> (j &gt;= <span class="tok-builtin">@intFromPtr</span>(end) - <span class="tok-builtin">@intFromPtr</span>(p) <span class="tok-kw">or</span> j &gt;= <span class="tok-builtin">@intFromPtr</span>(dend) - <span class="tok-builtin">@intFromPtr</span>(dest)) {</span>
<span class="line" id="L7040">                <span class="tok-kw">return</span> <span class="tok-kw">error</span>.InvalidDnsPacket;</span>
<span class="line" id="L7041">            }</span>
<span class="line" id="L7042">            <span class="tok-kw">while</span> (j != <span class="tok-number">0</span>) {</span>
<span class="line" id="L7043">                j -= <span class="tok-number">1</span>;</span>
<span class="line" id="L7044">                dest[<span class="tok-number">0</span>] = p[<span class="tok-number">0</span>];</span>
<span class="line" id="L7045">                dest += <span class="tok-number">1</span>;</span>
<span class="line" id="L7046">                p += <span class="tok-number">1</span>;</span>
<span class="line" id="L7047">            }</span>
<span class="line" id="L7048">        } <span class="tok-kw">else</span> {</span>
<span class="line" id="L7049">            dest[<span class="tok-number">0</span>] = <span class="tok-number">0</span>;</span>
<span class="line" id="L7050">            <span class="tok-kw">if</span> (len == std.math.maxInt(<span class="tok-type">usize</span>)) len = <span class="tok-builtin">@intFromPtr</span>(p) + <span class="tok-number">1</span> - <span class="tok-builtin">@intFromPtr</span>(comp_dn.ptr);</span>
<span class="line" id="L7051">            <span class="tok-kw">return</span> len;</span>
<span class="line" id="L7052">        }</span>
<span class="line" id="L7053">    }</span>
<span class="line" id="L7054">    <span class="tok-kw">return</span> <span class="tok-kw">error</span>.InvalidDnsPacket;</span>
<span class="line" id="L7055">}</span>
<span class="line" id="L7056"></span>
<span class="line" id="L7057"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> SetSockOptError = <span class="tok-kw">error</span>{</span>
<span class="line" id="L7058">    <span class="tok-comment">/// The socket is already connected, and a specified option cannot be set while the socket is connected.</span></span>
<span class="line" id="L7059">    AlreadyConnected,</span>
<span class="line" id="L7060"></span>
<span class="line" id="L7061">    <span class="tok-comment">/// The option is not supported by the protocol.</span></span>
<span class="line" id="L7062">    InvalidProtocolOption,</span>
<span class="line" id="L7063"></span>
<span class="line" id="L7064">    <span class="tok-comment">/// The send and receive timeout values are too big to fit into the timeout fields in the socket structure.</span></span>
<span class="line" id="L7065">    TimeoutTooBig,</span>
<span class="line" id="L7066"></span>
<span class="line" id="L7067">    <span class="tok-comment">/// Insufficient resources are available in the system to complete the call.</span></span>
<span class="line" id="L7068">    SystemResources,</span>
<span class="line" id="L7069"></span>
<span class="line" id="L7070">    <span class="tok-comment">// Setting the socket option requires more elevated permissions.</span>
</span>
<span class="line" id="L7071">    PermissionDenied,</span>
<span class="line" id="L7072"></span>
<span class="line" id="L7073">    NetworkSubsystemFailed,</span>
<span class="line" id="L7074">    FileDescriptorNotASocket,</span>
<span class="line" id="L7075">    SocketNotBound,</span>
<span class="line" id="L7076">    NoDevice,</span>
<span class="line" id="L7077">} || UnexpectedError;</span>
<span class="line" id="L7078"></span>
<span class="line" id="L7079"><span class="tok-comment">/// Set a socket's options.</span></span>
<span class="line" id="L7080"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">setsockopt</span>(fd: socket_t, level: <span class="tok-type">u32</span>, optname: <span class="tok-type">u32</span>, opt: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>) SetSockOptError!<span class="tok-type">void</span> {</span>
<span class="line" id="L7081">    <span class="tok-kw">if</span> (builtin.os.tag == .windows) {</span>
<span class="line" id="L7082">        <span class="tok-kw">const</span> rc = windows.ws2_32.setsockopt(fd, <span class="tok-builtin">@intCast</span>(level), <span class="tok-builtin">@intCast</span>(optname), opt.ptr, <span class="tok-builtin">@intCast</span>(opt.len));</span>
<span class="line" id="L7083">        <span class="tok-kw">if</span> (rc == windows.ws2_32.SOCKET_ERROR) {</span>
<span class="line" id="L7084">            <span class="tok-kw">switch</span> (windows.ws2_32.WSAGetLastError()) {</span>
<span class="line" id="L7085">                .WSANOTINITIALISED =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L7086">                .WSAENETDOWN =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.NetworkSubsystemFailed,</span>
<span class="line" id="L7087">                .WSAEFAULT =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L7088">                .WSAENOTSOCK =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.FileDescriptorNotASocket,</span>
<span class="line" id="L7089">                .WSAEINVAL =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.SocketNotBound,</span>
<span class="line" id="L7090">                <span class="tok-kw">else</span> =&gt; |err| <span class="tok-kw">return</span> windows.unexpectedWSAError(err),</span>
<span class="line" id="L7091">            }</span>
<span class="line" id="L7092">        }</span>
<span class="line" id="L7093">        <span class="tok-kw">return</span>;</span>
<span class="line" id="L7094">    } <span class="tok-kw">else</span> {</span>
<span class="line" id="L7095">        <span class="tok-kw">switch</span> (errno(system.setsockopt(fd, level, optname, opt.ptr, <span class="tok-builtin">@intCast</span>(opt.len)))) {</span>
<span class="line" id="L7096">            .SUCCESS =&gt; {},</span>
<span class="line" id="L7097">            .BADF =&gt; <span class="tok-kw">unreachable</span>, <span class="tok-comment">// always a race condition</span>
</span>
<span class="line" id="L7098">            .NOTSOCK =&gt; <span class="tok-kw">unreachable</span>, <span class="tok-comment">// always a race condition</span>
</span>
<span class="line" id="L7099">            .INVAL =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L7100">            .FAULT =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L7101">            .DOM =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.TimeoutTooBig,</span>
<span class="line" id="L7102">            .ISCONN =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.AlreadyConnected,</span>
<span class="line" id="L7103">            .NOPROTOOPT =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.InvalidProtocolOption,</span>
<span class="line" id="L7104">            .NOMEM =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.SystemResources,</span>
<span class="line" id="L7105">            .NOBUFS =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.SystemResources,</span>
<span class="line" id="L7106">            .PERM =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.PermissionDenied,</span>
<span class="line" id="L7107">            .NODEV =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.NoDevice,</span>
<span class="line" id="L7108">            <span class="tok-kw">else</span> =&gt; |err| <span class="tok-kw">return</span> unexpectedErrno(err),</span>
<span class="line" id="L7109">        }</span>
<span class="line" id="L7110">    }</span>
<span class="line" id="L7111">}</span>
<span class="line" id="L7112"></span>
<span class="line" id="L7113"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> MemFdCreateError = <span class="tok-kw">error</span>{</span>
<span class="line" id="L7114">    SystemFdQuotaExceeded,</span>
<span class="line" id="L7115">    ProcessFdQuotaExceeded,</span>
<span class="line" id="L7116">    OutOfMemory,</span>
<span class="line" id="L7117"></span>
<span class="line" id="L7118">    <span class="tok-comment">/// memfd_create is available in Linux 3.17 and later. This error is returned</span></span>
<span class="line" id="L7119">    <span class="tok-comment">/// for older kernel versions.</span></span>
<span class="line" id="L7120">    SystemOutdated,</span>
<span class="line" id="L7121">} || UnexpectedError;</span>
<span class="line" id="L7122"></span>
<span class="line" id="L7123"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">memfd_createZ</span>(name: [*:<span class="tok-number">0</span>]<span class="tok-kw">const</span> <span class="tok-type">u8</span>, flags: <span class="tok-type">u32</span>) MemFdCreateError!fd_t {</span>
<span class="line" id="L7124">    <span class="tok-kw">switch</span> (builtin.os.tag) {</span>
<span class="line" id="L7125">        .linux =&gt; {</span>
<span class="line" id="L7126">            <span class="tok-comment">// memfd_create is available only in glibc versions starting with 2.27.</span>
</span>
<span class="line" id="L7127">            <span class="tok-kw">const</span> use_c = std.c.versionCheck(.{ .major = <span class="tok-number">2</span>, .minor = <span class="tok-number">27</span>, .patch = <span class="tok-number">0</span> });</span>
<span class="line" id="L7128">            <span class="tok-kw">const</span> sys = <span class="tok-kw">if</span> (use_c) std.c <span class="tok-kw">else</span> linux;</span>
<span class="line" id="L7129">            <span class="tok-kw">const</span> getErrno = <span class="tok-kw">if</span> (use_c) std.c.getErrno <span class="tok-kw">else</span> linux.getErrno;</span>
<span class="line" id="L7130">            <span class="tok-kw">const</span> rc = sys.memfd_create(name, flags);</span>
<span class="line" id="L7131">            <span class="tok-kw">switch</span> (getErrno(rc)) {</span>
<span class="line" id="L7132">                .SUCCESS =&gt; <span class="tok-kw">return</span> <span class="tok-builtin">@intCast</span>(rc),</span>
<span class="line" id="L7133">                .FAULT =&gt; <span class="tok-kw">unreachable</span>, <span class="tok-comment">// name has invalid memory</span>
</span>
<span class="line" id="L7134">                .INVAL =&gt; <span class="tok-kw">unreachable</span>, <span class="tok-comment">// name/flags are faulty</span>
</span>
<span class="line" id="L7135">                .NFILE =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.SystemFdQuotaExceeded,</span>
<span class="line" id="L7136">                .MFILE =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.ProcessFdQuotaExceeded,</span>
<span class="line" id="L7137">                .NOMEM =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.OutOfMemory,</span>
<span class="line" id="L7138">                .NOSYS =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.SystemOutdated,</span>
<span class="line" id="L7139">                <span class="tok-kw">else</span> =&gt; |err| <span class="tok-kw">return</span> unexpectedErrno(err),</span>
<span class="line" id="L7140">            }</span>
<span class="line" id="L7141">        },</span>
<span class="line" id="L7142">        .freebsd =&gt; {</span>
<span class="line" id="L7143">            <span class="tok-kw">if</span> (<span class="tok-kw">comptime</span> builtin.os.version_range.semver.max.order(.{ .major = <span class="tok-number">13</span>, .minor = <span class="tok-number">0</span>, .patch = <span class="tok-number">0</span> }) == .lt)</span>
<span class="line" id="L7144">                <span class="tok-builtin">@compileError</span>(<span class="tok-str">&quot;memfd_create is unavailable on FreeBSD &lt; 13.0&quot;</span>);</span>
<span class="line" id="L7145">            <span class="tok-kw">const</span> rc = system.memfd_create(name, flags);</span>
<span class="line" id="L7146">            <span class="tok-kw">switch</span> (errno(rc)) {</span>
<span class="line" id="L7147">                .SUCCESS =&gt; <span class="tok-kw">return</span> rc,</span>
<span class="line" id="L7148">                .BADF =&gt; <span class="tok-kw">unreachable</span>, <span class="tok-comment">// name argument NULL</span>
</span>
<span class="line" id="L7149">                .INVAL =&gt; <span class="tok-kw">unreachable</span>, <span class="tok-comment">// name too long or invalid/unsupported flags.</span>
</span>
<span class="line" id="L7150">                .MFILE =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.ProcessFdQuotaExceeded,</span>
<span class="line" id="L7151">                .NFILE =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.SystemFdQuotaExceeded,</span>
<span class="line" id="L7152">                .NOSYS =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.SystemOutdated,</span>
<span class="line" id="L7153">                <span class="tok-kw">else</span> =&gt; |err| <span class="tok-kw">return</span> unexpectedErrno(err),</span>
<span class="line" id="L7154">            }</span>
<span class="line" id="L7155">        },</span>
<span class="line" id="L7156">        <span class="tok-kw">else</span> =&gt; <span class="tok-builtin">@compileError</span>(<span class="tok-str">&quot;target OS does not support memfd_create()&quot;</span>),</span>
<span class="line" id="L7157">    }</span>
<span class="line" id="L7158">}</span>
<span class="line" id="L7159"></span>
<span class="line" id="L7160"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> MFD_NAME_PREFIX = <span class="tok-str">&quot;memfd:&quot;</span>;</span>
<span class="line" id="L7161"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> MFD_MAX_NAME_LEN = NAME_MAX - MFD_NAME_PREFIX.len;</span>
<span class="line" id="L7162"><span class="tok-kw">fn</span> <span class="tok-fn">toMemFdPath</span>(name: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>) ![MFD_MAX_NAME_LEN:<span class="tok-number">0</span>]<span class="tok-type">u8</span> {</span>
<span class="line" id="L7163">    <span class="tok-kw">var</span> path_with_null: [MFD_MAX_NAME_LEN:<span class="tok-number">0</span>]<span class="tok-type">u8</span> = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L7164">    <span class="tok-comment">// &gt;= rather than &gt; to make room for the null byte</span>
</span>
<span class="line" id="L7165">    <span class="tok-kw">if</span> (name.len &gt;= MFD_MAX_NAME_LEN) <span class="tok-kw">return</span> <span class="tok-kw">error</span>.NameTooLong;</span>
<span class="line" id="L7166">    <span class="tok-builtin">@memcpy</span>(path_with_null[<span class="tok-number">0</span>..name.len], name);</span>
<span class="line" id="L7167">    path_with_null[name.len] = <span class="tok-number">0</span>;</span>
<span class="line" id="L7168">    <span class="tok-kw">return</span> path_with_null;</span>
<span class="line" id="L7169">}</span>
<span class="line" id="L7170"></span>
<span class="line" id="L7171"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">memfd_create</span>(name: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>, flags: <span class="tok-type">u32</span>) !fd_t {</span>
<span class="line" id="L7172">    <span class="tok-kw">const</span> name_t = <span class="tok-kw">try</span> toMemFdPath(name);</span>
<span class="line" id="L7173">    <span class="tok-kw">return</span> memfd_createZ(&amp;name_t, flags);</span>
<span class="line" id="L7174">}</span>
<span class="line" id="L7175"></span>
<span class="line" id="L7176"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">getrusage</span>(who: <span class="tok-type">i32</span>) rusage {</span>
<span class="line" id="L7177">    <span class="tok-kw">var</span> result: rusage = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L7178">    <span class="tok-kw">const</span> rc = system.getrusage(who, &amp;result);</span>
<span class="line" id="L7179">    <span class="tok-kw">switch</span> (errno(rc)) {</span>
<span class="line" id="L7180">        .SUCCESS =&gt; <span class="tok-kw">return</span> result,</span>
<span class="line" id="L7181">        .INVAL =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L7182">        .FAULT =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L7183">        <span class="tok-kw">else</span> =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L7184">    }</span>
<span class="line" id="L7185">}</span>
<span class="line" id="L7186"></span>
<span class="line" id="L7187"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> TIOCError = <span class="tok-kw">error</span>{NotATerminal};</span>
<span class="line" id="L7188"></span>
<span class="line" id="L7189"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> TermiosGetError = TIOCError || UnexpectedError;</span>
<span class="line" id="L7190"></span>
<span class="line" id="L7191"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">tcgetattr</span>(handle: fd_t) TermiosGetError!termios {</span>
<span class="line" id="L7192">    <span class="tok-kw">while</span> (<span class="tok-null">true</span>) {</span>
<span class="line" id="L7193">        <span class="tok-kw">var</span> term: termios = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L7194">        <span class="tok-kw">switch</span> (errno(system.tcgetattr(handle, &amp;term))) {</span>
<span class="line" id="L7195">            .SUCCESS =&gt; <span class="tok-kw">return</span> term,</span>
<span class="line" id="L7196">            .INTR =&gt; <span class="tok-kw">continue</span>,</span>
<span class="line" id="L7197">            .BADF =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L7198">            .NOTTY =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.NotATerminal,</span>
<span class="line" id="L7199">            <span class="tok-kw">else</span> =&gt; |err| <span class="tok-kw">return</span> unexpectedErrno(err),</span>
<span class="line" id="L7200">        }</span>
<span class="line" id="L7201">    }</span>
<span class="line" id="L7202">}</span>
<span class="line" id="L7203"></span>
<span class="line" id="L7204"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> TermiosSetError = TermiosGetError || <span class="tok-kw">error</span>{ProcessOrphaned};</span>
<span class="line" id="L7205"></span>
<span class="line" id="L7206"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">tcsetattr</span>(handle: fd_t, optional_action: TCSA, termios_p: termios) TermiosSetError!<span class="tok-type">void</span> {</span>
<span class="line" id="L7207">    <span class="tok-kw">while</span> (<span class="tok-null">true</span>) {</span>
<span class="line" id="L7208">        <span class="tok-kw">switch</span> (errno(system.tcsetattr(handle, optional_action, &amp;termios_p))) {</span>
<span class="line" id="L7209">            .SUCCESS =&gt; <span class="tok-kw">return</span>,</span>
<span class="line" id="L7210">            .BADF =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L7211">            .INTR =&gt; <span class="tok-kw">continue</span>,</span>
<span class="line" id="L7212">            .INVAL =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L7213">            .NOTTY =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.NotATerminal,</span>
<span class="line" id="L7214">            .IO =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.ProcessOrphaned,</span>
<span class="line" id="L7215">            <span class="tok-kw">else</span> =&gt; |err| <span class="tok-kw">return</span> unexpectedErrno(err),</span>
<span class="line" id="L7216">        }</span>
<span class="line" id="L7217">    }</span>
<span class="line" id="L7218">}</span>
<span class="line" id="L7219"></span>
<span class="line" id="L7220"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> TermioGetPgrpError = TIOCError || UnexpectedError;</span>
<span class="line" id="L7221"></span>
<span class="line" id="L7222"><span class="tok-comment">/// Returns the process group ID for the TTY associated with the given handle.</span></span>
<span class="line" id="L7223"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">tcgetpgrp</span>(handle: fd_t) TermioGetPgrpError!pid_t {</span>
<span class="line" id="L7224">    <span class="tok-kw">while</span> (<span class="tok-null">true</span>) {</span>
<span class="line" id="L7225">        <span class="tok-kw">var</span> pgrp: pid_t = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L7226">        <span class="tok-kw">switch</span> (errno(system.tcgetpgrp(handle, &amp;pgrp))) {</span>
<span class="line" id="L7227">            .SUCCESS =&gt; <span class="tok-kw">return</span> pgrp,</span>
<span class="line" id="L7228">            .BADF =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L7229">            .INVAL =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L7230">            .INTR =&gt; <span class="tok-kw">continue</span>,</span>
<span class="line" id="L7231">            .NOTTY =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.NotATerminal,</span>
<span class="line" id="L7232">            <span class="tok-kw">else</span> =&gt; |err| <span class="tok-kw">return</span> unexpectedErrno(err),</span>
<span class="line" id="L7233">        }</span>
<span class="line" id="L7234">    }</span>
<span class="line" id="L7235">}</span>
<span class="line" id="L7236"></span>
<span class="line" id="L7237"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> TermioSetPgrpError = TermioGetPgrpError || <span class="tok-kw">error</span>{NotAPgrpMember};</span>
<span class="line" id="L7238"></span>
<span class="line" id="L7239"><span class="tok-comment">/// Sets the controlling process group ID for given TTY.</span></span>
<span class="line" id="L7240"><span class="tok-comment">/// handle must be valid fd_t to a TTY associated with calling process.</span></span>
<span class="line" id="L7241"><span class="tok-comment">/// pgrp must be a valid process group, and the calling process must be a member</span></span>
<span class="line" id="L7242"><span class="tok-comment">/// of that group.</span></span>
<span class="line" id="L7243"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">tcsetpgrp</span>(handle: fd_t, pgrp: pid_t) TermioSetPgrpError!<span class="tok-type">void</span> {</span>
<span class="line" id="L7244">    <span class="tok-kw">while</span> (<span class="tok-null">true</span>) {</span>
<span class="line" id="L7245">        <span class="tok-kw">switch</span> (errno(system.tcsetpgrp(handle, &amp;pgrp))) {</span>
<span class="line" id="L7246">            .SUCCESS =&gt; <span class="tok-kw">return</span>,</span>
<span class="line" id="L7247">            .BADF =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L7248">            .INVAL =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L7249">            .INTR =&gt; <span class="tok-kw">continue</span>,</span>
<span class="line" id="L7250">            .NOTTY =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.NotATerminal,</span>
<span class="line" id="L7251">            .PERM =&gt; <span class="tok-kw">return</span> TermioSetPgrpError.NotAPgrpMember,</span>
<span class="line" id="L7252">            <span class="tok-kw">else</span> =&gt; |err| <span class="tok-kw">return</span> unexpectedErrno(err),</span>
<span class="line" id="L7253">        }</span>
<span class="line" id="L7254">    }</span>
<span class="line" id="L7255">}</span>
<span class="line" id="L7256"></span>
<span class="line" id="L7257"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> IoCtl_SIOCGIFINDEX_Error = <span class="tok-kw">error</span>{</span>
<span class="line" id="L7258">    FileSystem,</span>
<span class="line" id="L7259">    InterfaceNotFound,</span>
<span class="line" id="L7260">} || UnexpectedError;</span>
<span class="line" id="L7261"></span>
<span class="line" id="L7262"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">ioctl_SIOCGIFINDEX</span>(fd: fd_t, ifr: *ifreq) IoCtl_SIOCGIFINDEX_Error!<span class="tok-type">void</span> {</span>
<span class="line" id="L7263">    <span class="tok-kw">while</span> (<span class="tok-null">true</span>) {</span>
<span class="line" id="L7264">        <span class="tok-kw">switch</span> (errno(system.ioctl(fd, SIOCGIFINDEX, <span class="tok-builtin">@intFromPtr</span>(ifr)))) {</span>
<span class="line" id="L7265">            .SUCCESS =&gt; <span class="tok-kw">return</span>,</span>
<span class="line" id="L7266">            .INVAL =&gt; <span class="tok-kw">unreachable</span>, <span class="tok-comment">// Bad parameters.</span>
</span>
<span class="line" id="L7267">            .NOTTY =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L7268">            .NXIO =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L7269">            .BADF =&gt; <span class="tok-kw">unreachable</span>, <span class="tok-comment">// Always a race condition.</span>
</span>
<span class="line" id="L7270">            .FAULT =&gt; <span class="tok-kw">unreachable</span>, <span class="tok-comment">// Bad pointer parameter.</span>
</span>
<span class="line" id="L7271">            .INTR =&gt; <span class="tok-kw">continue</span>,</span>
<span class="line" id="L7272">            .IO =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.FileSystem,</span>
<span class="line" id="L7273">            .NODEV =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.InterfaceNotFound,</span>
<span class="line" id="L7274">            <span class="tok-kw">else</span> =&gt; |err| <span class="tok-kw">return</span> unexpectedErrno(err),</span>
<span class="line" id="L7275">        }</span>
<span class="line" id="L7276">    }</span>
<span class="line" id="L7277">}</span>
<span class="line" id="L7278"></span>
<span class="line" id="L7279"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">signalfd</span>(fd: fd_t, mask: *<span class="tok-kw">const</span> sigset_t, flags: <span class="tok-type">u32</span>) !fd_t {</span>
<span class="line" id="L7280">    <span class="tok-kw">const</span> rc = system.signalfd(fd, mask, flags);</span>
<span class="line" id="L7281">    <span class="tok-kw">switch</span> (errno(rc)) {</span>
<span class="line" id="L7282">        .SUCCESS =&gt; <span class="tok-kw">return</span> <span class="tok-builtin">@intCast</span>(rc),</span>
<span class="line" id="L7283">        .BADF, .INVAL =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L7284">        .NFILE =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.SystemFdQuotaExceeded,</span>
<span class="line" id="L7285">        .NOMEM =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.SystemResources,</span>
<span class="line" id="L7286">        .MFILE =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.ProcessResources,</span>
<span class="line" id="L7287">        .NODEV =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.InodeMountFail,</span>
<span class="line" id="L7288">        .NOSYS =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.SystemOutdated,</span>
<span class="line" id="L7289">        <span class="tok-kw">else</span> =&gt; |err| <span class="tok-kw">return</span> unexpectedErrno(err),</span>
<span class="line" id="L7290">    }</span>
<span class="line" id="L7291">}</span>
<span class="line" id="L7292"></span>
<span class="line" id="L7293"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> SyncError = <span class="tok-kw">error</span>{</span>
<span class="line" id="L7294">    InputOutput,</span>
<span class="line" id="L7295">    NoSpaceLeft,</span>
<span class="line" id="L7296">    DiskQuota,</span>
<span class="line" id="L7297">    AccessDenied,</span>
<span class="line" id="L7298">} || UnexpectedError;</span>
<span class="line" id="L7299"></span>
<span class="line" id="L7300"><span class="tok-comment">/// Write all pending file contents and metadata modifications to all filesystems.</span></span>
<span class="line" id="L7301"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">sync</span>() <span class="tok-type">void</span> {</span>
<span class="line" id="L7302">    system.sync();</span>
<span class="line" id="L7303">}</span>
<span class="line" id="L7304"></span>
<span class="line" id="L7305"><span class="tok-comment">/// Write all pending file contents and metadata modifications to the filesystem which contains the specified file.</span></span>
<span class="line" id="L7306"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">syncfs</span>(fd: fd_t) SyncError!<span class="tok-type">void</span> {</span>
<span class="line" id="L7307">    <span class="tok-kw">const</span> rc = system.syncfs(fd);</span>
<span class="line" id="L7308">    <span class="tok-kw">switch</span> (errno(rc)) {</span>
<span class="line" id="L7309">        .SUCCESS =&gt; <span class="tok-kw">return</span>,</span>
<span class="line" id="L7310">        .BADF, .INVAL, .ROFS =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L7311">        .IO =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.InputOutput,</span>
<span class="line" id="L7312">        .NOSPC =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.NoSpaceLeft,</span>
<span class="line" id="L7313">        .DQUOT =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.DiskQuota,</span>
<span class="line" id="L7314">        <span class="tok-kw">else</span> =&gt; |err| <span class="tok-kw">return</span> unexpectedErrno(err),</span>
<span class="line" id="L7315">    }</span>
<span class="line" id="L7316">}</span>
<span class="line" id="L7317"></span>
<span class="line" id="L7318"><span class="tok-comment">/// Write all pending file contents and metadata modifications for the specified file descriptor to the underlying filesystem.</span></span>
<span class="line" id="L7319"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">fsync</span>(fd: fd_t) SyncError!<span class="tok-type">void</span> {</span>
<span class="line" id="L7320">    <span class="tok-kw">if</span> (builtin.os.tag == .windows) {</span>
<span class="line" id="L7321">        <span class="tok-kw">if</span> (windows.kernel32.FlushFileBuffers(fd) != <span class="tok-number">0</span>)</span>
<span class="line" id="L7322">            <span class="tok-kw">return</span>;</span>
<span class="line" id="L7323">        <span class="tok-kw">switch</span> (windows.kernel32.GetLastError()) {</span>
<span class="line" id="L7324">            .SUCCESS =&gt; <span class="tok-kw">return</span>,</span>
<span class="line" id="L7325">            .INVALID_HANDLE =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L7326">            .ACCESS_DENIED =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.AccessDenied, <span class="tok-comment">// a sync was performed but the system couldn't update the access time</span>
</span>
<span class="line" id="L7327">            .UNEXP_NET_ERR =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.InputOutput,</span>
<span class="line" id="L7328">            <span class="tok-kw">else</span> =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.InputOutput,</span>
<span class="line" id="L7329">        }</span>
<span class="line" id="L7330">    }</span>
<span class="line" id="L7331">    <span class="tok-kw">const</span> rc = system.fsync(fd);</span>
<span class="line" id="L7332">    <span class="tok-kw">switch</span> (errno(rc)) {</span>
<span class="line" id="L7333">        .SUCCESS =&gt; <span class="tok-kw">return</span>,</span>
<span class="line" id="L7334">        .BADF, .INVAL, .ROFS =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L7335">        .IO =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.InputOutput,</span>
<span class="line" id="L7336">        .NOSPC =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.NoSpaceLeft,</span>
<span class="line" id="L7337">        .DQUOT =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.DiskQuota,</span>
<span class="line" id="L7338">        <span class="tok-kw">else</span> =&gt; |err| <span class="tok-kw">return</span> unexpectedErrno(err),</span>
<span class="line" id="L7339">    }</span>
<span class="line" id="L7340">}</span>
<span class="line" id="L7341"></span>
<span class="line" id="L7342"><span class="tok-comment">/// Write all pending file contents for the specified file descriptor to the underlying filesystem, but not necessarily the metadata.</span></span>
<span class="line" id="L7343"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">fdatasync</span>(fd: fd_t) SyncError!<span class="tok-type">void</span> {</span>
<span class="line" id="L7344">    <span class="tok-kw">if</span> (builtin.os.tag == .windows) {</span>
<span class="line" id="L7345">        <span class="tok-kw">return</span> fsync(fd) <span class="tok-kw">catch</span> |err| <span class="tok-kw">switch</span> (err) {</span>
<span class="line" id="L7346">            SyncError.AccessDenied =&gt; <span class="tok-kw">return</span>, <span class="tok-comment">// fdatasync doesn't promise that the access time was synced</span>
</span>
<span class="line" id="L7347">            <span class="tok-kw">else</span> =&gt; <span class="tok-kw">return</span> err,</span>
<span class="line" id="L7348">        };</span>
<span class="line" id="L7349">    }</span>
<span class="line" id="L7350">    <span class="tok-kw">const</span> rc = system.fdatasync(fd);</span>
<span class="line" id="L7351">    <span class="tok-kw">switch</span> (errno(rc)) {</span>
<span class="line" id="L7352">        .SUCCESS =&gt; <span class="tok-kw">return</span>,</span>
<span class="line" id="L7353">        .BADF, .INVAL, .ROFS =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L7354">        .IO =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.InputOutput,</span>
<span class="line" id="L7355">        .NOSPC =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.NoSpaceLeft,</span>
<span class="line" id="L7356">        .DQUOT =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.DiskQuota,</span>
<span class="line" id="L7357">        <span class="tok-kw">else</span> =&gt; |err| <span class="tok-kw">return</span> unexpectedErrno(err),</span>
<span class="line" id="L7358">    }</span>
<span class="line" id="L7359">}</span>
<span class="line" id="L7360"></span>
<span class="line" id="L7361"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> PrctlError = <span class="tok-kw">error</span>{</span>
<span class="line" id="L7362">    <span class="tok-comment">/// Can only occur with PR_SET_SECCOMP/SECCOMP_MODE_FILTER or</span></span>
<span class="line" id="L7363">    <span class="tok-comment">/// PR_SET_MM/PR_SET_MM_EXE_FILE</span></span>
<span class="line" id="L7364">    AccessDenied,</span>
<span class="line" id="L7365">    <span class="tok-comment">/// Can only occur with PR_SET_MM/PR_SET_MM_EXE_FILE</span></span>
<span class="line" id="L7366">    InvalidFileDescriptor,</span>
<span class="line" id="L7367">    InvalidAddress,</span>
<span class="line" id="L7368">    <span class="tok-comment">/// Can only occur with PR_SET_SPECULATION_CTRL, PR_MPX_ENABLE_MANAGEMENT,</span></span>
<span class="line" id="L7369">    <span class="tok-comment">/// or PR_MPX_DISABLE_MANAGEMENT</span></span>
<span class="line" id="L7370">    UnsupportedFeature,</span>
<span class="line" id="L7371">    <span class="tok-comment">/// Can only occur with PR_SET_FP_MODE</span></span>
<span class="line" id="L7372">    OperationNotSupported,</span>
<span class="line" id="L7373">    PermissionDenied,</span>
<span class="line" id="L7374">} || UnexpectedError;</span>
<span class="line" id="L7375"></span>
<span class="line" id="L7376"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">prctl</span>(option: PR, args: <span class="tok-kw">anytype</span>) PrctlError!<span class="tok-type">u31</span> {</span>
<span class="line" id="L7377">    <span class="tok-kw">if</span> (<span class="tok-builtin">@typeInfo</span>(<span class="tok-builtin">@TypeOf</span>(args)) != .Struct)</span>
<span class="line" id="L7378">        <span class="tok-builtin">@compileError</span>(<span class="tok-str">&quot;Expected tuple or struct argument, found &quot;</span> ++ <span class="tok-builtin">@typeName</span>(<span class="tok-builtin">@TypeOf</span>(args)));</span>
<span class="line" id="L7379">    <span class="tok-kw">if</span> (args.len &gt; <span class="tok-number">4</span>)</span>
<span class="line" id="L7380">        <span class="tok-builtin">@compileError</span>(<span class="tok-str">&quot;prctl takes a maximum of 4 optional arguments&quot;</span>);</span>
<span class="line" id="L7381"></span>
<span class="line" id="L7382">    <span class="tok-kw">var</span> buf: [<span class="tok-number">4</span>]<span class="tok-type">usize</span> = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L7383">    {</span>
<span class="line" id="L7384">        <span class="tok-kw">comptime</span> <span class="tok-kw">var</span> i = <span class="tok-number">0</span>;</span>
<span class="line" id="L7385">        <span class="tok-kw">inline</span> <span class="tok-kw">while</span> (i &lt; args.len) : (i += <span class="tok-number">1</span>) buf[i] = args[i];</span>
<span class="line" id="L7386">    }</span>
<span class="line" id="L7387"></span>
<span class="line" id="L7388">    <span class="tok-kw">const</span> rc = system.prctl(<span class="tok-builtin">@intFromEnum</span>(option), buf[<span class="tok-number">0</span>], buf[<span class="tok-number">1</span>], buf[<span class="tok-number">2</span>], buf[<span class="tok-number">3</span>]);</span>
<span class="line" id="L7389">    <span class="tok-kw">switch</span> (errno(rc)) {</span>
<span class="line" id="L7390">        .SUCCESS =&gt; <span class="tok-kw">return</span> <span class="tok-builtin">@intCast</span>(rc),</span>
<span class="line" id="L7391">        .ACCES =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.AccessDenied,</span>
<span class="line" id="L7392">        .BADF =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.InvalidFileDescriptor,</span>
<span class="line" id="L7393">        .FAULT =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.InvalidAddress,</span>
<span class="line" id="L7394">        .INVAL =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L7395">        .NODEV, .NXIO =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.UnsupportedFeature,</span>
<span class="line" id="L7396">        .OPNOTSUPP =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.OperationNotSupported,</span>
<span class="line" id="L7397">        .PERM, .BUSY =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.PermissionDenied,</span>
<span class="line" id="L7398">        .RANGE =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L7399">        <span class="tok-kw">else</span> =&gt; |err| <span class="tok-kw">return</span> unexpectedErrno(err),</span>
<span class="line" id="L7400">    }</span>
<span class="line" id="L7401">}</span>
<span class="line" id="L7402"></span>
<span class="line" id="L7403"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> GetrlimitError = UnexpectedError;</span>
<span class="line" id="L7404"></span>
<span class="line" id="L7405"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">getrlimit</span>(resource: rlimit_resource) GetrlimitError!rlimit {</span>
<span class="line" id="L7406">    <span class="tok-kw">const</span> getrlimit_sym = <span class="tok-kw">if</span> (lfs64_abi) system.getrlimit64 <span class="tok-kw">else</span> system.getrlimit;</span>
<span class="line" id="L7407"></span>
<span class="line" id="L7408">    <span class="tok-kw">var</span> limits: rlimit = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L7409">    <span class="tok-kw">switch</span> (errno(getrlimit_sym(resource, &amp;limits))) {</span>
<span class="line" id="L7410">        .SUCCESS =&gt; <span class="tok-kw">return</span> limits,</span>
<span class="line" id="L7411">        .FAULT =&gt; <span class="tok-kw">unreachable</span>, <span class="tok-comment">// bogus pointer</span>
</span>
<span class="line" id="L7412">        .INVAL =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L7413">        <span class="tok-kw">else</span> =&gt; |err| <span class="tok-kw">return</span> unexpectedErrno(err),</span>
<span class="line" id="L7414">    }</span>
<span class="line" id="L7415">}</span>
<span class="line" id="L7416"></span>
<span class="line" id="L7417"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> SetrlimitError = <span class="tok-kw">error</span>{ PermissionDenied, LimitTooBig } || UnexpectedError;</span>
<span class="line" id="L7418"></span>
<span class="line" id="L7419"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">setrlimit</span>(resource: rlimit_resource, limits: rlimit) SetrlimitError!<span class="tok-type">void</span> {</span>
<span class="line" id="L7420">    <span class="tok-kw">const</span> setrlimit_sym = <span class="tok-kw">if</span> (lfs64_abi) system.setrlimit64 <span class="tok-kw">else</span> system.setrlimit;</span>
<span class="line" id="L7421"></span>
<span class="line" id="L7422">    <span class="tok-kw">switch</span> (errno(setrlimit_sym(resource, &amp;limits))) {</span>
<span class="line" id="L7423">        .SUCCESS =&gt; <span class="tok-kw">return</span>,</span>
<span class="line" id="L7424">        .FAULT =&gt; <span class="tok-kw">unreachable</span>, <span class="tok-comment">// bogus pointer</span>
</span>
<span class="line" id="L7425">        .INVAL =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.LimitTooBig, <span class="tok-comment">// this could also mean &quot;invalid resource&quot;, but that would be unreachable</span>
</span>
<span class="line" id="L7426">        .PERM =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.PermissionDenied,</span>
<span class="line" id="L7427">        <span class="tok-kw">else</span> =&gt; |err| <span class="tok-kw">return</span> unexpectedErrno(err),</span>
<span class="line" id="L7428">    }</span>
<span class="line" id="L7429">}</span>
<span class="line" id="L7430"></span>
<span class="line" id="L7431"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> MincoreError = <span class="tok-kw">error</span>{</span>
<span class="line" id="L7432">    <span class="tok-comment">/// A kernel resource was temporarily unavailable.</span></span>
<span class="line" id="L7433">    SystemResources,</span>
<span class="line" id="L7434">    <span class="tok-comment">/// vec points to an invalid address.</span></span>
<span class="line" id="L7435">    InvalidAddress,</span>
<span class="line" id="L7436">    <span class="tok-comment">/// addr is not page-aligned.</span></span>
<span class="line" id="L7437">    InvalidSyscall,</span>
<span class="line" id="L7438">    <span class="tok-comment">/// One of the following:</span></span>
<span class="line" id="L7439">    <span class="tok-comment">/// * length is greater than user space TASK_SIZE - addr</span></span>
<span class="line" id="L7440">    <span class="tok-comment">/// * addr + length contains unmapped memory</span></span>
<span class="line" id="L7441">    OutOfMemory,</span>
<span class="line" id="L7442">    <span class="tok-comment">/// The mincore syscall is not available on this version and configuration</span></span>
<span class="line" id="L7443">    <span class="tok-comment">/// of this UNIX-like kernel.</span></span>
<span class="line" id="L7444">    MincoreUnavailable,</span>
<span class="line" id="L7445">} || UnexpectedError;</span>
<span class="line" id="L7446"></span>
<span class="line" id="L7447"><span class="tok-comment">/// Determine whether pages are resident in memory.</span></span>
<span class="line" id="L7448"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">mincore</span>(ptr: [*]<span class="tok-kw">align</span>(mem.page_size) <span class="tok-type">u8</span>, length: <span class="tok-type">usize</span>, vec: [*]<span class="tok-type">u8</span>) MincoreError!<span class="tok-type">void</span> {</span>
<span class="line" id="L7449">    <span class="tok-kw">return</span> <span class="tok-kw">switch</span> (errno(system.mincore(ptr, length, vec))) {</span>
<span class="line" id="L7450">        .SUCCESS =&gt; {},</span>
<span class="line" id="L7451">        .AGAIN =&gt; <span class="tok-kw">error</span>.SystemResources,</span>
<span class="line" id="L7452">        .FAULT =&gt; <span class="tok-kw">error</span>.InvalidAddress,</span>
<span class="line" id="L7453">        .INVAL =&gt; <span class="tok-kw">error</span>.InvalidSyscall,</span>
<span class="line" id="L7454">        .NOMEM =&gt; <span class="tok-kw">error</span>.OutOfMemory,</span>
<span class="line" id="L7455">        .NOSYS =&gt; <span class="tok-kw">error</span>.MincoreUnavailable,</span>
<span class="line" id="L7456">        <span class="tok-kw">else</span> =&gt; |err| unexpectedErrno(err),</span>
<span class="line" id="L7457">    };</span>
<span class="line" id="L7458">}</span>
<span class="line" id="L7459"></span>
<span class="line" id="L7460"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> MadviseError = <span class="tok-kw">error</span>{</span>
<span class="line" id="L7461">    <span class="tok-comment">/// advice is MADV.REMOVE, but the specified address range is not a shared writable mapping.</span></span>
<span class="line" id="L7462">    AccessDenied,</span>
<span class="line" id="L7463">    <span class="tok-comment">/// advice is MADV.HWPOISON, but the caller does not have the CAP_SYS_ADMIN capability.</span></span>
<span class="line" id="L7464">    PermissionDenied,</span>
<span class="line" id="L7465">    <span class="tok-comment">/// A kernel resource was temporarily unavailable.</span></span>
<span class="line" id="L7466">    SystemResources,</span>
<span class="line" id="L7467">    <span class="tok-comment">/// One of the following:</span></span>
<span class="line" id="L7468">    <span class="tok-comment">/// * addr is not page-aligned or length is negative</span></span>
<span class="line" id="L7469">    <span class="tok-comment">/// * advice is not valid</span></span>
<span class="line" id="L7470">    <span class="tok-comment">/// * advice is MADV.DONTNEED or MADV.REMOVE and the specified address range</span></span>
<span class="line" id="L7471">    <span class="tok-comment">///   includes locked, Huge TLB pages, or VM_PFNMAP pages.</span></span>
<span class="line" id="L7472">    <span class="tok-comment">/// * advice is MADV.MERGEABLE or MADV.UNMERGEABLE, but the kernel was not</span></span>
<span class="line" id="L7473">    <span class="tok-comment">///   configured with CONFIG_KSM.</span></span>
<span class="line" id="L7474">    <span class="tok-comment">/// * advice is MADV.FREE or MADV.WIPEONFORK but the specified address range</span></span>
<span class="line" id="L7475">    <span class="tok-comment">///   includes file, Huge TLB, MAP.SHARED, or VM_PFNMAP ranges.</span></span>
<span class="line" id="L7476">    InvalidSyscall,</span>
<span class="line" id="L7477">    <span class="tok-comment">/// (for MADV.WILLNEED) Paging in this area would exceed the process's</span></span>
<span class="line" id="L7478">    <span class="tok-comment">/// maximum resident set size.</span></span>
<span class="line" id="L7479">    WouldExceedMaximumResidentSetSize,</span>
<span class="line" id="L7480">    <span class="tok-comment">/// One of the following:</span></span>
<span class="line" id="L7481">    <span class="tok-comment">/// * (for MADV.WILLNEED) Not enough memory: paging in failed.</span></span>
<span class="line" id="L7482">    <span class="tok-comment">/// * Addresses in the specified range are not currently mapped, or</span></span>
<span class="line" id="L7483">    <span class="tok-comment">///   are outside the address space of the process.</span></span>
<span class="line" id="L7484">    OutOfMemory,</span>
<span class="line" id="L7485">    <span class="tok-comment">/// The madvise syscall is not available on this version and configuration</span></span>
<span class="line" id="L7486">    <span class="tok-comment">/// of the Linux kernel.</span></span>
<span class="line" id="L7487">    MadviseUnavailable,</span>
<span class="line" id="L7488">    <span class="tok-comment">/// The operating system returned an undocumented error code.</span></span>
<span class="line" id="L7489">    Unexpected,</span>
<span class="line" id="L7490">};</span>
<span class="line" id="L7491"></span>
<span class="line" id="L7492"><span class="tok-comment">/// Give advice about use of memory.</span></span>
<span class="line" id="L7493"><span class="tok-comment">/// This syscall is optional and is sometimes configured to be disabled.</span></span>
<span class="line" id="L7494"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">madvise</span>(ptr: [*]<span class="tok-kw">align</span>(mem.page_size) <span class="tok-type">u8</span>, length: <span class="tok-type">usize</span>, advice: <span class="tok-type">u32</span>) MadviseError!<span class="tok-type">void</span> {</span>
<span class="line" id="L7495">    <span class="tok-kw">switch</span> (errno(system.madvise(ptr, length, advice))) {</span>
<span class="line" id="L7496">        .SUCCESS =&gt; <span class="tok-kw">return</span>,</span>
<span class="line" id="L7497">        .ACCES =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.AccessDenied,</span>
<span class="line" id="L7498">        .AGAIN =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.SystemResources,</span>
<span class="line" id="L7499">        .BADF =&gt; <span class="tok-kw">unreachable</span>, <span class="tok-comment">// The map exists, but the area maps something that isn't a file.</span>
</span>
<span class="line" id="L7500">        .INVAL =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.InvalidSyscall,</span>
<span class="line" id="L7501">        .IO =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.WouldExceedMaximumResidentSetSize,</span>
<span class="line" id="L7502">        .NOMEM =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.OutOfMemory,</span>
<span class="line" id="L7503">        .NOSYS =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.MadviseUnavailable,</span>
<span class="line" id="L7504">        <span class="tok-kw">else</span> =&gt; |err| <span class="tok-kw">return</span> unexpectedErrno(err),</span>
<span class="line" id="L7505">    }</span>
<span class="line" id="L7506">}</span>
<span class="line" id="L7507"></span>
<span class="line" id="L7508"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> PerfEventOpenError = <span class="tok-kw">error</span>{</span>
<span class="line" id="L7509">    <span class="tok-comment">/// Returned if the perf_event_attr size value is too small (smaller</span></span>
<span class="line" id="L7510">    <span class="tok-comment">/// than PERF_ATTR_SIZE_VER0), too big (larger than the page  size),</span></span>
<span class="line" id="L7511">    <span class="tok-comment">/// or  larger  than the kernel supports and the extra bytes are not</span></span>
<span class="line" id="L7512">    <span class="tok-comment">/// zero.  When E2BIG is returned, the perf_event_attr size field is</span></span>
<span class="line" id="L7513">    <span class="tok-comment">/// overwritten by the kernel to be the size of the structure it was</span></span>
<span class="line" id="L7514">    <span class="tok-comment">/// expecting.</span></span>
<span class="line" id="L7515">    TooBig,</span>
<span class="line" id="L7516">    <span class="tok-comment">/// Returned when the requested event requires CAP_SYS_ADMIN permis‐</span></span>
<span class="line" id="L7517">    <span class="tok-comment">/// sions  (or a more permissive perf_event paranoid setting).  Some</span></span>
<span class="line" id="L7518">    <span class="tok-comment">/// common cases where an unprivileged process  may  encounter  this</span></span>
<span class="line" id="L7519">    <span class="tok-comment">/// error:  attaching  to a process owned by a different user; moni‐</span></span>
<span class="line" id="L7520">    <span class="tok-comment">/// toring all processes on a given CPU (i.e.,  specifying  the  pid</span></span>
<span class="line" id="L7521">    <span class="tok-comment">/// argument  as  -1); and not setting exclude_kernel when the para‐</span></span>
<span class="line" id="L7522">    <span class="tok-comment">/// noid setting requires it.</span></span>
<span class="line" id="L7523">    <span class="tok-comment">/// Also:</span></span>
<span class="line" id="L7524">    <span class="tok-comment">/// Returned on many (but not all) architectures when an unsupported</span></span>
<span class="line" id="L7525">    <span class="tok-comment">/// exclude_hv,  exclude_idle,  exclude_user, or exclude_kernel set‐</span></span>
<span class="line" id="L7526">    <span class="tok-comment">/// ting is specified.</span></span>
<span class="line" id="L7527">    <span class="tok-comment">/// It can also happen, as with EACCES, when the requested event re‐</span></span>
<span class="line" id="L7528">    <span class="tok-comment">/// quires   CAP_SYS_ADMIN   permissions   (or   a  more  permissive</span></span>
<span class="line" id="L7529">    <span class="tok-comment">/// perf_event paranoid setting).  This includes  setting  a  break‐</span></span>
<span class="line" id="L7530">    <span class="tok-comment">/// point on a kernel address, and (since Linux 3.13) setting a ker‐</span></span>
<span class="line" id="L7531">    <span class="tok-comment">/// nel function-trace tracepoint.</span></span>
<span class="line" id="L7532">    PermissionDenied,</span>
<span class="line" id="L7533">    <span class="tok-comment">/// Returned if another event already has exclusive  access  to  the</span></span>
<span class="line" id="L7534">    <span class="tok-comment">/// PMU.</span></span>
<span class="line" id="L7535">    DeviceBusy,</span>
<span class="line" id="L7536">    <span class="tok-comment">/// Each  opened  event uses one file descriptor.  If a large number</span></span>
<span class="line" id="L7537">    <span class="tok-comment">/// of events are opened, the per-process limit  on  the  number  of</span></span>
<span class="line" id="L7538">    <span class="tok-comment">/// open file descriptors will be reached, and no more events can be</span></span>
<span class="line" id="L7539">    <span class="tok-comment">/// created.</span></span>
<span class="line" id="L7540">    ProcessResources,</span>
<span class="line" id="L7541">    EventRequiresUnsupportedCpuFeature,</span>
<span class="line" id="L7542">    <span class="tok-comment">/// Returned if  you  try  to  add  more  breakpoint</span></span>
<span class="line" id="L7543">    <span class="tok-comment">/// events than supported by the hardware.</span></span>
<span class="line" id="L7544">    TooManyBreakpoints,</span>
<span class="line" id="L7545">    <span class="tok-comment">/// Returned  if PERF_SAMPLE_STACK_USER is set in sample_type and it</span></span>
<span class="line" id="L7546">    <span class="tok-comment">/// is not supported by hardware.</span></span>
<span class="line" id="L7547">    SampleStackNotSupported,</span>
<span class="line" id="L7548">    <span class="tok-comment">/// Returned if an event requiring a specific  hardware  feature  is</span></span>
<span class="line" id="L7549">    <span class="tok-comment">/// requested  but  there is no hardware support.  This includes re‐</span></span>
<span class="line" id="L7550">    <span class="tok-comment">/// questing low-skid events if not supported, branch tracing if  it</span></span>
<span class="line" id="L7551">    <span class="tok-comment">/// is not available, sampling if no PMU interrupt is available, and</span></span>
<span class="line" id="L7552">    <span class="tok-comment">/// branch stacks for software events.</span></span>
<span class="line" id="L7553">    EventNotSupported,</span>
<span class="line" id="L7554">    <span class="tok-comment">/// Returned  if  PERF_SAMPLE_CALLCHAIN  is   requested   and   sam‐</span></span>
<span class="line" id="L7555">    <span class="tok-comment">/// ple_max_stack   is   larger   than   the  maximum  specified  in</span></span>
<span class="line" id="L7556">    <span class="tok-comment">/// /proc/sys/kernel/perf_event_max_stack.</span></span>
<span class="line" id="L7557">    SampleMaxStackOverflow,</span>
<span class="line" id="L7558">    <span class="tok-comment">/// Returned if attempting to attach to a process that does not  exist.</span></span>
<span class="line" id="L7559">    ProcessNotFound,</span>
<span class="line" id="L7560">} || UnexpectedError;</span>
<span class="line" id="L7561"></span>
<span class="line" id="L7562"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">perf_event_open</span>(</span>
<span class="line" id="L7563">    attr: *linux.perf_event_attr,</span>
<span class="line" id="L7564">    pid: pid_t,</span>
<span class="line" id="L7565">    cpu: <span class="tok-type">i32</span>,</span>
<span class="line" id="L7566">    group_fd: fd_t,</span>
<span class="line" id="L7567">    flags: <span class="tok-type">usize</span>,</span>
<span class="line" id="L7568">) PerfEventOpenError!fd_t {</span>
<span class="line" id="L7569">    <span class="tok-kw">const</span> rc = linux.perf_event_open(attr, pid, cpu, group_fd, flags);</span>
<span class="line" id="L7570">    <span class="tok-kw">switch</span> (errno(rc)) {</span>
<span class="line" id="L7571">        .SUCCESS =&gt; <span class="tok-kw">return</span> <span class="tok-builtin">@intCast</span>(rc),</span>
<span class="line" id="L7572">        .@&quot;2BIG&quot; =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.TooBig,</span>
<span class="line" id="L7573">        .ACCES =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.PermissionDenied,</span>
<span class="line" id="L7574">        .BADF =&gt; <span class="tok-kw">unreachable</span>, <span class="tok-comment">// group_fd file descriptor is not valid.</span>
</span>
<span class="line" id="L7575">        .BUSY =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.DeviceBusy,</span>
<span class="line" id="L7576">        .FAULT =&gt; <span class="tok-kw">unreachable</span>, <span class="tok-comment">// Segmentation fault.</span>
</span>
<span class="line" id="L7577">        .INVAL =&gt; <span class="tok-kw">unreachable</span>, <span class="tok-comment">// Bad attr settings.</span>
</span>
<span class="line" id="L7578">        .INTR =&gt; <span class="tok-kw">unreachable</span>, <span class="tok-comment">// Mixed perf and ftrace handling for a uprobe.</span>
</span>
<span class="line" id="L7579">        .MFILE =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.ProcessResources,</span>
<span class="line" id="L7580">        .NODEV =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.EventRequiresUnsupportedCpuFeature,</span>
<span class="line" id="L7581">        .NOENT =&gt; <span class="tok-kw">unreachable</span>, <span class="tok-comment">// Invalid type setting.</span>
</span>
<span class="line" id="L7582">        .NOSPC =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.TooManyBreakpoints,</span>
<span class="line" id="L7583">        .NOSYS =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.SampleStackNotSupported,</span>
<span class="line" id="L7584">        .OPNOTSUPP =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.EventNotSupported,</span>
<span class="line" id="L7585">        .OVERFLOW =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.SampleMaxStackOverflow,</span>
<span class="line" id="L7586">        .PERM =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.PermissionDenied,</span>
<span class="line" id="L7587">        .SRCH =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.ProcessNotFound,</span>
<span class="line" id="L7588">        <span class="tok-kw">else</span> =&gt; |err| <span class="tok-kw">return</span> unexpectedErrno(err),</span>
<span class="line" id="L7589">    }</span>
<span class="line" id="L7590">}</span>
<span class="line" id="L7591"></span>
<span class="line" id="L7592"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> TimerFdCreateError = <span class="tok-kw">error</span>{</span>
<span class="line" id="L7593">    AccessDenied,</span>
<span class="line" id="L7594">    ProcessFdQuotaExceeded,</span>
<span class="line" id="L7595">    SystemFdQuotaExceeded,</span>
<span class="line" id="L7596">    NoDevice,</span>
<span class="line" id="L7597">    SystemResources,</span>
<span class="line" id="L7598">} || UnexpectedError;</span>
<span class="line" id="L7599"></span>
<span class="line" id="L7600"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> TimerFdGetError = <span class="tok-kw">error</span>{InvalidHandle} || UnexpectedError;</span>
<span class="line" id="L7601"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> TimerFdSetError = TimerFdGetError || <span class="tok-kw">error</span>{Canceled};</span>
<span class="line" id="L7602"></span>
<span class="line" id="L7603"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">timerfd_create</span>(clokid: <span class="tok-type">i32</span>, flags: linux.TFD) TimerFdCreateError!fd_t {</span>
<span class="line" id="L7604">    <span class="tok-kw">const</span> rc = linux.timerfd_create(clokid, flags);</span>
<span class="line" id="L7605">    <span class="tok-kw">return</span> <span class="tok-kw">switch</span> (errno(rc)) {</span>
<span class="line" id="L7606">        .SUCCESS =&gt; <span class="tok-builtin">@intCast</span>(rc),</span>
<span class="line" id="L7607">        .INVAL =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L7608">        .MFILE =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.ProcessFdQuotaExceeded,</span>
<span class="line" id="L7609">        .NFILE =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.SystemFdQuotaExceeded,</span>
<span class="line" id="L7610">        .NODEV =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.NoDevice,</span>
<span class="line" id="L7611">        .NOMEM =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.SystemResources,</span>
<span class="line" id="L7612">        .PERM =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.AccessDenied,</span>
<span class="line" id="L7613">        <span class="tok-kw">else</span> =&gt; |err| <span class="tok-kw">return</span> unexpectedErrno(err),</span>
<span class="line" id="L7614">    };</span>
<span class="line" id="L7615">}</span>
<span class="line" id="L7616"></span>
<span class="line" id="L7617"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">timerfd_settime</span>(</span>
<span class="line" id="L7618">    fd: <span class="tok-type">i32</span>,</span>
<span class="line" id="L7619">    flags: linux.TFD.TIMER,</span>
<span class="line" id="L7620">    new_value: *<span class="tok-kw">const</span> linux.itimerspec,</span>
<span class="line" id="L7621">    old_value: ?*linux.itimerspec,</span>
<span class="line" id="L7622">) TimerFdSetError!<span class="tok-type">void</span> {</span>
<span class="line" id="L7623">    <span class="tok-kw">const</span> rc = linux.timerfd_settime(fd, flags, new_value, old_value);</span>
<span class="line" id="L7624">    <span class="tok-kw">return</span> <span class="tok-kw">switch</span> (errno(rc)) {</span>
<span class="line" id="L7625">        .SUCCESS =&gt; {},</span>
<span class="line" id="L7626">        .BADF =&gt; <span class="tok-kw">error</span>.InvalidHandle,</span>
<span class="line" id="L7627">        .FAULT =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L7628">        .INVAL =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L7629">        .CANCELED =&gt; <span class="tok-kw">error</span>.Canceled,</span>
<span class="line" id="L7630">        <span class="tok-kw">else</span> =&gt; |err| <span class="tok-kw">return</span> unexpectedErrno(err),</span>
<span class="line" id="L7631">    };</span>
<span class="line" id="L7632">}</span>
<span class="line" id="L7633"></span>
<span class="line" id="L7634"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">timerfd_gettime</span>(fd: <span class="tok-type">i32</span>) TimerFdGetError!linux.itimerspec {</span>
<span class="line" id="L7635">    <span class="tok-kw">var</span> curr_value: linux.itimerspec = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L7636">    <span class="tok-kw">const</span> rc = linux.timerfd_gettime(fd, &amp;curr_value);</span>
<span class="line" id="L7637">    <span class="tok-kw">return</span> <span class="tok-kw">switch</span> (errno(rc)) {</span>
<span class="line" id="L7638">        .SUCCESS =&gt; <span class="tok-kw">return</span> curr_value,</span>
<span class="line" id="L7639">        .BADF =&gt; <span class="tok-kw">error</span>.InvalidHandle,</span>
<span class="line" id="L7640">        .FAULT =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L7641">        .INVAL =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L7642">        <span class="tok-kw">else</span> =&gt; |err| <span class="tok-kw">return</span> unexpectedErrno(err),</span>
<span class="line" id="L7643">    };</span>
<span class="line" id="L7644">}</span>
<span class="line" id="L7645"></span>
<span class="line" id="L7646"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> PtraceError = <span class="tok-kw">error</span>{</span>
<span class="line" id="L7647">    DeviceBusy,</span>
<span class="line" id="L7648">    InputOutput,</span>
<span class="line" id="L7649">    ProcessNotFound,</span>
<span class="line" id="L7650">    PermissionDenied,</span>
<span class="line" id="L7651">} || UnexpectedError;</span>
<span class="line" id="L7652"></span>
<span class="line" id="L7653"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">ptrace</span>(request: <span class="tok-type">u32</span>, pid: pid_t, addr: <span class="tok-type">usize</span>, signal: <span class="tok-type">usize</span>) PtraceError!<span class="tok-type">void</span> {</span>
<span class="line" id="L7654">    <span class="tok-kw">if</span> (builtin.os.tag == .windows <span class="tok-kw">or</span> builtin.os.tag == .wasi)</span>
<span class="line" id="L7655">        <span class="tok-builtin">@compileError</span>(<span class="tok-str">&quot;Unsupported OS&quot;</span>);</span>
<span class="line" id="L7656"></span>
<span class="line" id="L7657">    <span class="tok-kw">return</span> <span class="tok-kw">switch</span> (builtin.os.tag) {</span>
<span class="line" id="L7658">        .linux =&gt; <span class="tok-kw">switch</span> (errno(linux.ptrace(request, pid, addr, signal, <span class="tok-number">0</span>))) {</span>
<span class="line" id="L7659">            .SUCCESS =&gt; {},</span>
<span class="line" id="L7660">            .SRCH =&gt; <span class="tok-kw">error</span>.ProcessNotFound,</span>
<span class="line" id="L7661">            .FAULT =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L7662">            .INVAL =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L7663">            .IO =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.InputOutput,</span>
<span class="line" id="L7664">            .PERM =&gt; <span class="tok-kw">error</span>.PermissionDenied,</span>
<span class="line" id="L7665">            .BUSY =&gt; <span class="tok-kw">error</span>.DeviceBusy,</span>
<span class="line" id="L7666">            <span class="tok-kw">else</span> =&gt; |err| <span class="tok-kw">return</span> unexpectedErrno(err),</span>
<span class="line" id="L7667">        },</span>
<span class="line" id="L7668"></span>
<span class="line" id="L7669">        .macos, .ios, .tvos, .watchos =&gt; <span class="tok-kw">switch</span> (errno(darwin.ptrace(</span>
<span class="line" id="L7670">            <span class="tok-builtin">@intCast</span>(request),</span>
<span class="line" id="L7671">            pid,</span>
<span class="line" id="L7672">            <span class="tok-builtin">@ptrFromInt</span>(addr),</span>
<span class="line" id="L7673">            <span class="tok-builtin">@intCast</span>(signal),</span>
<span class="line" id="L7674">        ))) {</span>
<span class="line" id="L7675">            .SUCCESS =&gt; {},</span>
<span class="line" id="L7676">            .SRCH =&gt; <span class="tok-kw">error</span>.ProcessNotFound,</span>
<span class="line" id="L7677">            .INVAL =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L7678">            .PERM =&gt; <span class="tok-kw">error</span>.PermissionDenied,</span>
<span class="line" id="L7679">            .BUSY =&gt; <span class="tok-kw">error</span>.DeviceBusy,</span>
<span class="line" id="L7680">            <span class="tok-kw">else</span> =&gt; |err| <span class="tok-kw">return</span> unexpectedErrno(err),</span>
<span class="line" id="L7681">        },</span>
<span class="line" id="L7682"></span>
<span class="line" id="L7683">        <span class="tok-kw">else</span> =&gt; <span class="tok-kw">switch</span> (errno(system.ptrace(request, pid, addr, signal))) {</span>
<span class="line" id="L7684">            .SUCCESS =&gt; {},</span>
<span class="line" id="L7685">            .SRCH =&gt; <span class="tok-kw">error</span>.ProcessNotFound,</span>
<span class="line" id="L7686">            .INVAL =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L7687">            .PERM =&gt; <span class="tok-kw">error</span>.PermissionDenied,</span>
<span class="line" id="L7688">            .BUSY =&gt; <span class="tok-kw">error</span>.DeviceBusy,</span>
<span class="line" id="L7689">            <span class="tok-kw">else</span> =&gt; |err| <span class="tok-kw">return</span> unexpectedErrno(err),</span>
<span class="line" id="L7690">        },</span>
<span class="line" id="L7691">    };</span>
<span class="line" id="L7692">}</span>
<span class="line" id="L7693"></span>
<span class="line" id="L7694"><span class="tok-kw">const</span> lfs64_abi = builtin.os.tag == .linux <span class="tok-kw">and</span> builtin.link_libc <span class="tok-kw">and</span> builtin.abi.isGnu();</span>
<span class="line" id="L7695"></span>
</code></pre></body>
</html>