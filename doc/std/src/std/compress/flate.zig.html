<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">    <title>compress/flate.zig - source view</title>
    <link rel="icon" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAgklEQVR4AWMYWuD7EllJIM4G4g4g5oIJ/odhOJ8wToOxSTXgNxDHoeiBMfA4+wGShjyYOCkG/IGqWQziEzYAoUAeiF9D5U+DxEg14DRU7jWIT5IBIOdCxf+A+CQZAAoopEB7QJwBCBwHiip8UYmRdrAlDpIMgApwQZNnNii5Dq0MBgCxxycBnwEd+wAAAABJRU5ErkJggg==">
    <link rel="icon" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxNTMgMTQwIj48ZyBmaWxsPSIjRjdBNDFEIj48Zz48cG9seWdvbiBwb2ludHM9IjQ2LDIyIDI4LDQ0IDE5LDMwIi8+PHBvbHlnb24gcG9pbnRzPSI0NiwyMiAzMywzMyAyOCw0NCAyMiw0NCAyMiw5NSAzMSw5NSAyMCwxMDAgMTIsMTE3IDAsMTE3IDAsMjIiIHNoYXBlLXJlbmRlcmluZz0iY3Jpc3BFZGdlcyIvPjxwb2x5Z29uIHBvaW50cz0iMzEsOTUgMTIsMTE3IDQsMTA2Ii8+PC9nPjxnPjxwb2x5Z29uIHBvaW50cz0iNTYsMjIgNjIsMzYgMzcsNDQiLz48cG9seWdvbiBwb2ludHM9IjU2LDIyIDExMSwyMiAxMTEsNDQgMzcsNDQgNTYsMzIiIHNoYXBlLXJlbmRlcmluZz0iY3Jpc3BFZGdlcyIvPjxwb2x5Z29uIHBvaW50cz0iMTE2LDk1IDk3LDExNyA5MCwxMDQiLz48cG9seWdvbiBwb2ludHM9IjExNiw5NSAxMDAsMTA0IDk3LDExNyA0MiwxMTcgNDIsOTUiIHNoYXBlLXJlbmRlcmluZz0iY3Jpc3BFZGdlcyIvPjxwb2x5Z29uIHBvaW50cz0iMTUwLDAgNTIsMTE3IDMsMTQwIDEwMSwyMiIvPjwvZz48Zz48cG9seWdvbiBwb2ludHM9IjE0MSwyMiAxNDAsNDAgMTIyLDQ1Ii8+PHBvbHlnb24gcG9pbnRzPSIxNTMsMjIgMTUzLDExNyAxMDYsMTE3IDEyMCwxMDUgMTI1LDk1IDEzMSw5NSAxMzEsNDUgMTIyLDQ1IDEzMiwzNiAxNDEsMjIiIHNoYXBlLXJlbmRlcmluZz0iY3Jpc3BFZGdlcyIvPjxwb2x5Z29uIHBvaW50cz0iMTI1LDk1IDEzMCwxMTAgMTA2LDExNyIvPjwvZz48L2c+PC9zdmc+">
    <style>
      body{
        font-family: system-ui, -apple-system, Roboto, "Segoe UI", sans-serif;
        margin: 0;
        line-height: 1.5;
      }

      pre > code {
        display: block;
        overflow: auto;
        line-height: normal;
        margin: 0em;
      }
      .tok-kw {
          color: #333;
          font-weight: bold;
      }
      .tok-str {
          color: #d14;
      }
      .tok-builtin {
          color: #005C7A;
      }
      .tok-comment {
          color: #545454;
          font-style: italic;
      }
      .tok-fn {
          color: #900;
          font-weight: bold;
      }
      .tok-null {
          color: #005C5C;
      }
      .tok-number {
          color: #005C5C;
      }
      .tok-type {
          color: #458;
          font-weight: bold;
      }
      pre {
        counter-reset: line;
      }
      pre .line:before {
        counter-increment: line;
        content: counter(line);
        display: inline-block;
        padding-right: 1em;
        width: 2em;
        text-align: right;
        color: #999;
      }
      
      .line {
        width: 100%;
        display: inline-block;
      }
      .line:target {
        border-top: 1px solid #ccc;
        border-bottom: 1px solid #ccc;
        background: #fafafa;
      }

      @media (prefers-color-scheme: dark) {
        body{
            background:#222;
            color: #ccc;
        }
        pre > code {
            color: #ccc;
            background: #222;
            border: unset;
        }
        .line:target {
            border-top: 1px solid #444;
            border-bottom: 1px solid #444;
            background: #333;
        }
        .tok-kw {
            color: #eee;
        }
        .tok-str {
            color: #2e5;
        }
        .tok-builtin {
            color: #ff894c;
        }
        .tok-comment {
            color: #aa7;
        }
        .tok-fn {
            color: #B1A0F8;
        }
        .tok-null {
            color: #ff8080;
        }
        .tok-number {
            color: #ff8080;
        }
        .tok-type {
            color: #68f;
        }
      }
    </style>
</head>
<body>
<pre><code><span class="line" id="L1"><span class="tok-comment">/// Deflate is a lossless data compression file format that uses a combination</span></span>
<span class="line" id="L2"><span class="tok-comment">/// of LZ77 and Huffman coding.</span></span>
<span class="line" id="L3"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> deflate = <span class="tok-builtin">@import</span>(<span class="tok-str">&quot;flate/deflate.zig&quot;</span>);</span>
<span class="line" id="L4"></span>
<span class="line" id="L5"><span class="tok-comment">/// Inflate is the decoding process that takes a Deflate bitstream for</span></span>
<span class="line" id="L6"><span class="tok-comment">/// decompression and correctly produces the original full-size data or file.</span></span>
<span class="line" id="L7"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> inflate = <span class="tok-builtin">@import</span>(<span class="tok-str">&quot;flate/inflate.zig&quot;</span>);</span>
<span class="line" id="L8"></span>
<span class="line" id="L9"><span class="tok-comment">/// Decompress compressed data from reader and write plain data to the writer.</span></span>
<span class="line" id="L10"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">decompress</span>(reader: <span class="tok-kw">anytype</span>, writer: <span class="tok-kw">anytype</span>) !<span class="tok-type">void</span> {</span>
<span class="line" id="L11">    <span class="tok-kw">try</span> inflate.decompress(.raw, reader, writer);</span>
<span class="line" id="L12">}</span>
<span class="line" id="L13"></span>
<span class="line" id="L14"><span class="tok-comment">/// Decompressor type</span></span>
<span class="line" id="L15"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">Decompressor</span>(<span class="tok-kw">comptime</span> ReaderType: <span class="tok-type">type</span>) <span class="tok-type">type</span> {</span>
<span class="line" id="L16">    <span class="tok-kw">return</span> inflate.Decompressor(.raw, ReaderType);</span>
<span class="line" id="L17">}</span>
<span class="line" id="L18"></span>
<span class="line" id="L19"><span class="tok-comment">/// Create Decompressor which will read compressed data from reader.</span></span>
<span class="line" id="L20"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">decompressor</span>(reader: <span class="tok-kw">anytype</span>) Decompressor(<span class="tok-builtin">@TypeOf</span>(reader)) {</span>
<span class="line" id="L21">    <span class="tok-kw">return</span> inflate.decompressor(.raw, reader);</span>
<span class="line" id="L22">}</span>
<span class="line" id="L23"></span>
<span class="line" id="L24"><span class="tok-comment">/// Compression level, trades between speed and compression size.</span></span>
<span class="line" id="L25"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> Options = deflate.Options;</span>
<span class="line" id="L26"></span>
<span class="line" id="L27"><span class="tok-comment">/// Compress plain data from reader and write compressed data to the writer.</span></span>
<span class="line" id="L28"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">compress</span>(reader: <span class="tok-kw">anytype</span>, writer: <span class="tok-kw">anytype</span>, options: Options) !<span class="tok-type">void</span> {</span>
<span class="line" id="L29">    <span class="tok-kw">try</span> deflate.compress(.raw, reader, writer, options);</span>
<span class="line" id="L30">}</span>
<span class="line" id="L31"></span>
<span class="line" id="L32"><span class="tok-comment">/// Compressor type</span></span>
<span class="line" id="L33"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">Compressor</span>(<span class="tok-kw">comptime</span> WriterType: <span class="tok-type">type</span>) <span class="tok-type">type</span> {</span>
<span class="line" id="L34">    <span class="tok-kw">return</span> deflate.Compressor(.raw, WriterType);</span>
<span class="line" id="L35">}</span>
<span class="line" id="L36"></span>
<span class="line" id="L37"><span class="tok-comment">/// Create Compressor which outputs compressed data to the writer.</span></span>
<span class="line" id="L38"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">compressor</span>(writer: <span class="tok-kw">anytype</span>, options: Options) !Compressor(<span class="tok-builtin">@TypeOf</span>(writer)) {</span>
<span class="line" id="L39">    <span class="tok-kw">return</span> <span class="tok-kw">try</span> deflate.compressor(.raw, writer, options);</span>
<span class="line" id="L40">}</span>
<span class="line" id="L41"></span>
<span class="line" id="L42"><span class="tok-comment">/// Huffman only compression. Without Lempel-Ziv match searching. Faster</span></span>
<span class="line" id="L43"><span class="tok-comment">/// compression, less memory requirements but bigger compressed sizes.</span></span>
<span class="line" id="L44"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> huffman = <span class="tok-kw">struct</span> {</span>
<span class="line" id="L45">    <span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">compress</span>(reader: <span class="tok-kw">anytype</span>, writer: <span class="tok-kw">anytype</span>) !<span class="tok-type">void</span> {</span>
<span class="line" id="L46">        <span class="tok-kw">try</span> deflate.huffman.compress(.raw, reader, writer);</span>
<span class="line" id="L47">    }</span>
<span class="line" id="L48"></span>
<span class="line" id="L49">    <span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">Compressor</span>(<span class="tok-kw">comptime</span> WriterType: <span class="tok-type">type</span>) <span class="tok-type">type</span> {</span>
<span class="line" id="L50">        <span class="tok-kw">return</span> deflate.huffman.Compressor(.raw, WriterType);</span>
<span class="line" id="L51">    }</span>
<span class="line" id="L52"></span>
<span class="line" id="L53">    <span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">compressor</span>(writer: <span class="tok-kw">anytype</span>) !huffman.Compressor(<span class="tok-builtin">@TypeOf</span>(writer)) {</span>
<span class="line" id="L54">        <span class="tok-kw">return</span> deflate.huffman.compressor(.raw, writer);</span>
<span class="line" id="L55">    }</span>
<span class="line" id="L56">};</span>
<span class="line" id="L57"></span>
<span class="line" id="L58"><span class="tok-comment">// No compression store only. Compressed size is slightly bigger than plain.</span>
</span>
<span class="line" id="L59"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> store = <span class="tok-kw">struct</span> {</span>
<span class="line" id="L60">    <span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">compress</span>(reader: <span class="tok-kw">anytype</span>, writer: <span class="tok-kw">anytype</span>) !<span class="tok-type">void</span> {</span>
<span class="line" id="L61">        <span class="tok-kw">try</span> deflate.store.compress(.raw, reader, writer);</span>
<span class="line" id="L62">    }</span>
<span class="line" id="L63"></span>
<span class="line" id="L64">    <span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">Compressor</span>(<span class="tok-kw">comptime</span> WriterType: <span class="tok-type">type</span>) <span class="tok-type">type</span> {</span>
<span class="line" id="L65">        <span class="tok-kw">return</span> deflate.store.Compressor(.raw, WriterType);</span>
<span class="line" id="L66">    }</span>
<span class="line" id="L67"></span>
<span class="line" id="L68">    <span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">compressor</span>(writer: <span class="tok-kw">anytype</span>) !store.Compressor(<span class="tok-builtin">@TypeOf</span>(writer)) {</span>
<span class="line" id="L69">        <span class="tok-kw">return</span> deflate.store.compressor(.raw, writer);</span>
<span class="line" id="L70">    }</span>
<span class="line" id="L71">};</span>
<span class="line" id="L72"></span>
<span class="line" id="L73"><span class="tok-comment">/// Container defines header/footer arround deflate bit stream. Gzip and zlib</span></span>
<span class="line" id="L74"><span class="tok-comment">/// compression algorithms are containers arround deflate bit stream body.</span></span>
<span class="line" id="L75"><span class="tok-kw">const</span> Container = <span class="tok-builtin">@import</span>(<span class="tok-str">&quot;flate/container.zig&quot;</span>).Container;</span>
<span class="line" id="L76"><span class="tok-kw">const</span> std = <span class="tok-builtin">@import</span>(<span class="tok-str">&quot;std&quot;</span>);</span>
<span class="line" id="L77"><span class="tok-kw">const</span> testing = std.testing;</span>
<span class="line" id="L78"><span class="tok-kw">const</span> fixedBufferStream = std.io.fixedBufferStream;</span>
<span class="line" id="L79"><span class="tok-kw">const</span> print = std.debug.print;</span>
<span class="line" id="L80"><span class="tok-kw">const</span> builtin = <span class="tok-builtin">@import</span>(<span class="tok-str">&quot;builtin&quot;</span>);</span>
<span class="line" id="L81"></span>
<span class="line" id="L82"><span class="tok-kw">test</span> {</span>
<span class="line" id="L83">    _ = deflate;</span>
<span class="line" id="L84">    _ = inflate;</span>
<span class="line" id="L85">}</span>
<span class="line" id="L86"></span>
<span class="line" id="L87"><span class="tok-kw">test</span> <span class="tok-str">&quot;compress/decompress&quot;</span> {</span>
<span class="line" id="L88">    <span class="tok-kw">var</span> cmp_buf: [<span class="tok-number">64</span> * <span class="tok-number">1024</span>]<span class="tok-type">u8</span> = <span class="tok-null">undefined</span>; <span class="tok-comment">// compressed data buffer</span>
</span>
<span class="line" id="L89">    <span class="tok-kw">var</span> dcm_buf: [<span class="tok-number">64</span> * <span class="tok-number">1024</span>]<span class="tok-type">u8</span> = <span class="tok-null">undefined</span>; <span class="tok-comment">// decompressed data buffer</span>
</span>
<span class="line" id="L90"></span>
<span class="line" id="L91">    <span class="tok-kw">const</span> levels = [_]deflate.Level{ .level_4, .level_5, .level_6, .level_7, .level_8, .level_9 };</span>
<span class="line" id="L92">    <span class="tok-kw">const</span> cases = [_]<span class="tok-kw">struct</span> {</span>
<span class="line" id="L93">        data: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>, <span class="tok-comment">// uncompressed content</span>
</span>
<span class="line" id="L94">        <span class="tok-comment">// compressed data sizes per level 4-9</span>
</span>
<span class="line" id="L95">        gzip_sizes: [levels.len]<span class="tok-type">usize</span> = [_]<span class="tok-type">usize</span>{<span class="tok-number">0</span>} ** levels.len,</span>
<span class="line" id="L96">        huffman_only_size: <span class="tok-type">usize</span> = <span class="tok-number">0</span>,</span>
<span class="line" id="L97">        store_size: <span class="tok-type">usize</span> = <span class="tok-number">0</span>,</span>
<span class="line" id="L98">    }{</span>
<span class="line" id="L99">        .{</span>
<span class="line" id="L100">            .data = <span class="tok-builtin">@embedFile</span>(<span class="tok-str">&quot;flate/testdata/rfc1951.txt&quot;</span>),</span>
<span class="line" id="L101">            .gzip_sizes = [_]<span class="tok-type">usize</span>{ <span class="tok-number">11513</span>, <span class="tok-number">11217</span>, <span class="tok-number">11139</span>, <span class="tok-number">11126</span>, <span class="tok-number">11122</span>, <span class="tok-number">11119</span> },</span>
<span class="line" id="L102">            .huffman_only_size = <span class="tok-number">20287</span>,</span>
<span class="line" id="L103">            .store_size = <span class="tok-number">36967</span>,</span>
<span class="line" id="L104">        },</span>
<span class="line" id="L105">        .{</span>
<span class="line" id="L106">            .data = <span class="tok-builtin">@embedFile</span>(<span class="tok-str">&quot;flate/testdata/fuzz/roundtrip1.input&quot;</span>),</span>
<span class="line" id="L107">            .gzip_sizes = [_]<span class="tok-type">usize</span>{ <span class="tok-number">373</span>, <span class="tok-number">370</span>, <span class="tok-number">370</span>, <span class="tok-number">370</span>, <span class="tok-number">370</span>, <span class="tok-number">370</span> },</span>
<span class="line" id="L108">            .huffman_only_size = <span class="tok-number">393</span>,</span>
<span class="line" id="L109">            .store_size = <span class="tok-number">393</span>,</span>
<span class="line" id="L110">        },</span>
<span class="line" id="L111">        .{</span>
<span class="line" id="L112">            .data = <span class="tok-builtin">@embedFile</span>(<span class="tok-str">&quot;flate/testdata/fuzz/roundtrip2.input&quot;</span>),</span>
<span class="line" id="L113">            .gzip_sizes = [_]<span class="tok-type">usize</span>{ <span class="tok-number">373</span>, <span class="tok-number">373</span>, <span class="tok-number">373</span>, <span class="tok-number">373</span>, <span class="tok-number">373</span>, <span class="tok-number">373</span> },</span>
<span class="line" id="L114">            .huffman_only_size = <span class="tok-number">394</span>,</span>
<span class="line" id="L115">            .store_size = <span class="tok-number">394</span>,</span>
<span class="line" id="L116">        },</span>
<span class="line" id="L117">        .{</span>
<span class="line" id="L118">            .data = <span class="tok-builtin">@embedFile</span>(<span class="tok-str">&quot;flate/testdata/fuzz/deflate-stream.expect&quot;</span>),</span>
<span class="line" id="L119">            .gzip_sizes = [_]<span class="tok-type">usize</span>{ <span class="tok-number">351</span>, <span class="tok-number">347</span>, <span class="tok-number">347</span>, <span class="tok-number">347</span>, <span class="tok-number">347</span>, <span class="tok-number">347</span> },</span>
<span class="line" id="L120">            .huffman_only_size = <span class="tok-number">498</span>,</span>
<span class="line" id="L121">            .store_size = <span class="tok-number">747</span>,</span>
<span class="line" id="L122">        },</span>
<span class="line" id="L123">    };</span>
<span class="line" id="L124"></span>
<span class="line" id="L125">    <span class="tok-kw">for</span> (cases, <span class="tok-number">0</span>..) |case, case_no| { <span class="tok-comment">// for each case</span>
</span>
<span class="line" id="L126">        <span class="tok-kw">const</span> data = case.data;</span>
<span class="line" id="L127"></span>
<span class="line" id="L128">        <span class="tok-kw">for</span> (levels, <span class="tok-number">0</span>..) |level, i| { <span class="tok-comment">// for each compression level</span>
</span>
<span class="line" id="L129"></span>
<span class="line" id="L130">            <span class="tok-kw">inline</span> <span class="tok-kw">for</span> (Container.list) |container| { <span class="tok-comment">// for each wrapping</span>
</span>
<span class="line" id="L131">                <span class="tok-kw">var</span> compressed_size: <span class="tok-type">usize</span> = <span class="tok-kw">if</span> (case.gzip_sizes[i] &gt; <span class="tok-number">0</span>)</span>
<span class="line" id="L132">                    case.gzip_sizes[i] - Container.gzip.size() + container.size()</span>
<span class="line" id="L133">                <span class="tok-kw">else</span></span>
<span class="line" id="L134">                    <span class="tok-number">0</span>;</span>
<span class="line" id="L135"></span>
<span class="line" id="L136">                <span class="tok-comment">// compress original stream to compressed stream</span>
</span>
<span class="line" id="L137">                {</span>
<span class="line" id="L138">                    <span class="tok-kw">var</span> original = fixedBufferStream(data);</span>
<span class="line" id="L139">                    <span class="tok-kw">var</span> compressed = fixedBufferStream(&amp;cmp_buf);</span>
<span class="line" id="L140">                    <span class="tok-kw">try</span> deflate.compress(container, original.reader(), compressed.writer(), .{ .level = level });</span>
<span class="line" id="L141">                    <span class="tok-kw">if</span> (compressed_size == <span class="tok-number">0</span>) {</span>
<span class="line" id="L142">                        <span class="tok-kw">if</span> (container == .gzip)</span>
<span class="line" id="L143">                            print(<span class="tok-str">&quot;case {d} gzip level {} compressed size: {d}\n&quot;</span>, .{ case_no, level, compressed.pos });</span>
<span class="line" id="L144">                        compressed_size = compressed.pos;</span>
<span class="line" id="L145">                    }</span>
<span class="line" id="L146">                    <span class="tok-kw">try</span> testing.expectEqual(compressed_size, compressed.pos);</span>
<span class="line" id="L147">                }</span>
<span class="line" id="L148">                <span class="tok-comment">// decompress compressed stream to decompressed stream</span>
</span>
<span class="line" id="L149">                {</span>
<span class="line" id="L150">                    <span class="tok-kw">var</span> compressed = fixedBufferStream(cmp_buf[<span class="tok-number">0</span>..compressed_size]);</span>
<span class="line" id="L151">                    <span class="tok-kw">var</span> decompressed = fixedBufferStream(&amp;dcm_buf);</span>
<span class="line" id="L152">                    <span class="tok-kw">try</span> inflate.decompress(container, compressed.reader(), decompressed.writer());</span>
<span class="line" id="L153">                    <span class="tok-kw">try</span> testing.expectEqualSlices(<span class="tok-type">u8</span>, data, decompressed.getWritten());</span>
<span class="line" id="L154">                }</span>
<span class="line" id="L155"></span>
<span class="line" id="L156">                <span class="tok-comment">// compressor writer interface</span>
</span>
<span class="line" id="L157">                {</span>
<span class="line" id="L158">                    <span class="tok-kw">var</span> compressed = fixedBufferStream(&amp;cmp_buf);</span>
<span class="line" id="L159">                    <span class="tok-kw">var</span> cmp = <span class="tok-kw">try</span> deflate.compressor(container, compressed.writer(), .{ .level = level });</span>
<span class="line" id="L160">                    <span class="tok-kw">var</span> cmp_wrt = cmp.writer();</span>
<span class="line" id="L161">                    <span class="tok-kw">try</span> cmp_wrt.writeAll(data);</span>
<span class="line" id="L162">                    <span class="tok-kw">try</span> cmp.finish();</span>
<span class="line" id="L163"></span>
<span class="line" id="L164">                    <span class="tok-kw">try</span> testing.expectEqual(compressed_size, compressed.pos);</span>
<span class="line" id="L165">                }</span>
<span class="line" id="L166">                <span class="tok-comment">// decompressor reader interface</span>
</span>
<span class="line" id="L167">                {</span>
<span class="line" id="L168">                    <span class="tok-kw">var</span> compressed = fixedBufferStream(cmp_buf[<span class="tok-number">0</span>..compressed_size]);</span>
<span class="line" id="L169">                    <span class="tok-kw">var</span> dcm = inflate.decompressor(container, compressed.reader());</span>
<span class="line" id="L170">                    <span class="tok-kw">var</span> dcm_rdr = dcm.reader();</span>
<span class="line" id="L171">                    <span class="tok-kw">const</span> n = <span class="tok-kw">try</span> dcm_rdr.readAll(&amp;dcm_buf);</span>
<span class="line" id="L172">                    <span class="tok-kw">try</span> testing.expectEqual(data.len, n);</span>
<span class="line" id="L173">                    <span class="tok-kw">try</span> testing.expectEqualSlices(<span class="tok-type">u8</span>, data, dcm_buf[<span class="tok-number">0</span>..n]);</span>
<span class="line" id="L174">                }</span>
<span class="line" id="L175">            }</span>
<span class="line" id="L176">        }</span>
<span class="line" id="L177">        <span class="tok-comment">// huffman only compression</span>
</span>
<span class="line" id="L178">        {</span>
<span class="line" id="L179">            <span class="tok-kw">inline</span> <span class="tok-kw">for</span> (Container.list) |container| { <span class="tok-comment">// for each wrapping</span>
</span>
<span class="line" id="L180">                <span class="tok-kw">var</span> compressed_size: <span class="tok-type">usize</span> = <span class="tok-kw">if</span> (case.huffman_only_size &gt; <span class="tok-number">0</span>)</span>
<span class="line" id="L181">                    case.huffman_only_size - Container.gzip.size() + container.size()</span>
<span class="line" id="L182">                <span class="tok-kw">else</span></span>
<span class="line" id="L183">                    <span class="tok-number">0</span>;</span>
<span class="line" id="L184"></span>
<span class="line" id="L185">                <span class="tok-comment">// compress original stream to compressed stream</span>
</span>
<span class="line" id="L186">                {</span>
<span class="line" id="L187">                    <span class="tok-kw">var</span> original = fixedBufferStream(data);</span>
<span class="line" id="L188">                    <span class="tok-kw">var</span> compressed = fixedBufferStream(&amp;cmp_buf);</span>
<span class="line" id="L189">                    <span class="tok-kw">var</span> cmp = <span class="tok-kw">try</span> deflate.huffman.compressor(container, compressed.writer());</span>
<span class="line" id="L190">                    <span class="tok-kw">try</span> cmp.compress(original.reader());</span>
<span class="line" id="L191">                    <span class="tok-kw">try</span> cmp.finish();</span>
<span class="line" id="L192">                    <span class="tok-kw">if</span> (compressed_size == <span class="tok-number">0</span>) {</span>
<span class="line" id="L193">                        <span class="tok-kw">if</span> (container == .gzip)</span>
<span class="line" id="L194">                            print(<span class="tok-str">&quot;case {d} huffman only compressed size: {d}\n&quot;</span>, .{ case_no, compressed.pos });</span>
<span class="line" id="L195">                        compressed_size = compressed.pos;</span>
<span class="line" id="L196">                    }</span>
<span class="line" id="L197">                    <span class="tok-kw">try</span> testing.expectEqual(compressed_size, compressed.pos);</span>
<span class="line" id="L198">                }</span>
<span class="line" id="L199">                <span class="tok-comment">// decompress compressed stream to decompressed stream</span>
</span>
<span class="line" id="L200">                {</span>
<span class="line" id="L201">                    <span class="tok-kw">var</span> compressed = fixedBufferStream(cmp_buf[<span class="tok-number">0</span>..compressed_size]);</span>
<span class="line" id="L202">                    <span class="tok-kw">var</span> decompressed = fixedBufferStream(&amp;dcm_buf);</span>
<span class="line" id="L203">                    <span class="tok-kw">try</span> inflate.decompress(container, compressed.reader(), decompressed.writer());</span>
<span class="line" id="L204">                    <span class="tok-kw">try</span> testing.expectEqualSlices(<span class="tok-type">u8</span>, data, decompressed.getWritten());</span>
<span class="line" id="L205">                }</span>
<span class="line" id="L206">            }</span>
<span class="line" id="L207">        }</span>
<span class="line" id="L208"></span>
<span class="line" id="L209">        <span class="tok-comment">// store only</span>
</span>
<span class="line" id="L210">        {</span>
<span class="line" id="L211">            <span class="tok-kw">inline</span> <span class="tok-kw">for</span> (Container.list) |container| { <span class="tok-comment">// for each wrapping</span>
</span>
<span class="line" id="L212">                <span class="tok-kw">var</span> compressed_size: <span class="tok-type">usize</span> = <span class="tok-kw">if</span> (case.store_size &gt; <span class="tok-number">0</span>)</span>
<span class="line" id="L213">                    case.store_size - Container.gzip.size() + container.size()</span>
<span class="line" id="L214">                <span class="tok-kw">else</span></span>
<span class="line" id="L215">                    <span class="tok-number">0</span>;</span>
<span class="line" id="L216"></span>
<span class="line" id="L217">                <span class="tok-comment">// compress original stream to compressed stream</span>
</span>
<span class="line" id="L218">                {</span>
<span class="line" id="L219">                    <span class="tok-kw">var</span> original = fixedBufferStream(data);</span>
<span class="line" id="L220">                    <span class="tok-kw">var</span> compressed = fixedBufferStream(&amp;cmp_buf);</span>
<span class="line" id="L221">                    <span class="tok-kw">var</span> cmp = <span class="tok-kw">try</span> deflate.store.compressor(container, compressed.writer());</span>
<span class="line" id="L222">                    <span class="tok-kw">try</span> cmp.compress(original.reader());</span>
<span class="line" id="L223">                    <span class="tok-kw">try</span> cmp.finish();</span>
<span class="line" id="L224">                    <span class="tok-kw">if</span> (compressed_size == <span class="tok-number">0</span>) {</span>
<span class="line" id="L225">                        <span class="tok-kw">if</span> (container == .gzip)</span>
<span class="line" id="L226">                            print(<span class="tok-str">&quot;case {d} store only compressed size: {d}\n&quot;</span>, .{ case_no, compressed.pos });</span>
<span class="line" id="L227">                        compressed_size = compressed.pos;</span>
<span class="line" id="L228">                    }</span>
<span class="line" id="L229"></span>
<span class="line" id="L230">                    <span class="tok-kw">try</span> testing.expectEqual(compressed_size, compressed.pos);</span>
<span class="line" id="L231">                }</span>
<span class="line" id="L232">                <span class="tok-comment">// decompress compressed stream to decompressed stream</span>
</span>
<span class="line" id="L233">                {</span>
<span class="line" id="L234">                    <span class="tok-kw">var</span> compressed = fixedBufferStream(cmp_buf[<span class="tok-number">0</span>..compressed_size]);</span>
<span class="line" id="L235">                    <span class="tok-kw">var</span> decompressed = fixedBufferStream(&amp;dcm_buf);</span>
<span class="line" id="L236">                    <span class="tok-kw">try</span> inflate.decompress(container, compressed.reader(), decompressed.writer());</span>
<span class="line" id="L237">                    <span class="tok-kw">try</span> testing.expectEqualSlices(<span class="tok-type">u8</span>, data, decompressed.getWritten());</span>
<span class="line" id="L238">                }</span>
<span class="line" id="L239">            }</span>
<span class="line" id="L240">        }</span>
<span class="line" id="L241">    }</span>
<span class="line" id="L242">}</span>
<span class="line" id="L243"></span>
<span class="line" id="L244"><span class="tok-kw">fn</span> <span class="tok-fn">testDecompress</span>(<span class="tok-kw">comptime</span> container: Container, compressed: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>, expected_plain: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>) !<span class="tok-type">void</span> {</span>
<span class="line" id="L245">    <span class="tok-kw">var</span> in = fixedBufferStream(compressed);</span>
<span class="line" id="L246">    <span class="tok-kw">var</span> out = std.ArrayList(<span class="tok-type">u8</span>).init(testing.allocator);</span>
<span class="line" id="L247">    <span class="tok-kw">defer</span> out.deinit();</span>
<span class="line" id="L248"></span>
<span class="line" id="L249">    <span class="tok-kw">try</span> inflate.decompress(container, in.reader(), out.writer());</span>
<span class="line" id="L250">    <span class="tok-kw">try</span> testing.expectEqualSlices(<span class="tok-type">u8</span>, expected_plain, out.items);</span>
<span class="line" id="L251">}</span>
<span class="line" id="L252"></span>
<span class="line" id="L253"><span class="tok-kw">test</span> <span class="tok-str">&quot;don't read past deflate stream's end&quot;</span> {</span>
<span class="line" id="L254">    <span class="tok-kw">try</span> testDecompress(.zlib, &amp;[_]<span class="tok-type">u8</span>{</span>
<span class="line" id="L255">        <span class="tok-number">0x08</span>, <span class="tok-number">0xd7</span>, <span class="tok-number">0x63</span>, <span class="tok-number">0xf8</span>, <span class="tok-number">0xcf</span>, <span class="tok-number">0xc0</span>, <span class="tok-number">0xc0</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0xc1</span>, <span class="tok-number">0xff</span>,</span>
<span class="line" id="L256">        <span class="tok-number">0xff</span>, <span class="tok-number">0x43</span>, <span class="tok-number">0x30</span>, <span class="tok-number">0x03</span>, <span class="tok-number">0x03</span>, <span class="tok-number">0xc3</span>, <span class="tok-number">0xff</span>, <span class="tok-number">0xff</span>, <span class="tok-number">0xff</span>, <span class="tok-number">0x01</span>,</span>
<span class="line" id="L257">        <span class="tok-number">0x83</span>, <span class="tok-number">0x95</span>, <span class="tok-number">0x0b</span>, <span class="tok-number">0xf5</span>,</span>
<span class="line" id="L258">    }, &amp;[_]<span class="tok-type">u8</span>{</span>
<span class="line" id="L259">        <span class="tok-number">0x00</span>, <span class="tok-number">0xff</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0xff</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0xff</span>,</span>
<span class="line" id="L260">        <span class="tok-number">0x00</span>, <span class="tok-number">0xff</span>, <span class="tok-number">0xff</span>, <span class="tok-number">0xff</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0xff</span>, <span class="tok-number">0xff</span>, <span class="tok-number">0xff</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>,</span>
<span class="line" id="L261">        <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0xff</span>, <span class="tok-number">0xff</span>, <span class="tok-number">0xff</span>,</span>
<span class="line" id="L262">    });</span>
<span class="line" id="L263">}</span>
<span class="line" id="L264"></span>
<span class="line" id="L265"><span class="tok-kw">test</span> <span class="tok-str">&quot;zlib header&quot;</span> {</span>
<span class="line" id="L266">    <span class="tok-comment">// Truncated header</span>
</span>
<span class="line" id="L267">    <span class="tok-kw">try</span> testing.expectError(</span>
<span class="line" id="L268">        <span class="tok-kw">error</span>.EndOfStream,</span>
<span class="line" id="L269">        testDecompress(.zlib, &amp;[_]<span class="tok-type">u8</span>{<span class="tok-number">0x78</span>}, <span class="tok-str">&quot;&quot;</span>),</span>
<span class="line" id="L270">    );</span>
<span class="line" id="L271">    <span class="tok-comment">// Wrong CM</span>
</span>
<span class="line" id="L272">    <span class="tok-kw">try</span> testing.expectError(</span>
<span class="line" id="L273">        <span class="tok-kw">error</span>.BadZlibHeader,</span>
<span class="line" id="L274">        testDecompress(.zlib, &amp;[_]<span class="tok-type">u8</span>{ <span class="tok-number">0x79</span>, <span class="tok-number">0x94</span> }, <span class="tok-str">&quot;&quot;</span>),</span>
<span class="line" id="L275">    );</span>
<span class="line" id="L276">    <span class="tok-comment">// Wrong CINFO</span>
</span>
<span class="line" id="L277">    <span class="tok-kw">try</span> testing.expectError(</span>
<span class="line" id="L278">        <span class="tok-kw">error</span>.BadZlibHeader,</span>
<span class="line" id="L279">        testDecompress(.zlib, &amp;[_]<span class="tok-type">u8</span>{ <span class="tok-number">0x88</span>, <span class="tok-number">0x98</span> }, <span class="tok-str">&quot;&quot;</span>),</span>
<span class="line" id="L280">    );</span>
<span class="line" id="L281">    <span class="tok-comment">// Wrong checksum</span>
</span>
<span class="line" id="L282">    <span class="tok-kw">try</span> testing.expectError(</span>
<span class="line" id="L283">        <span class="tok-kw">error</span>.WrongZlibChecksum,</span>
<span class="line" id="L284">        testDecompress(.zlib, &amp;[_]<span class="tok-type">u8</span>{ <span class="tok-number">0x78</span>, <span class="tok-number">0xda</span>, <span class="tok-number">0x03</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span> }, <span class="tok-str">&quot;&quot;</span>),</span>
<span class="line" id="L285">    );</span>
<span class="line" id="L286">    <span class="tok-comment">// Truncated checksum</span>
</span>
<span class="line" id="L287">    <span class="tok-kw">try</span> testing.expectError(</span>
<span class="line" id="L288">        <span class="tok-kw">error</span>.EndOfStream,</span>
<span class="line" id="L289">        testDecompress(.zlib, &amp;[_]<span class="tok-type">u8</span>{ <span class="tok-number">0x78</span>, <span class="tok-number">0xda</span>, <span class="tok-number">0x03</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span> }, <span class="tok-str">&quot;&quot;</span>),</span>
<span class="line" id="L290">    );</span>
<span class="line" id="L291">}</span>
<span class="line" id="L292"></span>
<span class="line" id="L293"><span class="tok-kw">test</span> <span class="tok-str">&quot;gzip header&quot;</span> {</span>
<span class="line" id="L294">    <span class="tok-comment">// Truncated header</span>
</span>
<span class="line" id="L295">    <span class="tok-kw">try</span> testing.expectError(</span>
<span class="line" id="L296">        <span class="tok-kw">error</span>.EndOfStream,</span>
<span class="line" id="L297">        testDecompress(.gzip, &amp;[_]<span class="tok-type">u8</span>{ <span class="tok-number">0x1f</span>, <span class="tok-number">0x8B</span> }, <span class="tok-null">undefined</span>),</span>
<span class="line" id="L298">    );</span>
<span class="line" id="L299">    <span class="tok-comment">// Wrong CM</span>
</span>
<span class="line" id="L300">    <span class="tok-kw">try</span> testing.expectError(</span>
<span class="line" id="L301">        <span class="tok-kw">error</span>.BadGzipHeader,</span>
<span class="line" id="L302">        testDecompress(.gzip, &amp;[_]<span class="tok-type">u8</span>{</span>
<span class="line" id="L303">            <span class="tok-number">0x1f</span>, <span class="tok-number">0x8b</span>, <span class="tok-number">0x09</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>,</span>
<span class="line" id="L304">            <span class="tok-number">0x00</span>, <span class="tok-number">0x03</span>,</span>
<span class="line" id="L305">        }, <span class="tok-null">undefined</span>),</span>
<span class="line" id="L306">    );</span>
<span class="line" id="L307"></span>
<span class="line" id="L308">    <span class="tok-comment">// Wrong checksum</span>
</span>
<span class="line" id="L309">    <span class="tok-kw">try</span> testing.expectError(</span>
<span class="line" id="L310">        <span class="tok-kw">error</span>.WrongGzipChecksum,</span>
<span class="line" id="L311">        testDecompress(.gzip, &amp;[_]<span class="tok-type">u8</span>{</span>
<span class="line" id="L312">            <span class="tok-number">0x1f</span>, <span class="tok-number">0x8b</span>, <span class="tok-number">0x08</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>,</span>
<span class="line" id="L313">            <span class="tok-number">0x00</span>, <span class="tok-number">0x03</span>, <span class="tok-number">0x03</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x01</span>,</span>
<span class="line" id="L314">            <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>,</span>
<span class="line" id="L315">        }, <span class="tok-null">undefined</span>),</span>
<span class="line" id="L316">    );</span>
<span class="line" id="L317">    <span class="tok-comment">// Truncated checksum</span>
</span>
<span class="line" id="L318">    <span class="tok-kw">try</span> testing.expectError(</span>
<span class="line" id="L319">        <span class="tok-kw">error</span>.EndOfStream,</span>
<span class="line" id="L320">        testDecompress(.gzip, &amp;[_]<span class="tok-type">u8</span>{</span>
<span class="line" id="L321">            <span class="tok-number">0x1f</span>, <span class="tok-number">0x8b</span>, <span class="tok-number">0x08</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>,</span>
<span class="line" id="L322">            <span class="tok-number">0x00</span>, <span class="tok-number">0x03</span>, <span class="tok-number">0x03</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>,</span>
<span class="line" id="L323">        }, <span class="tok-null">undefined</span>),</span>
<span class="line" id="L324">    );</span>
<span class="line" id="L325">    <span class="tok-comment">// Wrong initial size</span>
</span>
<span class="line" id="L326">    <span class="tok-kw">try</span> testing.expectError(</span>
<span class="line" id="L327">        <span class="tok-kw">error</span>.WrongGzipSize,</span>
<span class="line" id="L328">        testDecompress(.gzip, &amp;[_]<span class="tok-type">u8</span>{</span>
<span class="line" id="L329">            <span class="tok-number">0x1f</span>, <span class="tok-number">0x8b</span>, <span class="tok-number">0x08</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>,</span>
<span class="line" id="L330">            <span class="tok-number">0x00</span>, <span class="tok-number">0x03</span>, <span class="tok-number">0x03</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>,</span>
<span class="line" id="L331">            <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x01</span>,</span>
<span class="line" id="L332">        }, <span class="tok-null">undefined</span>),</span>
<span class="line" id="L333">    );</span>
<span class="line" id="L334">    <span class="tok-comment">// Truncated initial size field</span>
</span>
<span class="line" id="L335">    <span class="tok-kw">try</span> testing.expectError(</span>
<span class="line" id="L336">        <span class="tok-kw">error</span>.EndOfStream,</span>
<span class="line" id="L337">        testDecompress(.gzip, &amp;[_]<span class="tok-type">u8</span>{</span>
<span class="line" id="L338">            <span class="tok-number">0x1f</span>, <span class="tok-number">0x8b</span>, <span class="tok-number">0x08</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>,</span>
<span class="line" id="L339">            <span class="tok-number">0x00</span>, <span class="tok-number">0x03</span>, <span class="tok-number">0x03</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>,</span>
<span class="line" id="L340">            <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>,</span>
<span class="line" id="L341">        }, <span class="tok-null">undefined</span>),</span>
<span class="line" id="L342">    );</span>
<span class="line" id="L343"></span>
<span class="line" id="L344">    <span class="tok-kw">try</span> testDecompress(.gzip, &amp;[_]<span class="tok-type">u8</span>{</span>
<span class="line" id="L345">        <span class="tok-comment">// GZIP header</span>
</span>
<span class="line" id="L346">        <span class="tok-number">0x1f</span>, <span class="tok-number">0x8b</span>, <span class="tok-number">0x08</span>, <span class="tok-number">0x12</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x09</span>, <span class="tok-number">0x6e</span>, <span class="tok-number">0x88</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0xff</span>, <span class="tok-number">0x48</span>, <span class="tok-number">0x65</span>, <span class="tok-number">0x6c</span>, <span class="tok-number">0x6c</span>, <span class="tok-number">0x6f</span>, <span class="tok-number">0x00</span>,</span>
<span class="line" id="L347">        <span class="tok-comment">// header.FHCRC (should cover entire header)</span>
</span>
<span class="line" id="L348">        <span class="tok-number">0x99</span>, <span class="tok-number">0xd6</span>,</span>
<span class="line" id="L349">        <span class="tok-comment">// GZIP data</span>
</span>
<span class="line" id="L350">        <span class="tok-number">0x01</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0xff</span>, <span class="tok-number">0xff</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>,</span>
<span class="line" id="L351">    }, <span class="tok-str">&quot;&quot;</span>);</span>
<span class="line" id="L352">}</span>
<span class="line" id="L353"></span>
<span class="line" id="L354"><span class="tok-kw">test</span> <span class="tok-str">&quot;public interface&quot;</span> {</span>
<span class="line" id="L355">    <span class="tok-kw">const</span> plain_data = [_]<span class="tok-type">u8</span>{ <span class="tok-str">'H'</span>, <span class="tok-str">'e'</span>, <span class="tok-str">'l'</span>, <span class="tok-str">'l'</span>, <span class="tok-str">'o'</span>, <span class="tok-str">' '</span>, <span class="tok-str">'w'</span>, <span class="tok-str">'o'</span>, <span class="tok-str">'r'</span>, <span class="tok-str">'l'</span>, <span class="tok-str">'d'</span>, <span class="tok-number">0x0a</span> };</span>
<span class="line" id="L356"></span>
<span class="line" id="L357">    <span class="tok-comment">// deflate final stored block, header + plain (stored) data</span>
</span>
<span class="line" id="L358">    <span class="tok-kw">const</span> deflate_block = [_]<span class="tok-type">u8</span>{</span>
<span class="line" id="L359">        <span class="tok-number">0b0000_0001</span>, <span class="tok-number">0b0000_1100</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0b1111_0011</span>, <span class="tok-number">0xff</span>, <span class="tok-comment">// deflate fixed buffer header len, nlen</span>
</span>
<span class="line" id="L360">    } ++ plain_data;</span>
<span class="line" id="L361"></span>
<span class="line" id="L362">    <span class="tok-comment">// gzip header/footer + deflate block</span>
</span>
<span class="line" id="L363">    <span class="tok-kw">const</span> gzip_data =</span>
<span class="line" id="L364">        [_]<span class="tok-type">u8</span>{ <span class="tok-number">0x1f</span>, <span class="tok-number">0x8b</span>, <span class="tok-number">0x08</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x03</span> } ++ <span class="tok-comment">// gzip header (10 bytes)</span>
</span>
<span class="line" id="L365">        deflate_block ++</span>
<span class="line" id="L366">        [_]<span class="tok-type">u8</span>{ <span class="tok-number">0xd5</span>, <span class="tok-number">0xe0</span>, <span class="tok-number">0x39</span>, <span class="tok-number">0xb7</span>, <span class="tok-number">0x0c</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span> }; <span class="tok-comment">// gzip footer checksum (4 byte), size (4 bytes)</span>
</span>
<span class="line" id="L367"></span>
<span class="line" id="L368">    <span class="tok-comment">// zlib header/footer + deflate block</span>
</span>
<span class="line" id="L369">    <span class="tok-kw">const</span> zlib_data = [_]<span class="tok-type">u8</span>{ <span class="tok-number">0x78</span>, <span class="tok-number">0b10_0_11100</span> } ++ <span class="tok-comment">// zlib header (2 bytes)}</span>
</span>
<span class="line" id="L370">        deflate_block ++</span>
<span class="line" id="L371">        [_]<span class="tok-type">u8</span>{ <span class="tok-number">0x1c</span>, <span class="tok-number">0xf2</span>, <span class="tok-number">0x04</span>, <span class="tok-number">0x47</span> }; <span class="tok-comment">// zlib footer: checksum</span>
</span>
<span class="line" id="L372"></span>
<span class="line" id="L373">    <span class="tok-kw">const</span> gzip = <span class="tok-builtin">@import</span>(<span class="tok-str">&quot;gzip.zig&quot;</span>);</span>
<span class="line" id="L374">    <span class="tok-kw">const</span> zlib = <span class="tok-builtin">@import</span>(<span class="tok-str">&quot;zlib.zig&quot;</span>);</span>
<span class="line" id="L375">    <span class="tok-kw">const</span> flate = <span class="tok-builtin">@This</span>();</span>
<span class="line" id="L376"></span>
<span class="line" id="L377">    <span class="tok-kw">try</span> testInterface(gzip, &amp;gzip_data, &amp;plain_data);</span>
<span class="line" id="L378">    <span class="tok-kw">try</span> testInterface(zlib, &amp;zlib_data, &amp;plain_data);</span>
<span class="line" id="L379">    <span class="tok-kw">try</span> testInterface(flate, &amp;deflate_block, &amp;plain_data);</span>
<span class="line" id="L380">}</span>
<span class="line" id="L381"></span>
<span class="line" id="L382"><span class="tok-kw">fn</span> <span class="tok-fn">testInterface</span>(<span class="tok-kw">comptime</span> pkg: <span class="tok-type">type</span>, gzip_data: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>, plain_data: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>) !<span class="tok-type">void</span> {</span>
<span class="line" id="L383">    <span class="tok-kw">var</span> buffer1: [<span class="tok-number">64</span>]<span class="tok-type">u8</span> = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L384">    <span class="tok-kw">var</span> buffer2: [<span class="tok-number">64</span>]<span class="tok-type">u8</span> = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L385"></span>
<span class="line" id="L386">    <span class="tok-kw">var</span> compressed = fixedBufferStream(&amp;buffer1);</span>
<span class="line" id="L387">    <span class="tok-kw">var</span> plain = fixedBufferStream(&amp;buffer2);</span>
<span class="line" id="L388"></span>
<span class="line" id="L389">    <span class="tok-comment">// decompress</span>
</span>
<span class="line" id="L390">    {</span>
<span class="line" id="L391">        <span class="tok-kw">var</span> in = fixedBufferStream(gzip_data);</span>
<span class="line" id="L392">        <span class="tok-kw">try</span> pkg.decompress(in.reader(), plain.writer());</span>
<span class="line" id="L393">        <span class="tok-kw">try</span> testing.expectEqualSlices(<span class="tok-type">u8</span>, plain_data, plain.getWritten());</span>
<span class="line" id="L394">    }</span>
<span class="line" id="L395">    plain.reset();</span>
<span class="line" id="L396">    compressed.reset();</span>
<span class="line" id="L397"></span>
<span class="line" id="L398">    <span class="tok-comment">// compress/decompress</span>
</span>
<span class="line" id="L399">    {</span>
<span class="line" id="L400">        <span class="tok-kw">var</span> in = fixedBufferStream(plain_data);</span>
<span class="line" id="L401">        <span class="tok-kw">try</span> pkg.compress(in.reader(), compressed.writer(), .{});</span>
<span class="line" id="L402">        compressed.reset();</span>
<span class="line" id="L403">        <span class="tok-kw">try</span> pkg.decompress(compressed.reader(), plain.writer());</span>
<span class="line" id="L404">        <span class="tok-kw">try</span> testing.expectEqualSlices(<span class="tok-type">u8</span>, plain_data, plain.getWritten());</span>
<span class="line" id="L405">    }</span>
<span class="line" id="L406">    plain.reset();</span>
<span class="line" id="L407">    compressed.reset();</span>
<span class="line" id="L408"></span>
<span class="line" id="L409">    <span class="tok-comment">// compressor/decompressor</span>
</span>
<span class="line" id="L410">    {</span>
<span class="line" id="L411">        <span class="tok-kw">var</span> in = fixedBufferStream(plain_data);</span>
<span class="line" id="L412">        <span class="tok-kw">var</span> cmp = <span class="tok-kw">try</span> pkg.compressor(compressed.writer(), .{});</span>
<span class="line" id="L413">        <span class="tok-kw">try</span> cmp.compress(in.reader());</span>
<span class="line" id="L414">        <span class="tok-kw">try</span> cmp.finish();</span>
<span class="line" id="L415"></span>
<span class="line" id="L416">        compressed.reset();</span>
<span class="line" id="L417">        <span class="tok-kw">var</span> dcp = pkg.decompressor(compressed.reader());</span>
<span class="line" id="L418">        <span class="tok-kw">try</span> dcp.decompress(plain.writer());</span>
<span class="line" id="L419">        <span class="tok-kw">try</span> testing.expectEqualSlices(<span class="tok-type">u8</span>, plain_data, plain.getWritten());</span>
<span class="line" id="L420">    }</span>
<span class="line" id="L421">    plain.reset();</span>
<span class="line" id="L422">    compressed.reset();</span>
<span class="line" id="L423"></span>
<span class="line" id="L424">    <span class="tok-comment">// huffman</span>
</span>
<span class="line" id="L425">    {</span>
<span class="line" id="L426">        <span class="tok-comment">// huffman compress/decompress</span>
</span>
<span class="line" id="L427">        {</span>
<span class="line" id="L428">            <span class="tok-kw">var</span> in = fixedBufferStream(plain_data);</span>
<span class="line" id="L429">            <span class="tok-kw">try</span> pkg.huffman.compress(in.reader(), compressed.writer());</span>
<span class="line" id="L430">            compressed.reset();</span>
<span class="line" id="L431">            <span class="tok-kw">try</span> pkg.decompress(compressed.reader(), plain.writer());</span>
<span class="line" id="L432">            <span class="tok-kw">try</span> testing.expectEqualSlices(<span class="tok-type">u8</span>, plain_data, plain.getWritten());</span>
<span class="line" id="L433">        }</span>
<span class="line" id="L434">        plain.reset();</span>
<span class="line" id="L435">        compressed.reset();</span>
<span class="line" id="L436"></span>
<span class="line" id="L437">        <span class="tok-comment">// huffman compressor/decompressor</span>
</span>
<span class="line" id="L438">        {</span>
<span class="line" id="L439">            <span class="tok-kw">var</span> in = fixedBufferStream(plain_data);</span>
<span class="line" id="L440">            <span class="tok-kw">var</span> cmp = <span class="tok-kw">try</span> pkg.huffman.compressor(compressed.writer());</span>
<span class="line" id="L441">            <span class="tok-kw">try</span> cmp.compress(in.reader());</span>
<span class="line" id="L442">            <span class="tok-kw">try</span> cmp.finish();</span>
<span class="line" id="L443"></span>
<span class="line" id="L444">            compressed.reset();</span>
<span class="line" id="L445">            <span class="tok-kw">try</span> pkg.decompress(compressed.reader(), plain.writer());</span>
<span class="line" id="L446">            <span class="tok-kw">try</span> testing.expectEqualSlices(<span class="tok-type">u8</span>, plain_data, plain.getWritten());</span>
<span class="line" id="L447">        }</span>
<span class="line" id="L448">    }</span>
<span class="line" id="L449">    plain.reset();</span>
<span class="line" id="L450">    compressed.reset();</span>
<span class="line" id="L451"></span>
<span class="line" id="L452">    <span class="tok-comment">// store</span>
</span>
<span class="line" id="L453">    {</span>
<span class="line" id="L454">        <span class="tok-comment">// store compress/decompress</span>
</span>
<span class="line" id="L455">        {</span>
<span class="line" id="L456">            <span class="tok-kw">var</span> in = fixedBufferStream(plain_data);</span>
<span class="line" id="L457">            <span class="tok-kw">try</span> pkg.store.compress(in.reader(), compressed.writer());</span>
<span class="line" id="L458">            compressed.reset();</span>
<span class="line" id="L459">            <span class="tok-kw">try</span> pkg.decompress(compressed.reader(), plain.writer());</span>
<span class="line" id="L460">            <span class="tok-kw">try</span> testing.expectEqualSlices(<span class="tok-type">u8</span>, plain_data, plain.getWritten());</span>
<span class="line" id="L461">        }</span>
<span class="line" id="L462">        plain.reset();</span>
<span class="line" id="L463">        compressed.reset();</span>
<span class="line" id="L464"></span>
<span class="line" id="L465">        <span class="tok-comment">// store compressor/decompressor</span>
</span>
<span class="line" id="L466">        {</span>
<span class="line" id="L467">            <span class="tok-kw">var</span> in = fixedBufferStream(plain_data);</span>
<span class="line" id="L468">            <span class="tok-kw">var</span> cmp = <span class="tok-kw">try</span> pkg.store.compressor(compressed.writer());</span>
<span class="line" id="L469">            <span class="tok-kw">try</span> cmp.compress(in.reader());</span>
<span class="line" id="L470">            <span class="tok-kw">try</span> cmp.finish();</span>
<span class="line" id="L471"></span>
<span class="line" id="L472">            compressed.reset();</span>
<span class="line" id="L473">            <span class="tok-kw">try</span> pkg.decompress(compressed.reader(), plain.writer());</span>
<span class="line" id="L474">            <span class="tok-kw">try</span> testing.expectEqualSlices(<span class="tok-type">u8</span>, plain_data, plain.getWritten());</span>
<span class="line" id="L475">        }</span>
<span class="line" id="L476">    }</span>
<span class="line" id="L477">}</span>
<span class="line" id="L478"></span>
</code></pre></body>
</html>