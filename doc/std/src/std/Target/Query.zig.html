<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">    <title>Target/Query.zig - source view</title>
    <link rel="icon" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAgklEQVR4AWMYWuD7EllJIM4G4g4g5oIJ/odhOJ8wToOxSTXgNxDHoeiBMfA4+wGShjyYOCkG/IGqWQziEzYAoUAeiF9D5U+DxEg14DRU7jWIT5IBIOdCxf+A+CQZAAoopEB7QJwBCBwHiip8UYmRdrAlDpIMgApwQZNnNii5Dq0MBgCxxycBnwEd+wAAAABJRU5ErkJggg==">
    <link rel="icon" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxNTMgMTQwIj48ZyBmaWxsPSIjRjdBNDFEIj48Zz48cG9seWdvbiBwb2ludHM9IjQ2LDIyIDI4LDQ0IDE5LDMwIi8+PHBvbHlnb24gcG9pbnRzPSI0NiwyMiAzMywzMyAyOCw0NCAyMiw0NCAyMiw5NSAzMSw5NSAyMCwxMDAgMTIsMTE3IDAsMTE3IDAsMjIiIHNoYXBlLXJlbmRlcmluZz0iY3Jpc3BFZGdlcyIvPjxwb2x5Z29uIHBvaW50cz0iMzEsOTUgMTIsMTE3IDQsMTA2Ii8+PC9nPjxnPjxwb2x5Z29uIHBvaW50cz0iNTYsMjIgNjIsMzYgMzcsNDQiLz48cG9seWdvbiBwb2ludHM9IjU2LDIyIDExMSwyMiAxMTEsNDQgMzcsNDQgNTYsMzIiIHNoYXBlLXJlbmRlcmluZz0iY3Jpc3BFZGdlcyIvPjxwb2x5Z29uIHBvaW50cz0iMTE2LDk1IDk3LDExNyA5MCwxMDQiLz48cG9seWdvbiBwb2ludHM9IjExNiw5NSAxMDAsMTA0IDk3LDExNyA0MiwxMTcgNDIsOTUiIHNoYXBlLXJlbmRlcmluZz0iY3Jpc3BFZGdlcyIvPjxwb2x5Z29uIHBvaW50cz0iMTUwLDAgNTIsMTE3IDMsMTQwIDEwMSwyMiIvPjwvZz48Zz48cG9seWdvbiBwb2ludHM9IjE0MSwyMiAxNDAsNDAgMTIyLDQ1Ii8+PHBvbHlnb24gcG9pbnRzPSIxNTMsMjIgMTUzLDExNyAxMDYsMTE3IDEyMCwxMDUgMTI1LDk1IDEzMSw5NSAxMzEsNDUgMTIyLDQ1IDEzMiwzNiAxNDEsMjIiIHNoYXBlLXJlbmRlcmluZz0iY3Jpc3BFZGdlcyIvPjxwb2x5Z29uIHBvaW50cz0iMTI1LDk1IDEzMCwxMTAgMTA2LDExNyIvPjwvZz48L2c+PC9zdmc+">
    <style>
      body{
        font-family: system-ui, -apple-system, Roboto, "Segoe UI", sans-serif;
        margin: 0;
        line-height: 1.5;
      }

      pre > code {
        display: block;
        overflow: auto;
        line-height: normal;
        margin: 0em;
      }
      .tok-kw {
          color: #333;
          font-weight: bold;
      }
      .tok-str {
          color: #d14;
      }
      .tok-builtin {
          color: #005C7A;
      }
      .tok-comment {
          color: #545454;
          font-style: italic;
      }
      .tok-fn {
          color: #900;
          font-weight: bold;
      }
      .tok-null {
          color: #005C5C;
      }
      .tok-number {
          color: #005C5C;
      }
      .tok-type {
          color: #458;
          font-weight: bold;
      }
      pre {
        counter-reset: line;
      }
      pre .line:before {
        counter-increment: line;
        content: counter(line);
        display: inline-block;
        padding-right: 1em;
        width: 2em;
        text-align: right;
        color: #999;
      }
      
      .line {
        width: 100%;
        display: inline-block;
      }
      .line:target {
        border-top: 1px solid #ccc;
        border-bottom: 1px solid #ccc;
        background: #fafafa;
      }

      @media (prefers-color-scheme: dark) {
        body{
            background:#222;
            color: #ccc;
        }
        pre > code {
            color: #ccc;
            background: #222;
            border: unset;
        }
        .line:target {
            border-top: 1px solid #444;
            border-bottom: 1px solid #444;
            background: #333;
        }
        .tok-kw {
            color: #eee;
        }
        .tok-str {
            color: #2e5;
        }
        .tok-builtin {
            color: #ff894c;
        }
        .tok-comment {
            color: #aa7;
        }
        .tok-fn {
            color: #B1A0F8;
        }
        .tok-null {
            color: #ff8080;
        }
        .tok-number {
            color: #ff8080;
        }
        .tok-type {
            color: #68f;
        }
      }
    </style>
</head>
<body>
<pre><code><span class="line" id="L1"><span class="tok-comment">//! Contains all the same data as `Target`, additionally introducing the</span></span>
<span class="line" id="L2"><span class="tok-comment">//! concept of &quot;the native target&quot;. The purpose of this abstraction is to</span></span>
<span class="line" id="L3"><span class="tok-comment">//! provide meaningful and unsurprising defaults. This struct does reference</span></span>
<span class="line" id="L4"><span class="tok-comment">//! any resources and it is copyable.</span></span>
<span class="line" id="L5"></span>
<span class="line" id="L6"><span class="tok-comment">/// `null` means native.</span></span>
<span class="line" id="L7">cpu_arch: ?Target.Cpu.Arch = <span class="tok-null">null</span>,</span>
<span class="line" id="L8"></span>
<span class="line" id="L9">cpu_model: CpuModel = CpuModel.determined_by_cpu_arch,</span>
<span class="line" id="L10"></span>
<span class="line" id="L11"><span class="tok-comment">/// Sparse set of CPU features to add to the set from `cpu_model`.</span></span>
<span class="line" id="L12">cpu_features_add: Target.Cpu.Feature.Set = Target.Cpu.Feature.Set.empty,</span>
<span class="line" id="L13"></span>
<span class="line" id="L14"><span class="tok-comment">/// Sparse set of CPU features to remove from the set from `cpu_model`.</span></span>
<span class="line" id="L15">cpu_features_sub: Target.Cpu.Feature.Set = Target.Cpu.Feature.Set.empty,</span>
<span class="line" id="L16"></span>
<span class="line" id="L17"><span class="tok-comment">/// `null` means native.</span></span>
<span class="line" id="L18">os_tag: ?Target.Os.Tag = <span class="tok-null">null</span>,</span>
<span class="line" id="L19"></span>
<span class="line" id="L20"><span class="tok-comment">/// `null` means the default version range for `os_tag`. If `os_tag` is `null` (native)</span></span>
<span class="line" id="L21"><span class="tok-comment">/// then `null` for this field means native.</span></span>
<span class="line" id="L22">os_version_min: ?OsVersion = <span class="tok-null">null</span>,</span>
<span class="line" id="L23"></span>
<span class="line" id="L24"><span class="tok-comment">/// When cross compiling, `null` means default (latest known OS version).</span></span>
<span class="line" id="L25"><span class="tok-comment">/// When `os_tag` is native, `null` means equal to the native OS version.</span></span>
<span class="line" id="L26">os_version_max: ?OsVersion = <span class="tok-null">null</span>,</span>
<span class="line" id="L27"></span>
<span class="line" id="L28"><span class="tok-comment">/// `null` means default when cross compiling, or native when os_tag is native.</span></span>
<span class="line" id="L29"><span class="tok-comment">/// If `isGnuLibC()` is `false`, this must be `null` and is ignored.</span></span>
<span class="line" id="L30">glibc_version: ?SemanticVersion = <span class="tok-null">null</span>,</span>
<span class="line" id="L31"></span>
<span class="line" id="L32"><span class="tok-comment">/// `null` means the native C ABI, if `os_tag` is native, otherwise it means the default C ABI.</span></span>
<span class="line" id="L33">abi: ?Target.Abi = <span class="tok-null">null</span>,</span>
<span class="line" id="L34"></span>
<span class="line" id="L35"><span class="tok-comment">/// When `os_tag` is `null`, then `null` means native. Otherwise it means the standard path</span></span>
<span class="line" id="L36"><span class="tok-comment">/// based on the `os_tag`.</span></span>
<span class="line" id="L37">dynamic_linker: Target.DynamicLinker = Target.DynamicLinker.none,</span>
<span class="line" id="L38"></span>
<span class="line" id="L39"><span class="tok-comment">/// `null` means default for the cpu/arch/os combo.</span></span>
<span class="line" id="L40">ofmt: ?Target.ObjectFormat = <span class="tok-null">null</span>,</span>
<span class="line" id="L41"></span>
<span class="line" id="L42"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> CpuModel = <span class="tok-kw">union</span>(<span class="tok-kw">enum</span>) {</span>
<span class="line" id="L43">    <span class="tok-comment">/// Always native</span></span>
<span class="line" id="L44">    native,</span>
<span class="line" id="L45"></span>
<span class="line" id="L46">    <span class="tok-comment">/// Always baseline</span></span>
<span class="line" id="L47">    baseline,</span>
<span class="line" id="L48"></span>
<span class="line" id="L49">    <span class="tok-comment">/// If CPU Architecture is native, then the CPU model will be native. Otherwise,</span></span>
<span class="line" id="L50">    <span class="tok-comment">/// it will be baseline.</span></span>
<span class="line" id="L51">    determined_by_cpu_arch,</span>
<span class="line" id="L52"></span>
<span class="line" id="L53">    explicit: *<span class="tok-kw">const</span> Target.Cpu.Model,</span>
<span class="line" id="L54"></span>
<span class="line" id="L55">    <span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">eql</span>(a: CpuModel, b: CpuModel) <span class="tok-type">bool</span> {</span>
<span class="line" id="L56">        <span class="tok-kw">const</span> Tag = <span class="tok-builtin">@typeInfo</span>(CpuModel).Union.tag_type.?;</span>
<span class="line" id="L57">        <span class="tok-kw">const</span> a_tag: Tag = a;</span>
<span class="line" id="L58">        <span class="tok-kw">const</span> b_tag: Tag = b;</span>
<span class="line" id="L59">        <span class="tok-kw">if</span> (a_tag != b_tag) <span class="tok-kw">return</span> <span class="tok-null">false</span>;</span>
<span class="line" id="L60">        <span class="tok-kw">return</span> <span class="tok-kw">switch</span> (a) {</span>
<span class="line" id="L61">            .native, .baseline, .determined_by_cpu_arch =&gt; <span class="tok-null">true</span>,</span>
<span class="line" id="L62">            .explicit =&gt; |a_model| a_model == b.explicit,</span>
<span class="line" id="L63">        };</span>
<span class="line" id="L64">    }</span>
<span class="line" id="L65">};</span>
<span class="line" id="L66"></span>
<span class="line" id="L67"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> OsVersion = <span class="tok-kw">union</span>(<span class="tok-kw">enum</span>) {</span>
<span class="line" id="L68">    none: <span class="tok-type">void</span>,</span>
<span class="line" id="L69">    semver: SemanticVersion,</span>
<span class="line" id="L70">    windows: Target.Os.WindowsVersion,</span>
<span class="line" id="L71"></span>
<span class="line" id="L72">    <span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">eql</span>(a: OsVersion, b: OsVersion) <span class="tok-type">bool</span> {</span>
<span class="line" id="L73">        <span class="tok-kw">const</span> Tag = <span class="tok-builtin">@typeInfo</span>(OsVersion).Union.tag_type.?;</span>
<span class="line" id="L74">        <span class="tok-kw">const</span> a_tag: Tag = a;</span>
<span class="line" id="L75">        <span class="tok-kw">const</span> b_tag: Tag = b;</span>
<span class="line" id="L76">        <span class="tok-kw">if</span> (a_tag != b_tag) <span class="tok-kw">return</span> <span class="tok-null">false</span>;</span>
<span class="line" id="L77">        <span class="tok-kw">return</span> <span class="tok-kw">switch</span> (a) {</span>
<span class="line" id="L78">            .none =&gt; <span class="tok-null">true</span>,</span>
<span class="line" id="L79">            .semver =&gt; |a_semver| a_semver.order(b.semver) == .eq,</span>
<span class="line" id="L80">            .windows =&gt; |a_windows| a_windows == b.windows,</span>
<span class="line" id="L81">        };</span>
<span class="line" id="L82">    }</span>
<span class="line" id="L83"></span>
<span class="line" id="L84">    <span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">eqlOpt</span>(a: ?OsVersion, b: ?OsVersion) <span class="tok-type">bool</span> {</span>
<span class="line" id="L85">        <span class="tok-kw">if</span> (a == <span class="tok-null">null</span> <span class="tok-kw">and</span> b == <span class="tok-null">null</span>) <span class="tok-kw">return</span> <span class="tok-null">true</span>;</span>
<span class="line" id="L86">        <span class="tok-kw">if</span> (a == <span class="tok-null">null</span> <span class="tok-kw">or</span> b == <span class="tok-null">null</span>) <span class="tok-kw">return</span> <span class="tok-null">false</span>;</span>
<span class="line" id="L87">        <span class="tok-kw">return</span> OsVersion.eql(a.?, b.?);</span>
<span class="line" id="L88">    }</span>
<span class="line" id="L89">};</span>
<span class="line" id="L90"></span>
<span class="line" id="L91"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> SemanticVersion = std.SemanticVersion;</span>
<span class="line" id="L92"></span>
<span class="line" id="L93"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">fromTarget</span>(target: Target) Query {</span>
<span class="line" id="L94">    <span class="tok-kw">var</span> result: Query = .{</span>
<span class="line" id="L95">        .cpu_arch = target.cpu.arch,</span>
<span class="line" id="L96">        .cpu_model = .{ .explicit = target.cpu.model },</span>
<span class="line" id="L97">        .os_tag = target.os.tag,</span>
<span class="line" id="L98">        .os_version_min = <span class="tok-null">undefined</span>,</span>
<span class="line" id="L99">        .os_version_max = <span class="tok-null">undefined</span>,</span>
<span class="line" id="L100">        .abi = target.abi,</span>
<span class="line" id="L101">        .glibc_version = <span class="tok-kw">if</span> (target.isGnuLibC())</span>
<span class="line" id="L102">            target.os.version_range.linux.glibc</span>
<span class="line" id="L103">        <span class="tok-kw">else</span></span>
<span class="line" id="L104">            <span class="tok-null">null</span>,</span>
<span class="line" id="L105">    };</span>
<span class="line" id="L106">    result.updateOsVersionRange(target.os);</span>
<span class="line" id="L107"></span>
<span class="line" id="L108">    <span class="tok-kw">const</span> all_features = target.cpu.arch.allFeaturesList();</span>
<span class="line" id="L109">    <span class="tok-kw">var</span> cpu_model_set = target.cpu.model.features;</span>
<span class="line" id="L110">    cpu_model_set.populateDependencies(all_features);</span>
<span class="line" id="L111">    {</span>
<span class="line" id="L112">        <span class="tok-comment">// The &quot;add&quot; set is the full set with the CPU Model set removed.</span>
</span>
<span class="line" id="L113">        <span class="tok-kw">const</span> add_set = &amp;result.cpu_features_add;</span>
<span class="line" id="L114">        add_set.* = target.cpu.features;</span>
<span class="line" id="L115">        add_set.removeFeatureSet(cpu_model_set);</span>
<span class="line" id="L116">    }</span>
<span class="line" id="L117">    {</span>
<span class="line" id="L118">        <span class="tok-comment">// The &quot;sub&quot; set is the features that are on in CPU Model set and off in the full set.</span>
</span>
<span class="line" id="L119">        <span class="tok-kw">const</span> sub_set = &amp;result.cpu_features_sub;</span>
<span class="line" id="L120">        sub_set.* = cpu_model_set;</span>
<span class="line" id="L121">        sub_set.removeFeatureSet(target.cpu.features);</span>
<span class="line" id="L122">    }</span>
<span class="line" id="L123">    <span class="tok-kw">return</span> result;</span>
<span class="line" id="L124">}</span>
<span class="line" id="L125"></span>
<span class="line" id="L126"><span class="tok-kw">fn</span> <span class="tok-fn">updateOsVersionRange</span>(self: *Query, os: Target.Os) <span class="tok-type">void</span> {</span>
<span class="line" id="L127">    <span class="tok-kw">switch</span> (os.tag) {</span>
<span class="line" id="L128">        .freestanding,</span>
<span class="line" id="L129">        .ananas,</span>
<span class="line" id="L130">        .cloudabi,</span>
<span class="line" id="L131">        .fuchsia,</span>
<span class="line" id="L132">        .kfreebsd,</span>
<span class="line" id="L133">        .lv2,</span>
<span class="line" id="L134">        .solaris,</span>
<span class="line" id="L135">        .illumos,</span>
<span class="line" id="L136">        .zos,</span>
<span class="line" id="L137">        .haiku,</span>
<span class="line" id="L138">        .minix,</span>
<span class="line" id="L139">        .rtems,</span>
<span class="line" id="L140">        .nacl,</span>
<span class="line" id="L141">        .aix,</span>
<span class="line" id="L142">        .cuda,</span>
<span class="line" id="L143">        .nvcl,</span>
<span class="line" id="L144">        .amdhsa,</span>
<span class="line" id="L145">        .ps4,</span>
<span class="line" id="L146">        .ps5,</span>
<span class="line" id="L147">        .elfiamcu,</span>
<span class="line" id="L148">        .mesa3d,</span>
<span class="line" id="L149">        .contiki,</span>
<span class="line" id="L150">        .amdpal,</span>
<span class="line" id="L151">        .hermit,</span>
<span class="line" id="L152">        .hurd,</span>
<span class="line" id="L153">        .wasi,</span>
<span class="line" id="L154">        .emscripten,</span>
<span class="line" id="L155">        .driverkit,</span>
<span class="line" id="L156">        .shadermodel,</span>
<span class="line" id="L157">        .liteos,</span>
<span class="line" id="L158">        .uefi,</span>
<span class="line" id="L159">        .opencl,</span>
<span class="line" id="L160">        .glsl450,</span>
<span class="line" id="L161">        .vulkan,</span>
<span class="line" id="L162">        .plan9,</span>
<span class="line" id="L163">        .other,</span>
<span class="line" id="L164">        =&gt; {</span>
<span class="line" id="L165">            self.os_version_min = .{ .none = {} };</span>
<span class="line" id="L166">            self.os_version_max = .{ .none = {} };</span>
<span class="line" id="L167">        },</span>
<span class="line" id="L168"></span>
<span class="line" id="L169">        .freebsd,</span>
<span class="line" id="L170">        .macos,</span>
<span class="line" id="L171">        .ios,</span>
<span class="line" id="L172">        .tvos,</span>
<span class="line" id="L173">        .watchos,</span>
<span class="line" id="L174">        .netbsd,</span>
<span class="line" id="L175">        .openbsd,</span>
<span class="line" id="L176">        .dragonfly,</span>
<span class="line" id="L177">        =&gt; {</span>
<span class="line" id="L178">            self.os_version_min = .{ .semver = os.version_range.semver.min };</span>
<span class="line" id="L179">            self.os_version_max = .{ .semver = os.version_range.semver.max };</span>
<span class="line" id="L180">        },</span>
<span class="line" id="L181"></span>
<span class="line" id="L182">        .linux =&gt; {</span>
<span class="line" id="L183">            self.os_version_min = .{ .semver = os.version_range.linux.range.min };</span>
<span class="line" id="L184">            self.os_version_max = .{ .semver = os.version_range.linux.range.max };</span>
<span class="line" id="L185">        },</span>
<span class="line" id="L186"></span>
<span class="line" id="L187">        .windows =&gt; {</span>
<span class="line" id="L188">            self.os_version_min = .{ .windows = os.version_range.windows.min };</span>
<span class="line" id="L189">            self.os_version_max = .{ .windows = os.version_range.windows.max };</span>
<span class="line" id="L190">        },</span>
<span class="line" id="L191">    }</span>
<span class="line" id="L192">}</span>
<span class="line" id="L193"></span>
<span class="line" id="L194"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> ParseOptions = <span class="tok-kw">struct</span> {</span>
<span class="line" id="L195">    <span class="tok-comment">/// This is sometimes called a &quot;triple&quot;. It looks roughly like this:</span></span>
<span class="line" id="L196">    <span class="tok-comment">///     riscv64-linux-musl</span></span>
<span class="line" id="L197">    <span class="tok-comment">/// The fields are, respectively:</span></span>
<span class="line" id="L198">    <span class="tok-comment">/// * CPU Architecture</span></span>
<span class="line" id="L199">    <span class="tok-comment">/// * Operating System (and optional version range)</span></span>
<span class="line" id="L200">    <span class="tok-comment">/// * C ABI (optional, with optional glibc version)</span></span>
<span class="line" id="L201">    <span class="tok-comment">/// The string &quot;native&quot; can be used for CPU architecture as well as Operating System.</span></span>
<span class="line" id="L202">    <span class="tok-comment">/// If the CPU Architecture is specified as &quot;native&quot;, then the Operating System and C ABI may be omitted.</span></span>
<span class="line" id="L203">    arch_os_abi: []<span class="tok-kw">const</span> <span class="tok-type">u8</span> = <span class="tok-str">&quot;native&quot;</span>,</span>
<span class="line" id="L204"></span>
<span class="line" id="L205">    <span class="tok-comment">/// Looks like &quot;name+a+b-c-d+e&quot;, where &quot;name&quot; is a CPU Model name, &quot;a&quot;, &quot;b&quot;, and &quot;e&quot;</span></span>
<span class="line" id="L206">    <span class="tok-comment">/// are examples of CPU features to add to the set, and &quot;c&quot; and &quot;d&quot; are examples of CPU features</span></span>
<span class="line" id="L207">    <span class="tok-comment">/// to remove from the set.</span></span>
<span class="line" id="L208">    <span class="tok-comment">/// The following special strings are recognized for CPU Model name:</span></span>
<span class="line" id="L209">    <span class="tok-comment">/// * &quot;baseline&quot; - The &quot;default&quot; set of CPU features for cross-compiling. A conservative set</span></span>
<span class="line" id="L210">    <span class="tok-comment">///                of features that is expected to be supported on most available hardware.</span></span>
<span class="line" id="L211">    <span class="tok-comment">/// * &quot;native&quot;   - The native CPU model is to be detected when compiling.</span></span>
<span class="line" id="L212">    <span class="tok-comment">/// If this field is not provided (`null`), then the value will depend on the</span></span>
<span class="line" id="L213">    <span class="tok-comment">/// parsed CPU Architecture. If native, then this will be &quot;native&quot;. Otherwise, it will be &quot;baseline&quot;.</span></span>
<span class="line" id="L214">    cpu_features: ?[]<span class="tok-kw">const</span> <span class="tok-type">u8</span> = <span class="tok-null">null</span>,</span>
<span class="line" id="L215"></span>
<span class="line" id="L216">    <span class="tok-comment">/// Absolute path to dynamic linker, to override the default, which is either a natively</span></span>
<span class="line" id="L217">    <span class="tok-comment">/// detected path, or a standard path.</span></span>
<span class="line" id="L218">    dynamic_linker: ?[]<span class="tok-kw">const</span> <span class="tok-type">u8</span> = <span class="tok-null">null</span>,</span>
<span class="line" id="L219"></span>
<span class="line" id="L220">    object_format: ?[]<span class="tok-kw">const</span> <span class="tok-type">u8</span> = <span class="tok-null">null</span>,</span>
<span class="line" id="L221"></span>
<span class="line" id="L222">    <span class="tok-comment">/// If this is provided, the function will populate some information about parsing failures,</span></span>
<span class="line" id="L223">    <span class="tok-comment">/// so that user-friendly error messages can be delivered.</span></span>
<span class="line" id="L224">    diagnostics: ?*Diagnostics = <span class="tok-null">null</span>,</span>
<span class="line" id="L225"></span>
<span class="line" id="L226">    <span class="tok-kw">pub</span> <span class="tok-kw">const</span> Diagnostics = <span class="tok-kw">struct</span> {</span>
<span class="line" id="L227">        <span class="tok-comment">/// If the architecture was determined, this will be populated.</span></span>
<span class="line" id="L228">        arch: ?Target.Cpu.Arch = <span class="tok-null">null</span>,</span>
<span class="line" id="L229"></span>
<span class="line" id="L230">        <span class="tok-comment">/// If the OS name was determined, this will be populated.</span></span>
<span class="line" id="L231">        os_name: ?[]<span class="tok-kw">const</span> <span class="tok-type">u8</span> = <span class="tok-null">null</span>,</span>
<span class="line" id="L232"></span>
<span class="line" id="L233">        <span class="tok-comment">/// If the OS tag was determined, this will be populated.</span></span>
<span class="line" id="L234">        os_tag: ?Target.Os.Tag = <span class="tok-null">null</span>,</span>
<span class="line" id="L235"></span>
<span class="line" id="L236">        <span class="tok-comment">/// If the ABI was determined, this will be populated.</span></span>
<span class="line" id="L237">        abi: ?Target.Abi = <span class="tok-null">null</span>,</span>
<span class="line" id="L238"></span>
<span class="line" id="L239">        <span class="tok-comment">/// If the CPU name was determined, this will be populated.</span></span>
<span class="line" id="L240">        cpu_name: ?[]<span class="tok-kw">const</span> <span class="tok-type">u8</span> = <span class="tok-null">null</span>,</span>
<span class="line" id="L241"></span>
<span class="line" id="L242">        <span class="tok-comment">/// If error.UnknownCpuFeature is returned, this will be populated.</span></span>
<span class="line" id="L243">        unknown_feature_name: ?[]<span class="tok-kw">const</span> <span class="tok-type">u8</span> = <span class="tok-null">null</span>,</span>
<span class="line" id="L244">    };</span>
<span class="line" id="L245">};</span>
<span class="line" id="L246"></span>
<span class="line" id="L247"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">parse</span>(args: ParseOptions) !Query {</span>
<span class="line" id="L248">    <span class="tok-kw">var</span> dummy_diags: ParseOptions.Diagnostics = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L249">    <span class="tok-kw">const</span> diags = args.diagnostics <span class="tok-kw">orelse</span> &amp;dummy_diags;</span>
<span class="line" id="L250"></span>
<span class="line" id="L251">    <span class="tok-kw">var</span> result: Query = .{</span>
<span class="line" id="L252">        .dynamic_linker = Target.DynamicLinker.init(args.dynamic_linker),</span>
<span class="line" id="L253">    };</span>
<span class="line" id="L254"></span>
<span class="line" id="L255">    <span class="tok-kw">var</span> it = mem.splitScalar(<span class="tok-type">u8</span>, args.arch_os_abi, <span class="tok-str">'-'</span>);</span>
<span class="line" id="L256">    <span class="tok-kw">const</span> arch_name = it.first();</span>
<span class="line" id="L257">    <span class="tok-kw">const</span> arch_is_native = mem.eql(<span class="tok-type">u8</span>, arch_name, <span class="tok-str">&quot;native&quot;</span>);</span>
<span class="line" id="L258">    <span class="tok-kw">if</span> (!arch_is_native) {</span>
<span class="line" id="L259">        result.cpu_arch = std.meta.stringToEnum(Target.Cpu.Arch, arch_name) <span class="tok-kw">orelse</span></span>
<span class="line" id="L260">            <span class="tok-kw">return</span> <span class="tok-kw">error</span>.UnknownArchitecture;</span>
<span class="line" id="L261">    }</span>
<span class="line" id="L262">    <span class="tok-kw">const</span> arch = result.cpu_arch <span class="tok-kw">orelse</span> builtin.cpu.arch;</span>
<span class="line" id="L263">    diags.arch = arch;</span>
<span class="line" id="L264"></span>
<span class="line" id="L265">    <span class="tok-kw">if</span> (it.next()) |os_text| {</span>
<span class="line" id="L266">        <span class="tok-kw">try</span> parseOs(&amp;result, diags, os_text);</span>
<span class="line" id="L267">    } <span class="tok-kw">else</span> <span class="tok-kw">if</span> (!arch_is_native) {</span>
<span class="line" id="L268">        <span class="tok-kw">return</span> <span class="tok-kw">error</span>.MissingOperatingSystem;</span>
<span class="line" id="L269">    }</span>
<span class="line" id="L270"></span>
<span class="line" id="L271">    <span class="tok-kw">const</span> opt_abi_text = it.next();</span>
<span class="line" id="L272">    <span class="tok-kw">if</span> (opt_abi_text) |abi_text| {</span>
<span class="line" id="L273">        <span class="tok-kw">var</span> abi_it = mem.splitScalar(<span class="tok-type">u8</span>, abi_text, <span class="tok-str">'.'</span>);</span>
<span class="line" id="L274">        <span class="tok-kw">const</span> abi = std.meta.stringToEnum(Target.Abi, abi_it.first()) <span class="tok-kw">orelse</span></span>
<span class="line" id="L275">            <span class="tok-kw">return</span> <span class="tok-kw">error</span>.UnknownApplicationBinaryInterface;</span>
<span class="line" id="L276">        result.abi = abi;</span>
<span class="line" id="L277">        diags.abi = abi;</span>
<span class="line" id="L278"></span>
<span class="line" id="L279">        <span class="tok-kw">const</span> abi_ver_text = abi_it.rest();</span>
<span class="line" id="L280">        <span class="tok-kw">if</span> (abi_it.next() != <span class="tok-null">null</span>) {</span>
<span class="line" id="L281">            <span class="tok-kw">if</span> (Target.isGnuLibC_os_tag_abi(result.os_tag <span class="tok-kw">orelse</span> builtin.os.tag, abi)) {</span>
<span class="line" id="L282">                result.glibc_version = parseVersion(abi_ver_text) <span class="tok-kw">catch</span> |err| <span class="tok-kw">switch</span> (err) {</span>
<span class="line" id="L283">                    <span class="tok-kw">error</span>.Overflow =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.InvalidAbiVersion,</span>
<span class="line" id="L284">                    <span class="tok-kw">error</span>.InvalidVersion =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.InvalidAbiVersion,</span>
<span class="line" id="L285">                };</span>
<span class="line" id="L286">            } <span class="tok-kw">else</span> {</span>
<span class="line" id="L287">                <span class="tok-kw">return</span> <span class="tok-kw">error</span>.InvalidAbiVersion;</span>
<span class="line" id="L288">            }</span>
<span class="line" id="L289">        }</span>
<span class="line" id="L290">    }</span>
<span class="line" id="L291"></span>
<span class="line" id="L292">    <span class="tok-kw">if</span> (it.next() != <span class="tok-null">null</span>) <span class="tok-kw">return</span> <span class="tok-kw">error</span>.UnexpectedExtraField;</span>
<span class="line" id="L293"></span>
<span class="line" id="L294">    <span class="tok-kw">if</span> (args.cpu_features) |cpu_features| {</span>
<span class="line" id="L295">        <span class="tok-kw">const</span> all_features = arch.allFeaturesList();</span>
<span class="line" id="L296">        <span class="tok-kw">var</span> index: <span class="tok-type">usize</span> = <span class="tok-number">0</span>;</span>
<span class="line" id="L297">        <span class="tok-kw">while</span> (index &lt; cpu_features.len <span class="tok-kw">and</span></span>
<span class="line" id="L298">            cpu_features[index] != <span class="tok-str">'+'</span> <span class="tok-kw">and</span></span>
<span class="line" id="L299">            cpu_features[index] != <span class="tok-str">'-'</span>)</span>
<span class="line" id="L300">        {</span>
<span class="line" id="L301">            index += <span class="tok-number">1</span>;</span>
<span class="line" id="L302">        }</span>
<span class="line" id="L303">        <span class="tok-kw">const</span> cpu_name = cpu_features[<span class="tok-number">0</span>..index];</span>
<span class="line" id="L304">        diags.cpu_name = cpu_name;</span>
<span class="line" id="L305"></span>
<span class="line" id="L306">        <span class="tok-kw">const</span> add_set = &amp;result.cpu_features_add;</span>
<span class="line" id="L307">        <span class="tok-kw">const</span> sub_set = &amp;result.cpu_features_sub;</span>
<span class="line" id="L308">        <span class="tok-kw">if</span> (mem.eql(<span class="tok-type">u8</span>, cpu_name, <span class="tok-str">&quot;native&quot;</span>)) {</span>
<span class="line" id="L309">            result.cpu_model = .native;</span>
<span class="line" id="L310">        } <span class="tok-kw">else</span> <span class="tok-kw">if</span> (mem.eql(<span class="tok-type">u8</span>, cpu_name, <span class="tok-str">&quot;baseline&quot;</span>)) {</span>
<span class="line" id="L311">            result.cpu_model = .baseline;</span>
<span class="line" id="L312">        } <span class="tok-kw">else</span> {</span>
<span class="line" id="L313">            result.cpu_model = .{ .explicit = <span class="tok-kw">try</span> arch.parseCpuModel(cpu_name) };</span>
<span class="line" id="L314">        }</span>
<span class="line" id="L315"></span>
<span class="line" id="L316">        <span class="tok-kw">while</span> (index &lt; cpu_features.len) {</span>
<span class="line" id="L317">            <span class="tok-kw">const</span> op = cpu_features[index];</span>
<span class="line" id="L318">            <span class="tok-kw">const</span> set = <span class="tok-kw">switch</span> (op) {</span>
<span class="line" id="L319">                <span class="tok-str">'+'</span> =&gt; add_set,</span>
<span class="line" id="L320">                <span class="tok-str">'-'</span> =&gt; sub_set,</span>
<span class="line" id="L321">                <span class="tok-kw">else</span> =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L322">            };</span>
<span class="line" id="L323">            index += <span class="tok-number">1</span>;</span>
<span class="line" id="L324">            <span class="tok-kw">const</span> start = index;</span>
<span class="line" id="L325">            <span class="tok-kw">while</span> (index &lt; cpu_features.len <span class="tok-kw">and</span></span>
<span class="line" id="L326">                cpu_features[index] != <span class="tok-str">'+'</span> <span class="tok-kw">and</span></span>
<span class="line" id="L327">                cpu_features[index] != <span class="tok-str">'-'</span>)</span>
<span class="line" id="L328">            {</span>
<span class="line" id="L329">                index += <span class="tok-number">1</span>;</span>
<span class="line" id="L330">            }</span>
<span class="line" id="L331">            <span class="tok-kw">const</span> feature_name = cpu_features[start..index];</span>
<span class="line" id="L332">            <span class="tok-kw">for</span> (all_features, <span class="tok-number">0</span>..) |feature, feat_index_usize| {</span>
<span class="line" id="L333">                <span class="tok-kw">const</span> feat_index = <span class="tok-builtin">@as</span>(Target.Cpu.Feature.Set.Index, <span class="tok-builtin">@intCast</span>(feat_index_usize));</span>
<span class="line" id="L334">                <span class="tok-kw">if</span> (mem.eql(<span class="tok-type">u8</span>, feature_name, feature.name)) {</span>
<span class="line" id="L335">                    set.addFeature(feat_index);</span>
<span class="line" id="L336">                    <span class="tok-kw">break</span>;</span>
<span class="line" id="L337">                }</span>
<span class="line" id="L338">            } <span class="tok-kw">else</span> {</span>
<span class="line" id="L339">                diags.unknown_feature_name = feature_name;</span>
<span class="line" id="L340">                <span class="tok-kw">return</span> <span class="tok-kw">error</span>.UnknownCpuFeature;</span>
<span class="line" id="L341">            }</span>
<span class="line" id="L342">        }</span>
<span class="line" id="L343">    }</span>
<span class="line" id="L344"></span>
<span class="line" id="L345">    <span class="tok-kw">if</span> (args.object_format) |ofmt_name| {</span>
<span class="line" id="L346">        result.ofmt = std.meta.stringToEnum(Target.ObjectFormat, ofmt_name) <span class="tok-kw">orelse</span></span>
<span class="line" id="L347">            <span class="tok-kw">return</span> <span class="tok-kw">error</span>.UnknownObjectFormat;</span>
<span class="line" id="L348">    }</span>
<span class="line" id="L349"></span>
<span class="line" id="L350">    <span class="tok-kw">return</span> result;</span>
<span class="line" id="L351">}</span>
<span class="line" id="L352"></span>
<span class="line" id="L353"><span class="tok-comment">/// Similar to `parse` except instead of fully parsing, it only determines the CPU</span></span>
<span class="line" id="L354"><span class="tok-comment">/// architecture and returns it if it can be determined, and returns `null` otherwise.</span></span>
<span class="line" id="L355"><span class="tok-comment">/// This is intended to be used if the API user of Query needs to learn the</span></span>
<span class="line" id="L356"><span class="tok-comment">/// target CPU architecture in order to fully populate `ParseOptions`.</span></span>
<span class="line" id="L357"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">parseCpuArch</span>(args: ParseOptions) ?Target.Cpu.Arch {</span>
<span class="line" id="L358">    <span class="tok-kw">var</span> it = mem.splitScalar(<span class="tok-type">u8</span>, args.arch_os_abi, <span class="tok-str">'-'</span>);</span>
<span class="line" id="L359">    <span class="tok-kw">const</span> arch_name = it.first();</span>
<span class="line" id="L360">    <span class="tok-kw">const</span> arch_is_native = mem.eql(<span class="tok-type">u8</span>, arch_name, <span class="tok-str">&quot;native&quot;</span>);</span>
<span class="line" id="L361">    <span class="tok-kw">if</span> (arch_is_native) {</span>
<span class="line" id="L362">        <span class="tok-kw">return</span> builtin.cpu.arch;</span>
<span class="line" id="L363">    } <span class="tok-kw">else</span> {</span>
<span class="line" id="L364">        <span class="tok-kw">return</span> std.meta.stringToEnum(Target.Cpu.Arch, arch_name);</span>
<span class="line" id="L365">    }</span>
<span class="line" id="L366">}</span>
<span class="line" id="L367"></span>
<span class="line" id="L368"><span class="tok-comment">/// Similar to `SemanticVersion.parse`, but with following changes:</span></span>
<span class="line" id="L369"><span class="tok-comment">/// * Leading zeroes are allowed.</span></span>
<span class="line" id="L370"><span class="tok-comment">/// * Supports only 2 or 3 version components (major, minor, [patch]). If 3-rd component is omitted, it will be 0.</span></span>
<span class="line" id="L371"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">parseVersion</span>(ver: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>) <span class="tok-kw">error</span>{ InvalidVersion, Overflow }!SemanticVersion {</span>
<span class="line" id="L372">    <span class="tok-kw">const</span> parseVersionComponentFn = (<span class="tok-kw">struct</span> {</span>
<span class="line" id="L373">        <span class="tok-kw">fn</span> <span class="tok-fn">parseVersionComponentInner</span>(component: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>) <span class="tok-kw">error</span>{ InvalidVersion, Overflow }!<span class="tok-type">usize</span> {</span>
<span class="line" id="L374">            <span class="tok-kw">return</span> std.fmt.parseUnsigned(<span class="tok-type">usize</span>, component, <span class="tok-number">10</span>) <span class="tok-kw">catch</span> |err| <span class="tok-kw">switch</span> (err) {</span>
<span class="line" id="L375">                <span class="tok-kw">error</span>.InvalidCharacter =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.InvalidVersion,</span>
<span class="line" id="L376">                <span class="tok-kw">error</span>.Overflow =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.Overflow,</span>
<span class="line" id="L377">            };</span>
<span class="line" id="L378">        }</span>
<span class="line" id="L379">    }).parseVersionComponentInner;</span>
<span class="line" id="L380">    <span class="tok-kw">var</span> version_components = mem.splitScalar(<span class="tok-type">u8</span>, ver, <span class="tok-str">'.'</span>);</span>
<span class="line" id="L381">    <span class="tok-kw">const</span> major = version_components.first();</span>
<span class="line" id="L382">    <span class="tok-kw">const</span> minor = version_components.next() <span class="tok-kw">orelse</span> <span class="tok-kw">return</span> <span class="tok-kw">error</span>.InvalidVersion;</span>
<span class="line" id="L383">    <span class="tok-kw">const</span> patch = version_components.next() <span class="tok-kw">orelse</span> <span class="tok-str">&quot;0&quot;</span>;</span>
<span class="line" id="L384">    <span class="tok-kw">if</span> (version_components.next() != <span class="tok-null">null</span>) <span class="tok-kw">return</span> <span class="tok-kw">error</span>.InvalidVersion;</span>
<span class="line" id="L385">    <span class="tok-kw">return</span> .{</span>
<span class="line" id="L386">        .major = <span class="tok-kw">try</span> parseVersionComponentFn(major),</span>
<span class="line" id="L387">        .minor = <span class="tok-kw">try</span> parseVersionComponentFn(minor),</span>
<span class="line" id="L388">        .patch = <span class="tok-kw">try</span> parseVersionComponentFn(patch),</span>
<span class="line" id="L389">    };</span>
<span class="line" id="L390">}</span>
<span class="line" id="L391"></span>
<span class="line" id="L392"><span class="tok-kw">test</span> parseVersion {</span>
<span class="line" id="L393">    <span class="tok-kw">try</span> std.testing.expectError(<span class="tok-kw">error</span>.InvalidVersion, parseVersion(<span class="tok-str">&quot;1&quot;</span>));</span>
<span class="line" id="L394">    <span class="tok-kw">try</span> std.testing.expectEqual(SemanticVersion{ .major = <span class="tok-number">1</span>, .minor = <span class="tok-number">2</span>, .patch = <span class="tok-number">0</span> }, <span class="tok-kw">try</span> parseVersion(<span class="tok-str">&quot;1.2&quot;</span>));</span>
<span class="line" id="L395">    <span class="tok-kw">try</span> std.testing.expectEqual(SemanticVersion{ .major = <span class="tok-number">1</span>, .minor = <span class="tok-number">2</span>, .patch = <span class="tok-number">3</span> }, <span class="tok-kw">try</span> parseVersion(<span class="tok-str">&quot;1.2.3&quot;</span>));</span>
<span class="line" id="L396">    <span class="tok-kw">try</span> std.testing.expectError(<span class="tok-kw">error</span>.InvalidVersion, parseVersion(<span class="tok-str">&quot;1.2.3.4&quot;</span>));</span>
<span class="line" id="L397">}</span>
<span class="line" id="L398"></span>
<span class="line" id="L399"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">isNativeCpu</span>(self: Query) <span class="tok-type">bool</span> {</span>
<span class="line" id="L400">    <span class="tok-kw">return</span> self.cpu_arch == <span class="tok-null">null</span> <span class="tok-kw">and</span></span>
<span class="line" id="L401">        (self.cpu_model == .native <span class="tok-kw">or</span> self.cpu_model == .determined_by_cpu_arch) <span class="tok-kw">and</span></span>
<span class="line" id="L402">        self.cpu_features_sub.isEmpty() <span class="tok-kw">and</span> self.cpu_features_add.isEmpty();</span>
<span class="line" id="L403">}</span>
<span class="line" id="L404"></span>
<span class="line" id="L405"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">isNativeOs</span>(self: Query) <span class="tok-type">bool</span> {</span>
<span class="line" id="L406">    <span class="tok-kw">return</span> self.os_tag == <span class="tok-null">null</span> <span class="tok-kw">and</span> self.os_version_min == <span class="tok-null">null</span> <span class="tok-kw">and</span> self.os_version_max == <span class="tok-null">null</span> <span class="tok-kw">and</span></span>
<span class="line" id="L407">        self.dynamic_linker.get() == <span class="tok-null">null</span> <span class="tok-kw">and</span> self.glibc_version == <span class="tok-null">null</span>;</span>
<span class="line" id="L408">}</span>
<span class="line" id="L409"></span>
<span class="line" id="L410"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">isNativeAbi</span>(self: Query) <span class="tok-type">bool</span> {</span>
<span class="line" id="L411">    <span class="tok-kw">return</span> self.os_tag == <span class="tok-null">null</span> <span class="tok-kw">and</span> self.abi == <span class="tok-null">null</span>;</span>
<span class="line" id="L412">}</span>
<span class="line" id="L413"></span>
<span class="line" id="L414"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">isNative</span>(self: Query) <span class="tok-type">bool</span> {</span>
<span class="line" id="L415">    <span class="tok-kw">return</span> self.isNativeCpu() <span class="tok-kw">and</span> self.isNativeOs() <span class="tok-kw">and</span> self.isNativeAbi();</span>
<span class="line" id="L416">}</span>
<span class="line" id="L417"></span>
<span class="line" id="L418"><span class="tok-comment">/// Formats a version with the patch component omitted if it is zero,</span></span>
<span class="line" id="L419"><span class="tok-comment">/// unlike SemanticVersion.format which formats all its version components regardless.</span></span>
<span class="line" id="L420"><span class="tok-kw">fn</span> <span class="tok-fn">formatVersion</span>(version: SemanticVersion, writer: <span class="tok-kw">anytype</span>) !<span class="tok-type">void</span> {</span>
<span class="line" id="L421">    <span class="tok-kw">if</span> (version.patch == <span class="tok-number">0</span>) {</span>
<span class="line" id="L422">        <span class="tok-kw">try</span> writer.print(<span class="tok-str">&quot;{d}.{d}&quot;</span>, .{ version.major, version.minor });</span>
<span class="line" id="L423">    } <span class="tok-kw">else</span> {</span>
<span class="line" id="L424">        <span class="tok-kw">try</span> writer.print(<span class="tok-str">&quot;{d}.{d}.{d}&quot;</span>, .{ version.major, version.minor, version.patch });</span>
<span class="line" id="L425">    }</span>
<span class="line" id="L426">}</span>
<span class="line" id="L427"></span>
<span class="line" id="L428"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">zigTriple</span>(self: Query, allocator: Allocator) Allocator.Error![]<span class="tok-type">u8</span> {</span>
<span class="line" id="L429">    <span class="tok-kw">if</span> (self.isNative()) {</span>
<span class="line" id="L430">        <span class="tok-kw">return</span> allocator.dupe(<span class="tok-type">u8</span>, <span class="tok-str">&quot;native&quot;</span>);</span>
<span class="line" id="L431">    }</span>
<span class="line" id="L432"></span>
<span class="line" id="L433">    <span class="tok-kw">const</span> arch_name = <span class="tok-kw">if</span> (self.cpu_arch) |arch| <span class="tok-builtin">@tagName</span>(arch) <span class="tok-kw">else</span> <span class="tok-str">&quot;native&quot;</span>;</span>
<span class="line" id="L434">    <span class="tok-kw">const</span> os_name = <span class="tok-kw">if</span> (self.os_tag) |os_tag| <span class="tok-builtin">@tagName</span>(os_tag) <span class="tok-kw">else</span> <span class="tok-str">&quot;native&quot;</span>;</span>
<span class="line" id="L435"></span>
<span class="line" id="L436">    <span class="tok-kw">var</span> result = std.ArrayList(<span class="tok-type">u8</span>).init(allocator);</span>
<span class="line" id="L437">    <span class="tok-kw">defer</span> result.deinit();</span>
<span class="line" id="L438"></span>
<span class="line" id="L439">    <span class="tok-kw">try</span> result.writer().print(<span class="tok-str">&quot;{s}-{s}&quot;</span>, .{ arch_name, os_name });</span>
<span class="line" id="L440"></span>
<span class="line" id="L441">    <span class="tok-comment">// The zig target syntax does not allow specifying a max os version with no min, so</span>
</span>
<span class="line" id="L442">    <span class="tok-comment">// if either are present, we need the min.</span>
</span>
<span class="line" id="L443">    <span class="tok-kw">if</span> (self.os_version_min) |min| {</span>
<span class="line" id="L444">        <span class="tok-kw">switch</span> (min) {</span>
<span class="line" id="L445">            .none =&gt; {},</span>
<span class="line" id="L446">            .semver =&gt; |v| {</span>
<span class="line" id="L447">                <span class="tok-kw">try</span> result.writer().writeAll(<span class="tok-str">&quot;.&quot;</span>);</span>
<span class="line" id="L448">                <span class="tok-kw">try</span> formatVersion(v, result.writer());</span>
<span class="line" id="L449">            },</span>
<span class="line" id="L450">            .windows =&gt; |v| {</span>
<span class="line" id="L451">                <span class="tok-kw">try</span> result.writer().print(<span class="tok-str">&quot;{s}&quot;</span>, .{v});</span>
<span class="line" id="L452">            },</span>
<span class="line" id="L453">        }</span>
<span class="line" id="L454">    }</span>
<span class="line" id="L455">    <span class="tok-kw">if</span> (self.os_version_max) |max| {</span>
<span class="line" id="L456">        <span class="tok-kw">switch</span> (max) {</span>
<span class="line" id="L457">            .none =&gt; {},</span>
<span class="line" id="L458">            .semver =&gt; |v| {</span>
<span class="line" id="L459">                <span class="tok-kw">try</span> result.writer().writeAll(<span class="tok-str">&quot;...&quot;</span>);</span>
<span class="line" id="L460">                <span class="tok-kw">try</span> formatVersion(v, result.writer());</span>
<span class="line" id="L461">            },</span>
<span class="line" id="L462">            .windows =&gt; |v| {</span>
<span class="line" id="L463">                <span class="tok-comment">// This is counting on a custom format() function defined on `WindowsVersion`</span>
</span>
<span class="line" id="L464">                <span class="tok-comment">// to add a prefix '.' and make there be a total of three dots.</span>
</span>
<span class="line" id="L465">                <span class="tok-kw">try</span> result.writer().print(<span class="tok-str">&quot;..{s}&quot;</span>, .{v});</span>
<span class="line" id="L466">            },</span>
<span class="line" id="L467">        }</span>
<span class="line" id="L468">    }</span>
<span class="line" id="L469"></span>
<span class="line" id="L470">    <span class="tok-kw">if</span> (self.glibc_version) |v| {</span>
<span class="line" id="L471">        <span class="tok-kw">const</span> name = <span class="tok-kw">if</span> (self.abi) |abi| <span class="tok-builtin">@tagName</span>(abi) <span class="tok-kw">else</span> <span class="tok-str">&quot;gnu&quot;</span>;</span>
<span class="line" id="L472">        <span class="tok-kw">try</span> result.ensureUnusedCapacity(name.len + <span class="tok-number">2</span>);</span>
<span class="line" id="L473">        result.appendAssumeCapacity(<span class="tok-str">'-'</span>);</span>
<span class="line" id="L474">        result.appendSliceAssumeCapacity(name);</span>
<span class="line" id="L475">        result.appendAssumeCapacity(<span class="tok-str">'.'</span>);</span>
<span class="line" id="L476">        <span class="tok-kw">try</span> formatVersion(v, result.writer());</span>
<span class="line" id="L477">    } <span class="tok-kw">else</span> <span class="tok-kw">if</span> (self.abi) |abi| {</span>
<span class="line" id="L478">        <span class="tok-kw">const</span> name = <span class="tok-builtin">@tagName</span>(abi);</span>
<span class="line" id="L479">        <span class="tok-kw">try</span> result.ensureUnusedCapacity(name.len + <span class="tok-number">1</span>);</span>
<span class="line" id="L480">        result.appendAssumeCapacity(<span class="tok-str">'-'</span>);</span>
<span class="line" id="L481">        result.appendSliceAssumeCapacity(name);</span>
<span class="line" id="L482">    }</span>
<span class="line" id="L483"></span>
<span class="line" id="L484">    <span class="tok-kw">return</span> result.toOwnedSlice();</span>
<span class="line" id="L485">}</span>
<span class="line" id="L486"></span>
<span class="line" id="L487"><span class="tok-comment">/// Renders the query into a textual representation that can be parsed via the</span></span>
<span class="line" id="L488"><span class="tok-comment">/// `-mcpu` flag passed to the Zig compiler.</span></span>
<span class="line" id="L489"><span class="tok-comment">/// Appends the result to `buffer`.</span></span>
<span class="line" id="L490"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">serializeCpu</span>(q: Query, buffer: *std.ArrayList(<span class="tok-type">u8</span>)) Allocator.Error!<span class="tok-type">void</span> {</span>
<span class="line" id="L491">    <span class="tok-kw">try</span> buffer.ensureUnusedCapacity(<span class="tok-number">8</span>);</span>
<span class="line" id="L492">    <span class="tok-kw">switch</span> (q.cpu_model) {</span>
<span class="line" id="L493">        .native =&gt; {</span>
<span class="line" id="L494">            buffer.appendSliceAssumeCapacity(<span class="tok-str">&quot;native&quot;</span>);</span>
<span class="line" id="L495">        },</span>
<span class="line" id="L496">        .baseline =&gt; {</span>
<span class="line" id="L497">            buffer.appendSliceAssumeCapacity(<span class="tok-str">&quot;baseline&quot;</span>);</span>
<span class="line" id="L498">        },</span>
<span class="line" id="L499">        .determined_by_cpu_arch =&gt; {</span>
<span class="line" id="L500">            <span class="tok-kw">if</span> (q.cpu_arch == <span class="tok-null">null</span>) {</span>
<span class="line" id="L501">                buffer.appendSliceAssumeCapacity(<span class="tok-str">&quot;native&quot;</span>);</span>
<span class="line" id="L502">            } <span class="tok-kw">else</span> {</span>
<span class="line" id="L503">                buffer.appendSliceAssumeCapacity(<span class="tok-str">&quot;baseline&quot;</span>);</span>
<span class="line" id="L504">            }</span>
<span class="line" id="L505">        },</span>
<span class="line" id="L506">        .explicit =&gt; |model| {</span>
<span class="line" id="L507">            <span class="tok-kw">try</span> buffer.appendSlice(model.name);</span>
<span class="line" id="L508">        },</span>
<span class="line" id="L509">    }</span>
<span class="line" id="L510"></span>
<span class="line" id="L511">    <span class="tok-kw">if</span> (q.cpu_features_add.isEmpty() <span class="tok-kw">and</span> q.cpu_features_sub.isEmpty()) {</span>
<span class="line" id="L512">        <span class="tok-comment">// The CPU name alone is sufficient.</span>
</span>
<span class="line" id="L513">        <span class="tok-kw">return</span>;</span>
<span class="line" id="L514">    }</span>
<span class="line" id="L515"></span>
<span class="line" id="L516">    <span class="tok-kw">const</span> cpu_arch = q.cpu_arch <span class="tok-kw">orelse</span> builtin.cpu.arch;</span>
<span class="line" id="L517">    <span class="tok-kw">const</span> all_features = cpu_arch.allFeaturesList();</span>
<span class="line" id="L518"></span>
<span class="line" id="L519">    <span class="tok-kw">for</span> (all_features, <span class="tok-number">0</span>..) |feature, i_usize| {</span>
<span class="line" id="L520">        <span class="tok-kw">const</span> i: Target.Cpu.Feature.Set.Index = <span class="tok-builtin">@intCast</span>(i_usize);</span>
<span class="line" id="L521">        <span class="tok-kw">try</span> buffer.ensureUnusedCapacity(feature.name.len + <span class="tok-number">1</span>);</span>
<span class="line" id="L522">        <span class="tok-kw">if</span> (q.cpu_features_sub.isEnabled(i)) {</span>
<span class="line" id="L523">            buffer.appendAssumeCapacity(<span class="tok-str">'-'</span>);</span>
<span class="line" id="L524">            buffer.appendSliceAssumeCapacity(feature.name);</span>
<span class="line" id="L525">        } <span class="tok-kw">else</span> <span class="tok-kw">if</span> (q.cpu_features_add.isEnabled(i)) {</span>
<span class="line" id="L526">            buffer.appendAssumeCapacity(<span class="tok-str">'+'</span>);</span>
<span class="line" id="L527">            buffer.appendSliceAssumeCapacity(feature.name);</span>
<span class="line" id="L528">        }</span>
<span class="line" id="L529">    }</span>
<span class="line" id="L530">}</span>
<span class="line" id="L531"></span>
<span class="line" id="L532"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">serializeCpuAlloc</span>(q: Query, ally: Allocator) Allocator.Error![]<span class="tok-type">u8</span> {</span>
<span class="line" id="L533">    <span class="tok-kw">var</span> buffer = std.ArrayList(<span class="tok-type">u8</span>).init(ally);</span>
<span class="line" id="L534">    <span class="tok-kw">try</span> serializeCpu(q, &amp;buffer);</span>
<span class="line" id="L535">    <span class="tok-kw">return</span> buffer.toOwnedSlice();</span>
<span class="line" id="L536">}</span>
<span class="line" id="L537"></span>
<span class="line" id="L538"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">allocDescription</span>(self: Query, allocator: Allocator) ![]<span class="tok-type">u8</span> {</span>
<span class="line" id="L539">    <span class="tok-comment">// TODO is there anything else worthy of the description that is not</span>
</span>
<span class="line" id="L540">    <span class="tok-comment">// already captured in the triple?</span>
</span>
<span class="line" id="L541">    <span class="tok-kw">return</span> self.zigTriple(allocator);</span>
<span class="line" id="L542">}</span>
<span class="line" id="L543"></span>
<span class="line" id="L544"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">setGnuLibCVersion</span>(self: *Query, major: <span class="tok-type">u32</span>, minor: <span class="tok-type">u32</span>, patch: <span class="tok-type">u32</span>) <span class="tok-type">void</span> {</span>
<span class="line" id="L545">    self.glibc_version = SemanticVersion{ .major = major, .minor = minor, .patch = patch };</span>
<span class="line" id="L546">}</span>
<span class="line" id="L547"></span>
<span class="line" id="L548"><span class="tok-kw">fn</span> <span class="tok-fn">parseOs</span>(result: *Query, diags: *ParseOptions.Diagnostics, text: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>) !<span class="tok-type">void</span> {</span>
<span class="line" id="L549">    <span class="tok-kw">var</span> it = mem.splitScalar(<span class="tok-type">u8</span>, text, <span class="tok-str">'.'</span>);</span>
<span class="line" id="L550">    <span class="tok-kw">const</span> os_name = it.first();</span>
<span class="line" id="L551">    diags.os_name = os_name;</span>
<span class="line" id="L552">    <span class="tok-kw">const</span> os_is_native = mem.eql(<span class="tok-type">u8</span>, os_name, <span class="tok-str">&quot;native&quot;</span>);</span>
<span class="line" id="L553">    <span class="tok-kw">if</span> (!os_is_native) {</span>
<span class="line" id="L554">        result.os_tag = std.meta.stringToEnum(Target.Os.Tag, os_name) <span class="tok-kw">orelse</span></span>
<span class="line" id="L555">            <span class="tok-kw">return</span> <span class="tok-kw">error</span>.UnknownOperatingSystem;</span>
<span class="line" id="L556">    }</span>
<span class="line" id="L557">    <span class="tok-kw">const</span> tag = result.os_tag <span class="tok-kw">orelse</span> builtin.os.tag;</span>
<span class="line" id="L558">    diags.os_tag = tag;</span>
<span class="line" id="L559"></span>
<span class="line" id="L560">    <span class="tok-kw">const</span> version_text = it.rest();</span>
<span class="line" id="L561">    <span class="tok-kw">if</span> (it.next() == <span class="tok-null">null</span>) <span class="tok-kw">return</span>;</span>
<span class="line" id="L562"></span>
<span class="line" id="L563">    <span class="tok-kw">switch</span> (tag) {</span>
<span class="line" id="L564">        .freestanding,</span>
<span class="line" id="L565">        .ananas,</span>
<span class="line" id="L566">        .cloudabi,</span>
<span class="line" id="L567">        .fuchsia,</span>
<span class="line" id="L568">        .kfreebsd,</span>
<span class="line" id="L569">        .lv2,</span>
<span class="line" id="L570">        .solaris,</span>
<span class="line" id="L571">        .illumos,</span>
<span class="line" id="L572">        .zos,</span>
<span class="line" id="L573">        .haiku,</span>
<span class="line" id="L574">        .minix,</span>
<span class="line" id="L575">        .rtems,</span>
<span class="line" id="L576">        .nacl,</span>
<span class="line" id="L577">        .aix,</span>
<span class="line" id="L578">        .cuda,</span>
<span class="line" id="L579">        .nvcl,</span>
<span class="line" id="L580">        .amdhsa,</span>
<span class="line" id="L581">        .ps4,</span>
<span class="line" id="L582">        .ps5,</span>
<span class="line" id="L583">        .elfiamcu,</span>
<span class="line" id="L584">        .mesa3d,</span>
<span class="line" id="L585">        .contiki,</span>
<span class="line" id="L586">        .amdpal,</span>
<span class="line" id="L587">        .hermit,</span>
<span class="line" id="L588">        .hurd,</span>
<span class="line" id="L589">        .wasi,</span>
<span class="line" id="L590">        .emscripten,</span>
<span class="line" id="L591">        .uefi,</span>
<span class="line" id="L592">        .opencl,</span>
<span class="line" id="L593">        .glsl450,</span>
<span class="line" id="L594">        .vulkan,</span>
<span class="line" id="L595">        .plan9,</span>
<span class="line" id="L596">        .driverkit,</span>
<span class="line" id="L597">        .shadermodel,</span>
<span class="line" id="L598">        .liteos,</span>
<span class="line" id="L599">        .other,</span>
<span class="line" id="L600">        =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.InvalidOperatingSystemVersion,</span>
<span class="line" id="L601"></span>
<span class="line" id="L602">        .freebsd,</span>
<span class="line" id="L603">        .macos,</span>
<span class="line" id="L604">        .ios,</span>
<span class="line" id="L605">        .tvos,</span>
<span class="line" id="L606">        .watchos,</span>
<span class="line" id="L607">        .netbsd,</span>
<span class="line" id="L608">        .openbsd,</span>
<span class="line" id="L609">        .linux,</span>
<span class="line" id="L610">        .dragonfly,</span>
<span class="line" id="L611">        =&gt; {</span>
<span class="line" id="L612">            <span class="tok-kw">var</span> range_it = mem.splitSequence(<span class="tok-type">u8</span>, version_text, <span class="tok-str">&quot;...&quot;</span>);</span>
<span class="line" id="L613"></span>
<span class="line" id="L614">            <span class="tok-kw">const</span> min_text = range_it.next().?;</span>
<span class="line" id="L615">            <span class="tok-kw">const</span> min_ver = parseVersion(min_text) <span class="tok-kw">catch</span> |err| <span class="tok-kw">switch</span> (err) {</span>
<span class="line" id="L616">                <span class="tok-kw">error</span>.Overflow =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.InvalidOperatingSystemVersion,</span>
<span class="line" id="L617">                <span class="tok-kw">error</span>.InvalidVersion =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.InvalidOperatingSystemVersion,</span>
<span class="line" id="L618">            };</span>
<span class="line" id="L619">            result.os_version_min = .{ .semver = min_ver };</span>
<span class="line" id="L620"></span>
<span class="line" id="L621">            <span class="tok-kw">const</span> max_text = range_it.next() <span class="tok-kw">orelse</span> <span class="tok-kw">return</span>;</span>
<span class="line" id="L622">            <span class="tok-kw">const</span> max_ver = parseVersion(max_text) <span class="tok-kw">catch</span> |err| <span class="tok-kw">switch</span> (err) {</span>
<span class="line" id="L623">                <span class="tok-kw">error</span>.Overflow =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.InvalidOperatingSystemVersion,</span>
<span class="line" id="L624">                <span class="tok-kw">error</span>.InvalidVersion =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.InvalidOperatingSystemVersion,</span>
<span class="line" id="L625">            };</span>
<span class="line" id="L626">            result.os_version_max = .{ .semver = max_ver };</span>
<span class="line" id="L627">        },</span>
<span class="line" id="L628"></span>
<span class="line" id="L629">        .windows =&gt; {</span>
<span class="line" id="L630">            <span class="tok-kw">var</span> range_it = mem.splitSequence(<span class="tok-type">u8</span>, version_text, <span class="tok-str">&quot;...&quot;</span>);</span>
<span class="line" id="L631"></span>
<span class="line" id="L632">            <span class="tok-kw">const</span> min_text = range_it.first();</span>
<span class="line" id="L633">            <span class="tok-kw">const</span> min_ver = std.meta.stringToEnum(Target.Os.WindowsVersion, min_text) <span class="tok-kw">orelse</span></span>
<span class="line" id="L634">                <span class="tok-kw">return</span> <span class="tok-kw">error</span>.InvalidOperatingSystemVersion;</span>
<span class="line" id="L635">            result.os_version_min = .{ .windows = min_ver };</span>
<span class="line" id="L636"></span>
<span class="line" id="L637">            <span class="tok-kw">const</span> max_text = range_it.next() <span class="tok-kw">orelse</span> <span class="tok-kw">return</span>;</span>
<span class="line" id="L638">            <span class="tok-kw">const</span> max_ver = std.meta.stringToEnum(Target.Os.WindowsVersion, max_text) <span class="tok-kw">orelse</span></span>
<span class="line" id="L639">                <span class="tok-kw">return</span> <span class="tok-kw">error</span>.InvalidOperatingSystemVersion;</span>
<span class="line" id="L640">            result.os_version_max = .{ .windows = max_ver };</span>
<span class="line" id="L641">        },</span>
<span class="line" id="L642">    }</span>
<span class="line" id="L643">}</span>
<span class="line" id="L644"></span>
<span class="line" id="L645"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">eql</span>(a: Query, b: Query) <span class="tok-type">bool</span> {</span>
<span class="line" id="L646">    <span class="tok-kw">if</span> (a.cpu_arch != b.cpu_arch) <span class="tok-kw">return</span> <span class="tok-null">false</span>;</span>
<span class="line" id="L647">    <span class="tok-kw">if</span> (!a.cpu_model.eql(b.cpu_model)) <span class="tok-kw">return</span> <span class="tok-null">false</span>;</span>
<span class="line" id="L648">    <span class="tok-kw">if</span> (!a.cpu_features_add.eql(b.cpu_features_add)) <span class="tok-kw">return</span> <span class="tok-null">false</span>;</span>
<span class="line" id="L649">    <span class="tok-kw">if</span> (!a.cpu_features_sub.eql(b.cpu_features_sub)) <span class="tok-kw">return</span> <span class="tok-null">false</span>;</span>
<span class="line" id="L650">    <span class="tok-kw">if</span> (a.os_tag != b.os_tag) <span class="tok-kw">return</span> <span class="tok-null">false</span>;</span>
<span class="line" id="L651">    <span class="tok-kw">if</span> (!OsVersion.eqlOpt(a.os_version_min, b.os_version_min)) <span class="tok-kw">return</span> <span class="tok-null">false</span>;</span>
<span class="line" id="L652">    <span class="tok-kw">if</span> (!OsVersion.eqlOpt(a.os_version_max, b.os_version_max)) <span class="tok-kw">return</span> <span class="tok-null">false</span>;</span>
<span class="line" id="L653">    <span class="tok-kw">if</span> (!versionEqualOpt(a.glibc_version, b.glibc_version)) <span class="tok-kw">return</span> <span class="tok-null">false</span>;</span>
<span class="line" id="L654">    <span class="tok-kw">if</span> (a.abi != b.abi) <span class="tok-kw">return</span> <span class="tok-null">false</span>;</span>
<span class="line" id="L655">    <span class="tok-kw">if</span> (!a.dynamic_linker.eql(b.dynamic_linker)) <span class="tok-kw">return</span> <span class="tok-null">false</span>;</span>
<span class="line" id="L656">    <span class="tok-kw">if</span> (a.ofmt != b.ofmt) <span class="tok-kw">return</span> <span class="tok-null">false</span>;</span>
<span class="line" id="L657"></span>
<span class="line" id="L658">    <span class="tok-kw">return</span> <span class="tok-null">true</span>;</span>
<span class="line" id="L659">}</span>
<span class="line" id="L660"></span>
<span class="line" id="L661"><span class="tok-kw">fn</span> <span class="tok-fn">versionEqualOpt</span>(a: ?SemanticVersion, b: ?SemanticVersion) <span class="tok-type">bool</span> {</span>
<span class="line" id="L662">    <span class="tok-kw">if</span> (a == <span class="tok-null">null</span> <span class="tok-kw">and</span> b == <span class="tok-null">null</span>) <span class="tok-kw">return</span> <span class="tok-null">true</span>;</span>
<span class="line" id="L663">    <span class="tok-kw">if</span> (a == <span class="tok-null">null</span> <span class="tok-kw">or</span> b == <span class="tok-null">null</span>) <span class="tok-kw">return</span> <span class="tok-null">false</span>;</span>
<span class="line" id="L664">    <span class="tok-kw">return</span> SemanticVersion.order(a.?, b.?) == .eq;</span>
<span class="line" id="L665">}</span>
<span class="line" id="L666"></span>
<span class="line" id="L667"><span class="tok-kw">const</span> Query = <span class="tok-builtin">@This</span>();</span>
<span class="line" id="L668"><span class="tok-kw">const</span> std = <span class="tok-builtin">@import</span>(<span class="tok-str">&quot;../std.zig&quot;</span>);</span>
<span class="line" id="L669"><span class="tok-kw">const</span> builtin = <span class="tok-builtin">@import</span>(<span class="tok-str">&quot;builtin&quot;</span>);</span>
<span class="line" id="L670"><span class="tok-kw">const</span> assert = std.debug.assert;</span>
<span class="line" id="L671"><span class="tok-kw">const</span> Target = std.Target;</span>
<span class="line" id="L672"><span class="tok-kw">const</span> mem = std.mem;</span>
<span class="line" id="L673"><span class="tok-kw">const</span> Allocator = std.mem.Allocator;</span>
<span class="line" id="L674"></span>
<span class="line" id="L675"><span class="tok-kw">test</span> parse {</span>
<span class="line" id="L676">    <span class="tok-kw">if</span> (builtin.target.isGnuLibC()) {</span>
<span class="line" id="L677">        <span class="tok-kw">var</span> query = <span class="tok-kw">try</span> Query.parse(.{});</span>
<span class="line" id="L678">        query.setGnuLibCVersion(<span class="tok-number">2</span>, <span class="tok-number">1</span>, <span class="tok-number">1</span>);</span>
<span class="line" id="L679"></span>
<span class="line" id="L680">        <span class="tok-kw">const</span> text = <span class="tok-kw">try</span> query.zigTriple(std.testing.allocator);</span>
<span class="line" id="L681">        <span class="tok-kw">defer</span> std.testing.allocator.free(text);</span>
<span class="line" id="L682"></span>
<span class="line" id="L683">        <span class="tok-kw">var</span> buf: [<span class="tok-number">256</span>]<span class="tok-type">u8</span> = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L684">        <span class="tok-kw">const</span> triple = std.fmt.bufPrint(</span>
<span class="line" id="L685">            buf[<span class="tok-number">0</span>..],</span>
<span class="line" id="L686">            <span class="tok-str">&quot;native-native-{s}.2.1.1&quot;</span>,</span>
<span class="line" id="L687">            .{<span class="tok-builtin">@tagName</span>(builtin.target.abi)},</span>
<span class="line" id="L688">        ) <span class="tok-kw">catch</span> <span class="tok-kw">unreachable</span>;</span>
<span class="line" id="L689"></span>
<span class="line" id="L690">        <span class="tok-kw">try</span> std.testing.expectEqualSlices(<span class="tok-type">u8</span>, triple, text);</span>
<span class="line" id="L691">    }</span>
<span class="line" id="L692">    {</span>
<span class="line" id="L693">        <span class="tok-kw">const</span> query = <span class="tok-kw">try</span> Query.parse(.{</span>
<span class="line" id="L694">            .arch_os_abi = <span class="tok-str">&quot;aarch64-linux&quot;</span>,</span>
<span class="line" id="L695">            .cpu_features = <span class="tok-str">&quot;native&quot;</span>,</span>
<span class="line" id="L696">        });</span>
<span class="line" id="L697"></span>
<span class="line" id="L698">        <span class="tok-kw">try</span> std.testing.expect(query.cpu_arch.? == .aarch64);</span>
<span class="line" id="L699">        <span class="tok-kw">try</span> std.testing.expect(query.cpu_model == .native);</span>
<span class="line" id="L700">    }</span>
<span class="line" id="L701">    {</span>
<span class="line" id="L702">        <span class="tok-kw">const</span> query = <span class="tok-kw">try</span> Query.parse(.{ .arch_os_abi = <span class="tok-str">&quot;native&quot;</span> });</span>
<span class="line" id="L703"></span>
<span class="line" id="L704">        <span class="tok-kw">try</span> std.testing.expect(query.cpu_arch == <span class="tok-null">null</span>);</span>
<span class="line" id="L705">        <span class="tok-kw">try</span> std.testing.expect(query.isNative());</span>
<span class="line" id="L706"></span>
<span class="line" id="L707">        <span class="tok-kw">const</span> text = <span class="tok-kw">try</span> query.zigTriple(std.testing.allocator);</span>
<span class="line" id="L708">        <span class="tok-kw">defer</span> std.testing.allocator.free(text);</span>
<span class="line" id="L709">        <span class="tok-kw">try</span> std.testing.expectEqualSlices(<span class="tok-type">u8</span>, <span class="tok-str">&quot;native&quot;</span>, text);</span>
<span class="line" id="L710">    }</span>
<span class="line" id="L711">    {</span>
<span class="line" id="L712">        <span class="tok-kw">const</span> query = <span class="tok-kw">try</span> Query.parse(.{</span>
<span class="line" id="L713">            .arch_os_abi = <span class="tok-str">&quot;x86_64-linux-gnu&quot;</span>,</span>
<span class="line" id="L714">            .cpu_features = <span class="tok-str">&quot;x86_64-sse-sse2-avx-cx8&quot;</span>,</span>
<span class="line" id="L715">        });</span>
<span class="line" id="L716">        <span class="tok-kw">const</span> target = <span class="tok-kw">try</span> std.zig.system.resolveTargetQuery(query);</span>
<span class="line" id="L717"></span>
<span class="line" id="L718">        <span class="tok-kw">try</span> std.testing.expect(target.os.tag == .linux);</span>
<span class="line" id="L719">        <span class="tok-kw">try</span> std.testing.expect(target.abi == .gnu);</span>
<span class="line" id="L720">        <span class="tok-kw">try</span> std.testing.expect(target.cpu.arch == .x86_64);</span>
<span class="line" id="L721">        <span class="tok-kw">try</span> std.testing.expect(!Target.x86.featureSetHas(target.cpu.features, .sse));</span>
<span class="line" id="L722">        <span class="tok-kw">try</span> std.testing.expect(!Target.x86.featureSetHas(target.cpu.features, .avx));</span>
<span class="line" id="L723">        <span class="tok-kw">try</span> std.testing.expect(!Target.x86.featureSetHas(target.cpu.features, .cx8));</span>
<span class="line" id="L724">        <span class="tok-kw">try</span> std.testing.expect(Target.x86.featureSetHas(target.cpu.features, .cmov));</span>
<span class="line" id="L725">        <span class="tok-kw">try</span> std.testing.expect(Target.x86.featureSetHas(target.cpu.features, .fxsr));</span>
<span class="line" id="L726"></span>
<span class="line" id="L727">        <span class="tok-kw">try</span> std.testing.expect(Target.x86.featureSetHasAny(target.cpu.features, .{ .sse, .avx, .cmov }));</span>
<span class="line" id="L728">        <span class="tok-kw">try</span> std.testing.expect(!Target.x86.featureSetHasAny(target.cpu.features, .{ .sse, .avx }));</span>
<span class="line" id="L729">        <span class="tok-kw">try</span> std.testing.expect(Target.x86.featureSetHasAll(target.cpu.features, .{ .mmx, .x87 }));</span>
<span class="line" id="L730">        <span class="tok-kw">try</span> std.testing.expect(!Target.x86.featureSetHasAll(target.cpu.features, .{ .mmx, .x87, .sse }));</span>
<span class="line" id="L731"></span>
<span class="line" id="L732">        <span class="tok-kw">const</span> text = <span class="tok-kw">try</span> query.zigTriple(std.testing.allocator);</span>
<span class="line" id="L733">        <span class="tok-kw">defer</span> std.testing.allocator.free(text);</span>
<span class="line" id="L734">        <span class="tok-kw">try</span> std.testing.expectEqualSlices(<span class="tok-type">u8</span>, <span class="tok-str">&quot;x86_64-linux-gnu&quot;</span>, text);</span>
<span class="line" id="L735">    }</span>
<span class="line" id="L736">    {</span>
<span class="line" id="L737">        <span class="tok-kw">const</span> query = <span class="tok-kw">try</span> Query.parse(.{</span>
<span class="line" id="L738">            .arch_os_abi = <span class="tok-str">&quot;arm-linux-musleabihf&quot;</span>,</span>
<span class="line" id="L739">            .cpu_features = <span class="tok-str">&quot;generic+v8a&quot;</span>,</span>
<span class="line" id="L740">        });</span>
<span class="line" id="L741">        <span class="tok-kw">const</span> target = <span class="tok-kw">try</span> std.zig.system.resolveTargetQuery(query);</span>
<span class="line" id="L742"></span>
<span class="line" id="L743">        <span class="tok-kw">try</span> std.testing.expect(target.os.tag == .linux);</span>
<span class="line" id="L744">        <span class="tok-kw">try</span> std.testing.expect(target.abi == .musleabihf);</span>
<span class="line" id="L745">        <span class="tok-kw">try</span> std.testing.expect(target.cpu.arch == .arm);</span>
<span class="line" id="L746">        <span class="tok-kw">try</span> std.testing.expect(target.cpu.model == &amp;Target.arm.cpu.generic);</span>
<span class="line" id="L747">        <span class="tok-kw">try</span> std.testing.expect(Target.arm.featureSetHas(target.cpu.features, .v8a));</span>
<span class="line" id="L748"></span>
<span class="line" id="L749">        <span class="tok-kw">const</span> text = <span class="tok-kw">try</span> query.zigTriple(std.testing.allocator);</span>
<span class="line" id="L750">        <span class="tok-kw">defer</span> std.testing.allocator.free(text);</span>
<span class="line" id="L751">        <span class="tok-kw">try</span> std.testing.expectEqualSlices(<span class="tok-type">u8</span>, <span class="tok-str">&quot;arm-linux-musleabihf&quot;</span>, text);</span>
<span class="line" id="L752">    }</span>
<span class="line" id="L753">    {</span>
<span class="line" id="L754">        <span class="tok-kw">const</span> query = <span class="tok-kw">try</span> Query.parse(.{</span>
<span class="line" id="L755">            .arch_os_abi = <span class="tok-str">&quot;aarch64-linux.3.10...4.4.1-gnu.2.27&quot;</span>,</span>
<span class="line" id="L756">            .cpu_features = <span class="tok-str">&quot;generic+v8a&quot;</span>,</span>
<span class="line" id="L757">        });</span>
<span class="line" id="L758">        <span class="tok-kw">const</span> target = <span class="tok-kw">try</span> std.zig.system.resolveTargetQuery(query);</span>
<span class="line" id="L759"></span>
<span class="line" id="L760">        <span class="tok-kw">try</span> std.testing.expect(target.cpu.arch == .aarch64);</span>
<span class="line" id="L761">        <span class="tok-kw">try</span> std.testing.expect(target.os.tag == .linux);</span>
<span class="line" id="L762">        <span class="tok-kw">try</span> std.testing.expect(target.os.version_range.linux.range.min.major == <span class="tok-number">3</span>);</span>
<span class="line" id="L763">        <span class="tok-kw">try</span> std.testing.expect(target.os.version_range.linux.range.min.minor == <span class="tok-number">10</span>);</span>
<span class="line" id="L764">        <span class="tok-kw">try</span> std.testing.expect(target.os.version_range.linux.range.min.patch == <span class="tok-number">0</span>);</span>
<span class="line" id="L765">        <span class="tok-kw">try</span> std.testing.expect(target.os.version_range.linux.range.max.major == <span class="tok-number">4</span>);</span>
<span class="line" id="L766">        <span class="tok-kw">try</span> std.testing.expect(target.os.version_range.linux.range.max.minor == <span class="tok-number">4</span>);</span>
<span class="line" id="L767">        <span class="tok-kw">try</span> std.testing.expect(target.os.version_range.linux.range.max.patch == <span class="tok-number">1</span>);</span>
<span class="line" id="L768">        <span class="tok-kw">try</span> std.testing.expect(target.os.version_range.linux.glibc.major == <span class="tok-number">2</span>);</span>
<span class="line" id="L769">        <span class="tok-kw">try</span> std.testing.expect(target.os.version_range.linux.glibc.minor == <span class="tok-number">27</span>);</span>
<span class="line" id="L770">        <span class="tok-kw">try</span> std.testing.expect(target.os.version_range.linux.glibc.patch == <span class="tok-number">0</span>);</span>
<span class="line" id="L771">        <span class="tok-kw">try</span> std.testing.expect(target.abi == .gnu);</span>
<span class="line" id="L772"></span>
<span class="line" id="L773">        <span class="tok-kw">const</span> text = <span class="tok-kw">try</span> query.zigTriple(std.testing.allocator);</span>
<span class="line" id="L774">        <span class="tok-kw">defer</span> std.testing.allocator.free(text);</span>
<span class="line" id="L775">        <span class="tok-kw">try</span> std.testing.expectEqualSlices(<span class="tok-type">u8</span>, <span class="tok-str">&quot;aarch64-linux.3.10...4.4.1-gnu.2.27&quot;</span>, text);</span>
<span class="line" id="L776">    }</span>
<span class="line" id="L777">}</span>
<span class="line" id="L778"></span>
</code></pre></body>
</html>