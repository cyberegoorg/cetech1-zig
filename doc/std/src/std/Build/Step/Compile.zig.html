<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">    <title>Build/Step/Compile.zig - source view</title>
    <link rel="icon" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAgklEQVR4AWMYWuD7EllJIM4G4g4g5oIJ/odhOJ8wToOxSTXgNxDHoeiBMfA4+wGShjyYOCkG/IGqWQziEzYAoUAeiF9D5U+DxEg14DRU7jWIT5IBIOdCxf+A+CQZAAoopEB7QJwBCBwHiip8UYmRdrAlDpIMgApwQZNnNii5Dq0MBgCxxycBnwEd+wAAAABJRU5ErkJggg==">
    <link rel="icon" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxNTMgMTQwIj48ZyBmaWxsPSIjRjdBNDFEIj48Zz48cG9seWdvbiBwb2ludHM9IjQ2LDIyIDI4LDQ0IDE5LDMwIi8+PHBvbHlnb24gcG9pbnRzPSI0NiwyMiAzMywzMyAyOCw0NCAyMiw0NCAyMiw5NSAzMSw5NSAyMCwxMDAgMTIsMTE3IDAsMTE3IDAsMjIiIHNoYXBlLXJlbmRlcmluZz0iY3Jpc3BFZGdlcyIvPjxwb2x5Z29uIHBvaW50cz0iMzEsOTUgMTIsMTE3IDQsMTA2Ii8+PC9nPjxnPjxwb2x5Z29uIHBvaW50cz0iNTYsMjIgNjIsMzYgMzcsNDQiLz48cG9seWdvbiBwb2ludHM9IjU2LDIyIDExMSwyMiAxMTEsNDQgMzcsNDQgNTYsMzIiIHNoYXBlLXJlbmRlcmluZz0iY3Jpc3BFZGdlcyIvPjxwb2x5Z29uIHBvaW50cz0iMTE2LDk1IDk3LDExNyA5MCwxMDQiLz48cG9seWdvbiBwb2ludHM9IjExNiw5NSAxMDAsMTA0IDk3LDExNyA0MiwxMTcgNDIsOTUiIHNoYXBlLXJlbmRlcmluZz0iY3Jpc3BFZGdlcyIvPjxwb2x5Z29uIHBvaW50cz0iMTUwLDAgNTIsMTE3IDMsMTQwIDEwMSwyMiIvPjwvZz48Zz48cG9seWdvbiBwb2ludHM9IjE0MSwyMiAxNDAsNDAgMTIyLDQ1Ii8+PHBvbHlnb24gcG9pbnRzPSIxNTMsMjIgMTUzLDExNyAxMDYsMTE3IDEyMCwxMDUgMTI1LDk1IDEzMSw5NSAxMzEsNDUgMTIyLDQ1IDEzMiwzNiAxNDEsMjIiIHNoYXBlLXJlbmRlcmluZz0iY3Jpc3BFZGdlcyIvPjxwb2x5Z29uIHBvaW50cz0iMTI1LDk1IDEzMCwxMTAgMTA2LDExNyIvPjwvZz48L2c+PC9zdmc+">
    <style>
      body{
        font-family: system-ui, -apple-system, Roboto, "Segoe UI", sans-serif;
        margin: 0;
        line-height: 1.5;
      }

      pre > code {
        display: block;
        overflow: auto;
        line-height: normal;
        margin: 0em;
      }
      .tok-kw {
          color: #333;
          font-weight: bold;
      }
      .tok-str {
          color: #d14;
      }
      .tok-builtin {
          color: #005C7A;
      }
      .tok-comment {
          color: #545454;
          font-style: italic;
      }
      .tok-fn {
          color: #900;
          font-weight: bold;
      }
      .tok-null {
          color: #005C5C;
      }
      .tok-number {
          color: #005C5C;
      }
      .tok-type {
          color: #458;
          font-weight: bold;
      }
      pre {
        counter-reset: line;
      }
      pre .line:before {
        counter-increment: line;
        content: counter(line);
        display: inline-block;
        padding-right: 1em;
        width: 2em;
        text-align: right;
        color: #999;
      }
      
      .line {
        width: 100%;
        display: inline-block;
      }
      .line:target {
        border-top: 1px solid #ccc;
        border-bottom: 1px solid #ccc;
        background: #fafafa;
      }

      @media (prefers-color-scheme: dark) {
        body{
            background:#222;
            color: #ccc;
        }
        pre > code {
            color: #ccc;
            background: #222;
            border: unset;
        }
        .line:target {
            border-top: 1px solid #444;
            border-bottom: 1px solid #444;
            background: #333;
        }
        .tok-kw {
            color: #eee;
        }
        .tok-str {
            color: #2e5;
        }
        .tok-builtin {
            color: #ff894c;
        }
        .tok-comment {
            color: #aa7;
        }
        .tok-fn {
            color: #B1A0F8;
        }
        .tok-null {
            color: #ff8080;
        }
        .tok-number {
            color: #ff8080;
        }
        .tok-type {
            color: #68f;
        }
      }
    </style>
</head>
<body>
<pre><code><span class="line" id="L1"><span class="tok-kw">const</span> builtin = <span class="tok-builtin">@import</span>(<span class="tok-str">&quot;builtin&quot;</span>);</span>
<span class="line" id="L2"><span class="tok-kw">const</span> std = <span class="tok-builtin">@import</span>(<span class="tok-str">&quot;std&quot;</span>);</span>
<span class="line" id="L3"><span class="tok-kw">const</span> mem = std.mem;</span>
<span class="line" id="L4"><span class="tok-kw">const</span> fs = std.fs;</span>
<span class="line" id="L5"><span class="tok-kw">const</span> assert = std.debug.assert;</span>
<span class="line" id="L6"><span class="tok-kw">const</span> panic = std.debug.panic;</span>
<span class="line" id="L7"><span class="tok-kw">const</span> ArrayList = std.ArrayList;</span>
<span class="line" id="L8"><span class="tok-kw">const</span> StringHashMap = std.StringHashMap;</span>
<span class="line" id="L9"><span class="tok-kw">const</span> Sha256 = std.crypto.hash.sha2.Sha256;</span>
<span class="line" id="L10"><span class="tok-kw">const</span> Allocator = mem.Allocator;</span>
<span class="line" id="L11"><span class="tok-kw">const</span> Step = std.Build.Step;</span>
<span class="line" id="L12"><span class="tok-kw">const</span> LazyPath = std.Build.LazyPath;</span>
<span class="line" id="L13"><span class="tok-kw">const</span> PkgConfigPkg = std.Build.PkgConfigPkg;</span>
<span class="line" id="L14"><span class="tok-kw">const</span> PkgConfigError = std.Build.PkgConfigError;</span>
<span class="line" id="L15"><span class="tok-kw">const</span> RunError = std.Build.RunError;</span>
<span class="line" id="L16"><span class="tok-kw">const</span> Module = std.Build.Module;</span>
<span class="line" id="L17"><span class="tok-kw">const</span> InstallDir = std.Build.InstallDir;</span>
<span class="line" id="L18"><span class="tok-kw">const</span> GeneratedFile = std.Build.GeneratedFile;</span>
<span class="line" id="L19"><span class="tok-kw">const</span> Compile = <span class="tok-builtin">@This</span>();</span>
<span class="line" id="L20"></span>
<span class="line" id="L21"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> base_id: Step.Id = .compile;</span>
<span class="line" id="L22"></span>
<span class="line" id="L23">step: Step,</span>
<span class="line" id="L24">root_module: Module,</span>
<span class="line" id="L25"></span>
<span class="line" id="L26">name: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>,</span>
<span class="line" id="L27">linker_script: ?LazyPath = <span class="tok-null">null</span>,</span>
<span class="line" id="L28">version_script: ?[]<span class="tok-kw">const</span> <span class="tok-type">u8</span> = <span class="tok-null">null</span>,</span>
<span class="line" id="L29">out_filename: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>,</span>
<span class="line" id="L30">out_lib_filename: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>,</span>
<span class="line" id="L31">linkage: ?Linkage = <span class="tok-null">null</span>,</span>
<span class="line" id="L32">version: ?std.SemanticVersion,</span>
<span class="line" id="L33">kind: Kind,</span>
<span class="line" id="L34">major_only_filename: ?[]<span class="tok-kw">const</span> <span class="tok-type">u8</span>,</span>
<span class="line" id="L35">name_only_filename: ?[]<span class="tok-kw">const</span> <span class="tok-type">u8</span>,</span>
<span class="line" id="L36"><span class="tok-comment">// keep in sync with src/link.zig:CompressDebugSections</span>
</span>
<span class="line" id="L37">compress_debug_sections: <span class="tok-kw">enum</span> { none, zlib, zstd } = .none,</span>
<span class="line" id="L38">verbose_link: <span class="tok-type">bool</span>,</span>
<span class="line" id="L39">verbose_cc: <span class="tok-type">bool</span>,</span>
<span class="line" id="L40">bundle_compiler_rt: ?<span class="tok-type">bool</span> = <span class="tok-null">null</span>,</span>
<span class="line" id="L41">rdynamic: <span class="tok-type">bool</span>,</span>
<span class="line" id="L42">import_memory: <span class="tok-type">bool</span> = <span class="tok-null">false</span>,</span>
<span class="line" id="L43">export_memory: <span class="tok-type">bool</span> = <span class="tok-null">false</span>,</span>
<span class="line" id="L44"><span class="tok-comment">/// For WebAssembly targets, this will allow for undefined symbols to</span></span>
<span class="line" id="L45"><span class="tok-comment">/// be imported from the host environment.</span></span>
<span class="line" id="L46">import_symbols: <span class="tok-type">bool</span> = <span class="tok-null">false</span>,</span>
<span class="line" id="L47">import_table: <span class="tok-type">bool</span> = <span class="tok-null">false</span>,</span>
<span class="line" id="L48">export_table: <span class="tok-type">bool</span> = <span class="tok-null">false</span>,</span>
<span class="line" id="L49">initial_memory: ?<span class="tok-type">u64</span> = <span class="tok-null">null</span>,</span>
<span class="line" id="L50">max_memory: ?<span class="tok-type">u64</span> = <span class="tok-null">null</span>,</span>
<span class="line" id="L51">shared_memory: <span class="tok-type">bool</span> = <span class="tok-null">false</span>,</span>
<span class="line" id="L52">global_base: ?<span class="tok-type">u64</span> = <span class="tok-null">null</span>,</span>
<span class="line" id="L53"><span class="tok-comment">/// Set via options; intended to be read-only after that.</span></span>
<span class="line" id="L54">zig_lib_dir: ?LazyPath,</span>
<span class="line" id="L55">exec_cmd_args: ?[]<span class="tok-kw">const</span> ?[]<span class="tok-kw">const</span> <span class="tok-type">u8</span>,</span>
<span class="line" id="L56">filter: ?[]<span class="tok-kw">const</span> <span class="tok-type">u8</span>,</span>
<span class="line" id="L57">test_evented_io: <span class="tok-type">bool</span> = <span class="tok-null">false</span>,</span>
<span class="line" id="L58">test_runner: ?[]<span class="tok-kw">const</span> <span class="tok-type">u8</span>,</span>
<span class="line" id="L59">test_server_mode: <span class="tok-type">bool</span>,</span>
<span class="line" id="L60">wasi_exec_model: ?std.builtin.WasiExecModel = <span class="tok-null">null</span>,</span>
<span class="line" id="L61"></span>
<span class="line" id="L62">installed_headers: ArrayList(*Step),</span>
<span class="line" id="L63"></span>
<span class="line" id="L64"><span class="tok-comment">// keep in sync with src/Compilation.zig:RcIncludes</span>
</span>
<span class="line" id="L65"><span class="tok-comment">/// Behavior of automatic detection of include directories when compiling .rc files.</span></span>
<span class="line" id="L66"><span class="tok-comment">///  any: Use MSVC if available, fall back to MinGW.</span></span>
<span class="line" id="L67"><span class="tok-comment">///  msvc: Use MSVC include paths (must be present on the system).</span></span>
<span class="line" id="L68"><span class="tok-comment">///  gnu: Use MinGW include paths (distributed with Zig).</span></span>
<span class="line" id="L69"><span class="tok-comment">///  none: Do not use any autodetected include paths.</span></span>
<span class="line" id="L70">rc_includes: <span class="tok-kw">enum</span> { any, msvc, gnu, none } = .any,</span>
<span class="line" id="L71"></span>
<span class="line" id="L72"><span class="tok-comment">/// (Windows) .manifest file to embed in the compilation</span></span>
<span class="line" id="L73"><span class="tok-comment">/// Set via options; intended to be read-only after that.</span></span>
<span class="line" id="L74">win32_manifest: ?LazyPath = <span class="tok-null">null</span>,</span>
<span class="line" id="L75"></span>
<span class="line" id="L76">installed_path: ?[]<span class="tok-kw">const</span> <span class="tok-type">u8</span>,</span>
<span class="line" id="L77"></span>
<span class="line" id="L78"><span class="tok-comment">/// Base address for an executable image.</span></span>
<span class="line" id="L79">image_base: ?<span class="tok-type">u64</span> = <span class="tok-null">null</span>,</span>
<span class="line" id="L80"></span>
<span class="line" id="L81">libc_file: ?LazyPath = <span class="tok-null">null</span>,</span>
<span class="line" id="L82"></span>
<span class="line" id="L83">each_lib_rpath: ?<span class="tok-type">bool</span> = <span class="tok-null">null</span>,</span>
<span class="line" id="L84"><span class="tok-comment">/// On ELF targets, this will emit a link section called &quot;.note.gnu.build-id&quot;</span></span>
<span class="line" id="L85"><span class="tok-comment">/// which can be used to coordinate a stripped binary with its debug symbols.</span></span>
<span class="line" id="L86"><span class="tok-comment">/// As an example, the bloaty project refuses to work unless its inputs have</span></span>
<span class="line" id="L87"><span class="tok-comment">/// build ids, in order to prevent accidental mismatches.</span></span>
<span class="line" id="L88"><span class="tok-comment">/// The default is to not include this section because it slows down linking.</span></span>
<span class="line" id="L89">build_id: ?std.zig.BuildId = <span class="tok-null">null</span>,</span>
<span class="line" id="L90"></span>
<span class="line" id="L91"><span class="tok-comment">/// Create a .eh_frame_hdr section and a PT_GNU_EH_FRAME segment in the ELF</span></span>
<span class="line" id="L92"><span class="tok-comment">/// file.</span></span>
<span class="line" id="L93">link_eh_frame_hdr: <span class="tok-type">bool</span> = <span class="tok-null">false</span>,</span>
<span class="line" id="L94">link_emit_relocs: <span class="tok-type">bool</span> = <span class="tok-null">false</span>,</span>
<span class="line" id="L95"></span>
<span class="line" id="L96"><span class="tok-comment">/// Place every function in its own section so that unused ones may be</span></span>
<span class="line" id="L97"><span class="tok-comment">/// safely garbage-collected during the linking phase.</span></span>
<span class="line" id="L98">link_function_sections: <span class="tok-type">bool</span> = <span class="tok-null">false</span>,</span>
<span class="line" id="L99"></span>
<span class="line" id="L100"><span class="tok-comment">/// Place every data in its own section so that unused ones may be</span></span>
<span class="line" id="L101"><span class="tok-comment">/// safely garbage-collected during the linking phase.</span></span>
<span class="line" id="L102">link_data_sections: <span class="tok-type">bool</span> = <span class="tok-null">false</span>,</span>
<span class="line" id="L103"></span>
<span class="line" id="L104"><span class="tok-comment">/// Remove functions and data that are unreachable by the entry point or</span></span>
<span class="line" id="L105"><span class="tok-comment">/// exported symbols.</span></span>
<span class="line" id="L106">link_gc_sections: ?<span class="tok-type">bool</span> = <span class="tok-null">null</span>,</span>
<span class="line" id="L107"></span>
<span class="line" id="L108"><span class="tok-comment">/// (Windows) Whether or not to enable ASLR. Maps to the /DYNAMICBASE[:NO] linker argument.</span></span>
<span class="line" id="L109">linker_dynamicbase: <span class="tok-type">bool</span> = <span class="tok-null">true</span>,</span>
<span class="line" id="L110"></span>
<span class="line" id="L111">linker_allow_shlib_undefined: ?<span class="tok-type">bool</span> = <span class="tok-null">null</span>,</span>
<span class="line" id="L112"></span>
<span class="line" id="L113"><span class="tok-comment">/// Permit read-only relocations in read-only segments. Disallowed by default.</span></span>
<span class="line" id="L114">link_z_notext: <span class="tok-type">bool</span> = <span class="tok-null">false</span>,</span>
<span class="line" id="L115"></span>
<span class="line" id="L116"><span class="tok-comment">/// Force all relocations to be read-only after processing.</span></span>
<span class="line" id="L117">link_z_relro: <span class="tok-type">bool</span> = <span class="tok-null">true</span>,</span>
<span class="line" id="L118"></span>
<span class="line" id="L119"><span class="tok-comment">/// Allow relocations to be lazily processed after load.</span></span>
<span class="line" id="L120">link_z_lazy: <span class="tok-type">bool</span> = <span class="tok-null">false</span>,</span>
<span class="line" id="L121"></span>
<span class="line" id="L122"><span class="tok-comment">/// Common page size</span></span>
<span class="line" id="L123">link_z_common_page_size: ?<span class="tok-type">u64</span> = <span class="tok-null">null</span>,</span>
<span class="line" id="L124"></span>
<span class="line" id="L125"><span class="tok-comment">/// Maximum page size</span></span>
<span class="line" id="L126">link_z_max_page_size: ?<span class="tok-type">u64</span> = <span class="tok-null">null</span>,</span>
<span class="line" id="L127"></span>
<span class="line" id="L128"><span class="tok-comment">/// (Darwin) Install name for the dylib</span></span>
<span class="line" id="L129">install_name: ?[]<span class="tok-kw">const</span> <span class="tok-type">u8</span> = <span class="tok-null">null</span>,</span>
<span class="line" id="L130"></span>
<span class="line" id="L131"><span class="tok-comment">/// (Darwin) Path to entitlements file</span></span>
<span class="line" id="L132">entitlements: ?[]<span class="tok-kw">const</span> <span class="tok-type">u8</span> = <span class="tok-null">null</span>,</span>
<span class="line" id="L133"></span>
<span class="line" id="L134"><span class="tok-comment">/// (Darwin) Size of the pagezero segment.</span></span>
<span class="line" id="L135">pagezero_size: ?<span class="tok-type">u64</span> = <span class="tok-null">null</span>,</span>
<span class="line" id="L136"></span>
<span class="line" id="L137"><span class="tok-comment">/// (Darwin) Set size of the padding between the end of load commands</span></span>
<span class="line" id="L138"><span class="tok-comment">/// and start of `__TEXT,__text` section.</span></span>
<span class="line" id="L139">headerpad_size: ?<span class="tok-type">u32</span> = <span class="tok-null">null</span>,</span>
<span class="line" id="L140"></span>
<span class="line" id="L141"><span class="tok-comment">/// (Darwin) Automatically Set size of the padding between the end of load commands</span></span>
<span class="line" id="L142"><span class="tok-comment">/// and start of `__TEXT,__text` section to a value fitting all paths expanded to MAXPATHLEN.</span></span>
<span class="line" id="L143">headerpad_max_install_names: <span class="tok-type">bool</span> = <span class="tok-null">false</span>,</span>
<span class="line" id="L144"></span>
<span class="line" id="L145"><span class="tok-comment">/// (Darwin) Remove dylibs that are unreachable by the entry point or exported symbols.</span></span>
<span class="line" id="L146">dead_strip_dylibs: <span class="tok-type">bool</span> = <span class="tok-null">false</span>,</span>
<span class="line" id="L147"></span>
<span class="line" id="L148"><span class="tok-comment">/// Position Independent Executable</span></span>
<span class="line" id="L149">pie: ?<span class="tok-type">bool</span> = <span class="tok-null">null</span>,</span>
<span class="line" id="L150"></span>
<span class="line" id="L151">dll_export_fns: ?<span class="tok-type">bool</span> = <span class="tok-null">null</span>,</span>
<span class="line" id="L152"></span>
<span class="line" id="L153">subsystem: ?std.Target.SubSystem = <span class="tok-null">null</span>,</span>
<span class="line" id="L154"></span>
<span class="line" id="L155"><span class="tok-comment">/// How the linker must handle the entry point of the executable.</span></span>
<span class="line" id="L156">entry: Entry = .default,</span>
<span class="line" id="L157"></span>
<span class="line" id="L158"><span class="tok-comment">/// List of symbols forced as undefined in the symbol table</span></span>
<span class="line" id="L159"><span class="tok-comment">/// thus forcing their resolution by the linker.</span></span>
<span class="line" id="L160"><span class="tok-comment">/// Corresponds to `-u &lt;symbol&gt;` for ELF/MachO and `/include:&lt;symbol&gt;` for COFF/PE.</span></span>
<span class="line" id="L161">force_undefined_symbols: std.StringHashMap(<span class="tok-type">void</span>),</span>
<span class="line" id="L162"></span>
<span class="line" id="L163"><span class="tok-comment">/// Overrides the default stack size</span></span>
<span class="line" id="L164">stack_size: ?<span class="tok-type">u64</span> = <span class="tok-null">null</span>,</span>
<span class="line" id="L165"></span>
<span class="line" id="L166">want_lto: ?<span class="tok-type">bool</span> = <span class="tok-null">null</span>,</span>
<span class="line" id="L167">use_llvm: ?<span class="tok-type">bool</span>,</span>
<span class="line" id="L168">use_lld: ?<span class="tok-type">bool</span>,</span>
<span class="line" id="L169"></span>
<span class="line" id="L170"><span class="tok-comment">/// This is an advanced setting that can change the intent of this Compile step.</span></span>
<span class="line" id="L171"><span class="tok-comment">/// If this value is non-null, it means that this Compile step exists to</span></span>
<span class="line" id="L172"><span class="tok-comment">/// check for compile errors and return *success* if they match, and failure</span></span>
<span class="line" id="L173"><span class="tok-comment">/// otherwise.</span></span>
<span class="line" id="L174">expect_errors: ?ExpectedCompileErrors = <span class="tok-null">null</span>,</span>
<span class="line" id="L175"></span>
<span class="line" id="L176">emit_directory: ?*GeneratedFile,</span>
<span class="line" id="L177"></span>
<span class="line" id="L178">generated_docs: ?*GeneratedFile,</span>
<span class="line" id="L179">generated_asm: ?*GeneratedFile,</span>
<span class="line" id="L180">generated_bin: ?*GeneratedFile,</span>
<span class="line" id="L181">generated_pdb: ?*GeneratedFile,</span>
<span class="line" id="L182">generated_implib: ?*GeneratedFile,</span>
<span class="line" id="L183">generated_llvm_bc: ?*GeneratedFile,</span>
<span class="line" id="L184">generated_llvm_ir: ?*GeneratedFile,</span>
<span class="line" id="L185">generated_h: ?*GeneratedFile,</span>
<span class="line" id="L186"></span>
<span class="line" id="L187"><span class="tok-comment">/// The maximum number of distinct errors within a compilation step</span></span>
<span class="line" id="L188"><span class="tok-comment">/// Defaults to `std.math.maxInt(u16)`</span></span>
<span class="line" id="L189">error_limit: ?<span class="tok-type">u32</span> = <span class="tok-null">null</span>,</span>
<span class="line" id="L190"></span>
<span class="line" id="L191"><span class="tok-comment">/// Computed during make().</span></span>
<span class="line" id="L192">is_linking_libc: <span class="tok-type">bool</span> = <span class="tok-null">false</span>,</span>
<span class="line" id="L193"><span class="tok-comment">/// Computed during make().</span></span>
<span class="line" id="L194">is_linking_libcpp: <span class="tok-type">bool</span> = <span class="tok-null">false</span>,</span>
<span class="line" id="L195"></span>
<span class="line" id="L196"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> ExpectedCompileErrors = <span class="tok-kw">union</span>(<span class="tok-kw">enum</span>) {</span>
<span class="line" id="L197">    contains: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>,</span>
<span class="line" id="L198">    exact: []<span class="tok-kw">const</span> []<span class="tok-kw">const</span> <span class="tok-type">u8</span>,</span>
<span class="line" id="L199">};</span>
<span class="line" id="L200"></span>
<span class="line" id="L201"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> Entry = <span class="tok-kw">union</span>(<span class="tok-kw">enum</span>) {</span>
<span class="line" id="L202">    <span class="tok-comment">/// Let the compiler decide whether to make an entry point and what to name</span></span>
<span class="line" id="L203">    <span class="tok-comment">/// it.</span></span>
<span class="line" id="L204">    default,</span>
<span class="line" id="L205">    <span class="tok-comment">/// The executable will have no entry point.</span></span>
<span class="line" id="L206">    disabled,</span>
<span class="line" id="L207">    <span class="tok-comment">/// The executable will have an entry point with the default symbol name.</span></span>
<span class="line" id="L208">    enabled,</span>
<span class="line" id="L209">    <span class="tok-comment">/// The executable will have an entry point with the specified symbol name.</span></span>
<span class="line" id="L210">    symbol_name: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>,</span>
<span class="line" id="L211">};</span>
<span class="line" id="L212"></span>
<span class="line" id="L213"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> Options = <span class="tok-kw">struct</span> {</span>
<span class="line" id="L214">    name: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>,</span>
<span class="line" id="L215">    root_module: Module.CreateOptions,</span>
<span class="line" id="L216">    kind: Kind,</span>
<span class="line" id="L217">    linkage: ?Linkage = <span class="tok-null">null</span>,</span>
<span class="line" id="L218">    version: ?std.SemanticVersion = <span class="tok-null">null</span>,</span>
<span class="line" id="L219">    max_rss: <span class="tok-type">usize</span> = <span class="tok-number">0</span>,</span>
<span class="line" id="L220">    filter: ?[]<span class="tok-kw">const</span> <span class="tok-type">u8</span> = <span class="tok-null">null</span>,</span>
<span class="line" id="L221">    test_runner: ?[]<span class="tok-kw">const</span> <span class="tok-type">u8</span> = <span class="tok-null">null</span>,</span>
<span class="line" id="L222">    use_llvm: ?<span class="tok-type">bool</span> = <span class="tok-null">null</span>,</span>
<span class="line" id="L223">    use_lld: ?<span class="tok-type">bool</span> = <span class="tok-null">null</span>,</span>
<span class="line" id="L224">    zig_lib_dir: ?LazyPath = <span class="tok-null">null</span>,</span>
<span class="line" id="L225">    <span class="tok-comment">/// Embed a `.manifest` file in the compilation if the object format supports it.</span></span>
<span class="line" id="L226">    <span class="tok-comment">/// https://learn.microsoft.com/en-us/windows/win32/sbscs/manifest-files-reference</span></span>
<span class="line" id="L227">    <span class="tok-comment">/// Manifest files must have the extension `.manifest`.</span></span>
<span class="line" id="L228">    <span class="tok-comment">/// Can be set regardless of target. The `.manifest` file will be ignored</span></span>
<span class="line" id="L229">    <span class="tok-comment">/// if the target object format does not support embedded manifests.</span></span>
<span class="line" id="L230">    win32_manifest: ?LazyPath = <span class="tok-null">null</span>,</span>
<span class="line" id="L231">};</span>
<span class="line" id="L232"></span>
<span class="line" id="L233"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> Kind = <span class="tok-kw">enum</span> {</span>
<span class="line" id="L234">    exe,</span>
<span class="line" id="L235">    lib,</span>
<span class="line" id="L236">    obj,</span>
<span class="line" id="L237">    @&quot;test&quot;,</span>
<span class="line" id="L238">};</span>
<span class="line" id="L239"></span>
<span class="line" id="L240"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> Linkage = <span class="tok-kw">enum</span> { dynamic, static };</span>
<span class="line" id="L241"></span>
<span class="line" id="L242"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">create</span>(owner: *std.Build, options: Options) *Compile {</span>
<span class="line" id="L243">    <span class="tok-kw">const</span> name = owner.dupe(options.name);</span>
<span class="line" id="L244">    <span class="tok-kw">if</span> (mem.indexOf(<span class="tok-type">u8</span>, name, <span class="tok-str">&quot;/&quot;</span>) != <span class="tok-null">null</span> <span class="tok-kw">or</span> mem.indexOf(<span class="tok-type">u8</span>, name, <span class="tok-str">&quot;\\&quot;</span>) != <span class="tok-null">null</span>) {</span>
<span class="line" id="L245">        panic(<span class="tok-str">&quot;invalid name: '{s}'. It looks like a file path, but it is supposed to be the library or application name.&quot;</span>, .{name});</span>
<span class="line" id="L246">    }</span>
<span class="line" id="L247"></span>
<span class="line" id="L248">    <span class="tok-comment">// Avoid the common case of the step name looking like &quot;zig test test&quot;.</span>
</span>
<span class="line" id="L249">    <span class="tok-kw">const</span> name_adjusted = <span class="tok-kw">if</span> (options.kind == .@&quot;test&quot; <span class="tok-kw">and</span> mem.eql(<span class="tok-type">u8</span>, name, <span class="tok-str">&quot;test&quot;</span>))</span>
<span class="line" id="L250">        <span class="tok-str">&quot;&quot;</span></span>
<span class="line" id="L251">    <span class="tok-kw">else</span></span>
<span class="line" id="L252">        owner.fmt(<span class="tok-str">&quot;{s} &quot;</span>, .{name});</span>
<span class="line" id="L253"></span>
<span class="line" id="L254">    <span class="tok-kw">const</span> resolved_target = options.root_module.target.?;</span>
<span class="line" id="L255">    <span class="tok-kw">const</span> target = resolved_target.result;</span>
<span class="line" id="L256"></span>
<span class="line" id="L257">    <span class="tok-kw">const</span> step_name = owner.fmt(<span class="tok-str">&quot;{s} {s}{s} {s}&quot;</span>, .{</span>
<span class="line" id="L258">        <span class="tok-kw">switch</span> (options.kind) {</span>
<span class="line" id="L259">            .exe =&gt; <span class="tok-str">&quot;zig build-exe&quot;</span>,</span>
<span class="line" id="L260">            .lib =&gt; <span class="tok-str">&quot;zig build-lib&quot;</span>,</span>
<span class="line" id="L261">            .obj =&gt; <span class="tok-str">&quot;zig build-obj&quot;</span>,</span>
<span class="line" id="L262">            .@&quot;test&quot; =&gt; <span class="tok-str">&quot;zig test&quot;</span>,</span>
<span class="line" id="L263">        },</span>
<span class="line" id="L264">        name_adjusted,</span>
<span class="line" id="L265">        <span class="tok-builtin">@tagName</span>(options.root_module.optimize <span class="tok-kw">orelse</span> .Debug),</span>
<span class="line" id="L266">        resolved_target.query.zigTriple(owner.allocator) <span class="tok-kw">catch</span> <span class="tok-builtin">@panic</span>(<span class="tok-str">&quot;OOM&quot;</span>),</span>
<span class="line" id="L267">    });</span>
<span class="line" id="L268"></span>
<span class="line" id="L269">    <span class="tok-kw">const</span> out_filename = std.zig.binNameAlloc(owner.allocator, .{</span>
<span class="line" id="L270">        .root_name = name,</span>
<span class="line" id="L271">        .target = target,</span>
<span class="line" id="L272">        .output_mode = <span class="tok-kw">switch</span> (options.kind) {</span>
<span class="line" id="L273">            .lib =&gt; .Lib,</span>
<span class="line" id="L274">            .obj =&gt; .Obj,</span>
<span class="line" id="L275">            .exe, .@&quot;test&quot; =&gt; .Exe,</span>
<span class="line" id="L276">        },</span>
<span class="line" id="L277">        .link_mode = <span class="tok-kw">if</span> (options.linkage) |some| <span class="tok-builtin">@as</span>(std.builtin.LinkMode, <span class="tok-kw">switch</span> (some) {</span>
<span class="line" id="L278">            .dynamic =&gt; .Dynamic,</span>
<span class="line" id="L279">            .static =&gt; .Static,</span>
<span class="line" id="L280">        }) <span class="tok-kw">else</span> <span class="tok-null">null</span>,</span>
<span class="line" id="L281">        .version = options.version,</span>
<span class="line" id="L282">    }) <span class="tok-kw">catch</span> <span class="tok-builtin">@panic</span>(<span class="tok-str">&quot;OOM&quot;</span>);</span>
<span class="line" id="L283"></span>
<span class="line" id="L284">    <span class="tok-kw">const</span> self = owner.allocator.create(Compile) <span class="tok-kw">catch</span> <span class="tok-builtin">@panic</span>(<span class="tok-str">&quot;OOM&quot;</span>);</span>
<span class="line" id="L285">    self.* = .{</span>
<span class="line" id="L286">        .root_module = <span class="tok-null">undefined</span>,</span>
<span class="line" id="L287">        .verbose_link = <span class="tok-null">false</span>,</span>
<span class="line" id="L288">        .verbose_cc = <span class="tok-null">false</span>,</span>
<span class="line" id="L289">        .linkage = options.linkage,</span>
<span class="line" id="L290">        .kind = options.kind,</span>
<span class="line" id="L291">        .name = name,</span>
<span class="line" id="L292">        .step = Step.init(.{</span>
<span class="line" id="L293">            .id = base_id,</span>
<span class="line" id="L294">            .name = step_name,</span>
<span class="line" id="L295">            .owner = owner,</span>
<span class="line" id="L296">            .makeFn = make,</span>
<span class="line" id="L297">            .max_rss = options.max_rss,</span>
<span class="line" id="L298">        }),</span>
<span class="line" id="L299">        .version = options.version,</span>
<span class="line" id="L300">        .out_filename = out_filename,</span>
<span class="line" id="L301">        .out_lib_filename = <span class="tok-null">undefined</span>,</span>
<span class="line" id="L302">        .major_only_filename = <span class="tok-null">null</span>,</span>
<span class="line" id="L303">        .name_only_filename = <span class="tok-null">null</span>,</span>
<span class="line" id="L304">        .installed_headers = ArrayList(*Step).init(owner.allocator),</span>
<span class="line" id="L305">        .zig_lib_dir = <span class="tok-null">null</span>,</span>
<span class="line" id="L306">        .exec_cmd_args = <span class="tok-null">null</span>,</span>
<span class="line" id="L307">        .filter = options.filter,</span>
<span class="line" id="L308">        .test_runner = options.test_runner,</span>
<span class="line" id="L309">        .test_server_mode = options.test_runner == <span class="tok-null">null</span>,</span>
<span class="line" id="L310">        .rdynamic = <span class="tok-null">false</span>,</span>
<span class="line" id="L311">        .installed_path = <span class="tok-null">null</span>,</span>
<span class="line" id="L312">        .force_undefined_symbols = StringHashMap(<span class="tok-type">void</span>).init(owner.allocator),</span>
<span class="line" id="L313"></span>
<span class="line" id="L314">        .emit_directory = <span class="tok-null">null</span>,</span>
<span class="line" id="L315">        .generated_docs = <span class="tok-null">null</span>,</span>
<span class="line" id="L316">        .generated_asm = <span class="tok-null">null</span>,</span>
<span class="line" id="L317">        .generated_bin = <span class="tok-null">null</span>,</span>
<span class="line" id="L318">        .generated_pdb = <span class="tok-null">null</span>,</span>
<span class="line" id="L319">        .generated_implib = <span class="tok-null">null</span>,</span>
<span class="line" id="L320">        .generated_llvm_bc = <span class="tok-null">null</span>,</span>
<span class="line" id="L321">        .generated_llvm_ir = <span class="tok-null">null</span>,</span>
<span class="line" id="L322">        .generated_h = <span class="tok-null">null</span>,</span>
<span class="line" id="L323"></span>
<span class="line" id="L324">        .use_llvm = options.use_llvm,</span>
<span class="line" id="L325">        .use_lld = options.use_lld,</span>
<span class="line" id="L326">    };</span>
<span class="line" id="L327"></span>
<span class="line" id="L328">    self.root_module.init(owner, options.root_module, self);</span>
<span class="line" id="L329"></span>
<span class="line" id="L330">    <span class="tok-kw">if</span> (options.zig_lib_dir) |lp| {</span>
<span class="line" id="L331">        self.zig_lib_dir = lp.dupe(self.step.owner);</span>
<span class="line" id="L332">        lp.addStepDependencies(&amp;self.step);</span>
<span class="line" id="L333">    }</span>
<span class="line" id="L334"></span>
<span class="line" id="L335">    <span class="tok-comment">// Only the PE/COFF format has a Resource Table which is where the manifest</span>
</span>
<span class="line" id="L336">    <span class="tok-comment">// gets embedded, so for any other target the manifest file is just ignored.</span>
</span>
<span class="line" id="L337">    <span class="tok-kw">if</span> (target.ofmt == .coff) {</span>
<span class="line" id="L338">        <span class="tok-kw">if</span> (options.win32_manifest) |lp| {</span>
<span class="line" id="L339">            self.win32_manifest = lp.dupe(self.step.owner);</span>
<span class="line" id="L340">            lp.addStepDependencies(&amp;self.step);</span>
<span class="line" id="L341">        }</span>
<span class="line" id="L342">    }</span>
<span class="line" id="L343"></span>
<span class="line" id="L344">    <span class="tok-kw">if</span> (self.kind == .lib) {</span>
<span class="line" id="L345">        <span class="tok-kw">if</span> (self.linkage != <span class="tok-null">null</span> <span class="tok-kw">and</span> self.linkage.? == .static) {</span>
<span class="line" id="L346">            self.out_lib_filename = self.out_filename;</span>
<span class="line" id="L347">        } <span class="tok-kw">else</span> <span class="tok-kw">if</span> (self.version) |version| {</span>
<span class="line" id="L348">            <span class="tok-kw">if</span> (target.isDarwin()) {</span>
<span class="line" id="L349">                self.major_only_filename = owner.fmt(<span class="tok-str">&quot;lib{s}.{d}.dylib&quot;</span>, .{</span>
<span class="line" id="L350">                    self.name,</span>
<span class="line" id="L351">                    version.major,</span>
<span class="line" id="L352">                });</span>
<span class="line" id="L353">                self.name_only_filename = owner.fmt(<span class="tok-str">&quot;lib{s}.dylib&quot;</span>, .{self.name});</span>
<span class="line" id="L354">                self.out_lib_filename = self.out_filename;</span>
<span class="line" id="L355">            } <span class="tok-kw">else</span> <span class="tok-kw">if</span> (target.os.tag == .windows) {</span>
<span class="line" id="L356">                self.out_lib_filename = owner.fmt(<span class="tok-str">&quot;{s}.lib&quot;</span>, .{self.name});</span>
<span class="line" id="L357">            } <span class="tok-kw">else</span> {</span>
<span class="line" id="L358">                self.major_only_filename = owner.fmt(<span class="tok-str">&quot;lib{s}.so.{d}&quot;</span>, .{ self.name, version.major });</span>
<span class="line" id="L359">                self.name_only_filename = owner.fmt(<span class="tok-str">&quot;lib{s}.so&quot;</span>, .{self.name});</span>
<span class="line" id="L360">                self.out_lib_filename = self.out_filename;</span>
<span class="line" id="L361">            }</span>
<span class="line" id="L362">        } <span class="tok-kw">else</span> {</span>
<span class="line" id="L363">            <span class="tok-kw">if</span> (target.isDarwin()) {</span>
<span class="line" id="L364">                self.out_lib_filename = self.out_filename;</span>
<span class="line" id="L365">            } <span class="tok-kw">else</span> <span class="tok-kw">if</span> (target.os.tag == .windows) {</span>
<span class="line" id="L366">                self.out_lib_filename = owner.fmt(<span class="tok-str">&quot;{s}.lib&quot;</span>, .{self.name});</span>
<span class="line" id="L367">            } <span class="tok-kw">else</span> {</span>
<span class="line" id="L368">                self.out_lib_filename = self.out_filename;</span>
<span class="line" id="L369">            }</span>
<span class="line" id="L370">        }</span>
<span class="line" id="L371">    }</span>
<span class="line" id="L372"></span>
<span class="line" id="L373">    <span class="tok-kw">return</span> self;</span>
<span class="line" id="L374">}</span>
<span class="line" id="L375"></span>
<span class="line" id="L376"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">installHeader</span>(cs: *Compile, src_path: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>, dest_rel_path: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>) <span class="tok-type">void</span> {</span>
<span class="line" id="L377">    <span class="tok-kw">const</span> b = cs.step.owner;</span>
<span class="line" id="L378">    <span class="tok-kw">const</span> install_file = b.addInstallHeaderFile(src_path, dest_rel_path);</span>
<span class="line" id="L379">    b.getInstallStep().dependOn(&amp;install_file.step);</span>
<span class="line" id="L380">    cs.installed_headers.append(&amp;install_file.step) <span class="tok-kw">catch</span> <span class="tok-builtin">@panic</span>(<span class="tok-str">&quot;OOM&quot;</span>);</span>
<span class="line" id="L381">}</span>
<span class="line" id="L382"></span>
<span class="line" id="L383"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> InstallConfigHeaderOptions = <span class="tok-kw">struct</span> {</span>
<span class="line" id="L384">    install_dir: InstallDir = .header,</span>
<span class="line" id="L385">    dest_rel_path: ?[]<span class="tok-kw">const</span> <span class="tok-type">u8</span> = <span class="tok-null">null</span>,</span>
<span class="line" id="L386">};</span>
<span class="line" id="L387"></span>
<span class="line" id="L388"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">installConfigHeader</span>(</span>
<span class="line" id="L389">    cs: *Compile,</span>
<span class="line" id="L390">    config_header: *Step.ConfigHeader,</span>
<span class="line" id="L391">    options: InstallConfigHeaderOptions,</span>
<span class="line" id="L392">) <span class="tok-type">void</span> {</span>
<span class="line" id="L393">    <span class="tok-kw">const</span> dest_rel_path = options.dest_rel_path <span class="tok-kw">orelse</span> config_header.include_path;</span>
<span class="line" id="L394">    <span class="tok-kw">const</span> b = cs.step.owner;</span>
<span class="line" id="L395">    <span class="tok-kw">const</span> install_file = b.addInstallFileWithDir(</span>
<span class="line" id="L396">        .{ .generated = &amp;config_header.output_file },</span>
<span class="line" id="L397">        options.install_dir,</span>
<span class="line" id="L398">        dest_rel_path,</span>
<span class="line" id="L399">    );</span>
<span class="line" id="L400">    install_file.step.dependOn(&amp;config_header.step);</span>
<span class="line" id="L401">    b.getInstallStep().dependOn(&amp;install_file.step);</span>
<span class="line" id="L402">    cs.installed_headers.append(&amp;install_file.step) <span class="tok-kw">catch</span> <span class="tok-builtin">@panic</span>(<span class="tok-str">&quot;OOM&quot;</span>);</span>
<span class="line" id="L403">}</span>
<span class="line" id="L404"></span>
<span class="line" id="L405"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">installHeadersDirectory</span>(</span>
<span class="line" id="L406">    a: *Compile,</span>
<span class="line" id="L407">    src_dir_path: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>,</span>
<span class="line" id="L408">    dest_rel_path: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>,</span>
<span class="line" id="L409">) <span class="tok-type">void</span> {</span>
<span class="line" id="L410">    <span class="tok-kw">return</span> installHeadersDirectoryOptions(a, .{</span>
<span class="line" id="L411">        .source_dir = .{ .path = src_dir_path },</span>
<span class="line" id="L412">        .install_dir = .header,</span>
<span class="line" id="L413">        .install_subdir = dest_rel_path,</span>
<span class="line" id="L414">    });</span>
<span class="line" id="L415">}</span>
<span class="line" id="L416"></span>
<span class="line" id="L417"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">installHeadersDirectoryOptions</span>(</span>
<span class="line" id="L418">    cs: *Compile,</span>
<span class="line" id="L419">    options: std.Build.Step.InstallDir.Options,</span>
<span class="line" id="L420">) <span class="tok-type">void</span> {</span>
<span class="line" id="L421">    <span class="tok-kw">const</span> b = cs.step.owner;</span>
<span class="line" id="L422">    <span class="tok-kw">const</span> install_dir = b.addInstallDirectory(options);</span>
<span class="line" id="L423">    b.getInstallStep().dependOn(&amp;install_dir.step);</span>
<span class="line" id="L424">    cs.installed_headers.append(&amp;install_dir.step) <span class="tok-kw">catch</span> <span class="tok-builtin">@panic</span>(<span class="tok-str">&quot;OOM&quot;</span>);</span>
<span class="line" id="L425">}</span>
<span class="line" id="L426"></span>
<span class="line" id="L427"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">installLibraryHeaders</span>(cs: *Compile, l: *Compile) <span class="tok-type">void</span> {</span>
<span class="line" id="L428">    assert(l.kind == .lib);</span>
<span class="line" id="L429">    <span class="tok-kw">const</span> b = cs.step.owner;</span>
<span class="line" id="L430">    <span class="tok-kw">const</span> install_step = b.getInstallStep();</span>
<span class="line" id="L431">    <span class="tok-comment">// Copy each element from installed_headers, modifying the builder</span>
</span>
<span class="line" id="L432">    <span class="tok-comment">// to be the new parent's builder.</span>
</span>
<span class="line" id="L433">    <span class="tok-kw">for</span> (l.installed_headers.items) |step| {</span>
<span class="line" id="L434">        <span class="tok-kw">const</span> step_copy = <span class="tok-kw">switch</span> (step.id) {</span>
<span class="line" id="L435">            <span class="tok-kw">inline</span> .install_file, .install_dir =&gt; |id| blk: {</span>
<span class="line" id="L436">                <span class="tok-kw">const</span> T = id.Type();</span>
<span class="line" id="L437">                <span class="tok-kw">const</span> ptr = b.allocator.create(T) <span class="tok-kw">catch</span> <span class="tok-builtin">@panic</span>(<span class="tok-str">&quot;OOM&quot;</span>);</span>
<span class="line" id="L438">                ptr.* = step.cast(T).?.*;</span>
<span class="line" id="L439">                ptr.dest_builder = b;</span>
<span class="line" id="L440">                <span class="tok-kw">break</span> :blk &amp;ptr.step;</span>
<span class="line" id="L441">            },</span>
<span class="line" id="L442">            <span class="tok-kw">else</span> =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L443">        };</span>
<span class="line" id="L444">        cs.installed_headers.append(step_copy) <span class="tok-kw">catch</span> <span class="tok-builtin">@panic</span>(<span class="tok-str">&quot;OOM&quot;</span>);</span>
<span class="line" id="L445">        install_step.dependOn(step_copy);</span>
<span class="line" id="L446">    }</span>
<span class="line" id="L447">    cs.installed_headers.appendSlice(l.installed_headers.items) <span class="tok-kw">catch</span> <span class="tok-builtin">@panic</span>(<span class="tok-str">&quot;OOM&quot;</span>);</span>
<span class="line" id="L448">}</span>
<span class="line" id="L449"></span>
<span class="line" id="L450"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">addObjCopy</span>(cs: *Compile, options: Step.ObjCopy.Options) *Step.ObjCopy {</span>
<span class="line" id="L451">    <span class="tok-kw">const</span> b = cs.step.owner;</span>
<span class="line" id="L452">    <span class="tok-kw">var</span> copy = options;</span>
<span class="line" id="L453">    <span class="tok-kw">if</span> (copy.basename == <span class="tok-null">null</span>) {</span>
<span class="line" id="L454">        <span class="tok-kw">if</span> (options.format) |f| {</span>
<span class="line" id="L455">            copy.basename = b.fmt(<span class="tok-str">&quot;{s}.{s}&quot;</span>, .{ cs.name, <span class="tok-builtin">@tagName</span>(f) });</span>
<span class="line" id="L456">        } <span class="tok-kw">else</span> {</span>
<span class="line" id="L457">            copy.basename = cs.name;</span>
<span class="line" id="L458">        }</span>
<span class="line" id="L459">    }</span>
<span class="line" id="L460">    <span class="tok-kw">return</span> b.addObjCopy(cs.getEmittedBin(), copy);</span>
<span class="line" id="L461">}</span>
<span class="line" id="L462"></span>
<span class="line" id="L463"><span class="tok-comment">/// This function would run in the context of the package that created the executable,</span></span>
<span class="line" id="L464"><span class="tok-comment">/// which is undesirable when running an executable provided by a dependency package.</span></span>
<span class="line" id="L465"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> run = <span class="tok-builtin">@compileError</span>(<span class="tok-str">&quot;deprecated; use std.Build.addRunArtifact&quot;</span>);</span>
<span class="line" id="L466"></span>
<span class="line" id="L467"><span class="tok-comment">/// This function would install in the context of the package that created the artifact,</span></span>
<span class="line" id="L468"><span class="tok-comment">/// which is undesirable when installing an artifact provided by a dependency package.</span></span>
<span class="line" id="L469"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> install = <span class="tok-builtin">@compileError</span>(<span class="tok-str">&quot;deprecated; use std.Build.installArtifact&quot;</span>);</span>
<span class="line" id="L470"></span>
<span class="line" id="L471"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">checkObject</span>(self: *Compile) *Step.CheckObject {</span>
<span class="line" id="L472">    <span class="tok-kw">return</span> Step.CheckObject.create(self.step.owner, self.getEmittedBin(), self.rootModuleTarget().ofmt);</span>
<span class="line" id="L473">}</span>
<span class="line" id="L474"></span>
<span class="line" id="L475"><span class="tok-comment">/// deprecated: use `setLinkerScript`</span></span>
<span class="line" id="L476"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> setLinkerScriptPath = setLinkerScript;</span>
<span class="line" id="L477"></span>
<span class="line" id="L478"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">setLinkerScript</span>(self: *Compile, source: LazyPath) <span class="tok-type">void</span> {</span>
<span class="line" id="L479">    <span class="tok-kw">const</span> b = self.step.owner;</span>
<span class="line" id="L480">    self.linker_script = source.dupe(b);</span>
<span class="line" id="L481">    source.addStepDependencies(&amp;self.step);</span>
<span class="line" id="L482">}</span>
<span class="line" id="L483"></span>
<span class="line" id="L484"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">forceUndefinedSymbol</span>(self: *Compile, symbol_name: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>) <span class="tok-type">void</span> {</span>
<span class="line" id="L485">    <span class="tok-kw">const</span> b = self.step.owner;</span>
<span class="line" id="L486">    self.force_undefined_symbols.put(b.dupe(symbol_name), {}) <span class="tok-kw">catch</span> <span class="tok-builtin">@panic</span>(<span class="tok-str">&quot;OOM&quot;</span>);</span>
<span class="line" id="L487">}</span>
<span class="line" id="L488"></span>
<span class="line" id="L489"><span class="tok-comment">/// Returns whether the library, executable, or object depends on a particular system library.</span></span>
<span class="line" id="L490"><span class="tok-comment">/// Includes transitive dependencies.</span></span>
<span class="line" id="L491"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">dependsOnSystemLibrary</span>(self: *<span class="tok-kw">const</span> Compile, name: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>) <span class="tok-type">bool</span> {</span>
<span class="line" id="L492">    <span class="tok-kw">var</span> is_linking_libc = <span class="tok-null">false</span>;</span>
<span class="line" id="L493">    <span class="tok-kw">var</span> is_linking_libcpp = <span class="tok-null">false</span>;</span>
<span class="line" id="L494"></span>
<span class="line" id="L495">    <span class="tok-kw">var</span> it = self.root_module.iterateDependencies(self, <span class="tok-null">true</span>);</span>
<span class="line" id="L496">    <span class="tok-kw">while</span> (it.next()) |module| {</span>
<span class="line" id="L497">        <span class="tok-kw">for</span> (module.link_objects.items) |link_object| {</span>
<span class="line" id="L498">            <span class="tok-kw">switch</span> (link_object) {</span>
<span class="line" id="L499">                .system_lib =&gt; |lib| <span class="tok-kw">if</span> (mem.eql(<span class="tok-type">u8</span>, lib.name, name)) <span class="tok-kw">return</span> <span class="tok-null">true</span>,</span>
<span class="line" id="L500">                <span class="tok-kw">else</span> =&gt; <span class="tok-kw">continue</span>,</span>
<span class="line" id="L501">            }</span>
<span class="line" id="L502">        }</span>
<span class="line" id="L503">        is_linking_libc = is_linking_libc <span class="tok-kw">or</span> module.link_libcpp == <span class="tok-null">true</span>;</span>
<span class="line" id="L504">        is_linking_libcpp = is_linking_libcpp <span class="tok-kw">or</span> module.link_libcpp == <span class="tok-null">true</span>;</span>
<span class="line" id="L505">    }</span>
<span class="line" id="L506"></span>
<span class="line" id="L507">    <span class="tok-kw">if</span> (self.rootModuleTarget().is_libc_lib_name(name)) {</span>
<span class="line" id="L508">        <span class="tok-kw">return</span> is_linking_libc;</span>
<span class="line" id="L509">    }</span>
<span class="line" id="L510"></span>
<span class="line" id="L511">    <span class="tok-kw">if</span> (self.rootModuleTarget().is_libcpp_lib_name(name)) {</span>
<span class="line" id="L512">        <span class="tok-kw">return</span> is_linking_libcpp;</span>
<span class="line" id="L513">    }</span>
<span class="line" id="L514"></span>
<span class="line" id="L515">    <span class="tok-kw">return</span> <span class="tok-null">false</span>;</span>
<span class="line" id="L516">}</span>
<span class="line" id="L517"></span>
<span class="line" id="L518"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">isDynamicLibrary</span>(self: *<span class="tok-kw">const</span> Compile) <span class="tok-type">bool</span> {</span>
<span class="line" id="L519">    <span class="tok-kw">return</span> self.kind == .lib <span class="tok-kw">and</span> self.linkage == Linkage.dynamic;</span>
<span class="line" id="L520">}</span>
<span class="line" id="L521"></span>
<span class="line" id="L522"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">isStaticLibrary</span>(self: *<span class="tok-kw">const</span> Compile) <span class="tok-type">bool</span> {</span>
<span class="line" id="L523">    <span class="tok-kw">return</span> self.kind == .lib <span class="tok-kw">and</span> self.linkage != Linkage.dynamic;</span>
<span class="line" id="L524">}</span>
<span class="line" id="L525"></span>
<span class="line" id="L526"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">producesPdbFile</span>(self: *Compile) <span class="tok-type">bool</span> {</span>
<span class="line" id="L527">    <span class="tok-kw">const</span> target = self.rootModuleTarget();</span>
<span class="line" id="L528">    <span class="tok-comment">// TODO: Is this right? Isn't PDB for *any* PE/COFF file?</span>
</span>
<span class="line" id="L529">    <span class="tok-comment">// TODO: just share this logic with the compiler, silly!</span>
</span>
<span class="line" id="L530">    <span class="tok-kw">switch</span> (target.os.tag) {</span>
<span class="line" id="L531">        .windows, .uefi =&gt; {},</span>
<span class="line" id="L532">        <span class="tok-kw">else</span> =&gt; <span class="tok-kw">return</span> <span class="tok-null">false</span>,</span>
<span class="line" id="L533">    }</span>
<span class="line" id="L534">    <span class="tok-kw">if</span> (target.ofmt == .c) <span class="tok-kw">return</span> <span class="tok-null">false</span>;</span>
<span class="line" id="L535">    <span class="tok-kw">if</span> (self.root_module.strip == <span class="tok-null">true</span> <span class="tok-kw">or</span></span>
<span class="line" id="L536">        (self.root_module.strip == <span class="tok-null">null</span> <span class="tok-kw">and</span> self.root_module.optimize == .ReleaseSmall))</span>
<span class="line" id="L537">    {</span>
<span class="line" id="L538">        <span class="tok-kw">return</span> <span class="tok-null">false</span>;</span>
<span class="line" id="L539">    }</span>
<span class="line" id="L540">    <span class="tok-kw">return</span> self.isDynamicLibrary() <span class="tok-kw">or</span> self.kind == .exe <span class="tok-kw">or</span> self.kind == .@&quot;test&quot;;</span>
<span class="line" id="L541">}</span>
<span class="line" id="L542"></span>
<span class="line" id="L543"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">producesImplib</span>(self: *Compile) <span class="tok-type">bool</span> {</span>
<span class="line" id="L544">    <span class="tok-kw">return</span> self.isDynamicLibrary() <span class="tok-kw">and</span> self.rootModuleTarget().os.tag == .windows;</span>
<span class="line" id="L545">}</span>
<span class="line" id="L546"></span>
<span class="line" id="L547"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">linkLibC</span>(self: *Compile) <span class="tok-type">void</span> {</span>
<span class="line" id="L548">    self.root_module.link_libc = <span class="tok-null">true</span>;</span>
<span class="line" id="L549">}</span>
<span class="line" id="L550"></span>
<span class="line" id="L551"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">linkLibCpp</span>(self: *Compile) <span class="tok-type">void</span> {</span>
<span class="line" id="L552">    self.root_module.link_libcpp = <span class="tok-null">true</span>;</span>
<span class="line" id="L553">}</span>
<span class="line" id="L554"></span>
<span class="line" id="L555"><span class="tok-comment">/// Deprecated. Use `c.root_module.addCMacro`.</span></span>
<span class="line" id="L556"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">defineCMacro</span>(c: *Compile, name: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>, value: ?[]<span class="tok-kw">const</span> <span class="tok-type">u8</span>) <span class="tok-type">void</span> {</span>
<span class="line" id="L557">    c.root_module.addCMacro(name, value <span class="tok-kw">orelse</span> <span class="tok-str">&quot;1&quot;</span>);</span>
<span class="line" id="L558">}</span>
<span class="line" id="L559"></span>
<span class="line" id="L560"><span class="tok-comment">/// Run pkg-config for the given library name and parse the output, returning the arguments</span></span>
<span class="line" id="L561"><span class="tok-comment">/// that should be passed to zig to link the given library.</span></span>
<span class="line" id="L562"><span class="tok-kw">fn</span> <span class="tok-fn">runPkgConfig</span>(self: *Compile, lib_name: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>) ![]<span class="tok-kw">const</span> []<span class="tok-kw">const</span> <span class="tok-type">u8</span> {</span>
<span class="line" id="L563">    <span class="tok-kw">const</span> b = self.step.owner;</span>
<span class="line" id="L564">    <span class="tok-kw">const</span> pkg_name = match: {</span>
<span class="line" id="L565">        <span class="tok-comment">// First we have to map the library name to pkg config name. Unfortunately,</span>
</span>
<span class="line" id="L566">        <span class="tok-comment">// there are several examples where this is not straightforward:</span>
</span>
<span class="line" id="L567">        <span class="tok-comment">// -lSDL2 -&gt; pkg-config sdl2</span>
</span>
<span class="line" id="L568">        <span class="tok-comment">// -lgdk-3 -&gt; pkg-config gdk-3.0</span>
</span>
<span class="line" id="L569">        <span class="tok-comment">// -latk-1.0 -&gt; pkg-config atk</span>
</span>
<span class="line" id="L570">        <span class="tok-kw">const</span> pkgs = <span class="tok-kw">try</span> getPkgConfigList(b);</span>
<span class="line" id="L571"></span>
<span class="line" id="L572">        <span class="tok-comment">// Exact match means instant winner.</span>
</span>
<span class="line" id="L573">        <span class="tok-kw">for</span> (pkgs) |pkg| {</span>
<span class="line" id="L574">            <span class="tok-kw">if</span> (mem.eql(<span class="tok-type">u8</span>, pkg.name, lib_name)) {</span>
<span class="line" id="L575">                <span class="tok-kw">break</span> :match pkg.name;</span>
<span class="line" id="L576">            }</span>
<span class="line" id="L577">        }</span>
<span class="line" id="L578"></span>
<span class="line" id="L579">        <span class="tok-comment">// Next we'll try ignoring case.</span>
</span>
<span class="line" id="L580">        <span class="tok-kw">for</span> (pkgs) |pkg| {</span>
<span class="line" id="L581">            <span class="tok-kw">if</span> (std.ascii.eqlIgnoreCase(pkg.name, lib_name)) {</span>
<span class="line" id="L582">                <span class="tok-kw">break</span> :match pkg.name;</span>
<span class="line" id="L583">            }</span>
<span class="line" id="L584">        }</span>
<span class="line" id="L585"></span>
<span class="line" id="L586">        <span class="tok-comment">// Now try appending &quot;.0&quot;.</span>
</span>
<span class="line" id="L587">        <span class="tok-kw">for</span> (pkgs) |pkg| {</span>
<span class="line" id="L588">            <span class="tok-kw">if</span> (std.ascii.indexOfIgnoreCase(pkg.name, lib_name)) |pos| {</span>
<span class="line" id="L589">                <span class="tok-kw">if</span> (pos != <span class="tok-number">0</span>) <span class="tok-kw">continue</span>;</span>
<span class="line" id="L590">                <span class="tok-kw">if</span> (mem.eql(<span class="tok-type">u8</span>, pkg.name[lib_name.len..], <span class="tok-str">&quot;.0&quot;</span>)) {</span>
<span class="line" id="L591">                    <span class="tok-kw">break</span> :match pkg.name;</span>
<span class="line" id="L592">                }</span>
<span class="line" id="L593">            }</span>
<span class="line" id="L594">        }</span>
<span class="line" id="L595"></span>
<span class="line" id="L596">        <span class="tok-comment">// Trimming &quot;-1.0&quot;.</span>
</span>
<span class="line" id="L597">        <span class="tok-kw">if</span> (mem.endsWith(<span class="tok-type">u8</span>, lib_name, <span class="tok-str">&quot;-1.0&quot;</span>)) {</span>
<span class="line" id="L598">            <span class="tok-kw">const</span> trimmed_lib_name = lib_name[<span class="tok-number">0</span> .. lib_name.len - <span class="tok-str">&quot;-1.0&quot;</span>.len];</span>
<span class="line" id="L599">            <span class="tok-kw">for</span> (pkgs) |pkg| {</span>
<span class="line" id="L600">                <span class="tok-kw">if</span> (std.ascii.eqlIgnoreCase(pkg.name, trimmed_lib_name)) {</span>
<span class="line" id="L601">                    <span class="tok-kw">break</span> :match pkg.name;</span>
<span class="line" id="L602">                }</span>
<span class="line" id="L603">            }</span>
<span class="line" id="L604">        }</span>
<span class="line" id="L605"></span>
<span class="line" id="L606">        <span class="tok-kw">return</span> <span class="tok-kw">error</span>.PackageNotFound;</span>
<span class="line" id="L607">    };</span>
<span class="line" id="L608"></span>
<span class="line" id="L609">    <span class="tok-kw">var</span> code: <span class="tok-type">u8</span> = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L610">    <span class="tok-kw">const</span> stdout = <span class="tok-kw">if</span> (b.runAllowFail(&amp;[_][]<span class="tok-kw">const</span> <span class="tok-type">u8</span>{</span>
<span class="line" id="L611">        <span class="tok-str">&quot;pkg-config&quot;</span>,</span>
<span class="line" id="L612">        pkg_name,</span>
<span class="line" id="L613">        <span class="tok-str">&quot;--cflags&quot;</span>,</span>
<span class="line" id="L614">        <span class="tok-str">&quot;--libs&quot;</span>,</span>
<span class="line" id="L615">    }, &amp;code, .Ignore)) |stdout| stdout <span class="tok-kw">else</span> |err| <span class="tok-kw">switch</span> (err) {</span>
<span class="line" id="L616">        <span class="tok-kw">error</span>.ProcessTerminated =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.PkgConfigCrashed,</span>
<span class="line" id="L617">        <span class="tok-kw">error</span>.ExecNotSupported =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.PkgConfigFailed,</span>
<span class="line" id="L618">        <span class="tok-kw">error</span>.ExitCodeFailure =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.PkgConfigFailed,</span>
<span class="line" id="L619">        <span class="tok-kw">error</span>.FileNotFound =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.PkgConfigNotInstalled,</span>
<span class="line" id="L620">        <span class="tok-kw">else</span> =&gt; <span class="tok-kw">return</span> err,</span>
<span class="line" id="L621">    };</span>
<span class="line" id="L622"></span>
<span class="line" id="L623">    <span class="tok-kw">var</span> zig_args = ArrayList([]<span class="tok-kw">const</span> <span class="tok-type">u8</span>).init(b.allocator);</span>
<span class="line" id="L624">    <span class="tok-kw">defer</span> zig_args.deinit();</span>
<span class="line" id="L625"></span>
<span class="line" id="L626">    <span class="tok-kw">var</span> it = mem.tokenizeAny(<span class="tok-type">u8</span>, stdout, <span class="tok-str">&quot; \r\n\t&quot;</span>);</span>
<span class="line" id="L627">    <span class="tok-kw">while</span> (it.next()) |tok| {</span>
<span class="line" id="L628">        <span class="tok-kw">if</span> (mem.eql(<span class="tok-type">u8</span>, tok, <span class="tok-str">&quot;-I&quot;</span>)) {</span>
<span class="line" id="L629">            <span class="tok-kw">const</span> dir = it.next() <span class="tok-kw">orelse</span> <span class="tok-kw">return</span> <span class="tok-kw">error</span>.PkgConfigInvalidOutput;</span>
<span class="line" id="L630">            <span class="tok-kw">try</span> zig_args.appendSlice(&amp;[_][]<span class="tok-kw">const</span> <span class="tok-type">u8</span>{ <span class="tok-str">&quot;-I&quot;</span>, dir });</span>
<span class="line" id="L631">        } <span class="tok-kw">else</span> <span class="tok-kw">if</span> (mem.startsWith(<span class="tok-type">u8</span>, tok, <span class="tok-str">&quot;-I&quot;</span>)) {</span>
<span class="line" id="L632">            <span class="tok-kw">try</span> zig_args.append(tok);</span>
<span class="line" id="L633">        } <span class="tok-kw">else</span> <span class="tok-kw">if</span> (mem.eql(<span class="tok-type">u8</span>, tok, <span class="tok-str">&quot;-L&quot;</span>)) {</span>
<span class="line" id="L634">            <span class="tok-kw">const</span> dir = it.next() <span class="tok-kw">orelse</span> <span class="tok-kw">return</span> <span class="tok-kw">error</span>.PkgConfigInvalidOutput;</span>
<span class="line" id="L635">            <span class="tok-kw">try</span> zig_args.appendSlice(&amp;[_][]<span class="tok-kw">const</span> <span class="tok-type">u8</span>{ <span class="tok-str">&quot;-L&quot;</span>, dir });</span>
<span class="line" id="L636">        } <span class="tok-kw">else</span> <span class="tok-kw">if</span> (mem.startsWith(<span class="tok-type">u8</span>, tok, <span class="tok-str">&quot;-L&quot;</span>)) {</span>
<span class="line" id="L637">            <span class="tok-kw">try</span> zig_args.append(tok);</span>
<span class="line" id="L638">        } <span class="tok-kw">else</span> <span class="tok-kw">if</span> (mem.eql(<span class="tok-type">u8</span>, tok, <span class="tok-str">&quot;-l&quot;</span>)) {</span>
<span class="line" id="L639">            <span class="tok-kw">const</span> lib = it.next() <span class="tok-kw">orelse</span> <span class="tok-kw">return</span> <span class="tok-kw">error</span>.PkgConfigInvalidOutput;</span>
<span class="line" id="L640">            <span class="tok-kw">try</span> zig_args.appendSlice(&amp;[_][]<span class="tok-kw">const</span> <span class="tok-type">u8</span>{ <span class="tok-str">&quot;-l&quot;</span>, lib });</span>
<span class="line" id="L641">        } <span class="tok-kw">else</span> <span class="tok-kw">if</span> (mem.startsWith(<span class="tok-type">u8</span>, tok, <span class="tok-str">&quot;-l&quot;</span>)) {</span>
<span class="line" id="L642">            <span class="tok-kw">try</span> zig_args.append(tok);</span>
<span class="line" id="L643">        } <span class="tok-kw">else</span> <span class="tok-kw">if</span> (mem.eql(<span class="tok-type">u8</span>, tok, <span class="tok-str">&quot;-D&quot;</span>)) {</span>
<span class="line" id="L644">            <span class="tok-kw">const</span> macro = it.next() <span class="tok-kw">orelse</span> <span class="tok-kw">return</span> <span class="tok-kw">error</span>.PkgConfigInvalidOutput;</span>
<span class="line" id="L645">            <span class="tok-kw">try</span> zig_args.appendSlice(&amp;[_][]<span class="tok-kw">const</span> <span class="tok-type">u8</span>{ <span class="tok-str">&quot;-D&quot;</span>, macro });</span>
<span class="line" id="L646">        } <span class="tok-kw">else</span> <span class="tok-kw">if</span> (mem.startsWith(<span class="tok-type">u8</span>, tok, <span class="tok-str">&quot;-D&quot;</span>)) {</span>
<span class="line" id="L647">            <span class="tok-kw">try</span> zig_args.append(tok);</span>
<span class="line" id="L648">        } <span class="tok-kw">else</span> <span class="tok-kw">if</span> (b.debug_pkg_config) {</span>
<span class="line" id="L649">            <span class="tok-kw">return</span> self.step.fail(<span class="tok-str">&quot;unknown pkg-config flag '{s}'&quot;</span>, .{tok});</span>
<span class="line" id="L650">        }</span>
<span class="line" id="L651">    }</span>
<span class="line" id="L652"></span>
<span class="line" id="L653">    <span class="tok-kw">return</span> zig_args.toOwnedSlice();</span>
<span class="line" id="L654">}</span>
<span class="line" id="L655"></span>
<span class="line" id="L656"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">linkSystemLibrary</span>(self: *Compile, name: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>) <span class="tok-type">void</span> {</span>
<span class="line" id="L657">    <span class="tok-kw">return</span> self.root_module.linkSystemLibrary(name, .{});</span>
<span class="line" id="L658">}</span>
<span class="line" id="L659"></span>
<span class="line" id="L660"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">linkSystemLibrary2</span>(</span>
<span class="line" id="L661">    self: *Compile,</span>
<span class="line" id="L662">    name: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>,</span>
<span class="line" id="L663">    options: Module.LinkSystemLibraryOptions,</span>
<span class="line" id="L664">) <span class="tok-type">void</span> {</span>
<span class="line" id="L665">    <span class="tok-kw">return</span> self.root_module.linkSystemLibrary(name, options);</span>
<span class="line" id="L666">}</span>
<span class="line" id="L667"></span>
<span class="line" id="L668"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">linkFramework</span>(c: *Compile, name: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>) <span class="tok-type">void</span> {</span>
<span class="line" id="L669">    c.root_module.linkFramework(name, .{});</span>
<span class="line" id="L670">}</span>
<span class="line" id="L671"></span>
<span class="line" id="L672"><span class="tok-comment">/// Deprecated. Use `c.root_module.linkFramework`.</span></span>
<span class="line" id="L673"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">linkFrameworkNeeded</span>(c: *Compile, name: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>) <span class="tok-type">void</span> {</span>
<span class="line" id="L674">    c.root_module.linkFramework(name, .{ .needed = <span class="tok-null">true</span> });</span>
<span class="line" id="L675">}</span>
<span class="line" id="L676"></span>
<span class="line" id="L677"><span class="tok-comment">/// Deprecated. Use `c.root_module.linkFramework`.</span></span>
<span class="line" id="L678"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">linkFrameworkWeak</span>(c: *Compile, name: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>) <span class="tok-type">void</span> {</span>
<span class="line" id="L679">    c.root_module.linkFramework(name, .{ .weak = <span class="tok-null">true</span> });</span>
<span class="line" id="L680">}</span>
<span class="line" id="L681"></span>
<span class="line" id="L682"><span class="tok-comment">/// Handy when you have many C/C++ source files and want them all to have the same flags.</span></span>
<span class="line" id="L683"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">addCSourceFiles</span>(self: *Compile, options: Module.AddCSourceFilesOptions) <span class="tok-type">void</span> {</span>
<span class="line" id="L684">    self.root_module.addCSourceFiles(options);</span>
<span class="line" id="L685">}</span>
<span class="line" id="L686"></span>
<span class="line" id="L687"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">addCSourceFile</span>(self: *Compile, source: Module.CSourceFile) <span class="tok-type">void</span> {</span>
<span class="line" id="L688">    self.root_module.addCSourceFile(source);</span>
<span class="line" id="L689">}</span>
<span class="line" id="L690"></span>
<span class="line" id="L691"><span class="tok-comment">/// Resource files must have the extension `.rc`.</span></span>
<span class="line" id="L692"><span class="tok-comment">/// Can be called regardless of target. The .rc file will be ignored</span></span>
<span class="line" id="L693"><span class="tok-comment">/// if the target object format does not support embedded resources.</span></span>
<span class="line" id="L694"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">addWin32ResourceFile</span>(self: *Compile, source: Module.RcSourceFile) <span class="tok-type">void</span> {</span>
<span class="line" id="L695">    self.root_module.addWin32ResourceFile(source);</span>
<span class="line" id="L696">}</span>
<span class="line" id="L697"></span>
<span class="line" id="L698"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">setVerboseLink</span>(self: *Compile, value: <span class="tok-type">bool</span>) <span class="tok-type">void</span> {</span>
<span class="line" id="L699">    self.verbose_link = value;</span>
<span class="line" id="L700">}</span>
<span class="line" id="L701"></span>
<span class="line" id="L702"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">setVerboseCC</span>(self: *Compile, value: <span class="tok-type">bool</span>) <span class="tok-type">void</span> {</span>
<span class="line" id="L703">    self.verbose_cc = value;</span>
<span class="line" id="L704">}</span>
<span class="line" id="L705"></span>
<span class="line" id="L706"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">setLibCFile</span>(self: *Compile, libc_file: ?LazyPath) <span class="tok-type">void</span> {</span>
<span class="line" id="L707">    <span class="tok-kw">const</span> b = self.step.owner;</span>
<span class="line" id="L708">    self.libc_file = <span class="tok-kw">if</span> (libc_file) |f| f.dupe(b) <span class="tok-kw">else</span> <span class="tok-null">null</span>;</span>
<span class="line" id="L709">}</span>
<span class="line" id="L710"></span>
<span class="line" id="L711"><span class="tok-kw">fn</span> <span class="tok-fn">getEmittedFileGeneric</span>(self: *Compile, output_file: *?*GeneratedFile) LazyPath {</span>
<span class="line" id="L712">    <span class="tok-kw">if</span> (output_file.*) |g| {</span>
<span class="line" id="L713">        <span class="tok-kw">return</span> .{ .generated = g };</span>
<span class="line" id="L714">    }</span>
<span class="line" id="L715">    <span class="tok-kw">const</span> arena = self.step.owner.allocator;</span>
<span class="line" id="L716">    <span class="tok-kw">const</span> generated_file = arena.create(GeneratedFile) <span class="tok-kw">catch</span> <span class="tok-builtin">@panic</span>(<span class="tok-str">&quot;OOM&quot;</span>);</span>
<span class="line" id="L717">    generated_file.* = .{ .step = &amp;self.step };</span>
<span class="line" id="L718">    output_file.* = generated_file;</span>
<span class="line" id="L719">    <span class="tok-kw">return</span> .{ .generated = generated_file };</span>
<span class="line" id="L720">}</span>
<span class="line" id="L721"></span>
<span class="line" id="L722"><span class="tok-comment">/// Returns the path to the directory that contains the emitted binary file.</span></span>
<span class="line" id="L723"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">getEmittedBinDirectory</span>(self: *Compile) LazyPath {</span>
<span class="line" id="L724">    _ = self.getEmittedBin();</span>
<span class="line" id="L725">    <span class="tok-kw">return</span> self.getEmittedFileGeneric(&amp;self.emit_directory);</span>
<span class="line" id="L726">}</span>
<span class="line" id="L727"></span>
<span class="line" id="L728"><span class="tok-comment">/// Returns the path to the generated executable, library or object file.</span></span>
<span class="line" id="L729"><span class="tok-comment">/// To run an executable built with zig build, use `run`, or create an install step and invoke it.</span></span>
<span class="line" id="L730"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">getEmittedBin</span>(self: *Compile) LazyPath {</span>
<span class="line" id="L731">    <span class="tok-kw">return</span> self.getEmittedFileGeneric(&amp;self.generated_bin);</span>
<span class="line" id="L732">}</span>
<span class="line" id="L733"></span>
<span class="line" id="L734"><span class="tok-comment">/// Returns the path to the generated import library.</span></span>
<span class="line" id="L735"><span class="tok-comment">/// This function can only be called for libraries.</span></span>
<span class="line" id="L736"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">getEmittedImplib</span>(self: *Compile) LazyPath {</span>
<span class="line" id="L737">    assert(self.kind == .lib);</span>
<span class="line" id="L738">    <span class="tok-kw">return</span> self.getEmittedFileGeneric(&amp;self.generated_implib);</span>
<span class="line" id="L739">}</span>
<span class="line" id="L740"></span>
<span class="line" id="L741"><span class="tok-comment">/// Returns the path to the generated header file.</span></span>
<span class="line" id="L742"><span class="tok-comment">/// This function can only be called for libraries or objects.</span></span>
<span class="line" id="L743"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">getEmittedH</span>(self: *Compile) LazyPath {</span>
<span class="line" id="L744">    assert(self.kind != .exe <span class="tok-kw">and</span> self.kind != .@&quot;test&quot;);</span>
<span class="line" id="L745">    <span class="tok-kw">return</span> self.getEmittedFileGeneric(&amp;self.generated_h);</span>
<span class="line" id="L746">}</span>
<span class="line" id="L747"></span>
<span class="line" id="L748"><span class="tok-comment">/// Returns the generated PDB file.</span></span>
<span class="line" id="L749"><span class="tok-comment">/// If the compilation does not produce a PDB file, this causes a FileNotFound error</span></span>
<span class="line" id="L750"><span class="tok-comment">/// at build time.</span></span>
<span class="line" id="L751"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">getEmittedPdb</span>(self: *Compile) LazyPath {</span>
<span class="line" id="L752">    _ = self.getEmittedBin();</span>
<span class="line" id="L753">    <span class="tok-kw">return</span> self.getEmittedFileGeneric(&amp;self.generated_pdb);</span>
<span class="line" id="L754">}</span>
<span class="line" id="L755"></span>
<span class="line" id="L756"><span class="tok-comment">/// Returns the path to the generated documentation directory.</span></span>
<span class="line" id="L757"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">getEmittedDocs</span>(self: *Compile) LazyPath {</span>
<span class="line" id="L758">    <span class="tok-kw">return</span> self.getEmittedFileGeneric(&amp;self.generated_docs);</span>
<span class="line" id="L759">}</span>
<span class="line" id="L760"></span>
<span class="line" id="L761"><span class="tok-comment">/// Returns the path to the generated assembly code.</span></span>
<span class="line" id="L762"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">getEmittedAsm</span>(self: *Compile) LazyPath {</span>
<span class="line" id="L763">    <span class="tok-kw">return</span> self.getEmittedFileGeneric(&amp;self.generated_asm);</span>
<span class="line" id="L764">}</span>
<span class="line" id="L765"></span>
<span class="line" id="L766"><span class="tok-comment">/// Returns the path to the generated LLVM IR.</span></span>
<span class="line" id="L767"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">getEmittedLlvmIr</span>(self: *Compile) LazyPath {</span>
<span class="line" id="L768">    <span class="tok-kw">return</span> self.getEmittedFileGeneric(&amp;self.generated_llvm_ir);</span>
<span class="line" id="L769">}</span>
<span class="line" id="L770"></span>
<span class="line" id="L771"><span class="tok-comment">/// Returns the path to the generated LLVM BC.</span></span>
<span class="line" id="L772"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">getEmittedLlvmBc</span>(self: *Compile) LazyPath {</span>
<span class="line" id="L773">    <span class="tok-kw">return</span> self.getEmittedFileGeneric(&amp;self.generated_llvm_bc);</span>
<span class="line" id="L774">}</span>
<span class="line" id="L775"></span>
<span class="line" id="L776"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">addAssemblyFile</span>(self: *Compile, source: LazyPath) <span class="tok-type">void</span> {</span>
<span class="line" id="L777">    self.root_module.addAssemblyFile(source);</span>
<span class="line" id="L778">}</span>
<span class="line" id="L779"></span>
<span class="line" id="L780"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">addObjectFile</span>(self: *Compile, source: LazyPath) <span class="tok-type">void</span> {</span>
<span class="line" id="L781">    self.root_module.addObjectFile(source);</span>
<span class="line" id="L782">}</span>
<span class="line" id="L783"></span>
<span class="line" id="L784"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">addObject</span>(self: *Compile, object: *Compile) <span class="tok-type">void</span> {</span>
<span class="line" id="L785">    self.root_module.addObject(object);</span>
<span class="line" id="L786">}</span>
<span class="line" id="L787"></span>
<span class="line" id="L788"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">linkLibrary</span>(self: *Compile, library: *Compile) <span class="tok-type">void</span> {</span>
<span class="line" id="L789">    self.root_module.linkLibrary(library);</span>
<span class="line" id="L790">}</span>
<span class="line" id="L791"></span>
<span class="line" id="L792"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">addAfterIncludePath</span>(self: *Compile, lazy_path: LazyPath) <span class="tok-type">void</span> {</span>
<span class="line" id="L793">    self.root_module.addAfterIncludePath(lazy_path);</span>
<span class="line" id="L794">}</span>
<span class="line" id="L795"></span>
<span class="line" id="L796"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">addSystemIncludePath</span>(self: *Compile, lazy_path: LazyPath) <span class="tok-type">void</span> {</span>
<span class="line" id="L797">    self.root_module.addSystemIncludePath(lazy_path);</span>
<span class="line" id="L798">}</span>
<span class="line" id="L799"></span>
<span class="line" id="L800"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">addIncludePath</span>(self: *Compile, lazy_path: LazyPath) <span class="tok-type">void</span> {</span>
<span class="line" id="L801">    self.root_module.addIncludePath(lazy_path);</span>
<span class="line" id="L802">}</span>
<span class="line" id="L803"></span>
<span class="line" id="L804"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">addConfigHeader</span>(self: *Compile, config_header: *Step.ConfigHeader) <span class="tok-type">void</span> {</span>
<span class="line" id="L805">    self.root_module.addConfigHeader(config_header);</span>
<span class="line" id="L806">}</span>
<span class="line" id="L807"></span>
<span class="line" id="L808"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">addLibraryPath</span>(self: *Compile, directory_path: LazyPath) <span class="tok-type">void</span> {</span>
<span class="line" id="L809">    self.root_module.addLibraryPath(directory_path);</span>
<span class="line" id="L810">}</span>
<span class="line" id="L811"></span>
<span class="line" id="L812"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">addRPath</span>(self: *Compile, directory_path: LazyPath) <span class="tok-type">void</span> {</span>
<span class="line" id="L813">    self.root_module.addRPath(directory_path);</span>
<span class="line" id="L814">}</span>
<span class="line" id="L815"></span>
<span class="line" id="L816"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">addSystemFrameworkPath</span>(self: *Compile, directory_path: LazyPath) <span class="tok-type">void</span> {</span>
<span class="line" id="L817">    self.root_module.addSystemFrameworkPath(directory_path);</span>
<span class="line" id="L818">}</span>
<span class="line" id="L819"></span>
<span class="line" id="L820"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">addFrameworkPath</span>(self: *Compile, directory_path: LazyPath) <span class="tok-type">void</span> {</span>
<span class="line" id="L821">    self.root_module.addFrameworkPath(directory_path);</span>
<span class="line" id="L822">}</span>
<span class="line" id="L823"></span>
<span class="line" id="L824"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">setExecCmd</span>(self: *Compile, args: []<span class="tok-kw">const</span> ?[]<span class="tok-kw">const</span> <span class="tok-type">u8</span>) <span class="tok-type">void</span> {</span>
<span class="line" id="L825">    <span class="tok-kw">const</span> b = self.step.owner;</span>
<span class="line" id="L826">    assert(self.kind == .@&quot;test&quot;);</span>
<span class="line" id="L827">    <span class="tok-kw">const</span> duped_args = b.allocator.alloc(?[]<span class="tok-type">u8</span>, args.len) <span class="tok-kw">catch</span> <span class="tok-builtin">@panic</span>(<span class="tok-str">&quot;OOM&quot;</span>);</span>
<span class="line" id="L828">    <span class="tok-kw">for</span> (args, <span class="tok-number">0</span>..) |arg, i| {</span>
<span class="line" id="L829">        duped_args[i] = <span class="tok-kw">if</span> (arg) |a| b.dupe(a) <span class="tok-kw">else</span> <span class="tok-null">null</span>;</span>
<span class="line" id="L830">    }</span>
<span class="line" id="L831">    self.exec_cmd_args = duped_args;</span>
<span class="line" id="L832">}</span>
<span class="line" id="L833"></span>
<span class="line" id="L834"><span class="tok-kw">const</span> CliNamedModules = <span class="tok-kw">struct</span> {</span>
<span class="line" id="L835">    modules: std.AutoArrayHashMapUnmanaged(*Module, <span class="tok-type">void</span>),</span>
<span class="line" id="L836">    names: std.StringArrayHashMapUnmanaged(<span class="tok-type">void</span>),</span>
<span class="line" id="L837"></span>
<span class="line" id="L838">    <span class="tok-comment">/// Traverse the whole dependency graph and give every module a unique</span></span>
<span class="line" id="L839">    <span class="tok-comment">/// name, ideally one named after what it's called somewhere in the graph.</span></span>
<span class="line" id="L840">    <span class="tok-comment">/// It will help here to have both a mapping from module to name and a set</span></span>
<span class="line" id="L841">    <span class="tok-comment">/// of all the currently-used names.</span></span>
<span class="line" id="L842">    <span class="tok-kw">fn</span> <span class="tok-fn">init</span>(arena: Allocator, root_module: *Module) Allocator.Error!CliNamedModules {</span>
<span class="line" id="L843">        <span class="tok-kw">var</span> self: CliNamedModules = .{</span>
<span class="line" id="L844">            .modules = .{},</span>
<span class="line" id="L845">            .names = .{},</span>
<span class="line" id="L846">        };</span>
<span class="line" id="L847">        <span class="tok-kw">var</span> it = root_module.iterateDependencies(<span class="tok-null">null</span>, <span class="tok-null">false</span>);</span>
<span class="line" id="L848">        {</span>
<span class="line" id="L849">            <span class="tok-kw">const</span> item = it.next().?;</span>
<span class="line" id="L850">            assert(root_module == item.module);</span>
<span class="line" id="L851">            <span class="tok-kw">try</span> self.modules.put(arena, root_module, {});</span>
<span class="line" id="L852">            <span class="tok-kw">try</span> self.names.put(arena, <span class="tok-str">&quot;root&quot;</span>, {});</span>
<span class="line" id="L853">        }</span>
<span class="line" id="L854">        <span class="tok-kw">while</span> (it.next()) |item| {</span>
<span class="line" id="L855">            <span class="tok-kw">var</span> name = item.name;</span>
<span class="line" id="L856">            <span class="tok-kw">var</span> n: <span class="tok-type">usize</span> = <span class="tok-number">0</span>;</span>
<span class="line" id="L857">            <span class="tok-kw">while</span> (<span class="tok-null">true</span>) {</span>
<span class="line" id="L858">                <span class="tok-kw">const</span> gop = <span class="tok-kw">try</span> self.names.getOrPut(arena, name);</span>
<span class="line" id="L859">                <span class="tok-kw">if</span> (!gop.found_existing) {</span>
<span class="line" id="L860">                    <span class="tok-kw">try</span> self.modules.putNoClobber(arena, item.module, {});</span>
<span class="line" id="L861">                    <span class="tok-kw">break</span>;</span>
<span class="line" id="L862">                }</span>
<span class="line" id="L863">                name = <span class="tok-kw">try</span> std.fmt.allocPrint(arena, <span class="tok-str">&quot;{s}{d}&quot;</span>, .{ item.name, n });</span>
<span class="line" id="L864">                n += <span class="tok-number">1</span>;</span>
<span class="line" id="L865">            }</span>
<span class="line" id="L866">        }</span>
<span class="line" id="L867">        <span class="tok-kw">return</span> self;</span>
<span class="line" id="L868">    }</span>
<span class="line" id="L869">};</span>
<span class="line" id="L870"></span>
<span class="line" id="L871"><span class="tok-kw">fn</span> <span class="tok-fn">getGeneratedFilePath</span>(self: *Compile, <span class="tok-kw">comptime</span> tag_name: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>, asking_step: ?*Step) []<span class="tok-kw">const</span> <span class="tok-type">u8</span> {</span>
<span class="line" id="L872">    <span class="tok-kw">const</span> maybe_path: ?*GeneratedFile = <span class="tok-builtin">@field</span>(self, tag_name);</span>
<span class="line" id="L873"></span>
<span class="line" id="L874">    <span class="tok-kw">const</span> generated_file = maybe_path <span class="tok-kw">orelse</span> {</span>
<span class="line" id="L875">        std.debug.getStderrMutex().lock();</span>
<span class="line" id="L876">        <span class="tok-kw">const</span> stderr = std.io.getStdErr();</span>
<span class="line" id="L877"></span>
<span class="line" id="L878">        std.Build.dumpBadGetPathHelp(&amp;self.step, stderr, self.step.owner, asking_step) <span class="tok-kw">catch</span> {};</span>
<span class="line" id="L879"></span>
<span class="line" id="L880">        <span class="tok-builtin">@panic</span>(<span class="tok-str">&quot;missing emit option for &quot;</span> ++ tag_name);</span>
<span class="line" id="L881">    };</span>
<span class="line" id="L882"></span>
<span class="line" id="L883">    <span class="tok-kw">const</span> path = generated_file.path <span class="tok-kw">orelse</span> {</span>
<span class="line" id="L884">        std.debug.getStderrMutex().lock();</span>
<span class="line" id="L885">        <span class="tok-kw">const</span> stderr = std.io.getStdErr();</span>
<span class="line" id="L886"></span>
<span class="line" id="L887">        std.Build.dumpBadGetPathHelp(&amp;self.step, stderr, self.step.owner, asking_step) <span class="tok-kw">catch</span> {};</span>
<span class="line" id="L888"></span>
<span class="line" id="L889">        <span class="tok-builtin">@panic</span>(tag_name ++ <span class="tok-str">&quot; is null. Is there a missing step dependency?&quot;</span>);</span>
<span class="line" id="L890">    };</span>
<span class="line" id="L891"></span>
<span class="line" id="L892">    <span class="tok-kw">return</span> path;</span>
<span class="line" id="L893">}</span>
<span class="line" id="L894"></span>
<span class="line" id="L895"><span class="tok-kw">fn</span> <span class="tok-fn">make</span>(step: *Step, prog_node: *std.Progress.Node) !<span class="tok-type">void</span> {</span>
<span class="line" id="L896">    <span class="tok-kw">const</span> b = step.owner;</span>
<span class="line" id="L897">    <span class="tok-kw">const</span> arena = b.allocator;</span>
<span class="line" id="L898">    <span class="tok-kw">const</span> self = <span class="tok-builtin">@fieldParentPtr</span>(Compile, <span class="tok-str">&quot;step&quot;</span>, step);</span>
<span class="line" id="L899"></span>
<span class="line" id="L900">    <span class="tok-kw">var</span> zig_args = ArrayList([]<span class="tok-kw">const</span> <span class="tok-type">u8</span>).init(arena);</span>
<span class="line" id="L901">    <span class="tok-kw">defer</span> zig_args.deinit();</span>
<span class="line" id="L902"></span>
<span class="line" id="L903">    <span class="tok-kw">try</span> zig_args.append(b.zig_exe);</span>
<span class="line" id="L904"></span>
<span class="line" id="L905">    <span class="tok-kw">const</span> cmd = <span class="tok-kw">switch</span> (self.kind) {</span>
<span class="line" id="L906">        .lib =&gt; <span class="tok-str">&quot;build-lib&quot;</span>,</span>
<span class="line" id="L907">        .exe =&gt; <span class="tok-str">&quot;build-exe&quot;</span>,</span>
<span class="line" id="L908">        .obj =&gt; <span class="tok-str">&quot;build-obj&quot;</span>,</span>
<span class="line" id="L909">        .@&quot;test&quot; =&gt; <span class="tok-str">&quot;test&quot;</span>,</span>
<span class="line" id="L910">    };</span>
<span class="line" id="L911">    <span class="tok-kw">try</span> zig_args.append(cmd);</span>
<span class="line" id="L912"></span>
<span class="line" id="L913">    <span class="tok-kw">if</span> (b.reference_trace) |some| {</span>
<span class="line" id="L914">        <span class="tok-kw">try</span> zig_args.append(<span class="tok-kw">try</span> std.fmt.allocPrint(arena, <span class="tok-str">&quot;-freference-trace={d}&quot;</span>, .{some}));</span>
<span class="line" id="L915">    }</span>
<span class="line" id="L916"></span>
<span class="line" id="L917">    <span class="tok-kw">try</span> addFlag(&amp;zig_args, <span class="tok-str">&quot;llvm&quot;</span>, self.use_llvm);</span>
<span class="line" id="L918">    <span class="tok-kw">try</span> addFlag(&amp;zig_args, <span class="tok-str">&quot;lld&quot;</span>, self.use_lld);</span>
<span class="line" id="L919"></span>
<span class="line" id="L920">    <span class="tok-kw">if</span> (self.root_module.resolved_target.?.query.ofmt) |ofmt| {</span>
<span class="line" id="L921">        <span class="tok-kw">try</span> zig_args.append(<span class="tok-kw">try</span> std.fmt.allocPrint(arena, <span class="tok-str">&quot;-ofmt={s}&quot;</span>, .{<span class="tok-builtin">@tagName</span>(ofmt)}));</span>
<span class="line" id="L922">    }</span>
<span class="line" id="L923"></span>
<span class="line" id="L924">    <span class="tok-kw">switch</span> (self.entry) {</span>
<span class="line" id="L925">        .default =&gt; {},</span>
<span class="line" id="L926">        .disabled =&gt; <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;-fno-entry&quot;</span>),</span>
<span class="line" id="L927">        .enabled =&gt; <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;-fentry&quot;</span>),</span>
<span class="line" id="L928">        .symbol_name =&gt; |entry_name| {</span>
<span class="line" id="L929">            <span class="tok-kw">try</span> zig_args.append(<span class="tok-kw">try</span> std.fmt.allocPrint(arena, <span class="tok-str">&quot;-fentry={s}&quot;</span>, .{entry_name}));</span>
<span class="line" id="L930">        },</span>
<span class="line" id="L931">    }</span>
<span class="line" id="L932"></span>
<span class="line" id="L933">    {</span>
<span class="line" id="L934">        <span class="tok-kw">var</span> it = self.force_undefined_symbols.keyIterator();</span>
<span class="line" id="L935">        <span class="tok-kw">while</span> (it.next()) |symbol_name| {</span>
<span class="line" id="L936">            <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;--force_undefined&quot;</span>);</span>
<span class="line" id="L937">            <span class="tok-kw">try</span> zig_args.append(symbol_name.*);</span>
<span class="line" id="L938">        }</span>
<span class="line" id="L939">    }</span>
<span class="line" id="L940"></span>
<span class="line" id="L941">    <span class="tok-kw">if</span> (self.stack_size) |stack_size| {</span>
<span class="line" id="L942">        <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;--stack&quot;</span>);</span>
<span class="line" id="L943">        <span class="tok-kw">try</span> zig_args.append(<span class="tok-kw">try</span> std.fmt.allocPrint(arena, <span class="tok-str">&quot;{}&quot;</span>, .{stack_size}));</span>
<span class="line" id="L944">    }</span>
<span class="line" id="L945"></span>
<span class="line" id="L946">    {</span>
<span class="line" id="L947">        <span class="tok-kw">var</span> seen_system_libs: std.StringHashMapUnmanaged(<span class="tok-type">void</span>) = .{};</span>
<span class="line" id="L948">        <span class="tok-kw">var</span> frameworks: std.StringArrayHashMapUnmanaged(Module.LinkFrameworkOptions) = .{};</span>
<span class="line" id="L949"></span>
<span class="line" id="L950">        <span class="tok-kw">var</span> prev_has_cflags = <span class="tok-null">false</span>;</span>
<span class="line" id="L951">        <span class="tok-kw">var</span> prev_has_rcflags = <span class="tok-null">false</span>;</span>
<span class="line" id="L952">        <span class="tok-kw">var</span> prev_search_strategy: Module.SystemLib.SearchStrategy = .paths_first;</span>
<span class="line" id="L953">        <span class="tok-kw">var</span> prev_preferred_link_mode: std.builtin.LinkMode = .Dynamic;</span>
<span class="line" id="L954">        <span class="tok-comment">// Track the number of positional arguments so that a nice error can be</span>
</span>
<span class="line" id="L955">        <span class="tok-comment">// emitted if there is nothing to link.</span>
</span>
<span class="line" id="L956">        <span class="tok-kw">var</span> total_linker_objects: <span class="tok-type">usize</span> = <span class="tok-builtin">@intFromBool</span>(self.root_module.root_source_file != <span class="tok-null">null</span>);</span>
<span class="line" id="L957"></span>
<span class="line" id="L958">        {</span>
<span class="line" id="L959">            <span class="tok-comment">// Fully recursive iteration including dynamic libraries to detect</span>
</span>
<span class="line" id="L960">            <span class="tok-comment">// libc and libc++ linkage.</span>
</span>
<span class="line" id="L961">            <span class="tok-kw">var</span> it = self.root_module.iterateDependencies(self, <span class="tok-null">true</span>);</span>
<span class="line" id="L962">            <span class="tok-kw">while</span> (it.next()) |key| {</span>
<span class="line" id="L963">                <span class="tok-kw">if</span> (key.module.link_libc == <span class="tok-null">true</span>) self.is_linking_libc = <span class="tok-null">true</span>;</span>
<span class="line" id="L964">                <span class="tok-kw">if</span> (key.module.link_libcpp == <span class="tok-null">true</span>) self.is_linking_libcpp = <span class="tok-null">true</span>;</span>
<span class="line" id="L965">            }</span>
<span class="line" id="L966">        }</span>
<span class="line" id="L967"></span>
<span class="line" id="L968">        <span class="tok-kw">var</span> cli_named_modules = <span class="tok-kw">try</span> CliNamedModules.init(arena, &amp;self.root_module);</span>
<span class="line" id="L969"></span>
<span class="line" id="L970">        <span class="tok-comment">// For this loop, don't chase dynamic libraries because their link</span>
</span>
<span class="line" id="L971">        <span class="tok-comment">// objects are already linked.</span>
</span>
<span class="line" id="L972">        <span class="tok-kw">var</span> it = self.root_module.iterateDependencies(self, <span class="tok-null">false</span>);</span>
<span class="line" id="L973"></span>
<span class="line" id="L974">        <span class="tok-kw">while</span> (it.next()) |key| {</span>
<span class="line" id="L975">            <span class="tok-kw">const</span> module = key.module;</span>
<span class="line" id="L976">            <span class="tok-kw">const</span> compile = key.compile.?;</span>
<span class="line" id="L977"></span>
<span class="line" id="L978">            <span class="tok-comment">// While walking transitive dependencies, if a given link object is</span>
</span>
<span class="line" id="L979">            <span class="tok-comment">// already included in a library, it should not redundantly be</span>
</span>
<span class="line" id="L980">            <span class="tok-comment">// placed on the linker line of the dependee.</span>
</span>
<span class="line" id="L981">            <span class="tok-kw">const</span> my_responsibility = compile == self;</span>
<span class="line" id="L982">            <span class="tok-kw">const</span> already_linked = !my_responsibility <span class="tok-kw">and</span> compile.isDynamicLibrary();</span>
<span class="line" id="L983"></span>
<span class="line" id="L984">            <span class="tok-comment">// Inherit dependencies on darwin frameworks.</span>
</span>
<span class="line" id="L985">            <span class="tok-kw">if</span> (!already_linked) {</span>
<span class="line" id="L986">                <span class="tok-kw">for</span> (module.frameworks.keys(), module.frameworks.values()) |name, info| {</span>
<span class="line" id="L987">                    <span class="tok-kw">try</span> frameworks.put(arena, name, info);</span>
<span class="line" id="L988">                }</span>
<span class="line" id="L989">            }</span>
<span class="line" id="L990"></span>
<span class="line" id="L991">            <span class="tok-comment">// Inherit dependencies on system libraries and static libraries.</span>
</span>
<span class="line" id="L992">            <span class="tok-kw">for</span> (module.link_objects.items) |link_object| {</span>
<span class="line" id="L993">                <span class="tok-kw">switch</span> (link_object) {</span>
<span class="line" id="L994">                    .static_path =&gt; |static_path| {</span>
<span class="line" id="L995">                        <span class="tok-kw">if</span> (my_responsibility) {</span>
<span class="line" id="L996">                            <span class="tok-kw">try</span> zig_args.append(static_path.getPath(b));</span>
<span class="line" id="L997">                            total_linker_objects += <span class="tok-number">1</span>;</span>
<span class="line" id="L998">                        }</span>
<span class="line" id="L999">                    },</span>
<span class="line" id="L1000">                    .system_lib =&gt; |system_lib| {</span>
<span class="line" id="L1001">                        <span class="tok-kw">if</span> ((<span class="tok-kw">try</span> seen_system_libs.fetchPut(arena, system_lib.name, {})) != <span class="tok-null">null</span>)</span>
<span class="line" id="L1002">                            <span class="tok-kw">continue</span>;</span>
<span class="line" id="L1003"></span>
<span class="line" id="L1004">                        <span class="tok-kw">if</span> (already_linked)</span>
<span class="line" id="L1005">                            <span class="tok-kw">continue</span>;</span>
<span class="line" id="L1006"></span>
<span class="line" id="L1007">                        <span class="tok-kw">if</span> ((system_lib.search_strategy != prev_search_strategy <span class="tok-kw">or</span></span>
<span class="line" id="L1008">                            system_lib.preferred_link_mode != prev_preferred_link_mode) <span class="tok-kw">and</span></span>
<span class="line" id="L1009">                            self.linkage != .static)</span>
<span class="line" id="L1010">                        {</span>
<span class="line" id="L1011">                            <span class="tok-kw">switch</span> (system_lib.search_strategy) {</span>
<span class="line" id="L1012">                                .no_fallback =&gt; <span class="tok-kw">switch</span> (system_lib.preferred_link_mode) {</span>
<span class="line" id="L1013">                                    .Dynamic =&gt; <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;-search_dylibs_only&quot;</span>),</span>
<span class="line" id="L1014">                                    .Static =&gt; <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;-search_static_only&quot;</span>),</span>
<span class="line" id="L1015">                                },</span>
<span class="line" id="L1016">                                .paths_first =&gt; <span class="tok-kw">switch</span> (system_lib.preferred_link_mode) {</span>
<span class="line" id="L1017">                                    .Dynamic =&gt; <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;-search_paths_first&quot;</span>),</span>
<span class="line" id="L1018">                                    .Static =&gt; <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;-search_paths_first_static&quot;</span>),</span>
<span class="line" id="L1019">                                },</span>
<span class="line" id="L1020">                                .mode_first =&gt; <span class="tok-kw">switch</span> (system_lib.preferred_link_mode) {</span>
<span class="line" id="L1021">                                    .Dynamic =&gt; <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;-search_dylibs_first&quot;</span>),</span>
<span class="line" id="L1022">                                    .Static =&gt; <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;-search_static_first&quot;</span>),</span>
<span class="line" id="L1023">                                },</span>
<span class="line" id="L1024">                            }</span>
<span class="line" id="L1025">                            prev_search_strategy = system_lib.search_strategy;</span>
<span class="line" id="L1026">                            prev_preferred_link_mode = system_lib.preferred_link_mode;</span>
<span class="line" id="L1027">                        }</span>
<span class="line" id="L1028"></span>
<span class="line" id="L1029">                        <span class="tok-kw">const</span> prefix: []<span class="tok-kw">const</span> <span class="tok-type">u8</span> = prefix: {</span>
<span class="line" id="L1030">                            <span class="tok-kw">if</span> (system_lib.needed) <span class="tok-kw">break</span> :prefix <span class="tok-str">&quot;-needed-l&quot;</span>;</span>
<span class="line" id="L1031">                            <span class="tok-kw">if</span> (system_lib.weak) <span class="tok-kw">break</span> :prefix <span class="tok-str">&quot;-weak-l&quot;</span>;</span>
<span class="line" id="L1032">                            <span class="tok-kw">break</span> :prefix <span class="tok-str">&quot;-l&quot;</span>;</span>
<span class="line" id="L1033">                        };</span>
<span class="line" id="L1034">                        <span class="tok-kw">switch</span> (system_lib.use_pkg_config) {</span>
<span class="line" id="L1035">                            .no =&gt; <span class="tok-kw">try</span> zig_args.append(b.fmt(<span class="tok-str">&quot;{s}{s}&quot;</span>, .{ prefix, system_lib.name })),</span>
<span class="line" id="L1036">                            .yes, .force =&gt; {</span>
<span class="line" id="L1037">                                <span class="tok-kw">if</span> (self.runPkgConfig(system_lib.name)) |args| {</span>
<span class="line" id="L1038">                                    <span class="tok-kw">try</span> zig_args.appendSlice(args);</span>
<span class="line" id="L1039">                                } <span class="tok-kw">else</span> |err| <span class="tok-kw">switch</span> (err) {</span>
<span class="line" id="L1040">                                    <span class="tok-kw">error</span>.PkgConfigInvalidOutput,</span>
<span class="line" id="L1041">                                    <span class="tok-kw">error</span>.PkgConfigCrashed,</span>
<span class="line" id="L1042">                                    <span class="tok-kw">error</span>.PkgConfigFailed,</span>
<span class="line" id="L1043">                                    <span class="tok-kw">error</span>.PkgConfigNotInstalled,</span>
<span class="line" id="L1044">                                    <span class="tok-kw">error</span>.PackageNotFound,</span>
<span class="line" id="L1045">                                    =&gt; <span class="tok-kw">switch</span> (system_lib.use_pkg_config) {</span>
<span class="line" id="L1046">                                        .yes =&gt; {</span>
<span class="line" id="L1047">                                            <span class="tok-comment">// pkg-config failed, so fall back to linking the library</span>
</span>
<span class="line" id="L1048">                                            <span class="tok-comment">// by name directly.</span>
</span>
<span class="line" id="L1049">                                            <span class="tok-kw">try</span> zig_args.append(b.fmt(<span class="tok-str">&quot;{s}{s}&quot;</span>, .{</span>
<span class="line" id="L1050">                                                prefix,</span>
<span class="line" id="L1051">                                                system_lib.name,</span>
<span class="line" id="L1052">                                            }));</span>
<span class="line" id="L1053">                                        },</span>
<span class="line" id="L1054">                                        .force =&gt; {</span>
<span class="line" id="L1055">                                            panic(<span class="tok-str">&quot;pkg-config failed for library {s}&quot;</span>, .{system_lib.name});</span>
<span class="line" id="L1056">                                        },</span>
<span class="line" id="L1057">                                        .no =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L1058">                                    },</span>
<span class="line" id="L1059"></span>
<span class="line" id="L1060">                                    <span class="tok-kw">else</span> =&gt; |e| <span class="tok-kw">return</span> e,</span>
<span class="line" id="L1061">                                }</span>
<span class="line" id="L1062">                            },</span>
<span class="line" id="L1063">                        }</span>
<span class="line" id="L1064">                    },</span>
<span class="line" id="L1065">                    .other_step =&gt; |other| {</span>
<span class="line" id="L1066">                        <span class="tok-kw">switch</span> (other.kind) {</span>
<span class="line" id="L1067">                            .exe =&gt; <span class="tok-kw">return</span> step.fail(<span class="tok-str">&quot;cannot link with an executable build artifact&quot;</span>, .{}),</span>
<span class="line" id="L1068">                            .@&quot;test&quot; =&gt; <span class="tok-kw">return</span> step.fail(<span class="tok-str">&quot;cannot link with a test&quot;</span>, .{}),</span>
<span class="line" id="L1069">                            .obj =&gt; {</span>
<span class="line" id="L1070">                                <span class="tok-kw">const</span> included_in_lib = !my_responsibility <span class="tok-kw">and</span></span>
<span class="line" id="L1071">                                    compile.kind == .lib <span class="tok-kw">and</span> other.kind == .obj;</span>
<span class="line" id="L1072">                                <span class="tok-kw">if</span> (!already_linked <span class="tok-kw">and</span> !included_in_lib) {</span>
<span class="line" id="L1073">                                    <span class="tok-kw">try</span> zig_args.append(other.getEmittedBin().getPath(b));</span>
<span class="line" id="L1074">                                    total_linker_objects += <span class="tok-number">1</span>;</span>
<span class="line" id="L1075">                                }</span>
<span class="line" id="L1076">                            },</span>
<span class="line" id="L1077">                            .lib =&gt; l: {</span>
<span class="line" id="L1078">                                <span class="tok-kw">const</span> other_produces_implib = other.producesImplib();</span>
<span class="line" id="L1079">                                <span class="tok-kw">const</span> other_is_static = other_produces_implib <span class="tok-kw">or</span> other.isStaticLibrary();</span>
<span class="line" id="L1080"></span>
<span class="line" id="L1081">                                <span class="tok-kw">if</span> (self.isStaticLibrary() <span class="tok-kw">and</span> other_is_static) {</span>
<span class="line" id="L1082">                                    <span class="tok-comment">// Avoid putting a static library inside a static library.</span>
</span>
<span class="line" id="L1083">                                    <span class="tok-kw">break</span> :l;</span>
<span class="line" id="L1084">                                }</span>
<span class="line" id="L1085"></span>
<span class="line" id="L1086">                                <span class="tok-comment">// For DLLs, we must link against the implib.</span>
</span>
<span class="line" id="L1087">                                <span class="tok-comment">// For everything else, we directly link</span>
</span>
<span class="line" id="L1088">                                <span class="tok-comment">// against the library file.</span>
</span>
<span class="line" id="L1089">                                <span class="tok-kw">const</span> full_path_lib = <span class="tok-kw">if</span> (other_produces_implib)</span>
<span class="line" id="L1090">                                    other.getGeneratedFilePath(<span class="tok-str">&quot;generated_implib&quot;</span>, &amp;self.step)</span>
<span class="line" id="L1091">                                <span class="tok-kw">else</span></span>
<span class="line" id="L1092">                                    other.getGeneratedFilePath(<span class="tok-str">&quot;generated_bin&quot;</span>, &amp;self.step);</span>
<span class="line" id="L1093"></span>
<span class="line" id="L1094">                                <span class="tok-kw">try</span> zig_args.append(full_path_lib);</span>
<span class="line" id="L1095">                                total_linker_objects += <span class="tok-number">1</span>;</span>
<span class="line" id="L1096"></span>
<span class="line" id="L1097">                                <span class="tok-kw">if</span> (other.linkage == Linkage.dynamic <span class="tok-kw">and</span></span>
<span class="line" id="L1098">                                    self.rootModuleTarget().os.tag != .windows)</span>
<span class="line" id="L1099">                                {</span>
<span class="line" id="L1100">                                    <span class="tok-kw">if</span> (fs.path.dirname(full_path_lib)) |dirname| {</span>
<span class="line" id="L1101">                                        <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;-rpath&quot;</span>);</span>
<span class="line" id="L1102">                                        <span class="tok-kw">try</span> zig_args.append(dirname);</span>
<span class="line" id="L1103">                                    }</span>
<span class="line" id="L1104">                                }</span>
<span class="line" id="L1105">                            },</span>
<span class="line" id="L1106">                        }</span>
<span class="line" id="L1107">                    },</span>
<span class="line" id="L1108">                    .assembly_file =&gt; |asm_file| l: {</span>
<span class="line" id="L1109">                        <span class="tok-kw">if</span> (!my_responsibility) <span class="tok-kw">break</span> :l;</span>
<span class="line" id="L1110"></span>
<span class="line" id="L1111">                        <span class="tok-kw">if</span> (prev_has_cflags) {</span>
<span class="line" id="L1112">                            <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;-cflags&quot;</span>);</span>
<span class="line" id="L1113">                            <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;--&quot;</span>);</span>
<span class="line" id="L1114">                            prev_has_cflags = <span class="tok-null">false</span>;</span>
<span class="line" id="L1115">                        }</span>
<span class="line" id="L1116">                        <span class="tok-kw">try</span> zig_args.append(asm_file.getPath(b));</span>
<span class="line" id="L1117">                        total_linker_objects += <span class="tok-number">1</span>;</span>
<span class="line" id="L1118">                    },</span>
<span class="line" id="L1119"></span>
<span class="line" id="L1120">                    .c_source_file =&gt; |c_source_file| l: {</span>
<span class="line" id="L1121">                        <span class="tok-kw">if</span> (!my_responsibility) <span class="tok-kw">break</span> :l;</span>
<span class="line" id="L1122"></span>
<span class="line" id="L1123">                        <span class="tok-kw">if</span> (c_source_file.flags.len == <span class="tok-number">0</span>) {</span>
<span class="line" id="L1124">                            <span class="tok-kw">if</span> (prev_has_cflags) {</span>
<span class="line" id="L1125">                                <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;-cflags&quot;</span>);</span>
<span class="line" id="L1126">                                <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;--&quot;</span>);</span>
<span class="line" id="L1127">                                prev_has_cflags = <span class="tok-null">false</span>;</span>
<span class="line" id="L1128">                            }</span>
<span class="line" id="L1129">                        } <span class="tok-kw">else</span> {</span>
<span class="line" id="L1130">                            <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;-cflags&quot;</span>);</span>
<span class="line" id="L1131">                            <span class="tok-kw">for</span> (c_source_file.flags) |arg| {</span>
<span class="line" id="L1132">                                <span class="tok-kw">try</span> zig_args.append(arg);</span>
<span class="line" id="L1133">                            }</span>
<span class="line" id="L1134">                            <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;--&quot;</span>);</span>
<span class="line" id="L1135">                            prev_has_cflags = <span class="tok-null">true</span>;</span>
<span class="line" id="L1136">                        }</span>
<span class="line" id="L1137">                        <span class="tok-kw">try</span> zig_args.append(c_source_file.file.getPath(b));</span>
<span class="line" id="L1138">                        total_linker_objects += <span class="tok-number">1</span>;</span>
<span class="line" id="L1139">                    },</span>
<span class="line" id="L1140"></span>
<span class="line" id="L1141">                    .c_source_files =&gt; |c_source_files| l: {</span>
<span class="line" id="L1142">                        <span class="tok-kw">if</span> (!my_responsibility) <span class="tok-kw">break</span> :l;</span>
<span class="line" id="L1143"></span>
<span class="line" id="L1144">                        <span class="tok-kw">if</span> (c_source_files.flags.len == <span class="tok-number">0</span>) {</span>
<span class="line" id="L1145">                            <span class="tok-kw">if</span> (prev_has_cflags) {</span>
<span class="line" id="L1146">                                <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;-cflags&quot;</span>);</span>
<span class="line" id="L1147">                                <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;--&quot;</span>);</span>
<span class="line" id="L1148">                                prev_has_cflags = <span class="tok-null">false</span>;</span>
<span class="line" id="L1149">                            }</span>
<span class="line" id="L1150">                        } <span class="tok-kw">else</span> {</span>
<span class="line" id="L1151">                            <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;-cflags&quot;</span>);</span>
<span class="line" id="L1152">                            <span class="tok-kw">for</span> (c_source_files.flags) |flag| {</span>
<span class="line" id="L1153">                                <span class="tok-kw">try</span> zig_args.append(flag);</span>
<span class="line" id="L1154">                            }</span>
<span class="line" id="L1155">                            <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;--&quot;</span>);</span>
<span class="line" id="L1156">                            prev_has_cflags = <span class="tok-null">true</span>;</span>
<span class="line" id="L1157">                        }</span>
<span class="line" id="L1158"></span>
<span class="line" id="L1159">                        <span class="tok-kw">if</span> (c_source_files.dependency) |dep| {</span>
<span class="line" id="L1160">                            <span class="tok-kw">for</span> (c_source_files.files) |file| {</span>
<span class="line" id="L1161">                                <span class="tok-kw">try</span> zig_args.append(dep.builder.pathFromRoot(file));</span>
<span class="line" id="L1162">                            }</span>
<span class="line" id="L1163">                        } <span class="tok-kw">else</span> {</span>
<span class="line" id="L1164">                            <span class="tok-kw">for</span> (c_source_files.files) |file| {</span>
<span class="line" id="L1165">                                <span class="tok-kw">try</span> zig_args.append(b.pathFromRoot(file));</span>
<span class="line" id="L1166">                            }</span>
<span class="line" id="L1167">                        }</span>
<span class="line" id="L1168">                        total_linker_objects += c_source_files.files.len;</span>
<span class="line" id="L1169">                    },</span>
<span class="line" id="L1170"></span>
<span class="line" id="L1171">                    .win32_resource_file =&gt; |rc_source_file| l: {</span>
<span class="line" id="L1172">                        <span class="tok-kw">if</span> (!my_responsibility) <span class="tok-kw">break</span> :l;</span>
<span class="line" id="L1173"></span>
<span class="line" id="L1174">                        <span class="tok-kw">if</span> (rc_source_file.flags.len == <span class="tok-number">0</span>) {</span>
<span class="line" id="L1175">                            <span class="tok-kw">if</span> (prev_has_rcflags) {</span>
<span class="line" id="L1176">                                <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;-rcflags&quot;</span>);</span>
<span class="line" id="L1177">                                <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;--&quot;</span>);</span>
<span class="line" id="L1178">                                prev_has_rcflags = <span class="tok-null">false</span>;</span>
<span class="line" id="L1179">                            }</span>
<span class="line" id="L1180">                        } <span class="tok-kw">else</span> {</span>
<span class="line" id="L1181">                            <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;-rcflags&quot;</span>);</span>
<span class="line" id="L1182">                            <span class="tok-kw">for</span> (rc_source_file.flags) |arg| {</span>
<span class="line" id="L1183">                                <span class="tok-kw">try</span> zig_args.append(arg);</span>
<span class="line" id="L1184">                            }</span>
<span class="line" id="L1185">                            <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;--&quot;</span>);</span>
<span class="line" id="L1186">                            prev_has_rcflags = <span class="tok-null">true</span>;</span>
<span class="line" id="L1187">                        }</span>
<span class="line" id="L1188">                        <span class="tok-kw">try</span> zig_args.append(rc_source_file.file.getPath(b));</span>
<span class="line" id="L1189">                        total_linker_objects += <span class="tok-number">1</span>;</span>
<span class="line" id="L1190">                    },</span>
<span class="line" id="L1191">                }</span>
<span class="line" id="L1192">            }</span>
<span class="line" id="L1193"></span>
<span class="line" id="L1194">            <span class="tok-comment">// We need to emit the --mod argument here so that the above link objects</span>
</span>
<span class="line" id="L1195">            <span class="tok-comment">// have the correct parent module, but only if the module is part of</span>
</span>
<span class="line" id="L1196">            <span class="tok-comment">// this compilation.</span>
</span>
<span class="line" id="L1197">            <span class="tok-kw">if</span> (cli_named_modules.modules.getIndex(module)) |module_cli_index| {</span>
<span class="line" id="L1198">                <span class="tok-kw">const</span> module_cli_name = cli_named_modules.names.keys()[module_cli_index];</span>
<span class="line" id="L1199">                <span class="tok-kw">try</span> module.appendZigProcessFlags(&amp;zig_args, step);</span>
<span class="line" id="L1200"></span>
<span class="line" id="L1201">                <span class="tok-comment">// --dep arguments</span>
</span>
<span class="line" id="L1202">                <span class="tok-kw">try</span> zig_args.ensureUnusedCapacity(module.import_table.count() * <span class="tok-number">2</span>);</span>
<span class="line" id="L1203">                <span class="tok-kw">for</span> (module.import_table.keys(), module.import_table.values()) |name, dep| {</span>
<span class="line" id="L1204">                    <span class="tok-kw">const</span> dep_index = cli_named_modules.modules.getIndex(dep).?;</span>
<span class="line" id="L1205">                    <span class="tok-kw">const</span> dep_cli_name = cli_named_modules.names.keys()[dep_index];</span>
<span class="line" id="L1206">                    zig_args.appendAssumeCapacity(<span class="tok-str">&quot;--dep&quot;</span>);</span>
<span class="line" id="L1207">                    <span class="tok-kw">if</span> (std.mem.eql(<span class="tok-type">u8</span>, dep_cli_name, name)) {</span>
<span class="line" id="L1208">                        zig_args.appendAssumeCapacity(dep_cli_name);</span>
<span class="line" id="L1209">                    } <span class="tok-kw">else</span> {</span>
<span class="line" id="L1210">                        zig_args.appendAssumeCapacity(b.fmt(<span class="tok-str">&quot;{s}={s}&quot;</span>, .{ name, dep_cli_name }));</span>
<span class="line" id="L1211">                    }</span>
<span class="line" id="L1212">                }</span>
<span class="line" id="L1213"></span>
<span class="line" id="L1214">                <span class="tok-comment">// The CLI assumes if it sees a --mod argument that it is a zig</span>
</span>
<span class="line" id="L1215">                <span class="tok-comment">// compilation unit. If there is no root source file, then this</span>
</span>
<span class="line" id="L1216">                <span class="tok-comment">// is not a zig compilation unit - it is perhaps a set of</span>
</span>
<span class="line" id="L1217">                <span class="tok-comment">// linker objects, or C source files instead.</span>
</span>
<span class="line" id="L1218">                <span class="tok-comment">// In such case, there will be only one module, so we can leave</span>
</span>
<span class="line" id="L1219">                <span class="tok-comment">// off the naming here.</span>
</span>
<span class="line" id="L1220">                <span class="tok-kw">if</span> (module.root_source_file) |lp| {</span>
<span class="line" id="L1221">                    <span class="tok-kw">const</span> src = lp.getPath2(module.owner, step);</span>
<span class="line" id="L1222">                    <span class="tok-kw">try</span> zig_args.appendSlice(&amp;.{ <span class="tok-str">&quot;--mod&quot;</span>, module_cli_name, src });</span>
<span class="line" id="L1223">                }</span>
<span class="line" id="L1224">            }</span>
<span class="line" id="L1225">        }</span>
<span class="line" id="L1226"></span>
<span class="line" id="L1227">        <span class="tok-kw">if</span> (total_linker_objects == <span class="tok-number">0</span>) {</span>
<span class="line" id="L1228">            <span class="tok-kw">return</span> step.fail(<span class="tok-str">&quot;the linker needs one or more objects to link&quot;</span>, .{});</span>
<span class="line" id="L1229">        }</span>
<span class="line" id="L1230"></span>
<span class="line" id="L1231">        <span class="tok-kw">for</span> (frameworks.keys(), frameworks.values()) |name, info| {</span>
<span class="line" id="L1232">            <span class="tok-kw">if</span> (info.needed) {</span>
<span class="line" id="L1233">                <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;-needed_framework&quot;</span>);</span>
<span class="line" id="L1234">            } <span class="tok-kw">else</span> <span class="tok-kw">if</span> (info.weak) {</span>
<span class="line" id="L1235">                <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;-weak_framework&quot;</span>);</span>
<span class="line" id="L1236">            } <span class="tok-kw">else</span> {</span>
<span class="line" id="L1237">                <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;-framework&quot;</span>);</span>
<span class="line" id="L1238">            }</span>
<span class="line" id="L1239">            <span class="tok-kw">try</span> zig_args.append(name);</span>
<span class="line" id="L1240">        }</span>
<span class="line" id="L1241"></span>
<span class="line" id="L1242">        <span class="tok-kw">if</span> (self.is_linking_libcpp) {</span>
<span class="line" id="L1243">            <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;-lc++&quot;</span>);</span>
<span class="line" id="L1244">        }</span>
<span class="line" id="L1245"></span>
<span class="line" id="L1246">        <span class="tok-kw">if</span> (self.is_linking_libc) {</span>
<span class="line" id="L1247">            <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;-lc&quot;</span>);</span>
<span class="line" id="L1248">        }</span>
<span class="line" id="L1249">    }</span>
<span class="line" id="L1250"></span>
<span class="line" id="L1251">    <span class="tok-kw">if</span> (self.win32_manifest) |manifest_file| {</span>
<span class="line" id="L1252">        <span class="tok-kw">try</span> zig_args.append(manifest_file.getPath(b));</span>
<span class="line" id="L1253">    }</span>
<span class="line" id="L1254"></span>
<span class="line" id="L1255">    <span class="tok-kw">if</span> (self.image_base) |image_base| {</span>
<span class="line" id="L1256">        <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;--image-base&quot;</span>);</span>
<span class="line" id="L1257">        <span class="tok-kw">try</span> zig_args.append(b.fmt(<span class="tok-str">&quot;0x{x}&quot;</span>, .{image_base}));</span>
<span class="line" id="L1258">    }</span>
<span class="line" id="L1259"></span>
<span class="line" id="L1260">    <span class="tok-kw">if</span> (self.filter) |filter| {</span>
<span class="line" id="L1261">        <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;--test-filter&quot;</span>);</span>
<span class="line" id="L1262">        <span class="tok-kw">try</span> zig_args.append(filter);</span>
<span class="line" id="L1263">    }</span>
<span class="line" id="L1264"></span>
<span class="line" id="L1265">    <span class="tok-kw">if</span> (self.test_evented_io) {</span>
<span class="line" id="L1266">        <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;--test-evented-io&quot;</span>);</span>
<span class="line" id="L1267">    }</span>
<span class="line" id="L1268"></span>
<span class="line" id="L1269">    <span class="tok-kw">if</span> (self.test_runner) |test_runner| {</span>
<span class="line" id="L1270">        <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;--test-runner&quot;</span>);</span>
<span class="line" id="L1271">        <span class="tok-kw">try</span> zig_args.append(b.pathFromRoot(test_runner));</span>
<span class="line" id="L1272">    }</span>
<span class="line" id="L1273"></span>
<span class="line" id="L1274">    <span class="tok-kw">for</span> (b.debug_log_scopes) |log_scope| {</span>
<span class="line" id="L1275">        <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;--debug-log&quot;</span>);</span>
<span class="line" id="L1276">        <span class="tok-kw">try</span> zig_args.append(log_scope);</span>
<span class="line" id="L1277">    }</span>
<span class="line" id="L1278"></span>
<span class="line" id="L1279">    <span class="tok-kw">if</span> (b.debug_compile_errors) {</span>
<span class="line" id="L1280">        <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;--debug-compile-errors&quot;</span>);</span>
<span class="line" id="L1281">    }</span>
<span class="line" id="L1282"></span>
<span class="line" id="L1283">    <span class="tok-kw">if</span> (b.verbose_cimport) <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;--verbose-cimport&quot;</span>);</span>
<span class="line" id="L1284">    <span class="tok-kw">if</span> (b.verbose_air) <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;--verbose-air&quot;</span>);</span>
<span class="line" id="L1285">    <span class="tok-kw">if</span> (b.verbose_llvm_ir) |path| <span class="tok-kw">try</span> zig_args.append(b.fmt(<span class="tok-str">&quot;--verbose-llvm-ir={s}&quot;</span>, .{path}));</span>
<span class="line" id="L1286">    <span class="tok-kw">if</span> (b.verbose_llvm_bc) |path| <span class="tok-kw">try</span> zig_args.append(b.fmt(<span class="tok-str">&quot;--verbose-llvm-bc={s}&quot;</span>, .{path}));</span>
<span class="line" id="L1287">    <span class="tok-kw">if</span> (b.verbose_link <span class="tok-kw">or</span> self.verbose_link) <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;--verbose-link&quot;</span>);</span>
<span class="line" id="L1288">    <span class="tok-kw">if</span> (b.verbose_cc <span class="tok-kw">or</span> self.verbose_cc) <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;--verbose-cc&quot;</span>);</span>
<span class="line" id="L1289">    <span class="tok-kw">if</span> (b.verbose_llvm_cpu_features) <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;--verbose-llvm-cpu-features&quot;</span>);</span>
<span class="line" id="L1290"></span>
<span class="line" id="L1291">    <span class="tok-kw">if</span> (self.generated_asm != <span class="tok-null">null</span>) <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;-femit-asm&quot;</span>);</span>
<span class="line" id="L1292">    <span class="tok-kw">if</span> (self.generated_bin == <span class="tok-null">null</span>) <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;-fno-emit-bin&quot;</span>);</span>
<span class="line" id="L1293">    <span class="tok-kw">if</span> (self.generated_docs != <span class="tok-null">null</span>) <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;-femit-docs&quot;</span>);</span>
<span class="line" id="L1294">    <span class="tok-kw">if</span> (self.generated_implib != <span class="tok-null">null</span>) <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;-femit-implib&quot;</span>);</span>
<span class="line" id="L1295">    <span class="tok-kw">if</span> (self.generated_llvm_bc != <span class="tok-null">null</span>) <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;-femit-llvm-bc&quot;</span>);</span>
<span class="line" id="L1296">    <span class="tok-kw">if</span> (self.generated_llvm_ir != <span class="tok-null">null</span>) <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;-femit-llvm-ir&quot;</span>);</span>
<span class="line" id="L1297">    <span class="tok-kw">if</span> (self.generated_h != <span class="tok-null">null</span>) <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;-femit-h&quot;</span>);</span>
<span class="line" id="L1298"></span>
<span class="line" id="L1299">    <span class="tok-kw">switch</span> (self.compress_debug_sections) {</span>
<span class="line" id="L1300">        .none =&gt; {},</span>
<span class="line" id="L1301">        .zlib =&gt; <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;--compress-debug-sections=zlib&quot;</span>),</span>
<span class="line" id="L1302">        .zstd =&gt; <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;--compress-debug-sections=zstd&quot;</span>),</span>
<span class="line" id="L1303">    }</span>
<span class="line" id="L1304"></span>
<span class="line" id="L1305">    <span class="tok-kw">if</span> (self.link_eh_frame_hdr) {</span>
<span class="line" id="L1306">        <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;--eh-frame-hdr&quot;</span>);</span>
<span class="line" id="L1307">    }</span>
<span class="line" id="L1308">    <span class="tok-kw">if</span> (self.link_emit_relocs) {</span>
<span class="line" id="L1309">        <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;--emit-relocs&quot;</span>);</span>
<span class="line" id="L1310">    }</span>
<span class="line" id="L1311">    <span class="tok-kw">if</span> (self.link_function_sections) {</span>
<span class="line" id="L1312">        <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;-ffunction-sections&quot;</span>);</span>
<span class="line" id="L1313">    }</span>
<span class="line" id="L1314">    <span class="tok-kw">if</span> (self.link_data_sections) {</span>
<span class="line" id="L1315">        <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;-fdata-sections&quot;</span>);</span>
<span class="line" id="L1316">    }</span>
<span class="line" id="L1317">    <span class="tok-kw">if</span> (self.link_gc_sections) |x| {</span>
<span class="line" id="L1318">        <span class="tok-kw">try</span> zig_args.append(<span class="tok-kw">if</span> (x) <span class="tok-str">&quot;--gc-sections&quot;</span> <span class="tok-kw">else</span> <span class="tok-str">&quot;--no-gc-sections&quot;</span>);</span>
<span class="line" id="L1319">    }</span>
<span class="line" id="L1320">    <span class="tok-kw">if</span> (!self.linker_dynamicbase) {</span>
<span class="line" id="L1321">        <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;--no-dynamicbase&quot;</span>);</span>
<span class="line" id="L1322">    }</span>
<span class="line" id="L1323">    <span class="tok-kw">if</span> (self.linker_allow_shlib_undefined) |x| {</span>
<span class="line" id="L1324">        <span class="tok-kw">try</span> zig_args.append(<span class="tok-kw">if</span> (x) <span class="tok-str">&quot;-fallow-shlib-undefined&quot;</span> <span class="tok-kw">else</span> <span class="tok-str">&quot;-fno-allow-shlib-undefined&quot;</span>);</span>
<span class="line" id="L1325">    }</span>
<span class="line" id="L1326">    <span class="tok-kw">if</span> (self.link_z_notext) {</span>
<span class="line" id="L1327">        <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;-z&quot;</span>);</span>
<span class="line" id="L1328">        <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;notext&quot;</span>);</span>
<span class="line" id="L1329">    }</span>
<span class="line" id="L1330">    <span class="tok-kw">if</span> (!self.link_z_relro) {</span>
<span class="line" id="L1331">        <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;-z&quot;</span>);</span>
<span class="line" id="L1332">        <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;norelro&quot;</span>);</span>
<span class="line" id="L1333">    }</span>
<span class="line" id="L1334">    <span class="tok-kw">if</span> (self.link_z_lazy) {</span>
<span class="line" id="L1335">        <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;-z&quot;</span>);</span>
<span class="line" id="L1336">        <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;lazy&quot;</span>);</span>
<span class="line" id="L1337">    }</span>
<span class="line" id="L1338">    <span class="tok-kw">if</span> (self.link_z_common_page_size) |size| {</span>
<span class="line" id="L1339">        <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;-z&quot;</span>);</span>
<span class="line" id="L1340">        <span class="tok-kw">try</span> zig_args.append(b.fmt(<span class="tok-str">&quot;common-page-size={d}&quot;</span>, .{size}));</span>
<span class="line" id="L1341">    }</span>
<span class="line" id="L1342">    <span class="tok-kw">if</span> (self.link_z_max_page_size) |size| {</span>
<span class="line" id="L1343">        <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;-z&quot;</span>);</span>
<span class="line" id="L1344">        <span class="tok-kw">try</span> zig_args.append(b.fmt(<span class="tok-str">&quot;max-page-size={d}&quot;</span>, .{size}));</span>
<span class="line" id="L1345">    }</span>
<span class="line" id="L1346"></span>
<span class="line" id="L1347">    <span class="tok-kw">if</span> (self.libc_file) |libc_file| {</span>
<span class="line" id="L1348">        <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;--libc&quot;</span>);</span>
<span class="line" id="L1349">        <span class="tok-kw">try</span> zig_args.append(libc_file.getPath(b));</span>
<span class="line" id="L1350">    } <span class="tok-kw">else</span> <span class="tok-kw">if</span> (b.libc_file) |libc_file| {</span>
<span class="line" id="L1351">        <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;--libc&quot;</span>);</span>
<span class="line" id="L1352">        <span class="tok-kw">try</span> zig_args.append(libc_file);</span>
<span class="line" id="L1353">    }</span>
<span class="line" id="L1354"></span>
<span class="line" id="L1355">    <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;--cache-dir&quot;</span>);</span>
<span class="line" id="L1356">    <span class="tok-kw">try</span> zig_args.append(b.cache_root.path <span class="tok-kw">orelse</span> <span class="tok-str">&quot;.&quot;</span>);</span>
<span class="line" id="L1357"></span>
<span class="line" id="L1358">    <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;--global-cache-dir&quot;</span>);</span>
<span class="line" id="L1359">    <span class="tok-kw">try</span> zig_args.append(b.global_cache_root.path <span class="tok-kw">orelse</span> <span class="tok-str">&quot;.&quot;</span>);</span>
<span class="line" id="L1360"></span>
<span class="line" id="L1361">    <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;--name&quot;</span>);</span>
<span class="line" id="L1362">    <span class="tok-kw">try</span> zig_args.append(self.name);</span>
<span class="line" id="L1363"></span>
<span class="line" id="L1364">    <span class="tok-kw">if</span> (self.linkage) |some| <span class="tok-kw">switch</span> (some) {</span>
<span class="line" id="L1365">        .dynamic =&gt; <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;-dynamic&quot;</span>),</span>
<span class="line" id="L1366">        .static =&gt; <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;-static&quot;</span>),</span>
<span class="line" id="L1367">    };</span>
<span class="line" id="L1368">    <span class="tok-kw">if</span> (self.kind == .lib <span class="tok-kw">and</span> self.linkage != <span class="tok-null">null</span> <span class="tok-kw">and</span> self.linkage.? == .dynamic) {</span>
<span class="line" id="L1369">        <span class="tok-kw">if</span> (self.version) |version| {</span>
<span class="line" id="L1370">            <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;--version&quot;</span>);</span>
<span class="line" id="L1371">            <span class="tok-kw">try</span> zig_args.append(b.fmt(<span class="tok-str">&quot;{}&quot;</span>, .{version}));</span>
<span class="line" id="L1372">        }</span>
<span class="line" id="L1373"></span>
<span class="line" id="L1374">        <span class="tok-kw">if</span> (self.rootModuleTarget().isDarwin()) {</span>
<span class="line" id="L1375">            <span class="tok-kw">const</span> install_name = self.install_name <span class="tok-kw">orelse</span> b.fmt(<span class="tok-str">&quot;@rpath/{s}{s}{s}&quot;</span>, .{</span>
<span class="line" id="L1376">                self.rootModuleTarget().libPrefix(),</span>
<span class="line" id="L1377">                self.name,</span>
<span class="line" id="L1378">                self.rootModuleTarget().dynamicLibSuffix(),</span>
<span class="line" id="L1379">            });</span>
<span class="line" id="L1380">            <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;-install_name&quot;</span>);</span>
<span class="line" id="L1381">            <span class="tok-kw">try</span> zig_args.append(install_name);</span>
<span class="line" id="L1382">        }</span>
<span class="line" id="L1383">    }</span>
<span class="line" id="L1384"></span>
<span class="line" id="L1385">    <span class="tok-kw">if</span> (self.entitlements) |entitlements| {</span>
<span class="line" id="L1386">        <span class="tok-kw">try</span> zig_args.appendSlice(&amp;[_][]<span class="tok-kw">const</span> <span class="tok-type">u8</span>{ <span class="tok-str">&quot;--entitlements&quot;</span>, entitlements });</span>
<span class="line" id="L1387">    }</span>
<span class="line" id="L1388">    <span class="tok-kw">if</span> (self.pagezero_size) |pagezero_size| {</span>
<span class="line" id="L1389">        <span class="tok-kw">const</span> size = <span class="tok-kw">try</span> std.fmt.allocPrint(arena, <span class="tok-str">&quot;{x}&quot;</span>, .{pagezero_size});</span>
<span class="line" id="L1390">        <span class="tok-kw">try</span> zig_args.appendSlice(&amp;[_][]<span class="tok-kw">const</span> <span class="tok-type">u8</span>{ <span class="tok-str">&quot;-pagezero_size&quot;</span>, size });</span>
<span class="line" id="L1391">    }</span>
<span class="line" id="L1392">    <span class="tok-kw">if</span> (self.headerpad_size) |headerpad_size| {</span>
<span class="line" id="L1393">        <span class="tok-kw">const</span> size = <span class="tok-kw">try</span> std.fmt.allocPrint(arena, <span class="tok-str">&quot;{x}&quot;</span>, .{headerpad_size});</span>
<span class="line" id="L1394">        <span class="tok-kw">try</span> zig_args.appendSlice(&amp;[_][]<span class="tok-kw">const</span> <span class="tok-type">u8</span>{ <span class="tok-str">&quot;-headerpad&quot;</span>, size });</span>
<span class="line" id="L1395">    }</span>
<span class="line" id="L1396">    <span class="tok-kw">if</span> (self.headerpad_max_install_names) {</span>
<span class="line" id="L1397">        <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;-headerpad_max_install_names&quot;</span>);</span>
<span class="line" id="L1398">    }</span>
<span class="line" id="L1399">    <span class="tok-kw">if</span> (self.dead_strip_dylibs) {</span>
<span class="line" id="L1400">        <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;-dead_strip_dylibs&quot;</span>);</span>
<span class="line" id="L1401">    }</span>
<span class="line" id="L1402"></span>
<span class="line" id="L1403">    <span class="tok-kw">try</span> addFlag(&amp;zig_args, <span class="tok-str">&quot;compiler-rt&quot;</span>, self.bundle_compiler_rt);</span>
<span class="line" id="L1404">    <span class="tok-kw">try</span> addFlag(&amp;zig_args, <span class="tok-str">&quot;dll-export-fns&quot;</span>, self.dll_export_fns);</span>
<span class="line" id="L1405">    <span class="tok-kw">if</span> (self.rdynamic) {</span>
<span class="line" id="L1406">        <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;-rdynamic&quot;</span>);</span>
<span class="line" id="L1407">    }</span>
<span class="line" id="L1408">    <span class="tok-kw">if</span> (self.import_memory) {</span>
<span class="line" id="L1409">        <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;--import-memory&quot;</span>);</span>
<span class="line" id="L1410">    }</span>
<span class="line" id="L1411">    <span class="tok-kw">if</span> (self.export_memory) {</span>
<span class="line" id="L1412">        <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;--export-memory&quot;</span>);</span>
<span class="line" id="L1413">    }</span>
<span class="line" id="L1414">    <span class="tok-kw">if</span> (self.import_symbols) {</span>
<span class="line" id="L1415">        <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;--import-symbols&quot;</span>);</span>
<span class="line" id="L1416">    }</span>
<span class="line" id="L1417">    <span class="tok-kw">if</span> (self.import_table) {</span>
<span class="line" id="L1418">        <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;--import-table&quot;</span>);</span>
<span class="line" id="L1419">    }</span>
<span class="line" id="L1420">    <span class="tok-kw">if</span> (self.export_table) {</span>
<span class="line" id="L1421">        <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;--export-table&quot;</span>);</span>
<span class="line" id="L1422">    }</span>
<span class="line" id="L1423">    <span class="tok-kw">if</span> (self.initial_memory) |initial_memory| {</span>
<span class="line" id="L1424">        <span class="tok-kw">try</span> zig_args.append(b.fmt(<span class="tok-str">&quot;--initial-memory={d}&quot;</span>, .{initial_memory}));</span>
<span class="line" id="L1425">    }</span>
<span class="line" id="L1426">    <span class="tok-kw">if</span> (self.max_memory) |max_memory| {</span>
<span class="line" id="L1427">        <span class="tok-kw">try</span> zig_args.append(b.fmt(<span class="tok-str">&quot;--max-memory={d}&quot;</span>, .{max_memory}));</span>
<span class="line" id="L1428">    }</span>
<span class="line" id="L1429">    <span class="tok-kw">if</span> (self.shared_memory) {</span>
<span class="line" id="L1430">        <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;--shared-memory&quot;</span>);</span>
<span class="line" id="L1431">    }</span>
<span class="line" id="L1432">    <span class="tok-kw">if</span> (self.global_base) |global_base| {</span>
<span class="line" id="L1433">        <span class="tok-kw">try</span> zig_args.append(b.fmt(<span class="tok-str">&quot;--global-base={d}&quot;</span>, .{global_base}));</span>
<span class="line" id="L1434">    }</span>
<span class="line" id="L1435"></span>
<span class="line" id="L1436">    <span class="tok-kw">if</span> (self.wasi_exec_model) |model| {</span>
<span class="line" id="L1437">        <span class="tok-kw">try</span> zig_args.append(b.fmt(<span class="tok-str">&quot;-mexec-model={s}&quot;</span>, .{<span class="tok-builtin">@tagName</span>(model)}));</span>
<span class="line" id="L1438">    }</span>
<span class="line" id="L1439">    <span class="tok-kw">if</span> (self.linker_script) |linker_script| {</span>
<span class="line" id="L1440">        <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;--script&quot;</span>);</span>
<span class="line" id="L1441">        <span class="tok-kw">try</span> zig_args.append(linker_script.getPath(b));</span>
<span class="line" id="L1442">    }</span>
<span class="line" id="L1443"></span>
<span class="line" id="L1444">    <span class="tok-kw">if</span> (self.version_script) |version_script| {</span>
<span class="line" id="L1445">        <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;--version-script&quot;</span>);</span>
<span class="line" id="L1446">        <span class="tok-kw">try</span> zig_args.append(b.pathFromRoot(version_script));</span>
<span class="line" id="L1447">    }</span>
<span class="line" id="L1448"></span>
<span class="line" id="L1449">    <span class="tok-kw">if</span> (self.kind == .@&quot;test&quot;) {</span>
<span class="line" id="L1450">        <span class="tok-kw">if</span> (self.exec_cmd_args) |exec_cmd_args| {</span>
<span class="line" id="L1451">            <span class="tok-kw">for</span> (exec_cmd_args) |cmd_arg| {</span>
<span class="line" id="L1452">                <span class="tok-kw">if</span> (cmd_arg) |arg| {</span>
<span class="line" id="L1453">                    <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;--test-cmd&quot;</span>);</span>
<span class="line" id="L1454">                    <span class="tok-kw">try</span> zig_args.append(arg);</span>
<span class="line" id="L1455">                } <span class="tok-kw">else</span> {</span>
<span class="line" id="L1456">                    <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;--test-cmd-bin&quot;</span>);</span>
<span class="line" id="L1457">                }</span>
<span class="line" id="L1458">            }</span>
<span class="line" id="L1459">        }</span>
<span class="line" id="L1460">    }</span>
<span class="line" id="L1461"></span>
<span class="line" id="L1462">    <span class="tok-kw">if</span> (b.sysroot) |sysroot| {</span>
<span class="line" id="L1463">        <span class="tok-kw">try</span> zig_args.appendSlice(&amp;[_][]<span class="tok-kw">const</span> <span class="tok-type">u8</span>{ <span class="tok-str">&quot;--sysroot&quot;</span>, sysroot });</span>
<span class="line" id="L1464">    }</span>
<span class="line" id="L1465"></span>
<span class="line" id="L1466">    <span class="tok-comment">// -I and -L arguments that appear after the last --mod argument apply to all modules.</span>
</span>
<span class="line" id="L1467">    <span class="tok-kw">for</span> (b.search_prefixes.items) |search_prefix| {</span>
<span class="line" id="L1468">        <span class="tok-kw">var</span> prefix_dir = fs.cwd().openDir(search_prefix, .{}) <span class="tok-kw">catch</span> |err| {</span>
<span class="line" id="L1469">            <span class="tok-kw">return</span> step.fail(<span class="tok-str">&quot;unable to open prefix directory '{s}': {s}&quot;</span>, .{</span>
<span class="line" id="L1470">                search_prefix, <span class="tok-builtin">@errorName</span>(err),</span>
<span class="line" id="L1471">            });</span>
<span class="line" id="L1472">        };</span>
<span class="line" id="L1473">        <span class="tok-kw">defer</span> prefix_dir.close();</span>
<span class="line" id="L1474"></span>
<span class="line" id="L1475">        <span class="tok-comment">// Avoid passing -L and -I flags for nonexistent directories.</span>
</span>
<span class="line" id="L1476">        <span class="tok-comment">// This prevents a warning, that should probably be upgraded to an error in Zig's</span>
</span>
<span class="line" id="L1477">        <span class="tok-comment">// CLI parsing code, when the linker sees an -L directory that does not exist.</span>
</span>
<span class="line" id="L1478"></span>
<span class="line" id="L1479">        <span class="tok-kw">if</span> (prefix_dir.accessZ(<span class="tok-str">&quot;lib&quot;</span>, .{})) |_| {</span>
<span class="line" id="L1480">            <span class="tok-kw">try</span> zig_args.appendSlice(&amp;.{</span>
<span class="line" id="L1481">                <span class="tok-str">&quot;-L&quot;</span>, <span class="tok-kw">try</span> fs.path.join(arena, &amp;.{ search_prefix, <span class="tok-str">&quot;lib&quot;</span> }),</span>
<span class="line" id="L1482">            });</span>
<span class="line" id="L1483">        } <span class="tok-kw">else</span> |err| <span class="tok-kw">switch</span> (err) {</span>
<span class="line" id="L1484">            <span class="tok-kw">error</span>.FileNotFound =&gt; {},</span>
<span class="line" id="L1485">            <span class="tok-kw">else</span> =&gt; |e| <span class="tok-kw">return</span> step.fail(<span class="tok-str">&quot;unable to access '{s}/lib' directory: {s}&quot;</span>, .{</span>
<span class="line" id="L1486">                search_prefix, <span class="tok-builtin">@errorName</span>(e),</span>
<span class="line" id="L1487">            }),</span>
<span class="line" id="L1488">        }</span>
<span class="line" id="L1489"></span>
<span class="line" id="L1490">        <span class="tok-kw">if</span> (prefix_dir.accessZ(<span class="tok-str">&quot;include&quot;</span>, .{})) |_| {</span>
<span class="line" id="L1491">            <span class="tok-kw">try</span> zig_args.appendSlice(&amp;.{</span>
<span class="line" id="L1492">                <span class="tok-str">&quot;-I&quot;</span>, <span class="tok-kw">try</span> fs.path.join(arena, &amp;.{ search_prefix, <span class="tok-str">&quot;include&quot;</span> }),</span>
<span class="line" id="L1493">            });</span>
<span class="line" id="L1494">        } <span class="tok-kw">else</span> |err| <span class="tok-kw">switch</span> (err) {</span>
<span class="line" id="L1495">            <span class="tok-kw">error</span>.FileNotFound =&gt; {},</span>
<span class="line" id="L1496">            <span class="tok-kw">else</span> =&gt; |e| <span class="tok-kw">return</span> step.fail(<span class="tok-str">&quot;unable to access '{s}/include' directory: {s}&quot;</span>, .{</span>
<span class="line" id="L1497">                search_prefix, <span class="tok-builtin">@errorName</span>(e),</span>
<span class="line" id="L1498">            }),</span>
<span class="line" id="L1499">        }</span>
<span class="line" id="L1500">    }</span>
<span class="line" id="L1501"></span>
<span class="line" id="L1502">    <span class="tok-kw">if</span> (self.rc_includes != .any) {</span>
<span class="line" id="L1503">        <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;-rcincludes&quot;</span>);</span>
<span class="line" id="L1504">        <span class="tok-kw">try</span> zig_args.append(<span class="tok-builtin">@tagName</span>(self.rc_includes));</span>
<span class="line" id="L1505">    }</span>
<span class="line" id="L1506"></span>
<span class="line" id="L1507">    <span class="tok-kw">try</span> addFlag(&amp;zig_args, <span class="tok-str">&quot;each-lib-rpath&quot;</span>, self.each_lib_rpath);</span>
<span class="line" id="L1508"></span>
<span class="line" id="L1509">    <span class="tok-kw">if</span> (self.build_id) |build_id| {</span>
<span class="line" id="L1510">        <span class="tok-kw">try</span> zig_args.append(<span class="tok-kw">switch</span> (build_id) {</span>
<span class="line" id="L1511">            .hexstring =&gt; |hs| b.fmt(<span class="tok-str">&quot;--build-id=0x{s}&quot;</span>, .{</span>
<span class="line" id="L1512">                std.fmt.fmtSliceHexLower(hs.toSlice()),</span>
<span class="line" id="L1513">            }),</span>
<span class="line" id="L1514">            .none, .fast, .uuid, .sha1, .md5 =&gt; b.fmt(<span class="tok-str">&quot;--build-id={s}&quot;</span>, .{<span class="tok-builtin">@tagName</span>(build_id)}),</span>
<span class="line" id="L1515">        });</span>
<span class="line" id="L1516">    }</span>
<span class="line" id="L1517"></span>
<span class="line" id="L1518">    <span class="tok-kw">if</span> (self.zig_lib_dir) |dir| {</span>
<span class="line" id="L1519">        <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;--zig-lib-dir&quot;</span>);</span>
<span class="line" id="L1520">        <span class="tok-kw">try</span> zig_args.append(dir.getPath(b));</span>
<span class="line" id="L1521">    }</span>
<span class="line" id="L1522"></span>
<span class="line" id="L1523">    <span class="tok-kw">try</span> addFlag(&amp;zig_args, <span class="tok-str">&quot;PIE&quot;</span>, self.pie);</span>
<span class="line" id="L1524">    <span class="tok-kw">try</span> addFlag(&amp;zig_args, <span class="tok-str">&quot;lto&quot;</span>, self.want_lto);</span>
<span class="line" id="L1525"></span>
<span class="line" id="L1526">    <span class="tok-kw">if</span> (self.subsystem) |subsystem| {</span>
<span class="line" id="L1527">        <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;--subsystem&quot;</span>);</span>
<span class="line" id="L1528">        <span class="tok-kw">try</span> zig_args.append(<span class="tok-kw">switch</span> (subsystem) {</span>
<span class="line" id="L1529">            .Console =&gt; <span class="tok-str">&quot;console&quot;</span>,</span>
<span class="line" id="L1530">            .Windows =&gt; <span class="tok-str">&quot;windows&quot;</span>,</span>
<span class="line" id="L1531">            .Posix =&gt; <span class="tok-str">&quot;posix&quot;</span>,</span>
<span class="line" id="L1532">            .Native =&gt; <span class="tok-str">&quot;native&quot;</span>,</span>
<span class="line" id="L1533">            .EfiApplication =&gt; <span class="tok-str">&quot;efi_application&quot;</span>,</span>
<span class="line" id="L1534">            .EfiBootServiceDriver =&gt; <span class="tok-str">&quot;efi_boot_service_driver&quot;</span>,</span>
<span class="line" id="L1535">            .EfiRom =&gt; <span class="tok-str">&quot;efi_rom&quot;</span>,</span>
<span class="line" id="L1536">            .EfiRuntimeDriver =&gt; <span class="tok-str">&quot;efi_runtime_driver&quot;</span>,</span>
<span class="line" id="L1537">        });</span>
<span class="line" id="L1538">    }</span>
<span class="line" id="L1539"></span>
<span class="line" id="L1540">    <span class="tok-kw">if</span> (self.error_limit) |err_limit| <span class="tok-kw">try</span> zig_args.appendSlice(&amp;.{</span>
<span class="line" id="L1541">        <span class="tok-str">&quot;--error-limit&quot;</span>,</span>
<span class="line" id="L1542">        b.fmt(<span class="tok-str">&quot;{}&quot;</span>, .{err_limit}),</span>
<span class="line" id="L1543">    });</span>
<span class="line" id="L1544"></span>
<span class="line" id="L1545">    <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;--listen=-&quot;</span>);</span>
<span class="line" id="L1546"></span>
<span class="line" id="L1547">    <span class="tok-comment">// Windows has an argument length limit of 32,766 characters, macOS 262,144 and Linux</span>
</span>
<span class="line" id="L1548">    <span class="tok-comment">// 2,097,152. If our args exceed 30 KiB, we instead write them to a &quot;response file&quot; and</span>
</span>
<span class="line" id="L1549">    <span class="tok-comment">// pass that to zig, e.g. via 'zig build-lib @args.rsp'</span>
</span>
<span class="line" id="L1550">    <span class="tok-comment">// See @file syntax here: https://gcc.gnu.org/onlinedocs/gcc/Overall-Options.html</span>
</span>
<span class="line" id="L1551">    <span class="tok-kw">var</span> args_length: <span class="tok-type">usize</span> = <span class="tok-number">0</span>;</span>
<span class="line" id="L1552">    <span class="tok-kw">for</span> (zig_args.items) |arg| {</span>
<span class="line" id="L1553">        args_length += arg.len + <span class="tok-number">1</span>; <span class="tok-comment">// +1 to account for null terminator</span>
</span>
<span class="line" id="L1554">    }</span>
<span class="line" id="L1555">    <span class="tok-kw">if</span> (args_length &gt;= <span class="tok-number">30</span> * <span class="tok-number">1024</span>) {</span>
<span class="line" id="L1556">        <span class="tok-kw">try</span> b.cache_root.handle.makePath(<span class="tok-str">&quot;args&quot;</span>);</span>
<span class="line" id="L1557"></span>
<span class="line" id="L1558">        <span class="tok-kw">const</span> args_to_escape = zig_args.items[<span class="tok-number">2</span>..];</span>
<span class="line" id="L1559">        <span class="tok-kw">var</span> escaped_args = <span class="tok-kw">try</span> ArrayList([]<span class="tok-kw">const</span> <span class="tok-type">u8</span>).initCapacity(arena, args_to_escape.len);</span>
<span class="line" id="L1560">        arg_blk: <span class="tok-kw">for</span> (args_to_escape) |arg| {</span>
<span class="line" id="L1561">            <span class="tok-kw">for</span> (arg, <span class="tok-number">0</span>..) |c, arg_idx| {</span>
<span class="line" id="L1562">                <span class="tok-kw">if</span> (c == <span class="tok-str">'\\'</span> <span class="tok-kw">or</span> c == <span class="tok-str">'&quot;'</span>) {</span>
<span class="line" id="L1563">                    <span class="tok-comment">// Slow path for arguments that need to be escaped. We'll need to allocate and copy</span>
</span>
<span class="line" id="L1564">                    <span class="tok-kw">var</span> escaped = <span class="tok-kw">try</span> ArrayList(<span class="tok-type">u8</span>).initCapacity(arena, arg.len + <span class="tok-number">1</span>);</span>
<span class="line" id="L1565">                    <span class="tok-kw">const</span> writer = escaped.writer();</span>
<span class="line" id="L1566">                    <span class="tok-kw">try</span> writer.writeAll(arg[<span class="tok-number">0</span>..arg_idx]);</span>
<span class="line" id="L1567">                    <span class="tok-kw">for</span> (arg[arg_idx..]) |to_escape| {</span>
<span class="line" id="L1568">                        <span class="tok-kw">if</span> (to_escape == <span class="tok-str">'\\'</span> <span class="tok-kw">or</span> to_escape == <span class="tok-str">'&quot;'</span>) <span class="tok-kw">try</span> writer.writeByte(<span class="tok-str">'\\'</span>);</span>
<span class="line" id="L1569">                        <span class="tok-kw">try</span> writer.writeByte(to_escape);</span>
<span class="line" id="L1570">                    }</span>
<span class="line" id="L1571">                    escaped_args.appendAssumeCapacity(escaped.items);</span>
<span class="line" id="L1572">                    <span class="tok-kw">continue</span> :arg_blk;</span>
<span class="line" id="L1573">                }</span>
<span class="line" id="L1574">            }</span>
<span class="line" id="L1575">            escaped_args.appendAssumeCapacity(arg); <span class="tok-comment">// no escaping needed so just use original argument</span>
</span>
<span class="line" id="L1576">        }</span>
<span class="line" id="L1577"></span>
<span class="line" id="L1578">        <span class="tok-comment">// Write the args to zig-cache/args/&lt;SHA256 hash of args&gt; to avoid conflicts with</span>
</span>
<span class="line" id="L1579">        <span class="tok-comment">// other zig build commands running in parallel.</span>
</span>
<span class="line" id="L1580">        <span class="tok-kw">const</span> partially_quoted = <span class="tok-kw">try</span> std.mem.join(arena, <span class="tok-str">&quot;\&quot; \&quot;&quot;</span>, escaped_args.items);</span>
<span class="line" id="L1581">        <span class="tok-kw">const</span> args = <span class="tok-kw">try</span> std.mem.concat(arena, <span class="tok-type">u8</span>, &amp;[_][]<span class="tok-kw">const</span> <span class="tok-type">u8</span>{ <span class="tok-str">&quot;\&quot;&quot;</span>, partially_quoted, <span class="tok-str">&quot;\&quot;&quot;</span> });</span>
<span class="line" id="L1582"></span>
<span class="line" id="L1583">        <span class="tok-kw">var</span> args_hash: [Sha256.digest_length]<span class="tok-type">u8</span> = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L1584">        Sha256.hash(args, &amp;args_hash, .{});</span>
<span class="line" id="L1585">        <span class="tok-kw">var</span> args_hex_hash: [Sha256.digest_length * <span class="tok-number">2</span>]<span class="tok-type">u8</span> = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L1586">        _ = <span class="tok-kw">try</span> std.fmt.bufPrint(</span>
<span class="line" id="L1587">            &amp;args_hex_hash,</span>
<span class="line" id="L1588">            <span class="tok-str">&quot;{s}&quot;</span>,</span>
<span class="line" id="L1589">            .{std.fmt.fmtSliceHexLower(&amp;args_hash)},</span>
<span class="line" id="L1590">        );</span>
<span class="line" id="L1591"></span>
<span class="line" id="L1592">        <span class="tok-kw">const</span> args_file = <span class="tok-str">&quot;args&quot;</span> ++ fs.path.sep_str ++ args_hex_hash;</span>
<span class="line" id="L1593">        <span class="tok-kw">try</span> b.cache_root.handle.writeFile(args_file, args);</span>
<span class="line" id="L1594"></span>
<span class="line" id="L1595">        <span class="tok-kw">const</span> resolved_args_file = <span class="tok-kw">try</span> mem.concat(arena, <span class="tok-type">u8</span>, &amp;.{</span>
<span class="line" id="L1596">            <span class="tok-str">&quot;@&quot;</span>,</span>
<span class="line" id="L1597">            <span class="tok-kw">try</span> b.cache_root.join(arena, &amp;.{args_file}),</span>
<span class="line" id="L1598">        });</span>
<span class="line" id="L1599"></span>
<span class="line" id="L1600">        zig_args.shrinkRetainingCapacity(<span class="tok-number">2</span>);</span>
<span class="line" id="L1601">        <span class="tok-kw">try</span> zig_args.append(resolved_args_file);</span>
<span class="line" id="L1602">    }</span>
<span class="line" id="L1603"></span>
<span class="line" id="L1604">    <span class="tok-kw">const</span> maybe_output_bin_path = step.evalZigProcess(zig_args.items, prog_node) <span class="tok-kw">catch</span> |err| <span class="tok-kw">switch</span> (err) {</span>
<span class="line" id="L1605">        <span class="tok-kw">error</span>.NeedCompileErrorCheck =&gt; {</span>
<span class="line" id="L1606">            assert(self.expect_errors != <span class="tok-null">null</span>);</span>
<span class="line" id="L1607">            <span class="tok-kw">try</span> checkCompileErrors(self);</span>
<span class="line" id="L1608">            <span class="tok-kw">return</span>;</span>
<span class="line" id="L1609">        },</span>
<span class="line" id="L1610">        <span class="tok-kw">else</span> =&gt; |e| <span class="tok-kw">return</span> e,</span>
<span class="line" id="L1611">    };</span>
<span class="line" id="L1612"></span>
<span class="line" id="L1613">    <span class="tok-comment">// Update generated files</span>
</span>
<span class="line" id="L1614">    <span class="tok-kw">if</span> (maybe_output_bin_path) |output_bin_path| {</span>
<span class="line" id="L1615">        <span class="tok-kw">const</span> output_dir = fs.path.dirname(output_bin_path).?;</span>
<span class="line" id="L1616"></span>
<span class="line" id="L1617">        <span class="tok-kw">if</span> (self.emit_directory) |lp| {</span>
<span class="line" id="L1618">            lp.path = output_dir;</span>
<span class="line" id="L1619">        }</span>
<span class="line" id="L1620"></span>
<span class="line" id="L1621">        <span class="tok-comment">// -femit-bin[=path]         (default) Output machine code</span>
</span>
<span class="line" id="L1622">        <span class="tok-kw">if</span> (self.generated_bin) |bin| {</span>
<span class="line" id="L1623">            bin.path = b.pathJoin(&amp;.{ output_dir, self.out_filename });</span>
<span class="line" id="L1624">        }</span>
<span class="line" id="L1625"></span>
<span class="line" id="L1626">        <span class="tok-kw">const</span> sep = std.fs.path.sep;</span>
<span class="line" id="L1627"></span>
<span class="line" id="L1628">        <span class="tok-comment">// output PDB if someone requested it</span>
</span>
<span class="line" id="L1629">        <span class="tok-kw">if</span> (self.generated_pdb) |pdb| {</span>
<span class="line" id="L1630">            pdb.path = b.fmt(<span class="tok-str">&quot;{s}{c}{s}.pdb&quot;</span>, .{ output_dir, sep, self.name });</span>
<span class="line" id="L1631">        }</span>
<span class="line" id="L1632"></span>
<span class="line" id="L1633">        <span class="tok-comment">// -femit-implib[=path]      (default) Produce an import .lib when building a Windows DLL</span>
</span>
<span class="line" id="L1634">        <span class="tok-kw">if</span> (self.generated_implib) |implib| {</span>
<span class="line" id="L1635">            implib.path = b.fmt(<span class="tok-str">&quot;{s}{c}{s}.lib&quot;</span>, .{ output_dir, sep, self.name });</span>
<span class="line" id="L1636">        }</span>
<span class="line" id="L1637"></span>
<span class="line" id="L1638">        <span class="tok-comment">// -femit-h[=path]           Generate a C header file (.h)</span>
</span>
<span class="line" id="L1639">        <span class="tok-kw">if</span> (self.generated_h) |lp| {</span>
<span class="line" id="L1640">            lp.path = b.fmt(<span class="tok-str">&quot;{s}{c}{s}.h&quot;</span>, .{ output_dir, sep, self.name });</span>
<span class="line" id="L1641">        }</span>
<span class="line" id="L1642"></span>
<span class="line" id="L1643">        <span class="tok-comment">// -femit-docs[=path]        Create a docs/ dir with html documentation</span>
</span>
<span class="line" id="L1644">        <span class="tok-kw">if</span> (self.generated_docs) |generated_docs| {</span>
<span class="line" id="L1645">            generated_docs.path = b.pathJoin(&amp;.{ output_dir, <span class="tok-str">&quot;docs&quot;</span> });</span>
<span class="line" id="L1646">        }</span>
<span class="line" id="L1647"></span>
<span class="line" id="L1648">        <span class="tok-comment">// -femit-asm[=path]         Output .s (assembly code)</span>
</span>
<span class="line" id="L1649">        <span class="tok-kw">if</span> (self.generated_asm) |lp| {</span>
<span class="line" id="L1650">            lp.path = b.fmt(<span class="tok-str">&quot;{s}{c}{s}.s&quot;</span>, .{ output_dir, sep, self.name });</span>
<span class="line" id="L1651">        }</span>
<span class="line" id="L1652"></span>
<span class="line" id="L1653">        <span class="tok-comment">// -femit-llvm-ir[=path]     Produce a .ll file with optimized LLVM IR (requires LLVM extensions)</span>
</span>
<span class="line" id="L1654">        <span class="tok-kw">if</span> (self.generated_llvm_ir) |lp| {</span>
<span class="line" id="L1655">            lp.path = b.fmt(<span class="tok-str">&quot;{s}{c}{s}.ll&quot;</span>, .{ output_dir, sep, self.name });</span>
<span class="line" id="L1656">        }</span>
<span class="line" id="L1657"></span>
<span class="line" id="L1658">        <span class="tok-comment">// -femit-llvm-bc[=path]     Produce an optimized LLVM module as a .bc file (requires LLVM extensions)</span>
</span>
<span class="line" id="L1659">        <span class="tok-kw">if</span> (self.generated_llvm_bc) |lp| {</span>
<span class="line" id="L1660">            lp.path = b.fmt(<span class="tok-str">&quot;{s}{c}{s}.bc&quot;</span>, .{ output_dir, sep, self.name });</span>
<span class="line" id="L1661">        }</span>
<span class="line" id="L1662">    }</span>
<span class="line" id="L1663"></span>
<span class="line" id="L1664">    <span class="tok-kw">if</span> (self.kind == .lib <span class="tok-kw">and</span> self.linkage != <span class="tok-null">null</span> <span class="tok-kw">and</span> self.linkage.? == .dynamic <span class="tok-kw">and</span></span>
<span class="line" id="L1665">        self.version != <span class="tok-null">null</span> <span class="tok-kw">and</span> std.Build.wantSharedLibSymLinks(self.rootModuleTarget()))</span>
<span class="line" id="L1666">    {</span>
<span class="line" id="L1667">        <span class="tok-kw">try</span> doAtomicSymLinks(</span>
<span class="line" id="L1668">            step,</span>
<span class="line" id="L1669">            self.getEmittedBin().getPath(b),</span>
<span class="line" id="L1670">            self.major_only_filename.?,</span>
<span class="line" id="L1671">            self.name_only_filename.?,</span>
<span class="line" id="L1672">        );</span>
<span class="line" id="L1673">    }</span>
<span class="line" id="L1674">}</span>
<span class="line" id="L1675"></span>
<span class="line" id="L1676"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">doAtomicSymLinks</span>(</span>
<span class="line" id="L1677">    step: *Step,</span>
<span class="line" id="L1678">    output_path: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>,</span>
<span class="line" id="L1679">    filename_major_only: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>,</span>
<span class="line" id="L1680">    filename_name_only: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>,</span>
<span class="line" id="L1681">) !<span class="tok-type">void</span> {</span>
<span class="line" id="L1682">    <span class="tok-kw">const</span> arena = step.owner.allocator;</span>
<span class="line" id="L1683">    <span class="tok-kw">const</span> out_dir = fs.path.dirname(output_path) <span class="tok-kw">orelse</span> <span class="tok-str">&quot;.&quot;</span>;</span>
<span class="line" id="L1684">    <span class="tok-kw">const</span> out_basename = fs.path.basename(output_path);</span>
<span class="line" id="L1685">    <span class="tok-comment">// sym link for libfoo.so.1 to libfoo.so.1.2.3</span>
</span>
<span class="line" id="L1686">    <span class="tok-kw">const</span> major_only_path = <span class="tok-kw">try</span> fs.path.join(arena, &amp;.{ out_dir, filename_major_only });</span>
<span class="line" id="L1687">    fs.atomicSymLink(arena, out_basename, major_only_path) <span class="tok-kw">catch</span> |err| {</span>
<span class="line" id="L1688">        <span class="tok-kw">return</span> step.fail(<span class="tok-str">&quot;unable to symlink {s} -&gt; {s}: {s}&quot;</span>, .{</span>
<span class="line" id="L1689">            major_only_path, out_basename, <span class="tok-builtin">@errorName</span>(err),</span>
<span class="line" id="L1690">        });</span>
<span class="line" id="L1691">    };</span>
<span class="line" id="L1692">    <span class="tok-comment">// sym link for libfoo.so to libfoo.so.1</span>
</span>
<span class="line" id="L1693">    <span class="tok-kw">const</span> name_only_path = <span class="tok-kw">try</span> fs.path.join(arena, &amp;.{ out_dir, filename_name_only });</span>
<span class="line" id="L1694">    fs.atomicSymLink(arena, filename_major_only, name_only_path) <span class="tok-kw">catch</span> |err| {</span>
<span class="line" id="L1695">        <span class="tok-kw">return</span> step.fail(<span class="tok-str">&quot;Unable to symlink {s} -&gt; {s}: {s}&quot;</span>, .{</span>
<span class="line" id="L1696">            name_only_path, filename_major_only, <span class="tok-builtin">@errorName</span>(err),</span>
<span class="line" id="L1697">        });</span>
<span class="line" id="L1698">    };</span>
<span class="line" id="L1699">}</span>
<span class="line" id="L1700"></span>
<span class="line" id="L1701"><span class="tok-kw">fn</span> <span class="tok-fn">execPkgConfigList</span>(self: *std.Build, out_code: *<span class="tok-type">u8</span>) (PkgConfigError || RunError)![]<span class="tok-kw">const</span> PkgConfigPkg {</span>
<span class="line" id="L1702">    <span class="tok-kw">const</span> stdout = <span class="tok-kw">try</span> self.runAllowFail(&amp;[_][]<span class="tok-kw">const</span> <span class="tok-type">u8</span>{ <span class="tok-str">&quot;pkg-config&quot;</span>, <span class="tok-str">&quot;--list-all&quot;</span> }, out_code, .Ignore);</span>
<span class="line" id="L1703">    <span class="tok-kw">var</span> list = ArrayList(PkgConfigPkg).init(self.allocator);</span>
<span class="line" id="L1704">    <span class="tok-kw">errdefer</span> list.deinit();</span>
<span class="line" id="L1705">    <span class="tok-kw">var</span> line_it = mem.tokenizeAny(<span class="tok-type">u8</span>, stdout, <span class="tok-str">&quot;\r\n&quot;</span>);</span>
<span class="line" id="L1706">    <span class="tok-kw">while</span> (line_it.next()) |line| {</span>
<span class="line" id="L1707">        <span class="tok-kw">if</span> (mem.trim(<span class="tok-type">u8</span>, line, <span class="tok-str">&quot; \t&quot;</span>).len == <span class="tok-number">0</span>) <span class="tok-kw">continue</span>;</span>
<span class="line" id="L1708">        <span class="tok-kw">var</span> tok_it = mem.tokenizeAny(<span class="tok-type">u8</span>, line, <span class="tok-str">&quot; \t&quot;</span>);</span>
<span class="line" id="L1709">        <span class="tok-kw">try</span> list.append(PkgConfigPkg{</span>
<span class="line" id="L1710">            .name = tok_it.next() <span class="tok-kw">orelse</span> <span class="tok-kw">return</span> <span class="tok-kw">error</span>.PkgConfigInvalidOutput,</span>
<span class="line" id="L1711">            .desc = tok_it.rest(),</span>
<span class="line" id="L1712">        });</span>
<span class="line" id="L1713">    }</span>
<span class="line" id="L1714">    <span class="tok-kw">return</span> list.toOwnedSlice();</span>
<span class="line" id="L1715">}</span>
<span class="line" id="L1716"></span>
<span class="line" id="L1717"><span class="tok-kw">fn</span> <span class="tok-fn">getPkgConfigList</span>(self: *std.Build) ![]<span class="tok-kw">const</span> PkgConfigPkg {</span>
<span class="line" id="L1718">    <span class="tok-kw">if</span> (self.pkg_config_pkg_list) |res| {</span>
<span class="line" id="L1719">        <span class="tok-kw">return</span> res;</span>
<span class="line" id="L1720">    }</span>
<span class="line" id="L1721">    <span class="tok-kw">var</span> code: <span class="tok-type">u8</span> = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L1722">    <span class="tok-kw">if</span> (execPkgConfigList(self, &amp;code)) |list| {</span>
<span class="line" id="L1723">        self.pkg_config_pkg_list = list;</span>
<span class="line" id="L1724">        <span class="tok-kw">return</span> list;</span>
<span class="line" id="L1725">    } <span class="tok-kw">else</span> |err| {</span>
<span class="line" id="L1726">        <span class="tok-kw">const</span> result = <span class="tok-kw">switch</span> (err) {</span>
<span class="line" id="L1727">            <span class="tok-kw">error</span>.ProcessTerminated =&gt; <span class="tok-kw">error</span>.PkgConfigCrashed,</span>
<span class="line" id="L1728">            <span class="tok-kw">error</span>.ExecNotSupported =&gt; <span class="tok-kw">error</span>.PkgConfigFailed,</span>
<span class="line" id="L1729">            <span class="tok-kw">error</span>.ExitCodeFailure =&gt; <span class="tok-kw">error</span>.PkgConfigFailed,</span>
<span class="line" id="L1730">            <span class="tok-kw">error</span>.FileNotFound =&gt; <span class="tok-kw">error</span>.PkgConfigNotInstalled,</span>
<span class="line" id="L1731">            <span class="tok-kw">error</span>.InvalidName =&gt; <span class="tok-kw">error</span>.PkgConfigNotInstalled,</span>
<span class="line" id="L1732">            <span class="tok-kw">error</span>.PkgConfigInvalidOutput =&gt; <span class="tok-kw">error</span>.PkgConfigInvalidOutput,</span>
<span class="line" id="L1733">            <span class="tok-kw">else</span> =&gt; <span class="tok-kw">return</span> err,</span>
<span class="line" id="L1734">        };</span>
<span class="line" id="L1735">        self.pkg_config_pkg_list = result;</span>
<span class="line" id="L1736">        <span class="tok-kw">return</span> result;</span>
<span class="line" id="L1737">    }</span>
<span class="line" id="L1738">}</span>
<span class="line" id="L1739"></span>
<span class="line" id="L1740"><span class="tok-kw">fn</span> <span class="tok-fn">addFlag</span>(args: *ArrayList([]<span class="tok-kw">const</span> <span class="tok-type">u8</span>), <span class="tok-kw">comptime</span> name: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>, opt: ?<span class="tok-type">bool</span>) !<span class="tok-type">void</span> {</span>
<span class="line" id="L1741">    <span class="tok-kw">const</span> cond = opt <span class="tok-kw">orelse</span> <span class="tok-kw">return</span>;</span>
<span class="line" id="L1742">    <span class="tok-kw">try</span> args.ensureUnusedCapacity(<span class="tok-number">1</span>);</span>
<span class="line" id="L1743">    <span class="tok-kw">if</span> (cond) {</span>
<span class="line" id="L1744">        args.appendAssumeCapacity(<span class="tok-str">&quot;-f&quot;</span> ++ name);</span>
<span class="line" id="L1745">    } <span class="tok-kw">else</span> {</span>
<span class="line" id="L1746">        args.appendAssumeCapacity(<span class="tok-str">&quot;-fno-&quot;</span> ++ name);</span>
<span class="line" id="L1747">    }</span>
<span class="line" id="L1748">}</span>
<span class="line" id="L1749"></span>
<span class="line" id="L1750"><span class="tok-kw">fn</span> <span class="tok-fn">checkCompileErrors</span>(self: *Compile) !<span class="tok-type">void</span> {</span>
<span class="line" id="L1751">    <span class="tok-comment">// Clear this field so that it does not get printed by the build runner.</span>
</span>
<span class="line" id="L1752">    <span class="tok-kw">const</span> actual_eb = self.step.result_error_bundle;</span>
<span class="line" id="L1753">    self.step.result_error_bundle = std.zig.ErrorBundle.empty;</span>
<span class="line" id="L1754"></span>
<span class="line" id="L1755">    <span class="tok-kw">const</span> arena = self.step.owner.allocator;</span>
<span class="line" id="L1756"></span>
<span class="line" id="L1757">    <span class="tok-kw">var</span> actual_stderr_list = std.ArrayList(<span class="tok-type">u8</span>).init(arena);</span>
<span class="line" id="L1758">    <span class="tok-kw">try</span> actual_eb.renderToWriter(.{</span>
<span class="line" id="L1759">        .ttyconf = .no_color,</span>
<span class="line" id="L1760">        .include_reference_trace = <span class="tok-null">false</span>,</span>
<span class="line" id="L1761">        .include_source_line = <span class="tok-null">false</span>,</span>
<span class="line" id="L1762">    }, actual_stderr_list.writer());</span>
<span class="line" id="L1763">    <span class="tok-kw">const</span> actual_stderr = <span class="tok-kw">try</span> actual_stderr_list.toOwnedSlice();</span>
<span class="line" id="L1764"></span>
<span class="line" id="L1765">    <span class="tok-comment">// Render the expected lines into a string that we can compare verbatim.</span>
</span>
<span class="line" id="L1766">    <span class="tok-kw">var</span> expected_generated = std.ArrayList(<span class="tok-type">u8</span>).init(arena);</span>
<span class="line" id="L1767">    <span class="tok-kw">const</span> expect_errors = self.expect_errors.?;</span>
<span class="line" id="L1768"></span>
<span class="line" id="L1769">    <span class="tok-kw">var</span> actual_line_it = mem.splitScalar(<span class="tok-type">u8</span>, actual_stderr, <span class="tok-str">'\n'</span>);</span>
<span class="line" id="L1770"></span>
<span class="line" id="L1771">    <span class="tok-comment">// TODO merge this with the testing.expectEqualStrings logic, and also CheckFile</span>
</span>
<span class="line" id="L1772">    <span class="tok-kw">switch</span> (expect_errors) {</span>
<span class="line" id="L1773">        .contains =&gt; |expect_line| {</span>
<span class="line" id="L1774">            <span class="tok-kw">while</span> (actual_line_it.next()) |actual_line| {</span>
<span class="line" id="L1775">                <span class="tok-kw">if</span> (!matchCompileError(actual_line, expect_line)) <span class="tok-kw">continue</span>;</span>
<span class="line" id="L1776">                <span class="tok-kw">return</span>;</span>
<span class="line" id="L1777">            }</span>
<span class="line" id="L1778"></span>
<span class="line" id="L1779">            <span class="tok-kw">return</span> self.step.fail(</span>
<span class="line" id="L1780">                <span class="tok-str">\\</span></span>

<span class="line" id="L1781">                <span class="tok-str">\\========= should contain: ===============</span></span>

<span class="line" id="L1782">                <span class="tok-str">\\{s}</span></span>

<span class="line" id="L1783">                <span class="tok-str">\\========= but not found: ================</span></span>

<span class="line" id="L1784">                <span class="tok-str">\\{s}</span></span>

<span class="line" id="L1785">                <span class="tok-str">\\=========================================</span></span>

<span class="line" id="L1786">            , .{ expect_line, actual_stderr });</span>
<span class="line" id="L1787">        },</span>
<span class="line" id="L1788">        .exact =&gt; |expect_lines| {</span>
<span class="line" id="L1789">            <span class="tok-kw">for</span> (expect_lines) |expect_line| {</span>
<span class="line" id="L1790">                <span class="tok-kw">const</span> actual_line = actual_line_it.next() <span class="tok-kw">orelse</span> {</span>
<span class="line" id="L1791">                    <span class="tok-kw">try</span> expected_generated.appendSlice(expect_line);</span>
<span class="line" id="L1792">                    <span class="tok-kw">try</span> expected_generated.append(<span class="tok-str">'\n'</span>);</span>
<span class="line" id="L1793">                    <span class="tok-kw">continue</span>;</span>
<span class="line" id="L1794">                };</span>
<span class="line" id="L1795">                <span class="tok-kw">if</span> (matchCompileError(actual_line, expect_line)) {</span>
<span class="line" id="L1796">                    <span class="tok-kw">try</span> expected_generated.appendSlice(actual_line);</span>
<span class="line" id="L1797">                    <span class="tok-kw">try</span> expected_generated.append(<span class="tok-str">'\n'</span>);</span>
<span class="line" id="L1798">                    <span class="tok-kw">continue</span>;</span>
<span class="line" id="L1799">                }</span>
<span class="line" id="L1800">                <span class="tok-kw">try</span> expected_generated.appendSlice(expect_line);</span>
<span class="line" id="L1801">                <span class="tok-kw">try</span> expected_generated.append(<span class="tok-str">'\n'</span>);</span>
<span class="line" id="L1802">            }</span>
<span class="line" id="L1803"></span>
<span class="line" id="L1804">            <span class="tok-kw">if</span> (mem.eql(<span class="tok-type">u8</span>, expected_generated.items, actual_stderr)) <span class="tok-kw">return</span>;</span>
<span class="line" id="L1805"></span>
<span class="line" id="L1806">            <span class="tok-kw">return</span> self.step.fail(</span>
<span class="line" id="L1807">                <span class="tok-str">\\</span></span>

<span class="line" id="L1808">                <span class="tok-str">\\========= expected: =====================</span></span>

<span class="line" id="L1809">                <span class="tok-str">\\{s}</span></span>

<span class="line" id="L1810">                <span class="tok-str">\\========= but found: ====================</span></span>

<span class="line" id="L1811">                <span class="tok-str">\\{s}</span></span>

<span class="line" id="L1812">                <span class="tok-str">\\=========================================</span></span>

<span class="line" id="L1813">            , .{ expected_generated.items, actual_stderr });</span>
<span class="line" id="L1814">        },</span>
<span class="line" id="L1815">    }</span>
<span class="line" id="L1816">}</span>
<span class="line" id="L1817"></span>
<span class="line" id="L1818"><span class="tok-kw">fn</span> <span class="tok-fn">matchCompileError</span>(actual: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>, expected: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>) <span class="tok-type">bool</span> {</span>
<span class="line" id="L1819">    <span class="tok-kw">if</span> (mem.endsWith(<span class="tok-type">u8</span>, actual, expected)) <span class="tok-kw">return</span> <span class="tok-null">true</span>;</span>
<span class="line" id="L1820">    <span class="tok-kw">if</span> (mem.startsWith(<span class="tok-type">u8</span>, expected, <span class="tok-str">&quot;:?:?: &quot;</span>)) {</span>
<span class="line" id="L1821">        <span class="tok-kw">if</span> (mem.endsWith(<span class="tok-type">u8</span>, actual, expected[<span class="tok-str">&quot;:?:?: &quot;</span>.len..])) <span class="tok-kw">return</span> <span class="tok-null">true</span>;</span>
<span class="line" id="L1822">    }</span>
<span class="line" id="L1823">    <span class="tok-comment">// We scan for /?/ in expected line and if there is a match, we match everything</span>
</span>
<span class="line" id="L1824">    <span class="tok-comment">// up to and after /?/.</span>
</span>
<span class="line" id="L1825">    <span class="tok-kw">const</span> expected_trim = mem.trim(<span class="tok-type">u8</span>, expected, <span class="tok-str">&quot; &quot;</span>);</span>
<span class="line" id="L1826">    <span class="tok-kw">if</span> (mem.indexOf(<span class="tok-type">u8</span>, expected_trim, <span class="tok-str">&quot;/?/&quot;</span>)) |index| {</span>
<span class="line" id="L1827">        <span class="tok-kw">const</span> actual_trim = mem.trim(<span class="tok-type">u8</span>, actual, <span class="tok-str">&quot; &quot;</span>);</span>
<span class="line" id="L1828">        <span class="tok-kw">const</span> lhs = expected_trim[<span class="tok-number">0</span>..index];</span>
<span class="line" id="L1829">        <span class="tok-kw">const</span> rhs = expected_trim[index + <span class="tok-str">&quot;/?/&quot;</span>.len ..];</span>
<span class="line" id="L1830">        <span class="tok-kw">if</span> (mem.startsWith(<span class="tok-type">u8</span>, actual_trim, lhs) <span class="tok-kw">and</span> mem.endsWith(<span class="tok-type">u8</span>, actual_trim, rhs)) <span class="tok-kw">return</span> <span class="tok-null">true</span>;</span>
<span class="line" id="L1831">    }</span>
<span class="line" id="L1832">    <span class="tok-kw">return</span> <span class="tok-null">false</span>;</span>
<span class="line" id="L1833">}</span>
<span class="line" id="L1834"></span>
<span class="line" id="L1835"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">rootModuleTarget</span>(c: *Compile) std.Target {</span>
<span class="line" id="L1836">    <span class="tok-comment">// The root module is always given a target, so we know this to be non-null.</span>
</span>
<span class="line" id="L1837">    <span class="tok-kw">return</span> c.root_module.resolved_target.?.result;</span>
<span class="line" id="L1838">}</span>
<span class="line" id="L1839"></span>
</code></pre></body>
</html>